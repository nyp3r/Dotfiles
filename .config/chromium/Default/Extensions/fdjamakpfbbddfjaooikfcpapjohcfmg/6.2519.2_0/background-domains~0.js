"use strict";(globalThis.webpackChunk_dashlane_amphora=globalThis.webpackChunk_dashlane_amphora||[]).push([["466"],{87055:function(e,t,i){i.d(t,{J:()=>c});var s=i(36503),r=i(49629),n=i(30273),a=i(31142),o=i(37595);let c=(0,s.Q)({name:"permissions",commands:{addGroupManager:r.B,removeGroupManager:n.d},events:{permissionsLoaded:a.L},queries:{userPermissions:o.lO}})},69108:function(e,t,i){i.d(t,{J:()=>n});var s=i(46266),r=i(87055);class n extends(0,s.E)(r.J){}(0,s.K)(r.J,n)},49629:function(e,t,i){i.d(t,{B:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},30273:function(e,t,i){i.d(t,{d:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},31142:function(e,t,i){i.d(t,{L:()=>n});var s=i(98037),r=i(15021);class n extends(0,s.d)({scope:r.F.User}){}},37595:function(e,t,i){i.d(t,{GQ:()=>n,lO:()=>a});var s=i(45429),r=i(15021);let n=(0,i(96272).Vj)("not_member","The user is not a member of the team");class a extends(0,s.k)({scope:r.F.User}){}},12160:function(e,t,i){i.d(t,{Iy:()=>n,K$:()=>a,fp:()=>r});var s=i(63762);let r=s.z.enum(["ALL","BILLING_EDIT","BILLING_READ","GROUP_CREATE","GROUP_DELETE","GROUP_EDIT","GROUP_READ"]),n=r,a=s.z.array(r)},11060:function(e,t,i){i.d(t,{B:()=>z});var s,r=i(21636),n=i(48035),a=i(87055),o=i(73827),c=i(4843),d=i(44577),l=i(94190),u=i(59242),p=i(49247),h=i(306),g=i(17741),m=((s={})[s.GroupManager=0]="GroupManager",s);class v{async addRole({role:e,params:t}){if(0===e)return await this.addGroupManager(t)}async removeRole({role:e,params:t}){if(0===e)return await this.removeGroupManager(t)}async getSpecialUserGroupRevision(e){let t;let{commands:{carbon:i}}=this.carbonLegacyClient,s=await i({name:"getSpecialUserGroupRevision",args:[{teamId:e}]});if((0,h.d6)(s)){let{carbonResult:e}=s.data,{specialUserGroupRevision:i}=e;t=i}else throw s.error.error;return t}async removeGroupManager({memberLogin:e,teamId:t}){let i=await this.getSpecialUserGroupRevision(t);return await (0,d.z)(this.serverApiClient.v1.teams.removeGroupManager({memberLogin:e,userGroupRevision:i}).pipe((0,g.DZ)(e=>{throw Error(e.message)}),(0,g.lk)(e=>{if(e.data)return(0,h.Vp)(void 0);throw Error("Unknown server error occurred while attempting to remove group manager")})))}async addGroupManager({memberLogin:e,teamId:t}){let i=await this.getSpecialUserGroupRevision(t),{commands:{carbon:s}}=this.carbonLegacyClient,r=await s({name:"getSpecialUserGroupInviteValuesForMemberInTeam",args:[{memberLogin:e,teamId:t}]}),n="",a="";if((0,h.d6)(r)){let{carbonResult:e}=r.data,{groupKey:t,proposeSignature:i}=e;n=t,a=i}else throw r.error.error;return await (0,d.z)(this.serverApiClient.v1.teams.addGroupManager({memberLogin:e,groupKey:n,proposeSignature:a,userGroupRevision:i}).pipe((0,g.DZ)(e=>{throw Error(e.message)}),(0,g.lk)(e=>{if(e.data)return(0,h.Vp)(void 0);throw Error("Unknown server error occurred while attempting to add group manager")})))}constructor(e,t){this.serverApiClient=e,this.carbonLegacyClient=t}}v=(0,r.gn)([(0,l.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===u.l?Object:u.l,void 0===p._?Object:p._])],v);var y=i(59982),w=i(68238),S=i(20458),f=i(15021),E=i(12160);let I=e=>E.K$.safeParse(e).success;class b extends(0,y.Q)({storage:{schemaVersion:1,initialValue:[],typeGuard:I},persist:!0,scope:f.F.User,storeName:"permissions-store",capacity:w.Y._010KB,codec:S.E}){}var A=i(88826),C=i(51870),R=i(70554),_=i(72907),O=i(69853),T=i(53868),F=i(42589),D=i(14098),U=i(37595),P=i(17507);class x extends P.f{}x=(0,r.gn)([(0,l.GS)()],x);class N{async refreshState(){let{getActiveSpaces:e}=this.carbon.queries;return await (0,d.z)(e().pipe((0,_.w)(e=>{if(!(0,h.d6)(e))throw Error("Cannot retrieve user spaces from carbon");return e.data.length?this.fetchPermissions().pipe((0,T.b)(e=>{(0,h.d6)(e)&&this.permissionsStore.set(this.serverToDomainPermissionsMapper(e.data.permissions))})):(0,O.of)(void 0)}),(0,T.b)(()=>{this.eventEmitter.sendEvent("permissionsLoaded",void 0)})))}getActiveUserPermissions(){return this.permissionsStore.state$.pipe((0,F.U)(h.Vp))}fetchPermissions(){return this.serverApiClient.v1.teams.getUserPermissions().pipe((0,F.U)(e=>(0,h.hx)(e)?(0,R.EQ)(e.error,{...(0,D.X)(()=>{throw Error("Unexpected server error while attempting to fetch permissions")}),BusinessError:()=>(0,h.Rn)((0,U.GQ)())}):(0,h.Vp)(e.data.data)))}serverToDomainPermissionsMapper(e){return e.filter(e=>E.Iy.safeParse(e).success)}constructor(e,t,i,s){this.carbon=e,this.serverApiClient=t,this.permissionsStore=i,this.eventEmitter=s}}N=(0,r.gn)([(0,l.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===p._?Object:p._,void 0===u.l?Object:u.l,b,void 0===x?Object:x])],N);class L{async handle(){await this.permissionsService.refreshState()}constructor(e){this.permissionsService=e}}L=(0,r.gn)([(0,C.b)(A.M),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===N?Object:N])],L);var k=i(37368),j=i(49629);class G{async execute({body:e}){return await this.roleService.addRole({role:m.GroupManager,params:e})}constructor(e){this.roleService=e}}G=(0,r.gn)([(0,k.W)(j.B),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===v?Object:v])],G);var V=i(30273);class M{async execute({body:e}){return await this.roleService.removeRole({role:m.GroupManager,params:e})}constructor(e){this.roleService=e}}M=(0,r.gn)([(0,k.W)(V.d),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===v?Object:v])],M);var K=i(62506);class W{execute(){return this.permissionsService.getActiveUserPermissions()}constructor(e){this.permissionsService=e}}W=(0,r.gn)([(0,K.e)(U.lO),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===N?Object:N])],W);class z{}z=(0,r.gn)([(0,n.Y)({api:a.J,imports:[c.n],providers:[x,N,v],stores:[b],handlers:{commands:{addGroupManager:G,removeGroupManager:M},events:{...(0,n.g)(o.Q,{sessionOpened:L})},queries:{userPermissions:W}}})],z)},47146:function(e,t,i){i.d(t,{j:()=>C});var s=i(36503),r=i(27402),n=i(86289),a=i(67732),o=i(43611),c=i(54124),d=i(34695),l=i(99542),u=i(58781),p=i(73271),h=i(53129),g=i(63921),m=i(75476),v=i(7820),y=i(12086),w=i(34399),S=i(24151),f=i(72157),E=i(85076),I=i(56084),b=i(68362),A=i(34450);let C=(0,s.Q)({name:"accountRecoveryKey",commands:{acknowledgeRecoveryActivation:r.yZ,goToActivationNextStep:n.Z,goToActivationPrevStep:a.H,requestActivation:o.e,resetActivationFlow:c.W,cancelGeneration:d.r,confirmActivation:l.W,confirmNewPassword:u.v,deactivate:p.E,submitRecoveryKey:h.Y,tryAgainRecovery:g.d,cancelRecoveryFlow:m.b,startRecoveryFlow:v.Q,clearWrongRecoveryKeyError:y.u,createPin:w.f,submitPin:S.W},queries:{shouldNotifyOfRecoveryActivation:f.a,activationFlowStatus:E.S,accountRecoveryKeyStatus:I.D,recoveryFlowStatus:b.y,recoveryMethodsInfo:A.V},events:{}})},27402:function(e,t,i){i.d(t,{yZ:()=>n});var s=i(66122),r=i(15021);(0,i(96272).Vj)("unable_to_acknowledge_notification","Unable to acknowledge notification");class n extends(0,s.g)({scope:r.F.User}){}},34695:function(e,t,i){i.d(t,{r:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},75476:function(e,t,i){i.d(t,{b:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},12086:function(e,t,i){i.d(t,{u:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},99542:function(e,t,i){i.d(t,{W:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},58781:function(e,t,i){i.d(t,{v:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},34399:function(e,t,i){i.d(t,{f:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},73271:function(e,t,i){i.d(t,{E:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},86289:function(e,t,i){i.d(t,{Z:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},67732:function(e,t,i){i.d(t,{H:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},43611:function(e,t,i){i.d(t,{e:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},54124:function(e,t,i){i.d(t,{W:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},7820:function(e,t,i){i.d(t,{Q:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},24151:function(e,t,i){i.d(t,{W:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},53129:function(e,t,i){i.d(t,{Y:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},63921:function(e,t,i){i.d(t,{d:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},56084:function(e,t,i){i.d(t,{D:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},85076:function(e,t,i){i.d(t,{S:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},68362:function(e,t,i){i.d(t,{y:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},34450:function(e,t,i){i.d(t,{V:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},72157:function(e,t,i){i.d(t,{a:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},34104:function(e,t,i){i.d(t,{D:()=>t9});var s,r,n,a=i(21636),o=i(44577),c=i(47146),d=i(77878),l=i(48035),u=i(90573),p=i(70438),h=i(29047),g=i(99481),m=i(79374),v=i(544),y=i(4843),w=i(87253),S=i(306),f=i(73827),E=i(52726),I=i(56144),b=i(42589),A=i(49247),C=i(59242),R=i(94190),_=i(17741),O=i(70554),T=i(649),F=i(15021),D=i(59982),U=i(68238);let P=e=>!!e&&"object"==typeof e&&"isEnabled"in e;class x extends(0,D.Q)({initialValue:{isEnabled:void 0,login:void 0},persist:!1,scope:F.F.Device,storeName:"account-recovery-key",storeTypeGuard:P,capacity:U.Y._001KB}){}let N=["email_token","totp","duo_push","dashlane_authenticator"];var L=i(51721);let k=e=>(0,L.K)(e)&&"type"in e&&"dashlane_authenticator"!==e.type;var j=i(96272),G=((s={}).GENERIC_ERROR="GENERIC_ERROR",s.NETWORK_ERROR="NETWORK_ERROR",s.PIN_MISMATCH_ERROR="PIN_MISMATCH_ERROR",s.INITIALIZE_MACHINE_ERROR="INITIALIZE_MACHINE_ERROR",s.WRONG_RECOVERY_KEY_ERROR="WRONG_RECOVERY_KEY_ERROR",s.CHANGE_MASTER_PASSWORD_ERROR="CHANGE_MASTER_PASSWORD_ERROR",s);let V=e=>e instanceof Error&&e.message.includes("Signature cannot be verified");class M extends(0,j.Hu)("NETWORK_ERROR","There is an issue with your connection"){}class K{getAuthTicketInfo(){let{carbonState:e}=this.carbon.queries;return(0,o.z)(e({path:"userSession.authTicketInfo"}).pipe((0,_.nb)({success:e=>e,failure:()=>{throw Error("Failure getting auth ticket info")}})))}retrieveLocalAccounts(){let{carbonState:e}=this.carbon.queries;return(0,o.z)(e({path:"authentication.localAccounts"}).pipe((0,I.h)(S.d6),(0,I.h)(e=>e.data.accountsListInitialized),(0,b.U)(e=>e.data.accountsList)))}async getCurrentPersonalSettings(){let{carbonStateList:e}=this.carbon.queries;return await (0,o.z)(e({paths:["userSession.personalSettings.AccountRecoveryKey","userSession.personalSettings.AccountRecoveryKeyId"]}).pipe((0,_.nb)({success:([e,t])=>({AccountRecoveryKey:e,AccountRecoveryKeyId:t}),failure:()=>{throw Error("Failure getting state list")}})))}getCurrentRecoveryKey(){return this.getCurrentPersonalSettings()}getLastAuthenticatedUserRecoveryData(){return this.store.state$.pipe((0,b.U)(e=>({isEnabled:e.isEnabled,login:e.login})))}async updateLastAuthenticatedUserRecoveryStatus(e){if(!e)throw Error("No user login provided");let t=await (0,o.z)(this.serverApiClient.v1.accountrecovery.getStatus({login:e}));if((0,S.hx)(t))throw Error("Server call failed");await this.store.set({isEnabled:t.data.data.enabled,login:e})}async generateRecoveryKey(){let{carbon:e}=this.carbon.commands;return await e({name:"generatePassword",args:[{settings:{length:28,digits:!0,letters:!0,avoidAmbiguous:!0,symbols:!1}}]})}async setPersonalSettings(e){let{updateAccountRecoveryKeyPersonalSettings:t}=this.carbon.commands;return await t(e)}async getAccountInfo(e){return await (0,o.z)(this.serverApiClient.v1.authentication.getAuthenticationMethodsForDevice({login:e,methods:N}).pipe((0,_.DZ)(e=>(0,O.EQ)(e,{BusinessError:()=>{throw Error(G.GENERIC_ERROR)},FetchFailedError:()=>new M,InternalServerError:T.j,InvalidRequest:T.j,RateLimited:T.j,ServiceUnavailable:T.j,UnspecifiedBadStatus:T.j})),(0,_.lk)(e=>{let t=e.data.verifications.find(k);if(t)return(0,S.Vp)({verificationMethod:t,accountType:e.data.accountType});throw Error("Unsupported authentication method")})))}async requestActivation(e){return await (0,o.z)(this.serverApiClient.v1.accountrecovery.requestActivation({encryptedVaultKey:e}).pipe((0,_.DZ)(e=>(0,O.EQ)(e,{BusinessError:()=>{throw Error(G.GENERIC_ERROR)},FetchFailedError:()=>new M,UnspecifiedBadStatus:T.j,InternalServerError:T.j,InvalidRequest:T.j,RateLimited:T.j,ServiceUnavailable:T.j})),(0,_.lk)(e=>{if(e.data.recoveryId)return(0,S.Vp)(e.data.recoveryId);throw Error(G.GENERIC_ERROR)})))}async confirmActivation(e){return await (0,o.z)(this.serverApiClient.v1.accountrecovery.confirmActivation({recoveryId:e}).pipe((0,_.DZ)(e=>(0,O.EQ)(e,{BusinessError:()=>{throw Error(G.GENERIC_ERROR)},FetchFailedError:()=>new M,UnspecifiedBadStatus:T.j,InternalServerError:T.j,InvalidRequest:T.j,RateLimited:T.j,ServiceUnavailable:T.j})),(0,_.lk)(()=>(0,S.Vp)(void 0))))}async deactivate(e){return await (0,o.z)(this.serverApiClient.v1.accountrecovery.deactivate({reason:e}).pipe((0,_.DZ)(e=>(0,O.EQ)(e,{BusinessError:()=>{throw Error(G.GENERIC_ERROR)},FetchFailedError:()=>new M,UnspecifiedBadStatus:T.j,InternalServerError:T.j,InvalidRequest:T.j,RateLimited:T.j,ServiceUnavailable:T.j})),(0,_.lk)(()=>(0,S.Vp)(void 0))))}async getEncryptedVaultKey(e,t){return await (0,o.z)(this.serverApiClient.v1.accountrecovery.getEncryptedVaultKey({login:e,authTicket:t}).pipe((0,_.DZ)(e=>(0,O.EQ)(e,{BusinessError:()=>{throw Error(G.GENERIC_ERROR)},FetchFailedError:()=>new M,UnspecifiedBadStatus:T.j,InternalServerError:T.j,InvalidRequest:T.j,RateLimited:T.j,ServiceUnavailable:T.j})),(0,_.lk)(e=>{let{encryptedVaultKey:t,recoveryId:i}=e.data;if(t&&i)return(0,S.Vp)({encryptedVaultKey:t,recoveryId:i});throw Error(G.GENERIC_ERROR)})))}constructor(e,t,i){this.store=e,this.serverApiClient=t,this.carbon=i}}K=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[x,void 0===C.l?Object:C.l,void 0===A._?Object:A._])],K);var W=i(16620);class z{async decrypt(e,t){return new TextDecoder().decode(await this.flexibleDecryptor.decrypt(e,t))}constructor(e){this.flexibleDecryptor=e}}z=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===W.a?Object:W.a])],z);var q=i(17721),B=i(97702),Y=i(14006),Q=i(49);class H{makeDerivationConfig(e){let[,,t]=e.split("$");return"pbkdf2"===t?Y.E1:Y.mr}async getUserCryptoConfig(){let{carbonStateList:e}=this.carbon.queries;return await (0,o.z)(e({paths:["userSession.personalSettings.CryptoFixedSalt","userSession.personalSettings.CryptoUserPayload"]}).pipe((0,_.nb)({success:([e,t])=>{if("string"!=typeof e)throw Error("Fixed salt is not a string");if("string"!=typeof t)throw Error("Marker is not a string");return{fixedSalt:e,derivationConfig:this.makeDerivationConfig(t)}},failure:()=>{throw Error("Failure getting state list")}})))}async getUserMasterPassword(){let{carbonState:e}=this.carbon.queries;return await (0,o.z)(e({path:"userSession.session.masterPassword"}).pipe((0,b.U)(e=>{if(!(0,S.d6)(e))throw Error("Error when fetching master password from session");let t=e.data;if("string"!=typeof t)throw Error("Result data is not a string");return new TextEncoder().encode(t)})))}async encrypt(e){let t=await this.getUserMasterPassword(),{derivationConfig:i,fixedSalt:s}=await this.getUserCryptoConfig();return await this.flexibleEncryptor.encrypt(e,t,i,Q.Nw,{salt:(0,B.R)(s)})}constructor(e,t){this.carbon=e,this.flexibleEncryptor=t}}H=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===A._?Object:A._,void 0===q._?Object:q._])],H);var $=i(83267),X=i(21039),Z=i(20458),J=i(63762);let ee=J.z.object({lastCheckedIntegrityKeyId:J.z.optional(J.z.string())}),et=e=>ee.safeParse(e).success;class ei extends(0,D.Q)({persist:!0,storeName:"integrity",codec:Z.E,scope:F.F.User,storage:{initialValue:{},schemaVersion:0,typeGuard:et},isCache:!1,capacity:U.Y._001KB}){}var es=i(83533),er=i(82343),en=i(19855);class ea{async executeWithParams(e,t){let i=await this.accountRecoveryKeyService.getCurrentPersonalSettings();if(await this.accountRecoveryKeyService.setPersonalSettings({AccountRecoveryKey:e,AccountRecoveryKeyId:t}),(0,S.hx)(await this.syncService.waitForSync(es.Trigger.SettingsChange)))return await this.accountRecoveryKeyService.setPersonalSettings(i),(0,S.Rn)({tag:G.GENERIC_ERROR});let s=await this.accountRecoveryKeyService.confirmActivation(t);if((0,S.hx)(s))return(await this.accountRecoveryKeyService.setPersonalSettings(i),(0,S.hx)(await this.syncService.waitForSync(es.Trigger.SettingsChange)))?(0,S.Rn)({tag:G.GENERIC_ERROR}):(0,S.Rn)({tag:s.error.tag});let r=await (0,o.z)(this.session.queries.selectedOpenedSession());if(!(0,S.d6)(r)||!r.data)throw Error("No users logged in");return await this.accountRecoveryKeyService.updateLastAuthenticatedUserRecoveryStatus(r.data),Promise.resolve((0,S.Vp)(void 0))}constructor(e,t,i){this.accountRecoveryKeyService=e,this.syncService=t,this.session=i}}ea=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===K?Object:K,void 0===er._?Object:er._,void 0===en.x?Object:en.x])],ea);class eo extends(0,g.ne)(){}let ec="authentication_ark_integrity_fixup_web_dev";class ed{async shouldCheck(){let e=await this.arkService.getCurrentRecoveryKey();return!!e.AccountRecoveryKey&&(await this.store.getState()).lastCheckedIntegrityKeyId!==e.AccountRecoveryKeyId&&await (0,o.z)(this.ffClient.queries.userFeatureFlip({featureFlip:ec}).pipe((0,b.U)(e=>((0,S.d6)(e)&&e.data)??!1)))}async updateLastCheck(e){await this.store.set({lastCheckedIntegrityKeyId:e})}async renewEncryptedVaultKeyIfUnusuable(e,t=!1){if(!t&&!await this.shouldCheck())return;let{arkService:i,decryptor:s,encryptor:r}=this,n=await i.getCurrentRecoveryKey();if(!n.AccountRecoveryKey)return;let a=new TextEncoder().encode(n.AccountRecoveryKey),c=await (0,o.z)(this.server.v1.accountrecovery.getAuthenticatedEncryptedVaultKey());if(!(0,S.d6)(c))throw Error("Failed to check encrypted vault key on server side");let{data:{encryptedVaultKey:d}}=c.data,l=(0,B.R)(d);await s.decrypt(a,l)===e&&this.logger.log("ARK encryped key has been fixed!");let u=await r.encrypt(a),p=await i.requestActivation((0,$.s)(u));if(!(0,S.d6)(p))throw Error("Could not get current encrypted VK");let h=p.data,g=await this.activationService.executeWithParams(n.AccountRecoveryKey,h);if(!(0,S.d6)(g))throw Error("Failed to confirm");await this.updateLastCheck(h)}constructor(e,t,i,s,r,n,a,o){this.arkService=e,this.encryptor=t,this.decryptor=i,this.ffClient=s,this.server=r,this.store=n,this.logger=a,this.activationService=o}}ed=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===K?Object:K,void 0===H?Object:H,void 0===z?Object:z,void 0===X.P?Object:X.P,void 0===C.l?Object:C.l,ei,eo,void 0===ea?Object:ea])],ed);var el=i(97512),eu=i(51870),ep=i(88826);class eh{async handle({body:{sessionKey:e}}){if("mp"!==e.type)return;let{masterPassword:t}=e;await Promise.race([()=>new Promise(e=>setTimeout(e,100)),this.allowedToFail.doOne(()=>this.service.renewEncryptedVaultKeyIfUnusuable(t),{methodName:"SessionOpenedEventHandler:handle",criticality:el.Tr.CRITICAL})])}constructor(e,t){this.service=e,this.allowedToFail=t}}eh=(0,a.gn)([(0,eu.b)(ep.M),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===ed?Object:ed,void 0===h.J?Object:h.J])],eh);var eg=i(69334),em=i(84408),ev=i(22050),ey=i(71581),ew=i(39559);let eS=e=>!0;class ef extends(0,D.Q)({initialValue:void 0,persist:!1,scope:F.F.Device,storeName:"activation-flow-machine",storeTypeGuard:eS}){}let eE=async(e,t)=>{await e.set(JSON.stringify(t))},eI=async e=>{let t=await e.getState();return t?ew.ZM.create(JSON.parse(t)):void 0},eb=e=>e.state$.pipe((0,b.U)(e=>e?ew.ZM.create(JSON.parse(e)):void 0));var eA=i(83833),eC=i(23269),eR=i(37196);class e_{async execute(){try{let e=await (0,o.z)(this.recoveryKeyService.getLastAuthenticatedUserRecoveryData());return Promise.resolve({isFeatureEnabled:e.isEnabled,recoveryKey:"",recoveryId:"",encryptedVaultKey:""})}catch(e){return Promise.reject(Error("Unable to retrieve initialization data"))}}constructor(e){this.recoveryKeyService=e}}e_=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===K?Object:K])],e_);var eO=i(87169),eT=i(91012);class eF{async executeWithParams(e){if(e.recoveryKey)return(0,S.Vp)({recoveryKey:e.recoveryKey,encryptedVaultKey:e.encryptedVaultKey,recoveryId:e.recoveryId});let t=await this.accountRecoveryKeyService.generateRecoveryKey();if((0,S.hx)(t))return(0,S.Rn)({tag:G.GENERIC_ERROR});let i=(0,eO.u)(t.data.carbonResult.password.toUpperCase()),s=await this.recoveryKeyEncryptor.encrypt(i),r=(0,$.s)(s),n=await this.accountRecoveryKeyService.requestActivation(r);return(0,S.hx)(n)?(0,S.Rn)({tag:n.error.tag}):(0,S.Vp)({recoveryKey:(0,eT.v)(i),encryptedVaultKey:r,recoveryId:n.data})}constructor(e,t){this.accountRecoveryKeyService=e,this.recoveryKeyEncryptor=t}}eF=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===K?Object:K,void 0===H?Object:H])],eF);class eD{desc(e=!1){let t={config:{predictableActionArguments:!0,schema:{events:{},context:{}},initial:"Starting",id:"ActivationFlowMachine",context:{isFeatureEnabled:!1,recoveryKey:"",recoveryId:"",encryptedVaultKey:""},states:{Starting:{invoke:{src:"initializeMachine",onDone:[{actions:["assignInitialContext"],target:"InitAccountRecoveryKeyActivation",cond:"isActivationFlow"},{actions:["assignInitialContext"],target:"GenerateNewAccountRecoveryKey"}]}},InitAccountRecoveryKeyActivation:{on:{REQUEST_ACTIVATION:{target:"RequestingActivation"}}},RequestingActivation:{invoke:{src:"requestActivation",onDone:[{cond:"isFunctionalError",actions:["assignFunctionalError"],target:"AccountRecoveryKeyActivationError"},{actions:["assignKeys"],target:"DisplayAccountRecoveryKey"}],onError:{actions:["assignGenericError"],target:"AccountRecoveryKeyActivationError"}}},DisplayAccountRecoveryKey:{on:{GO_TO_NEXT_STEP:{target:"ConfirmAccountRecoveryKey"}}},ConfirmAccountRecoveryKey:{on:{GO_TO_NEXT_STEP:{target:"FinalisingAccountRecoveryKeyActivation"},GO_TO_PREV_STEP:{target:"DisplayAccountRecoveryKey"}}},FinalisingAccountRecoveryKeyActivation:{invoke:{src:"confirmActivation",onDone:[{cond:"isFunctionalError",actions:["assignFunctionalError"],target:"AccountRecoveryKeyActivationError"},{target:"AccountRecoveryKeyActivationDone"}],onError:{actions:["assignGenericError"],target:"AccountRecoveryKeyActivationError"}}},AccountRecoveryKeyActivationDone:{},GenerateNewAccountRecoveryKey:{on:{REQUEST_ACTIVATION:{target:"RequestingActivation"},CANCEL_GENERATION:{target:"CancelNewAccountRecoveryKey"}}},CancelNewAccountRecoveryKey:{on:{GO_TO_PREV_STEP:{target:"GenerateNewAccountRecoveryKey"}}},AccountRecoveryKeyActivationError:{on:{GO_TO_PREV_STEP:{target:"RequestingActivation"}}}},on:{RESET_FLOW:{actions:["clearContext"],target:"Starting"}}},options:{actions:{assignInitialContext:(0,eA.f0)({encryptedVaultKey:(e,t)=>t.data.encryptedVaultKey,recoveryKey:(e,t)=>t.data.recoveryKey,recoveryId:(e,t)=>t.data.recoveryId,isFeatureEnabled:(e,t)=>t.data.isFeatureEnabled}),assignKeys:(0,eA.f0)({recoveryKey:(e,t)=>t.data.data.recoveryKey,encryptedVaultKey:(e,t)=>t.data.data.encryptedVaultKey,recoveryId:(e,t)=>t.data.data.recoveryId}),assignFunctionalError:(0,eA.f0)({error:(e,t)=>t.data.error.tag}),assignGenericError:(0,eA.f0)({error:()=>G.GENERIC_ERROR}),clearContext:(0,eA.f0)({encryptedVaultKey:()=>"",recoveryKey:()=>"",recoveryId:()=>"",error:()=>void 0})},services:{initializeMachine:()=>this.initializeMachineService.execute(),requestActivation:e=>this.requestActivationService.executeWithParams(e),confirmActivation:e=>this.confirmActivationService.executeWithParams(e.recoveryKey,e.recoveryId)},guards:{isActivationFlow:(e,t)=>t.type.startsWith("done.invoke.ActivationFlowMachine.Starting")&&!t.data.isFeatureEnabled,isFunctionalError:(e,t)=>(t.type.startsWith("done.invoke.ActivationFlowMachine.RequestingActivation")||t.type.startsWith("done.invoke.ActivationFlowMachine.FinalisingAccountRecoveryKeyActivation"))&&(0,S.hx)(t.data)}}};return e&&(0,eR.G)(t.config),t}create(e=!1){let{config:t,options:i}=this.desc(e);return(0,eC.C)(t,i)}constructor(e,t,i){this.initializeMachineService=e,this.requestActivationService=t,this.confirmActivationService=i,this.initializeMachineService=e,this.requestActivationService=t,this.confirmActivationService=i}}eD=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e_?Object:e_,void 0===eF?Object:eF,void 0===ea?Object:ea])],eD);class eU{async prepare(){if(this.interpreter)try{let e=await eI(this.activationMachineStore);try{this.interpreter.start(e)}catch(e){console.error("[ARK Activation] Unable to reuse the stored state: ",e),this.interpreter.start()}}catch(e){console.error("[ARK Activation] Unable to start machine",e)}}ready(){return new em.X(!0)}continue(e){if(!this.interpreter)throw Error("Activation flow not started");this.interpreter.send(e)}stop(){this.isStarted()&&(this.interpreter=void 0)}isStarted(){return!!this.interpreter}constructor(e,t,i,s){this.activationMachineStore=i,this.allowedToFail=s,this.activationMachineStore=i;let r=e.create(t);this.interpreter=eg.kJ(r).onTransition((0,ev.V)(e=>{this.allowedToFail.doOne(()=>{throw e})})).onEvent((0,ey.V)(e=>{this.allowedToFail.doOne(()=>{throw e})})).onTransition(async()=>{let e=this.interpreter?.getSnapshot();e&&await eE(this.activationMachineStore,e)})}}eU=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===eD?Object:eD,Boolean,ef,void 0===h.J?Object:h.J])],eU);var eP=i(73142),ex=i(21958);class eN extends(0,D.Q)({initialValue:{},persist:!1,scope:F.F.Device,storeName:"admin-assisted-recovery-notification",capacity:U.Y._001KB}){}var eL=i(99178);let ek=(e,t,i)=>i-t>=36e5*e,ej=({isFirstSessionAfterAccountCreation:e,isSSOUser:t,requires2FAEnforcement:i,accountRecoveryNotificationAlreadyAcknowledged:s,isAdminAssistedRecoveryEnabled:r,isTeamSoftDiscontinued:n,userAdminAssistedRecoveryOptIn:a})=>!e&&!t&&!i&&!n&&!s&&r&&!a,eG=e=>!e.isAllowed&&e.reasons.includes(eL.Oq.Requires2FAEnforcement),eV=e=>e.b2bStatus?.currentTeam?.isSoftDiscontinued===!0,eM=e=>{let t=e.seenAt;return!!t&&!ek(1,t,Date.now())};class eK{async acknowledgeRecoveryActivation(){let{commands:e}=this.carbonLegacyClient;return await e.activateAccountRecovery(),await this.store.set({seenAt:Date.now()}),(0,S.Vp)(void 0)}constructor(e,t,i){this.store=e,this.carbonLegacyClient=t,this.vaultAccessClient=i,this.getShouldNotifyOfAARActivation$=()=>{let{carbonState:e}=this.carbonLegacyClient.queries,{queries:t}=this.carbonLegacyClient,i=e({path:"userSession.session.isFirstSessionAfterAccountCreation"}),s=this.vaultAccessClient.queries.isAllowed(),r=t.getIsRecoveryEnabled(),n=t.getNodePremiumStatus(),a=t.getIsSSOUser(),o=t.getRecoveryOptInSetting();return this.store.state$.pipe((0,ex.V)(s,r,n,a,i,o),(0,b.U)(([e,t,i,s,r,n,a])=>{if((0,S.hx)(t)||(0,S.hx)(i)||(0,S.hx)(s)||(0,S.hx)(r)||(0,S.hx)(n)||(0,S.hx)(a))throw Error("Failed to query recovery activation notification");let o=eM(e),c=eG((0,S.db)(t)),d=!!(0,S.db)(n),l=!!(0,S.db)(r),u=!!(0,S.db)(a),p=ej({isFirstSessionAfterAccountCreation:d,isSSOUser:l,requires2FAEnforcement:c,accountRecoveryNotificationAlreadyAcknowledged:o,isAdminAssistedRecoveryEnabled:!!(0,S.db)(i),isTeamSoftDiscontinued:eV((0,S.db)(s)),userAdminAssistedRecoveryOptIn:u});return(0,S.Vp)(p)}))}}}eK=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[eN,void 0===A._?Object:A._,void 0===eP.N?Object:eP.N])],eK);let eW=e=>!0;class ez extends(0,D.Q)({initialValue:void 0,persist:!1,scope:F.F.Device,storeName:"recovery-flow-machine",storeTypeGuard:eW}){}let eq=async(e,t)=>{await e.set(JSON.stringify(t))},eB=async e=>{let t=await e.getState();return t?ew.ZM.create(JSON.parse(t)):void 0},eY=e=>e.state$.pipe((0,b.U)(e=>e?ew.ZM.create(JSON.parse(e)):void 0));class eQ{async executeWithParams(e){try{let{authTicket:t}=await this.recoveryKeyService.getAuthTicketInfo(),i=await this.recoveryKeyService.getAccountInfo(e);if((0,S.hx)(i))throw Error("Unable to retrieve verifications methods for login");return Promise.resolve({authTiket:t??"",accountType:i.data.accountType,verificationMethod:i.data.verificationMethod})}catch(e){return Promise.reject(Error("Unable to retrieve initialization data"))}}constructor(e){this.recoveryKeyService=e}}eQ=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===K?Object:K])],eQ);class eH{async executeWithParams({login:e,authTicket:t,recoveryKey:i}){try{let s=await this.accountRecoveryKeyService.getEncryptedVaultKey(e,t);if((0,S.hx)(s))return Promise.reject(G.GENERIC_ERROR);let r=(0,eO.u)(i),n=(0,B.R)(s.data.encryptedVaultKey),a=await this.recoveryKeyDecryptor.decrypt(r,n);return Promise.resolve({oldPassword:a})}catch(e){if(V(e))return Promise.reject(G.WRONG_RECOVERY_KEY_ERROR);return Promise.reject(G.GENERIC_ERROR)}}constructor(e,t){this.accountRecoveryKeyService=e,this.recoveryKeyDecryptor=t}}eH=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===K?Object:K,void 0===z?Object:z])],eH);var e$=i(42758),eX=i(64773);class eZ{async executeWithParams(e){try{let{cleanRemotelyRemovedProfiles:t,registerDevice:i}=this.deviceRegistration.commands,{localAccounts:s}=this.deviceRegistration.queries;await t();let r=await (0,o.z)(s());if((0,S.hx)(r))return Promise.reject(Error(`[ARK] - Error while fetching local accounts: ${r.error}`));return r.data.localAccounts.some(t=>t.login===e.login)||await i({with:"authTicket",login:e.login,authTicket:e.authTicket}),Promise.resolve(void 0)}catch(e){return Promise.reject(G.GENERIC_ERROR)}}constructor(e){this.deviceRegistration=e}}eZ=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===eX.z?Object:eX.z])],eZ);class eJ{async executeWithParams(e){let{commands:t}=this.carbon;try{await this.deviceRegistrationService.executeWithParams(e);let i=await t.openSessionWithMasterPassword({login:e.login,password:e.oldPassword,rememberPassword:!1,requiredPermissions:void 0,loginType:"MasterPasswordARK"});if((0,S.hx)(i))return Promise.reject(Error(`[ARK] - Error while trying to open session with deciphered recovery key: ${i.error}`));let s=await t.changeMasterPassword({newPassword:e.newPassword,currentPassword:e.oldPassword,flow:e$.pT.ACCOUNT_RECOVERY_KEY});if((0,S.hx)(s)||!s.data.success)return Promise.reject(Error(`[ARK] - Error while changing user Master Password (${"failure"===s.tag?s.error:""})`));return Promise.resolve(void 0)}catch(e){return Promise.reject(Error(`[ARK] - Unable to change user Master Password: ${e}`))}}constructor(e,t){this.carbon=e,this.deviceRegistrationService=t}}eJ=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===A._?Object:A._,void 0===eZ?Object:eZ])],eJ);var e0=i(60160),e6=i(30357);class e1{executeWithParams(e,t){try{return this.identityVerification.commands.startIdentityVerification({login:e,verificationMethod:t.type}),Promise.resolve(void 0)}catch(e){return Promise.reject(Error("Something went wrong..."))}}constructor(e){this.identityVerification=e,this.identityVerification=e}}e1=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e0||void 0===e6.l?Object:e6.l])],e1);var e2=i(83816);class e4{async executeWithParams(e){let{commands:t}=this.carbon;if(e.newPinCode!==e.confirmedPinCode)return Promise.reject(G.PIN_MISMATCH_ERROR);try{await this.deviceRegistrationService.executeWithParams(e);let i=await t.openSessionWithMasterPassword({login:e.login,password:e.oldPassword,rememberPassword:!1,requiredPermissions:void 0,loginType:"PasswordlessARK"});if((0,S.hx)(i))return Promise.reject(Error(`[ARK] - Error while trying to open session with deciphered recovery key: ${i.error}`));return await this.pinCode.commands.activate({pinCode:e.newPinCode}),Promise.resolve(void 0)}catch(e){return Promise.reject(G.GENERIC_ERROR)}}constructor(e,t,i){this.carbon=e,this.pinCode=t,this.deviceRegistrationService=i}}e4=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===A._?Object:A._,void 0===e2.u?Object:e2.u,void 0===eZ?Object:eZ])],e4);class e5{async executeWithParams(e){let{commands:t}=this.carbon;try{await this.deviceRegistrationService.executeWithParams(e);let i=await t.openSessionWithMasterPassword({login:e.login,password:e.oldPassword,rememberPassword:!1,requiredPermissions:void 0,loginType:"invisibleMasterPassword"===e.accountType?"PasswordlessARK":"MasterPasswordARK"});if((0,S.hx)(i))return Promise.reject(Error(`[ARK] - Error while trying to open session with deciphered recovery key: ${i.error}`));return Promise.resolve(void 0)}catch(e){return Promise.reject(G.GENERIC_ERROR)}}constructor(e,t){this.carbon=e,this.deviceRegistrationService=t}}e5=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===A._?Object:A._,void 0===eZ?Object:eZ])],e5);class e9{desc(e=!1){let t={config:{predictableActionArguments:!0,schema:{events:{},context:{}},initial:"Idle",id:"RecoveryFlowMachine",context:{login:"",authTicket:"",newPassword:"",recoveryKey:"",oldPassword:"",encryptedVaultKey:"",newPinCode:"",confirmedPinCode:""},states:{Idle:{entry:["clearContext"],on:{START_RECOVERY_FLOW:{target:"Starting",actions:["assignAccountEmail"]}}},Starting:{invoke:{src:"initializeMachine",onDone:[{actions:["assignInitialContext"],target:"IdentityVerification",cond:"isAuthTicketNeeded"},{actions:["assignInitialContext"],target:"EnterRecoveryKey"}]}},IdentityVerification:{entry:["triggerIdentityVerification"]},EnterRecoveryKey:{on:{SUBMIT_RECOVERY_KEY:{actions:["assignRecoveryKey"],target:"CheckAccountRecoveryKey"}}},CheckAccountRecoveryKey:{invoke:{src:"checkAccountRecoveryKey",onDone:[{actions:["assignOldPassword"],cond:"isMigratingToSSO",target:"OpenSessionWithoutPasswordChange"},{actions:["assignOldPassword"],cond:"isPasswordlessUser",target:"EnterPin"},{actions:["assignOldPassword"],target:"ChangeMasterPassword"}],onError:[{actions:["assignError"],cond:"isWrongRecoveryKeyError",target:"EnterRecoveryKey"},{actions:["assignError"],target:"CheckAccountRecoveryKeyError"}]}},CheckAccountRecoveryKeyError:{on:{TRY_AGAIN:{actions:["clearError"],target:"EnterRecoveryKey"}}},EnterPin:{on:{CREATE_PIN:{actions:["assignNewPinCode"],target:"ConfirmPin"}}},ConfirmPin:{on:{SUBMIT_PIN:{actions:["assignConfirmedPinCode"],target:"OpenPasswordlessSession"}}},OpenPasswordlessSession:{invoke:{src:"openPasswordlessSession",onDone:{target:"RecoverySuccess"},onError:[{actions:["assignError"],cond:"isPinMismatchError",target:"ConfirmPin"},{actions:["assignError"],target:"OpenSessionError"}]}},OpenSessionWithoutPasswordChange:{invoke:{src:"openSessionWithoutPasswordChange",onDone:{target:"RecoverySuccess"},onError:[{actions:["assignError"],target:"OpenSessionError"}]}},ChangeMasterPassword:{on:{CONFIRM_NEW_PASSWORD:{actions:["assignNewPassword"],target:"FinalisingRecovery"}}},FinalisingRecovery:{invoke:{src:"changeMasterPassword",onDone:{target:"RecoverySuccess"},onError:{actions:["assignError"],target:"OpenSessionError"}}},OpenSessionError:{on:{TRY_AGAIN:[{cond:"isPasswordlessUser",target:"EnterPin"},{target:"ChangeMasterPassword"}]}},RecoverySuccess:{type:"final"}},on:{CLEAR_ERROR:{actions:["clearError"]},IDENTITY_VERIFICATION_COMPLETE:{actions:["assignAuthTicket"],target:"EnterRecoveryKey"},CANCEL_RECOVERY_FLOW:{actions:["clearError"],target:"Idle"}}},options:{actions:{assignAccountEmail:(0,eA.f0)({login:(e,t)=>t.login}),assignInitialContext:(0,eA.f0)({authTicket:(e,t)=>t.data.authTiket,accountType:(e,t)=>t.data.accountType,verificationMethod:(e,t)=>t.data.verificationMethod}),assignAuthTicket:(0,eA.f0)({authTicket:(e,t)=>t.authTicket}),assignNewPassword:(0,eA.f0)({newPassword:(e,t)=>t.password}),assignRecoveryKey:(0,eA.f0)({recoveryKey:(e,t)=>t.recoveryKey}),assignOldPassword:(0,eA.f0)({oldPassword:(e,t)=>t.data.oldPassword}),assignNewPinCode:(0,eA.f0)({newPinCode:(e,t)=>t.pinCode}),assignConfirmedPinCode:(0,eA.f0)({confirmedPinCode:(e,t)=>t.pinCode}),assignError:(0,eA.f0)({error:(e,t)=>t.data}),clearError:(0,eA.f0)({error:()=>void 0}),triggerIdentityVerification:e=>{if(!e.verificationMethod)throw Error("No verification method found, initialization went wrong");return this.triggerIdentityVerificationService.executeWithParams(e.login,e.verificationMethod)},clearContext:(0,eA.f0)({login:()=>"",newPassword:()=>"",localAccounts:()=>[],recoveryKey:()=>"",oldPassword:()=>"",encryptedVaultKey:()=>"",authTicket:()=>""})},services:{initializeMachine:e=>this.initializeMachineService.executeWithParams(e.login),checkAccountRecoveryKey:e=>this.checkAccountRecoveryKeyService.executeWithParams(e),changeMasterPassword:e=>this.changeMasterPasswordService.executeWithParams(e),openPasswordlessSession:e=>this.openSessionPasswordLessService.executeWithParams(e),openSessionWithoutPasswordChange:e=>this.openSessionWithoutPasswordChangeService.executeWithParams(e)},guards:{isAuthTicketNeeded:(e,t)=>!t.data.authTiket,isPasswordlessUser:e=>"invisibleMasterPassword"===e.accountType,isWrongRecoveryKeyError:(e,t)=>t.data===G.WRONG_RECOVERY_KEY_ERROR,isPinMismatchError:(e,t)=>t.data===G.PIN_MISMATCH_ERROR,isMigratingToSSO:e=>(e.verificationMethod&&"sso"===e.verificationMethod.type)??!1}}};return e&&(0,eR.G)(t.config),t}create(e=!1){let{config:t,options:i}=this.desc(e);return(0,eC.C)(t,i)}constructor(e,t,i,s,r,n){this.initializeMachineService=e,this.checkAccountRecoveryKeyService=t,this.changeMasterPasswordService=i,this.triggerIdentityVerificationService=s,this.openSessionPasswordLessService=r,this.openSessionWithoutPasswordChangeService=n}}e9=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===eQ?Object:eQ,void 0===eH?Object:eH,void 0===eJ?Object:eJ,void 0===e1?Object:e1,void 0===e4?Object:e4,void 0===e5?Object:e5])],e9);class e3{async prepare(){if(this.interpreter)try{let e=await eB(this.recoveryMachineStore);try{this.interpreter.start(e)}catch(e){console.error("[ARK Recovery] Unable to reuse the stored state: ",e),this.interpreter.start()}}catch(e){console.error("[ARK Recovery] Unable to start machine",e)}}ready(){return new em.X(!0)}continue(e){if(!this.interpreter)throw Error("Recovery flow not started");this.interpreter.send(e)}stop(){this.isStarted()&&(this.interpreter=void 0)}isStarted(){return!!this.interpreter}constructor(e,t,i,s){this.recoveryMachineStore=i,this.allowedToFail=s,this.recoveryMachineStore=i;let r=e.create(t);this.interpreter=eg.kJ(r).onTransition((0,ev.V)(e=>this.allowedToFail.doOne(()=>{throw e}))).onEvent((0,ey.V)(e=>this.allowedToFail.doOne(()=>{throw e}))).onTransition(async()=>{let e=this.interpreter?.getSnapshot();e&&await eq(this.recoveryMachineStore,e)})}}e3=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e9?Object:e9,Boolean,ez,void 0===h.J?Object:h.J])],e3);var e7=i(37368),e8=i(27402);class te{execute(){return this.recoveryActivationNotification.acknowledgeRecoveryActivation()}constructor(e){this.recoveryActivationNotification=e}}te=(0,a.gn)([(0,e7.W)(e8.yZ),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===eK?Object:eK])],te);var tt=i(86289);class ti{execute(){return this.activationFlow.continue({type:"GO_TO_NEXT_STEP"}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.activationFlow=e}}ti=(0,a.gn)([(0,e7.W)(tt.Z),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===eU?Object:eU])],ti);var ts=i(67732);class tr{execute(){return this.activationFlow.continue({type:"GO_TO_PREV_STEP"}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.activationFlow=e}}tr=(0,a.gn)([(0,e7.W)(ts.H),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===eU?Object:eU])],tr);var tn=i(43611);class ta{execute(){return this.activationFlow.continue({type:"REQUEST_ACTIVATION"}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.activationFlow=e}}ta=(0,a.gn)([(0,e7.W)(tn.e),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===eU?Object:eU])],ta);var to=i(54124);class tc{execute(){return this.activationFlow.continue({type:"RESET_FLOW"}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.activationFlow=e}}tc=(0,a.gn)([(0,e7.W)(to.W),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===eU?Object:eU])],tc);var td=i(34695);class tl{execute(){return this.activationFlow.continue({type:"CANCEL_GENERATION"}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.activationFlow=e}}tl=(0,a.gn)([(0,e7.W)(td.r),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===eU?Object:eU])],tl);var tu=i(99542);class tp{execute(){return this.activationFlow.continue({type:"GO_TO_NEXT_STEP"}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.activationFlow=e}}tp=(0,a.gn)([(0,e7.W)(tu.W),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===eU?Object:eU])],tp);var th=i(58781);class tg{execute(e){return this.recoveryFlow.continue({type:"CONFIRM_NEW_PASSWORD",password:e.body.password}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.recoveryFlow=e,this.recoveryFlow=e}}tg=(0,a.gn)([(0,e7.W)(th.v),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e3?Object:e3])],tg);var tm=i(73271);class tv{async execute(e){let{reason:t}=e.body,i=await this.accountRecoveryKeyService.deactivate(t);if((0,S.hx)(i))return this.logger.trace("Deactivate ARK: "+i.error.message),(0,S.Rn)({tag:i.error.tag});let s=await (0,o.z)(this.session.queries.selectedOpenedSession());return(0,S.hx)(s)||!s.data?(this.logger.trace("Deactivate ARK - No session opened",{location:"DeactivateCommandHandler",method:"execute()"}),(0,S.Rn)({tag:G.GENERIC_ERROR})):(await this.accountRecoveryKeyService.updateLastAuthenticatedUserRecoveryStatus(s.data),this.activationFlow.continue({type:"RESET_FLOW"}),await this.accountRecoveryKeyService.setPersonalSettings({AccountRecoveryKey:void 0,AccountRecoveryKeyId:void 0}),await this.allowedToFail.doOne(()=>this.syncService.waitForSync(es.Trigger.SettingsChange),{methodName:"waitForSync"}),(0,S.Vp)(void 0))}constructor(e,t,i,s,r,n){this.accountRecoveryKeyService=e,this.activationFlow=t,this.syncService=i,this.logger=s,this.allowedToFail=r,this.session=n}}tv=(0,a.gn)([(0,e7.W)(tm.E),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===K?Object:K,void 0===eU?Object:eU,void 0===er._?Object:er._,eo,void 0===h.J?Object:h.J,void 0===en.x?Object:en.x])],tv);var ty=i(53129);class tw{execute(e){return this.recoveryFlow.continue({type:"SUBMIT_RECOVERY_KEY",recoveryKey:e.body.recoveryKey}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.recoveryFlow=e}}tw=(0,a.gn)([(0,e7.W)(ty.Y),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e3?Object:e3])],tw);var tS=i(63921);class tf{execute(){return this.recoveryFlow.continue({type:"TRY_AGAIN"}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.recoveryFlow=e}}tf=(0,a.gn)([(0,e7.W)(tS.d),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e3?Object:e3])],tf);var tE=i(75476),tI=i(23506);class tb{execute(){return this.recoveryFlow.continue({type:"CANCEL_RECOVERY_FLOW"}),this.cqrsClient.getClient(d.i).commands.cancelIdentityVerification(),Promise.resolve((0,S.Vp)(void 0))}constructor(e,t){this.recoveryFlow=e,this.cqrsClient=t,this.recoveryFlow=e}}tb=(0,a.gn)([(0,e7.W)(tE.b),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e3?Object:e3,void 0===tI.w?Object:tI.w])],tb);var tA=i(7820);class tC{execute(e){let{login:t}=e.body;return this.recoveryFlow.continue({type:"START_RECOVERY_FLOW",login:t}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.recoveryFlow=e,this.recoveryFlow=e}}tC=(0,a.gn)([(0,e7.W)(tA.Q),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e3?Object:e3])],tC);var tR=i(12086);class t_{execute(){return this.recoveryFlow.continue({type:"CLEAR_ERROR"}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.recoveryFlow=e}}t_=(0,a.gn)([(0,e7.W)(tR.u),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e3?Object:e3])],t_);var tO=i(34399);class tT{execute(e){return this.recoveryFlow.continue({type:"CREATE_PIN",pinCode:e.body.pinCode}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.recoveryFlow=e,this.recoveryFlow=e}}tT=(0,a.gn)([(0,e7.W)(tO.f),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e3?Object:e3])],tT);var tF=i(24151);class tD{execute(e){return this.recoveryFlow.continue({type:"SUBMIT_PIN",pinCode:e.body.pinCode}),Promise.resolve((0,S.Vp)(void 0))}constructor(e){this.recoveryFlow=e,this.recoveryFlow=e}}tD=(0,a.gn)([(0,e7.W)(tF.W),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e3?Object:e3])],tD);var tU=i(82127);class tP{handle(e){let{authTicket:t}=e.body;return this.recoveryFlow.continue({type:"IDENTITY_VERIFICATION_COMPLETE",authTicket:t}),Promise.resolve()}constructor(e){this.recoveryFlow=e,this.recoveryFlow=e}}tP=(0,a.gn)([(0,eu.b)(tU.w),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e3?Object:e3])],tP);var tx=i(62506),tN=i(72157);class tL{execute(){return this.recoveryActivationNotification.getShouldNotifyOfAARActivation$()}constructor(e){this.recoveryActivationNotification=e}}tL=(0,a.gn)([(0,tx.e)(tN.a),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===eK?Object:eK])],tL);var tk=i(36884),tj=i(72233),tG=i(81433),tV=i(85076),tM=i(69853),tK=i(48194),tW=((r={})[r.InitActivation=0]="InitActivation",r[r.RequestActivation=1]="RequestActivation",r[r.DisplayKey=2]="DisplayKey",r[r.ConfirmKey=3]="ConfirmKey",r[r.FinaliseActivation=4]="FinaliseActivation",r[r.ActivationDone=5]="ActivationDone",r[r.ShowError=6]="ShowError",r[r.GenerateNewKey=7]="GenerateNewKey",r[r.CancelGenerateNewKey=8]="CancelGenerateNewKey",r),tz=((n={})[n.InitRecovery=0]="InitRecovery",n[n.IdentityVerification=1]="IdentityVerification",n[n.EnterRecoveryKey=2]="EnterRecoveryKey",n[n.ChangeMasterPassword=3]="ChangeMasterPassword",n[n.EnterPin=4]="EnterPin",n[n.ConfirmPin=5]="ConfirmPin",n[n.Finalising=6]="Finalising",n[n.Success=7]="Success",n[n.Failure=8]="Failure",n);let tq=e=>(0,tM.of)((0,S.Vp)(function(e){if(!e.matches("Starting")){if(e.matches("InitAccountRecoveryKeyActivation"))return{step:tW.InitActivation,isFeatureEnabled:e.context.isFeatureEnabled};if(e.matches("RequestingActivation"))return{step:tW.RequestActivation,isFeatureEnabled:e.context.isFeatureEnabled};if(e.matches("DisplayAccountRecoveryKey"))return{step:tW.DisplayKey,recoveryKey:e.context.recoveryKey,isFeatureEnabled:e.context.isFeatureEnabled};if(e.matches("ConfirmAccountRecoveryKey"))return{step:tW.ConfirmKey,recoveryKey:e.context.recoveryKey,isFeatureEnabled:e.context.isFeatureEnabled};if(e.matches("FinalisingAccountRecoveryKeyActivation"))return{step:tW.FinaliseActivation,isFeatureEnabled:e.context.isFeatureEnabled};if(e.matches("AccountRecoveryKeyActivationDone"))return{step:tW.ActivationDone,isFeatureEnabled:e.context.isFeatureEnabled};if(e.matches("AccountRecoveryKeyActivationError"))return{step:tW.ShowError,error:e.context.error,isFeatureEnabled:e.context.isFeatureEnabled};if(e.matches("GenerateNewAccountRecoveryKey"))return{step:tW.GenerateNewKey,isFeatureEnabled:e.context.isFeatureEnabled};if(e.matches("CancelNewAccountRecoveryKey"))return{step:tW.CancelGenerateNewKey,isFeatureEnabled:e.context.isFeatureEnabled};throw Error(`[ARK Activation] - No view associated to state ${JSON.stringify(e.value)}`)}}(e))),tB=e=>e.pipe((0,tK.z)(tq));var tY=i(4944);let tQ=(e,t)=>{let i=t.matches(e.value),s=(0,tY.Z)(e.context,t.context);return i&&s};class tH{execute(){return(0,tk.a)([eb(this.activationFlowMachineStore),this.activationFlow.ready()],(e,t)=>{if(e&&t)return e}).pipe((0,I.h)(Boolean),(0,tG.x)((e,t)=>tQ(e,t)),tB,(0,tj.K)((e,t)=>(this.logger.error("Error retrieveing account recovery key activation view data",{location:"ActivationFlowStatusQueryHandler",method:"execute()",error:e}),t)))}constructor(e,t,i){this.activationFlow=e,this.activationFlowMachineStore=t,this.logger=i}}tH=(0,a.gn)([(0,tx.e)(tV.S),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===eU?Object:eU,ef,eo])],tH);var t$=i(72907),tX=i(56084);class tZ{execute({body:e}){let{login:t}=e;return""===t?(0,tM.of)((0,S.Vp)({isEnabled:!1})):this.accountRecoveryKeyService.getLastAuthenticatedUserRecoveryData().pipe((0,t$.w)(async e=>((void 0===e.isEnabled||t!==e.login)&&await this.accountRecoveryKeyService.updateLastAuthenticatedUserRecoveryStatus(t),e)),(0,b.U)(e=>(0,S.Vp)({isEnabled:e.isEnabled})))}constructor(e){this.accountRecoveryKeyService=e}}tZ=(0,a.gn)([(0,tx.e)(tX.D),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===K?Object:K])],tZ);var tJ=i(34450);class t0{execute(){let e=this.session.queries.selectedOpenedSession().pipe((0,t$.w)(e=>{if(!(0,S.d6)(e)||!e.data)throw Error("no user provided ");return this.accountRecoveryKeyService.updateLastAuthenticatedUserRecoveryStatus(e.data)}),(0,t$.w)(()=>this.carbonLegacyClient.queries.carbonState({path:"userSession.personalSettings.RecoveryOptIn"})),(0,I.h)(S.d6),(0,b.U)(e=>"boolean"==typeof e.data&&e.data)),t=this.accountRecoveryKeyService.getLastAuthenticatedUserRecoveryData().pipe((0,b.U)(e=>void 0!==e.isEnabled&&e.isEnabled));return(0,tk.a)([e,t]).pipe((0,b.U)(([e,t])=>(0,S.Vp)({adminAssistedRecovery:e,accountRecoveryKey:t})))}constructor(e,t,i){this.accountRecoveryKeyService=e,this.carbonLegacyClient=t,this.session=i}}t0=(0,a.gn)([(0,tx.e)(tJ.V),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===K?Object:K,void 0===A._?Object:A._,void 0===en.x?Object:en.x])],t0);var t6=i(68362);let t1=e=>(0,tM.of)((0,S.Vp)(function(e){if(e.matches("Starting"))return{step:tz.InitRecovery,error:e.context.error};if(e.matches("IdentityVerification"))return{step:tz.IdentityVerification,login:e.context.login};if(e.matches("EnterRecoveryKey")||e.matches("CheckAccountRecoveryKey"))return{step:tz.EnterRecoveryKey,error:e.context.error,accountType:e.context.accountType,isMigratingToSSO:e.context.verificationMethod&&"sso"===e.context.verificationMethod.type};if(e.matches("ChangeMasterPassword"))return{step:tz.ChangeMasterPassword,error:e.context.error};if(e.matches("EnterPin"))return{step:tz.EnterPin,error:e.context.error};if(e.matches("ConfirmPin"))return{step:tz.ConfirmPin,error:e.context.error,pinCode:e.context.newPinCode};if(e.matches("FinalisingRecovery")||e.matches("OpenPasswordlessSession")||e.matches("OpenSessionWithoutPasswordChange"))return{step:tz.Finalising};if(e.matches("RecoverySuccess"))return{step:tz.Success};if(e.matches("CheckAccountRecoveryKeyError")||e.matches("OpenSessionError"))return{step:tz.Failure};throw Error(`[ARK Recovery] - No view associated to state ${JSON.stringify(e.value)}`)}(e))),t2=e=>e.pipe((0,tK.z)(t1));class t4{execute(){return(0,tk.a)([eY(this.recoveryFlowMachineStore),this.recoveryFlow.ready()],(e,t)=>{if(e&&t)return e}).pipe((0,I.h)(Boolean),(0,tG.x)((e,t)=>tQ(e,t)),t2,(0,tj.K)((e,t)=>(this.logger.error("Error retrieving account recovery view data",{location:"RecoveryFlowStatusQueryHandler",method:"execute()",error:e}),t)))}constructor(e,t,i){this.recoveryFlow=e,this.recoveryFlowMachineStore=t,this.logger=i}}t4=(0,a.gn)([(0,tx.e)(t6.y),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===e3?Object:e3,ez,eo])],t4);class t5{async executeWithParams(e,t){let i=await this.accountRecoveryKeyService.deactivate(t);return(0,S.hx)(i)?(this.logger.trace("Deactivate ARK: "+i.error.message),(0,S.Rn)({tag:i.error.tag})):(await this.accountRecoveryKeyService.updateLastAuthenticatedUserRecoveryStatus(e),this.activationFlow.continue({type:"RESET_FLOW"}),await this.accountRecoveryKeyService.setPersonalSettings({AccountRecoveryKey:void 0,AccountRecoveryKeyId:void 0}),await this.allowedToFail.doOne(()=>this.syncService.waitForSync(es.Trigger.SettingsChange),{methodName:"waitForSync"}),(0,S.Vp)(void 0))}constructor(e,t,i,s,r){this.accountRecoveryKeyService=e,this.activationFlow=t,this.syncService=i,this.logger=s,this.allowedToFail=r}}t5=(0,a.gn)([(0,R.GS)(),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[void 0===K?Object:K,void 0===eU?Object:eU,void 0===er._?Object:er._,eo,void 0===h.J?Object:h.J])],t5);class t9{}t9=(0,a.gn)([(0,l.Y)({api:c.j,stores:[ef,ez,x,eN,ei],imports:[y.n,w.D,E.R,u.G],handlers:{commands:{acknowledgeRecoveryActivation:te,goToActivationNextStep:ti,goToActivationPrevStep:tr,requestActivation:ta,resetActivationFlow:tc,cancelGeneration:tl,confirmActivation:tp,confirmNewPassword:tg,deactivate:tv,submitRecoveryKey:tw,tryAgainRecovery:tf,cancelRecoveryFlow:tb,startRecoveryFlow:tC,clearWrongRecoveryKeyError:t_,createPin:tT,submitPin:tD},events:{...(0,l.g)(d.i,{identityVerificationCompleted:tP}),...(0,l.g)(f.Q,{sessionOpened:eh})},queries:{shouldNotifyOfRecoveryActivation:tL,activationFlowStatus:tH,accountRecoveryKeyStatus:tZ,recoveryMethodsInfo:t0,recoveryFlowStatus:t4}},providers:[...(0,p.H)(eU,{inject:[eD,ef,m.c,h.J],asyncFactory:async(e,t,i,s)=>{let r=!1,n=await (0,o.z)(i.queries.platformInfo());(0,S.d6)(n)&&(n.data.buildType===v.P.DEV||n.data.buildType===v.P.NIGHTLY)&&(r=!0);let a=new eU(e,r,t,s);return await a.prepare(),a}}),...(0,p.H)(e3,{inject:[e9,ez,m.c,h.J],asyncFactory:async(e,t,i,s)=>{let r=!1,n=await (0,o.z)(i.queries.platformInfo());(0,S.d6)(n)&&(n.data.buildType===v.P.DEV||n.data.buildType===v.P.NIGHTLY)&&(r=!0);let a=new e3(e,r,t,s);return await a.prepare(),a}}),eD,e9,e_,eQ,eH,e1,K,eZ,eF,ea,z,H,eJ,e4,e5,t5,ed,eK,(0,g.d_)(eo)],requiredFeatureFlips:[ec]})],t9)},6970:function(e,t,i){i.d(t,{X:()=>l});var s=i(36503),r=i(55242),n=i(90105),a=i(74804),o=i(50454),c=i(32576),d=i(67351);let l=(0,s.Q)({name:"accountCreation",commands:{createPasswordlessAccount:r.ck,markMassDeployFirstInitDone:n.$,requestTeamInviteTokenSending:a.V,createSecurityKeyAccount:o.Bj},events:{},queries:{accountCreationMassDeployPolicies:c.d,inviteLinkData:d.$}})},55242:function(e,t,i){i.d(t,{G2:()=>n,ck:()=>a});var s=i(66122),r=i(15021);let n=(0,i(96272).Vj)("NetworkError","The user appears offline");class a extends(0,s.g)({scope:r.F.Device}){}},50454:function(e,t,i){i.d(t,{AB:()=>c,Bj:()=>d,C8:()=>o,JC:()=>a});var s=i(66122),r=i(15021),n=i(96272);let a=(0,n.Vj)("WEB_AUTHN_ERROR","Error while getting prf data from security key"),o=(0,n.Vj)("ACCOUNT_CREATION_ERROR","Error while creating account with security key");(0,n.Vj)("DEVICE_REGISTRATION_ERROR","Error while registering device during security key account creation");let c=(0,n.Vj)("LOGIN_ERROR","Error while logging user in after successful security key account creation");class d extends(0,s.g)({scope:r.F.Device}){}},90105:function(e,t,i){i.d(t,{$:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},74804:function(e,t,i){i.d(t,{V:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},32576:function(e,t,i){i.d(t,{d:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},67351:function(e,t,i){i.d(t,{$:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},84323:function(e,t,i){i.d(t,{v:()=>g});var s=i(36503),r=i(14470),n=i(30170),a=i(81914),o=i(39951),c=i(25608),d=i(22982),l=i(42095),u=i(67024),p=i(39747),h=i(26555);let g=(0,s.Q)({name:"accountManagement",commands:{acceptTeamInvite:r.c,changeAccountType:n.p,initChangeLoginEmail:a.j,completeChangeLoginEmail:o.b,resendVerificationCode:c.h,changeTeamMembersLoginEmail:d.C,completeChangeTeamMemberLoginEmail:l.G,cancelChangeTeamMemberLoginEmail:u.L},events:{},queries:{changeLoginEmailStatus:p.w,pendingLoginChangeRequests:h.A}})},14470:function(e,t,i){i.d(t,{c:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},67024:function(e,t,i){i.d(t,{L:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},30170:function(e,t,i){i.d(t,{p:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},22982:function(e,t,i){i.d(t,{C:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},39951:function(e,t,i){i.d(t,{b:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},42095:function(e,t,i){i.d(t,{G:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},81914:function(e,t,i){i.d(t,{j:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},25608:function(e,t,i){i.d(t,{h:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},39747:function(e,t,i){i.d(t,{v:()=>a,w:()=>o});var s,r=i(45429),n=i(15021),a=((s={}).TOKEN_VALIDATION_FAILED="TOKEN_VALIDATION_FAILED",s.LOGIN_CHANGE_FAILED="LOGIN_CHANGE_FAILED",s);class o extends(0,r.k)({scope:n.F.Device}){}},26555:function(e,t,i){i.d(t,{A:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},84501:function(e,t,i){i.d(t,{l:()=>o});var s=i(36503),r=i(14977),n=i(43490),a=i(89705);let o=(0,s.Q)({name:"accountReferral",commands:{inviteByEmail:r.PI},events:{},queries:{getSharingLink:n.h,getInvitationsHistory:a.g}})},14977:function(e,t,i){i.d(t,{PI:()=>a,qM:()=>n});var s=i(66122),r=i(15021);let n=(0,i(96272).Vj)("user_already_exists","The user invited already exists");class a extends(0,s.g)({scope:r.F.User}){}},89705:function(e,t,i){i.d(t,{g:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},43490:function(e,t,i){i.d(t,{h:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},26224:function(e,t,i){i.d(t,{d:()=>c});var s=i(36503),r=i(6182),n=i(1788),a=i(65496),o=i(79938);let c=(0,s.Q)({name:"deleteOrResetAccount",commands:{completeFlow:r.I,initiateFlow:n.O},events:{},queries:{userAuthenticationMethod:a.c,isFlowCompleted:o.h}})},6182:function(e,t,i){i.d(t,{I:()=>c,O:()=>o});var s,r=i(66122),n=i(15021),a=i(63762),o=((s={}).INVALID_OTP_ALREADY_USED="INVALID_OTP_ALREADY_USED",s.INVALID_OTP_BLOCKED="INVALID_OTP_BLOCKED",s.VERIFICATION_FAILED="VERIFICATION_FAILED",s.ACCOUNT_BLOCKED_CONTACT_SUPPORT="ACCOUNT_BLOCKED_CONTACT_SUPPORT",s.VERIFICATION_REQUIRES_REQUEST="VERIFICATION_REQUIRES_REQUEST",s.VERIFICATION_TIMEOUT="VERIFICATION_TIMEOUT",s);a.z.object({tag:a.z.nativeEnum(o)});class c extends(0,r.g)({scope:n.F.Device}){}},1788:function(e,t,i){i.d(t,{O:()=>c,U:()=>o});var s,r=i(66122),n=i(15021),a=i(63762),o=((s={}).UNKNOWN_USER="user_not_found",s.SSO_BLOCKED="SSO_BLOCKED",s);a.z.object({tag:a.z.nativeEnum(o)});class c extends(0,r.g)({scope:n.F.Device}){}},79938:function(e,t,i){i.d(t,{h:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},65496:function(e,t,i){i.d(t,{c:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},86825:function(e,t,i){i.d(t,{N:()=>n});var s=i(36503),r=i(31616);let n=(0,s.Q)({name:"subscriptionCode",commands:{},events:{},queries:{getSubscriptionCode:r.aD}})},72005:function(e,t,i){i.d(t,{_:()=>n});var s=i(46266),r=i(86825);class n extends(0,s.E)(r.N){}(0,s.K)(r.N,n)},31616:function(e,t,i){i.d(t,{KJ:()=>n,aD:()=>a});var s=i(45429),r=i(15021);let n=(0,i(96272).Vj)("no_key_for_user","The user appears offline");class a extends(0,s.k)({scope:r.F.User}){}},32786:function(e,t,i){i.d(t,{Z:()=>eb});var s,r,n=i(21636),a=i(6970),o=i(48035),c=i(4843),d=i(87253),l=i(20082),u=i(51376),p=i(306),h=i(94190);class g{}class m extends g{async retrieveAccountCreationBrowserPolicies(){try{let e=await (0,u.U)();if(void 0===e)return(0,p.Vp)({teamKey:"",isExtensionMassDeployed:!1});return(0,p.Vp)({teamKey:e.team_key||"",isExtensionMassDeployed:e.is_extension_mass_deployed||!1})}catch{return(0,p.Vp)({teamKey:"",isExtensionMassDeployed:!1})}}}m=(0,n.gn)([(0,h.GS)()],m);var v=i(15021),y=i(59982),w=i(68238),S=i(20458);let f=e=>!!e&&"object"==typeof e&&"firstMassDeployOpening"in e&&"teamKey"in e,E=()=>({firstMassDeployOpening:!0,teamKey:""});class I extends(0,y.Q)({codec:S.E,persist:!0,scope:v.F.Device,storeName:"account-creation-browser-policies-store",capacity:w.Y._001KB,storage:{schemaVersion:1,initialValue:E(),typeGuard:f}}){}class b{async onFrameworkInit(){let{firstMassDeployOpening:e}=await this.acBrowserPoliciesStore.getState(),t=await this.massDeployBrowserPoliciesService.retrieveAccountCreationBrowserPolicies();(0,p.ty)(t,({teamKey:t,isExtensionMassDeployed:i})=>{this.acBrowserPoliciesStore.set({teamKey:t,firstMassDeployOpening:e&&i})})}constructor(e,t){this.acBrowserPoliciesStore=e,this.massDeployBrowserPoliciesService=t}}b=(0,n.gn)([(0,h.ar)(),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[I,g])],b);var A=i(63762),C=((s={}).LOADING="loading",s.NOT_LOADED="not_loaded",s.READY="ready",s),R=((r={}).TEAM_DOES_NOT_EXIST="TEAM_DOES_NOT_EXIST",r.USER_NOT_PROPOSED_IN_TEAM="USER_NOT_PROPOSED_IN_TEAM",r.USER_TEAM_INVITE_TOKEN_NOT_FOUND="USER_TEAM_INVITE_TOKEN_NOT_FOUND",r);A.z.object({tag:A.z.nativeEnum(R)});class _ extends(0,y.Q)({persist:!1,scope:v.F.Device,storeName:"invite-link-store",initialValue:{status:C.NOT_LOADED},capacity:w.Y._001KB}){}var O=i(37368),T=i(55242),F=i(49247),D=i(70554),U=i(51860),P=i(44577),x=i(56144),N=i(19855),L=i(83816);let k={avoidAmbiguous:!1,length:40,letters:!0,digits:!0,symbols:!0};var j=i(79374),G=i(59242),V=i(94588),M=i(17721),K=i(21193),W=i(649),z=i(70410);function q(e){return!e||e.length<2||e.length>5?"ZZ":e}function B(e){return!e||e.length<2||e.length>5?"und":e}function Y(){return`{${(0,z.Z)().toUpperCase()}}`}var Q=i(83267),H=i(57102),$=i(7766),X=i(56130),Z=i(14006),J=i(49),ee=i(64773);class et{async createAccount({login:e,accountType:t,password:i,consents:s,deviceName:r,securityKey:n}){let a=await (0,P.z)(this.platformInfoClient.queries.platformInfo());if(!(0,p.d6)(a))throw Error("failed to get platform info");let o=a.data,c=Math.round(Date.now()/1e3),d=this.random.get(16),l=function({AnonymousUserId:e,CryptoFixedSalt:t,CryptoUserPayload:i,UsagelogToken:s,accountCreationDatetime:r}){return`<?xml version="1.0" encoding="UTF-8"?>
<root>
    <KWSettingsManagerApp> 
        <KWDataItem key="AnonymousUserId"><![CDATA[${e}]]></KWDataItem>
        <KWDataItem key="CryptoFixedSalt"><![CDATA[${t}]]></KWDataItem>
        <KWDataItem key="CryptoUserPayload"><![CDATA[${i}]]></KWDataItem>  
        <KWDataItem key="SyncBackup"><![CDATA[YES]]></KWDataItem>
        <KWDataItem key="UsagelogToken"><![CDATA[${s}]]></KWDataItem>
        <KWDataItem key="accountCreationDatetime"><![CDATA[${r}]]></KWDataItem>
    </KWSettingsManagerApp>
</root>`}({accountCreationDatetime:c,AnonymousUserId:Y(),CryptoFixedSalt:(0,Q.s)(d),CryptoUserPayload:"$1$argon2d$16$3$32768$2$aes256$cbchmac$16$",Login:e,UsagelogToken:Y()}),u=(0,H.n)(new TextEncoder().encode(l)),h=async e=>await this.flexibleEncryptor.encrypt(new TextEncoder().encode(i),e,Z.mr,J.Nw,{salt:d}),g=await h(u),{privateKey:m,publicKey:v}=await this.rsaKeyGenerator.generate(),y=(0,$.R)(m),w=(0,X.y)(v),S=await h(new TextEncoder().encode(y));if("server_carbon_unknown"===o.platformName)throw Error("Invalid platform info");let f=await (0,P.z)(this.serverApiClient.v1.account.createUser({appVersion:o.appVersion,consents:[{consentType:"emailsOffersAndTips",status:s.offers},{consentType:"privacyPolicyAndToS",status:s.tosAndPrivacy}],country:q(o.country),deviceName:(r?r.replace(/https?:\/\//g," "):r)||"Device",language:B(o.lang),login:e,osCountry:q(o.country),osLanguage:B(o.lang),platform:o.platformName,settings:{time:c,content:(0,Q.s)(g)},sharingKeys:{publicKey:w,privateKey:(0,Q.s)(S)},temporaryDevice:!1,accountType:t,contactEmail:e,securityKey:n}));if(!(0,p.d6)(f))return(0,D.EQ)(f.error,{BusinessError:()=>(0,W.j)("failed to create account"),FetchFailedError:()=>(0,p.Rn)((0,T.G2)()),InternalServerError:()=>(0,W.j)("failed to create account"),InvalidRequest:()=>(0,W.j)("failed to create account"),RateLimited:()=>(0,W.j)("failed to create account"),ServiceUnavailable:()=>(0,W.j)("failed to create account"),UnspecifiedBadStatus:()=>(0,W.j)("failed to create account")});let{deviceAccessKey:E,deviceSecretKey:I,userAnalyticsId:b}=f.data.data,A=await this.deviceRegistration.commands.registerDevice({with:"deviceKeys",deviceAccessKey:E,deviceSecretKey:I,login:e,settings:(0,Q.s)(g),userAnalyticsId:b,deviceName:r,ignoreAlreadyRegisteredError:!0});return(0,p.d6)(A)?(0,p.Vp)(void 0):(0,D.EQ)(A.error,{DeviceAlreadyRegistered:()=>(0,W.j)("failed to register device in carbon"),InvalidTokenError:()=>(0,W.j)("failed to register device in carbon"),NetworkError:()=>(0,p.Rn)((0,T.G2)())})}constructor(e,t,i,s,r,n){this.serverApiClient=e,this.platformInfoClient=t,this.random=i,this.flexibleEncryptor=s,this.rsaKeyGenerator=r,this.deviceRegistration=n}}et=(0,n.gn)([(0,h.GS)(),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===G.l?Object:G.l,void 0===j.c?Object:j.c,void 0===V.Y?Object:V.Y,void 0===M._?Object:M._,void 0===K.e?Object:K.e,void 0===ee.z?Object:ee.z])],et);class ei{async execute({body:{consents:e,email:t,pinCode:i,deviceName:s}}){let r=(0,U.generate)(k),n=await this.creator.createAccount({accountType:"invisibleMasterPassword",login:t,consents:e,password:r,deviceName:s});if(!(0,p.d6)(n))return(0,D.EQ)(n.error,{NetworkError:e=>(0,p.Rn)(e)});let a=await this.carbon.commands.openSessionWithMasterPassword({login:t,password:r,rememberPassword:!1,requiredPermissions:void 0,loginType:"PasswordlessAccountCreation"});if(!(0,p.d6)(a))throw Error("failed to login in carbon");return await (0,P.z)(this.session.queries.selectedOpenedSession().pipe((0,x.h)(e=>(0,p.d6)(e)&&e.data===t))),await this.pinCode.commands.activate({pinCode:i}),(0,p.Vp)(void 0)}constructor(e,t,i,s){this.creator=e,this.carbon=t,this.session=i,this.pinCode=s}}ei=(0,n.gn)([(0,O.W)(T.ck),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===et?Object:et,void 0===F._?Object:F._,void 0===N.x?Object:N.x,void 0===L.u?Object:L.u])],ei);var es=i(90105);class er{async execute(){let e=await this.acBrowserPoliciesStore.getState();return this.acBrowserPoliciesStore.set({...e,firstMassDeployOpening:!1}),(0,p.Vp)(void 0)}constructor(e){this.acBrowserPoliciesStore=e}}er=(0,n.gn)([(0,O.W)(es.$),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[I])],er);var en=i(74804),ea=i(17741);class eo{constructor(e,t){this.serverApiClient=e,this.inviteLinkStore=t,this.getFunctionalError=e=>{switch(e){case R.TEAM_DOES_NOT_EXIST:return{tag:R.TEAM_DOES_NOT_EXIST};case R.USER_NOT_PROPOSED_IN_TEAM:return{tag:R.USER_NOT_PROPOSED_IN_TEAM};case R.USER_TEAM_INVITE_TOKEN_NOT_FOUND:return{tag:R.USER_TEAM_INVITE_TOKEN_NOT_FOUND};default:throw Error(`RequestTeamInviteToken: error ${e}`)}},this.loadInviteLinkData=async e=>{let t=await this.inviteLinkStore.getState();if(t.status===C.LOADING||t.status===C.READY&&e===t.teamKey)return;await this.inviteLinkStore.set({status:C.LOADING});let i=await (0,P.z)(this.serverApiClient.v1.teams.getTeamSignUpPage({teamKey:e}).pipe((0,ea.Qn)(({data:e})=>e)));if((0,p.hx)(i))return this.inviteLinkStore.set({status:C.NOT_LOADED});let{disabled:s,displayName:r,teamUuid:n}=i.data;return this.inviteLinkStore.set({teamKey:e,teamUuid:n,displayName:r,disabled:s,status:C.READY})},this.requestTeamInviteTokenSending=(e,t)=>(0,P.z)(this.serverApiClient.v1.teams.requestTeamInviteToken({login:e,teamUuid:t}).pipe((0,ea.DZ)(e=>(0,D.EQ)(e,{BusinessError:e=>this.getFunctionalError(e.code),FetchFailedError:()=>{throw Error("Fetch Failed error")},InternalServerError:W.j,InvalidRequest:W.j,RateLimited:W.j,ServiceUnavailable:W.j,UnspecifiedBadStatus:W.j})),(0,ea.Qn)(({data:e})=>e)))}}eo=(0,n.gn)([(0,h.GS)(),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===G.l?Object:G.l,_])],eo);class ec{async execute({body:e}){let{login:t,teamUuid:i}=e,s=await this.inviteLinkService.requestTeamInviteTokenSending(t,i);return(0,p.hx)(s)?Promise.resolve(s):(0,p.Vp)(void 0)}constructor(e){this.inviteLinkService=e}}ec=(0,n.gn)([(0,O.W)(en.V),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===eo?Object:eo])],ec);var ed=i(50454),el=i(15001),eu=i(14220);class ep{async execute({body:{consents:e,login:t,credential:i,prf:s,salt:r,deviceName:n}}){let a=(0,U.generate)(k);if(!s)return(0,p.Rn)((0,ed.JC)());let o=await this.securityKeyEncryptionService.prfToCryptoKey(s),c=await this.securityKeyEncryptionService.encryptPasswordWithPrfKey(a,o),d=await this.createAccountService.createAccount({accountType:"invisibleMasterPassword",login:t,consents:e,password:a,deviceName:n,securityKey:{credential:i,encryptedVaultKey:c}});if(!(0,p.d6)(d))return(0,p.Rn)((0,ed.C8)());await this.securityKeyClient.commands.saveSecurityKeys({login:t,securityKeys:[{credentialId:i.id,encryptedMP:c,salt:r}]});let l=await this.carbon.commands.openSessionWithMasterPassword({login:t,password:a,rememberPassword:!1,requiredPermissions:void 0,loginType:"PasswordlessAccountCreation"});return(0,p.d6)(l)?(await (0,P.z)(this.session.queries.selectedOpenedSession().pipe((0,x.h)(e=>(0,p.d6)(e)&&e.data===t))),(0,p.Vp)(void 0)):(0,p.Rn)((0,ed.AB)())}constructor(e,t,i,s,r){this.createAccountService=e,this.carbon=t,this.session=i,this.securityKeyClient=s,this.securityKeyEncryptionService=r}}ep=(0,n.gn)([(0,O.W)(ed.Bj),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===et?Object:et,void 0===F._?Object:F._,void 0===N.x?Object:N.x,void 0===el.m?Object:el.m,void 0===eu.K?Object:eu.K])],ep);var eh=i(81433),eg=i(42589),em=i(45991),ev=i(62506),ey=i(32576);class ew{execute(){return this.acBrowserPoliciesStore.state$.pipe((0,eh.x)(em.shallowEqualObjects),(0,eg.U)(p.Vp))}constructor(e){this.acBrowserPoliciesStore=e}}ew=(0,n.gn)([(0,ev.e)(ey.d),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[I])],ew);var eS=i(69853),ef=i(60025),eE=i(67351);class eI{execute({body:e}){let{teamKey:t}=e;return""===t?(0,eS.of)((0,p.Vp)(null)):(0,ef.P)(()=>(this.inviteLinkService.loadInviteLinkData(t),this.inviteLinkStore.state$.pipe((0,eg.U)(e=>e.status!==C.READY?(0,p.Vp)(null):(0,p.Vp)({teamKey:e.teamKey,teamUuid:e.teamUuid,displayName:e.displayName,disabled:e.disabled})))))}constructor(e,t){this.inviteLinkStore=e,this.inviteLinkService=t}}eI=(0,n.gn)([(0,ev.e)(eE.$),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[_,void 0===eo?Object:eo])],eI);class eb{}eb=(0,n.gn)([(0,o.Y)({api:a.X,providers:[{provide:g,useClass:m},et,eo],exports:[g],onFrameworkInit:[b],stores:[I,_],handlers:{commands:{createPasswordlessAccount:ei,markMassDeployFirstInitDone:er,requestTeamInviteTokenSending:ec,createSecurityKeyAccount:ep},events:{},queries:{accountCreationMassDeployPolicies:ew,inviteLinkData:eI}},imports:[c.n,d.D,l.r]})],eb)},27616:function(e,t,i){i.d(t,{c:()=>er});var s,r,n=i(21636),a=i(48035),o=i(4843),c=i(22104),d=i(84323),l=((s={}).ChangeLoginEmailWebDev="account_management_change_login_email_web_dev",s.ChangeLoginEmailB2CWeb="account_management_change_login_email_b2c_web",s.ChangeLoginEmailB2BJit="account_management_change_login_email_web_jit",s.ChangeLoginEmailB2BMP="account_management_change_login_email_web_b2b_mp",s),u=i(14470),p=i(37368),h=i(306),g=i(44577),m=i(94190),v=i(59242),y=i(17741),w=i(70554),S=i(649),f=i(96272),E=((r={}).TokenNotFound="TOKEN_NOT_FOUND",r.TeamIsDiscontinued="TEAM_IS_DISCONTINUED",r.AlreadyMemberOtherTeam="ALREADY_MEMBER_OTHER_TEAM",r);let I=(0,f.Vj)("TOKEN_NOT_FOUND","Invite token not found"),b=(0,f.Vj)("TEAM_IS_DISCONTINUED","The team being joined has been discontinued"),A=(0,f.Vj)("ALREADY_MEMBER_OTHER_TEAM","Token's user is already member of another team");class C{async acceptTeamInvite(e){return await (0,g.z)(this.serverClient.v1.teams.acceptTeamInvite({inviteToken:e}).pipe((0,y.DZ)(e=>(0,w.EQ)(e,{BusinessError:e=>this.getAcceptTeamInviteError(e.code),FetchFailedError:S.j,InternalServerError:S.j,InvalidRequest:S.j,RateLimited:S.j,ServiceUnavailable:S.j,UnspecifiedBadStatus:S.j})),(0,y.lk)(h.Vp)))}constructor(e){this.serverClient=e,this.getAcceptTeamInviteError=e=>{switch(e){case E.AlreadyMemberOtherTeam:return A();case E.TeamIsDiscontinued:return b();case E.TokenNotFound:default:return I()}}}}C=(0,n.gn)([(0,m.GS)(),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===v.l?Object:v.l])],C);class R{async execute({body:{token:e}}){return await this.teamInviteService.acceptTeamInvite(e),(0,h.Vp)(void 0)}constructor(e){this.teamInviteService=e}}R=(0,n.gn)([(0,p.W)(u.c),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===C?Object:C])],R);var _=i(69853),O=i(19855);class T{async requestChangeLoginEmail(e){return await (0,g.z)(this.serverClient.v1.user.requestLoginChange({newLogin:e}).pipe((0,y.DZ)(e=>(0,w.EQ)(e,{BusinessError:e=>({tag:e.code}),FetchFailedError:S.j,InternalServerError:S.j,InvalidRequest:S.j,RateLimited:S.j,ServiceUnavailable:S.j,UnspecifiedBadStatus:S.j})),(0,y.lk)(h.Vp)))}async completeChangeLoginEmail(e){return await (0,g.z)(this.serverClient.v1.user.completeLoginChange({validationToken:e}).pipe((0,y.DZ)(e=>(0,w.EQ)(e,{BusinessError:e=>({tag:e.code}),FetchFailedError:S.j,InternalServerError:S.j,InvalidRequest:S.j,RateLimited:S.j,ServiceUnavailable:S.j,UnspecifiedBadStatus:S.j})),(0,y.lk)(h.Vp)))}async changeLoginEmailForTeamMembers(e){return await (0,g.z)(this.serverClient.v1.teams.requestLoginChange({users:e}).pipe((0,y.DZ)(e=>(0,w.EQ)(e,{BusinessError:e=>({tag:e.code}),FetchFailedError:S.j,InternalServerError:S.j,InvalidRequest:S.j,RateLimited:S.j,ServiceUnavailable:S.j,UnspecifiedBadStatus:S.j})),(0,y.lk)(h.Vp)))}async completeChangeLoginEmailForTeamMember(e,t){return await (0,g.z)(this.serverClient.v1.teams.completeLoginChange({changeLoginRequestId:e,validationToken:t}))}async resendLoginChangeToken(){return await (0,g.z)(this.serverClient.v1.user.sendLoginChangeToken().pipe((0,y.DZ)(S.j),(0,y.lk)(h.Vp)))}getChangeLoginEmailRequests(){return(0,_.of)([])}async migrateSessionDataAndChangeEmail(e){let t=await (0,g.z)(this.sessionClient.queries.selectedOpenedSession());if(!(0,h.d6)(t)||!t.data)throw Error("Current user's email not found");let i=await (0,g.z)(this.serverClient.v1.sync.getLatestContent({needsKeys:!1,teamAdminGroups:!1,transactions:["SETTINGS_userId"],timestamp:0}));if(!(0,h.d6)(i))throw Error("Could not retrieve user's PersonalSettings");let s=i.data.data.transactions.find(e=>"BACKUP_EDIT"===e.action&&"SETTINGS"===e.type);if(!s||"BACKUP_REMOVE"===s.action)throw Error("Could not retrieve user's PersonalSettings in user's transactions");let r=await this.sessionClient.commands.copyUserDataAndOpenSession({currentEmail:t.data,newEmail:e,personalSettings:s});if(!(0,h.d6)(r))throw Error(`Error while migrating user session details: ${r.error.tag}`);return(0,h.Vp)(void 0)}async cancelChangeLoginEmail(e){return await (0,g.z)(this.serverClient.v1.teams.cancelLoginChange({logins:e}).pipe((0,y.DZ)(e=>(0,w.EQ)(e,{BusinessError:e=>({tag:e.code}),FetchFailedError:S.j,InternalServerError:S.j,InvalidRequest:S.j,RateLimited:S.j,ServiceUnavailable:S.j,UnspecifiedBadStatus:S.j})),(0,y.lk)(h.Vp)))}constructor(e,t){this.sessionClient=e,this.serverClient=t}}T=(0,n.gn)([(0,m.GS)(),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===O.x?Object:O.x,void 0===v.l?Object:v.l])],T);class F{async changeAccountType(e){return await (0,g.z)(this.serverClient.v1.account.changeAccountType({newAccountType:e}).pipe((0,y.DZ)(e=>(0,w.EQ)(e,{BusinessError:e=>({tag:e.code}),FetchFailedError:S.j,InternalServerError:S.j,InvalidRequest:S.j,RateLimited:S.j,ServiceUnavailable:S.j,UnspecifiedBadStatus:S.j})),(0,y.lk)(h.Vp)))}constructor(e){this.serverClient=e}}F=(0,n.gn)([(0,m.GS)(),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===v.l?Object:v.l])],F);var D=i(81914);class U{async execute({body:e}){let t=await this.changeLoginEmailService.requestChangeLoginEmail(e.newEmail);if(!(0,h.d6)(t)){let{tag:e}=t.error;if("LOGIN_UNAVAILABLE"===e)return(0,h.Rn)({tag:e});throw Error("Request to change login email failed")}return(0,h.Vp)(void 0)}constructor(e){this.changeLoginEmailService=e}}U=(0,n.gn)([(0,p.W)(D.j),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===T?Object:T])],U);var P=i(29047),x=i(39747),N=i(39951),L=i(15021),k=i(59982),j=i(68238);class G extends(0,k.Q)({persist:!1,scope:L.F.Device,storeName:"change-login-email",initialValue:{status:"no_request"},capacity:j.Y._001KB}){}class V{async execute({body:{newEmail:e,verificationCode:t}}){return await this.changeLoginEmailStore.set({status:"in_progress"}),await this.allowedToFail.doOne(async()=>{let i=await this.changeLoginEmailService.completeChangeLoginEmail(t);if(!(0,h.d6)(i)){await this.changeLoginEmailStore.set({status:"failed",error:x.v[i.error.tag]});return}await this.changeLoginEmailService.migrateSessionDataAndChangeEmail(e),await this.changeLoginEmailStore.set({status:"success"})},{criticality:"critical",methodName:"change-login-email"})||await this.changeLoginEmailStore.set({status:"failed",error:x.v.LOGIN_CHANGE_FAILED}),(0,h.Vp)(void 0)}constructor(e,t,i){this.changeLoginEmailService=e,this.changeLoginEmailStore=t,this.allowedToFail=i}}V=(0,n.gn)([(0,p.W)(N.b),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===T?Object:T,G,void 0===P.J?Object:P.J])],V);var M=i(25608);class K{async execute(){return await this.changeLoginEmailService.resendLoginChangeToken(),(0,h.Vp)(void 0)}constructor(e){this.changeLoginEmailService=e}}K=(0,n.gn)([(0,p.W)(M.h),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===T?Object:T])],K);var W=i(42589),z=i(62506);class q{execute(){return this.store.state$.pipe((0,W.U)(e=>(0,h.Vp)(e)))}constructor(e){this.store=e}}q=(0,n.gn)([(0,z.e)(x.w),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[G])],q);var B=i(26555);class Y{execute(){return this.service.getChangeLoginEmailRequests().pipe((0,W.U)(e=>(0,h.Vp)(e)))}constructor(e){this.service=e}}Y=(0,n.gn)([(0,z.e)(B.A),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===T?Object:T])],Y);var Q=i(94680),H=i(22982),$=i(59355);class X{bodyToEndpointBodyMapper({currentLogin:e,newLogin:t}){return{currentLogin:e,newLogin:t}}async execute({body:e}){if(e.some(e=>e.isUserSSO)){let t=await (0,g.z)(this.teamEnclaveClient.queries.getTeamIdentifiers());if((0,h.hx)(t)||!t.data.adminProvisioningKey)throw Error("[ChangeTeamMembersLoginEmailCommand] unable to retrieve team identifiers");let i=await this.enclaveApiClient.authentication.prepareChangeLogin({adminProvisioningKey:t.data.adminProvisioningKey,userLoginChanges:e.filter(e=>e.isUserSSO).map(this.bodyToEndpointBodyMapper)});if((0,h.hx)(i))return(0,h.Rn)({tag:i.error.code})}let t=await this.changeLoginEmailService.changeLoginEmailForTeamMembers(e.map(this.bodyToEndpointBodyMapper));return(0,h.hx)(t)?(0,h.Rn)({tag:t.error.tag}):(0,h.Vp)(void 0)}constructor(e,t,i){this.changeLoginEmailService=e,this.enclaveApiClient=t,this.teamEnclaveClient=i}}X=(0,n.gn)([(0,p.W)(H.C),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===T?Object:T,void 0===Q.l?Object:Q.l,void 0===$.G?Object:$.G])],X);var Z=i(30170);class J{async execute({body:{newAccountType:e}}){let t=await this.changeAccountTypeService.changeAccountType(e);if((0,h.hx)(t))throw Error("Request to change account type failed");return(0,h.Vp)(void 0)}constructor(e){this.changeAccountTypeService=e}}J=(0,n.gn)([(0,p.W)(Z.p),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===F?Object:F])],J);var ee=i(42095);class et{async execute({body:{changeLoginRequestId:e,validationToken:t}}){await this.changeLoginEmailStore.set({status:"in_progress"});let i=await this.changeLoginEmailService.completeChangeLoginEmailForTeamMember(e,t);if(!(0,h.d6)(i))return await this.changeLoginEmailStore.set({status:"failed",error:x.v.LOGIN_CHANGE_FAILED}),(0,h.Vp)(void 0);let s=await (0,g.z)(this.sessionClient.queries.selectedOpenedSession());return(0,h.d6)(s)&&s.data&&await this.sessionClient.commands.closeUserSession({email:s.data}),await this.changeLoginEmailStore.set({status:"success"}),(0,h.Vp)(void 0)}constructor(e,t,i){this.changeLoginEmailService=e,this.changeLoginEmailStore=t,this.sessionClient=i}}et=(0,n.gn)([(0,p.W)(ee.G),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===T?Object:T,G,void 0===O.x?Object:O.x])],et);var ei=i(67024);class es{async execute({body:{logins:e}}){let t=await this.changeLoginEmailService.cancelChangeLoginEmail(e);return(0,h.d6)(t)?(0,h.Vp)(void 0):(0,h.Rn)({tag:t.error.tag})}constructor(e,t,i){this.changeLoginEmailService=e,this.changeLoginEmailStore=t,this.sessionClient=i}}es=(0,n.gn)([(0,p.W)(ei.L),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===T?Object:T,G,void 0===O.x?Object:O.x])],es);class er{}er=(0,n.gn)([(0,a.Y)({api:d.v,imports:[o.n,c.G],providers:[T,C,F],stores:[G],handlers:{commands:{acceptTeamInvite:R,changeAccountType:J,initChangeLoginEmail:U,completeChangeLoginEmail:V,resendVerificationCode:K,changeTeamMembersLoginEmail:X,completeChangeTeamMemberLoginEmail:et,cancelChangeTeamMemberLoginEmail:es},events:{},queries:{changeLoginEmailStatus:q,pendingLoginChangeRequests:Y}},domainName:"account",requiredFeatureFlips:Object.values(l)})],er)},1419:function(e,t,i){i.d(t,{o:()=>C});var s=i(21636),r=i(48035),n=i(84501),a=i(4843),o=i(44577),c=i(37368),d=i(14977),l=i(31616),u=i(72005),p=i(59242),h=i(306),g=i(42589),m=i(94190);class v{async getIsExistingLogin(e){let t=this.serverApiClient.v1.authentication.get2FaStatusUnauthenticated({login:e});return await (0,o.z)(t.pipe((0,g.U)(e=>(0,h.d6)(e))))}constructor(e){this.serverApiClient=e}}v=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.l?Object:p.l])],v);class y{async execute({body:{email:e}}){try{let t=await (0,o.z)(this.subscriptionCodeApi.queries.getSubscriptionCode());if(await this.accountExistsService.getIsExistingLogin(e))return(0,h.Rn)((0,d.qM)());if(!(0,h.d6)(t))return(0,h.Rn)((0,l.KJ)());let i=await (0,o.z)(this.serverApiClient.v1.invitation.invite({userKey:t.data,identifiers:[e],type:"manual"}));if((0,h.hx)(i))throw Error("InviteByEmailCommand failure: something went wrong in call to /invitation/invite");return(0,h.Vp)(void 0)}catch(e){throw Error("InviteByEmailCommand failure: something went wrong in execute method")}}constructor(e,t,i){this.serverApiClient=e,this.accountExistsService=t,this.subscriptionCodeApi=i}}y=(0,s.gn)([(0,c.W)(d.PI),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.l?Object:p.l,void 0===v?Object:v,void 0===u._?Object:u._])],y);var w=i(92291),S=i(62506),f=i(43490),E=i(17741);class I{execute(){return this.subscriptionCodeApi.queries.getSubscriptionCode().pipe((0,w.b)(e=>this.serverApiClient.v1.invitation.getSharingLink({userKey:"success"===e.tag?e.data:""}).pipe((0,E.Qn)(e=>e.data),(0,E.DZ)(e=>{throw Error(e.message)}))))}constructor(e,t){this.serverApiClient=e,this.subscriptionCodeApi=t}}I=(0,s.gn)([(0,S.e)(f.h),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.l?Object:p.l,void 0===u._?Object:u._])],I);var b=i(89705);class A{execute(){return this.serverApiClient.v1.invitation.getInvitationsHistory().pipe((0,E.Qn)(e=>e.data),(0,E.DZ)(e=>(0,h.Rn)({tag:`GetInvitationsHistoryQueryHandler failure: ${e.message}`})))}constructor(e){this.serverApiClient=e}}A=(0,s.gn)([(0,S.e)(b.g),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.l?Object:p.l])],A);class C{}C=(0,s.gn)([(0,r.Y)({api:n.l,imports:[a.n],handlers:{commands:{inviteByEmail:y},events:{},queries:{getSharingLink:I,getInvitationsHistory:A}},providers:[v],requiredFeatureFlips:[...Object.values({B2bReferralProd:"activationRetention_web_b2b_referrals_prod"})]})],C)},19988:function(e,t,i){i.d(t,{T:()=>L});var s,r=i(21636),n=i(48035),a=i(4843),o=i(26224),c=i(44577),d=i(6182),l=i(1788),u=i(94190),p=i(59242),h=i(17741),g=i(70554),m=i(649);class v{getAuthenticationMethodsForReset(e){return this.serverApiClient.v1.authentication.getAuthenticationMethodsForReset({login:e,methods:["email_token","totp"]}).pipe((0,h.DZ)(e=>(0,g.EQ)(e,{BusinessError:e=>this.getFunctionalError(e.code),FetchFailedError:()=>{throw Error("Fetch Failed error")},BadStatus:m.j,InternalServerError:m.j,InvalidRequest:m.j,RateLimited:m.j,ServiceUnavailable:m.j,UnspecifiedBadStatus:m.j})),(0,h.Qn)(e=>{if(e.data.verifications.length>=1)return e.data.verifications[0].type;throw Error("GetAuthenticationMethodsForReset: couldn't retrieve any method")}))}getVerifyTokenFunctionalError(e){switch(e){case"invalid_otp_already_used":return{tag:d.O.INVALID_OTP_ALREADY_USED};case"invalid_otp_blocked":return{tag:d.O.INVALID_OTP_BLOCKED};case"verification_failed":return{tag:d.O.VERIFICATION_FAILED};case"account_blocked_contact_support":return{tag:d.O.ACCOUNT_BLOCKED_CONTACT_SUPPORT};case"verification_requires_request":return{tag:d.O.VERIFICATION_REQUIRES_REQUEST};case"verification_timeout":return{tag:d.O.VERIFICATION_TIMEOUT};default:throw Error("performTokenVerification: Business error not handled")}}verifyTOTPToken(e,t){return(0,c.z)(this.serverApiClient.v1.authentication.performTotpVerification({login:e,otp:t,intent:"account_delete_or_reset"}).pipe((0,h.DZ)(e=>(0,g.EQ)(e,{BusinessError:e=>this.getVerifyTokenFunctionalError(e.code),FetchFailedError:m.j,BadStatus:m.j,InternalServerError:m.j,InvalidRequest:m.j,RateLimited:m.j,ServiceUnavailable:m.j,UnspecifiedBadStatus:m.j})),(0,h.Qn)(e=>e.data.authTicket)))}verifyEmailToken(e,t){return(0,c.z)(this.serverApiClient.v1.authentication.performEmailTokenVerification({login:e,token:t,intent:"account_delete_or_reset"}).pipe((0,h.DZ)(e=>(0,g.EQ)(e,{BusinessError:e=>this.getVerifyTokenFunctionalError(e.code),FetchFailedError:m.j,BadStatus:m.j,InternalServerError:m.j,InvalidRequest:m.j,RateLimited:m.j,ServiceUnavailable:m.j,UnspecifiedBadStatus:m.j})),(0,h.Qn)(e=>e.data.authTicket)))}deleteOrResetAccount(e,t,i=!0){return(0,c.z)(this.serverApiClient.v1.account.deleteOrResetAccount({authTicket:t,isDelete:i,login:e}).pipe((0,h.DZ)(e=>(0,g.EQ)(e,{BusinessError:m.j,FetchFailedError:m.j,BadStatus:m.j,InternalServerError:m.j,InvalidRequest:m.j,RateLimited:m.j,ServiceUnavailable:m.j,UnspecifiedBadStatus:m.j})),(0,h.Qn)(()=>!0)))}constructor(e){this.serverApiClient=e,this.getFunctionalError=e=>{switch(e){case l.U.UNKNOWN_USER:return{tag:l.U.UNKNOWN_USER};case l.U.SSO_BLOCKED:return{tag:l.U.SSO_BLOCKED};default:throw Error(`GetAuthenticationMethodsForReset: error ${e}`)}}}}v=(0,r.gn)([(0,u.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===p.l?Object:p.l])],v);var y=i(15021),w=i(59982),S=i(68238);class f extends(0,w.Q)({persist:!1,scope:y.F.Device,storeName:"account-deletion",initialValue:{login:"",userAuthenticationMethod:null,isFlowCompleted:!1},capacity:S.Y._001KB}){}var E=((s={}).EMAIL="EMAIL",s.TOTP="TOTP",s),I=i(37368),b=i(29047),A=i(49247),C=i(306);class R{async execute({body:e}){let{token:t,isDelete:i}=e,s=await this.deleteOrResetAccountStore.getState(),{userAuthenticationMethod:r,login:n}=s,a=r===E.EMAIL?await this.deleteOrResetAccountService.verifyEmailToken(n,t):await this.deleteOrResetAccountService.verifyTOTPToken(n,t);if((0,C.hx)(a))return Promise.resolve(a);let o=await this.deleteOrResetAccountService.deleteOrResetAccount(n,a.data,i);if((0,C.hx)(o))throw Error("CompleteFlowCommand : error while deleting the account");return this.deleteOrResetAccountStore.set({...s,isFlowCompleted:!0}),await this.allowedToFail.doOne(async()=>this.carbonLegacy.commands.cleanRemotelyRemovedProfiles()),Promise.resolve((0,C.Vp)(void 0))}constructor(e,t,i,s){this.deleteOrResetAccountStore=e,this.deleteOrResetAccountService=t,this.carbonLegacy=i,this.allowedToFail=s}}R=(0,r.gn)([(0,I.W)(d.I),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[f,void 0===v?Object:v,void 0===A._?Object:A._,void 0===b.J?Object:b.J])],R);var _=i(11396),O=i(4772);class T{async execute({body:e}){let{login:t}=e,i=await (0,c.z)(this.deleteOrResetAccountService.getAuthenticationMethodsForReset(t).pipe((0,h.Qn)(e=>"email_token"===e?E.EMAIL:E.TOTP)));if((0,C.hx)(i))return Promise.resolve(i);i.data===E.EMAIL&&await this.authenticationFlowClient.commands.requestEmailTokenVerification({login:t});let s=await this.deleteOrResetAccountStore.getState();return await this.deleteOrResetAccountStore.set({...s,login:t,userAuthenticationMethod:i.data}),Promise.resolve((0,C.Vp)(void 0))}constructor(e,t,i){this.deleteOrResetAccountStore=e,this.deleteOrResetAccountService=t,this.authenticationFlowClient=i}}T=(0,r.gn)([(0,I.W)(l.O),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[f,void 0===v?Object:v,void 0===_||void 0===O.e?Object:O.e])],T);var F=i(42589),D=i(62506),U=i(65496);class P{execute(){return this.deleteOrResetAccountStore.state$.pipe((0,F.U)(e=>(0,C.Vp)(e.userAuthenticationMethod)))}constructor(e){this.deleteOrResetAccountStore=e}}P=(0,r.gn)([(0,D.e)(U.c),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[f])],P);var x=i(79938);class N{execute(){return this.deleteOrResetAccountStore.state$.pipe((0,F.U)(e=>(0,C.Vp)(e.isFlowCompleted)))}constructor(e){this.deleteOrResetAccountStore=e}}N=(0,r.gn)([(0,D.e)(x.h),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[f])],N);class L{}L=(0,r.gn)([(0,n.Y)({api:o.d,handlers:{commands:{completeFlow:R,initiateFlow:T},events:{},queries:{userAuthenticationMethod:P,isFlowCompleted:N}},stores:[f],imports:[a.n],providers:[v]})],L)},18395:function(e,t,i){i.d(t,{q:()=>F});var s=i(21636),r=i(4843),n=i(73827),a=i(48035),o=i(86825),c=i(88826),d=i(51870),l=i(44577),u=i(94190),p=i(59242),h=i(17741),g=i(306),m=i(63762),v=i(15021),y=i(59982),w=i(68238),S=i(20458);let f=m.z.object({code:m.z.string().nullable(),error:m.z.union([m.z.string(),m.z.undefined()])}),E=e=>f.safeParse(e).success;class I extends(0,y.Q)({storage:{schemaVersion:1,initialValue:{code:null},typeGuard:E},persist:!0,scope:v.F.User,storeName:"plan-cancellation-store",capacity:w.Y._001KB,codec:S.E}){}class b{async refresh(){let e=await (0,l.z)(this.serverApiClient.v1.premium.getSubscriptionCode({}).pipe((0,h.Qn)(({data:e})=>e)));if(!(0,g.d6)(e)){this.subscriptionCodeStore.set({code:null,error:e.error.message});return}this.subscriptionCodeStore.set({code:e.data.subscriptionCode})}constructor(e,t){this.serverApiClient=e,this.subscriptionCodeStore=t}}b=(0,s.gn)([(0,u.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.l?Object:p.l,I])],b);class A{async handle(){this.subscriptionCodeService.refresh()}constructor(e){this.subscriptionCodeService=e}}A=(0,s.gn)([(0,d.b)(c.M),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===b?Object:b])],A);var C=i(42589),R=i(81433),_=i(62506),O=i(31616);class T{execute(){return this.subscriptionCodeStore.state$.pipe((0,C.U)(e=>"no_key_for_user"!==e.error&&e.code?(0,g.Vp)(e.code):(0,g.Rn)((0,O.KJ)())),(0,R.x)())}constructor(e){this.subscriptionCodeStore=e}}T=(0,s.gn)([(0,_.e)(O.aD),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[I])],T);class F{}F=(0,s.gn)([(0,a.Y)({api:o.N,handlers:{commands:{},events:{...(0,a.g)(n.Q,{sessionOpened:A})},queries:{getSubscriptionCode:T}},stores:[I],imports:[r.n],providers:[b]})],F)},70710:function(e,t,i){i.d(t,{L:()=>n});var s=i(36503),r=i(56645);let n=(0,s.Q)({name:"mlAntiPhishing",commands:{},events:{},queries:{getAntiPhishingStatus:r.T}})},56645:function(e,t,i){i.d(t,{T:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},73466:function(e,t,i){i.d(t,{D:()=>n});var s=i(36503),r=i(26678);let n=(0,s.Q)({name:"overrides",commands:{},events:{},queries:{overrides:r.N}})},26678:function(e,t,i){i.d(t,{N:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},89544:function(e,t,i){i.d(t,{s:()=>m});var s=i(21636),r=i(48035),n=i(70710);let a=(0,i(96272).Vj)("GET_ANTI_PHISHING_STATUS_KILL_SWITCH_ERROR","Error retrieving ML anti-phishing kill switch information");var o=i(56645),c=i(62506),d=i(13598),l=i(25933),u=i(306),p=i(42589),h=i(81433);class g{execute(){let{getKillSwitch:e}=this.killSwitchClient.queries;return e({killSwitch:d.v.DisableMLAntiPhishing}).pipe((0,p.U)(e=>{if((0,u.hx)(e))return(0,u.Rn)(a());let t=(0,u.db)(e)??!1;return(0,u.Vp)({isEnabled:!t})}),(0,h.x)())}constructor(e){this.killSwitchClient=e}}g=(0,s.gn)([(0,c.e)(o.T),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===l.i?Object:l.i])],g);class m{}m=(0,s.gn)([(0,r.Y)({api:n.L,handlers:{commands:{},events:{},queries:{getAntiPhishingStatus:g}},stores:[]})],m)},19195:function(e,t,i){i.d(t,{x:()=>y});var s=i(21636),r=i(48035);let n=e=>{let t="type"in e&&void 0!==e.type&&("css"===e.type||"xpath"===e.type),i="selector"in e&&void 0!==e.selector&&"string"==typeof e.selector;return t&&i},a=e=>{let t="type"in e&&void 0!==e.type&&("set"===e.type||"ignore"===e.type),i="cssSelector"in e&&void 0!==e.cssSelector&&"string"==typeof e.cssSelector;return t&&i},o=e=>{if(!e||"object"!=typeof e)return!1;let t="type"in e&&void 0!==e.type&&("startsWith"===e.type||"regexp"===e.type),i="value"in e&&void 0!==e.value&&(Array.isArray(e.value)&&e.value.every(e=>"string"==typeof e)||"string"==typeof e.value),s="conditions"in e&&void 0!==e.conditions&&Array.isArray(e.conditions)&&e.conditions.every(e=>n(e)),r="actions"in e&&void 0!==e.actions&&Array.isArray(e.actions)&&e.actions.every(e=>a(e));return t&&i&&s&&r};var c=i(73466),d=i(64247),l=i(62506),u=i(26678),p=i(306),h=i(33438),g=i(42589);class m{execute(){return this.rfuClient.streamFileUpdate().pipe((0,g.U)(e=>(0,p.Vp)({overrides:e})))}constructor(e){this.rfuClient=e}}m=(0,s.gn)([(0,l.e)(u.N),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h.w?Object:h.w])],m);let v=(0,d.Q)("overrides.json",e=>null!=e&&"object"==typeof e&&Object.values(e).every(e=>Array.isArray(e)&&e.every(e=>o(e))));class y{}y=(0,s.gn)([(0,r.Y)({api:c.D,composes:[v],handlers:{commands:{},events:{},queries:{overrides:m}}})],y)},4772:function(e,t,i){i.d(t,{e:()=>n});var s=i(46266),r=i(90834);class n extends(0,s.E)(r.V){}(0,s.K)(r.V,n)},90834:function(e,t,i){i.d(t,{V:()=>a});var s=i(36503),r=i(44810),n=i(83518);let a=(0,s.Q)({name:"authenticationFlow",commands:{changeLogin:n.hW,changeTwoFactorAuthenticationOtpType:n.eG,clearError:n.jq,cancelDeviceTransferRequest:n.Yc,requestEmailTokenVerification:n._F,resendEmailToken:n.Gc,resendPushNotification:n.rF,sendAccountEmail:n.A,sendMasterPassword:n.rT,submitPinCode:n.CO,submitBackupCode:n.sH,submitEmailToken:n.XH,submitTotp:n.ad,switchToDevicetoDeviceAuthentication:n.sU,switchToDashlaneAuthenticator:n.K1,switchToMasterPassword:n.On,switchToEmailToken:n.v5,switchToPinCode:n.WF,retryWebAuthnAuthentication:n.M6,webAuthnAuthenticationFail:n.O3,logout:n.N5,lockSession:n.Y$,loginViaSSO:n.yv,initiateLoginWithSSO:n.Hr,initiateAutologinWithSSO:n.x2},queries:{authenticationFlowStatus:r.DW,getSsoUserSettings:r.Dc,getProviderInfo:r.L2},events:{}})},83518:function(e,t,i){i.d(t,{A:()=>n,CO:()=>o,Gc:()=>y,Hr:()=>_,K1:()=>l,M6:()=>I,N5:()=>A,O3:()=>b,On:()=>c,WF:()=>u,XH:()=>p,Y$:()=>C,Yc:()=>T,_F:()=>v,ad:()=>h,eG:()=>m,hW:()=>a,jq:()=>E,rF:()=>S,rT:()=>w,sH:()=>g,sU:()=>d,v5:()=>f,x2:()=>O,yv:()=>R});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}class a extends(0,s.g)({scope:r.F.Device}){}class o extends(0,s.g)({scope:r.F.Device}){}class c extends(0,s.g)({scope:r.F.Device}){}class d extends(0,s.g)({scope:r.F.Device}){}class l extends(0,s.g)({scope:r.F.Device}){}class u extends(0,s.g)({scope:r.F.Device}){}class p extends(0,s.g)({scope:r.F.Device}){}class h extends(0,s.g)({scope:r.F.Device}){}class g extends(0,s.g)({scope:r.F.Device}){}class m extends(0,s.g)({scope:r.F.Device}){}class v extends(0,s.g)({scope:r.F.Device}){}class y extends(0,s.g)({scope:r.F.Device}){}class w extends(0,s.g)({scope:r.F.Device}){}class S extends(0,s.g)({scope:r.F.Device}){}class f extends(0,s.g)({scope:r.F.Device}){}class E extends(0,s.g)({scope:r.F.Device}){}class I extends(0,s.g)({scope:r.F.Device}){}class b extends(0,s.g)({scope:r.F.Device}){}class A extends(0,s.g)({scope:r.F.Device}){}class C extends(0,s.g)({scope:r.F.Device}){}class R extends(0,s.g)({scope:r.F.Device}){}class _ extends(0,s.g)({scope:r.F.Device}){}class O extends(0,s.g)({scope:r.F.Device}){}class T extends(0,s.g)({scope:r.F.Device}){}},76047:function(e,t,i){i.d(t,{Z:()=>n,x:()=>r});var s=i(96272);let r="REQUEST_EMAIL_TOKEN_VERIFICATION_ERROR",n=(0,s.Vj)(r,"Error requesting email token")},44810:function(e,t,i){i.d(t,{DW:()=>n,Dc:()=>a,L2:()=>o});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}class a extends(0,s.k)({scope:r.F.Device}){}class o extends(0,s.k)({scope:r.F.Device}){}},81544:function(e,t,i){i.d(t,{E6:()=>c,UY:()=>d,ao:()=>l,hr:()=>o,vX:()=>u});var s,r,n,a,o=((s={}).SSO="sso",s.MP="master_password",s),c=((r={}).WaitingForTransferRequest="WaitingForTransferRequest",r.DisplayInstructions="DisplayInstructions",r.LoadingPassphrase="LoadingPassphrase",r.DisplayPassphrase="DisplayPassphrase",r.LoadingAccount="LoadingAccount",r.Error="Error",r.DeviceRegistered="DeviceRegistered",r),d=((n={}).GENERIC_ERROR="GENERIC_ERROR",n.TIMEOUT="TIMEOUT",n.REQUEST_REJECTED="REQUEST_REJECTED",n.ACCOUNT_ERROR="ACCOUNT_ERROR",n.RATE_LIMIT="RATE_LIMIT",n);let l=e=>Object.values(d).includes(e);var u=((a={})[a.MP_TO_SSO=0]="MP_TO_SSO",a[a.MP_TO_SSO_WITH_INFO=1]="MP_TO_SSO_WITH_INFO",a[a.SSO_TO_MP=2]="SSO_TO_MP",a)},11396:function(e,t,i){i.r(t),i.d(t,{AuthenticationFlowClient:()=>o.e,AuthenticationFlowStatusQuery:()=>n.DW,CancelDeviceTransferRequestCommand:()=>r.Yc,ChangeAccountEmailCommand:()=>r.hW,ChangeTwoFactorAuthenticationOtpTypeCommand:()=>r.eG,ClearErrorCommand:()=>r.jq,DeviceToDeviceAuthenticationErrors:()=>a.UY,DeviceToDeviceAuthenticationFlowStep:()=>a.E6,GetSsoProviderInfoQuery:()=>n.L2,GetSsoUserSettingsQuery:()=>n.Dc,InitiateAutologinWithSSOCommand:()=>r.x2,InitiateLoginWithSSOCommand:()=>r.Hr,LockCommand:()=>r.Y$,LoginViaSSOCommand:()=>r.yv,LogoutCommand:()=>r.N5,REQUEST_EMAIL_TOKEN_VERIFICATION_ERROR:()=>c.x,RequestEmailTokenVerificationCommand:()=>r._F,ResendEmailTokenCommand:()=>r.Gc,ResendPushNotificationCommand:()=>r.rF,RetryWebAuthnAuthenticationCommand:()=>r.M6,SSOMigrationType:()=>a.vX,SendAccountEmailCommand:()=>r.A,SendMasterPasswordCommand:()=>r.rT,SsoMigrationServerMethod:()=>a.hr,SubmitBackupCodeCommand:()=>r.sH,SubmitEmailTokenCommand:()=>r.XH,SubmitPinCodeCommand:()=>r.CO,SubmitTotpCommand:()=>r.ad,SwitchToDashlaneAuthenticatorCommand:()=>r.K1,SwitchToDevicetoDeviceAuthenticationCommand:()=>r.sU,SwitchToEmailTokenCommand:()=>r.v5,SwitchToMasterPasswordCommand:()=>r.On,SwitchToPinCodeCommand:()=>r.WF,WebAuthnAuthenticationFailCommand:()=>r.O3,authenticationFlowApi:()=>s.V,createRequestEmailTokenVerificationError:()=>c.Z,isDeviceToDeviceAuthenticationError:()=>a.ao});var s=i(90834),r=i(83518),n=i(44810),a=i(81544),o=i(4772),c=i(76047)},88978:function(e,t,i){i.d(t,{n:()=>n});var s=i(36503),r=i(82500);let n=(0,s.Q)({name:"authentication",commands:{},events:{},queries:{canLockApp:r._}})},82500:function(e,t,i){i.d(t,{I:()=>n,_:()=>a});var s=i(45429),r=i(15021);let n="USER_NOT_LOGGED_IN";class a extends(0,s.k)({scope:r.F.User,noUserError:{tag:n}}){}},70985:function(e,t,i){i.d(t,{G:()=>o});var s=i(36503),r=i(89600),n=i(22717),a=i(26284);let o=(0,s.Q)({name:"deviceRegistration",commands:{cleanRemotelyRemovedProfiles:r.L,registerDevice:n.J},events:{},queries:{localAccounts:a.a}})},64773:function(e,t,i){i.d(t,{z:()=>n});var s=i(46266),r=i(70985);class n extends(0,s.E)(r.G){}(0,s.K)(r.G,n)},89600:function(e,t,i){i.d(t,{L:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},22717:function(e,t,i){i.d(t,{J:()=>o,Y:()=>a});var s=i(66122),r=i(15021),n=i(63762);let a=n.z.discriminatedUnion("with",[n.z.object({with:n.z.literal("token"),login:n.z.string(),token:n.z.string(),deviceName:n.z.optional(n.z.string()),ignoreAlreadyRegisteredError:n.z.optional(n.z.boolean())}),n.z.object({with:n.z.literal("authTicket"),login:n.z.string(),authTicket:n.z.string(),deviceName:n.z.optional(n.z.string()),ignoreAlreadyRegisteredError:n.z.optional(n.z.boolean())}),n.z.object({with:n.z.literal("deviceKeys"),login:n.z.string(),deviceName:n.z.optional(n.z.string()),ignoreAlreadyRegisteredError:n.z.optional(n.z.boolean()),deviceAccessKey:n.z.string(),deviceSecretKey:n.z.string(),settings:n.z.string(),userAnalyticsId:n.z.string(),serverKey:n.z.optional(n.z.string())})]);class o extends(0,s.g)({scope:r.F.Device}){}},26284:function(e,t,i){i.d(t,{a:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},43530:function(e,t,i){i.d(t,{F:()=>u});var s=i(36503),r=i(42229),n=i(70285),a=i(28511),o=i(1776),c=i(46313),d=i(86565),l=i(74859);let u=(0,s.Q)({name:"deviceTransfer",commands:{refreshRequest:r.V,cancelRequest:n.b,approveRequest:a.G,rejectRequest:o.a,submitPassphraseChallenge:c.I,returnToDeviceSetup:d.n},events:{},queries:{trustedDeviceFlowStatus:l.N}})},28511:function(e,t,i){i.d(t,{G:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},70285:function(e,t,i){i.d(t,{b:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},42229:function(e,t,i){i.d(t,{V:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},1776:function(e,t,i){i.d(t,{a:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},86565:function(e,t,i){i.d(t,{n:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},46313:function(e,t,i){i.d(t,{I:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},74859:function(e,t,i){i.d(t,{N:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},46181:function(e,t,i){i.d(t,{S:()=>n,T:()=>a});var s,r,n=((s={}).GENERIC_ERROR="GENERIC_ERROR",s.INVALID_PASSPHRASE="INVALID_PASSPHRASE",s.TIMEOUT="TIMEOUT",s.PASSPHRASE_ATTEMPTS_LIMIT="PASSPHRASE_ATTEMPTS_LIMIT",s),a=((r={})[r.WaitingForNewDeviceRequest=0]="WaitingForNewDeviceRequest",r[r.NewDeviceRequestAvailable=1]="NewDeviceRequestAvailable",r[r.DisplayPassphraseChallenge=2]="DisplayPassphraseChallenge",r[r.DeviceTransferComplete=3]="DeviceTransferComplete",r[r.LoadingChallenge=4]="LoadingChallenge",r[r.DeviceTransferRejected=5]="DeviceTransferRejected",r[r.Error=6]="Error",r)},77878:function(e,t,i){i.d(t,{i:()=>o});var s=i(36503),r=i(68371),n=i(21273),a=i(82127);let o=(0,s.Q)({name:"identityVerificationFlow",commands:{changeTwoFactorAuthenticationOtpType:n.eG,clearError:n.$5,resendEmailToken:n.Gc,resendPushNotification:n.rF,submitBackupCode:n.sH,submitEmailToken:n.XH,submitTotp:n.ad,switchToDashlaneAuthenticator:n.K1,switchToEmailToken:n.v5,startIdentityVerification:n.qw,cancelIdentityVerification:n.Vs},queries:{identityVerificationFlowStatus:r.O},events:{identityVerificationCompleted:a.w}})},21273:function(e,t,i){i.d(t,{$5:()=>a,Gc:()=>o,K1:()=>p,Vs:()=>m,XH:()=>d,ad:()=>u,eG:()=>n,qw:()=>g,rF:()=>c,sH:()=>l,v5:()=>h});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}class a extends(0,s.g)({scope:r.F.Device}){}class o extends(0,s.g)({scope:r.F.Device}){}class c extends(0,s.g)({scope:r.F.Device}){}class d extends(0,s.g)({scope:r.F.Device}){}class l extends(0,s.g)({scope:r.F.Device}){}class u extends(0,s.g)({scope:r.F.Device}){}class p extends(0,s.g)({scope:r.F.Device}){}class h extends(0,s.g)({scope:r.F.Device}){}class g extends(0,s.g)({scope:r.F.Device}){}class m extends(0,s.g)({scope:r.F.Device}){}},82127:function(e,t,i){i.d(t,{w:()=>n});var s=i(98037),r=i(15021);class n extends(0,s.d)({scope:r.F.Device}){}},68371:function(e,t,i){i.d(t,{O:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},30357:function(e,t,i){i.d(t,{l:()=>n});var s=i(46266),r=i(77878);class n extends(0,s.E)(r.i){}(0,s.K)(r.i,n)},60160:function(e,t,i){i.r(t),i.d(t,{CancelIdentityVerificationCommand:()=>r.Vs,ChangeTwoFactorAuthenticationOtpTypeCommand:()=>r.eG,ClearIdentityVerificationErrorCommand:()=>r.$5,IdentityVerificationClient:()=>a.l,IdentityVerificationCompletedEvent:()=>o.w,IdentityVerificationFlowStatusQuery:()=>n.O,ResendEmailTokenCommand:()=>r.Gc,ResendPushNotificationCommand:()=>r.rF,StartIdentityVerificationCommand:()=>r.qw,SubmitBackupCodeCommand:()=>r.sH,SubmitEmailTokenCommand:()=>r.XH,SubmitTotpCommand:()=>r.ad,SwitchToDashlaneAuthenticatorCommand:()=>r.K1,SwitchToEmailTokenCommand:()=>r.v5,identityVerificationFlowApi:()=>s.i});var s=i(77878),r=i(21273),n=i(68371),a=i(30357),o=i(82127)},81453:function(e,t,i){i.r(t),i.d(t,{UserVerificationMethods:()=>S.W,ActivateCommand:()=>R.r,USER_NOT_LOGGED_IN:()=>k.I,UserVerificationMethodsQuery:()=>S.Y,createAuthenticationWithSecurityKeyFailedError:()=>W.pF,securityKeyApi:()=>V.d,IsPinCodeCorrectQuery:()=>D.M,createUserNotSetWithSecurityKeyError:()=>W.Zx,Request2FaCodesByPhoneCommand:()=>y.x,SaveSecurityKeysCommand:()=>M.Q,DeactivateCommand:()=>_.E,PinCodeClient:()=>U.u,RegisterDeviceCommand:()=>I.J,createWrongPinCodeError:()=>N.g5,GetStatusQuery:()=>T.D,Request2FaCodesByPhoneErrorCodes:()=>w.A,registrationSchema:()=>I.Y,DeviceRegistrationClient:()=>A.z,InitAccountCreationQuery:()=>q.M,LoginWithSecurityKeyCommand:()=>K.T,AUTHENTICATION_WITH_SECURITY_KEY_FAILED:()=>W.rI,authenticationApi:()=>L.n,LocalAccountsQuery:()=>b.a,PinCodeServerApiConfig:()=>x,USER_NOT_SET_WITH_SECURITY_KEY:()=>W.gi,PhishingResistanceContracts:()=>m,GetCurrentUserStatusQuery:()=>F.o,SecurityKeyClient:()=>z.m,WRONG_PIN_CODE:()=>N.Vh,IdentityVerificationFlowContracts:()=>n,GetSecurityKeyOptionsQuery:()=>B.v,CanLockAppQuery:()=>k._,CleanRemotelyRemovedProfilesCommand:()=>E.L,DeviceTransferContracts:()=>s,ValidateWebauthnAssertionCommand:()=>y.L,NO_ACTIVE_PIN_CODE:()=>N.DN,AuthenticationFlowContracts:()=>r,createNoActivePinCodeError:()=>N.Zs,pinCodeApi:()=>C.n,deviceRegistrationApi:()=>f.G,userVerificationApi:()=>v.M,AuthenticationClient:()=>G,LoginWithPinCodeCommand:()=>O.c});var s={};i.r(s),i.d(s,{ApproveDeviceTransferRequestCommand:()=>d.G,CancelRequestCommand:()=>p.b,RefreshRequestCommand:()=>c.V,RejectDeviceTransferRequestCommand:()=>l.a,ReturnToDeviceSetupCommand:()=>h.n,SubmitPassphraseChallengeCommand:()=>u.I,TrustedDeviceFlowErrors:()=>o.S,TrustedDeviceFlowStatusQuery:()=>g.N,TrustedDeviceFlowStep:()=>o.T,deviceTransferApi:()=>a.F});var r=i(11396),n=i(60160),a=i(43530),o=i(46181),c=i(42229),d=i(28511),l=i(1776),u=i(46313),p=i(70285),h=i(86565),g=i(74859),m=i(20474),v=i(15468),y=i(30213),w=i(41893),S=i(77326),f=i(70985),E=i(89600),I=i(22717),b=i(26284),A=i(64773),C=i(19868),R=i(90973),_=i(50621),O=i(26775),T=i(44581),F=i(79437),D=i(19487),U=i(83816),P=i(55466);class x{constructor(e){(0,P._)(this,"env",void 0),this.env=e}}var N=i(60909),L=i(88978),k=i(82500),j=i(46266);class G extends(0,j.E)(L.n){}(0,j.K)(L.n,G);var V=i(85662),M=i(11826),K=i(47898),W=i(61664),z=i(15001),q=i(91687),B=i(27504)},67602:function(e,t,i){i.d(t,{I:()=>o});var s=i(36503),r=i(14247),n=i(28655),a=i(66645);let o=(0,s.Q)({name:"phishingResistance",commands:{setToken:r.r},events:{},queries:{getIsTokenRequired:n.c,getToken:a.m}})},11103:function(e,t,i){i.d(t,{L:()=>n});var s=i(46266),r=i(67602);class n extends(0,s.E)(r.I){}(0,s.K)(r.I,n)},14247:function(e,t,i){i.d(t,{r:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},20474:function(e,t,i){i.r(t),i.d(t,{GET_IS_TOKEN_REQUIRED_ERROR:()=>o.N,GetIsTokenRequiredQuery:()=>c.c,GetTokenQuery:()=>d.m,PhishingResistanceClient:()=>r.L,SetTokenCommand:()=>n.r,TOKEN_FETCHING_REQUIRED:()=>a.o,createGetIsTokenRequiredQueryError:()=>o.Z,phishingResistanceApi:()=>s.I});var s=i(67602),r=i(11103),n=i(14247),a=i(96079),o=i(86419),c=i(28655),d=i(66645)},28655:function(e,t,i){i.d(t,{c:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},66645:function(e,t,i){i.d(t,{m:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},86419:function(e,t,i){i.d(t,{N:()=>r,Z:()=>n});var s=i(96272);let r="GET_IS_TOKEN_REQUIRED_ERROR",n=(0,s.Vj)(r,"Error getting token requirement")},96079:function(e,t,i){i.d(t,{o:()=>s});let s="TOKEN_FETCHING_REQUIRED"},19868:function(e,t,i){i.d(t,{n:()=>l});var s=i(36503),r=i(90973),n=i(50621),a=i(26775),o=i(19487),c=i(44581),d=i(79437);let l=(0,s.Q)({name:"pinCode",commands:{activate:r.r,deactivate:n.E,loginWithPinCode:a.c},events:{},queries:{isPinCodeCorrect:o.M,getStatus:c.D,getCurrentUserStatus:d.o}})},83816:function(e,t,i){i.d(t,{u:()=>n});var s=i(46266),r=i(19868);class n extends(0,s.E)(r.n){}(0,s.K)(r.n,n)},90973:function(e,t,i){i.d(t,{r:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},50621:function(e,t,i){i.d(t,{E:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},26775:function(e,t,i){i.d(t,{c:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},60909:function(e,t,i){i.d(t,{DN:()=>a,Vh:()=>r,Zs:()=>o,g5:()=>n});var s=i(96272);let r="WRONG_PIN_CODE",n=(0,s.Vj)(r,"Entered pin-code is not correct"),a="NO_ACTIVE_PIN_CODE",o=(0,s.Vj)(a,"User has no active pin-code")},79437:function(e,t,i){i.d(t,{o:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},44581:function(e,t,i){i.d(t,{D:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},19487:function(e,t,i){i.d(t,{M:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},85662:function(e,t,i){i.d(t,{d:()=>c});var s=i(36503),r=i(11826),n=i(47898),a=i(91687),o=i(27504);let c=(0,s.Q)({name:"securityKey",commands:{saveSecurityKeys:r.Q,loginWithSecurityKey:n.T},events:{},queries:{initAccountCreation:a.M,getSecurityKeyOptions:o.v}})},15001:function(e,t,i){i.d(t,{m:()=>n});var s=i(46266),r=i(85662);class n extends(0,s.E)(r.d){}(0,s.K)(r.d,n)},47898:function(e,t,i){i.d(t,{T:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},61664:function(e,t,i){i.d(t,{Zx:()=>n,gi:()=>r,pF:()=>o,rI:()=>a});var s=i(96272);let r="USER_NOT_SET_WITH_SECURITY_KEY",n=(0,s.Vj)(r,"User has not been set with security key"),a="AUTHENTICATION_WITH_SECURITY_KEY_FAILED",o=(0,s.Vj)(a,"Authentication with security key failed")},11826:function(e,t,i){i.d(t,{Q:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},27504:function(e,t,i){i.d(t,{v:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},91687:function(e,t,i){i.d(t,{M:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},41893:function(e,t,i){i.d(t,{A:()=>r});var s,r=((s={}).AccountNotEligible="AccountNotEligible",s.NetworkError="NetworkError",s)},77326:function(e,t,i){i.d(t,{W:()=>a,Y:()=>o});var s,r=i(45429),n=i(15021),a=((s={}).Biometrics="Biometrics",s.Pin="Pin",s.MasterPassword="MasterPassword",s);class o extends(0,r.k)({scope:n.F.User}){}},15468:function(e,t,i){i.d(t,{M:()=>a});var s=i(36503),r=i(30213),n=i(77326);let a=(0,s.Q)({name:"userVerification",commands:{validateWebauthnAssertion:r.L,request2FaCodesByPhone:r.x},queries:{userVerificationMethods:n.Y},events:{}})},30213:function(e,t,i){i.d(t,{L:()=>n,x:()=>a});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}class a extends(0,s.g)({scope:r.F.Device}){}},2706:function(e,t,i){i.d(t,{c:()=>t0});var s=i(21636),r=i(44577),n=i(90834),a=i(6223),o=i(49247),c=i(48035),d=i(70438),l=i(29047),u=i(99481),p=i(90573),h=i(79374),g=i(544),m=i(306),v=i(4843),y=i(88288),w=i(32004),S=i(15021),f=i(59982);let E=e=>!0;class I extends(0,f.Q)({initialValue:void 0,persist:!1,scope:S.F.Device,storeName:"device-registration-flow-store",storeTypeGuard:E}){}var b=i(83833),A=i(23269),C=i(94190),R=i(37196),_=i(6153);class O extends _.x{}var T=i(19855);class F{async executeWithParams({login:e,masterPassword:t,isRememberMeEnabled:i,serverKey:s}){try{let n=await (0,r.z)(this.session.queries.localSessions());if(!(0,m.d6)(n))throw Error("Failure querying the session module to get the sessions");if(e in n.data){let r=await this.session.commands.openUserSession({email:e,rememberPassword:i,sessionKey:{type:"mp",masterPassword:t,secondaryKey:s}});if(!(0,m.d6)(r))throw Error("Failed to open session");return Promise.resolve()}let a=await this.carbon.commands.openSessionWithMasterPassword({login:e,password:t,rememberPassword:i,requiredPermissions:void 0,loginType:"MasterPassword"});if(!(0,m.d6)(a))throw Error("Failed to open session in carbon");return Promise.resolve()}catch(e){if(e instanceof Error&&("exception"in e&&e.exception instanceof Error?e.exception.message:e.message).includes("WRONG_PASSWORD on openSessionWithMasterPassword"))return Promise.reject(new O);return Promise.reject(Error("UNKNOWN_ERROR"))}}constructor(e,t){this.carbon=e,this.session=t}}F=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._,void 0===T.x?Object:T.x])],F);var D=i(19444);class U{async execute(){try{let e=await this.carbonLegacy.commands.carbon({name:"checkDoesLocalRecoveryKeyExist",args:[]});if(!(0,m.d6)(e))throw Error("Carbon command failed");return{isAccountRecoveryAvailable:e.data.carbonResult.doesExist}}catch(e){return this.logger.error("Error checking local recovery key existence",{location:"AccountRecoveryStatusService",method:"execute()",error:e}),{isAccountRecoveryAvailable:!1}}}constructor(e,t){this.carbonLegacy=e,this.logger=t}}U=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._,void 0===D.SX?Object:D.SX])],U);class P{async executeWithParams(e){let t=await (0,r.z)(this.session.queries.checkSessionKey({email:e.login,sessionKey:{type:"mp",masterPassword:e.masterPassword,secondaryKey:e.serverKey}}));if(!(0,m.d6)(t))throw Error("Error verifying SK");if(t.data)return!0;throw new O}constructor(e){this.session=e}}P=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===T.x?Object:T.x])],P);class x{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},initial:"CheckingAccountRecoveryStatus",id:"MasterPasswordFlowMachine",context:{isRememberMeEnabled:!1,isAccountRecoveryAvailable:!1},states:{CheckingAccountRecoveryStatus:{invoke:{src:"checkAccountRecoveryStatus",onDone:{target:"WaitingForMasterPassword",actions:["assignAccountRecoveryStatus"]}}},WaitingForMasterPassword:{on:{INPUT_MASTER_PASSWORD:{target:"ValidatingMasterPassword",actions:["assignMasterPassword"]},SWITCH_TO_PIN_CODE:{target:"#AuthenticationFlowMachine.PinCode",cond:"hasPinCodeEnabled"},CARBON_WRONG_PASSWORD:{actions:["assignMpError"]}}},ValidatingMasterPassword:{invoke:{src:"validateMasterPassword",onDone:{target:"OpeningSessionWithMasterpassword"},onError:{actions:["assignMaybeMpError"],target:"WaitingForMasterPassword"}},on:{CARBON_LEGACY_ERROR:{target:"WaitingForMasterPassword",actions:["assignError"]},CARBON_WRONG_PASSWORD:{actions:["assignMpError"],target:"WaitingForMasterPassword"}}},OpeningSessionWithMasterpassword:{invoke:{src:"authenticateWithMasterPassword",onError:{actions:["assignMaybeMpError"],target:"WaitingForMasterPassword"},onDone:{target:"MasterPasswordDone"},CARBON_WRONG_PASSWORD:{actions:["assignMpError"],target:"WaitingForMasterPassword"}},on:{CARBON_LEGACY_ERROR:{target:"WaitingForMasterPassword",actions:["assignError"]},DEVICE_LIMIT_ABORTED:{target:"DeviceLimitAborted"}}},DeviceLimitAborted:{type:"final",data:{shouldResetAuthenticationFlow:!0}},MasterPasswordDone:{type:"final",data:{shouldResetAuthenticationFlow:!1}}}},options:{actions:{assignMasterPassword:(0,b.f0)({masterPassword:(e,t)=>t.masterPassword,isRememberMeEnabled:(e,t)=>t.rememberMe}),assignAccountRecoveryStatus:(0,b.f0)({isAccountRecoveryAvailable:(e,t)=>t.data.isAccountRecoveryAvailable}),assignError:(0,b.f0)({error:(e,t)=>({code:"unknown_error",data:{message:t.error}})}),assignGenericServiceError:(0,b.f0)({error:()=>({code:"unknown_error",data:{message:"UNKNOWN_ERROR"}})}),assignMpError:(0,b.f0)({error:()=>({code:"unknown_error",data:{message:"WRONG_PASSWORD"}})}),assignMaybeMpError:(0,b.f0)({error:(e,t)=>({code:"unknown_error",data:{message:t.data instanceof O?"WRONG_PASSWORD":"UNKNOWN_ERROR"}})}),assignSSOMigrationStatus:(0,b.f0)({serviceProviderRedirectUrl:(e,t)=>t.data?.serviceProviderRedirectUrl,isNitroProvider:(e,t)=>t.data?.isNitroProvider})},services:{authenticateWithMasterPassword:e=>{let{login:t,masterPassword:i,isRememberMeEnabled:s,serverKey:r}=e;return this.masterPasswordService.executeWithParams({login:t??"",masterPassword:i??"",isRememberMeEnabled:s,serverKey:r})},checkAccountRecoveryStatus:()=>this.accountRecoveryStatusService.execute(),validateMasterPassword:({login:e,masterPassword:t,serverKey:i})=>this.mpVerificationService.executeWithParams({login:e??"",masterPassword:t??"",serverKey:i})},guards:{hasPinCodeEnabled:e=>e.shouldAskPinCode}}}}create(){let{config:e,options:t}=this.desc();return(0,A.C)(e,t)}constructor(e,t,i){this.accountRecoveryStatusService=e,this.masterPasswordService=t,this.mpVerificationService=i}}x=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===U?Object:U,void 0===F?Object:F,void 0===P?Object:P])],x);class N{async requestCodeAgainstServer(){}async execute({login:e}){return await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"openSessionWithDashlaneAuthenticator",arg:[{login:e,password:null,persistData:!0,deviceName:""}]}),Promise.resolve()}async cancel(){return await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"cancelDashlaneAuthenticatorRegistration",arg:[]}),Promise.resolve()}constructor(e){this.carbonLegacy=e}}N=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._])],N);class L{async execute(e){try{return await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"openSessionResendToken",arg:[{login:e.login??""}]}),Promise.resolve()}catch(e){this.logger.error("Error resending session token",{location:"SendEmailToken",method:"execute()",error:e})}}constructor(e,t){this.carbonLegacy=e,this.logger=t}}L=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._,void 0===D.SX?Object:D.SX])],L);class k{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"AuthenticatorMachine",context:{isDashlaneAuthenticatorAvailable:!1},initial:"RequestingServerPush",states:{RequestingServerPush:{entry:["updateDashlaneAuthenticatorAvailability"],invoke:{src:"authenticateWithDashlaneAuthenticator"},on:{CARBON_LEGACY_ERROR:{actions:["assignError","updateDashlaneAuthenticatorAvailability"]},RESEND_PUSH_NOTIFICATION:{target:"RequestingServerPush",actions:["clearError"]},SWITCH_TO_EMAIL_TOKEN:{actions:["cancelDashlaneAuthenticator","clearError"],target:"EmailTokenRequested"}}},AuthenticatorPushValidated:{type:"final",data:{switchToEmailToken:!1}},EmailTokenRequested:{entry:["sendEmailToken"],type:"final",data:{switchToEmailToken:!0}}}},options:{actions:{clearError:(0,b.f0)({error:()=>void 0}),assignError:(0,b.f0)({error:(e,t)=>({code:"unknown_error",data:{message:t.error}})}),switchToEmailToken:(0,b.f0)({switchToEmailToken:()=>!0}),updateDashlaneAuthenticatorAvailability:(0,b.f0)({isDashlaneAuthenticatorAvailable:!0}),cancelDashlaneAuthenticator:()=>{this.dashlaneAuthenticatorService.cancel()},sendEmailToken:e=>{let{login:t}=e;this.sendEmailToken.execute({login:t})}},services:{authenticateWithDashlaneAuthenticator:e=>{let{login:t}=e;return this.dashlaneAuthenticatorService.execute({login:t})}},guards:{}}}}create(){let{config:e,options:t}=this.desc();return(0,A.C)(e,t)}constructor(e,t){this.dashlaneAuthenticatorService=e,this.sendEmailToken=t}}k=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===N?Object:N,void 0===L?Object:L])],k);class j{async execute(e){try{await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"openSessionWithToken",arg:[{login:e.login??"",password:null,token:e.emailToken??"",persistData:!0,deviceName:e.deviceName}]})}catch(e){this.logger.error("Error opening session with token",{location:"AuthenticateWithEmailToken",method:"execute()",error:e})}}constructor(e,t){this.carbonLegacy=e,this.logger=t}}j=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._,void 0===D.SX?Object:D.SX])],j);class G{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"EmailTokenMachine",context:{login:"",emailToken:"",deviceName:""},initial:"WaitingForEmailToken",states:{SendEmailToken:{invoke:{src:"sendEmailToken",onError:{target:"WaitingForEmailToken"},onDone:{target:"WaitingForEmailToken"}}},WaitingForEmailToken:{on:{INPUT_EMAIL_TOKEN:{target:"ValidatingEmailToken",actions:["assignEmailToken"]},RESEND_EMAIL_TOKEN:{target:"SendEmailToken",actions:["clearError"]}}},ValidatingEmailToken:{entry:["authenticateWithEmailToken"],on:{CARBON_LEGACY_ERROR:{target:"WaitingForEmailToken",actions:["assignError"]}}},FinishingEmailToken:{type:"final",data:{switchToDashlaneAuthenticator:!1}},DashlaneAuthenticatorRequested:{type:"final",data:{switchToDashlaneAuthenticator:!0}}},on:{SWITCH_TO_DASHLANE_AUTHENTICATOR:{target:".DashlaneAuthenticatorRequested",internal:!0,actions:["clearError"]}}},options:{actions:{clearError:(0,b.f0)({error:()=>void 0}),assignError:(0,b.f0)({error:(e,t)=>({code:"unknown_error",data:{message:t.error}})}),assignEmailToken:(0,b.f0)({emailToken:(e,t)=>t.emailToken}),authenticateWithEmailToken:e=>{let{deviceName:t,emailToken:i,login:s}=e;return this.authenticateWithEmailToken.execute({deviceName:t,emailToken:i,login:s})}},services:{sendEmailToken:e=>{let{login:t}=e;return this.sendEmailToken.execute({login:t})}},guards:{}}}}create(){let{config:e,options:t}=this.desc();return(0,A.C)(e,t)}constructor(e,t){this.authenticateWithEmailToken=e,this.sendEmailToken=t}}G=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===j?Object:j,void 0===L?Object:L])],G);let V=e=>({initial:e.initial,states:e.states,on:e.on??{}});class M{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{},guards:{}},id:"DeviceRegistrationMachine",context:{...this.authenticatorMachine.desc().config.context,...this.emailTokenMachine.desc().config.context,registrationMethod:void 0},initial:"StartDeviceRegistration",states:{StartDeviceRegistration:{always:[{target:"EmailToken",cond:"isRegistrationMethodEmailToken"},{target:"DashlaneAuthenticator",cond:"isRegistrationMethodAuthenticator"},{target:"TwoFactorAuthentication",cond:"isRegistrationMethodOTP"}]},DashlaneAuthenticator:{...V(this.authenticatorMachine.desc().config),onDone:[{target:"EmailToken",cond:"shouldSwitchToEmailToken"},{target:"DeviceRegistrationDone"}]},EmailToken:{...V(this.emailTokenMachine.desc().config),onDone:[{target:"DashlaneAuthenticator",cond:"shouldSwitchToAuthenticator"},{target:"DeviceRegistrationDone"}]},TwoFactorAuthentication:{onDone:{target:"DeviceRegistrationDone"}},DeviceRegistrationDone:{type:"final"}}},options:{actions:{...this.authenticatorMachine.desc().options.actions,...this.emailTokenMachine.desc().options.actions,assignUnknownDeviceRegistrationError:(0,b.f0)({error:()=>({code:"unknown_error",data:{message:"Unknown device registration error"}})})},services:{...this.authenticatorMachine.desc().options.services,...this.emailTokenMachine.desc().options.services},guards:{...this.authenticatorMachine.desc().options.guards,...this.emailTokenMachine.desc().options.guards,isRegistrationMethodEmailToken:e=>"email_token"===e.registrationMethod,isRegistrationMethodOTP:e=>"otp"===e.registrationMethod,isRegistrationMethodAuthenticator:e=>"dashlane_authenticator"===e.registrationMethod,shouldSwitchToEmailToken:(e,t)=>t.data.switchToEmailToken,shouldSwitchToAuthenticator:(e,t)=>t.data.switchToDashlaneAuthenticator}}}}create(){let{config:e,options:t}=this.desc();return(0,A.C)(e,t)}constructor(e,t){this.authenticatorMachine=e,this.emailTokenMachine=t}}M=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===k?Object:k,void 0===G?Object:G])],M);class K{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"WebAuthnMachine",context:{},initial:"InitWebAuthnAuthentication",states:{InitWebAuthnAuthentication:{on:{WEBAUTHN_AUTHENTICATION_FAIL:{target:"WebAuthnAuthenticationFailed",actions:["assignWebAuthnError"]}}},WebAuthnAuthenticationFailed:{on:{RETRY_WEBAUTHN_AUTHENTICATION:{target:"InitWebAuthnAuthentication",actions:["clearError"]}}},WebAuthnAuthenticationDone:{type:"final",data:{switchToMasterPassword:!1,switchToPinCode:!1}},MasterPasswordRequested:{type:"final",data:{switchToMasterPassword:!0,switchToPinCode:!1}},PinCodeRequested:{type:"final",data:{switchToMasterPassword:!1,switchToPinCode:!0}}},on:{USE_MASTER_PASSWORD:{actions:["clearError"],target:".MasterPasswordRequested",internal:!0},SWITCH_TO_PIN_CODE:{actions:["clearError"],target:".PinCodeRequested",internal:!0}}},options:{actions:{clearError:(0,b.f0)({error:()=>void 0}),assignWebAuthnError:(0,b.f0)({error:(e,t)=>t.error})},services:{},guards:{}}}}create(){let{config:e,options:t}=this.desc();return(0,A.C)(e,t)}}K=(0,s.gn)([(0,C.GS)()],K);class W{executeWithParams({login:e,masterPassword:t,otp:i,twoFactorAuthenticationOtpType:s,otpVerificationMode:r,deviceName:n}){let a={login:e,password:t??null,otp:i,withBackupCode:"backupCode"===s,persistData:!0};try{"otp2"===r?this.carbonLegacy.commands.carbonLegacyLeeloo({name:"openSessionWithOTP",arg:[{...a,deviceName:n}]}):"otp1"===r&&this.carbonLegacy.commands.carbonLegacyLeeloo({name:"openSessionWithOTPForNewDevice",arg:[a]})}catch(e){this.logger.error("Error opening session with otp",{location:"TwoFactorAuthenticationService",method:"execute()",error:e})}return Promise.resolve()}constructor(e,t){this.carbonLegacy=e,this.logger=t}}W=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._,void 0===D.SX?Object:D.SX])],W);class z{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"WebAuthnMachine",context:{twoFactorAuthenticationOtpType:"totp"},initial:"WaitingForTotp",states:{WaitingForTotp:{on:{INPUT_TOTP:{target:"ValidatingTwoFactorAuthenticationOtp",actions:["assignTwoFactorAuthenticationOtpValue"]},SWITCH_TWO_FACTOR_AUTHENTICATION_TYPE:{target:"WaitingForBackupCode",actions:["assignTwoFactorAuthenticationOtpType","clearError"]}}},WaitingForBackupCode:{on:{INPUT_BACKUP_CODE:{target:"ValidatingTwoFactorAuthenticationOtp",actions:["assignTwoFactorAuthenticationOtpValue"]},SWITCH_TWO_FACTOR_AUTHENTICATION_TYPE:{target:"WaitingForTotp",actions:["assignTwoFactorAuthenticationOtpType","clearError"]}}},ValidatingTwoFactorAuthenticationOtp:{entry:["authenticateWithTwoFactorAuthentication"],on:{CARBON_LEGACY_ERROR:[{target:"WaitingForBackupCode",cond:"isBackupCode",actions:["assignError"]},{target:"WaitingForTotp",actions:["assignError"]}]}},TwoFactorAuthenticationDone:{type:"final"}}},options:{actions:{assignError:(0,b.f0)({error:(e,t)=>({code:"unknown_error",data:{message:t.error}})}),clearError:(0,b.f0)({error:()=>void 0}),assignTwoFactorAuthenticationOtpValue:(0,b.f0)({twoFactorAuthenticationOtpValue:(e,t)=>t.twoFactorAuthenticationOtpValue}),assignTwoFactorAuthenticationOtpType:(0,b.f0)({twoFactorAuthenticationOtpType:(e,t)=>t.twoFactorAuthenticationOtpType}),authenticateWithTwoFactorAuthentication:e=>{let t={login:e.login??"",masterPassword:e.masterPassword??null,otp:e.twoFactorAuthenticationOtpValue,twoFactorAuthenticationOtpType:e.twoFactorAuthenticationOtpType,persistData:!0,otpVerificationMode:e.otpVerificationMode,deviceName:e.deviceName};this.twoFactorAuthenticationService.executeWithParams(t)}},services:{},guards:{isBackupCode:e=>"backupCode"===e.twoFactorAuthenticationOtpType}}}}create(){let{config:e,options:t}=this.desc();return(0,A.C)(e,t)}constructor(e){this.twoFactorAuthenticationService=e}}z=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===W?Object:W])],z);var q=i(70554),B=i(83816);class Y extends _.x{constructor(){super("Entered PIN code is wrong")}}class Q{async executeWithParams({loginEmail:e,pinCode:t}){if(!e)throw Error("No login email");let i=await this.pinCodeClient.commands.loginWithPinCode({email:e,pinCode:t});return(0,m.hx)(i)?Promise.reject((0,q.EQ)(i.error,{NO_ACTIVE_PIN_CODE:()=>Error("No active pin code"),WRONG_PIN_CODE:()=>new Y})):Promise.resolve()}constructor(e){this.pinCodeClient=e}}Q=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===B.u?Object:B.u])],Q);class H{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"PinCodeMachine",context:{pinCode:""},initial:"WaitingForPinCode",states:{WaitingForPinCode:{on:{INPUT_PIN_CODE:{target:"ValidatingPinCode",actions:["assignPinCode"]},USE_MASTER_PASSWORD:{target:"#AuthenticationFlowMachine.MasterPassword"},USE_DEVICE_TO_DEVICE_AUTHENTICATION:{target:"#AuthenticationFlowMachine.DeviceToDeviceAuthentication"}}},ValidatingPinCode:{invoke:{src:"validatePinCode",onDone:{target:"PinCodeDone"},onError:{actions:["assignPinCodeError"],target:"WaitingForPinCode"}}},PinCodeDone:{type:"final"}}},options:{actions:{assignPinCode:(0,b.f0)({pinCode:(e,t)=>t.pinCode}),assignPinCodeError:(0,b.f0)({error:(e,t)=>({code:t.data instanceof Y?"wrong_pin_code":"unknown_error"})}),clearError:(0,b.f0)({error:()=>void 0}),clearContext:(0,b.f0)({pinCode:()=>"",error:()=>void 0})},services:{validatePinCode:e=>this.pinCodeVerificationService.executeWithParams({loginEmail:e.login,pinCode:e.pinCode})},guards:{}}}}create(){let{config:e,options:t}=this.desc();return(0,A.C)(e,t)}constructor(e){this.pinCodeVerificationService=e}}H=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===Q?Object:Q])],H);var $=i(56144),X=i(42589);class Z{retrieveLocalAccounts(){return(0,r.z)(this.carbonLegacyClient.queries.carbonState({path:"authentication.localAccounts"}).pipe((0,$.h)(m.d6),(0,$.h)(e=>e.data.accountsListInitialized),(0,X.U)(e=>e.data.accountsList)))}async getPinCodeStatus(e){if(!e)return!1;let t=await (0,r.z)(this.pinCodeClient.queries.getStatus({loginEmail:e}));return!(0,m.hx)(t)&&t.data.isPinCodeEnabled}async execute(){let e=await this.retrieveLocalAccounts(),t=e?.find(e=>e.isLastSuccessfulLogin),i=await this.getPinCodeStatus(t?.login);return{localAccounts:e??[],lastUsedLogin:t?.login??"",shouldAskMasterPassword:t?.shouldAskMasterPassword??!1,shouldAskPinCode:i,shouldAskOTP:t?.hasLoginOtp??!1,rememberMeType:t?.rememberMeType??"disabled"}}constructor(e,t){this.carbonLegacyClient=e,this.pinCodeClient=t}}Z=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._,void 0===B.u?Object:B.u])],Z);class J{async execute(e){await this.carbonLegacy.commands.carbon({name:"loginViaSSO",args:[e]})}constructor(e){this.carbonLegacy=e}}J=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._])],J);var ee=i(68238);let et=e=>!0;class ei extends(0,f.Q)({persist:!1,initialValue:{},scope:S.F.Device,storeName:"sso-provider-info",storeTypeGuard:et,capacity:ee.Y._001KB}){}class es{async execute({isNitroProvider:e,serviceProviderRedirectUrl:t}){await this.ssoProviderInfoStore.set({isNitroProvider:e,serviceProviderUrl:t})}constructor(e){this.ssoProviderInfoStore=e,this.ssoProviderInfoStore=e}}es=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[ei])],es);class er{async execute({login:e}){await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"openSession",arg:[{login:e??""}]})}constructor(e){this.carbonLegacy=e}}er=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._])],er);class en{async execute({login:e}){if(e){let t=await (0,r.z)(this.pinCodeClient.queries.getStatus({loginEmail:e}));if((0,m.d6)(t)&&t.data.isPinCodeEnabled)return Promise.resolve(!0)}return Promise.resolve(!1)}constructor(e){this.pinCodeClient=e}}en=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===B.u?Object:B.u])],en);var ea=i(81544),eo=i(70675),ec=i(76793),ed=i(9846);class el{async execute({login:e}){let t=eo.getDefaultDeviceName();if(!e||!t)throw new ed.z("No user login/device name",ea.UY.GENERIC_ERROR);let i=await this.d2dAuthenticationService.requestTransfer(e,t);if((0,m.hx)(i))throw new ed.z("Request transfer error",ea.UY.GENERIC_ERROR);let{transferId:s,expireDateUnix:r}=i.data;return Promise.resolve({transferId:s,expireDateUnix:r})}constructor(e){this.d2dAuthenticationService=e}}el=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===ec.C?Object:ec.C])],el);var eu=i(31422);class ep{async execute({transferId:e}){if(!e)throw new ed.z("No transferId in context",ea.UY.GENERIC_ERROR);let{privateKey:t,publicKey:i}=this.d2dCryptoService.generateKeyPair(),s=this.d2dCryptoService.hash(i),r=await this.d2dAuthenticationService.startReceiverKeyExchange(e,s);if((0,m.hx)(r))return Promise.reject(r.error);let{senderPublicKey:n}=r.data;return Promise.resolve({receiverPrivateKey:t,receiverPublicKey:i,senderPublicKey:n})}constructor(e,t){this.d2dCryptoService=e,this.d2dAuthenticationService=t}}ep=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eu.q?Object:eu.q,void 0===ec.C?Object:ec.C])],ep);class eh{async execute(e){if(!e.transferId||!e.login)throw new ed.z("No transferId or user login in the machine context",ea.UY.GENERIC_ERROR);let t=await this.d2dAuthenticationService.startTransfer(e.transferId);return(0,m.hx)(t)?Promise.reject(t.error):Promise.resolve(t.data)}constructor(e){this.d2dAuthenticationService=e}}eh=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===ec.C?Object:ec.C])],eh);class eg{async execute(e){if(!e.transferId||!e.login)throw new ed.z("No transferId or user login in the machine context",ea.UY.GENERIC_ERROR);if(!e.receiverPrivateKey||!e.receiverPublicKey||!e.senderPublicKey)throw new ed.z("Missing keys/data in context",ea.UY.GENERIC_ERROR);if(!e.sharedSecret)throw new ed.z("Missing sharedSecret in context",ea.UY.GENERIC_ERROR);if(!e.encryptedData||!e.nonce)throw new ed.z("Missing transfer data in context",ea.UY.GENERIC_ERROR);let t=this.d2dCryptoService.generateSymmetricKey(e.login,e.transferId,e.sharedSecret),i=this.d2dCryptoService.decryptInvisibleMasterPassword(e.encryptedData,e.nonce,t);await this.d2dAuthenticationService.openSession(i.login,i.token,i.key.value,e.deviceName)}constructor(e,t){this.d2dCryptoService=e,this.d2dAuthenticationService=t}}eg=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eu.q?Object:eu.q,void 0===ec.C?Object:ec.C])],eg);var em=i(12908);class ev{async execute(e){if(!e.receiverPrivateKey||!e.receiverPublicKey||!e.senderPublicKey)throw new ed.z("Keys not found in the state machine context",ea.UY.GENERIC_ERROR);if(!e.transferId)throw new ed.z("TransferId not found in the state machine context/store",ea.UY.GENERIC_ERROR);if(!e.login)throw new ed.z("User login not found in state machine context/store",ea.UY.GENERIC_ERROR);let t=await this.d2dAuthenticationService.completeKeyExchange(e.transferId,e.receiverPublicKey);if((0,m.hx)(t))throw new ed.z("Error with completeKeyExchange",ea.UY.GENERIC_ERROR);let i=this.d2dCryptoService.generateReceiverSharedSecret(e.receiverPublicKey,e.receiverPrivateKey,e.senderPublicKey),s=this.d2dCryptoService.generateVisualCheckSeed(e.login,e.transferId,i),{passphrase:r}=await this.passphraseService.generatePassphraseChallenge(s);return Promise.resolve({sharedSecret:i,passphrase:r})}constructor(e,t,i){this.d2dCryptoService=e,this.d2dAuthenticationService=t,this.passphraseService=i}}ev=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eu.q?Object:eu.q,void 0===ec.C?Object:ec.C,void 0===em.Kp?Object:em.Kp])],ev);class ey{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"DeviceToDeviceAuthenticationFlow",initial:"WaitingForTransferRequest",context:{transferId:void 0},states:{WaitingForTransferRequest:{invoke:{src:"requestDeviceTransfer",onDone:{target:"DisplayInstructions",actions:["assignTransferId"]},onError:{actions:["assignDeviceToDeviceError"],target:"DeviceTransferError"}}},DisplayInstructions:{invoke:{src:"startReceiverKeyExchange",onDone:{actions:["assignKeys"],target:"GeneratePassphrase"},onError:{actions:["assignDeviceToDeviceError"],target:"DeviceTransferError"}}},GeneratePassphrase:{invoke:{src:"completeKeyExchangeAndGeneratePassphrase",onDone:{actions:["assignPassphrase"],target:"StartTransfer"},onError:{actions:["assignDeviceToDeviceError"],target:"DeviceTransferError"}}},StartTransfer:{invoke:{src:"startTransfer",onDone:{actions:["assignTransferData"],target:"OpenSession"},onError:{actions:["assignDeviceToDeviceError"],target:"DeviceTransferError"}}},OpenSession:{invoke:{src:"openSession",onDone:{target:"DeviceRegistered"},onError:{actions:["assignDeviceToDeviceError"],target:"DeviceTransferError"}}},DeviceTransferError:{},DeviceRegistered:{type:"final"}}},options:{actions:{assignTransferId:(0,b.f0)({transferId:(e,t)=>t.data.transferId}),assignKeys:(0,b.f0)({receiverPublicKey:(e,t)=>t.data.receiverPublicKey,receiverPrivateKey:(e,t)=>t.data.receiverPrivateKey,senderPublicKey:(e,t)=>t.data.senderPublicKey}),assignPassphrase:(0,b.f0)({passphrase:(e,t)=>t.data.passphrase,sharedSecret:(e,t)=>t.data.sharedSecret}),assignTransferData:(0,b.f0)({encryptedData:(e,t)=>t.data.encryptedData,nonce:(e,t)=>t.data.nonce}),clearContext:(0,b.f0)({deviceName:()=>void 0,transferId:()=>void 0,receiverPublicKey:()=>void 0,receiverPrivateKey:()=>void 0,senderPublicKey:()=>void 0,sharedSecret:()=>void 0,passphrase:()=>void 0}),assignDeviceToDeviceError:(0,b.f0)({error:(e,t)=>t.data instanceof ed.z?t.data.code:ea.UY.GENERIC_ERROR})},services:{requestDeviceTransfer:e=>this.requestDeviceTransfer.execute(e),startReceiverKeyExchange:e=>this.startReceiverKeyExchange.execute(e),completeKeyExchangeAndGeneratePassphrase:e=>this.completeKeyExchangeAndGeneratePassphrase.execute(e),startTransfer:e=>this.startTransfer.execute(e),openSession:e=>this.openSession.execute(e)}}}}create(){let{config:e,options:t}=this.desc();return(0,A.C)(e,t)}constructor(e,t,i,s,r){this.requestDeviceTransfer=e,this.startReceiverKeyExchange=t,this.completeKeyExchangeAndGeneratePassphrase=i,this.startTransfer=s,this.openSession=r}}ey=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===el?Object:el,void 0===ep?Object:ep,void 0===ev?Object:ev,void 0===eh?Object:eh,void 0===eg?Object:eg])],ey);class ew{desc(e=!1){let t={config:{predictableActionArguments:!0,schema:{events:{},context:{}},initial:"Starting",id:"AuthenticationFlowMachine",context:{...this.deviceRegistrationMachine.desc().config.context,...this.masterPasswordFlowMachine.desc().config.context,...this.twoFactorAuthenticationMachine.desc().config.context,...this.webAuthnMachine.desc().config.context,...this.deviceToDeviceAuthenticationMachine.desc().config.context,...this.pinCodeMachine.desc().config.context,ready:!1,shouldAskMasterPassword:!1,shouldAskOTP:!1,shouldAskPinCode:!1},states:{Starting:{invoke:{src:"initializeMachine",onDone:{actions:["assignInitializationResults"],target:"RememberMeRedirection"}}},RememberMeRedirection:{always:[{target:"MasterPassword",cond:"shouldAskMasterPassword"},{target:"CheckSessionForOtp2",cond:"shouldAskOTP"},{target:"WebAuthn",cond:"rememberMeIsWebAuthn"},{target:"WaitingForEmail"}]},CheckSessionForOtp2:{entry:["checkAccountType"]},WaitingForEmail:{on:{INPUT_ACCOUNT_EMAIL:{target:"ValidatingEmail",actions:["assignAccountEmail","clearError"]}}},ValidatingEmail:{entry:["checkAccountType"],on:{CARBON_LEGACY_ERROR:{target:"WaitingForEmail",actions:["assignError"]}}},PinCode:{...V(this.pinCodeMachine.desc().config),onDone:{target:"PinCodeAuthenticationDone"}},DeviceRegistration:{...V(this.deviceRegistrationMachine.desc().config)},WebAuthn:{...V(this.webAuthnMachine.desc().config),onDone:[{target:"MasterPassword",cond:"shouldSwitchToMasterPassword"},{target:"PinCode",cond:"shouldSwitchToPinCode"},{target:"MasterPasswordBasedAuthenticationDone"}]},TwoFactorAuthentication:{...V(this.twoFactorAuthenticationMachine.desc().config),onDone:{target:"MasterPasswordBasedAuthenticationDone"}},SSOAuthentication:{entry:["legacySSOLogin"]},SSORedirectionToIdp:{entry:["assignServiceProviderInfo","storeSSOInfo"],on:{CARBON_LEGACY_ERROR:{target:"WaitingForEmail",actions:["assignError"]}}},CheckPinCodeAvailableForMasterPassword:{invoke:{src:"checkPinCodeStatus",onDone:[{actions:["assignShouldAskPinCode"],cond:"isPinCodeLogin",target:"PinCode"},{actions:["assignShouldAskPinCode"],target:"MasterPassword"}]}},MasterPassword:{...V(this.masterPasswordFlowMachine.desc().config),onDone:[{target:"WaitingForEmail",cond:"shouldResetAuthenticationFlow"},{target:"MasterPasswordBasedAuthenticationDone"}]},MasterPasswordBasedAuthenticationDone:{on:{CARBON_LEGACY_LOGGED_OUT:{target:"Starting"}}},CheckPinCodeAvailableForPasswordless:{invoke:{src:"checkPinCodeStatus",onDone:[{actions:["assignShouldAskPinCode"],cond:"isPinCodeLogin",target:"PinCode"},{actions:["assignShouldAskPinCode"],target:"DeviceToDeviceAuthentication"}]}},DeviceToDeviceAuthentication:{...V(this.deviceToDeviceAuthenticationMachine.desc().config),onDone:{target:"DeviceToDeviceAuthenticationDone"}},PinCodeAuthenticationDone:{type:"final"},DeviceToDeviceAuthenticationDone:{type:"final"}},on:{CHANGE_ACCOUNT_EMAIL:[{target:"ValidatingEmail",actions:["clearError","assignAccountEmail"],cond:"isAccountLoginAvailable"},{target:"WaitingForEmail",actions:["clearError","clearEmail"]}],CARBON_LEGACY_ASK_MASTER_PASSWORD:{target:"CheckPinCodeAvailableForMasterPassword",actions:["assignServerKey","clearError"]},CARBON_LEGACY_OPEN_SESSION_TOKEN_SENT:[{target:"DeviceRegistration.EmailToken",actions:["assignAccountEmail","clearError"],cond:"isGrapheneDeviceRegistrationFlow"},{target:"DeviceRegistration.EmailToken",actions:["assignAccountEmail","clearError"]}],CARBON_LEGACY_OPEN_SESSION_DASHLANE_AUTHENTICATOR:{target:"DeviceRegistration.DashlaneAuthenticator",actions:["clearError"]},CARBON_LEGACY_OPEN_SESSION_SSO_REDIRECTION_TO_IDP_REQUIRED:{target:"SSORedirectionToIdp",actions:["clearError"]},CARBON_LEGACY_SSO_LOGIN_BYPASS:{target:"SSOAuthentication",actions:["assignSsoData"]},CARBON_LEGACY_OPEN_SESSION_OTP_SENT:{target:"TwoFactorAuthentication",actions:["assignOtpVerificationMode","clearError"]},CARBON_LEGACY_OPEN_SESSION_DEVICE_TO_DEVICE:{target:"CheckPinCodeAvailableForPasswordless",actions:["assignServerKey","clearError"]},CLEAR_ERROR:{actions:["clearError"]}}},options:{actions:{...this.deviceRegistrationMachine.desc().options.actions,...this.masterPasswordFlowMachine.desc().options.actions,...this.twoFactorAuthenticationMachine.desc().options.actions,...this.webAuthnMachine.desc().options.actions,...this.deviceToDeviceAuthenticationMachine.desc().options.actions,...this.pinCodeMachine.desc().options.actions,assignInitializationResults:(0,b.f0)({login:(e,t)=>t.data.lastUsedLogin,localAccounts:(e,t)=>t.data.localAccounts,shouldAskMasterPassword:(e,t)=>t.data.shouldAskMasterPassword,shouldAskOTP:(e,t)=>t.data.shouldAskOTP,shouldAskPinCode:(e,t)=>t.data.shouldAskPinCode,rememberMeType:(e,t)=>t.data.rememberMeType,ready:()=>!0}),assignAccountEmail:(0,b.f0)({login:(e,t)=>t.login}),assignError:(0,b.f0)({error:(e,t)=>({code:"unknown_error",data:{message:t.error}})}),assignOtpVerificationMode:(0,b.f0)({otpVerificationMode:(e,t)=>t.otpVerificationMode}),assignSsoData:(0,b.f0)({ssoData:(e,t)=>t}),assignServiceProviderInfo:(0,b.f0)({serviceProviderRedirectUrl:(e,t)=>t.serviceProviderRedirectUrl,isNitroProvider:(e,t)=>t.isNitroProvider,rememberMeForSSOPreference:(e,t)=>t.rememberMeForSSOPreference}),assignServerKey:(0,b.f0)({serverKey:(e,t)=>t.serverKey}),assignShouldAskPinCode:(0,b.f0)({shouldAskPinCode:(e,t)=>t.data}),clearEmail:(0,b.f0)({login:void 0}),clearError:(0,b.f0)({error:()=>void 0}),clearContext:(0,b.f0)({login:()=>"",shouldAskOTP:()=>!1,shouldAskMasterPassword:()=>!1,twoFactorAuthenticationOtpType:()=>"totp",registrationMethod:()=>void 0,emailToken:()=>"",deviceName:()=>"",isDashlaneAuthenticatorAvailable:()=>!1,isRememberMeEnabled:()=>!1,isAccountRecoveryAvailable:()=>!1}),legacySSOLogin:(e,t)=>this.legacySSOLoginService.execute(t),checkAccountType:e=>this.checkAccountType.execute(e),storeSSOInfo:(e,t)=>this.storeSSOInfoService.execute(t)},services:{...this.deviceRegistrationMachine.desc().options.services,...this.masterPasswordFlowMachine.desc().options.services,...this.twoFactorAuthenticationMachine.desc().options.services,...this.webAuthnMachine.desc().options.services,...this.deviceToDeviceAuthenticationMachine.desc().options.services,...this.pinCodeMachine.desc().options.services,initializeMachine:()=>this.initializeMachineService.execute(),checkAccountType:e=>this.checkAccountType.execute(e),checkPinCodeStatus:e=>this.checkPinCodeStatusService.execute(e)},guards:{...this.deviceRegistrationMachine.desc().options.guards,...this.twoFactorAuthenticationMachine.desc().options.guards,...this.webAuthnMachine.desc().options.guards,...this.masterPasswordFlowMachine.desc().options.guards,isAccountLoginAvailable:(e,t)=>!!t.login,shouldAskMasterPassword:e=>e.shouldAskMasterPassword&&!e.shouldAskPinCode,shouldAskOTP:e=>!!e.shouldAskOTP&&e.shouldAskOTP,shouldAskPinCode:e=>e.shouldAskPinCode,shouldSwitchToMasterPassword:(e,t)=>t.data.switchToMasterPassword,shouldSwitchToPinCode:(e,t)=>t.data.switchToPinCode,shouldResetAuthenticationFlow:(e,t)=>t.data.shouldResetAuthenticationFlow,rememberMeIsWebAuthn:e=>void 0!==e.rememberMeType&&"webauthn"===e.rememberMeType,isGrapheneDeviceRegistrationFlow:e=>!!e.login&&e.login.includes("kw_test_newdevice"),isPinCodeLogin:(e,t)=>t.data}}};return e&&(0,R.G)(t.config),t}create(e=!1){let{config:t,options:i}=this.desc(e);return(0,A.C)(t,i)}constructor(e,t,i,s,r,n,a,o,c,d,l){this.deviceRegistrationMachine=e,this.masterPasswordFlowMachine=t,this.twoFactorAuthenticationMachine=i,this.webAuthnMachine=s,this.deviceToDeviceAuthenticationMachine=r,this.pinCodeMachine=n,this.initializeMachineService=a,this.legacySSOLoginService=o,this.checkAccountType=c,this.storeSSOInfoService=d,this.checkPinCodeStatusService=l}}ew=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===M?Object:M,void 0===x?Object:x,void 0===z?Object:z,void 0===K?Object:K,void 0===ey?Object:ey,void 0===H?Object:H,void 0===Z?Object:Z,void 0===J?Object:J,void 0===er?Object:er,void 0===es?Object:es,void 0===en?Object:en])],ew);var eS=i(51721),ef=i(649),eE=i(59242);let eI=e=>(0,eS.K)(e)&&"type"in e&&"dashlane_authenticator"!==e.type,eb=e=>{if(e)switch(e){case"sso_member_to_admin":case"sso_member_to_mp_user":return ea.vX.SSO_TO_MP;case"mp_user_to_sso_member":return ea.vX.MP_TO_SSO;default:return}};class eA{async getSsoMigration(e){let t=await (0,r.z)(this.serverApiClient.v1.authentication.getAuthenticationMethodsForDevice({login:e,methods:["email_token","totp","duo_push","dashlane_authenticator","u2f"]}));if((0,m.hx)(t))return(0,q.EQ)(t.error,{FetchFailedError:()=>void 0,BusinessError:()=>(0,ef.j)("Retrieve of verificationMethods failed"),InternalServerError:()=>(0,ef.j)("Retrieve of verificationMethods failed"),InvalidRequest:()=>(0,ef.j)("Retrieve of verificationMethods failed"),RateLimited:()=>(0,ef.j)("Retrieve of verificationMethods failed"),ServiceUnavailable:()=>(0,ef.j)("Retrieve of verificationMethods failed"),UnspecifiedBadStatus:()=>(0,ef.j)("Retrieve of verificationMethods failed")});let i=t.data.data.verifications.find(eI);if(!i)throw Error("No valid verification method");if("sso"===i.type)return{serviceProviderUrl:i.ssoInfo.serviceProviderUrl,isNitroProvider:i.ssoInfo.isNitroProvider,migration:i.ssoInfo.migration}}async executeWithParams({login:e}){let t=await this.getSsoMigration(e);if(t)return await this.ssoProviderInfoStore.set({isNitroProvider:t.isNitroProvider??!1,serviceProviderUrl:t.serviceProviderUrl,migrationType:eb(t.migration)}),{serviceProviderRedirectUrl:t.serviceProviderUrl,isNitroProvider:t.isNitroProvider}}constructor(e,t){this.ssoProviderInfoStore=e,this.serverApiClient=t,this.ssoProviderInfoStore=e,this.serverApiClient=t}}eA=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[ei,void 0===eE.l?Object:eE.l])],eA);var eC=i(43840),eR=i(69334),e_=i(22050),eO=i(71581),eT=i(39559);let eF=e=>!0;class eD extends(0,f.Q)({initialValue:void 0,persist:!1,scope:S.F.Device,storeName:"authentication-flow-machine",storeTypeGuard:eF}){}let eU=async(e,t)=>{await e.set(JSON.stringify(t))},eP=async e=>{let t=await e.getState();return t?eT.ZM.create(JSON.parse(t)):void 0},ex=e=>e.state$.pipe((0,X.U)(e=>e?eT.ZM.create(JSON.parse(e)):void 0));class eN{execute(){try{let{carbonState:e}=this.carbon.queries;e({path:"userSession.loginDeviceLimitFlow.flow"}).pipe((0,X.U)(e=>{if("success"===e.tag)return e.data})).subscribe(e=>{this.lastDeviceLimitFlowValue&&!e&&this.interpreter.send({type:"DEVICE_LIMIT_ABORTED"}),this.lastDeviceLimitFlowValue=e})}catch(e){return Promise.reject(Error("Unable to subscribe to loginDeviceLimitFlow state"))}}constructor(e,t){this.interpreter=e,this.carbon=t}}class eL{async prepare(){let e;await this.abortDeviceLimitEventHandler.execute();let t=await eP(this.loginMachineStore);if(!t){let e=this.interpreter.start();await (0,eC.X)(e,e=>e.context.ready,{timeout:3e4});return}await this.allowedToFail.doOne(()=>{if(t.done)throw Error("Restarting a machine which is already in its final state. Starting from scratch instead.");e=this.interpreter.start(t)},{methodName:"Resuming state machine"}),e||(e=this.interpreter.start()),await (0,eC.X)(e,e=>e.context.ready)}continue(e){this.interpreter.send(e)}constructor(e,t,i,s,r,n){this.carbon=s,this.allowedToFail=r,this.logger=n,this.loginMachineStore=t;let a=e.create(i);this.interpreter=(0,eR.kJ)(a).onChange(e=>{this.logger.info("Context change occured",{location:"AuthenticationFlow",method:"interpreter.onChanged()",context:e})}).onEvent(e=>{this.logger.info("Context change occured",{location:"AuthenticationFlow",method:"interpreter.onEvent()",event:e})}).onTransition((e,t)=>{this.logger.info("Transition occured",{location:"AuthenticationFlow",method:"interpreter.onTransition()",event:t})}).onTransition((0,e_.V)(e=>this.allowedToFail.doOne(()=>{throw e}))).onEvent((0,eO.V)(e=>this.allowedToFail.doOne(()=>{throw e}))).onTransition(async()=>{let e=this.interpreter.getSnapshot();await eU(this.loginMachineStore,e)}),this.abortDeviceLimitEventHandler=new eN(this.interpreter,this.carbon)}}eL=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===ew?Object:ew,eD,Boolean,void 0===o._?Object:o._,void 0===l.J?Object:l.J,void 0===D.SX?Object:D.SX])],eL);var ek=i(41509),ej=i(72233),eG=i(69853),eV=i(96079),eM=i(11217),eK=i(54454);class eW{async requestEmailTokenVerificationLegacy(e){let t=await (0,r.z)(this.serverApiClient.v1.authentication.requestEmailTokenVerification({login:e}));if((0,m.hx)(t))throw this.logger.error("Error sending legacy email token verification",{location:"EmailTokenVerificationService",method:"requestEmailTokenVerificationLegacy()",requestEmailTokenVerificationSent:t}),Error("Error sending legacy email token verification")}async requestEmailTokenVerificationWithPhishingResistance(e,t){try{if("undefined"!=typeof chrome){let e=await (0,eM.c)();0===e.length&&await (0,eK.b)({})}await t.commands.setToken({token:eV.o});let i=await (0,r.z)(t.queries.getToken().pipe((0,$.h)(e=>{let t=(0,m.d6)(e)?(0,m.db)(e).token:"";return!!t&&t!==eV.o}),(0,ek.V)({first:2e4}),(0,ej.K)(()=>(0,eG.of)((0,m.Rn)(void 0))))),s=(0,m.hx)(i)?"":(0,m.db)(i).token;if(!s)throw this.logger.error("Error retrieving turnstile token",{location:"EmailTokenVerificationService",method:"requestEmailTokenVerificationWithPhishingResistance()"}),await t.commands.setToken({token:""}),Error("Error checking phishing resistance for email token verification");let n=await (0,r.z)(this.serverApiClient.v1.authentication.requestEmailTokenVerificationV2({login:e},{headers:{"cf-turnstile-response":s}}));if((0,m.hx)(n))throw this.logger.error("Error sending email token verification with phishing resistance",{location:"EmailTokenVerificationService",method:"requestEmailTokenVerificationWithPhishingResistance()",requestEmailTokenVerificationSent:n}),Error("Error sending email token verification with phishing resistance")}catch(e){throw this.logger.error("Error sending antiphishing token verification",{location:"EmailTokenVerificationService",method:"requestEmailTokenVerificationWithAntiphishing()",error:e}),Error("Error sending antiphishing email token verification")}}async requestEmailTokenVerification(e,t,i){return t?this.requestEmailTokenVerificationWithPhishingResistance(e,i):this.requestEmailTokenVerificationLegacy(e)}constructor(e,t){this.serverApiClient=e,this.logger=t}}eW=(0,s.gn)([(0,C.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eE.l?Object:eE.l,void 0===D.SX?Object:D.SX])],eW);var ez=i(37368),eq=i(83518);class eB{execute(e){let{pinCode:t}=e.body;return this.authenticationFlow.continue({type:"INPUT_PIN_CODE",pinCode:t}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}eB=(0,s.gn)([(0,ez.W)(eq.CO),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],eB);class eY{execute(){return this.authenticationFlow.continue({type:"USE_MASTER_PASSWORD"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}eY=(0,s.gn)([(0,ez.W)(eq.On),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],eY);class eQ{execute(){return this.authenticationFlow.continue({type:"SWITCH_TO_PIN_CODE"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}eQ=(0,s.gn)([(0,ez.W)(eq.WF),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],eQ);var eH=i(73827);class e${execute(e){let{login:t}=e.body;return this.authenticationFlow.continue({type:"CHANGE_ACCOUNT_EMAIL",login:t}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}e$=(0,s.gn)([(0,ez.W)(eq.hW),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],e$);class eX{execute(e){let{twoFactorAuthenticationOtpType:t}=e.body;return this.authenticationFlow.continue({type:"SWITCH_TWO_FACTOR_AUTHENTICATION_TYPE",twoFactorAuthenticationOtpType:t}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}eX=(0,s.gn)([(0,ez.W)(eq.eG),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],eX);class eZ{execute(){return this.authenticationFlow.continue({type:"CLEAR_ERROR"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}eZ=(0,s.gn)([(0,ez.W)(eq.jq),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],eZ);class eJ{execute(){return this.authenticationFlow.continue({type:"CANCEL_DEVICE_TRANSFER_REQUEST"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}eJ=(0,s.gn)([(0,ez.W)(eq.Yc),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],eJ);var e0=i(76047),e6=i(20474),e1=i(11103);class e2{async execute({body:e}){let{login:t}=e;try{let e=await (0,r.z)(this.phishingResistanceClient.queries.getIsTokenRequired());if((0,m.hx)(e))throw Error("Unexpected error attempting to determine phishing resistance token required");let i=(0,m.db)(e).isRequired;await this.emailTokenVerificationService.requestEmailTokenVerification(t,i,this.phishingResistanceClient)}catch{return(0,m.Rn)(e0.Z())}return(0,m.Vp)(void 0)}constructor(e,t){this.phishingResistanceClient=e,this.emailTokenVerificationService=t}}e2=(0,s.gn)([(0,ez.W)(eq._F),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===e6||void 0===e1.L?Object:e1.L,void 0===eW?Object:eW])],e2);class e4{execute(){return this.authenticationFlow.continue({type:"RESEND_EMAIL_TOKEN"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}e4=(0,s.gn)([(0,ez.W)(eq.Gc),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],e4);class e5{execute(){return this.authenticationFlow.continue({type:"RESEND_PUSH_NOTIFICATION"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}e5=(0,s.gn)([(0,ez.W)(eq.rF),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],e5);class e9{execute(e){let{login:t}=e.body;return this.authenticationFlow.continue({type:"INPUT_ACCOUNT_EMAIL",login:t}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}e9=(0,s.gn)([(0,ez.W)(eq.A),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],e9);class e3{execute(e){let{masterPassword:t,rememberMe:i}=e.body;return this.authenticationFlow.continue({type:"INPUT_MASTER_PASSWORD",masterPassword:t,rememberMe:i}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}e3=(0,s.gn)([(0,ez.W)(eq.rT),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],e3);class e7{execute(e){let{twoFactorAuthenticationOtpValue:t}=e.body;return this.authenticationFlow.continue({type:"INPUT_BACKUP_CODE",twoFactorAuthenticationOtpValue:t}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}e7=(0,s.gn)([(0,ez.W)(eq.sH),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],e7);class e8{execute(e){let{emailToken:t,deviceName:i}=e.body;return this.authenticationFlow.continue({type:"INPUT_EMAIL_TOKEN",emailToken:t,deviceName:i}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}e8=(0,s.gn)([(0,ez.W)(eq.XH),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],e8);class te{execute(e){let{twoFactorAuthenticationOtpValue:t}=e.body;return this.authenticationFlow.continue({type:"INPUT_TOTP",twoFactorAuthenticationOtpValue:t}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}te=(0,s.gn)([(0,ez.W)(eq.ad),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],te);class tt{execute(){return this.authenticationFlow.continue({type:"SWITCH_TO_DASHLANE_AUTHENTICATOR"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}tt=(0,s.gn)([(0,ez.W)(eq.K1),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],tt);class ti{execute(){return this.authenticationFlow.continue({type:"SWITCH_TO_EMAIL_TOKEN"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}ti=(0,s.gn)([(0,ez.W)(eq.v5),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],ti);class ts{execute(){return this.authenticationFlow.continue({type:"USE_DEVICE_TO_DEVICE_AUTHENTICATION"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}ts=(0,s.gn)([(0,ez.W)(eq.sU),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],ts);class tr{execute(){return this.authenticationFlow.continue({type:"RETRY_WEBAUTHN_AUTHENTICATION"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}tr=(0,s.gn)([(0,ez.W)(eq.M6),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],tr);class tn{execute(e){let{webAuthnError:t}=e.body;return this.authenticationFlow.continue({type:"WEBAUTHN_AUTHENTICATION_FAIL",error:t}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}tn=(0,s.gn)([(0,ez.W)(eq.O3),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],tn);class ta{async execute(){try{await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"closeSession",arg:[{}]})}catch(e){this.logger.error("Error closing session",{location:"LogoutCommandHandler",method:"execute()",error:e})}return Promise.resolve((0,m.Vp)(void 0))}constructor(e,t){this.carbonLegacy=e,this.logger=t}}ta=(0,s.gn)([(0,ez.W)(eq.N5),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._,void 0===D.SX?Object:D.SX])],ta);class to{async execute(){try{await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"lockSession",arg:[{}]})}catch(e){this.logger.trace("Error locking the session",{location:"LockCommandHandler",method:"execute()",error:e})}return Promise.resolve((0,m.Vp)(void 0))}constructor(e,t){this.carbonLegacy=e,this.logger=t}}to=(0,s.gn)([(0,ez.W)(eq.Y$),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._,void 0===D.SX?Object:D.SX])],to);class tc{execute(e){return this.authenticationFlow.continue({type:"CARBON_LEGACY_SSO_LOGIN_BYPASS",...e.body}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.authenticationFlow=e}}tc=(0,s.gn)([(0,ez.W)(eq.yv),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL])],tc);var td=i(18550),tl=i(23506),tu=i(59842),tp=i(20458);let th=e=>!!e&&"object"==typeof e&&"rememberMeForSSOPreference"in e;class tg extends(0,f.Q)({codec:tp.E,persist:!0,storage:{initialValue:{rememberMeForSSOPreference:!0},schemaVersion:1,typeGuard:th},scope:S.F.Device,storeName:"sso-info",storeTypeGuard:th,capacity:ee.Y._001KB}){}class tm{}let tv=e=>!!e&&"object"==typeof e&&(0,td.l$)(e,"ssoUser")&&(0,td.l$)(e,"serviceProviderUrl");class ty{async retrieveSSOInfo(){let e=await (0,r.z)(this.carbonLegacyClient.queries.carbonState({path:"userSession.ssoSettings"}).pipe((0,X.U)(e=>{if(!(0,m.d6)(e)||!tv(e.data))throw Error("SsoSettings is not of the expected type");return e.data})));return{isNitroProvider:e.isNitroProvider??!1,serviceProviderUrl:e.serviceProviderUrl}}async execute(e){let{loginUserWithEnclaveSSO:t}=this.client.getClient(tu.y).commands,i=await this.retrieveSSOInfo(),{login:s,rememberMeForSSOPreference:r}=e.body;return await this.ssoUserSettingsStore.set({rememberMeForSSOPreference:r}),i.isNitroProvider?await t({userEmailAddress:s}):this.authenticationFlowInfraContext.redirectUserToExternalUrl({externalUrl:i.serviceProviderUrl,tabFocus:!0}),Promise.resolve((0,m.Vp)(void 0))}constructor(e,t,i,s){this.carbonLegacyClient=e,this.ssoUserSettingsStore=i,this.client=t,this.authenticationFlowInfraContext=s}}ty=(0,s.gn)([(0,ez.W)(eq.Hr),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._,void 0===tl.w?Object:tl.w,tg,tm])],ty);var tw=i(47890);let tS=e=>!!e&&"object"==typeof e&&(0,td.l$)(e,"type")&&"sso"===e.type;class tf{getDeviceAccessKeys(e){return this.carbonLegacyClient.queries.carbonState({path:"authentication.localUsers"}).pipe((0,$.h)(m.d6),(0,X.U)(t=>t.data[e]))}async checkSSOInfo(e){let t=(await (0,r.z)(this.getDeviceAccessKeys(e).pipe((0,X.U)(t=>this.serverApiClient.v1.authentication.getAuthenticationMethodsForLogin({login:e,deviceAccessKey:t.deviceAccessKey,methods:["email_token","totp","duo_push","dashlane_authenticator"]})),(0,tw.J)(),(0,$.h)(m.d6),(0,X.U)(e=>e.data.data)))).verifications.find(tS);if(t){let e=t.ssoInfo;return{isNitroProvider:e.isNitroProvider,serviceProviderUrl:e.serviceProviderUrl}}throw Error("No SSO authentication available for the user")}async execute(e){let{login:t}=e.body,{loginUserWithEnclaveSSO:i}=this.client.getClient(tu.y).commands;return await this.allowToFail.doOne(async()=>{let e=await this.checkSSOInfo(t);e.isNitroProvider?await i({userEmailAddress:t,tabFocus:!1}):this.authenticationFlowInfraContext.redirectUserToExternalUrl({externalUrl:e.serviceProviderUrl,tabFocus:!1})},{methodName:"InitiateAutologinWithSSOCommandHandler.execute"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e,t,i,s,r){this.allowToFail=r,this.client=t,this.carbonLegacyClient=e,this.authenticationFlowInfraContext=i,this.serverApiClient=s}}tf=(0,s.gn)([(0,ez.W)(eq.x2),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._,void 0===tl.w?Object:tl.w,tm,void 0===eE.l?Object:eE.l,void 0===l.J?Object:l.J])],tf);var tE=i(51870),tI=i(30424);class tb{getLoginFlowMigrationKillswitch(){return(0,r.z)(this.carbon.queries.carbonState({path:"device.killswitch.disableLoginFlowMigration"}).pipe((0,$.h)(m.d6),(0,X.U)(e=>e)))}async handle(e){let t=await this.getLoginFlowMigrationKillswitch(),i=!1;if("undefined"!=typeof self&&self.localStorage){let e=self.localStorage.getItem("extng.loginFlow.forceLegacyFallback");i=!!e&&"true"===e}if("success"===t.tag&&t.data||i)return this.logger.warn("Authentication flow - Ignoring carbon event due to legacy login fallback",{location:"CarbonLegacyEventHandler",method:"handle()",isKillSwitchEnabled:t,isForceLoginFlowFallbackOptionEnabled:i}),Promise.resolve();switch(e.body.eventName){case"openSessionMasterPasswordLess":this.authenticationFlow.continue({type:"CARBON_LEGACY_OPEN_SESSION_DEVICE_TO_DEVICE"});break;case"openSessionTokenSent":if(!e.body.eventData||"object"!=typeof e.body.eventData||!("login"in e.body.eventData)||"string"!=typeof e.body.eventData.login)throw Error("login not in eventData");this.authenticationFlow.continue({type:"CARBON_LEGACY_OPEN_SESSION_TOKEN_SENT",login:e.body.eventData.login});break;case"openSessionAskMasterPassword":{let e=await (0,r.z)(this.carbon.queries.getMasterPasswordAndServerKey());if((0,m.hx)(e))throw Error("Failed to get  server key from carbon");let{serverKey:t}=e.data;this.authenticationFlow.continue({type:"CARBON_LEGACY_ASK_MASTER_PASSWORD",serverKey:t})}break;case"openSessionDashlaneAuthenticator":this.authenticationFlow.continue({type:"CARBON_LEGACY_OPEN_SESSION_DASHLANE_AUTHENTICATOR"});break;case"openSessionOTPSent":case"openSessionOTPForNewDeviceRequired":this.authenticationFlow.continue({type:"CARBON_LEGACY_OPEN_SESSION_OTP_SENT",otpVerificationMode:"openSessionOTPSent"===e.body.eventName?"otp2":"otp1"});break;case"openSessionSsoRedirectionToIdpRequired":{let t=e.body.eventData,{rememberMeForSSOPreference:i}=await this.ssoUserSettingsStore.getState();this.authenticationFlow.continue({type:"CARBON_LEGACY_OPEN_SESSION_SSO_REDIRECTION_TO_IDP_REQUIRED",serviceProviderRedirectUrl:t.serviceProviderRedirectUrl,isNitroProvider:t.isNitroProvider,rememberMeForSSOPreference:i})}break;case"openSessionFailed":{let t=e.body.eventData;if("WRONG_PASSWORD"===t.errorCode)return this.authenticationFlow.continue({type:"CARBON_WRONG_PASSWORD"});return this.authenticationFlow.continue({type:"CARBON_LEGACY_ERROR",error:t.errorCode})}case"carbonLoginStatusChanged":{e.body.eventData.loggedIn||this.authenticationFlow.continue({type:"CARBON_LEGACY_LOGGED_OUT"});let t=await (0,r.z)(this.carbon.queries.getSSOMigrationInfo().pipe((0,$.h)(m.d6),(0,X.U)(e=>e.data)));await this.ssoInfos.update(e=>({...e,migrationType:t.migration}))}}return Promise.resolve()}constructor(e,t,i,s,r){this.authenticationFlow=e,this.ssoUserSettingsStore=t,this.carbon=i,this.ssoInfos=s,this.logger=r}}tb=(0,s.gn)([(0,tE.b)(tI.Dj),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL,tg,void 0===o._?Object:o._,ei,void 0===D.SX?Object:D.SX])],tb);var tA=i(88826);class tC{async handle(e){await this.checkIsMigrationNeededService.executeWithParams({login:e.body.login})}constructor(e){this.checkIsMigrationNeededService=e}}tC=(0,s.gn)([(0,tE.b)(tA.M),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eA?Object:eA])],tC);var tR=i(81433),t_=i(62506),tO=i(44810),tT=i(48194);let tF=e=>({step:"EmailStep",loginEmail:e.context.login,localAccounts:e.context.localAccounts??[],isLoading:e.matches("ValidatingEmail")&&!e.context.error,error:e.context.error?.data?.message}),tD=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:ea.E6.WaitingForTransferRequest,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,error:e.context.error}),tU=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:ea.E6.DisplayInstructions,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,error:e.context.error}),tP=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:ea.E6.LoadingPassphrase,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,error:e.context.error}),tx=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:ea.E6.DisplayPassphrase,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,passphrase:e.context.passphrase?.split(em.iy)||[],error:e.context.error}),tN=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:ea.E6.LoadingAccount,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,error:e.context.error}),tL=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:ea.E6.Error,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,error:e.context.error??ea.UY.GENERIC_ERROR}),tk=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:ea.E6.DeviceRegistered,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,error:e.context.error}),tj=e=>({step:"EmailTokenStep",localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,isLoading:e.matches({DeviceRegistration:{EmailToken:"ValidatingEmailToken"}})&&!e.context.error,error:e.context.error?.data?.message,emailToken:e.context.emailToken,isDashlaneAuthenticatorAvailable:e.context.isDashlaneAuthenticatorAvailable}),tG=e=>({step:"DashlaneAuthenticatorStep",localAccounts:e.context.localAccounts??[],isLoading:e.matches({DeviceRegistration:{DashlaneAuthenticator:"RequestingServerPush"}})&&!e.context.error,error:e.context.error?.data?.message}),tV=e=>({step:"TwoFactorAuthenticationOtpStep",localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,isLoading:e.matches({TwoFactorAuthentication:"ValidatingTwoFactorAuthenticationOtp"})&&!e.context.error,error:e.context.error?.data?.message,twoFactorAuthenticationOtpValue:e.context.twoFactorAuthenticationOtpValue,twoFactorAuthenticationOtpType:e.context.twoFactorAuthenticationOtpType}),tM=e=>({step:"WebAuthnStep",localAccounts:e.context.localAccounts??[],loginEmail:e.context.login??"",isLoading:e.matches({WebAuthn:"InitWebAuthnAuthentication"})&&!e.context.error,error:e.context.error?.data?.message}),tK=e=>({step:"SSORedirectionToIdpStep",loginEmail:e.context.login,serviceProviderRedirectUrl:e.context.serviceProviderRedirectUrl??"",isNitroProvider:e.context.isNitroProvider??!1,rememberMeForSSOPreference:e.context.rememberMeForSSOPreference,isLoading:e.matches({SSORedirectionToIdp:"InitSSOAuthentication"})&&!e.context.error,error:e.context.error?.data?.message,localAccounts:e.context.localAccounts??[]}),tW=(e,t)=>({step:"MasterPasswordStep",loginEmail:e.context.login??"",localAccounts:e.context.localAccounts??[],isLoading:(e.matches({MasterPassword:"ValidatingMasterPassword"})||e.matches({MasterPassword:"OpeningSessionWithMasterpassword"})||e.matches("MasterPasswordBasedAuthenticationDone"))&&!e.context.error,isAccountRecoveryAvailable:e.context.isAccountRecoveryAvailable,error:e.context.error?.data?.message,isAuthenticationDone:t}),tz=e=>{if(!e.context.login)throw Error("No email login");return{step:"PinCodeStep",localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,isLoading:e.matches({PinCode:"ValidatingPinCode"})&&!e.context.error,error:e.context.error?.code}},tq=e=>({step:"StartingStep",localAccounts:e.context.localAccounts??[]}),tB=e=>(0,eG.of)((0,m.Vp)(function(e){if(e.matches("Starting"))return tq(e);if(e.matches("WaitingForEmail")||e.matches("ValidatingEmail")||e.matches("CheckPinCodeAvailableForMasterPassword")||e.matches("CheckPinCodeAvailableForPasswordless"))return tF(e);if(e.matches({DeviceRegistration:{EmailToken:"SendEmailToken"}})||e.matches({DeviceRegistration:{EmailToken:"WaitingForEmailToken"}})||e.matches({DeviceRegistration:{EmailToken:"ValidatingEmailToken"}})||e.matches({DeviceRegistration:{EmailToken:"FinishingEmailToken"}}))return tj(e);if(e.matches({DeviceRegistration:{DashlaneAuthenticator:"RequestingServerPush"}})||e.matches({DeviceRegistration:{DashlaneAuthenticator:"AuthenticatorPushFailed"}})||e.matches({DeviceRegistration:{DashlaneAuthenticator:"AuthenticatorPushValidated"}}))return tG(e);if(e.matches({TwoFactorAuthentication:"WaitingForTotp"})||e.matches({TwoFactorAuthentication:"WaitingForBackupCode"})||e.matches({TwoFactorAuthentication:"ValidatingTwoFactorAuthenticationOtp"})||e.matches({TwoFactorAuthentication:"FinishingTwoFactorAuthenticationOtp"})||e.matches("CheckSessionForOtp2"))return tV(e);if(e.matches({WebAuthn:"InitWebAuthnAuthentication"})||e.matches({WebAuthn:"WebAuthnAuthenticationFailed"})||e.matches({WebAuthn:"WebAuthnAuthenticationValidated"}))return tM(e);if(e.matches("SSORedirectionToIdp"))return tK(e);if(e.matches({DeviceToDeviceAuthentication:"WaitingForTransferRequest"}))return tD(e);if(e.matches({DeviceToDeviceAuthentication:"DisplayInstructions"}))return tU(e);if(e.matches({DeviceToDeviceAuthentication:"GeneratePassphrase"}))return tP(e);if(e.matches({DeviceToDeviceAuthentication:"StartTransfer"}))return tx(e);if(e.matches({DeviceToDeviceAuthentication:"OpenSession"}))return tN(e);if(e.matches({DeviceToDeviceAuthentication:"DeviceTransferError"}))return tL(e);if(e.matches({DeviceToDeviceAuthentication:"DeviceRegistered"})||e.matches("DeviceToDeviceAuthenticationDone"))return tk(e);if(e.matches({PinCode:"WaitingForPinCode"})||e.matches({PinCode:"ValidatingPinCode"})||e.matches({PinCode:"PinCodeError"}))return tz(e);if(e.matches({MasterPassword:"CheckingAccountRecoveryStatus"})||e.matches({MasterPassword:"WaitingForMasterPassword"})||e.matches({MasterPassword:"ValidatingMasterPassword"})||e.matches({MasterPassword:"OpeningSessionWithMasterpassword"}))return tW(e);if(e.matches("MasterPasswordBasedAuthenticationDone"))return tW(e,!0);if(e.matches("PinCodeAuthenticationDone"))return tz(e);throw Error(`[Auth] - No view associated to state ${JSON.stringify(e.value)}`)}(e))),tY=e=>e.pipe((0,tT.z)(tB));var tQ=i(4944);let tH=(e,t)=>{let i=t.matches(e.value),s=(0,tQ.Z)(e.context,t.context);return i&&s};class t${execute(){return ex(this.loginMachineStore).pipe((0,$.h)(Boolean),(0,tR.x)((e,t)=>tH(e,t)),tY,(0,ej.K)((e,t)=>(this.logger.error("Error retrieving the machine view data",{location:"AuthenticationFlowQueryStatusHandler",method:"execute()",error:e}),t)))}constructor(e,t,i){this.authenticationFlow=e,this.loginMachineStore=t,this.logger=i}}t$=(0,s.gn)([(0,t_.e)(tO.DW),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eL?Object:eL,eD,void 0===D.SX?Object:D.SX])],t$);class tX{execute(){return this.ssoUserSettingsStore.state$.pipe((0,X.U)(e=>(0,m.Vp)({rememberMeForSSOPreference:e.rememberMeForSSOPreference})))}constructor(e){this.ssoUserSettingsStore=e,this.ssoUserSettingsStore=e}}tX=(0,s.gn)([(0,t_.e)(tO.Dc),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[tg])],tX);class tZ{execute(){return this.ssoProviderInfoStore.state$.pipe((0,X.U)(e=>(0,m.Vp)({serviceProviderUrl:e.serviceProviderUrl,isNitroProvider:e.isNitroProvider,migrationType:e.migrationType})))}constructor(e){this.ssoProviderInfoStore=e,this.ssoProviderInfoStore=e}}tZ=(0,s.gn)([(0,t_.e)(tO.L2),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[ei])],tZ);var tJ=i(19741);class t0{}t0=(0,s.gn)([(0,c.Y)({api:n.V,handlers:{commands:{changeLogin:e$,changeTwoFactorAuthenticationOtpType:eX,clearError:eZ,cancelDeviceTransferRequest:eJ,requestEmailTokenVerification:e2,resendEmailToken:e4,resendPushNotification:e5,sendAccountEmail:e9,sendMasterPassword:e3,submitBackupCode:e7,submitEmailToken:e8,submitTotp:te,submitPinCode:eB,switchToMasterPassword:eY,switchToDashlaneAuthenticator:tt,switchToEmailToken:ti,switchToDevicetoDeviceAuthentication:ts,switchToPinCode:eQ,retryWebAuthnAuthentication:tr,webAuthnAuthenticationFail:tn,logout:ta,lockSession:to,loginViaSSO:tc,initiateLoginWithSSO:ty,initiateAutologinWithSSO:tf},events:{...(0,c.g)(a.W,{carbonLegacy:tb}),...(0,c.g)(eH.Q,{sessionOpened:tC})},queries:{authenticationFlowStatus:t$,getSsoUserSettings:tX,getProviderInfo:tZ}},configurations:{authenticationFlowContextInfrastructure:{token:tm}},providers:[k,M,G,K,x,z,ey,...(0,d.H)(eL,{inject:[ew,eD,o._,h.c,l.J,D.SX],asyncFactory:async(e,t,i,s,n,a)=>{let o=!1,c=await (0,r.z)(s.queries.platformInfo());(0,m.d6)(c)&&(c.data.buildType===g.P.DEV||c.data.buildType===g.P.NIGHTLY)&&(o=!0);let d=new eL(e,t,o,i,n,a);return await d.prepare(),d}}),ew,H,eW,Q,Z,J,U,eA,N,j,F,W,er,L,es,en,el,P,ep,ev,eh,eg,eu.q,ec.C,em.Kp,em.Ny,(0,u.d_)(D.SX)],stores:[eD,I,tg,ei],imports:[v.n,y.i,tJ.I,p.G,w.i]})],t0)},9846:function(e,t,i){i.d(t,{z:()=>s});class s extends Error{constructor(e,t){super(e),this.code=t}}},68426:function(e,t,i){i.d(t,{R:()=>m});var s=i(21636),r=i(48035),n=i(88978),a=i(82500),o=i(83816),c=i(49247),d=i(62506),l=i(306),u=i(36884),p=i(42589),h=i(81433);class g{execute(){let e=this.carbon.queries.liveWebAuthnAuthenticationOptedIn(void 0),t=this.pinCode.queries.getCurrentUserStatus();return(0,u.a)({webAuthnQuery:e,pinCodeQuery:t}).pipe((0,p.U)(({pinCodeQuery:e,webAuthnQuery:t})=>{if((0,l.hx)(e)||(0,l.hx)(t))throw Error("failed to query");return e.data.isPinCodeEnabled||t.data}),(0,h.x)(),(0,p.U)(l.Vp))}constructor(e,t){this.carbon=e,this.pinCode=t}}g=(0,s.gn)([(0,d.e)(a._),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===c._?Object:c._,void 0===o.u?Object:o.u])],g);class m{}m=(0,s.gn)([(0,r.Y)({api:n.n,handlers:{commands:{},events:{},queries:{canLockApp:g}}})],m)},60366:function(e,t,i){i.d(t,{_:()=>U});var s=i(21636),r=i(48035),n=i(70985),a=i(22717),o=i(37368),c=i(306),d=i(70554),l=i(90385),u=i(44577),p=i(86518),h=i(49247),g=i(94190),m=i(59242),v=i(90769),y=i(649),w=i(70675);let S={tag:"InvalidTokenError"},f={tag:"NetworkError"};class E{async hasRegisteredDevice(e){let t=await (0,u.z)(this.carbon.queries.getLocalAccounts());if((0,c.hx)(t))throw Error("Failed to query carbon");return t.data.some(t=>t.login===e)}async registerDeviceWithToken(e,t,i){let s=await (0,u.z)(this.serverApiClient.v1.authentication.performExtraDeviceVerification({login:e,token:t}));if(!(0,c.d6)(s))return(0,c.Rn)(S);let{authTicket:r}=s.data.data;return this.registerDeviceWithTicket(e,r,i)}async registerDeviceWithTicket(e,t,i){var s,r,n;let a=await (0,u.z)(this.carbon.queries.getPlatformInfo());if(!(0,c.d6)(a))throw Error("Failed to get status from carbon");let o=a.data;if("server_carbon_unknown"===o.platformName)throw Error("unexpected server_carbon_unknown");let l={deviceName:(s=i??w.getDefaultDeviceName())?s.replace(/https?:\/\//g," "):s,appVersion:o.appVersion,platform:o.platformName,osCountry:(r=o.country)&&!(r.length<2)&&!(r.length>5)?r:"ZZ",osLanguage:(n=o.lang)&&!(n.length<2)&&!(n.length>5)?n:"und",temporary:!1},p=await (0,u.z)(this.serverApiClient.v1.authentication.completeDeviceRegistrationWithAuthTicket({authTicket:t,login:e,device:l}));if(!(0,c.d6)(p))return(0,d.EQ)(p.error,{BusinessError:()=>(0,y.j)("Failed to register on server"),FetchFailedError:()=>(0,c.Rn)(f),InternalServerError:()=>(0,y.j)("Failed to register on server"),InvalidRequest:()=>(0,y.j)("Failed to register on server"),RateLimited:()=>(0,y.j)("Failed to register on server"),ServiceUnavailable:()=>(0,y.j)("Failed to register on server"),UnspecifiedBadStatus:()=>(0,y.j)("Failed to register on server")});let{deviceAccessKey:h,deviceSecretKey:g,settings:m,serverKey:v}=p.data.data;return await this.registerDeviceWithKeys({deviceAccessKey:h,deviceSecretKey:g,login:e,settingsContent:m.content,serverKey:v})}async registerDeviceWithKeys({deviceAccessKey:e,deviceSecretKey:t,settingsContent:i,serverKey:s,login:r}){let n=await (0,u.z)(this.contextless.v1.account.accountInfo({deviceAccessKey:e,deviceSecretKey:t,login:r}));if(!(0,c.d6)(n))return(0,d.EQ)(n.error,{BusinessError:()=>(0,y.j)("Failed to get account infos"),FetchFailedError:()=>(0,c.Rn)(f),InternalServerError:()=>(0,y.j)("Failed to get account infos"),InvalidRequest:()=>(0,y.j)("Failed to get account infos"),RateLimited:()=>(0,y.j)("Failed to get account infos"),ServiceUnavailable:()=>(0,y.j)("Failed to get account infos"),UnspecifiedBadStatus:()=>(0,y.j)("Failed to get account infos")});let{creationDateUnix:a,publicUserId:o,deviceAnalyticsId:l,userAnalyticsId:h}=n.data.data,g=await this.carbon.commands.registerDevice({deviceAccessKey:e,deviceAnalyticsId:l??"",deviceSecretKey:t,settings:{action:"BACKUP_EDIT",backupDate:a,content:i,identifier:"SETTINGS_userId",time:a,type:"SETTINGS"},serverKey:s,publicUserId:o,userAnalyticsId:h??"",isDataPersisted:p.jP.PERSIST_DATA_YES,login:r});if((0,c.hx)(g))throw Error("Failed to register in carbon");return(0,c.Vp)(void 0)}constructor(e,t,i){this.serverApiClient=e,this.carbon=t,this.contextless=i}}E=(0,s.gn)([(0,g.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===m.l?Object:m.l,void 0===h._?Object:h._,void 0===v.B?Object:v.B])],E);let I={tag:"DeviceAlreadyRegistered"};class b{async execute({body:e}){let{login:t,ignoreAlreadyRegisteredError:i,deviceName:s}=e;if(!i&&await this.service.hasRegisteredDevice(t))return(0,c.Rn)(I);switch(e.with){case"authTicket":return this.service.registerDeviceWithTicket(t,e.authTicket,s);case"token":return(0,d.EQ)(await this.service.registerDeviceWithToken(t,e.token,s),{success:()=>(0,c.Vp)(void 0),failure:e=>(0,d.EQ)(e.error,{InvalidTokenError:e=>(0,c.Rn)(e),NetworkError:e=>(0,c.Rn)(e)})});case"deviceKeys":return await this.service.registerDeviceWithKeys({deviceAccessKey:e.deviceAccessKey,deviceSecretKey:e.deviceSecretKey,login:t,settingsContent:e.settings,serverKey:e.serverKey});default:return(0,l.U)(e)}}constructor(e){this.service=e}}b=(0,s.gn)([(0,o.W)(a.J),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===E?Object:E])],b);var A=i(4843),C=i(89600);class R{async execute(){let e=await this.carbon.commands.cleanRemotelyRemovedProfiles();if((0,c.hx)(e))throw Error("clean remotely removed profiles failed");return(0,c.Vp)(void 0)}constructor(e){this.carbon=e}}R=(0,s.gn)([(0,o.W)(C.L),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h._?Object:h._])],R);var _=i(1833),O=i(42589),T=i(62506),F=i(26284);class D{isLocalAccounts(e){if(!Array.isArray(e))return!1;if(0===e.length)return!0;let t=e[0];return"object"==typeof t&&"login"in t}isCarbonLocalAccountResult(e){return!!e&&"object"==typeof e&&"localAccounts"in e&&this.isLocalAccounts(e.localAccounts)}execute(){return(0,_.D)(this.carbon.commands.carbonLegacyLeeloo({name:"getLocalAccountsList",arg:[]})).pipe((0,O.U)(e=>{if((0,c.hx)(e))throw Error("Unable to retrieve local accounts list");let t=(0,c.db)(e).carbonResult;if(!this.isCarbonLocalAccountResult(t))throw Error("Carbon result is not of type local accounts");return(0,c.Vp)({localAccounts:t.localAccounts})}))}constructor(e){this.carbon=e}}D=(0,s.gn)([(0,T.e)(F.a),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h._?Object:h._])],D);class U{}U=(0,s.gn)([(0,r.Y)({api:n.G,imports:[A.n],handlers:{commands:{cleanRemotelyRemovedProfiles:R,registerDevice:b},events:{},queries:{localAccounts:D}},providers:[E]})],U)},52743:function(e,t,i){i.d(t,{E:()=>a,V:()=>o});var s=i(21636),r=i(2052),n=i(94190);class a{generateNonce(){return this.sodium.randombytes_buf(this.sodium.crypto_box_NONCEBYTES)}generateKeyPair(){return this.sodium.crypto_kx_keypair()}hash(e,t){return this.sodium.crypto_generichash(this.sodium.crypto_secretbox_KEYBYTES,e,t)}compare(e,t){return this.sodium.memcmp(e,t)}generateClientSharedSecret(e,t,i){return this.sodium.crypto_kx_client_session_keys(e,t,i)}generateServerSharedSecret(e,t,i){return this.sodium.crypto_kx_server_session_keys(e,t,i)}encrypt(e,t,i){return this.sodium.crypto_secretbox_easy(e,t,i)}decrypt(e,t,i){return this.sodium.crypto_secretbox_open_easy(e,t,i)}constructor(e){this.sodium=e}}function o(){return{token:a,asyncFactory:async()=>(await r.ready,new a(r))}}a=(0,s.gn)([(0,n.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[Object])],a)},91861:function(e,t,i){i.d(t,{K:()=>r,d:()=>n});var s=i(6153);let r=3;class n extends s.x{constructor(e,t){super(e),this.code=t}}},19741:function(e,t,i){i.d(t,{I:()=>ep});var s=i(21636),r=i(43530),n=i(48035),a=i(90573),o=i(70438),c=i(99481),d=i(4843),l=i(52743),u=i(39559),p=i(42589),h=i(15021),g=i(59982);let m=e=>!0;class v extends(0,g.Q)({initialValue:void 0,persist:!1,scope:h.F.Device,storeName:"trusted-device-flow-machine",storeTypeGuard:m}){}let y=async(e,t)=>{await e.set(JSON.stringify(t))},w=async e=>{let t=await e.getState();return t?u.ZM.create(JSON.parse(t)):void 0},S=e=>e.state$.pipe((0,p.U)(e=>e?u.ZM.create(JSON.parse(e)):void 0));var f=i(69334),E=i(84408),I=i(94190),b=i(23269),A=i(83833),C=i(46181),R=i(306),_=i(76793);class O{async execute(){let e=await this.d2dAuthenticationService.getKeyExchangeTransferInfo();if((0,R.hx)(e))throw Error("Error with getKeyExchangeTransferInfo");let{transferId:t,receiver:i}=e.data.transfer;return Promise.resolve({transferId:t,requestTimestamp:i.requestedAtDateUnix,untrustedDeviceName:i.deviceName,untrustedDeviceLocation:`${i.city}, ${i.countryCode}`,untrustedDeviceHashedPublicKey:i.hashedPublicKey})}constructor(e){this.d2dAuthenticationService=e}}O=(0,s.gn)([(0,I.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===_.C?Object:_.C])],O);var T=i(31422),F=i(12908);class D{async execute(e){let{privateKey:t,publicKey:i}=this.d2dCryptoService.generateKeyPair();if(!e.transferId)throw Error("No transferId in context");let s=await this.d2dAuthenticationService.startSenderKeyExchange(e.transferId,i);if((0,R.hx)(s))return Promise.reject(s.error);let{receiverPublicKey:r}=s.data,n=e.untrustedDeviceHashedPublicKey;if(!this.d2dCryptoService.verifyUntrustedDevicePublicKey(n,r))throw Error("Receiver public key doesn't match");let a=this.d2dCryptoService.generateSenderSharedSecret(i,t,r),o=await this.d2dAuthenticationService.getCurrentUserLogin();if((0,R.hx)(o)||!o.data)throw Error("No user login in context");let c=this.d2dCryptoService.generateVisualCheckSeed(o.data,e.transferId,a),{passphrase:d,missingWordIndex:l}=await this.passphraseService.generatePassphraseChallenge(c);return{sharedSecret:a,passphrase:d,passhraseMissingWordIndex:l}}constructor(e,t,i){this.d2dCryptoService=e,this.d2dAuthenticationService=t,this.passphraseService=i}}D=(0,s.gn)([(0,I.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===T.q?Object:T.q,void 0===_.C?Object:_.C,void 0===F.Kp?Object:F.Kp])],D);var U=i(91861);class P{async execute(e){if(!this.passphraseService.verifyChallenge(e.passphrase,e.passphraseGuess))throw new U.d("Passphrase incorrect",e.passphraseAttemptsLeft>1?C.S.INVALID_PASSPHRASE:C.S.PASSPHRASE_ATTEMPTS_LIMIT);let t=await this.d2dAuthenticationService.getCurrentUserLogin();if((0,R.hx)(t)||!t.data||!e.transferId)throw Error("No user login or no transferId");let i=await this.d2dAuthenticationService.getUserInvisibleMasterPassword(),s=await this.d2dAuthenticationService.requestAuthTicket();if((0,R.hx)(s))throw Error("Couldn't get authTicket");let{encryptedData:r,nonce:n}=this.d2dCryptoService.encryptInvisibleMasterPassword(t.data,s.data,i,e.transferId,e.sharedSecret),a=await this.d2dAuthenticationService.completeTransfer(r,n,e.transferId);return(0,R.hx)(a)?Promise.reject(a.error):Promise.resolve()}constructor(e,t,i){this.passphraseService=e,this.d2dCryptoService=t,this.d2dAuthenticationService=i}}P=(0,s.gn)([(0,I.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F.Kp?Object:F.Kp,void 0===T.q?Object:T.q,void 0===_.C?Object:_.C])],P);class x{create(){return(0,b.C)({predictableActionArguments:!0,schema:{events:{},context:{}},initial:"WaitingForNewDeviceTransferRequest",id:"TrustedDeviceFlowMachine",context:{transferId:void 0,untrustedDeviceName:"",untrustedDeviceHashedPublicKey:"",untrustedDeviceLocation:"",sharedSecret:"",passphrase:"",passphraseGuess:"",passphraseMissingWordIndex:-1,passphraseAttemptsLeft:U.K},states:{Idle:{on:{REFRESH_REQUEST:{target:"WaitingForNewDeviceTransferRequest"}}},WaitingForNewDeviceTransferRequest:{invoke:{src:"getPendingDeviceTransferRequest",onDone:[{actions:["assignUntrustedDeviceData"],cond:"isDeviceTransferRequestAvailable",target:"NewDeviceTransferRequest"},{target:"Idle"}],onError:{actions:["assignTrustedDeviceFlowError"],target:"Idle"}}},NewDeviceTransferRequest:{on:{APPROVE_REQUEST:{target:"HandlingDeviceTransferRequest"},REJECT_REQUEST:{actions:["clearContext"],target:"DeviceTransferRejected"},RETURN_TO_DEVICE_SETUP:{actions:["clearContext"],target:"Idle"}}},HandlingDeviceTransferRequest:{invoke:{src:"approveDeviceTransferRequest",onDone:{actions:["assignPassphraseChallengeData"],target:"DisplayPassphraseChallenge"},onError:{actions:["assignTrustedDeviceFlowError"],target:"DeviceTransferFailed"}}},DisplayPassphraseChallenge:{on:{SUBMIT_PASSPHRASE_CHALLENGE:{actions:["assignPassphraseGuess","clearError"],target:"VerifyingPassphraseChallenge"},CANCEL_REQUEST:{actions:["clearContext"],target:"Idle"}}},VerifyingPassphraseChallenge:{invoke:{src:"verifyPassphraseChallenge",onDone:{target:"DeviceTransferComplete"},onError:[{actions:["assignTrustedDeviceFlowError","updatePassphraseAttempts"],target:"DisplayPassphraseChallenge",cond:"isInvalidPassphraseError"},{actions:["assignTrustedDeviceFlowError","updatePassphraseAttempts"],target:"DeviceTransferFailed"}]}},DeviceTransferComplete:{on:{RETURN_TO_DEVICE_SETUP:{actions:["clearContext"],target:"Idle"}}},DeviceTransferRejected:{on:{RETURN_TO_DEVICE_SETUP:{target:"Idle"}}},DeviceTransferFailed:{on:{RETURN_TO_DEVICE_SETUP:{actions:["clearContext"],target:"Idle"}}}}},{actions:{assignUntrustedDeviceData:(0,A.f0)({transferId:(e,t)=>t.data.transferId,untrustedDeviceName:(e,t)=>t.data.untrustedDeviceName,untrustedDeviceHashedPublicKey:(e,t)=>t.data.untrustedDeviceHashedPublicKey,untrustedDeviceLocation:(e,t)=>t.data.untrustedDeviceLocation,requestTimestamp:(e,t)=>t.data.requestTimestamp}),clearContext:(0,A.f0)({transferId:()=>void 0,untrustedDeviceName:()=>"",untrustedDeviceHashedPublicKey:()=>"",untrustedDeviceLocation:()=>"",sharedSecret:()=>"",passphrase:()=>"",passphraseGuess:()=>"",passphraseMissingWordIndex:()=>-1,passphraseAttemptsLeft:()=>U.K,error:()=>void 0}),clearError:(0,A.f0)({error:()=>void 0}),assignTrustedDeviceFlowError:(0,A.f0)({error:(e,t)=>t.data instanceof U.d?t.data.code:C.S.GENERIC_ERROR}),assignPassphraseChallengeData:(0,A.f0)({sharedSecret:(e,t)=>t.data.sharedSecret,passphrase:(e,t)=>t.data.passphrase,passphraseMissingWordIndex:(e,t)=>t.data.passhraseMissingWordIndex}),assignPassphraseGuess:(0,A.f0)({passphraseGuess:(e,t)=>t.passphraseChallenge}),updatePassphraseAttempts:(0,A.f0)({passphraseAttemptsLeft:(e,t)=>t.data instanceof U.d&&t.data.code===C.S.INVALID_PASSPHRASE?e.passphraseAttemptsLeft-1:e.passphraseAttemptsLeft})},services:{getPendingDeviceTransferRequest:()=>this.getPendingDeviceTransferRequestService.execute(),approveDeviceTransferRequest:e=>this.approveDeviceTransferRequestService.execute(e),verifyPassphraseChallenge:e=>this.verifyPassphraseChallengeService.execute(e)},guards:{isDeviceTransferRequestAvailable:(e,t)=>!!t.data.transferId,isInvalidPassphraseError:(e,t)=>t.data instanceof U.d&&"INVALID_PASSPHRASE"===t.data.code}})}constructor(e,t,i){this.getPendingDeviceTransferRequestService=e,this.approveDeviceTransferRequestService=t,this.verifyPassphraseChallengeService=i}}x=(0,s.gn)([(0,I.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===O?Object:O,void 0===D?Object:D,void 0===P?Object:P])],x);var N=i(19444);class L{async prepare(){if(this.interpreter)try{let e=await w(this.trustedDeviceMachineStore);try{this.interpreter.start(e)}catch(e){this.logger.error("D2D Trusted Device Flow - Unable to reuse the stored state",{location:"TrustedDeviceFlow",method:"prepare()",error:e}),this.interpreter.start()}}catch(e){this.logger.error("D2D Trusted Device Flow - Unable to start machine",{location:"TrustedDeviceFlow",method:"prepare()",error:e})}}ready(){return new E.X(!0)}continue(e){if(!this.interpreter)throw Error("TrustedDevice flow not started");this.interpreter.send(e)}stop(){this.isStarted()&&(this.interpreter=void 0)}isStarted(){return!!this.interpreter}constructor(e,t,i){this.trustedDeviceMachineStore=t,this.logger=i;let s=e.create();this.interpreter=f.kJ(s).onTransition(async e=>{e.changed||"xstate.init"===e.event.type||this.logger.warn(`D2D Trusted Device Flow - State is unchanged, unexpected transition with event ${e.event.type}`,{location:"TrustedDeviceFlow",method:"interpreter.onTransition()",event:e});try{let e=this.interpreter?.getSnapshot();e&&await y(this.trustedDeviceMachineStore,e)}catch(e){this.logger.error("D2D Trusted Device Flow - Unable to get snapshot",{location:"TrustedDeviceFlow",method:"interpreter.onTransition()",error:e})}})}}L=(0,s.gn)([(0,I.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===x?Object:x,v,void 0===N.SX?Object:N.SX])],L);var k=i(37368),j=i(28511);class G{execute(){return this.trustedDeviceFlow.continue({type:"APPROVE_REQUEST"}),Promise.resolve((0,R.Vp)(void 0))}constructor(e){this.trustedDeviceFlow=e,this.trustedDeviceFlow=e}}G=(0,s.gn)([(0,k.W)(j.G),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L?Object:L])],G);var V=i(42229);class M{execute(){return this.trustedDeviceFlow.continue({type:"REFRESH_REQUEST"}),Promise.resolve((0,R.Vp)(void 0))}constructor(e){this.trustedDeviceFlow=e,this.trustedDeviceFlow=e}}M=(0,s.gn)([(0,k.W)(V.V),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L?Object:L])],M);var K=i(1776);class W{execute(){return this.trustedDeviceFlow.continue({type:"REJECT_REQUEST"}),Promise.resolve((0,R.Vp)(void 0))}constructor(e){this.trustedDeviceFlow=e,this.trustedDeviceFlow=e}}W=(0,s.gn)([(0,k.W)(K.a),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L?Object:L])],W);var z=i(70285);class q{execute(){return this.trustedDeviceFlow.continue({type:"CANCEL_REQUEST"}),Promise.resolve((0,R.Vp)(void 0))}constructor(e){this.trustedDeviceFlow=e,this.trustedDeviceFlow=e}}q=(0,s.gn)([(0,k.W)(z.b),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L?Object:L])],q);var B=i(46313);class Y{execute(e){let{passphraseChallenge:t}=e.body;return this.trustedDeviceFlow.continue({type:"SUBMIT_PASSPHRASE_CHALLENGE",passphraseChallenge:t}),Promise.resolve((0,R.Vp)(void 0))}constructor(e){this.trustedDeviceFlow=e,this.trustedDeviceFlow=e}}Y=(0,s.gn)([(0,k.W)(B.I),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L?Object:L])],Y);var Q=i(86565);class H{execute(){return this.trustedDeviceFlow.continue({type:"RETURN_TO_DEVICE_SETUP"}),Promise.resolve((0,R.Vp)(void 0))}constructor(e){this.trustedDeviceFlow=e,this.trustedDeviceFlow=e}}H=(0,s.gn)([(0,k.W)(Q.n),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L?Object:L])],H);var $=i(72907),X=i(10096),Z=i(30545),J=i(36884),ee=i(72233),et=i(56144),ei=i(81433),es=i(4944),er=i(62506),en=i(74859),ea=i(69853),eo=i(48194),ec=i(70875);let ed=e=>(0,ea.of)((0,R.Vp)(function(e){if(e.matches("Idle")||e.matches("WaitingForNewDeviceTransferRequest"))return{step:C.T.WaitingForNewDeviceRequest};if(e.matches("NewDeviceTransferRequest"))return 0>=(0,ec.Xn)(e.context.requestTimestamp)?{step:C.T.Error,errorCode:C.S.TIMEOUT}:{step:C.T.NewDeviceRequestAvailable,untrustedDeviceName:e.context.untrustedDeviceName,untrustedDeviceLocation:e.context.untrustedDeviceLocation,requestTimestamp:e.context.requestTimestamp};if(e.matches("HandlingDeviceTransferRequest"))return{step:C.T.LoadingChallenge};if(e.matches("DisplayPassphraseChallenge")||e.matches("VerifyingPassphraseChallenge")){let{passphrase:t,passphraseMissingWordIndex:i,untrustedDeviceName:s,error:r}=e.context,n=t.split(F.iy).map((e,t)=>t===i?"":e);return{step:C.T.DisplayPassphraseChallenge,untrustedDeviceName:s,passphrase:n,error:r}}if(e.matches("DeviceTransferComplete"))return{step:C.T.DeviceTransferComplete,untrustedDeviceName:e.context.untrustedDeviceName};if(e.matches("DeviceTransferRejected"))return{step:C.T.DeviceTransferRejected,untrustedDeviceName:e.context.untrustedDeviceName};if(e.matches("DeviceTransferFailed"))return{step:C.T.Error,errorCode:e.context.error};throw Error("[D2D Trusted Device] - No view associated to state")}(e))),el=e=>e.pipe((0,eo.z)(ed));class eu{execute(){let e=S(this.trustedDeviceFlowMachineStore).pipe((0,et.h)(Boolean),(0,p.U)(e=>e.context.requestTimestamp?(0,ec.Xn)(e.context.requestTimestamp):0)).pipe((0,$.w)(e=>(0,X.H)(e)),(0,Z.O)(0));return(0,J.a)([S(this.trustedDeviceFlowMachineStore),this.trustedDeviceFlow.ready(),e],(e,t,i)=>{if(e&&t)return e}).pipe((0,et.h)(Boolean),el,(0,ei.x)((e,t)=>(0,es.Z)(e,t)),(0,ee.K)((e,t)=>(this.logger.error("Error retrieving D2D data",{location:"TrustedDeviceFlowStatusQueryHandler",method:"execute()",error:e}),t)))}constructor(e,t,i){this.trustedDeviceFlow=e,this.trustedDeviceFlowMachineStore=t,this.logger=i}}eu=(0,s.gn)([(0,er.e)(en.N),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L?Object:L,v,void 0===N.SX?Object:N.SX])],eu);class ep{}ep=(0,s.gn)([(0,n.Y)({api:r.F,stores:[v],imports:[d.n,a.G],exports:[T.q,l.E],providers:[(0,l.V)(),...(0,o.H)(L,{inject:[x,v,N.SX],asyncFactory:async(e,t,i)=>{let s=new L(e,t,i);return await s.prepare(),s}}),l.E,F.Kp,T.q,_.C,O,D,P,x,F.Ny,(0,c.d_)(N.SX)],handlers:{commands:{approveRequest:G,refreshRequest:M,rejectRequest:W,cancelRequest:q,submitPassphraseChallenge:Y,returnToDeviceSetup:H},events:{},queries:{trustedDeviceFlowStatus:eu}}})],ep)},76793:function(e,t,i){i.d(t,{C:()=>E});var s=i(21636),r=i(44577),n=i(70675),a=i(86518),o=i(49247),c=i(59242),d=i(27472),l=i(94190),u=i(17741),p=i(306),h=i(70554),g=i(649),m=i(19855),v=i(81544),y=i(46181),w=i(70875),S=i(9846),f=i(91861);class E{async getCurrentUserLogin(){return await (0,r.z)(this.sessionClient.queries.selectedOpenedSession().pipe((0,u.DZ)(()=>(0,p.Rn)(Error("No user login found"))),(0,u.lk)(e=>(0,p.Vp)(e))))}getUserInvisibleMasterPassword(){let{carbonState:e}=this.carbon.queries;return(0,r.z)(e({path:"userSession.session.masterPassword"}).pipe((0,u.nb)({success:e=>e,failure:()=>{throw Error("Failure getting user invisible master password info")}})))}async requestAuthTicket(){return await (0,r.z)(this.serverApiClient.v1.authentication.requestExtraDeviceRegistration({tokenType:"googleAccountNewDevice"}).pipe((0,u.DZ)(e=>(0,h.EQ)(e,{BusinessError:()=>(0,p.Rn)(e),FetchFailedError:()=>(0,p.Rn)(e),UnspecifiedBadStatus:()=>(0,p.Rn)(e),InternalServerError:g.j,InvalidRequest:g.j,RateLimited:g.j,ServiceUnavailable:g.j})),(0,u.lk)(e=>(0,p.Vp)(e.data.token))))}async getKeyExchangeTransferInfo(){return await (0,r.z)(this.serverApiClient.v1.secretTransfer.getKeyExchangeTransferInfo({}).pipe((0,u.DZ)(e=>(0,h.EQ)(e,{BusinessError:()=>(0,p.Rn)(e),FetchFailedError:()=>(0,p.Rn)(e),UnspecifiedBadStatus:()=>(0,p.Rn)(e),InternalServerError:g.j,InvalidRequest:g.j,RateLimited:g.j,ServiceUnavailable:g.j})),(0,u.lk)(e=>(0,p.Vp)(e.data))))}async startReceiverKeyExchange(e,t){return await (0,r.z)(this.serverApiClient.v1.secretTransfer.startReceiverKeyExchange({transferId:e,receiverHashedPublicKey:t},{timeout:6e4}).pipe((0,u.DZ)(e=>(0,h.EQ)(e,{BusinessError:g.j,FetchFailedError:()=>{throw new S.z("User offline or request timeout",v.UY.TIMEOUT)},UnspecifiedBadStatus:({response:t})=>{if(t.status===d.W.GatewayTimeout)return new S.z("Request has timed out",v.UY.TIMEOUT);(0,g.j)(e)},InternalServerError:g.j,InvalidRequest:g.j,RateLimited:g.j,ServiceUnavailable:g.j})),(0,u.lk)(e=>(0,p.Vp)(e.data))))}async completeKeyExchange(e,t){return await (0,r.z)(this.serverApiClient.v1.secretTransfer.completeKeyExchange({receiverPublicKey:t,transferId:e}).pipe((0,u.DZ)(e=>(0,h.EQ)(e,{BusinessError:()=>(0,p.Rn)(e),FetchFailedError:()=>(0,p.Rn)(e),UnspecifiedBadStatus:()=>(0,p.Rn)(e),InternalServerError:g.j,InvalidRequest:g.j,RateLimited:g.j,ServiceUnavailable:g.j})),(0,u.lk)(e=>(0,p.Vp)(e.data))))}async startTransfer(e){return await (0,r.z)(this.serverApiClient.v1.secretTransfer.startTransfer({transferId:e,transferType:"universal"},{timeout:6e4}).pipe((0,u.DZ)(e=>(0,h.EQ)(e,{BusinessError:g.j,FetchFailedError:g.j,UnspecifiedBadStatus:({response:t})=>t.status===d.W.GatewayTimeout?new S.z("Request has timed out",v.UY.TIMEOUT):(0,g.j)(e),InternalServerError:g.j,InvalidRequest:g.j,RateLimited:g.j,ServiceUnavailable:g.j})),(0,u.lk)(e=>(0,p.Vp)(e.data))))}async requestTransfer(e,t){return await (0,r.z)(this.serverApiClient.v1.secretTransfer.requestTransfer({transfer:{login:e,receiverDeviceName:t,transferType:"universal"}}).pipe((0,u.DZ)(e=>(0,h.EQ)(e,{BusinessError:()=>{throw Error("[D2D]: Business Error")},FetchFailedError:()=>{throw Error("[D2D]: Network error")},UnspecifiedBadStatus:g.j,InternalServerError:g.j,InvalidRequest:g.j,RateLimited:g.j,ServiceUnavailable:g.j})),(0,u.lk)(e=>(0,p.Vp)(e.data))))}async startSenderKeyExchange(e,t){return await (0,r.z)(this.serverApiClient.v1.secretTransfer.startSenderKeyExchange({transferId:e,senderPublicKey:t},{timeout:6e4}).pipe((0,u.DZ)(e=>(0,h.EQ)(e,{BusinessError:e=>{if("TRANSFER_DOES_NOT_EXISTS"===e.code)throw new f.d("Transfer request has expired",y.S.TIMEOUT);throw Error("[D2D]: Business Error")},FetchFailedError:()=>{throw Error("[D2D]: Network error")},UnspecifiedBadStatus:({response:e})=>{if(e.status===d.W.GatewayTimeout)return new f.d("Request has timed out",y.S.TIMEOUT);throw Error("[D2D]: Bad status error")},InternalServerError:g.j,InvalidRequest:g.j,RateLimited:g.j,ServiceUnavailable:g.j})),(0,u.lk)(e=>(0,p.Vp)(e.data))))}async completeTransfer(e,t,i){return await (0,r.z)(this.serverApiClient.v1.secretTransfer.completeTransfer({transfer:{encryptedData:e,nonce:t,transferId:i,transferType:"universal"}}).pipe((0,u.DZ)(e=>(0,h.EQ)(e,{BusinessError:e=>{if("TRANSFER_DOES_NOT_EXISTS"===e.error.code)return new f.d("Request timed out",y.S.TIMEOUT);throw Error("[D2D]: Business Error")},FetchFailedError:()=>{throw Error("[D2D]: Network error")},UnspecifiedBadStatus:g.j,InternalServerError:g.j,InvalidRequest:g.j,RateLimited:g.j,ServiceUnavailable:g.j})),(0,u.lk)(e=>(0,p.Vp)(e.data))))}async openSession(e,t,i,s){let o=await (0,r.z)(this.serverApiClient.v1.authentication.performExtraDeviceVerification({login:e,token:t}));if(!(0,p.d6)(o))throw new S.z("Perform extra device verification failed",v.UY.ACCOUNT_ERROR);let{authTicket:c}=o.data.data,d=await (0,r.z)(this.carbon.queries.getPlatformInfo());if(!(0,p.d6)(d))throw new S.z("No platform info available",v.UY.ACCOUNT_ERROR);let l=d.data,u={deviceName:(0,w.$f)(s||n.getDefaultDeviceName()),appVersion:l.appVersion,platform:l.platformName,osCountry:(0,w.Yb)(l.country),osLanguage:(0,w._$)(l.lang),temporary:!1},h=await (0,r.z)(this.serverApiClient.v1.authentication.completeDeviceRegistrationWithAuthTicket({authTicket:c,login:e,device:u}));if(!(0,p.d6)(h))throw new S.z("Device registration with authTicket failed",v.UY.ACCOUNT_ERROR);let{deviceAccessKey:g,deviceAnalyticsId:m,deviceSecretKey:y,settings:f,serverKey:E,publicUserId:I,userAnalyticsId:b}=h.data.data;await this.carbon.commands.registerDevice({deviceAccessKey:g,deviceAnalyticsId:m,deviceSecretKey:y,settings:f,serverKey:E,publicUserId:I,userAnalyticsId:b,isDataPersisted:a.jP.PERSIST_DATA_YES,login:e});let A=await this.carbon.commands.openSessionWithMasterPassword({login:e,password:i,rememberPassword:!0,requiredPermissions:void 0,serverKey:"",loginType:"DeviceToDevice"});if(!(0,p.d6)(A))throw new S.z("Open session with deciphered password failed",v.UY.ACCOUNT_ERROR)}constructor(e,t,i){this.serverApiClient=e,this.sessionClient=t,this.carbon=i}}E=(0,s.gn)([(0,l.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===c.l?Object:c.l,void 0===m.x?Object:m.x,void 0===o._?Object:o._])],E)},31422:function(e,t,i){i.d(t,{q:()=>c});var s=i(21636),r=i(83267),n=i(94190),a=i(52743),o=i(70875);class c{verifyUntrustedDevicePublicKey(e,t){return this.cryptoToolboxService.compare((0,o.tp)(e),(0,o.tp)(this.hash(t)))}generateReceiverSharedSecret(e,t,i){return(0,r.s)(this.cryptoToolboxService.generateClientSharedSecret((0,o.tp)(e),(0,o.tp)(t),(0,o.tp)(i)).sharedRx)}generateSenderSharedSecret(e,t,i){return(0,r.s)(this.cryptoToolboxService.generateServerSharedSecret((0,o.tp)(e),(0,o.tp)(t),(0,o.tp)(i)).sharedTx)}generateSymmetricKey(e,t,i){return(0,r.s)(this.cryptoToolboxService.hash(new TextEncoder().encode(`DASHLANE_D2D_SYMMETRIC_KEY${e.length}${e}${t}`),(0,o.tp)(i)))}hash(e){return(0,r.s)(this.cryptoToolboxService.hash((0,o.tp)(e)))}generateKeyPair(){let e=this.cryptoToolboxService.generateKeyPair();return{publicKey:(0,r.s)(e.publicKey),privateKey:(0,r.s)(e.privateKey)}}generateVisualCheckSeed(e,t,i){return(0,r.s)(this.cryptoToolboxService.hash(new TextEncoder().encode(`DASHLANE_D2D_SAS_SEED${e.length}${e}${t}`),(0,o.tp)(i)))}encryptInvisibleMasterPassword(e,t,i,s,n){let a;let c=(a={login:e,key:{type:"invisible_master_password",value:i},token:t,version:1},new TextEncoder().encode(JSON.stringify(a))),d=this.generateSymmetricKey(e,s,n),l=this.cryptoToolboxService.generateNonce(),u=this.cryptoToolboxService.encrypt(c,l,(0,o.tp)(d));return{encryptedData:(0,r.s)(u),nonce:(0,r.s)(l)}}decryptInvisibleMasterPassword(e,t,i){let s=this.cryptoToolboxService.decrypt((0,o.tp)(e),(0,o.tp)(t),(0,o.tp)(i));return JSON.parse(new TextDecoder("utf-8").decode(s))}constructor(e){this.cryptoToolboxService=e}}c=(0,s.gn)([(0,n.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===a.E?Object:a.E])],c)},12908:function(e,t,i){i.d(t,{Kp:()=>l,Ny:()=>d,iy:()=>c});var s=i(21636),r=i(49594),n=i(94190),a=i(75264),o=i(70875);let c=" ";class d extends r.K{loadResource(e){if(!e||!Array.isArray(e))throw Error("Failed to load word list");return e}constructor(e){super("assets/eff_large_wordlist.json",e)}}d=(0,s.gn)([(0,n.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===a.X?Object:a.X])],d);class l{getWordList(){return this.fetcher.get()}async generatePassphraseChallenge(e){let t=await this.getWordList(),i=[],s=Math.floor(0xffffffff/t.length)*t.length;for(let r=0;r<e.length;r+=4){let{buffer:n,byteOffset:a}=new Uint8Array((0,o.tp)(e).slice(r,r+4)),c=new DataView(n).getUint32(a,!0);if(c<s){let e=t[c%t.length];i.push(e)}if(5===i.length)break}return{passphrase:i.join(c),missingWordIndex:Math.floor(5*Math.random())}}verifyChallenge(e,t){if(!e)throw Error("[DEVICE-TRANSFER]: Passphrase challenge not generated yet");if(!t)throw Error("[DEVICE-TRANSFER]: Passphrase guess not saved to machine context");return e===t}constructor(e){this.fetcher=e}}l=(0,s.gn)([(0,n.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===d?Object:d])],l)},70875:function(e,t,i){i.d(t,{$f:()=>c,Xn:()=>r,Yb:()=>a,_$:()=>o,tp:()=>n});var s=i(97702);let r=e=>1e3*e+6e4-Date.now(),n=e=>new Uint8Array((0,s.R)(e));function a(e){return!e||e.length<2||e.length>5?"ZZ":e}function o(e){return!e||e.length<2||e.length>5?"und":e}function c(e){return e?e.replace(/https?:\/\//g," "):e}},26179:function(e,t,i){i.d(t,{f:()=>eq});var s,r,n,a,o,c=i(21636),d=i(48035),l=i(70438),u=i(99481),p=i(90573),h=i(4843),g=i(77878),m=i(94190),v=i(83833),y=i(23269),w=i(44577),S=i(59242),f=i(17741),E=i(70554),I=i(90385),b=i(649),A=i(306),C=i(96272),R=((s={}).VERIFICATION_FAILED="verification_failed",s.VERIFICATION_TIMEOUT="verification_timeout",s.VERIFICATION_REQUIRES_REQUEST="verification_requires_request",s.ACCOUNT_BLOCKED_CONTACT_SUPPORT="account_blocked_contact_support",s.INVALID_OTP_ALREADY_USED="invalid_otp_already_used",s.INVALID_OTP_BLOCKED="invalid_otp_blocked",s);class _ extends(0,C.Hu)("verification_failed",""){}class O extends(0,C.Hu)("verification_timeout",""){}class T extends(0,C.Hu)("verification_requires_request",""){}class F extends(0,C.Hu)("account_blocked_contact_support",""){}class D extends(0,C.Hu)("invalid_otp_already_used",""){}class U extends(0,C.Hu)("invalid_otp_blocked",""){}class P extends(0,C.Hu)("network_error",""){}var x=((r={}).TOKEN_NOT_VALID="TOKEN_NOT_VALID",r.TOKEN_EXPIRED="TOKEN_EXPIRED",r.TOKEN_TOO_MANY_ATTEMPTS="TOKEN_TOO_MANY_ATTEMPTS",r.TOKEN_ACCOUNT_LOCKED="TOKEN_ACCOUNT_LOCKED",r),N=((n={}).OTP_NOT_VALID="OTP_NOT_VALID",n.OTP_TOO_MANY_ATTEMPTS="OTP_TOO_MANY_ATTEMPTS",n.OTP_ALREADY_USED="OTP_ALREADY_USED",n.BACKUP_CODE_NOT_VALID="BACKUP_CODE_NOT_VALID",n),L=((a={}).DASHLANE_AUTHENTICATOR_PUSH_NOTIFICATION_DENIED="DASHLANE_AUTHENTICATOR_PUSH_NOTIFICATION_DENIED",a.TOKEN_EXPIRED="TOKEN_EXPIRED",a),k=((o={}).NETWORK_ERROR="NETWORK_ERROR",o.UNKNOWN_ERROR="UNKNOWN_ERROR",o);class j{async performEmailTokenVerification(e,t){return await (0,w.z)(this.serverApiClient.v1.authentication.performEmailTokenVerification({login:e,token:t}).pipe((0,f.DZ)(e=>(0,E.EQ)(e,{BusinessError:e=>{switch(e.code){case R.VERIFICATION_FAILED:return new _;case R.VERIFICATION_TIMEOUT:return new O;case R.VERIFICATION_REQUIRES_REQUEST:return new T;case R.ACCOUNT_BLOCKED_CONTACT_SUPPORT:return new F;default:(0,I.U)(e.code)}},FetchFailedError:()=>new P,UnspecifiedBadStatus:b.j,InternalServerError:b.j,InvalidRequest:b.j,RateLimited:b.j,ServiceUnavailable:b.j})),(0,f.lk)(e=>(0,A.Vp)(e.data.authTicket))))}async performTotpVerification(e,t){return await (0,w.z)(this.serverApiClient.v1.authentication.performTotpVerification({login:e,otp:t}).pipe((0,f.DZ)(e=>(0,E.EQ)(e,{BusinessError:e=>{switch(e.code){case R.VERIFICATION_FAILED:return new _;case R.INVALID_OTP_ALREADY_USED:return new D;case R.INVALID_OTP_BLOCKED:return new U;default:(0,I.U)(e.code)}},FetchFailedError:()=>new P,UnspecifiedBadStatus:b.j,InternalServerError:b.j,InvalidRequest:b.j,RateLimited:b.j,ServiceUnavailable:b.j})),(0,f.lk)(e=>(0,A.Vp)(e.data.authTicket))))}async performDashlaneAuthenticatorValidation(e,t){return await (0,w.z)(this.serverApiClient.v1.authentication.performDashlaneAuthenticatorVerification({login:e,deviceName:t}).pipe((0,f.DZ)(e=>(0,E.EQ)(e,{BusinessError:e=>{switch(e.code){case R.VERIFICATION_FAILED:return new _;case R.VERIFICATION_TIMEOUT:return new O;default:(0,I.U)(e.code)}},FetchFailedError:()=>new P,UnspecifiedBadStatus:b.j,InternalServerError:b.j,InvalidRequest:b.j,RateLimited:b.j,ServiceUnavailable:b.j})),(0,f.lk)(e=>(0,A.Vp)(e.data.authTicket))))}constructor(e){this.serverApiClient=e}}j=(0,c.gn)([(0,m.GS)(),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===S.l?Object:S.l])],j);var G=i(17507);class V extends G.f{}V=(0,c.gn)([(0,m.GS)()],V);class M{mapFunctionalErrorToErrorCode(e){switch(e.tag){case R.VERIFICATION_FAILED:return L.DASHLANE_AUTHENTICATOR_PUSH_NOTIFICATION_DENIED;case R.VERIFICATION_TIMEOUT:return L.TOKEN_EXPIRED;default:return k.UNKNOWN_ERROR}}async execute({login:e}){if(!e)throw Error("Something went wrong");let t=await this.identityVerificationService.performDashlaneAuthenticatorValidation(e,"");return(0,A.hx)(t)?Promise.reject(this.mapFunctionalErrorToErrorCode(t.error)):(this.eventEmitter.sendEvent("identityVerificationCompleted",{authTicket:t.data}),Promise.resolve())}constructor(e,t){this.identityVerificationService=e,this.eventEmitter=t}}M=(0,c.gn)([(0,m.GS)(),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===j?Object:j,void 0===V?Object:V])],M);var K=i(11396),W=i(4772);class z{async execute({login:e}){if(e){let t=await this.authenticationFlowClient.commands.requestEmailTokenVerification({login:e});if((0,A.hx)(t))return Promise.reject(t.error)}Promise.resolve(void 0)}constructor(e,t){this.identityVerificationService=e,this.authenticationFlowClient=t,this.identityVerificationService=e,this.authenticationFlowClient=t}}z=(0,c.gn)([(0,m.GS)(),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===j?Object:j,void 0===K||void 0===W.e?Object:W.e])],z);class q{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"AuthenticatorMachine",context:{isDashlaneAuthenticatorAvailable:!1},initial:"RequestingServerPush",states:{RequestingServerPush:{entry:["updateDashlaneAuthenticatorAvailability"],invoke:{src:"authenticateWithDashlaneAuthenticator",onDone:{target:"AuthenticatorPushValidated"},onError:{actions:["assignError","updateDashlaneAuthenticatorAvailability"]}},on:{RESEND_PUSH_NOTIFICATION:{target:"RequestingServerPush",actions:["clearError"]},SWITCH_TO_EMAIL_TOKEN:{actions:["clearError"],target:"EmailTokenRequested"}}},AuthenticatorPushValidated:{type:"final",data:{switchToEmailToken:!1}},EmailTokenRequested:{entry:["sendEmailToken"],type:"final",data:{switchToEmailToken:!0}}}},options:{actions:{clearError:(0,v.f0)({error:()=>void 0}),assignError:(0,v.f0)({error:(e,t)=>t.data}),switchToEmailToken:(0,v.f0)({switchToEmailToken:()=>!0}),updateDashlaneAuthenticatorAvailability:(0,v.f0)({isDashlaneAuthenticatorAvailable:!0}),sendEmailToken:e=>{let{login:t}=e;this.sendEmailToken.execute({login:t})}},services:{authenticateWithDashlaneAuthenticator:e=>{let{login:t}=e;return this.dashlaneAuthenticatorService.execute({login:t})}},guards:{}}}}create(){let{config:e,options:t}=this.desc();return(0,y.C)(e,t)}constructor(e,t){this.dashlaneAuthenticatorService=e,this.sendEmailToken=t}}q=(0,c.gn)([(0,m.GS)(),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===M?Object:M,void 0===z?Object:z])],q);let B=/^\d{6}$/;class Y{mapFunctionalErrorToErrorCode(e){switch(e.tag){case R.VERIFICATION_FAILED:return x.TOKEN_NOT_VALID;case R.VERIFICATION_TIMEOUT:return x.TOKEN_EXPIRED;case R.VERIFICATION_REQUIRES_REQUEST:return x.TOKEN_TOO_MANY_ATTEMPTS;case R.ACCOUNT_BLOCKED_CONTACT_SUPPORT:return x.TOKEN_ACCOUNT_LOCKED;default:return k.UNKNOWN_ERROR}}async executeWithParams(e){if(!e.login||!e.emailToken||0===e.emailToken.length||!B.test(e.emailToken))return Promise.reject(k.UNKNOWN_ERROR);let t=await this.identityVerificationService.performEmailTokenVerification(e.login,e.emailToken);if((0,A.hx)(t))return Promise.reject(this.mapFunctionalErrorToErrorCode(t.error));let i=t.data;return this.eventEmitter.sendEvent("identityVerificationCompleted",{authTicket:i}),Promise.resolve()}constructor(e,t){this.identityVerificationService=e,this.eventEmitter=t}}Y=(0,c.gn)([(0,m.GS)(),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===j?Object:j,void 0===V?Object:V])],Y);class Q{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"EmailTokenMachine",context:{login:"",emailToken:"",deviceName:""},initial:"SendEmailToken",states:{SendEmailToken:{invoke:{src:"sendEmailToken",onError:{target:"WaitingForEmailToken"},onDone:{target:"WaitingForEmailToken"}}},WaitingForEmailToken:{on:{INPUT_EMAIL_TOKEN:{target:"ValidatingEmailToken",actions:["assignEmailToken"]},RESEND_EMAIL_TOKEN:{target:"SendEmailToken",actions:["clearError"]}}},ValidatingEmailToken:{invoke:{src:"authenticateWithEmailToken",onDone:{target:"FinishingEmailToken"},onError:{target:"WaitingForEmailToken",actions:["assignError"]}}},FinishingEmailToken:{type:"final",data:{switchToDashlaneAuthenticator:!1}},DashlaneAuthenticatorRequested:{type:"final",data:{switchToDashlaneAuthenticator:!0}}},on:{SWITCH_TO_DASHLANE_AUTHENTICATOR:{target:".DashlaneAuthenticatorRequested",internal:!0,actions:["clearError"]}}},options:{actions:{assignError:(0,v.f0)({error:(e,t)=>t.data}),clearError:(0,v.f0)({error:()=>void 0}),assignEmailToken:(0,v.f0)({emailToken:(e,t)=>t.emailToken})},services:{sendEmailToken:e=>{let{login:t}=e;return this.sendEmailToken.execute({login:t})},authenticateWithEmailToken:e=>{let{deviceName:t,emailToken:i,login:s}=e;return this.authenticateWithEmailToken.executeWithParams({deviceName:t,emailToken:i,login:s})}},guards:{}}}}create(){let{config:e,options:t}=this.desc();return(0,y.C)(e,t)}constructor(e,t){this.authenticateWithEmailToken=e,this.sendEmailToken=t}}Q=(0,c.gn)([(0,m.GS)(),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===Y?Object:Y,void 0===z?Object:z])],Q);let H=e=>({initial:e.initial,states:e.states,on:e.on??{}});class ${desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{},guards:{}},id:"DeviceRegistrationMachine",context:{...this.authenticatorMachine.desc().config.context,...this.emailTokenMachine.desc().config.context,registrationMethod:void 0},initial:"StartDeviceRegistration",states:{StartDeviceRegistration:{always:[{target:"EmailToken",cond:"isRegistrationMethodEmailToken"},{target:"DashlaneAuthenticator",cond:"isRegistrationMethodAuthenticator"},{target:"TwoFactorAuthentication",cond:"isRegistrationMethodOTP"}]},DashlaneAuthenticator:{...H(this.authenticatorMachine.desc().config),onDone:[{target:"EmailToken",cond:"shouldSwitchToEmailToken"},{target:"DeviceRegistrationDone"}]},EmailToken:{...H(this.emailTokenMachine.desc().config),onDone:[{target:"DashlaneAuthenticator",cond:"shouldSwitchToAuthenticator"},{target:"DeviceRegistrationDone"}]},TwoFactorAuthentication:{onDone:{target:"DeviceRegistrationDone"}},DeviceRegistrationDone:{type:"final"}}},options:{actions:{...this.authenticatorMachine.desc().options.actions,...this.emailTokenMachine.desc().options.actions,assignUnknownDeviceRegistrationError:(0,v.f0)({error:()=>({code:"unknown_error",data:{message:"Unknown device registration error"}})})},services:{...this.authenticatorMachine.desc().options.services,...this.emailTokenMachine.desc().options.services},guards:{...this.authenticatorMachine.desc().options.guards,...this.emailTokenMachine.desc().options.guards,isRegistrationMethodEmailToken:e=>"email_token"===e.registrationMethod,isRegistrationMethodOTP:e=>"otp"===e.registrationMethod,isRegistrationMethodAuthenticator:e=>"dashlane_authenticator"===e.registrationMethod,shouldSwitchToEmailToken:(e,t)=>t.data.switchToEmailToken,shouldSwitchToAuthenticator:(e,t)=>t.data.switchToDashlaneAuthenticator}}}}create(){let{config:e,options:t}=this.desc();return(0,y.C)(e,t)}constructor(e,t){this.authenticatorMachine=e,this.emailTokenMachine=t}}$=(0,c.gn)([(0,m.GS)(),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===q?Object:q,void 0===Q?Object:Q])],$);var X=i(15021),Z=i(59982);let J=e=>!0;class ee extends(0,Z.Q)({initialValue:void 0,persist:!1,scope:X.F.Device,storeName:"device-registration-flow-store",storeTypeGuard:J}){}class et{mapFunctionalErrorToErrorCode(e){switch(e.tag){case R.VERIFICATION_FAILED:return N.OTP_NOT_VALID;case R.INVALID_OTP_ALREADY_USED:return N.OTP_ALREADY_USED;case R.INVALID_OTP_BLOCKED:return N.OTP_TOO_MANY_ATTEMPTS;default:return k.UNKNOWN_ERROR}}async executeWithParams(e){if(!e.login||!e.otp||0===e.otp.length||"totp"===e.twoFactorAuthenticationOtpType&&!B.test(e.otp))return Promise.reject(k.UNKNOWN_ERROR);let t=await this.identityVerificationService.performTotpVerification(e.login,e.otp);return(0,A.hx)(t)?Promise.reject(this.mapFunctionalErrorToErrorCode(t.error)):(this.eventEmitter.sendEvent("identityVerificationCompleted",{authTicket:t.data}),Promise.resolve())}constructor(e,t){this.identityVerificationService=e,this.eventEmitter=t}}et=(0,c.gn)([(0,m.GS)(),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===j?Object:j,void 0===V?Object:V])],et);class ei{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"TwoFactorAuthenticationMachine",context:{twoFactorAuthenticationOtpType:"totp"},initial:"WaitingForTotp",states:{WaitingForTotp:{on:{INPUT_TOTP:{target:"ValidatingTwoFactorAuthenticationOtp",actions:["assignTwoFactorAuthenticationOtpValue"]},SWITCH_TWO_FACTOR_AUTHENTICATION_TYPE:{target:"WaitingForBackupCode",actions:["assignTwoFactorAuthenticationOtpType","clearError"]}}},WaitingForBackupCode:{on:{INPUT_BACKUP_CODE:{target:"ValidatingTwoFactorAuthenticationOtp",actions:["assignTwoFactorAuthenticationOtpValue"]},SWITCH_TWO_FACTOR_AUTHENTICATION_TYPE:{target:"WaitingForTotp",actions:["assignTwoFactorAuthenticationOtpType","clearError"]}}},ValidatingTwoFactorAuthenticationOtp:{invoke:{src:"authenticateWithTwoFactorAuthentication",onDone:{target:"TwoFactorAuthenticationDone"},onError:[{target:"WaitingForBackupCode",cond:"isBackupCode",actions:["assignError"]},{target:"WaitingForTotp",actions:["assignError"]}]}},TwoFactorAuthenticationDone:{type:"final"}}},options:{actions:{assignError:(0,v.f0)({error:(e,t)=>t.data}),clearError:(0,v.f0)({error:()=>void 0}),assignTwoFactorAuthenticationOtpValue:(0,v.f0)({twoFactorAuthenticationOtpValue:(e,t)=>t.twoFactorAuthenticationOtpValue}),assignTwoFactorAuthenticationOtpType:(0,v.f0)({twoFactorAuthenticationOtpType:(e,t)=>t.twoFactorAuthenticationOtpType})},services:{authenticateWithTwoFactorAuthentication:e=>{let t={login:e.login??"",masterPassword:e.masterPassword??null,otp:e.twoFactorAuthenticationOtpValue,twoFactorAuthenticationOtpType:e.twoFactorAuthenticationOtpType,persistData:!0,otpVerificationMode:e.otpVerificationMode,deviceName:e.deviceName};return this.twoFactorAuthenticationService.executeWithParams(t)}},guards:{isBackupCode:e=>"backupCode"===e.twoFactorAuthenticationOtpType}}}}create(){let{config:e,options:t}=this.desc();return(0,y.C)(e,t)}constructor(e){this.twoFactorAuthenticationService=e}}ei=(0,c.gn)([(0,m.GS)(),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===et?Object:et])],ei);class es{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},initial:"Starting",id:"IdentityVerificationFlowMachine",context:{...this.deviceRegistrationMachine.desc().config.context,...this.twoFactorAuthenticationMachine.desc().config.context,ready:!1,shouldAskOTP:!1},states:{Starting:{entry:["assignInitializationResults"]},DeviceRegistration:{...H(this.deviceRegistrationMachine.desc().config)},TwoFactorAuthentication:{...H(this.twoFactorAuthenticationMachine.desc().config),onDone:{target:"AuthenticationDone"}},AuthenticationDone:{type:"final"}},on:{VERIFY_IDENTITY_WITH_TOKEN:{target:"DeviceRegistration.EmailToken",actions:["assignAccountEmail"]},VERIFY_IDENTITY_WITH_DASHLANE_AUTHENTICATOR:{target:"DeviceRegistration.DashlaneAuthenticator",actions:["assignAccountEmail"]},VERIFY_IDENTITY_WITH_TOTP:{target:"TwoFactorAuthentication",actions:["assignAccountEmail"]},CANCEL_IDENTITY_VERIFICATION:{target:"Starting",actions:["clearContext"]},CLEAR_ERROR:{actions:["clearError"]}}},options:{actions:{...this.deviceRegistrationMachine.desc().options.actions,...this.twoFactorAuthenticationMachine.desc().options.actions,assignInitializationResults:(0,v.f0)({ready:()=>!0}),assignAccountEmail:(0,v.f0)({login:(e,t)=>t.login}),clearContext:(0,v.f0)({login:()=>"",shouldAskOTP:()=>!1,twoFactorAuthenticationOtpType:()=>"totp",registrationMethod:()=>void 0,emailToken:()=>"",deviceName:()=>"",isDashlaneAuthenticatorAvailable:()=>!1}),clearError:(0,v.f0)({error:()=>void 0})},services:{...this.deviceRegistrationMachine.desc().options.services,...this.twoFactorAuthenticationMachine.desc().options.services},guards:{...this.deviceRegistrationMachine.desc().options.guards,...this.twoFactorAuthenticationMachine.desc().options.guards,isGrapheneDeviceRegistrationFlow:e=>!!e.login&&e.login.includes("kw_test_newdevice")}}}}create(){let{config:e,options:t}=this.desc();return(0,y.C)(e,t)}constructor(e,t){this.deviceRegistrationMachine=e,this.twoFactorAuthenticationMachine=t}}es=(0,c.gn)([(0,m.GS)(),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===$?Object:$,void 0===ei?Object:ei])],es);var er=i(19444),en=i(84408),ea=i(43840),eo=i(69334),ec=i(39559),ed=i(42589);let el=e=>!0;class eu extends(0,Z.Q)({initialValue:void 0,persist:!1,scope:X.F.Device,storeName:"identity-verification-flow-machine",storeTypeGuard:el}){}let ep=async(e,t)=>{await e.set(JSON.stringify(t))},eh=async e=>{let t=await e.getState();return t?ec.ZM.create(JSON.parse(t)):void 0},eg=e=>e.state$.pipe((0,ed.U)(e=>e?ec.ZM.create(JSON.parse(e)):void 0));class em{async prepare(){if(this.interpreter)try{let e;let t=await eh(this.identityVerificationMachineStore);try{e=this.interpreter.start(t)}catch(t){this.logger.error("Auth Ticket - Unable to reuse the stored state",{location:"IdentityVerificationFlow",method:"prepare()",error:t}),e=this.interpreter.start()}await (0,ea.X)(e,e=>e.context.ready),this.interpreter.send(this.delayedEvents),this.delayedEvents=[],this.initFlag.next(!0)}catch(e){this.logger.error("Auth Ticket - Unable to start machine",{location:"IdentityVerificationFlow",method:"prepare()",error:e})}}ready(){return this.initFlag}continue(e){if(!this.interpreter)throw Error("Authentication flow not started");this.interpreter.getSnapshot().context.ready?this.interpreter.send(e):this.delayedEvents.push(e)}stop(){this.isStarted()&&(this.interpreter=void 0)}isStarted(){return!!this.interpreter}constructor(e,t,i){this.identityVerificationMachineStore=t,this.initFlag=new en.X(!1),this.logger=i;let s=e.create();this.delayedEvents=[],this.interpreter=(0,eo.kJ)(s).onTransition(async e=>{e.changed||"xstate.init"===e.event.type||this.logger.warn(`Auth Ticket - State is unchanged. Unexpected transition with event ${e.event.type}`,{location:"IdentityVerificationFlow",method:"onTransition()",event:e});try{let e=this.interpreter?.getSnapshot();e&&await ep(this.identityVerificationMachineStore,e)}catch(e){this.logger.error("Auth Ticket - Unable to get snapshot",{location:"IdentityVerificationFlow",method:"onTransition()",error:e})}})}}em=(0,c.gn)([(0,m.GS)(),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===es?Object:es,eu,void 0===er.SX?Object:er.SX])],em);var ev=i(37368),ey=i(21273);class ew{execute(e){let{twoFactorAuthenticationOtpType:t}=e.body;return this.identityVerificationFlow.continue({type:"SWITCH_TWO_FACTOR_AUTHENTICATION_TYPE",twoFactorAuthenticationOtpType:t}),Promise.resolve((0,A.Vp)(void 0))}constructor(e){this.identityVerificationFlow=e}}ew=(0,c.gn)([(0,ev.W)(ey.eG),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===em?Object:em])],ew);class eS{execute(){return this.identityVerificationFlow.continue({type:"CLEAR_ERROR"}),Promise.resolve((0,A.Vp)(void 0))}constructor(e){this.identityVerificationFlow=e}}eS=(0,c.gn)([(0,ev.W)(ey.$5),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===em?Object:em])],eS);class ef{execute(){return this.identityVerificationFlow.continue({type:"RESEND_EMAIL_TOKEN"}),Promise.resolve((0,A.Vp)(void 0))}constructor(e){this.identityVerificationFlow=e}}ef=(0,c.gn)([(0,ev.W)(ey.Gc),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===em?Object:em])],ef);class eE{execute(){return this.identityVerificationFlow.continue({type:"RESEND_PUSH_NOTIFICATION"}),Promise.resolve((0,A.Vp)(void 0))}constructor(e){this.identityVerificationFlow=e}}eE=(0,c.gn)([(0,ev.W)(ey.rF),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===em?Object:em])],eE);class eI{execute(e){let{twoFactorAuthenticationOtpValue:t}=e.body;return this.identityVerificationFlow.continue({type:"INPUT_BACKUP_CODE",twoFactorAuthenticationOtpValue:t}),Promise.resolve((0,A.Vp)(void 0))}constructor(e){this.identityVerificationFlow=e}}eI=(0,c.gn)([(0,ev.W)(ey.sH),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===em?Object:em])],eI);class eb{execute(e){let{emailToken:t,deviceName:i}=e.body;return this.identityVerificationFlow.continue({type:"INPUT_EMAIL_TOKEN",emailToken:t,deviceName:i}),Promise.resolve((0,A.Vp)(void 0))}constructor(e){this.identityVerificationFlow=e}}eb=(0,c.gn)([(0,ev.W)(ey.XH),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===em?Object:em])],eb);class eA{execute(e){let{twoFactorAuthenticationOtpValue:t}=e.body;return this.identityVerificationFlow.continue({type:"INPUT_TOTP",twoFactorAuthenticationOtpValue:t}),Promise.resolve((0,A.Vp)(void 0))}constructor(e){this.identityVerificationFlow=e}}eA=(0,c.gn)([(0,ev.W)(ey.ad),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===em?Object:em])],eA);class eC{execute(){return this.identityVerificationFlow.continue({type:"SWITCH_TO_DASHLANE_AUTHENTICATOR"}),Promise.resolve((0,A.Vp)(void 0))}constructor(e){this.identityVerificationFlow=e}}eC=(0,c.gn)([(0,ev.W)(ey.K1),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===em?Object:em])],eC);class eR{execute(){return this.identityVerificationFlow.continue({type:"SWITCH_TO_EMAIL_TOKEN"}),Promise.resolve((0,A.Vp)(void 0))}constructor(e){this.identityVerificationFlow=e}}eR=(0,c.gn)([(0,ev.W)(ey.v5),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===em?Object:em])],eR);class e_{execute({body:{login:e,verificationMethod:t}}){switch(t){case"email_token":case"sso":this.identityVerificationFlow.continue({type:"VERIFY_IDENTITY_WITH_TOKEN",login:e});break;case"totp":this.identityVerificationFlow.continue({type:"VERIFY_IDENTITY_WITH_TOTP",login:e});break;case"dashlane_authenticator":this.identityVerificationFlow.continue({type:"VERIFY_IDENTITY_WITH_DASHLANE_AUTHENTICATOR",login:e})}return Promise.resolve((0,A.Vp)(void 0))}constructor(e){this.identityVerificationFlow=e}}e_=(0,c.gn)([(0,ev.W)(ey.qw),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===em?Object:em])],e_);class eO{execute(){return this.identityVerificationFlow.continue({type:"CANCEL_IDENTITY_VERIFICATION"}),Promise.resolve((0,A.Vp)(void 0))}constructor(e){this.identityVerificationFlow=e}}eO=(0,c.gn)([(0,ev.W)(ey.Vs),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===em?Object:em])],eO);var eT=i(36884),eF=i(72233),eD=i(56144),eU=i(81433),eP=i(62506),ex=i(68371),eN=i(69853),eL=i(48194);let ek=e=>({step:"EmailTokenStep",isLoading:e.matches({DeviceRegistration:{EmailToken:"ValidatingEmailToken"}})&&!e.context.error,error:e.context.error,emailToken:e.context.emailToken,isDashlaneAuthenticatorAvailable:e.context.isDashlaneAuthenticatorAvailable}),ej=e=>({step:"DashlaneAuthenticatorStep",isLoading:e.matches({DeviceRegistration:{DashlaneAuthenticator:"RequestingServerPush"}})&&!e.context.error,error:e.context.error}),eG=e=>({step:"TwoFactorAuthenticationOtpStep",isLoading:e.matches({TwoFactorAuthentication:"ValidatingTwoFactorAuthenticationOtp"})&&!e.context.error,error:e.context.error,twoFactorAuthenticationOtpValue:e.context.twoFactorAuthenticationOtpValue,twoFactorAuthenticationOtpType:e.context.twoFactorAuthenticationOtpType}),eV=e=>(0,eN.of)((0,A.Vp)(function(e){if(e.matches("Starting"))return{step:"StartingStep"};if(e.matches({DeviceRegistration:{EmailToken:"SendEmailToken"}})||e.matches({DeviceRegistration:{EmailToken:"WaitingForEmailToken"}})||e.matches({DeviceRegistration:{EmailToken:"ValidatingEmailToken"}})||e.matches({DeviceRegistration:{EmailToken:"FinishingEmailToken"}}))return ek(e);if(e.matches({DeviceRegistration:{DashlaneAuthenticator:"RequestingServerPush"}})||e.matches({DeviceRegistration:{DashlaneAuthenticator:"AuthenticatorPushFailed"}})||e.matches({DeviceRegistration:{DashlaneAuthenticator:"AuthenticatorPushValidated"}}))return ej(e);if(e.matches({TwoFactorAuthentication:"WaitingForTotp"})||e.matches({TwoFactorAuthentication:"WaitingForBackupCode"})||e.matches({TwoFactorAuthentication:"ValidatingTwoFactorAuthenticationOtp"})||e.matches({TwoFactorAuthentication:"FinishingTwoFactorAuthenticationOtp"}))return eG(e);throw Error(`[Auth Ticket] - No view associated to state ${JSON.stringify(e.value)}`)}(e))),eM=e=>e.pipe((0,eL.z)(eV));var eK=i(4944);let eW=(e,t)=>{let i=t.matches(e.value),s=(0,eK.Z)(e.context,t.context);return i&&s};class ez{execute(){return(0,eT.a)([eg(this.identityVerificationMachineStore),this.identityVerificationFlow.ready()],(e,t)=>{if(e&&t)return e}).pipe((0,eD.h)(Boolean),(0,eU.x)((e,t)=>eW(e,t)),eM,(0,eF.K)((e,t)=>(this.logger.error("Error retrieving identity verification view data",{location:"IdentityVerificationFlowQueryStatusHandler",method:"execute()",error:e}),t)))}constructor(e,t,i){this.identityVerificationFlow=e,this.identityVerificationMachineStore=t,this.logger=i}}ez=(0,c.gn)([(0,eP.e)(ex.O),(0,c.w6)("design:type",Function),(0,c.w6)("design:paramtypes",[void 0===em?Object:em,eu,void 0===er.SX?Object:er.SX])],ez);class eq{}eq=(0,c.gn)([(0,d.Y)({api:g.i,handlers:{commands:{changeTwoFactorAuthenticationOtpType:ew,clearError:eS,resendEmailToken:ef,resendPushNotification:eE,submitBackupCode:eI,submitEmailToken:eb,submitTotp:eA,switchToDashlaneAuthenticator:eC,switchToEmailToken:eR,startIdentityVerification:e_,cancelIdentityVerification:eO},events:{},queries:{identityVerificationFlowStatus:ez}},providers:[$,q,M,Q,ei,...(0,l.H)(em,{inject:[es,eu,er.SX],asyncFactory:async(e,t,i)=>{let s=new em(e,t,i);return await s.prepare(),s}}),es,Y,et,z,j,V,(0,u.d_)(er.SX)],imports:[h.n,p.G],exports:[em],stores:[eu,ee]})],eq)},32004:function(e,t,i){i.d(t,{i:()=>T});var s=i(21636),r=i(48035),n=i(67602),a=i(15021),o=i(59982),c=i(68238),d=i(63762);let l=d.z.object({token:d.z.string().optional()}),u=e=>l.safeParse(e).success;class p extends(0,o.Q)({initialValue:{token:void 0},persist:!1,scope:a.F.Device,storeName:"phishing-resistance",storeTypeGuard:u,capacity:c.Y._001KB}){}var h=i(37368),g=i(14247),m=i(306);class v{async execute({body:{token:e}}){return await this.store.set({token:e}),(0,m.Vp)(void 0)}constructor(e){this.store=e}}v=(0,s.gn)([(0,h.W)(g.r),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[p])],v);var y=i(36884),w=i(42589),S=i(62506),f=i(13598),E=i(25933),I=i(79374),b=i(86419),A=i(28655);class C{execute(){let{queries:{getKillSwitch:e}}=this.killSwitchClient;return(0,y.a)({killSwitch:e({killSwitch:f.v.DisablePhishingResistance}),platformInfo:this.platformInfoClient.queries.platformInfo()}).pipe((0,w.U)(({killSwitch:e,platformInfo:t})=>{if(!(0,m.d6)(e)||!(0,m.d6)(t))return(0,m.Rn)(b.Z());let i=(0,m.db)(e),s="Firefox"===(0,m.db)(t).browser,r="Safari"===(0,m.db)(t).browser;return(0,m.Vp)({isRequired:!i&&!s&&!r})}))}constructor(e,t){this.killSwitchClient=e,this.platformInfoClient=t}}C=(0,s.gn)([(0,S.e)(A.c),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===E.i?Object:E.i,void 0===I.c?Object:I.c])],C);var R=i(81433),_=i(66645);class O{execute(){return this.store.state$.pipe((0,w.U)(e=>e.token),(0,R.x)(),(0,w.U)(e=>(0,m.Vp)({token:e})))}constructor(e){this.store=e}}O=(0,s.gn)([(0,S.e)(_.m),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[p])],O);class T{}T=(0,s.gn)([(0,r.Y)({api:n.I,handlers:{commands:{setToken:v},events:{},queries:{getIsTokenRequired:C,getToken:O}},domainName:"authentication",stores:[p]})],T)},16734:function(e,t,i){i.d(t,{N:()=>el});var s=i(21636),r=i(48035),n=i(19868),a=i(87253),o=i(4843),c=i(44581),d=i(62506),l=i(60909),u=i(49247),p=i(94190),h=i(29047),g=i(76217),m=i(55559),v=i(59242),y=i(83267),w=i(97702),S=i(38004),f=i(306),E=i(70554),I=i(649),b=i(90385),A=i(19855),C=i(42589),R=i(41509),_=i(80262),O=i(56144),T=i(36884),F=i(44577);let D=null;async function U(){let{client:e,ready:t}=await Promise.all([i.e("185"),i.e("577"),i.e("954"),i.e("393"),i.e("766")]).then(i.bind(i,50817));return await t,{client:e}}async function P(){if(!D){let{client:e}=await U();D=e}return D}var x=i(15021),N=i(59982),L=i(68238),k=i(63762),j=i(20458);let G=k.z.object({localAccounts:k.z.record(k.z.string(),k.z.object({salt:k.z.string(),encryptedSessionKey:k.z.string(),serverSessionKey:k.z.string(),attemptsLeft:k.z.number()}))}),V=e=>G.safeParse(e).success;class M extends(0,N.Q)({persist:!0,storage:{initialValue:{localAccounts:{}},schemaVersion:1,typeGuard:V,migrateStorageSchema:()=>({localAccounts:{}})},codec:j.E,scope:x.F.Device,storeName:"pincode",capacity:L.Y._001KB}){}var K=i(17721),W=i(16620),z=i(14006),q=i(49);class B{async encryptSessionKeyWithPinKey(e,t){return await this.flexibleEncryptor.encrypt(t,e,z.oo,q.gO)}async decryptSessionKeyWithPinKey(e,t){return await this.flexibleDecryptor.decrypt(t,e)}constructor(e,t){this.flexibleEncryptor=e,this.flexibleDecryptor=t}}B=(0,s.gn)([(0,p.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===K._?Object:K._,void 0===W.a?Object:W.a])],B);var Y=i(49594),Q=i(75264);class H extends Y.K{loadResource(e){if(!(e&&"object"==typeof e&&"serverIdentifier"in e&&"serverPublicKey"in e))throw Error("File corrupted");return e}constructor(e,t){super(`/assets/pin-code.${"https://api.dashlane.com"===t.baseUrl?"prod":"staging"}.config.json`,e)}}H=(0,s.gn)([(0,p.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===Q.X?Object:Q.X,void 0===v.l?Object:v.l])],H);class ${getPinCodeStatus(e){return this.pinCodeStore.state$.pipe((0,C.U)(t=>{let i=e in t.localAccounts;return(0,f.Vp)(i?{isPinCodeEnabled:!0,attemptsLeft:t.localAccounts[e].attemptsLeft}:{isPinCodeEnabled:!1})}))}getCurrentUserPinCodeStatus(){let e=this.session.queries.selectedOpenedSession().pipe((0,R.V)({first:5e3,with:()=>(0,_._)(()=>Error("No current active user"))}),(0,C.U)(e=>(0,f.d6)(e)&&e.data?e.data:""),(0,O.h)(e=>!!e));return(0,T.a)([e,this.pinCodeStore.state$]).pipe((0,C.U)(([e,t])=>{let i=e in t.localAccounts;return(0,f.Vp)(i?{isPinCodeEnabled:!0,attemptsLeft:t.localAccounts[e].attemptsLeft}:{isPinCodeEnabled:!1})}))}async activatePinCode(e){let t=await this.getCurrentUserEmail(),i=await (0,F.z)(this.carbonClient.queries.carbonState({path:"state.authentication.currentUser.rememberMeType"}));(0,f.d6)(i)&&"autologin"===i.data&&await this.carbonClient.commands.disableAutologin();let s=await this.pinCodeStore.getState(),r=await this.getExportedSessionKey(),n=(0,y.s)(await this.keyGenerator.generate()),a=await P(),o=(0,y.s)(await this.hmacSigner.sign((0,w.R)(n),new TextEncoder().encode(e))),{clientRegistrationState:c,registrationRequest:d}=a.startRegistration({password:o}),l=await (0,F.z)(this.serverApi.v1.authentication.pincodeRequestActivation({activationRequest:d})),u=(0,E.EQ)(l,{success:e=>e.data.data.activationResponse,failure:e=>(0,E.EQ)(e.error,{BusinessError:e=>{switch(e.code){case"FAILED_TO_PROCESS_ACTIVATION_REQUEST":case"SSO_USER_NOT_ALLOWED":return(0,I.j)(e.code);default:(0,b.U)(e)}},FetchFailedError:I.j,InternalServerError:I.j,InvalidRequest:I.j,RateLimited:I.j,ServiceUnavailable:I.j,UnspecifiedBadStatus:I.j})}),p=await this.pinCodeServerConfigResourceLoader.get(),{registrationRecord:h,exportKey:g,serverStaticPublicKey:m}=a.finishRegistration({clientRegistrationState:c,registrationResponse:u,password:o,identifiers:{client:t,server:p.serverIdentifier}});if(m!==p.serverPublicKey)throw Error("OPAQUE\xb4s serverStaticPublicKey does not match api configs.");let v=await (0,F.z)(this.serverApi.v1.authentication.pincodeCompleteActivation({pinCodeRecord:h})),A=(0,E.EQ)(v,{success:e=>e.data.data.sessionKey,failure:e=>(0,E.EQ)(e.error,{BusinessError:e=>{switch(e.code){case"ACTIVATION_REQUEST_NOT_FOUND":case"EMPTY_PIN_CODE_RECORD":return(0,I.j)(e.code);default:(0,b.U)(e)}},FetchFailedError:I.j,InternalServerError:I.j,InvalidRequest:I.j,RateLimited:I.j,ServiceUnavailable:I.j,UnspecifiedBadStatus:I.j})}),C=(0,S.N)(g),R=await this.sessionKeyCrypto.encryptSessionKeyWithPinKey(r,C);await this.pinCodeStore.set({...s,localAccounts:{...s.localAccounts,[t]:{...s.localAccounts[t],serverSessionKey:A,salt:n,encryptedSessionKey:(0,y.s)(R),attemptsLeft:3}}})}async removePinCodeFromStore(e){let t=await this.pinCodeStore.getState();delete t.localAccounts[e],await this.pinCodeStore.set(t)}async deactivatePinCode(){let e=await this.getCurrentUserEmail();e in(await this.pinCodeStore.getState()).localAccounts&&(await this.removePinCodeFromStore(e),await this.allowToFail.doOne(async()=>await (0,F.z)(this.serverApi.v1.authentication.pincodeDisable({})),{methodName:"Deactivate pin code"}))}async computePinKey(e,t){let i=await this.pinCodeStore.getState();if(!(t in i.localAccounts))return(0,f.Rn)((0,l.Zs)());let{serverSessionKey:s,salt:r}=i.localAccounts[t],n=(0,y.s)(await this.hmacSigner.sign((0,w.R)(r),new TextEncoder().encode(e))),a=await P(),{clientLoginState:o,startLoginRequest:c}=a.startLogin({password:n}),d=await (0,F.z)(this.serverApi.v1.authentication.pincodeRequestLogin({loginRequest:c,sessionKey:s})),u=(0,E.EQ)(d,{success:e=>(0,f.Vp)(e.data.data),failure:e=>(0,E.EQ)(e.error,{BusinessError:e=>{switch(e.code){case"INVALID_SESSION_KEY":case"NO_PIN_CODE_ACTIVATED":case"FAILED_TO_PROCESS_LOGIN_REQUEST":case"MAX_ATTEMPTS_REACHED":return(0,f.Rn)((0,l.Zs)());default:(0,b.U)(e)}},FetchFailedError:I.j,InternalServerError:I.j,InvalidRequest:I.j,RateLimited:I.j,ServiceUnavailable:I.j,UnspecifiedBadStatus:I.j})});if(!(0,f.d6)(u))return await this.removePinCodeFromStore(t),u;let{loginResponse:p,attemptsLeft:h}=u.data,g=await this.pinCodeStore.getState();await this.pinCodeStore.set({...g,localAccounts:{...g.localAccounts,[t]:{...g.localAccounts[t],attemptsLeft:h}}});let m=await this.pinCodeServerConfigResourceLoader.get(),v=a.finishLogin({clientLoginState:o,loginResponse:p,password:n,identifiers:{client:t,server:m.serverIdentifier}});if(!v)return 0===h&&await this.removePinCodeFromStore(t),(0,f.Rn)((0,l.g5)());if(v.serverStaticPublicKey!==m.serverPublicKey)throw Error("OPAQUE\xb4s serverStaticPublicKey does not match api configs.");let{exportKey:A,finishLoginRequest:C}=v;return await this.allowToFail.doOne(async()=>await (0,F.z)(this.serverApi.v1.authentication.pincodeCompleteLogin({sessionKey:s,completeLoginRequest:C})),{methodName:"Complete login with pin code"}),(0,f.Vp)((0,S.N)(A))}async loginWithPinCode(e,t){let i=await this.pinCodeStore.getState();if(!(e in i.localAccounts))return(0,f.Rn)((0,l.Zs)());let{encryptedSessionKey:s}=i.localAccounts[e],r=await this.computePinKey(t,e);if(!(0,f.d6)(r))return r;let n=r.data,a=await this.sessionKeyCrypto.decryptSessionKeyWithPinKey((0,w.R)(s),n),o=await this.session.commands.openUserSession({email:e,rememberPassword:!1,sessionKey:{type:"exported",content:(0,y.s)(a)}});if(!(0,f.d6)(o))throw Error("Failed to open the session");return(0,f.Vp)(void 0)}async validatePinCode(e,t){return(0,E.EQ)(await this.computePinKey(e,t),{success:()=>(0,f.Vp)({isPinCodeCorrect:!0}),failure:e=>(0,E.EQ)(e.error,{NO_ACTIVE_PIN_CODE:I.j,WRONG_PIN_CODE:async()=>{let e=await (0,F.z)(this.getCurrentUserPinCodeStatus());return(0,f.ho)(e).isPinCodeEnabled||await this.session.commands.closeUserSession({email:t}),(0,f.Vp)({isPinCodeCorrect:!1})}})})}async getCurrentUserEmail(){let e=await (0,F.z)(this.session.queries.selectedOpenedSession());if(!(0,f.d6)(e)||!e.data)throw Error("No current session was found");return e.data}async getExportedSessionKey(){let e=await (0,F.z)(this.session.queries.exportSessionKey());if(!(0,f.d6)(e))throw Error("Failed to export session key");return(0,w.R)(e.data.content)}constructor(e,t,i,s,r,n,a,o,c){this.pinCodeStore=e,this.session=t,this.keyGenerator=i,this.hmacSigner=s,this.sessionKeyCrypto=r,this.serverApi=n,this.allowToFail=a,this.carbonClient=o,this.pinCodeServerConfigResourceLoader=c}}$=(0,s.gn)([(0,p.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[M,void 0===A.x?Object:A.x,void 0===g.c?Object:g.c,void 0===m.q?Object:m.q,void 0===B?Object:B,void 0===v.l?Object:v.l,void 0===h.J?Object:h.J,void 0===u._?Object:u._,void 0===H?Object:H])],$);class X{execute(e){return this.pinCodeService.getPinCodeStatus(e.body.loginEmail)}constructor(e){this.pinCodeService=e}}X=(0,s.gn)([(0,d.e)(c.D),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===$?Object:$])],X);var Z=i(90973),J=i(37368);class ee{async execute({body:e}){return await this.pinCodeService.activatePinCode(e.pinCode),(0,f.Vp)(void 0)}constructor(e){this.pinCodeService=e}}ee=(0,s.gn)([(0,J.W)(Z.r),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===$?Object:$])],ee);var et=i(50621);class ei{async execute(){return await this.pinCodeService.deactivatePinCode(),(0,f.Vp)(void 0)}constructor(e){this.pinCodeService=e}}ei=(0,s.gn)([(0,J.W)(et.E),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===$?Object:$])],ei);var es=i(26775);class er{async execute({body:e}){return await this.pinCodeService.loginWithPinCode(e.email,e.pinCode)}constructor(e){this.pinCodeService=e}}er=(0,s.gn)([(0,J.W)(es.c),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===$?Object:$])],er);var en=i(19487),ea=i(72907);class eo{execute(e){return this.session.queries.selectedOpenedSession().pipe((0,ea.w)(async t=>{if(!(0,f.d6)(t)||!t.data)throw Error("No user logged in");return await this.pinCodeService.validatePinCode(e.body.pinCode,t.data)}))}constructor(e,t){this.pinCodeService=e,this.session=t}}eo=(0,s.gn)([(0,d.e)(en.M),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===$?Object:$,void 0===A.x?Object:A.x])],eo);var ec=i(79437);class ed{execute(){return this.pinCodeService.getCurrentUserPinCodeStatus()}constructor(e){this.pinCodeService=e}}ed=(0,s.gn)([(0,d.e)(ec.o),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===$?Object:$])],ed);class el{}el=(0,s.gn)([(0,r.Y)({api:n.n,stores:[M],imports:[a.D,o.n],handlers:{commands:{activate:ee,deactivate:ei,loginWithPinCode:er},events:{},queries:{isPinCodeCorrect:eo,getStatus:X,getCurrentUserStatus:ed}},providers:[$,B,H]})],el)},20082:function(e,t,i){i.d(t,{r:()=>K});var s=i(21636),r=i(48035),n=i(90573),a=i(99481),o=i(85662),c=i(4843),d=i(15021),l=i(59982),u=i(68238),p=i(63762),h=i(20458);let g=p.z.record(p.z.string(),p.z.object({credentialId:p.z.string(),salt:p.z.string(),encryptedMP:p.z.string()}).array()),m=e=>g.safeParse(e).success;class v extends(0,l.Q)({persist:!0,storage:{initialValue:{},schemaVersion:1,typeGuard:m},codec:h.E,scope:d.F.Device,storeName:"security-key",capacity:u.Y._010KB}){}var y=i(91687),w=i(62506),S=i(42589),f=i(306),E=i(59242),I=i(94190);class b{requestSecurityKeyRegistration(e){return this.serverApi.v1.authentication.requestSecurityKeyRegistration({login:e}).pipe((0,S.U)(e=>{if((0,f.d6)(e))return(0,f.Vp)(e.data.data);throw Error(e.error.message)}))}constructor(e){this.serverApi=e}}b=(0,s.gn)([(0,I.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===E.l?Object:E.l])],b);class A{execute({body:{login:e}}){return this.securityKeyRequestsService.requestSecurityKeyRegistration(e)}constructor(e){this.securityKeyRequestsService=e}}A=(0,s.gn)([(0,w.e)(y.M),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===b?Object:b])],A);var C=i(1833),R=i(27504),_=i(26906);let O="securityKeys.isEnabled";class T{execute(){return(0,C.D)((0,_.U)(O)).pipe((0,S.U)(e=>{let t="true"===e[O];return(0,f.Vp)({isEnabled:t})}))}}T=(0,s.gn)([(0,w.e)(R.v)],T);var F=i(19444),D=i(83267),U=i(37368),P=i(61664),x=i(47898),N=i(19855),L=i(14220),k=i(44577);class j{async setSecurityKeys(e,t){return this.store.set({[e]:t})}getSecurityKeys$(e){return this.store.state$.pipe((0,S.U)(t=>e in t?t[e]:[]))}async getSecurityKeys(e){let t=this.getSecurityKeys$(e);return(0,k.z)(t)}async hasSecurityKeys(e){return(await this.getSecurityKeys(e)).length>0}async getSecurityKey(e,t){return(await this.getSecurityKeys(e)).find(e=>e.credentialId===t)}async getEncryptedMp(e,t){let i=await this.getSecurityKey(e,t);return i?.encryptedMP??""}constructor(e){this.store=e}}j=(0,s.gn)([(0,I.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[v])],j);class G{async execute({body:{login:e,credential:t,prf:i}}){let s=await this.securityKeyStoreService.hasSecurityKeys(e),r=t.id;if(!s||!r||!i)return this.logger.error("Missing security keys or prf key",{location:"LoginWithSecurityKeyCommand",method:"execute()"}),(0,f.Rn)((0,P.Zx)());let n=await this.securityKeyEncryptionService.prfToCryptoKey(i),a=await this.securityKeyStoreService.getEncryptedMp(e,r);if(!a)return(0,f.Rn)((0,P.pF)());let o=await this.securityKeyEncryptionService.decryptPasswordWithPrfKey(a,n),c=await this.session.commands.openUserSession({email:e,rememberPassword:!1,sessionKey:{type:"mp",masterPassword:(0,D.s)(o)}});return(0,f.hx)(c)?(this.logger.error("Failed to open user session",{location:"LoginWithSecurityKeyCommand",method:"execute()",cause:c.error}),(0,f.Rn)((0,P.pF)())):(0,f.Vp)(void 0)}constructor(e,t,i,s){this.securityKeyEncryptionService=e,this.securityKeyStoreService=t,this.session=i,this.logger=s}}G=(0,s.gn)([(0,U.W)(x.T),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L.K?Object:L.K,void 0===j?Object:j,void 0===N.x?Object:N.x,void 0===F.SX?Object:F.SX])],G);var V=i(11826);class M{async execute({body:{login:e,securityKeys:t}}){return await this.securityKeyStoreService.setSecurityKeys(e,t),(0,f.Vp)(void 0)}constructor(e){this.securityKeyStoreService=e}}M=(0,s.gn)([(0,U.W)(V.Q),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===j?Object:j])],M);class K{}K=(0,s.gn)([(0,r.Y)({domainName:"authentication",api:o.d,handlers:{commands:{loginWithSecurityKey:G,saveSecurityKeys:M},events:{},queries:{initAccountCreation:A,getSecurityKeyOptions:T}},imports:[c.n,n.G],providers:[(0,a.d_)(F.SX),L.K,b,j],stores:[v],exports:[L.K]})],K)},14220:function(e,t,i){i.d(t,{K:()=>c});var s=i(21636),r=i(94190),n=i(16016),a=i(97702),o=i(76957);class c{async decryptPasswordWithPrfKey(e,t){let i=(0,n.i)(e);return crypto.subtle.decrypt({name:"AES-GCM",length:256},t,i)}async prfToCryptoKey(e){return crypto.subtle.importKey("raw",(0,a.R)(e),{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}constructor(){this.encryptPasswordWithPrfKey=async(e,t)=>{let i=crypto.getRandomValues(new Uint8Array(12)),s=await crypto.subtle.encrypt({name:"AES-GCM",length:256,iv:i},t,new TextEncoder().encode(e));return`${(0,o.k)(i)}.${(0,o.k)(s)}`}}}c=(0,s.gn)([(0,r.GS)()],c)},60436:function(e,t,i){i.d(t,{Z:()=>N});var s=i(21636),r=i(15468),n=i(48035),a=i(4843),o=i(30213),c=i(37368),d=i(90769),l=i(306),u=i(19855),p=i(44577),h=i(49247),g=i(94190),m=i(42589);class v{getSessionCredentialsForUser(e){let{queries:{carbonStateList:t}}=this.carbon;return(0,p.z)(t({paths:["authentication.currentUser.deviceKeys","userSession.localSettings.uki","userSession.account.login","userSession.session.sessionKeys"]}).pipe((0,m.U)(e=>{if((0,l.hx)(e))throw Error("Failed to get credentials from carbon");return(0,l.db)(e)}),(0,m.U)(this.carbonStateToRequestUserSessionCredentials(e))))}carbonStateToRequestUserSessionCredentials(e){return([t,i,s,r])=>{let n;if(!t&&!i||s!==e)throw Error("No user device credentials available for active user");if(!r)throw Error("No session credentials available for active user");if(i){if("string"!=typeof i)throw Error("Unexpected UKI state shape received from carbon");n=function(e){let t=e.split("-");if(t.length>0){let[i]=t;return{accessKey:i,secretKey:e}}throw Error("Invalid UKI format")}(i)}else{if(!(t&&"object"==typeof t&&"accessKey"in t&&"secretKey"in t&&"string"==typeof t.accessKey&&"string"==typeof t.secretKey))throw Error("Unexpected user device state shape received from carbon");n=t}if(!(r&&"object"==typeof r&&"accessKey"in r&&"secretKey"in r&&"expirationTimeSeconds"in r&&"string"==typeof r.accessKey&&"string"==typeof r.secretKey&&"number"==typeof r.expirationTimeSeconds))throw Error("Unexpected session keys state shape received from carbon");return{login:e,deviceAccessKey:n.accessKey,sessionAccessKey:r.accessKey,sessionSecretKey:r.secretKey}}}constructor(e){this.carbon=e}}v=(0,s.gn)([(0,g.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h._?Object:h._])],v);class y{async execute(e){let t=await (0,p.z)(this.sessionClient.queries.selectedOpenedSession()),i=(0,l.d6)(t)?(0,l.db)(t):e.body.login;if(void 0===i)throw Error("Logged out and no login specified");let{id:s,type:r,rawId:n,response:a}=e.body.assertion,o=await (0,p.z)(this.contextLessServerApiClient.v1.authentication.completeRememberMeOpenSession(await this.rememberMeSessionKeysRepository.getSessionCredentialsForUser(i),{authenticator:{authenticationType:"webauthn.get",credential:{type:r,id:s,rawId:n,response:a}}}));if((0,l.hx)(o))throw Error(`Assertion could not be validated: ${o.error.name}`);return(0,l.Vp)(void 0)}constructor(e,t,i){this.contextLessServerApiClient=e,this.rememberMeSessionKeysRepository=t,this.sessionClient=i}}y=(0,s.gn)([(0,c.W)(o.L),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===d.B?Object:d.B,void 0===v?Object:v,void 0===u.x?Object:u.x])],y);var w=i(14098),S=i(59242),f=i(70554),E=i(63575),I=i(649),b=i(41893);function A(e){return()=>(0,l.Rn)({tag:e})}class C{async execute({body:{email:e}}){let t=await (0,p.z)(this.server.v1.authentication.requestOtpRecoveryCodesByPhone({login:e}));return(0,f.EQ)(t,{success:()=>(0,l.Vp)(void 0),failure:e=>(0,f.EQ)(e.error,{...w.J,FetchFailedError:A(b.A.NetworkError),BusinessError:e=>(0,E.G)(e.code,{INVALID_RECOVERY_PHONE:A(b.A.AccountNotEligible),SMS_ERROR:()=>(0,I.j)("Dashlane servers failed to send SMS"),SMS_OPT_OUT:A(b.A.AccountNotEligible),USER_NOT_FOUND:A(b.A.AccountNotEligible),WRONG_OTP_STATUS:A(b.A.AccountNotEligible)})})})}constructor(e){this.server=e}}C=(0,s.gn)([(0,c.W)(o.x),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===S.l?Object:S.l])],C);var R=i(77326),_=i(83816),O=i(62506),T=i(56144),F=i(72907),D=i(69853),U=i(36884);class P{execute(){let e=this.carbon.queries.liveWebAuthnAuthenticationOptedIn(void 0).pipe((0,T.h)(l.d6),(0,m.U)(e=>e.data)),t=this.carbon.queries.liveIsSSOUser(void 0).pipe((0,T.h)(l.d6),(0,m.U)(e=>e.data)).pipe((0,F.w)(e=>e?(0,D.of)(!1):this.carbon.queries.getAccountAuthenticationType().pipe((0,T.h)(l.d6),(0,m.U)(e=>"masterPassword"===e.data)))),i=this.pin.queries.getCurrentUserStatus().pipe((0,T.h)(l.d6),(0,m.U)(e=>e.data.isPinCodeEnabled)),s=(0,U.a)({isMpUser:t,isPinCodeEnabled:i}).pipe((0,m.U)(({isMpUser:e,isPinCodeEnabled:t})=>(0,l.Vp)(!e&&t)),(0,T.h)(l.d6),(0,m.U)(e=>e.data));return(0,U.a)({hasBiometrics:e,isPasswordlessUser:s,isMpUser:t}).pipe((0,m.U)(({hasBiometrics:e,isPasswordlessUser:t,isMpUser:i})=>(0,l.Vp)([...e?[R.W.Biometrics]:[],...t?[R.W.Pin]:[],...i?[R.W.MasterPassword]:[]])))}constructor(e,t){this.pin=e,this.carbon=t}}P=(0,s.gn)([(0,O.e)(R.Y),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===_.u?Object:_.u,void 0===h._?Object:h._])],P);var x=i(68426);class N{}N=(0,s.gn)([(0,n.Y)({api:r.M,handlers:{commands:{validateWebauthnAssertion:y,request2FaCodesByPhone:C},events:{},queries:{userVerificationMethods:P}},imports:[a.n,x.R],providers:[v]})],N)},19444:function(e,t,i){i.d(t,{SX:()=>u,kg:()=>p});var s=i(99481),r=i(41650),n=i(80426);let a=["masterPassword","serverKey","pinCode","passphrase","ssoServiceProviderKey","ssoToken"],o=(e,t=new WeakSet)=>{if(null==e||"object"!=typeof e||t.has(e))return e;if(t.add(e),Array.isArray(e))return e.map(e=>o(e,t));let i={};for(let s in e)if(Object.prototype.hasOwnProperty.call(e,s)&&"string"==typeof s){let r=e[s];a.some(e=>s.toLowerCase().includes(e.toLowerCase()))?i[s]="xxxxxxx":"object"==typeof r&&null!==r?i[s]=o(r,t):i[s]=r}return i},c=(e,t)=>null==e?"":"string"==typeof e?e:"number"==typeof e?`${e}`:t&&e instanceof Error?e:JSON.stringify(e),d=e=>{if(e&&"object"==typeof e&&!(e instanceof Error)){let t=o(e);return Object.keys(t).reduce((e,i)=>{let s=t[i];return{...e,[i]:c(s,!1)}},{})}return{data:c(e,!1)}},l=e=>!e||"object"!=typeof e||e instanceof Error?e&&e instanceof Error?{error:c(e,!0)}:{data:c(e,!0)}:o(e);class u extends(0,s.ne)(){info(e,t){super.info(e,d(t))}debug(e,t){super.debug(e,l(t))}error(e,t){super.error(e,l(t))}fatal(e,t){super.fatal(e,l(t))}trace(e,t){super.trace(e,l(t))}warn(e,t){super.warn(e,l(t))}log(e,t){super.log(e,l(t))}}let p=new Proxy(r.V.create({container:"no-container",module:"no-module",domain:"authentication-core",infra:new n.s}),{get:(e,t,i)=>"info"===t?(t,i)=>{e.info(t,d(i))}:"debug"===t?(t,i)=>{e.debug(t,l(i))}:"error"===t?(t,i)=>{e.error(t,l(i))}:"fatal"===t?(t,i)=>{e.fatal(t,l(i))}:"trace"===t?(t,i)=>{e.trace(t,l(i))}:"warn"===t?(t,i)=>{e.warn(t,l(i))}:"log"===t?(t,i)=>{e.log(t,l(i))}:Reflect.get(e,t,i)})},1929:function(e,t,i){i.d(t,{e:()=>n});var s=i(68136),r=i(22113);class n{async redirectUserToExternalUrl(e){try{await (0,s.U)({url:e.externalUrl,active:e.tabFocus})}catch(i){let t;this.logger.warn("Auto-SSO - No window available, delaying tab creation",{location:"WebExtensionAuthenticationFlowInfraContext",method:"redirectUserToExternalUrl()",error:i}),t=r.g.addListener(()=>{t&&(r.g.removeListener(t),(0,s.U)({url:e.externalUrl,active:e.tabFocus}))})}}constructor(e){this.logger=e}}},72268:function(e,t,i){i.d(t,{c:()=>o});var s=i(36503),r=i(40234),n=i(34365),a=i(89809);let o=(0,s.Q)({name:"autofillData",commands:{},events:{},queries:{getSingleAutofillData:r.a,getMultipleAutofillData:n.N,searchAutofillData:a.w}})},34365:function(e,t,i){i.d(t,{N:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},40234:function(e,t,i){i.d(t,{a:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},89809:function(e,t,i){i.d(t,{w:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},41908:function(e,t,i){i.d(t,{Y:()=>a});var s=i(36503),r=i(72895),n=i(53286);let a=(0,s.Q)({name:"autofillTracking",commands:{temporaryEmitPasswordAutofillPerformedEvent:r.q},events:{passwordAutofillPerformed:n.p},queries:{}})},72895:function(e,t,i){i.d(t,{q:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},53286:function(e,t,i){i.d(t,{p:()=>n});var s=i(98037),r=i(15021);class n extends(0,s.d)({scope:r.F.User}){}},89797:function(e,t,i){i.d(t,{a:()=>a});var s=i(36503),r=i(96752),n=i(11105);let a=(0,s.Q)({name:"cloudPasskey",commands:{},events:{},queries:{registerPasskey:r.E,usePasskey:n.w}})},96752:function(e,t,i){i.d(t,{E:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},11105:function(e,t,i){i.d(t,{w:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},72211:function(e,t,i){i.d(t,{Hn:()=>o,QY:()=>l,hl:()=>d,j1:()=>c,qH:()=>n,qc:()=>a});var s,r=i(96272),n=((s={}).NOT_SUPPORTED_ERROR="NOT_SUPPORTED_ERROR",s.SECURITY_ERROR="SECURITY_ERROR",s.NOT_ALLOWED_ERROR="NOT_ALLOWED_ERROR",s.INVALID_STATE_ERROR="INVALID_STATE_ERROR",s.UNKNOWN_ERROR="UNKNOWN_ERROR",s);let a=(0,r.Vj)("NOT_SUPPORTED_ERROR","The operation is not supported"),o=(0,r.Vj)("SECURITY_ERROR","The operation is insecure"),c=(0,r.Vj)("NOT_ALLOWED_ERROR","The request is not allowed by the user agent or the platform in the current context, possibly because the user denied permission"),d=(0,r.Vj)("INVALID_STATE_ERROR","The object is in an invalid state"),l=(0,r.Vj)("UNKNOWN_ERROR","The operation failed for an unknown transient reason (e.g. out of memory)")},82541:function(e,t,i){i.d(t,{S:()=>r});var s,r=((s={}).AutofillWebAskBeforeAutologin="autofill_web_askBeforeAutologin",s.AutofillWebInjectScriptOnStartDev="autofill_web_injectScriptOnStart_dev",s.ReplaceInputListeners="autofill_web_replaceInputListeners",s.PasskeySupport="autofill_web_passkey_support",s.ImproveImpalaVisibility="autofill_web_improveImpalaVisibility",s.ImproveImpalaVisibilityDev="autofill_web_improveImpalaVisibility_dev",s.DisableEmailPasswordWarningDev="ace_disable_email_password_warning_dev",s.DisableEmailPasswordWarning="ace_disable_email_password_warning",s.AdminInterview="ace_admin_tab_interview",s.AdminInterviewDev="ace_admin_tab_interview_dev",s.SecretsAttachment="ace_secrets_vault_attachment",s.SharedCollectionInSaveWebcard="shared_collection_in_save_webcard_dev",s.UninstallNudges="ace_nudges_uninstall_slack",s.EnableVortex="ace_web_enable_vortex",s.FunAuditLogs="ace_item_fun_auditlogs",s.CloudPasskeyBeta="ace_web_cloud_passkey_beta",s.CloudPasskeyGA="ace_web_cloud_passkey_ga",s.InAppNudgesV1="ace_web_nudges_extension_compromised",s.PhishingAlertInTac="ace_web_phishing_page_tac",s.MLPhishingPreventionWebcard="ace_web_ml_antiphishing_alert",s)},97401:function(e,t,i){i.d(t,{Pw:()=>a,q_:()=>r,rF:()=>o,up:()=>s});let s=["KWAddress","KWBankStatement","KWCompany","KWDriverLicence","KWEmail","KWFiscalStatement","KWIDCard","KWIdentity","KWMerchand","KWPassport","KWPaymentMean_creditCard","KWPaymentMean_paypal","KWPersonalWebsite","KWPhone","KWSecureNote","KWSecureNoteCategory","KWSocialSecurityStatement"],r=["KWAuthentifiant","KWGeneratedPassword","KWPasskey"],n=[...s,...r],a=e=>!!e&&"string"==typeof e&&n.includes(e),o=e=>!!e&&"object"==typeof e&&Array.isArray(e)&&e.every(a)},74791:function(e,t,i){i.d(t,{P:()=>r,w:()=>n});let s=e=>"object"==typeof e&&null!==e&&"id"in e&&"fieldIdentifier"in e&&"domain"in e,r=e=>e instanceof Array&&!e.find(e=>!s(e)),n=e=>"none"===e.correctedDataSource},94450:function(e,t,i){i.d(t,{M:()=>r});var s,r=((s={})[s.CannotDisable=0]="CannotDisable",s[s.DisableSpecificVaultItem=1]="DisableSpecificVaultItem",s[s.DisableGeneralSetting=2]="DisableGeneralSetting",s)},91192:function(e,t,i){i.d(t,{f:()=>s});let s=Object.freeze({NO_TYPE:"NO_TYPE",UNIVERSAL:"UNIVERSAL",AD:"AD",AE:"AE",AF:"AF",AG:"AG",AI:"AI",AL:"AL",AM:"AM",AO:"AO",AR:"AR",AS:"AS",AT:"AT",AU:"AU",AW:"AW",AZ:"AZ",BA:"BA",BB:"BB",BD:"BD",BE:"BE",BF:"BF",BG:"BG",BH:"BH",BI:"BI",BJ:"BJ",BL:"BL",BM:"BM",BN:"BN",BO:"BO",BR:"BR",BS:"BS",BT:"BT",BW:"BW",BY:"BY",BZ:"BZ",CA:"CA",CD:"CD",CF:"CF",CG:"CG",CH:"CH",CI:"CI",CK:"CK",CL:"CL",CM:"CM",CN:"CN",CO:"CO",CR:"CR",CU:"CU",CV:"CV",CY:"CY",CZ:"CZ",DE:"DE",DJ:"DJ",DK:"DK",DM:"DM",DO:"DO",DZ:"DZ",EC:"EC",EE:"EE",EG:"EG",ER:"ER",ES:"ES",ET:"ET",FI:"FI",FJ:"FJ",FK:"FK",FM:"FM",FO:"FO",FR:"FR",GA:"GA",GB:"GB",GD:"GD",GE:"GE",GF:"GF",GG:"GG",GH:"GH",GI:"GI",GL:"GL",GM:"GM",GN:"GN",GP:"GP",GQ:"GQ",GR:"GR",GT:"GT",GU:"GU",GW:"GW",GY:"GY",HK:"HK",HN:"HN",HR:"HR",HT:"HT",HU:"HU",ID:"ID",IE:"IE",IL:"IL",IM:"IM",IN:"IN",IO:"IO",IQ:"IQ",IR:"IR",IS:"IS",IT:"IT",JE:"JE",JM:"JM",JO:"JO",JP:"JP",KE:"KE",KG:"KG",KH:"KH",KI:"KI",KM:"KM",KN:"KN",KP:"KP",KR:"KR",KW:"KW",KY:"KY",KZ:"KZ",LA:"LA",LB:"LB",LC:"LC",LI:"LI",LK:"LK",LR:"LR",LS:"LS",LT:"LT",LU:"LU",LV:"LV",LY:"LY",MA:"MA",MC:"MC",MD:"MD",ME:"ME",MF:"MF",MG:"MG",MH:"MH",MK:"MK",ML:"ML",MM:"MM",MN:"MN",MO:"MO",MP:"MP",MQ:"MQ",MR:"MR",MS:"MS",MT:"MT",MU:"MU",MV:"MV",MW:"MW",MX:"MX",MY:"MY",MZ:"MZ",NA:"NA",NC:"NC",NE:"NE",NF:"NF",NG:"NG",NI:"NI",NL:"NL",NO:"NO",NP:"NP",NR:"NR",NU:"NU",NZ:"NZ",OM:"OM",PA:"PA",PE:"PE",PF:"PF",PG:"PG",PH:"PH",PK:"PK",PL:"PL",PM:"PM",PR:"PR",PS:"PS",PT:"PT",PW:"PW",PY:"PY",QA:"QA",RE:"RE",RO:"RO",RS:"RS",RU:"RU",RW:"RW",SA:"SA",SB:"SB",SC:"SC",SD:"SD",SE:"SE",SG:"SG",SH:"SH",SI:"SI",SK:"SK",SL:"SL",SM:"SM",SN:"SN",SO:"SO",SR:"SR",ST:"ST",SV:"SV",SY:"SY",SZ:"SZ",TC:"TC",TD:"TD",TF:"TF",TG:"TG",TH:"TH",TJ:"TJ",TK:"TK",TL:"TL",TM:"TM",TN:"TN",TO:"TO",TR:"TR",TT:"TT",TV:"TV",TW:"TW",TZ:"TZ",UA:"UA",UG:"UG",US:"US",UY:"UY",UZ:"UZ",VA:"VA",VC:"VC",VE:"VE",VG:"VG",VI:"VI",VN:"VN",VU:"VU",WF:"WF",WS:"WS",XK:"XK",YE:"YE",YT:"YT",ZA:"ZA",ZM:"ZM",ZW:"ZW",AQ:"AQ",AX:"AX",BV:"BV",CC:"CC",CX:"CX",EH:"EH",GS:"GS",HM:"HM",PN:"PN",SJ:"SJ",UM:"UM"})},95871:function(e,t,i){i.d(t,{$b:()=>a,JV:()=>n,Wm:()=>o});var s,r=i(52031),n=((s={}).NewPassword="newPassword",s.SubmitButton="submitButton",s.WebauthnConditionalUI="WebauthnConditionalUI",s);let a=e=>Object.values(n).includes(e),o=e=>e in r.k},52031:function(e,t,i){i.d(t,{k:()=>r});var s,r=((s={}).Address="Address",s.BankAccount="BankAccount",s.Company="Company",s.Credential="Credential",s.DriverLicense="DriverLicense",s.Email="Email",s.FiscalId="FiscalId",s.GeneratedPassword="GeneratedPassword",s.IdCard="IdCard",s.Identity="Identity",s.Note="Note",s.Passport="Passport",s.Passkey="Passkey",s.PaymentCard="PaymentCard",s.PersonalWebsite="PersonalWebsite",s.Phone="Phone",s.Secret="Secret",s.SocialSecurityId="SocialSecurityId",s)},51086:function(e,t,i){i.r(t),i.d(t,{AddDisabledSourceTypesCommand:()=>z.g,AddLinkedWebsiteCommand:()=>R.vp,AddLinkedWebsiteErrors:()=>R.hy,AnalysisStatus:()=>V._,AutofillFeatureFlips:()=>g.S,AutofillSettingsApiClient:()=>G.W,CREDENTIAL_DATA_MODELS:()=>w.q_,CloudPasskeyErrorCode:()=>h.qH,CountriesForAutofill:()=>m.f,DisableAnalysisCommand:()=>q.u,DisableAutofillOnFormsCommand:()=>Y.t,DisableAutofillOnLoginsCommand:()=>Q.f,DisableAutologinCommand:()=>B.T,DisableFollowUpNotificationCommand:()=>H.y,DisablePhishingPreventionForUrlCommand:()=>k.z,EnableAnalysisCommand:()=>$.c,EnableAutofillOnFormsCommand:()=>Z.a,EnableAutofillOnLoginsCommand:()=>J.I,EnableAutologinCommand:()=>X.i,EnableFollowUpNotificationCommand:()=>ee.B,FORM_DATA_MODELS:()=>w.up,GetAnalysisStatusOnUrlQuery:()=>V.h,GetAutofillDisabledOnLoginsAndFormsNotificationStatusQuery:()=>F.z,GetAutofillProtectionContextQuery:()=>U.u,GetAutofillSettingsQuery:()=>M.T,GetDashlaneDefinedLinkedWebsitesQuery:()=>b.J,GetMultipleAutofillDataQuery:()=>n.N,GetMultipleDashlaneDefinedLinkedWebsitesQuery:()=>A.E,GetPreferencesForCredentialsQuery:()=>W.g,GetSingleAutofillDataQuery:()=>r.a,GetUserAutofillCorrectionsQuery:()=>K.w,IsInAppNudgesEnabledQuery:()=>N.P,LinkedWebsitesClient:()=>I.X,OtherSourceType:()=>v.JV,PasswordAutofillPerformedEvent:()=>c.p,PhishingPreventionDisabledForUrlQuery:()=>x.v,PhishingPreventionEnabledQuery:()=>P.i,RegisterPasskeyQuery:()=>u.E,RemoveDisabledSourceTypesCommand:()=>et.v,RemoveLinkedWebsiteCommand:()=>_.M7,RemoveLinkedWebsiteErrors:()=>_.E6,ResetProtectedItemAutofillTimerCommand:()=>L.y,SearchAutofillDataQuery:()=>a.w,SetAutofillDisabledOnLoginsAndFormsNotificationStatusCommand:()=>T.a,SetUserAutofillCorrectionsCommand:()=>es.S,TemporaryEmitPasswordAutofillPerformedEventCommand:()=>d.q,ToggleDashlaneCommand:()=>ei.r,UpdateCredentialPreferencesCommand:()=>er.J,UpdateLinkedWebsitesCommand:()=>C.A,UsePasskeyQuery:()=>p.w,VaultItemDisableProtectionMode:()=>f.M,VaultSourceType:()=>y.k,autofillDataApi:()=>s.c,autofillNotificationsApi:()=>O._,autofillSecurityApi:()=>D.V,autofillSettingsApi:()=>j.I,autofillTrackingApi:()=>o.Y,cloudPasskeyApi:()=>l.a,createAddLinkedWebsiteCredentialNotFound:()=>R.i6,createAddLinkedWebsiteErrorOnUpdatingVault:()=>R.R6,createAddLinkedWebsiteWebsiteAlreadyLinked:()=>R.lD,createCloudPasskeyInvalidStateError:()=>h.hl,createCloudPasskeyNotAllowedError:()=>h.j1,createCloudPasskeyNotSupportedError:()=>h.qc,createCloudPasskeySecurityError:()=>h.Hn,createCloudPasskeyUnknownError:()=>h.QY,createRemoveLinkedWebsiteCredentialNotFound:()=>_.W4,createRemoveLinkedWebsiteErrorOnUpdatingVault:()=>_.cQ,isArrayOfAutofillableDataModel:()=>w.rF,isArrayOfUserAutofillCorrections:()=>S.P,isAutofillableDataModel:()=>w.Pw,isDashlaneDisabledPermanently:()=>S.w,isOtherSourceType:()=>v.$b,isVaultSourceType:()=>v.Wm,linkedWebsitesApi:()=>E.G});var s=i(72268),r=i(40234),n=i(34365),a=i(89809),o=i(41908),c=i(53286),d=i(72895),l=i(89797),u=i(96752),p=i(11105),h=i(72211),g=i(82541),m=i(91192),v=i(95871),y=i(52031),w=i(97401),S=i(74791),f=i(94450),E=i(74677),I=i(1010),b=i(56103),A=i(77660),C=i(43182),R=i(30459),_=i(21234),O=i(13473),T=i(43754),F=i(62921),D=i(52562),U=i(4880),P=i(3180),x=i(16787),N=i(29585),L=i(45685),k=i(55406),j=i(65430),G=i(17460),V=i(76794),M=i(96203),K=i(90994),W=i(1985),z=i(79401),q=i(81945),B=i(90163),Y=i(57579),Q=i(99123),H=i(71925),$=i(91840),X=i(18306),Z=i(83116),J=i(52781),ee=i(40741),et=i(79931),ei=i(27733),es=i(5596),er=i(68141)},74677:function(e,t,i){i.d(t,{G:()=>d});var s=i(36503),r=i(30459),n=i(21234),a=i(43182),o=i(56103),c=i(77660);let d=(0,s.Q)({name:"linkedWebsites",commands:{addLinkedWebsite:r.vp,removeLinkedWebsite:n.M7,updateLinkedWebsites:a.A},events:{},queries:{getDashlaneDefinedLinkedWebsites:o.J,getMultipleDashlaneDefinedLinkedWebsites:c.E}})},1010:function(e,t,i){i.d(t,{X:()=>n});var s=i(46266),r=i(74677);class n extends(0,s.E)(r.G){}(0,s.K)(r.G,n)},30459:function(e,t,i){i.d(t,{R6:()=>l,hy:()=>o,i6:()=>c,lD:()=>d,vp:()=>u});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).CREDENTIAL_NOT_FOUND="credential_not_found",s.WEBSITE_ALREADY_LINKED="website_already_linked",s.ERROR_ON_UPDATING_VAULT="error_on_updating_vault",s);let c=(0,a.Vj)("credential_not_found","Couldn't retrieve the credential"),d=(0,a.Vj)("website_already_linked","Website alredy linked to this credential"),l=(0,a.Vj)("error_on_updating_vault","Error while updating the credential");class u extends(0,r.g)({scope:n.F.User}){}},21234:function(e,t,i){i.d(t,{E6:()=>o,M7:()=>l,W4:()=>c,cQ:()=>d});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).CREDENTIAL_NOT_FOUND="credential_not_found",s.ERROR_ON_UPDATING_VAULT="error_on_updating_vault",s);let c=(0,a.Vj)("credential_not_found","Couldn't retrieve the credential"),d=(0,a.Vj)("error_on_updating_vault","Error while updating the credential");class l extends(0,r.g)({scope:n.F.User}){}},43182:function(e,t,i){i.d(t,{A:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},56103:function(e,t,i){i.d(t,{J:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},77660:function(e,t,i){i.d(t,{E:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},13473:function(e,t,i){i.d(t,{_:()=>a});var s=i(36503),r=i(43754),n=i(62921);let a=(0,s.Q)({name:"autofillNotifications",commands:{setAutofillDisabledOnLoginsAndFormsNotificationStatus:r.a},events:{},queries:{getAutofillDisabledOnLoginsAndFormsNotificationStatus:n.z}})},43754:function(e,t,i){i.d(t,{a:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},62921:function(e,t,i){i.d(t,{z:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},52562:function(e,t,i){i.d(t,{V:()=>l});var s=i(36503),r=i(29585),n=i(55406),a=i(45685),o=i(4880),c=i(3180),d=i(16787);let l=(0,s.Q)({name:"autofillSecurity",commands:{disablePhishingPreventionForUrl:n.z,resetProtectedItemAutofillTimer:a.y},events:{},queries:{getAutofillProtectionContext:o.u,isPhishingPreventionCapabilityEnabled:c.i,isPhishingPreventionDisabledForUrl:d.v,isInAppNudgesEnabled:r.P}})},55406:function(e,t,i){i.d(t,{z:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},45685:function(e,t,i){i.d(t,{y:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},4880:function(e,t,i){i.d(t,{u:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},29585:function(e,t,i){i.d(t,{P:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},3180:function(e,t,i){i.d(t,{i:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},16787:function(e,t,i){i.d(t,{v:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},65430:function(e,t,i){i.d(t,{I:()=>b});var s=i(36503),r=i(79931),n=i(79401),a=i(27733),o=i(91840),c=i(18306),d=i(83116),l=i(52781),u=i(40741),p=i(81945),h=i(90163),g=i(57579),m=i(99123),v=i(71925),y=i(5596),w=i(68141),S=i(76794),f=i(96203),E=i(90994),I=i(1985);let b=(0,s.Q)({name:"autofillSettings",commands:{toggleDashlane:a.r,enableAnalysis:o.c,enableAutologin:c.i,enableAutofillOnForms:d.a,enableAutofillOnLogins:l.I,enableFollowUpNotification:u.B,disableAnalysis:p.u,disableAutologin:h.T,disableAutofillOnForms:g.t,disableAutofillOnLogins:m.f,disableFollowUpNotification:v.y,addDisabledSourceTypes:n.g,removeDisabledSourceTypes:r.v,setUserAutofillCorrections:y.S,updateCredentialPreferences:w.J},events:{},queries:{getAnalysisStatusOnUrl:S.h,getAutofillSettings:f.T,getUserAutofillCorrections:E.w,getPreferencesForCredentials:I.g}})},17460:function(e,t,i){i.d(t,{W:()=>n});var s=i(46266),r=i(65430);class n extends(0,s.E)(r.I){}(0,s.K)(r.I,n)},79401:function(e,t,i){i.d(t,{g:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},81945:function(e,t,i){i.d(t,{u:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},57579:function(e,t,i){i.d(t,{t:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},99123:function(e,t,i){i.d(t,{f:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},90163:function(e,t,i){i.d(t,{T:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},71925:function(e,t,i){i.d(t,{y:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},91840:function(e,t,i){i.d(t,{c:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},83116:function(e,t,i){i.d(t,{a:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},52781:function(e,t,i){i.d(t,{I:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},18306:function(e,t,i){i.d(t,{i:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},40741:function(e,t,i){i.d(t,{B:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},79931:function(e,t,i){i.d(t,{v:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},5596:function(e,t,i){i.d(t,{S:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},27733:function(e,t,i){i.d(t,{r:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},68141:function(e,t,i){i.d(t,{J:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},76794:function(e,t,i){i.d(t,{_:()=>a,h:()=>o});var s,r=i(45429),n=i(15021),a=((s={}).ANALYSIS_ENABLED="ANALYSIS_ENABLED",s.ANALYSIS_DISABLED_BY_USER="ANALYSIS_DISABLED_BY_USER",s.ANALYSIS_DISABLED_BY_B2B_ADMIN="ANALYSIS_DISABLED_BY_B2B_ADMIN",s.ANALYSIS_DISABLED_BY_KILLSWITCH="ANALYSIS_DISABLED_BY_KILLSWITCH",s.ANALYSIS_DISABLED_BY_2FA_ENFORCEMENT="ANALYSIS_DISABLED_BY_2FA_ENFORCEMENT",s);class o extends(0,r.k)({scope:n.F.Device}){}},96203:function(e,t,i){i.d(t,{T:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},1985:function(e,t,i){i.d(t,{g:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User,useCache:!0}){}},90994:function(e,t,i){i.d(t,{w:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},77977:function(e,t,i){i.d(t,{U:()=>z});var s=i(21636),r=i(48035),n=i(72268),a=i(42589),o=i(52031),c=i(94190),d=i(306),l=i(17741),u=i(57178),p=i(23791),h=i(47244),g=i(34211);let m={[o.k.Address]:u.U.Address,[o.k.BankAccount]:u.U.BankAccount,[o.k.Company]:u.U.Company,[o.k.Credential]:u.U.Credential,[o.k.DriverLicense]:u.U.DriversLicense,[o.k.Email]:u.U.Email,[o.k.FiscalId]:u.U.FiscalId,[o.k.GeneratedPassword]:null,[o.k.IdCard]:u.U.IdCard,[o.k.Identity]:u.U.Identity,[o.k.Note]:u.U.SecureNote,[o.k.Passkey]:u.U.Passkey,[o.k.Passport]:u.U.Passport,[o.k.PaymentCard]:u.U.PaymentCard,[o.k.PersonalWebsite]:u.U.Website,[o.k.Phone]:u.U.Phone,[o.k.SocialSecurityId]:u.U.SocialSecurityId,[o.k.Secret]:u.U.Secret};class v{getAutofillData(e,t,i,s,r,n){let o=e.map(e=>m[e]).filter(e=>!!e);if(o.length<1)throw Error("autofill-data.repository: bad vault item type in `getAutofillData`");return this.getVaultItem(o,t?[t]:void 0,i,s,r,n).pipe((0,a.U)(e=>{if((0,d.hx)(e))throw Error("autofill-data.repository: the following error occured while requesting the vault API "+e.tag);if(t&&e.data[p.N[o[0]]].matchCount<1)throw Error("autofill-data.repository: no vault item corresponding to the provided id");return e}))}searchAutofillData(e,t,i,s,r,n){let a;return t?.length&&(a=t.map(e=>m[e]).filter(e=>!!e)),this.searchVaultItem(e,a,i,s,r,n).pipe((0,l.DZ)(e=>{throw Error("autofill-data.repository: the following error occured while requesting the search vault API "+e)}))}getVaultItem(e,t,i,s,r,n){let{query:a}=this.vaultClient.queries;return a({vaultItemTypes:e,ids:t,propertySorting:i,propertyFilters:s,pageNumber:n,pageSize:r})}searchVaultItem(e,t,i,s,r,n=!1){let{search:a}=this.searchClient.queries;return a({searchQuery:e,vaultItemTypes:t,propertySorting:i,pageSize:s,pageNumber:r,needDashlaneLinkedWebsites:n})}constructor(e,t){this.vaultClient=e,this.searchClient=t}}v=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h.L?Object:h.L,void 0===g.T?Object:g.T])],v);var y=i(44577),w=i(17460),S=i(1010),f=i(49499),E=i(83463),I=i(82199);let b=e=>{if(!e)return 0;let[t,i,s]=e.split(/[-/]/).map(e=>Number.parseInt(e,10)),r=new Date;return r.setUTCHours(0,0,0,0),Math.floor(r.setUTCFullYear(t,i-1,s)/1e3)},A=e=>new Date(1e3*e),C=e=>{if(!e)return null;let t=b(e);return Number.isNaN(t)?null:t},R=e=>{let t=new Date(0).getUTCFullYear(),i=A(C(e.birthDate)??0);return Math.abs(new Date(Date.now()-i.getTime()).getUTCFullYear()-t)};var _=i(83533);let O=(e,t,i)=>{if(!e)return"None";let s=new E.Y(e).getRootDomain();return s===new E.Y(t.URL).getRootDomain()?"MainWebsite":i.map(e=>new E.Y(e).getRootDomain()).includes(s)?"DashlaneDefinedLinkedWebsite":t.linkedURLs.map(e=>new E.Y(e).getRootDomain()).includes(s)?"UserDefinedLinkedWebsite":"None"},T=(e,t,i)=>{switch(O(e,t,i)){case"DashlaneDefinedLinkedWebsite":return _.MatchType.AssociatedWebsite;case"UserDefinedLinkedWebsite":return _.MatchType.UserAssociatedWebsite;default:return _.MatchType.Regular}},F=e=>e??"",D=e=>e??0;class U{getAutofillViewForItems(e,{data:t},i){let s=e.filter(e=>e!==o.k.GeneratedPassword);if(s.length<1)throw Error("AutofillDataService: unexpected item types");return Promise.all(s.map(e=>this.mapVaultItemToAutofillView[e](t,i)))}getSingleAutofillViewForItem(e,{data:t},i){if(e===o.k.GeneratedPassword)throw Error("AutofillDataService: unexpected item type");return this.mapVaultItemToAutofillView[e](t,i)}baseItemAutofillView(e){return{id:e.id,lastUse:e.lastUse,localeFormat:e.localeFormat,spaceId:F(e.spaceId)}}async addressAutofillView(e){return{items:e.addressesResult.items.map(e=>({...this.baseItemAutofillView(e),vaultType:o.k.Address,addressFull:`${F(e.streetNumber)} ${e.streetName}`.trim(),addressName:F(e.itemName),streetTitle:F(e.streetName),building:F(e.building),city:F(e.city),country:F(e.country),zipCode:F(e.zipCode),streetName:F(e.streetName),streetNumber:F(e.streetNumber),stairs:F(e.stairs),digitCode:F(e.digitCode),state:F(I.j[e.country?.toUpperCase()]?.[e.state]?.name),stateCode:F(e.state),stateLevel2:"",door:F(e.door),floor:F(e.floor)})),count:e.addressesResult.matchCount}}async bankAccountAutofillView(e){return{items:e.bankAccountsResult.items.map(e=>({...this.baseItemAutofillView(e),vaultType:o.k.BankAccount,name:F(e.accountName),owner:F(e.ownerName),IBAN:F(e.IBAN),BIC:F(e.BIC),bank:"",bankCode:F(e.bankCode),country:F(e.country)})),count:e.bankAccountsResult.matchCount}}async companyAutofillView(e){return{items:e.companiesResult.items.map(e=>({...this.baseItemAutofillView(e),vaultType:o.k.Company,name:F(e.companyName),jobTitle:F(e.jobTitle)})),count:e.companiesResult.matchCount}}filteredCredentials(e,t,i){let s=i.map(e=>new E.Y(e).getRootDomain());return e.filter(e=>{let i=new E.Y(e.URL).getRootDomain();return!!(i===t||s.includes(i)||e.linkedURLs.map(e=>new E.Y(e).getRootDomain()).includes(t))})}async credentialAutofillView(e,t){let{getDashlaneDefinedLinkedWebsites:i}=this.linkedWebsitesClient.queries,{getPreferencesForCredentials:s}=this.autofillSettings.queries,r=await (0,y.z)(i({url:t??""}));if((0,d.hx)(r))throw Error("Failed to retrieve dashlane linked website for domain: "+r.error);let n=t?this.filteredCredentials(e.credentialsResult.items,t,r.data):e.credentialsResult.items,a=n.map(({id:e})=>e),c=await (0,y.z)(s({credentialIds:a}));if((0,d.hx)(c))throw Error("Failed to retrieve preferences result: "+c.error);let l=c.data;return Promise.all(n.map(async e=>{let s=l.find(({id:t})=>t===e.id),r=await (0,y.z)(i({url:e.URL}));if(!s||(0,d.hx)(r))throw Error("Failed to map Credential to autofill view");let n=await this.getSharingInfoForItem(e.id),{data:a}=r,{useAutoLogin:c,requireMasterPassword:u,onlyAutofillExactDomain:p}=s;return{...this.baseItemAutofillView(e),vaultType:o.k.Credential,title:F(e.itemName),url:F(e.URL),secondaryLogin:F(e.alternativeUsername),email:F(e.email),password:F(e.password),otpSecret:F(e.otpSecret),matchType:T(t??"",e,a),login:F(e.username),hasOtp:!!e.otpURL||!!e.otpSecret,otpUrl:F(e.otpURL),autoLogin:c,autoProtected:u,subdomainOnly:p,userAddedLinkedWebsites:e.linkedURLs,sharingStatus:n}})).then(t=>({items:t,count:e.credentialsResult.matchCount}))}async getSharingInfoForItem(e){let{getPermissionForItem:t}=this.sharingItemsClient.queries,i=await (0,y.z)(t({itemId:e}));if((0,d.hx)(i))throw Error("Failed to get sharing info for item in `autofill-data.service`");let{capabilities:s,sharingPermissionLevel:r}=i.data,{canCopy:n,canEdit:a,canReveal:o}=s;return r?{isShared:!0,canCopy:n,canReveal:o,canEdit:a}:{isShared:!1}}async driverLicenseAutofillView(e){return{items:e.driversLicensesResult.items.map(e=>{let t=A(D(C(e.expirationDate))),i=A(D(C(e.issueDate)));return{...this.baseItemAutofillView(e),vaultType:o.k.DriverLicense,expirationDay:t.getDate(),expirationMonth:t.getMonth()+1,expirationYear:t.getFullYear(),expirationDateFull:`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`,idNumber:F(e.idNumber),issueDay:i.getDate(),issueMonth:i.getMonth()+1,issueYear:i.getFullYear(),issueDateFull:`${i.getFullYear()}-${i.getMonth()+1}-${i.getDate()}`,country:F(e.country),creationDate:D(e.creationDatetime),name:F(e.idName),state:F(e.state)}}),count:e.driversLicensesResult.matchCount}}async emailAutofillView(e){return{items:e.emailsResult.items.map(e=>({...this.baseItemAutofillView(e),vaultType:o.k.Email,email:F(e.emailAddress),name:F(e.itemName),type:e.type??"NO_TYPE"})),count:e.emailsResult.matchCount}}async fiscalIdAutofillView(e){return{items:e.fiscalIdsResult.items.map(e=>({...this.baseItemAutofillView(e),vaultType:o.k.FiscalId,creationDate:D(e.creationDatetime),country:F(e.country),idNumber:F(e.fiscalNumber),teledeclarantNumber:F(e.teledeclarantNumber)})),count:e.fiscalIdsResult.matchCount}}async identityAutofillView(e){return{items:e.identitiesResult.items.map(e=>({...this.baseItemAutofillView(e),vaultType:o.k.Identity,age:R(e),birthDate:F(e.birthDate),birthPlace:F(e.birthPlace),firstName:F(e.firstName),lastName2:F(e.lastName2),lastName:F(e.lastName),middleName:F(e.middleName),middleNameInitial:F(e.middleName),pseudo:F(e.pseudo),title:F(e.title)})),count:e.identitiesResult.matchCount}}async idCardAutofillView(e){return{items:e.idCardsResult.items.map(e=>{let t=A(D(C(e.expirationDate))),i=A(D(C(e.issueDate)));return{...this.baseItemAutofillView(e),vaultType:o.k.IdCard,country:F(e.country),creationDate:D(e.creationDatetime),expirationDay:t.getDate(),expirationMonth:t.getMonth()+1,expirationYear:t.getFullYear(),expirationDateFull:`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`,idNumber:F(e.idNumber),issueDay:i.getDate(),issueMonth:i.getMonth()+1,issueYear:i.getFullYear(),issueDateFull:`${i.getFullYear()}-${i.getMonth()+1}-${i.getDate()}`,name:F(e.idName)}}),count:e.idCardsResult.matchCount}}async noteAutofillView(e){return{items:e.secureNotesResult.items.map(e=>({...this.baseItemAutofillView(e),vaultType:o.k.Note})),count:e.secureNotesResult.matchCount}}async secretAutofillView(e){return{items:e.secretsResult.items.map(e=>({...this.baseItemAutofillView(e),vaultType:o.k.Secret})),count:e.secretsResult.matchCount}}async passportAutofillView(e){return{items:e.passportsResult.items.map(e=>{let t=A(D(C(e.expirationDate))),i=A(D(C(e.issueDate)));return{...this.baseItemAutofillView(e),vaultType:o.k.Passport,country:e.country,creationDate:D(e.creationDatetime),deliveryPlace:e.issuePlace,expirationDay:t.getDate(),expirationMonth:t.getMonth()+1,expirationYear:t.getFullYear(),expirationDateFull:`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`,idNumber:F(e.idNumber),issueDay:i.getDate(),issueMonth:i.getMonth()+1,issueYear:i.getFullYear(),issueDateFull:`${i.getFullYear()}-${i.getMonth()+1}-${i.getDate()}`,name:F(e.idName)}}),count:e.passportsResult.matchCount}}async paymentCardAutofillView(e){return{items:e.paymentCardsResult.items.map(e=>{let t="";return e.cardNumber&&e.cardNumber.trim().length>0&&(t=e.cardNumber.trim().slice(-4)),{...this.baseItemAutofillView(e),vaultType:o.k.PaymentCard,bank:"",cardNumber:F(e.cardNumber),cardNumberLastDigits:t,color:e.color||"BLUE_1",expireMonth:F(e.expireMonth),expireYear:F(e.expireYear),name:F(e.itemName),ownerName:F(e.ownerName),securityCode:F(e.securityCode),type:"PAYMENT_TYPE_MASTERCARD"}}),count:e.paymentCardsResult.matchCount}}async personalWebsiteAutofillView(e){return{items:e.websitesResult.items.map(e=>({...this.baseItemAutofillView(e),vaultType:o.k.PersonalWebsite,name:F(e.itemName),website:F(e.URL)})),count:e.websitesResult.matchCount}}async phoneAutofillView(e){return{items:e.phonesResult.items.map(e=>({...this.baseItemAutofillView(e),vaultType:o.k.Phone,name:F(e.itemName),numberInternational:F(e.numberInternational),number:F(e.phoneNumber),type:e.type})),count:e.phonesResult.matchCount}}async socialSecurityIdAutofillView(e){return{items:e.socialSecurityIdsResult.items.map(e=>({...this.baseItemAutofillView(e),vaultType:o.k.SocialSecurityId,name:F(e.idName),idNumber:F(e.idNumber),country:F(e.country),creationDate:D(e.creationDatetime)})),count:e.socialSecurityIdsResult.matchCount}}filterPasskeys(e,t){return e.filter(e=>{let i=new E.Y(e.rpId).getHostname(),s=new E.Y(t).getHostname();return s===i||s.endsWith(`.${i}`)})}async passkeyAutofillView(e,t){return{items:(t?this.filterPasskeys(e.passkeysResult.items,t):e.passkeysResult.items).map(e=>({...this.baseItemAutofillView(e),vaultType:o.k.Passkey,credentialId:e.credentialId,rpId:e.rpId,rpName:e.rpName,userDisplayName:e.userDisplayName,userHandle:e.userHandle,counter:e.counter,keyAlgorithm:e.keyAlgorithm})),count:e.passkeysResult.matchCount}}constructor(e,t,i){this.autofillSettings=e,this.linkedWebsitesClient=t,this.sharingItemsClient=i,this.mapVaultItemToAutofillView={[o.k.Address]:this.addressAutofillView.bind(this),[o.k.BankAccount]:this.bankAccountAutofillView.bind(this),[o.k.Company]:this.companyAutofillView.bind(this),[o.k.Credential]:this.credentialAutofillView.bind(this),[o.k.DriverLicense]:this.driverLicenseAutofillView.bind(this),[o.k.Email]:this.emailAutofillView.bind(this),[o.k.FiscalId]:this.fiscalIdAutofillView.bind(this),[o.k.IdCard]:this.idCardAutofillView.bind(this),[o.k.Identity]:this.identityAutofillView.bind(this),[o.k.Passkey]:this.passkeyAutofillView.bind(this),[o.k.Passport]:this.passportAutofillView.bind(this),[o.k.PaymentCard]:this.paymentCardAutofillView.bind(this),[o.k.Phone]:this.phoneAutofillView.bind(this),[o.k.Secret]:this.secretAutofillView.bind(this),[o.k.Note]:this.noteAutofillView.bind(this),[o.k.SocialSecurityId]:this.socialSecurityIdAutofillView.bind(this),[o.k.PersonalWebsite]:this.personalWebsiteAutofillView.bind(this)}}}U=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===w.W?Object:w.W,void 0===S.X?Object:S.X,void 0===f.s?Object:f.s])],U);var P=i(56144),x=i(72907),N=i(40234),L=i(62506);class k{execute({body:{itemId:e,itemType:t,rootDomain:i}}){return this.autofillDataRepository.getAutofillData([t],e).pipe((0,P.h)(e=>(0,d.d6)(e)),(0,x.w)(e=>this.autofillDataService.getSingleAutofillViewForItem(t,e,i)),(0,a.U)(e=>e.items[0]),(0,a.U)(d.Vp))}constructor(e,t){this.autofillDataRepository=e,this.autofillDataService=t}}k=(0,s.gn)([(0,L.e)(N.a),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===v?Object:v,void 0===U?Object:U])],k);var j=i(56778),G=i(72233),V=i(34365);class M{execute({body:{itemTypes:e,domain:t,sorting:i,filters:s,pagination:r}}){return this.autofillDataRepository.getAutofillData(e,void 0,i,s,r?.pageSize,r?.pageNumber).pipe((0,P.h)(e=>(0,d.d6)(e)),(0,j.q)(1),(0,x.w)(i=>this.autofillDataService.getAutofillViewForItems(e,i,t)),(0,G.K)(e=>{throw Error("get-multiple-autofill-data: error occured while mapping to autofill views: "+e)}),(0,a.U)(e=>e.reduce((e,t)=>({items:[...e.items,...t.items],count:e.count+t.count}),{items:[],count:0})),(0,a.U)(d.Vp))}constructor(e,t){this.autofillDataRepository=e,this.autofillDataService=t}}M=(0,s.gn)([(0,L.e)(V.N),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===v?Object:v,void 0===U?Object:U])],M);var K=i(89809);class W{execute({body:{searchQuery:e,itemTypes:t,domain:i,sorting:s,pagination:r,needDashlaneLinkedWebsites:n}}){let c=t??[...Object.values(o.k).filter(e=>e!==o.k.GeneratedPassword)];return this.autofillDataRepository.searchAutofillData(e,t,s,r?.pageSize,r?.pageNumber,n).pipe((0,P.h)(e=>(0,d.d6)(e)),(0,x.w)(e=>this.autofillDataService.getAutofillViewForItems(c,e,i)),(0,G.K)(e=>{throw Error("search-autofill-data: error occured while mapping to autofill views: "+e)}),(0,a.U)(e=>e.reduce((e,t)=>({items:[...e.items,...t.items],count:e.count+t.count}),{items:[],count:0})),(0,a.U)(d.Vp))}constructor(e,t){this.autofillDataRepository=e,this.autofillDataService=t}}W=(0,s.gn)([(0,L.e)(K.w),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===v?Object:v,void 0===U?Object:U])],W);class z{}z=(0,s.gn)([(0,r.Y)({api:n.c,handlers:{commands:{},events:{},queries:{getSingleAutofillData:k,getMultipleAutofillData:M,searchAutofillData:W}},providers:[v,U]})],z)},59317:function(e,t,i){i.d(t,{V:()=>h});var s=i(21636),r=i(48035),n=i(41908),a=i(17507),o=i(94190);class c extends a.f{}c=(0,s.gn)([(0,o.GS)()],c);var d=i(37368),l=i(306),u=i(72895);class p{execute({body:e}){let{credentialId:t}=e;return t&&this.autofillTrackingEventsEmitter.sendEvent("passwordAutofillPerformed",{credentialId:t}),Promise.resolve((0,l.Vp)(void 0))}constructor(e){this.autofillTrackingEventsEmitter=e}}p=(0,s.gn)([(0,d.W)(u.q),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===c?Object:c])],p);class h{}h=(0,s.gn)([(0,r.Y)({api:n.Y,handlers:{commands:{temporaryEmitPasswordAutofillPerformedEvent:p},events:{},queries:{}},providers:[c]})],h)},77510:function(e,t,i){i.d(t,{A:()=>R});var s=i(21636),r=i(89797),n=i(48035),a=i(79869),o=i(22104),c=i(1833),d=i(21958),l=i(48194),u=i(72211),p=i(96752),h=i(20394),g=i(49247),m=i(62506),v=i(9810),y=i(94680),w=i(306);class S{execute(e){let{passkeys:t}=this.enclaveApiClient,i=t.registerPasskey(e.body),s=this.carbonLegacyClient.queries.getSpaces();return(0,c.D)(i).pipe((0,d.V)(s),(0,l.z)(async([t,i])=>{if((0,w.hx)(t))switch(t.error.code){case v.r.SECURITY_ERROR:return(0,w.Rn)((0,u.Hn)());case v.r.INVALID_STATE_ERROR:return(0,w.Rn)((0,u.hl)());case v.r.ALGORITHM_NOT_SUPPORTED_ERROR:return(0,w.Rn)((0,u.qc)());default:return(0,w.Rn)((0,u.QY)())}if((0,w.hx)(i))return(0,w.Rn)((0,u.QY)());let{passkeyId:s,encryptionKey:r,credentialRegisterData:n}=t.data,a=(i.data.length>1?i.data:[]).find(e=>""!==e.spaceId),o=a?.settings.enableForcedCategorization?a.spaceId:"",c=await this.carbonLegacyClient.commands.addPasskey({credentialId:n.id,rpId:e.body.request.options.rp.id,rpName:e.body.request.options.rp.name,userHandle:e.body.request.options.user.id,userDisplayName:e.body.request.options.user.displayName,counter:0,spaceId:o,keyAlgorithm:h.aG.CloudPasskey,cloudPasskey:{PasskeyId:s,PasskeyEncryptionKeyId:r.uuid,PasskeyEncryptionKey:r.key}});return(0,w.hx)(c)||!c.data.success?(0,w.Rn)((0,u.QY)()):(0,w.Vp)({id:c.data.id,credentialRegisterData:t.data.credentialRegisterData})}))}constructor(e,t){this.carbonLegacyClient=e,this.enclaveApiClient=t}}S=(0,s.gn)([(0,m.e)(p.E),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===g._?Object:g._,void 0===y.l?Object:y.l])],S);var f=i(44577),E=i(11105),I=i(57178),b=i(79755),A=i(47244);class C{async usePasskey(e){let{id:t,request:i}=e,{passkeys:s}=this.enclaveApiClient,{query:r}=this.vaultClient.queries,n=await (0,f.z)(r({vaultItemTypes:[I.U.Passkey],ids:[t]}));if((0,w.hx)(n)||1!==n.data.passkeysResult.items.length)throw Error("UsePasskeyQuery: no vault item corresponding to the provided id");let a=n.data.passkeysResult.items[0];if(!(0,b.T5)(a))throw Error("UsePasskeyQuery: passkey is not a cloud passkey");let o=await s.usePasskey({passkeyId:a.cloudPasskey.PasskeyId,encryptionKey:{key:a.cloudPasskey.PasskeyEncryptionKey,uuid:a.cloudPasskey.PasskeyEncryptionKeyId},request:i});if((0,w.hx)(o))switch(o.error.code){case v.r.SECURITY_ERROR:return(0,w.Rn)((0,u.Hn)());case v.r.INVALID_STATE_ERROR:case v.r.PASSKEY_NOT_FOUND:case v.r.PASSKEY_DECRYPTION_ERROR:return(0,w.Rn)((0,u.hl)());case v.r.ALGORITHM_NOT_SUPPORTED_ERROR:return(0,w.Rn)((0,u.qc)());default:return(0,w.Rn)((0,u.QY)())}return this.carbonLegacyClient.commands.updatePasskey({id:t}),o}execute(e){return(0,c.D)(this.usePasskey(e.body))}constructor(e,t,i){this.vaultClient=e,this.carbonLegacyClient=t,this.enclaveApiClient=i}}C=(0,s.gn)([(0,m.e)(E.w),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===A.L?Object:A.L,void 0===g._?Object:g._,void 0===y.l?Object:y.l])],C);class R{}R=(0,s.gn)([(0,n.Y)({api:r.a,handlers:{commands:{},events:{},queries:{registerPasskey:S,usePasskey:C}},imports:[a.X,o.G],providers:[],requiredFeatureFlips:[]})],R)},8179:function(e,t,i){i.d(t,{J:()=>j});var s=i(21636),r=i(48035),n=i(74677),a=i(69853),o=i(42589),c=i(44577),d=i(13477),l=i(49247),u=i(83463),p=i(94190),h=i(306),g=i(22789),m=i(52327),v=i(57301);let y=e=>Object.keys(e).map(t=>[t].concat(e[t])),w=(e,t)=>e.some(e=>t.includes(e)),S=e=>[...new Set(e)].filter(Boolean),f=e=>[...e].sort(),E=(e,t)=>e.length===t.length&&f(e).join("")===f(t).join("");var I=i(69982),b=i(57178),A=i(47244);class C{getDashlaneDefinedLinkedWebsites$(e){return(0,a.of)(this._getDashlaneDefinedLinkedWebsites(e)).pipe((0,o.U)(h.Vp))}getDashlaneDefinedLinkedWebsitesByList$(e){return(0,a.of)(this._getDashlaneDefinedLinkedWebsitesByList(e)).pipe((0,o.U)(h.Vp))}constructor(e,t){this.carbonLegacyClient=e,this.vaultItemsCrudClient=t,this.updateLinkedWebsites=async(e,t)=>{let i=await this.getCredentialById(t),s=this.getUserAddedLinkedWebsiteDomains(i),r=S(e);if(E(s,r))return;let n=0===r.length?[]:this.mergeLinkedWebsites(i,s,r),a={...i.LinkedServices,associated_domains:n},o=await this.carbonLegacyClient.commands.carbon({name:"updateCredential",args:[{id:t,update:{linkedServices:a}}]});if((0,h.hx)(o))throw Error("Error when updating linked websites using updateCredential query from Carbon")},this.getCredentialByIdGraphene=e=>(0,c.z)(this.vaultItemsCrudClient.queries.query({vaultItemTypes:[b.U.Credential],ids:[e]}).pipe((0,o.U)(e=>(0,h.d6)(e)&&1===e.data.credentialsResult.matchCount?e.data.credentialsResult.items[0]:null))),this.populateDashlaneDefinedLinkedWebsitesIndex=e=>{let t={};return e.forEach(e=>{e.forEach(i=>{t[i]=e})}),t},this.mergeLinkedDomainsIntoList=(e,t)=>{let i=[],s=[];e.forEach(e=>w(e,t)?i.push(e):s.push(e));let r=i.concat([t]).flat();return s.concat([r])},this.reduceLinkedDomainsLists=(e,t,i)=>e.concat(t,i).reduce(this.mergeLinkedDomainsIntoList,[]),this._getDashlaneDefinedLinkedWebsites=e=>{let t=new u.Y(e).getRootDomain();return t?this.allDashlaneDefinedLinkedWebsitesIndex[t]||[t]:[]},this._getDashlaneDefinedLinkedWebsitesByList=e=>e.map(e=>this._getDashlaneDefinedLinkedWebsites(e)),this.getCredentialById=e=>{let{carbonState:t}=this.carbonLegacyClient.queries;return(0,c.z)(t({path:"userSession.personalData.credentials"}).pipe((0,o.U)(t=>{if(!(0,h.d6)(t)||!(0,I.A)(t.data))throw Error("Bad credential format");let i=t.data.find(t=>t.Id===e);if(i)return i;throw Error("Cannot find credential")})))},this.getUserAddedLinkedWebsiteDomains=e=>e.LinkedServices?.associated_domains?.flatMap(({domain:e})=>e||[])??[],this.getNewLinkedWebsitesToAdd$=(e,t)=>t.filter(t=>!e.includes(t)).map(this.linkedWebsiteFormatter),this.linkedWebsiteFormatter=e=>({domain:e,source:d.k.Manual}),this.mergeLinkedWebsites=(e,t,i)=>[...(e.LinkedServices?.associated_domains??[]).filter(e=>i.includes(e.domain)),...this.getNewLinkedWebsitesToAdd$(t,i)],this.allDashlaneDefinedLinkedWebsitesIndex=this.populateDashlaneDefinedLinkedWebsitesIndex(this.reduceLinkedDomainsLists(g,y(v),y(m)).map(e=>[...new Set(e)]))}}C=(0,s.gn)([(0,p.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===l._?Object:l._,void 0===A.L?Object:A.L])],C);var R=i(37368),_=i(30459);class O{async execute({body:{credentialId:e,linkedWebsite:t}}){let i=await this.repository.getCredentialByIdGraphene(e);if(!i)return(0,h.Rn)((0,_.i6)());if(i.linkedURLs.find(e=>e===t))return(0,h.Rn)((0,_.lD)());let s=await this.vaultItemsCrudClient.commands.updateVaultItem({vaultItemType:b.U.Credential,id:e,content:{linkedURLs:[...i.linkedURLs,t]}});return(0,h.hx)(s)?(0,h.Rn)((0,_.R6)()):(0,h.Vp)(void 0)}constructor(e,t){this.repository=e,this.vaultItemsCrudClient=t}}O=(0,s.gn)([(0,R.W)(_.vp),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===C?Object:C,void 0===A.L?Object:A.L])],O);var T=i(21234);class F{async execute({body:{credentialId:e,linkedWebsite:t}}){let i=await this.repository.getCredentialByIdGraphene(e);if(!i)return(0,h.Rn)((0,T.W4)());let s=await this.vaultItemsCrudClient.commands.updateVaultItem({vaultItemType:b.U.Credential,id:e,content:{linkedURLs:[...i.linkedURLs.filter(e=>e!==t)]}});return(0,h.hx)(s)?(0,h.Rn)((0,T.cQ)()):(0,h.Vp)(void 0)}constructor(e,t){this.repository=e,this.vaultItemsCrudClient=t}}F=(0,s.gn)([(0,R.W)(T.M7),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===C?Object:C,void 0===A.L?Object:A.L])],F);var D=i(43182);class U{async execute({body:{credentialId:e,updatedLinkedWebsitesList:t}}){try{return await this.linkedWebsites.updateLinkedWebsites(t,e),(0,h.Vp)(void 0)}catch(e){return(0,h.Rn)({tag:"",error:e instanceof Error?e:Error("Update linked websites command failed")})}}constructor(e){this.linkedWebsites=e}}U=(0,s.gn)([(0,R.W)(D.A),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===C?Object:C])],U);var P=i(62506),x=i(56103);class N{execute({body:{url:e=""}}){return this.linkedWebsites.getDashlaneDefinedLinkedWebsites$(e)}constructor(e){this.linkedWebsites=e}}N=(0,s.gn)([(0,P.e)(x.J),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===C?Object:C])],N);var L=i(77660);class k{execute({body:{urls:e}}){return this.linkedWebsites.getDashlaneDefinedLinkedWebsitesByList$(e)}constructor(e){this.linkedWebsites=e}}k=(0,s.gn)([(0,P.e)(L.E),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===C?Object:C])],k);class j{}j=(0,s.gn)([(0,r.Y)({api:n.G,handlers:{commands:{addLinkedWebsite:O,removeLinkedWebsite:F,updateLinkedWebsites:U},events:{},queries:{getDashlaneDefinedLinkedWebsites:N,getMultipleDashlaneDefinedLinkedWebsites:k}},providers:[C]})],j)},11671:function(e,t,i){i.d(t,{r:()=>b});var s=i(21636),r=i(13473),n=i(82541),a=i(48035),o=i(37368),c=i(306),d=i(43754),l=i(94190),u=i(59982),p=i(68238),h=i(15021),g=i(20458);let m=e=>void 0!==e&&"boolean"==typeof e;class v extends(0,u.Q)({persist:!0,storage:{initialValue:!1,typeGuard:m,schemaVersion:1},scope:h.F.User,storeName:"autofill-disabled-notification",capacity:p.Y._001KB,codec:g.E}){}class y{get autofillDisabledOnLoginsAndFormsNotificationStatus(){return{get$:this._getAutofillDisabledOnLoginsAndFormsNotificationStatus$,set:this._setAutofillDisabledOnLoginsAndFormsNotificationStatus.bind(this)}}get _getAutofillDisabledOnLoginsAndFormsNotificationStatus$(){return this.store.state$}async _setAutofillDisabledOnLoginsAndFormsNotificationStatus(e){try{await this.store.set(e)}catch{throw Error("SetAutofillDisabledOnLoginsAndFormsNotificationStatus command from autofill-core failed")}}constructor(e){this.store=e}}y=(0,s.gn)([(0,l.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[v])],y);class w{async execute({body:e}){let{status:t}=e;return await this.autofillDisabledNotificationRepository.autofillDisabledOnLoginsAndFormsNotificationStatus.set(t),(0,c.Vp)(void 0)}constructor(e){this.autofillDisabledNotificationRepository=e}}w=(0,s.gn)([(0,o.W)(d.a),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===y?Object:y])],w);var S=i(42589),f=i(62506),E=i(62921);class I{execute(){return this.repository.autofillDisabledOnLoginsAndFormsNotificationStatus.get$.pipe((0,S.U)(c.Vp))}constructor(e){this.repository=e}}I=(0,s.gn)([(0,f.e)(E.z),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===y?Object:y])],I);class b{}b=(0,s.gn)([(0,a.Y)({api:r._,handlers:{commands:{setAutofillDisabledOnLoginsAndFormsNotificationStatus:w},events:{},queries:{getAutofillDisabledOnLoginsAndFormsNotificationStatus:I}},stores:[v],providers:[y],requiredFeatureFlips:Object.values(n.S)})],b)},86836:function(e,t,i){i.d(t,{k:()=>G});var s=i(21636),r=i(52562),n=i(82541),a=i(48035),o=i(37368),c=i(306),d=i(55406),l=i(44577),u=i(94190),p=i(59982),h=i(68238),g=i(15021),m=i(20458);let v=e=>!!e&&"object"==typeof e&&Object.values(e).every(e=>Array.isArray(e))&&Object.keys(e).every(e=>"string"==typeof e);class y extends(0,p.Q)({persist:!0,storage:{initialValue:{},typeGuard:v,schemaVersion:1},scope:g.F.User,storeName:"phishing-prevention-optouts",capacity:h.Y._010KB,codec:m.E}){}class w{get phishingPreventionOptOuts(){return{get$:this._getPhishingPreventionOptOuts$,set$:this._setPhishingPreventionOptOut.bind(this)}}async disablePhishingPreventionForUrl(e,t){let i=await (0,l.z)(this._getPhishingPreventionOptOuts$),s={...i,[e]:Array.from(new Set(i[e]??[]).add(t))};await this._setPhishingPreventionOptOut(s)}get _getPhishingPreventionOptOuts$(){return this.store.state$}async _setPhishingPreventionOptOut(e){try{await this.store.set(e)}catch{throw Error("SetPhishingPreventionOptOut command from autofill-core has failed")}}constructor(e){this.store=e}}w=(0,s.gn)([(0,u.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[y])],w);class S{async execute({body:{credentialUrl:e,pasteDestinationUrl:t}}){return await this.phishingPreventionRepository.disablePhishingPreventionForUrl(e,t),(0,c.Vp)(void 0)}constructor(e){this.phishingPreventionRepository=e}}S=(0,s.gn)([(0,o.W)(d.z),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===w?Object:w])],S);var f=i(62506),E=i(4880),I=i(42589),b=i(36884),A=i(69853),C=i(49247),R=i(52031),_=i(94450),O=i(69982);class T{getIsVaultItemProtected$(e,t){return this._isVaultItemProtected(e,t).pipe((0,I.U)(c.Vp))}getIsPhishingPreventionEnabled$(){return this._isPhishingPreventionEnabled().pipe((0,I.U)(c.Vp))}getIsInAppNudgesEnabled$(){return this._isInAppNudgesEnabled().pipe((0,I.U)(c.Vp))}constructor(e){this.carbonLegacyClient=e,this.isUserSSO=()=>{let{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.localSettings.premiumStatus"}).pipe((0,I.U)(e=>{if(!(0,c.d6)(e))throw Error("Cannot retrieve premium status");return e.spaces}),(0,I.U)(e=>e?.[0].isSSOUser??!1))},this.areProtectedItemsUnlocked=()=>{let{carbonState:e}=this.carbonLegacyClient.queries;return(0,b.a)([e({path:"userSession.session.lastMasterPasswordCheck"}),e({path:"userSession.account.login"})]).pipe((0,I.U)(([e,t])=>{if(!(0,c.d6)(e)||"number"!=typeof e.data)throw Error("Cannot retrieve last master password check");if(!(0,c.d6)(t)||"string"!=typeof t.data)throw Error("No active login");let i=e.data,s=t.data;return Date.now()-i<(/^kw_test_auto_fmpc_.*/.test(s)?5e3:3e5)}))},this.isItemUnlocked=()=>(0,b.a)([this.areProtectedItemsUnlocked(),this.isUserSSO()]).pipe((0,I.U)(([e,t])=>e||t)),this.isGlobalCredentialProtectionSettingOn=()=>{let{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.personalSettings.ProtectPasswords"}).pipe((0,I.U)(e=>{if(!(0,c.d6)(e)||"boolean"!=typeof e.data)throw Error("No global setting found");return e.data}))},this.getCredentialProtectionStatus=e=>{let{carbonState:t}=this.carbonLegacyClient.queries;return t({path:"userSession.personalData.credentials"}).pipe((0,I.U)(t=>{if(!(0,c.d6)(t)||!(0,O.A)(t.data))throw Error("Bad credential format");let i=t.data;return i.find(t=>t.Id===e)?.AutoProtected??!1}))},this.getIsMPRequiredForCreditCardOrSocialSecurityId=()=>{let{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.personalSettings.SecuredDataAutofillCreditcard"}).pipe((0,I.U)(e=>!(0,c.d6)(e)||"boolean"!=typeof e.data||e.data))},this._isVaultItemProtected=(e,t)=>e===R.k.PaymentCard||e===R.k.SocialSecurityId?(0,b.a)([this.isItemUnlocked(),this.getIsMPRequiredForCreditCardOrSocialSecurityId()]).pipe((0,I.U)(([e,t])=>({disableMode:_.M.CannotDisable,isProtected:t&&!e}))):e===R.k.Credential?(0,b.a)([this.isItemUnlocked(),this.isGlobalCredentialProtectionSettingOn(),this.getCredentialProtectionStatus(t)]).pipe((0,I.U)(([e,t,i])=>t?{disableMode:_.M.DisableGeneralSetting,isProtected:!e}:{disableMode:_.M.DisableSpecificVaultItem,isProtected:i&&!e})):(0,A.of)({disableMode:_.M.CannotDisable,isProtected:!1}),this._isPhishingPreventionEnabled=()=>{let{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.localSettings.nodePremiumStatus"}).pipe((0,I.U)(e=>{if(!(0,c.d6)(e))throw Error("Cannot retrieve premium status");let t=e.data;return t.capabilities?.autofillWithPhishingPrevention.enabled??!1}))},this._isInAppNudgesEnabled=()=>{let{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.localSettings.nodePremiumStatus"}).pipe((0,I.U)(e=>{if(!(0,c.d6)(e))throw Error("Cannot retrieve premium status");let t=e.data;return t.capabilities?.inAppNudges.enabled??!1}))}}}T=(0,s.gn)([(0,u.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===C._?Object:C._])],T);class F{execute({body:e}){let{vaultItemId:t,vaultType:i}=e;return this.autofillSecurity.getIsVaultItemProtected$(i,t)}constructor(e){this.autofillSecurity=e}}F=(0,s.gn)([(0,f.e)(E.u),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===T?Object:T])],F);var D=i(3180);class U{execute(){return this.autofillSecurity.getIsPhishingPreventionEnabled$()}constructor(e){this.autofillSecurity=e}}U=(0,s.gn)([(0,f.e)(D.i),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===T?Object:T])],U);var P=i(16787);class x{execute({body:{credentialUrl:e,pasteDestinationUrl:t}}){return this.phishingPreventionRepository.phishingPreventionOptOuts.get$.pipe((0,I.U)(i=>e in i&&(i[e]??[]).includes(t)),(0,I.U)(c.Vp))}constructor(e){this.phishingPreventionRepository=e}}x=(0,s.gn)([(0,f.e)(P.v),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===w?Object:w])],x);var N=i(29585);class L{execute(){return this.autofillSecurity.getIsInAppNudgesEnabled$()}constructor(e){this.autofillSecurity=e}}L=(0,s.gn)([(0,f.e)(N.P),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===T?Object:T])],L);var k=i(45685);class j{async execute(){let{carbon:e}=this.carbonLegacyClient.commands,t=await e({name:"resetProtectedItemAutofillTimer",args:[]});return(0,c.hx)(t)?(0,c.Rn)({tag:"ResetProtectedItemAutofillTimer command from autofill/security failed"}):(0,c.Vp)(void 0)}constructor(e){this.carbonLegacyClient=e}}j=(0,s.gn)([(0,o.W)(k.y),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===C._?Object:C._])],j);class G{}G=(0,s.gn)([(0,a.Y)({api:r.V,handlers:{commands:{resetProtectedItemAutofillTimer:j,disablePhishingPreventionForUrl:S},events:{},queries:{getAutofillProtectionContext:F,isPhishingPreventionCapabilityEnabled:U,isPhishingPreventionDisabledForUrl:x,isInAppNudgesEnabled:L}},stores:[y],providers:[T,w],requiredFeatureFlips:Object.values(n.S)})],G)},69982:function(e,t,i){i.d(t,{A:()=>r});var s=i(71749);let r=e=>Array.isArray(e)&&e.every(e=>null!==e&&"object"==typeof e&&"kwType"in e&&(0,s.G)(e))},7132:function(e,t,i){i.d(t,{P:()=>eE});var s=i(21636),r=i(65430),n=i(82541),a=i(48035),o=i(37368),c=i(306),d=i(79401),l=i(44577),u=i(42589),p=i(14564),h=i(49247),g=i(94190),m=i(97401),v=i(18550);let y=e=>!!e&&"object"==typeof e&&(0,v.l$)(e,"isAutofillDisabled")&&"boolean"==typeof e.isAutofillDisabled&&(0,v.l$)(e,"isAutologinDisabled")&&"boolean"==typeof e.isAutologinDisabled&&(0,v.l$)(e,"disabledSourceTypes")&&(0,m.rF)(e.disabledSourceTypes)&&(0,v.l$)(e,"disabledDomains")&&Array.isArray(e.disabledDomains)&&e.disabledDomains.every(e=>"string"==typeof e)&&(0,v.l$)(e,"isFollowUpNotificationEnabled")&&"boolean"==typeof e.isFollowUpNotificationEnabled;var w=i(69982),S=i(57178);class f{get credentialsPreferences(){return{getByIds:this._getPreferencesForCredentials$.bind(this),set:this._setCredentialPreferences.bind(this)}}get isAutofillDisabled(){return{get$:this._getIsAutofillDisabled$,set:this._setIsAutofillDisabled.bind(this)}}get isAutologinDisabled(){return{get$:this._getIsAutologinDisabled$,set:this._setIsAutologinDisabled.bind(this)}}get disabledDomains(){return{get$:this._getDisabledDomains$,set:this._setDisabledDomains.bind(this),add:this._addDisabledDomains.bind(this),remove:this._removeDisabledDomains.bind(this)}}get disabledSourceTypes(){return{get$:this._getDisabledSourceTypes$,set:this._setDisabledSourceTypes.bind(this),add:this._addDisabledSourceTypes.bind(this),remove:this._removeDisabledSourceTypes.bind(this)}}get isFollowUpNotificationEnabled(){return{get$:this._getIsFollowUpNotificationEnabled$,set:this._setIsFollowUpNotificationEnabled.bind(this)}}async _updateSettings(e){let t=e.isAutofillDisabled??await (0,l.z)(this._getIsAutofillDisabled$),i=e.isAutologinDisabled??await (0,l.z)(this._getIsAutologinDisabled$),s=e.disabledDomains??await (0,l.z)(this._getDisabledDomains$),r=e.disabledSourceTypes??await (0,l.z)(this._getDisabledSourceTypes$),n=e.isFollowUpNotificationEnabled??await (0,l.z)(this._getIsFollowUpNotificationEnabled$),a=await this.carbonLegacyClient.commands.carbon({name:"updateAutofillSettings",args:[{AutofillSettings:{disabledDomains:s,disabledSourceTypes:r,isAutofillDisabled:t,isAutologinDisabled:i,isFollowUpNotificationEnabled:n}}]});if((0,c.hx)(a))throw Error("Error when updating autofill settings using updateAutofillSettings query from Carbon")}get _getAutofillSettings$(){let{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.personalSettings.AutofillSettings"}).pipe((0,u.U)(e=>{if(!(0,c.d6)(e)||!y(e.data))throw Error("AutofillSettings is not of the expected type");return e.data}),(0,p.d)(1))}async _setCredentialPreferences({credentialId:e,credentialUrl:t,onlyAutofillExactDomain:i,requireMasterPassword:s,useAutoLogin:r,shouldSkipSync:n}){let{carbonLegacyLeeloo:a}=this.carbonLegacyClient.commands,o=await a({name:"savePersonalDataItem",arg:[{kwType:S.U.Credential,origin:"MANUAL",content:{id:e,url:t,onlyForThisSubdomain:i,autoLogin:r,protectWithMasterPassword:s},shouldSkipSync:n}]});if((0,c.hx)(o))throw Error(`Failed to update credential preferences for: ${e}`)}_getPreferencesForCredentials$(e){let{carbonState:t}=this.carbonLegacyClient.queries;return t({path:"userSession.personalData.credentials"}).pipe((0,u.U)(t=>{if((0,c.hx)(t)||!(0,w.A)(t.data))throw Error("Bad credentials format when retrieving credential preferences");let i=e.length?t.data.filter(t=>e.includes(t.Id)):t.data;if(e.length&&i.length!==e.length)throw Error("not able to find one or more credentials corresponding to the provided ids");return(0,c.Vp)(i.map(e=>({id:e.Id,useAutoLogin:!!e.AutoLogin,onlyAutofillExactDomain:!!e.SubdomainOnly,requireMasterPassword:!!e.AutoProtected})))}))}get _getIsAutofillDisabled$(){return this._getAutofillSettings$.pipe((0,u.U)(({isAutofillDisabled:e})=>e))}_setIsAutofillDisabled(e){return this._updateSettings({isAutofillDisabled:e})}get _getIsAutologinDisabled$(){return this._getAutofillSettings$.pipe((0,u.U)(({isAutologinDisabled:e})=>e))}_setIsAutologinDisabled(e){return this._updateSettings({isAutologinDisabled:e})}_setIsFollowUpNotificationEnabled(e){return this._updateSettings({isFollowUpNotificationEnabled:e})}get _getDisabledDomains$(){return this._getAutofillSettings$.pipe((0,u.U)(({disabledDomains:e})=>e))}_setDisabledDomains(e){return this._updateSettings({disabledDomains:e})}async _addDisabledDomains(e){let t=await (0,l.z)(this._getDisabledDomains$);return this._setDisabledDomains([...new Set([...t,...e])])}async _removeDisabledDomains(e){let t=await (0,l.z)(this._getDisabledDomains$);return this._setDisabledDomains(t.filter(t=>!e.includes(t)))}get _getDisabledSourceTypes$(){return this._getAutofillSettings$.pipe((0,u.U)(({disabledSourceTypes:e})=>e))}_setDisabledSourceTypes(e){return this._updateSettings({disabledSourceTypes:e})}async _addDisabledSourceTypes(e){let t=await (0,l.z)(this._getDisabledSourceTypes$);return this._setDisabledSourceTypes([...new Set([...t,...e])])}async _removeDisabledSourceTypes(e){let t=await (0,l.z)(this._getDisabledSourceTypes$);return this._setDisabledSourceTypes(t.filter(t=>!e.includes(t)))}get _getIsFollowUpNotificationEnabled$(){return this._getAutofillSettings$.pipe((0,u.U)(({isFollowUpNotificationEnabled:e})=>e))}constructor(e){this.carbonLegacyClient=e}}f=(0,s.gn)([(0,g.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h._?Object:h._])],f);class E{async execute({body:{sourceTypes:e}}){return await this.settings.disabledSourceTypes.add(e),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}E=(0,s.gn)([(0,o.W)(d.g),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],E);var I=i(81945);class b{async execute(){return await this.settings.isAutofillDisabled.set(!0),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}b=(0,s.gn)([(0,o.W)(I.u),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],b);var A=i(57579);class C{async execute(){return await this.settings.disabledSourceTypes.add([...m.up]),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}C=(0,s.gn)([(0,o.W)(A.t),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],C);var R=i(99123);class _{async execute(){return await this.settings.disabledSourceTypes.add([...m.q_]),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}_=(0,s.gn)([(0,o.W)(R.f),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],_);var O=i(90163);class T{async execute(){return await this.settings.isAutologinDisabled.set(!0),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}T=(0,s.gn)([(0,o.W)(O.T),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],T);var F=i(71925);class D{async execute(){return await this.settings.isFollowUpNotificationEnabled.set(!1),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}D=(0,s.gn)([(0,o.W)(F.y),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],D);var U=i(91840);class P{async execute(){return await this.settings.isAutofillDisabled.set(!1),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}P=(0,s.gn)([(0,o.W)(U.c),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],P);var x=i(83116);class N{async execute(){return await this.settings.disabledSourceTypes.remove([...m.up]),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}N=(0,s.gn)([(0,o.W)(x.a),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],N);var L=i(52781);class k{async execute(){return await this.settings.disabledSourceTypes.remove([...m.q_]),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}k=(0,s.gn)([(0,o.W)(L.I),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],k);var j=i(18306);class G{async execute(){return await this.settings.isAutologinDisabled.set(!1),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}G=(0,s.gn)([(0,o.W)(j.i),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],G);var V=i(40741);class M{async execute(){return await this.settings.isFollowUpNotificationEnabled.set(!0),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}M=(0,s.gn)([(0,o.W)(V.B),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],M);var K=i(79931);class W{async execute({body:{sourceTypes:e}}){return await this.settings.disabledSourceTypes.remove(e),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}W=(0,s.gn)([(0,o.W)(K.v),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],W);var z=i(5596),q=i(74791),B=i(59982),Y=i(68238),Q=i(15021),H=i(20458);let $=e=>!!e&&(0,q.P)(e);class X extends(0,B.Q)({persist:!0,storage:{initialValue:[],typeGuard:$,schemaVersion:1},scope:Q.F.Device,storeName:"user-autofill-corrections",capacity:Y.Y._100KB,codec:H.E}){}class Z{get userAutofillCorrections(){return{get$:this._getUserAutofillCorrections$,set:this._setUserAutofillCorrections.bind(this)}}get _getUserAutofillCorrections$(){return this.store.state$}async _setUserAutofillCorrections(e){try{await this.store.set(e)}catch{throw Error("SetUserAutofillCorrections command from core-autofill failed")}}constructor(e){this.store=e}}Z=(0,s.gn)([(0,g.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[X])],Z);class J{async execute({body:e}){let{corrections:t}=e;return await this.correctionsRepository.userAutofillCorrections.set(t),(0,c.Vp)(void 0)}constructor(e){this.correctionsRepository=e}}J=(0,s.gn)([(0,o.W)(z.S),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===Z?Object:Z])],J);var ee=i(27733);class et{async execute({body:e}){let{isAutofillEnabled:t,url:i}=e,{carbon:s}=this.carbonLegacyClient.commands,r=await s({name:"toggleDashlane",args:[{where:"site",autofill:t,autologin:t,url:i}]});if((0,c.hx)(r))throw Error("Toggle Dashlane command from core-autofill failed");return(0,c.Vp)(void 0)}constructor(e){this.carbonLegacyClient=e}}et=(0,s.gn)([(0,o.W)(ee.r),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h._?Object:h._])],et);var ei=i(68141);class es{async execute({body:e}){try{return await this.autofillSettings.credentialsPreferences.set(e),(0,c.Vp)(void 0)}catch(t){let e=t instanceof Error?t.message:"unable to update credential preferences";return(0,c.Rn)({tag:"error",errorMessage:e})}}constructor(e){this.autofillSettings=e}}es=(0,s.gn)([(0,o.W)(ei.J),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],es);var er=i(36884),en=i(72907),ea=i(62506),eo=i(83463),ec=i(76794);let ed=e=>!!e&&"object"==typeof e&&Array.isArray(e)&&e.every(e=>(0,v.l$)(e,"details")&&(0,v.l$)(e.details,"info")),el=e=>!!e&&"object"==typeof e&&(0,v.l$)(e,"status")&&"number"==typeof e.status,eu=e=>{if(!el(e))throw Error("twoFactorAuthentication is not of the expected type");return 3===e.status&&e.shouldEnforceTwoFactorAuthentication},ep=e=>!!e&&"object"==typeof e&&Array.isArray(e)&&e.every(e=>"string"==typeof e),eh=e=>"boolean"==typeof e;class eg{execute({body:{url:e}}){let{carbonState:t}=this.carbonLegacyClient.queries,i=new eo.Y(e),s=i.getRootDomain(),r=i.getHost(),n=t({path:"device.killswitch.disableAutofill"}).pipe((0,u.U)(e=>{if(!(0,c.d6)(e)||!eh(e.data))throw Error("Error when fetching killswitch.disableAutofill");return e.data})),a=(0,er.a)({isAutofillDisabled:this.settings.isAutofillDisabled.get$,disabledDomains:this.settings.disabledDomains.get$}).pipe((0,en.w)(async({isAutofillDisabled:e,disabledDomains:t})=>e||t.includes(await s))),o=t({path:"userSession.spaceData.spaces"}).pipe((0,en.w)(async e=>{if(!(0,c.d6)(e)||!ed(e.data))throw Error("Error when fetching spaceData.spaces");let t=e.data.reduce((e,t)=>{let i=t.details.info.autologinDomainDisabledArray;return[...e,...ep(i)?i:[]]},[]),i=await r;return t.some(e=>{let t=new eo.Y(e).getHost();return t===i||i.endsWith(`.${t}`)})})),d=t({path:"authentication.twoFactorAuthentication"}).pipe((0,u.U)(e=>{if(!(0,c.d6)(e))throw Error("Error when fetching authentication.twoFactorAuthentication");return eu(e.data)}));return(0,er.a)({isAutofillDisabledByB2BAdmin:o,isAutofillDisabledByKillswitch:n,isAutofillDisabledByUser:a,isAutofillDisabledBy2FAEnforcement:d}).pipe((0,u.U)(({isAutofillDisabledBy2FAEnforcement:e,isAutofillDisabledByB2BAdmin:t,isAutofillDisabledByKillswitch:i,isAutofillDisabledByUser:s})=>{let r=ec._.ANALYSIS_ENABLED;return i?r=ec._.ANALYSIS_DISABLED_BY_KILLSWITCH:t?r=ec._.ANALYSIS_DISABLED_BY_B2B_ADMIN:s?r=ec._.ANALYSIS_DISABLED_BY_USER:e&&(r=ec._.ANALYSIS_DISABLED_BY_2FA_ENFORCEMENT),(0,c.Vp)({analysisStatus:r})}))}constructor(e,t){this.carbonLegacyClient=e,this.settings=t}}eg=(0,s.gn)([(0,ea.e)(ec.h),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h._?Object:h._,void 0===f?Object:f])],eg);var em=i(96203);class ev{execute(){return(0,er.a)({disabledDomains:this.settings.disabledDomains.get$,disabledSourceTypes:this.settings.disabledSourceTypes.get$,isAutofillDisabled:this.settings.isAutofillDisabled.get$,isAutologinDisabled:this.settings.isAutologinDisabled.get$,isFollowUpNotificationEnabled:this.settings.isFollowUpNotificationEnabled.get$}).pipe((0,u.U)(c.Vp))}constructor(e){this.settings=e}}ev=(0,s.gn)([(0,ea.e)(em.T),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],ev);var ey=i(90994);class ew{execute(){return this.settings.userAutofillCorrections.get$.pipe((0,u.U)(c.Vp))}constructor(e){this.settings=e}}ew=(0,s.gn)([(0,ea.e)(ey.w),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===Z?Object:Z])],ew);var eS=i(1985);class ef{execute({body:{credentialIds:e=[]}}){return this.autofillSettingsRepository.credentialsPreferences.getByIds(e)}constructor(e){this.autofillSettingsRepository=e}}ef=(0,s.gn)([(0,ea.e)(eS.g),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f?Object:f])],ef);class eE{}eE=(0,s.gn)([(0,a.Y)({api:r.I,handlers:{commands:{toggleDashlane:et,enableAnalysis:P,enableAutologin:G,enableAutofillOnForms:N,enableAutofillOnLogins:k,enableFollowUpNotification:M,disableAnalysis:b,disableAutologin:T,disableAutofillOnForms:C,disableAutofillOnLogins:_,disableFollowUpNotification:D,addDisabledSourceTypes:E,removeDisabledSourceTypes:W,setUserAutofillCorrections:J,updateCredentialPreferences:es},events:{},queries:{getAnalysisStatusOnUrl:eg,getAutofillSettings:ev,getUserAutofillCorrections:ew,getPreferencesForCredentials:ef}},stores:[X],providers:[f,Z],requiredFeatureFlips:Object.values(n.S)})],eE)},14690:function(e,t,i){i.d(t,{c:()=>o});var s=i(36503),r=i(44384),n=i(29576),a=i(51582);let o=(0,s.Q)({name:"deviceManagement",commands:{revokeAuthorisedDevice:r.hr,renameAuthorisedDevice:n.nT},events:{},queries:{listAuthorisedDevice:a.p}})},29576:function(e,t,i){i.d(t,{nT:()=>n});var s=i(66122),r=i(15021);(0,i(96272).Vj)("RENAME_DEVICE_ERROR","Failed to rename the device");class n extends(0,s.g)({scope:r.F.User}){}},44384:function(e,t,i){i.d(t,{hr:()=>n});var s=i(66122),r=i(15021);(0,i(96272).Vj)("REVOKE_DEVICE_ERROR","Failed to revoke the device");class n extends(0,s.g)({scope:r.F.User}){}},51582:function(e,t,i){i.d(t,{p:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},34e3:function(e,t,i){i.d(t,{B:()=>_});var s=i(21636),r=i(14690),n=i(48035),a=i(4843),o=i(15021),c=i(59982),d=i(68238);let l=e=>!e||"object"!=typeof e;class u extends(0,c.Q)({initialValue:[],persist:!1,scope:o.F.User,storeName:"device-management",storeTypeGuard:l,capacity:d.Y._010KB}){}var p=i(44384),h=i(37368),g=i(306),m=i(44577),v=i(49247),y=i(94190),w=i(59242);class S{async refreshDeviceManagementList(){let e=await (0,m.z)(this.carbonLegacyClient.queries.carbonState({path:"authentication.currentUser.deviceKeys"})),t=await (0,m.z)(this.serverApi.v1.devices.listDevices());if(!(0,g.d6)(t))throw Error("Unable to retrieve Authorised Devices list: Server call failed");await this.store.set(t.data.data.devices.map(t=>({deviceId:t.deviceId,deviceName:t.deviceName,devicePlatform:t.devicePlatform,creationDate:t.creationDateUnix,lastUpdateDate:t.lastUpdateDateUnix,isCurrentDevice:(0,g.d6)(e)&&e.data.accessKey===t.deviceId})))}async revokeDevice(e){let t=await this.store.getState(),i=await (0,m.z)(this.serverApi.v1.devices.deactivateDevice({deviceId:e}));if(!(0,g.d6)(i))throw Error("Failure to revoke device: Server call failed");return await this.store.set(t.filter(t=>t.deviceId!==e)),(0,g.Vp)(void 0)}async renameDevice(e,t){let i=await this.store.getState(),s=await (0,m.z)(this.serverApi.v1.devices.renameDevice({accessKey:e,updatedName:t}));if(!(0,g.d6)(s))throw Error("Failure to rename device: Server call failed");return await this.store.set(i.map(i=>i.deviceId===e?{...i,deviceName:t}:i)),(0,g.Vp)(void 0)}constructor(e,t,i){this.serverApi=e,this.carbonLegacyClient=t,this.store=i}}S=(0,s.gn)([(0,y.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===w.l?Object:w.l,void 0===v._?Object:v._,u])],S);class f{async execute({body:e}){let{deviceId:t}=e,i=await this.deviceManagementService.revokeDevice(t);if((0,g.hx)(i))throw Error("Failed to revoke device: Server error");return(0,g.Vp)(void 0)}constructor(e){this.deviceManagementService=e}}f=(0,s.gn)([(0,h.W)(p.hr),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===S?Object:S])],f);var E=i(72907),I=i(51582),b=i(62506);class A{execute(){return this.store.state$.pipe((0,E.w)(async e=>(e.length||await this.deviceManagementService.refreshDeviceManagementList(),(0,g.Vp)(e))))}constructor(e,t){this.deviceManagementService=e,this.store=t}}A=(0,s.gn)([(0,b.e)(I.p),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===S?Object:S,u])],A);var C=i(29576);class R{async execute({body:e}){let{deviceId:t,updatedName:i}=e,s=await this.deviceManagementService.renameDevice(t,i);if((0,g.hx)(s))throw Error("Failed to rename device: Server error");return(0,g.Vp)(void 0)}constructor(e){this.deviceManagementService=e}}R=(0,s.gn)([(0,h.W)(C.nT),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===S?Object:S])],R);class _{}_=(0,s.gn)([(0,n.Y)({api:r.c,imports:[a.n],handlers:{commands:{revokeAuthorisedDevice:f,renameAuthorisedDevice:R},events:{},queries:{listAuthorisedDevice:A}},providers:[S],stores:[u],domainName:"device"})],_)},34832:function(e,t,i){i.d(t,{K:()=>o});var s=i(36503),r=i(7855),n=i(74771),a=i(63824);let o=(0,s.Q)({name:"teamEnclave",commands:{createTeamInEnclave:r.f},events:{},queries:{getTeamFromEnclave:n.m3,getTeamIdentifiers:a.r}})},59355:function(e,t,i){i.d(t,{G:()=>n});var s=i(46266),r=i(34832);class n extends(0,s.E)(r.K){}(0,s.K)(r.K,n)},7855:function(e,t,i){i.d(t,{f:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},74771:function(e,t,i){i.d(t,{SM:()=>n,m3:()=>a});var s=i(45429),r=i(15021);let n=(0,i(96272).Vj)("TEAM_NOT_PROVISIONED_IN_ENCLAVE","Team not provisioned in enclave");class a extends(0,s.k)({scope:r.F.User}){}},63824:function(e,t,i){i.d(t,{r:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},59578:function(e,t,i){i.d(t,{Z:()=>et});var s=i(21636),r=i(48035),n=i(79869),a=i(88288),o=i(22104),c=i(87055),d=i(34832),l=i(59842),u=i(59982),p=i(68238),h=i(15021),g=i(63762);g.z.enum(["NOT_LOADED","LOADED","ERRORED"]);let m=e=>null!==e&&"object"==typeof e&&"adminProvisioningKey"in e&&"string"==typeof e.adminProvisioningKey&&"teamUuid"in e&&"string"==typeof e.teamUuid&&"status"in e&&"string"==typeof e.status;class v extends(0,u.Q)({persist:!1,scope:h.F.User,storeName:"enclave-team-info",storeTypeGuard:m,initialValue:{adminProvisioningKey:void 0,teamUuid:void 0,status:"NOT_LOADED"},capacity:p.Y._001KB}){}var y=i(37368),w=i(7855),S=i(94680),f=i(49247),E=i(64898),I=i(306),b=i(15524);let A=g.z.object({data:g.z.object({deviceAccessKey:g.z.string(),deviceSecretKey:g.z.string()})}),C=g.z.object({data:g.z.object({devicePrivateKey:g.z.string(),devicePublicKey:g.z.string()})}),R=async e=>{let t=await e.commands.registerTeamDevice({platform:b.h.NITRO,deviceName:"Nitro Encryption Service"});if((0,I.hx)(t))return t;let{data:{deviceAccessKey:i,deviceSecretKey:s}}=A.parse((0,I.db)(t)),r=await e.commands.registerTeamDeviceAccount({deviceAccessKey:i,shouldGenerateDeviceKeyPair:!0});if((0,I.hx)(r))return r;let{data:{devicePrivateKey:n,devicePublicKey:a}}=C.parse((0,I.db)(r));return(0,I.Vp)({deviceAccessKey:i,deviceSecretKey:s,devicePrivateKey:n,devicePublicKey:a})};class _{async execute(){let e;try{let t=await this.getTeamUuid(),i=await this.registerTeamDeviceWithAccount();e=i.deviceAccessKey;let s=await this.enclaveApiClient.teams.createTeam({teamDeviceCredentials:{teamUuid:t,accessKey:i.deviceAccessKey,secretKey:i.deviceSecretKey,sharingPublicKey:i.devicePublicKey,sharingPrivateKey:i.devicePrivateKey}});if((0,I.hx)(s))return s;let{adminProvisioningKey:r}=(0,I.db)(s);return await this.runSideEffects(t,r),(0,I.Vp)(void 0)}catch(t){switch(e&&await this.rollBackTeamCreation(e),t.message){case"TeamIdNotFound":return(0,I.Rn)({tag:"TeamIdNotFound"});case"RegisterTeamDeviceFailed":return(0,I.Rn)({tag:"RegisterTeamDeviceFailed"});default:return(0,I.Rn)({tag:"CreateTeamInEnclaveApiError"})}}}async getTeamUuid(){let{teamUuid:e}=await this.teamInfoStore.getState();if(!e)throw Error("TeamIdNotFound");return e}async registerTeamDeviceWithAccount(){let e=await R(this.carbonClient);if((0,I.hx)(e))throw Error("RegisterTeamDeviceFailed");return(0,I.db)(e)}async runSideEffects(e,t){await this.carbonClient.commands.persistAdminProvisioningKey({adminProvisioningKey:t}),await this.teamInfoStore.set({status:"LOADED",teamUuid:e,adminProvisioningKey:t})}async rollBackTeamCreation(e){await this.carbonClient.commands.deactivateTeamDevice({teamDeviceAccessKey:e})}constructor(e,t,i,s){this.enclaveApiClient=e,this.carbonClient=t,this.teamPlanClient=i,this.teamInfoStore=s}}_=(0,s.gn)([(0,y.W)(w.f),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===S.l?Object:S.l,void 0===f._?Object:f._,void 0===E.e?Object:E.e,v])],_);var O=i(51870),T=i(12160),F=i(31142),D=i(69108),U=i(44577),P=i(17741);let x=g.z.object({adminProvisioningKey:g.z.object({adminProvisioningKey:g.z.ostring().nullable(),itemId:g.z.ostring().nullable()}).optional().nullable()}),N=(e,t)=>{let i=t({path:`userSession.teamAdminData.teams.${e}`}).pipe((0,P.nb)({success:e=>{let t=x.safeParse(e);if(!t.success)throw t.error;return t.data.adminProvisioningKey?.adminProvisioningKey??null},failure:()=>""}));return(0,U.z)(i)};var L=i(86518);let k=g.z.object({enabled:g.z.boolean()}).optional(),j=g.z.object({teamInfo:g.z.object({uuid:g.z.ostring().nullable(),ssoEnabled:g.z.boolean(),ssoIsNitroProvider:g.z.boolean(),ssoServiceProviderUrl:g.z.ostring().nullable(),ssoIdpMetadata:g.z.ostring().nullable(),ssoIdpEntrypoint:g.z.ostring().nullable()}),capabilities:g.z.object({sso:k})}),G=g.z.object({data:j}),V=g.z.object({message:g.z.string(),reason:g.z.nativeEnum(L._V)}),M=async e=>{let{getTeamInfo:t}=e.commands,i=await t();if((0,I.hx)(i))switch(V.parse(i.error).reason){case L._V.UNAUTHORIZED:return(0,I.Rn)({tag:"UserNotAuthorized"});case L._V.UNKNOWN_ERROR:return(0,I.Rn)({tag:"CouldNotGetTeamStatus"});default:throw Error("An unexpected error happened while trying to retrieve team info")}let{data:{teamInfo:s,capabilities:r}}=G.parse(i.data);return(0,I.Vp)({teamInfo:s,capabilities:r})};class K{async handle(){try{if(!await this.isUserFullAdminRights()){await this.teamInfoStore.set({status:"LOADED",teamUuid:void 0,adminProvisioningKey:void 0});return}let e=await this.getTeamUuid(),t=await this.getAdminProvisioningKey();await this.teamInfoStore.set({status:"LOADED",teamUuid:e,adminProvisioningKey:t})}catch(e){throw await this.teamInfoStore.set({status:"ERRORED",teamUuid:void 0,adminProvisioningKey:void 0}),e}}async getTeamUuid(){let e=await M(this.carbonClient);if((0,I.hx)(e))throw Error("[Enclave] - cannot retrieve team Uuid");let{teamInfo:{uuid:t}}=e.data;if(!t)throw Error("[Enclave] - cannot retrieve team Uuid");return t}async getAdminProvisioningKey(){let e=await (0,U.z)(this.teamPlansClient.queries.getTeamId());if((0,I.hx)(e))throw Error("[Enclave] - cannot retrieve team info");let t=e.data.teamId??"";return await N(t,this.carbonClient.queries.carbonState)??void 0}async isUserFullAdminRights(){let e=await (0,U.z)(this.permissionsClient.queries.userPermissions());if((0,I.hx)(e))throw Error("[Enclave] - Cannot get user permissions");return(0,I.db)(e).includes(T.fp.enum.ALL)}constructor(e,t,i,s){this.teamInfoStore=e,this.carbonClient=t,this.teamPlansClient=i,this.permissionsClient=s}}K=(0,s.gn)([(0,O.b)(F.L),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[v,void 0===f._?Object:f._,void 0===E.e?Object:E.e,void 0===D.J?Object:D.J])],K);var W=i(18310);class z{async handle(){let e=await this.teamInfoStore.getState();this.teamInfoStore.set({status:"LOADED",teamUuid:e.teamUuid,adminProvisioningKey:void 0})}constructor(e){this.teamInfoStore=e}}z=(0,s.gn)([(0,O.b)(W.z),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[v])],z);var q=i(72907),B=i(69853),Y=i(1833),Q=i(62506),H=i(74771);class ${execute(){return this.teamInfoStore.state$.pipe((0,q.w)(({teamUuid:e,adminProvisioningKey:t})=>{if(!e)throw Error("GetTeamFromEnclave: Team UUID is missing");return t?(0,Y.D)(this.enclaveApiClient.teams.getTeam({teamUuid:e,adminProvisioningKey:t})):(0,B.of)((0,I.Rn)((0,H.SM)()))}))}constructor(e,t){this.enclaveApiClient=e,this.teamInfoStore=t}}$=(0,s.gn)([(0,Q.e)(H.m3),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===S.l?Object:S.l,v])],$);var X=i(63824),Z=i(81102),J=i(42589);class ee{execute(){return this.teamInfoStore.state$.pipe((0,Z.n)(({status:e})=>"NOT_LOADED"===e),(0,J.U)(({teamUuid:e,adminProvisioningKey:t})=>{if(!e)throw Error("GetTeamIdentifiersQueryHandler: Could not fetch any team identifiers");return(0,I.Vp)({teamUuid:e,adminProvisioningKey:t})}))}constructor(e){this.teamInfoStore=e}}ee=(0,s.gn)([(0,Q.e)(X.r),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[v])],ee);class et{}et=(0,s.gn)([(0,r.Y)({api:d.K,imports:[n.X,a.i,o.G],stores:[v],handlers:{commands:{createTeamInEnclave:_},events:{...(0,r.g)(c.J,{permissionsLoaded:K}),...(0,r.g)(l.y,{confidentialSsoSettingsReset:z})},queries:{getTeamFromEnclave:$,getTeamIdentifiers:ee}},domainName:"enclave"})],et)},76249:function(e,t,i){i.d(t,{J:()=>u});var s=i(36503),r=i(35304),n=i(31620),a=i(37190),o=i(5804),c=i(1398),d=i(86944),l=i(90779);let u=(0,s.Q)({name:"masterPasswordSecurity",commands:{dismissMasterPasswordNotification:r.T,temporaryCheckMasterPassword:n.T,temporaryResetMasterPasswordLeaked:a.j,temporaryCheckMasterPasswordWeak:o.B},events:{},queries:{isMasterPasswordLeaked:c.B,isMasterPasswordWeak:d.D,isMasterPasswordNotificationDismissed:l.F}})},35304:function(e,t,i){i.d(t,{T:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},5804:function(e,t,i){i.d(t,{B:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},31620:function(e,t,i){i.d(t,{T:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},37190:function(e,t,i){i.d(t,{j:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},1398:function(e,t,i){i.d(t,{B:()=>r});var s=i(45429);class r extends(0,s.k)(){}},90779:function(e,t,i){i.d(t,{F:()=>r});var s=i(45429);class r extends(0,s.k)(){}},86944:function(e,t,i){i.d(t,{D:()=>r});var s=i(45429);class r extends(0,s.k)(){}},41098:function(e,t,i){i.d(t,{f:()=>er});var s=i(21636),r=i(48035),n=i(76249),a=i(87253),o=i(4843),c=i(98222),d=i(15021),l=i(59982),u=i(68238),p=i(20458),h=i(63762);let g=h.z.object({isMasterPasswordLeaked:h.z.boolean(),isMasterPasswordNotificationDismissed:h.z.boolean(),isMasterPasswordWeak:h.z.boolean(),lastCheckTimestamp:h.z.number()}),m=h.z.union([h.z.object({isMasterPasswordLeaked:h.z.boolean(),isMasterPasswordLeakedNotificationDismissed:h.z.boolean(),isMasterPasswordWeak:h.z.boolean(),lastCheckTimestamp:h.z.number()}),g]),v=e=>g.safeParse(e).success,y=e=>m.safeParse(e).success;function w(e){let{content:t,version:i}=e;if(1===i&&y(t))return v(t)?t:{isMasterPasswordWeak:t.isMasterPasswordWeak,isMasterPasswordLeaked:t.isMasterPasswordLeaked,isMasterPasswordNotificationDismissed:t.isMasterPasswordLeakedNotificationDismissed,lastCheckTimestamp:t.lastCheckTimestamp};throw Error(`Unable to migrate unexpected master-password-security schema version ${i}`)}let S={isMasterPasswordWeak:!1,isMasterPasswordLeaked:!1,isMasterPasswordNotificationDismissed:!1,lastCheckTimestamp:0};class f extends(0,l.Q)({persist:!0,storage:{initialValue:S,typeGuard:v,schemaVersion:2,migrateStorageSchema:w},scope:d.F.User,isCache:!0,storeName:"master-password-security",codec:p.E,capacity:u.Y._001KB}){}var E=i(37368),I=i(306),b=i(35304);class A{async execute(){let e=await this.masterPasswordSecurityStore.getState();return await this.masterPasswordSecurityStore.set({...e,isMasterPasswordNotificationDismissed:!0}),Promise.resolve((0,I.Vp)(void 0))}constructor(e){this.masterPasswordSecurityStore=e}}A=(0,s.gn)([(0,E.W)(b.T),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[f])],A);var C=i(31620),R=i(94190),_=i(59242),O=i(44577),T=i(42589),F=i(85133);class D{shouldBeChecked(){return(0,O.z)(this.masterPasswordSecurityStore.state$.pipe((0,T.U)(e=>!e.isMasterPasswordLeaked&&e.lastCheckTimestamp+864e5<=Date.now())))}async check(e){let t=await this.passwordHasher.hash(e),i=await (0,O.z)(this.serverApiClient.v1.pwleak.getHashes({hashPrefix:t.substring(0,6)}));if((0,I.hx)(i))throw Error("Error while retrieving list of hashes for MP checking");let s=i.data.data.includes(t),r=await this.masterPasswordSecurityStore.getState();return await this.masterPasswordSecurityStore.set({...r,isMasterPasswordLeaked:s,lastCheckTimestamp:Date.now()})}constructor(e,t,i){this.serverApiClient=e,this.masterPasswordSecurityStore=t,this.passwordHasher=i}}D=(0,s.gn)([(0,R.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===_.l?Object:_.l,f,void 0===F.T?Object:F.T])],D);class U{async reset(){let e=await this.masterPasswordSecurityStore.getState();return await this.masterPasswordSecurityStore.set({...e,isMasterPasswordNotificationDismissed:!1})}constructor(e){this.masterPasswordSecurityStore=e}}U=(0,s.gn)([(0,R.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[f])],U);var P=i(23506),x=i(39523),N=i(83533);class L{async send(){let{commands:{trackEvent:e}}=this.cqrsClient.getClient(x.Yu),t=await this.masterPasswordSecurityStore.getState();await e({event:new N.AnonymousMasterPasswordHealthReportEvent({isLeaked:t.isMasterPasswordLeaked})})}constructor(e,t){this.masterPasswordSecurityStore=e,this.cqrsClient=t}}L=(0,s.gn)([(0,R.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[f,void 0===P.w?Object:P.w])],L);class k{async execute({body:e}){return await this.resetMasterPasswordNotification.reset(),await this.checkMasterPasswordService.shouldBeChecked()&&(await this.checkMasterPasswordService.check(e.password),this.anonymousMasterPasswordLeakedTrackingEventSender.send()),Promise.resolve((0,I.Vp)(void 0))}constructor(e,t,i){this.checkMasterPasswordService=e,this.resetMasterPasswordNotification=t,this.anonymousMasterPasswordLeakedTrackingEventSender=i}}k=(0,s.gn)([(0,E.W)(C.T),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===D?Object:D,void 0===U?Object:U,void 0===L?Object:L])],k);var j=i(37190);class G{async execute(){let e=await this.masterPasswordSecurityStore.getState();return await this.masterPasswordSecurityStore.set({...e,lastCheckTimestamp:0,isMasterPasswordLeaked:!1,isMasterPasswordNotificationDismissed:!1}),Promise.resolve((0,I.Vp)(void 0))}constructor(e){this.masterPasswordSecurityStore=e}}G=(0,s.gn)([(0,E.W)(j.j),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[f])],G);var V=i(5804),M=i(51860);let K=async e=>(await (0,M.evaluate)(e)).score,W=async e=>{if(e)return await K(e)/25};class z{async check(e){let t=(await W(e)??5)<3,i=await this.masterPasswordSecurityStore.getState();return await this.masterPasswordSecurityStore.set({...i,isMasterPasswordWeak:t})}constructor(e){this.masterPasswordSecurityStore=e}}z=(0,s.gn)([(0,R.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[f])],z);class q{async send(){let{commands:{trackEvent:e}}=this.cqrsClient.getClient(x.Yu),t=await this.masterPasswordSecurityStore.getState();await e({event:new N.AnonymousMasterPasswordHealthReportEvent({isWeak:t.isMasterPasswordWeak})})}constructor(e,t){this.masterPasswordSecurityStore=e,this.cqrsClient=t}}q=(0,s.gn)([(0,R.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[f,void 0===P.w?Object:P.w])],q);class B{async execute({body:e}){return await this.resetMasterPasswordNotification.reset(),await this.checkMasterPasswordWeakService.check(e.password),this.anonymousMasterPasswordWeakTrackingEventSender.send(),Promise.resolve((0,I.Vp)(void 0))}constructor(e,t,i){this.checkMasterPasswordWeakService=e,this.anonymousMasterPasswordWeakTrackingEventSender=t,this.resetMasterPasswordNotification=i}}B=(0,s.gn)([(0,E.W)(V.B),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===z?Object:z,void 0===q?Object:q,void 0===U?Object:U])],B);var Y=i(51870),Q=i(53836);class H{async reset(){let e=await this.masterPasswordSecurityStore.getState();return await this.masterPasswordSecurityStore.set({...e,isMasterPasswordWeak:!1})}constructor(e){this.masterPasswordSecurityStore=e}}H=(0,s.gn)([(0,R.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[f])],H);class ${handle(){return this.resetMasterPasswordWeak.reset(),Promise.resolve(void 0)}constructor(e){this.resetMasterPasswordWeak=e}}$=(0,s.gn)([(0,Y.b)(Q.D),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===H?Object:H])],$);var X=i(62506),Z=i(1398);class J{execute(){return this.masterPasswordSecurityStore.state$.pipe((0,T.U)(e=>(0,I.Vp)(e.isMasterPasswordLeaked)))}constructor(e){this.masterPasswordSecurityStore=e}}J=(0,s.gn)([(0,X.e)(Z.B),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[f])],J);var ee=i(86944);class et{execute(){return this.masterPasswordSecurityStore.state$.pipe((0,T.U)(e=>(0,I.Vp)(e.isMasterPasswordWeak)))}constructor(e){this.masterPasswordSecurityStore=e}}et=(0,s.gn)([(0,X.e)(ee.D),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[f])],et);var ei=i(90779);class es{execute(){return this.masterPasswordSecurityStore.state$.pipe((0,T.U)(e=>(0,I.Vp)(e.isMasterPasswordNotificationDismissed)))}constructor(e){this.masterPasswordSecurityStore=e}}es=(0,s.gn)([(0,X.e)(ei.F),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[f])],es);class er{}er=(0,s.gn)([(0,r.Y)({api:n.J,handlers:{commands:{dismissMasterPasswordNotification:A,temporaryCheckMasterPassword:k,temporaryResetMasterPasswordLeaked:G,temporaryCheckMasterPasswordWeak:B},events:{...(0,r.g)(c.v,{masterPasswordChanged:$})},queries:{isMasterPasswordLeaked:J,isMasterPasswordWeak:et,isMasterPasswordNotificationDismissed:es}},providers:[D,F.T,U,z,L,q,H],imports:[a.D,o.n],stores:[f]})],er)},85133:function(e,t,i){i.d(t,{T:()=>c});var s=i(21636),r=i(94190),n=i(16747),a=i(76957),o=i(87169);class c{async hash(e){return(0,a.k)(await this.argon2dDeriver.derive((0,o.u)(e),(0,o.u)("z8CXohryCcGAa7CESNHYnedqbDyp"),{tCost:3,mCost:32768,parallelism:2}))}constructor(e){this.argon2dDeriver=e}}c=(0,s.gn)([(0,r.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===n.y?Object:n.y])],c)},8886:function(e,t,i){i.d(t,{B:()=>n});var s=i(36503),r=i(42498);let n=(0,s.Q)({name:"notifications",commands:{},events:{},queries:{getUserMessages:r.m}})},42498:function(e,t,i){i.d(t,{m:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},38336:function(e,t,i){i.d(t,{F:()=>p});var s=i(21636),r=i(48035),n=i(8886),a=i(4843),o=i(62506),c=i(49247),d=i(42498),l=i(17741);class u{execute(){let{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.localSettings.userMessages"}).pipe((0,l.Qn)(e=>e))}constructor(e){this.carbonLegacyClient=e}}u=(0,s.gn)([(0,o.e)(d.m),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===c._?Object:c._])],u);class p{}p=(0,s.gn)([(0,r.Y)({api:n.B,handlers:{commands:{},events:{},queries:{getUserMessages:u}},imports:[a.n],providers:[]})],p)},44878:function(e,t,i){i.d(t,{G:()=>r});var s,r=((s={}).OnboardingWebProfileNewUsers="onboarding_web_profileNewUsers_prod",s.OnboardingWebAVGSGForEmployeeOrB2C="onboarding_web_avgsg_for_employee_b2c_dev",s.OnboardingWebConfirmSite="onboarding_web_onboarding",s.OnboardingWebExtensionInstallStaticBanner="onboarding_web_extensionInstallStaticBanner",s.SaexOnboardingHubAddPasswords="saexOnboardingHubAddPasswords",s.ActivationRetentionWebTalkToSales="activationRetention_web_talk_to_sales_prod",s)},83783:function(e,t,i){i.d(t,{U:()=>u});var s=i(36503),r=i(65086),n=i(91736),a=i(60494),o=i(41634),c=i(31982),d=i(64828),l=i(74188);let u=(0,s.Q)({name:"getStarted",commands:{dismissGetStarted:r.A,markAdminConsoleOpened:n.T},events:{},queries:{hasAddedMobileOnWeb:a.c,hasCompletedAutofillTutorial:o.G,hasCompletedCredentialTutorial:c.x,hasOpenedAdminConsole:d.s,isGetStartedDismissed:l.A}})},65086:function(e,t,i){i.d(t,{A:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},91736:function(e,t,i){i.d(t,{T:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},60494:function(e,t,i){i.d(t,{c:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},41634:function(e,t,i){i.d(t,{G:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},31982:function(e,t,i){i.d(t,{x:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},64828:function(e,t,i){i.d(t,{s:()=>r});var s=i(45429);class r extends(0,s.k)(){}},74188:function(e,t,i){i.d(t,{A:()=>r});var s=i(45429);class r extends(0,s.k)(){}},1748:function(e,t,i){i.d(t,{d:()=>c});var s=i(36503),r=i(63183),n=i(80970),a=i(94332),o=i(7818);let c=(0,s.Q)({name:"profileAdmin",commands:{markProfilingFormSeen:r.v,saveAnswer:n.L},events:{},queries:{answers:a.G,hasSeenProfilingForm:o.v}})},63183:function(e,t,i){i.d(t,{v:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},80970:function(e,t,i){i.d(t,{L:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},94332:function(e,t,i){i.d(t,{G:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},7818:function(e,t,i){i.d(t,{v:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},31147:function(e,t,i){i.d(t,{$:()=>k});var s=i(21636),r=i(48035),n=i(83783),a=i(44878),o=i(15021),c=i(59982),d=i(68238),l=i(20458),u=i(63762);let p=u.z.object({hasOpenedAdminConsole:u.z.boolean(),isGetStartedDismissed:u.z.boolean()}),h=e=>p.safeParse(e).success;class g extends(0,c.Q)({storage:{schemaVersion:1,initialValue:{hasOpenedAdminConsole:!1,isGetStartedDismissed:!1},typeGuard:h},persist:!0,scope:o.F.User,storeName:"onboarding-get-started-store",capacity:d.Y._010KB,codec:l.E}){}var m=i(37368),v=i(306),y=i(65086);class w{async execute(){let e=await this.store.getState();return await this.store.set({...e,isGetStartedDismissed:!0}),Promise.resolve((0,v.Vp)(void 0))}constructor(e){this.store=e}}w=(0,s.gn)([(0,m.W)(y.A),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[g])],w);var S=i(91736);class f{async execute(){let e=await this.store.getState();return await this.store.set({...e,hasOpenedAdminConsole:!0}),Promise.resolve((0,v.Vp)(void 0))}constructor(e){this.store=e}}f=(0,s.gn)([(0,m.W)(S.T),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[g])],f);var E=i(62506),I=i(60494),b=i(94190),A=i(49247),C=i(42589),R=i(81433);class _{get(){return this.carbonLegacyClient.queries.getWebOnboardingMode().pipe((0,C.U)(e=>{if(!(0,v.d6)(e))throw Error("Error while retrieving the legacy onboarding state");return e.data.completedSteps}))}getAutofillTaskCompletion(){return this.get().pipe((0,C.U)(e=>!!e?.tryAutofillOnWeb),(0,R.x)(),(0,C.U)(v.Vp))}getCredentialTaskCompletion(){return this.get().pipe((0,C.U)(e=>!!e?.saveCredentialOnWeb),(0,R.x)(),(0,C.U)(v.Vp))}addMobileTaskCompletion(){return this.get().pipe((0,C.U)(e=>!!e?.addMobileOnWeb),(0,R.x)(),(0,C.U)(v.Vp))}constructor(e){this.carbonLegacyClient=e}}_=(0,s.gn)([(0,b.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===A._?Object:A._])],_);class O{execute(){return this.onboardingStateGetterService.addMobileTaskCompletion()}constructor(e){this.onboardingStateGetterService=e}}O=(0,s.gn)([(0,E.e)(I.c),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===_?Object:_])],O);var T=i(41634);class F{execute(){return this.onboardingStateGetterService.getAutofillTaskCompletion()}constructor(e){this.onboardingStateGetterService=e}}F=(0,s.gn)([(0,E.e)(T.G),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===_?Object:_])],F);var D=i(31982);class U{execute(){return this.onboardingStateGetterService.getCredentialTaskCompletion()}constructor(e){this.onboardingStateGetterService=e}}U=(0,s.gn)([(0,E.e)(D.x),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===_?Object:_])],U);var P=i(64828);class x{execute(){return this.store.state$.pipe((0,C.U)(e=>(0,v.Vp)(e.hasOpenedAdminConsole)))}constructor(e){this.store=e}}x=(0,s.gn)([(0,E.e)(P.s),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[g])],x);var N=i(74188);class L{execute(){return this.store.state$.pipe((0,C.U)(e=>(0,v.Vp)(e.isGetStartedDismissed)))}constructor(e){this.store=e}}L=(0,s.gn)([(0,E.e)(N.A),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[g])],L);class k{}k=(0,s.gn)([(0,r.Y)({api:n.U,stores:[g],handlers:{commands:{dismissGetStarted:w,markAdminConsoleOpened:f},events:{},queries:{hasAddedMobileOnWeb:O,hasCompletedAutofillTutorial:F,hasCompletedCredentialTutorial:U,hasOpenedAdminConsole:x,isGetStartedDismissed:L}},providers:[_],requiredFeatureFlips:Object.values(a.G)})],k)},91866:function(e,t,i){i.d(t,{y:()=>O});var s=i(21636),r=i(48035),n=i(1748),a=i(44878),o=i(42589),c=i(62506),d=i(306),l=i(94332),u=i(15021),p=i(59982),h=i(68238),g=i(20458),m=i(63762);let v=m.z.object({questionKey:m.z.string(),completed:m.z.boolean(),selectedAnswers:m.z.array(m.z.string())}),y=m.z.object({hasSeenProfilingForm:m.z.boolean(),answers:m.z.array(v)}),w=e=>y.safeParse(e).success;class S extends(0,p.Q)({persist:!0,capacity:h.Y._010KB,scope:u.F.User,storeName:"profile-admin-store",codec:g.E,storage:{schemaVersion:1,initialValue:{answers:[],hasSeenProfilingForm:!1},typeGuard:w}}){}class f{execute(){return this.profileAdminStore.state$.pipe((0,o.U)(e=>(0,d.Vp)({answers:e.answers})))}constructor(e){this.profileAdminStore=e}}f=(0,s.gn)([(0,c.e)(l.G),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[S])],f);var E=i(7818);class I{execute(){return this.profileAdminStore.state$.pipe((0,o.U)(e=>(0,d.Vp)({hasSeenProfilingForm:e.hasSeenProfilingForm})))}constructor(e){this.profileAdminStore=e}}I=(0,s.gn)([(0,c.e)(E.v),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[S])],I);var b=i(37368),A=i(63183);class C{async execute(){let e=await this.profileAdminStore.getState();return this.profileAdminStore.set({...e,hasSeenProfilingForm:!0}),Promise.resolve((0,d.Vp)(void 0))}constructor(e){this.profileAdminStore=e}}C=(0,s.gn)([(0,b.W)(A.v),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[S])],C);var R=i(80970);class _{async execute({body:e}){let t=await this.profileAdminStore.getState(),i=t.answers.findIndex(t=>t.questionKey===e.questionKey);return -1===i?t.answers.push(e):t.answers[i]=e,this.profileAdminStore.set(t),Promise.resolve((0,d.Vp)(void 0))}constructor(e){this.profileAdminStore=e}}_=(0,s.gn)([(0,b.W)(R.L),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[S])],_);class O{}O=(0,s.gn)([(0,r.Y)({api:n.d,stores:[S],handlers:{commands:{markProfilingFormSeen:C,saveAnswer:_},events:{},queries:{answers:f,hasSeenProfilingForm:I}},requiredFeatureFlips:Object.values(a.G)})],O)},85360:function(e,t,i){i.d(t,{y:()=>c});var s=i(36503),r=i(93887),n=i(72174),a=i(84376),o=i(95209);let c=(0,s.Q)({name:"publicApi",commands:{createPublicApiKey:r.$R,fetchPublicApiKeys:n.Vj,revokePublicApiKey:a.rT},events:{},queries:{listPublicApiKeys:o.O}})},93887:function(e,t,i){i.d(t,{$R:()=>a,dr:()=>n});var s=i(66122),r=i(15021);let n=(0,i(96272).Vj)("GENERIC_ERROR","Generic error");class a extends(0,s.g)({scope:r.F.User}){}},72174:function(e,t,i){i.d(t,{Vj:()=>a,W0:()=>n});var s=i(66122),r=i(15021);let n=(0,i(96272).Vj)("GENERIC_ERROR","Generic error");class a extends(0,s.g)({scope:r.F.User}){}},84376:function(e,t,i){i.d(t,{Ps:()=>c,YO:()=>d,iO:()=>o,rT:()=>u,zH:()=>l});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).PUBLIC_API_KEY_NOT_FOUND="PUBLIC_API_KEY_NOT_FOUND",s.PUBLIC_API_KEY_ALREADY_REVOKED="PUBLIC_API_KEY_ALREADY_REVOKED",s.GENERIC_ERROR="GENERIC_ERROR",s);let c=(0,a.Vj)("PUBLIC_API_KEY_ALREADY_REVOKED","Public API Key was already revoked"),d=(0,a.Vj)("PUBLIC_API_KEY_NOT_FOUND","Public API Key was not found"),l=(0,a.Vj)("GENERIC_ERROR","Generic error");class u extends(0,r.g)({scope:n.F.User}){}},95209:function(e,t,i){i.d(t,{O:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User,useCache:!0}){}},93812:function(e,t,i){i.d(t,{M:()=>C});var s=i(21636),r=i(48035),n=i(85360),a=i(4843),o=i(59982),c=i(68238),d=i(15021);class l extends(0,o.Q)({persist:!1,scope:d.F.User,storeName:"public-api-keys",initialValue:void 0,capacity:c.Y._010KB}){}var u=i(37368),p=i(59242),h=i(306),g=i(93887),m=i(44577);class v{async execute({body:{description:e}}){let t=await (0,m.z)(this.serverApiClient.v1.partners.createPublicApiKey({description:e,origin:"server_standalone"}));if((0,h.hx)(t))return(0,h.Rn)((0,g.dr)());let{data:{accessKey:i,secretKey:s,teamUuid:r}}=(0,h.db)(t);return(0,h.Vp)({id:`${r}_${i}_${s}`})}constructor(e){this.serverApiClient=e}}v=(0,s.gn)([(0,u.W)(g.$R),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.l?Object:p.l])],v);var y=i(72174);class w{async execute(){let e=await (0,m.z)(this.serverApiClient.v1.partners.listPublicApiKeys().pipe());if((0,h.hx)(e))return(0,h.Rn)((0,y.W0)());let{data:{publicAPIKeys:t}}=(0,h.db)(e);return this.publicApiKeysStore.set(t.sort((e,t)=>t.creationDateUnix-e.creationDateUnix)),(0,h.Vp)(void 0)}constructor(e,t){this.serverApiClient=e,this.publicApiKeysStore=t}}w=(0,s.gn)([(0,u.W)(y.Vj),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.l?Object:p.l,l])],w);var S=i(84376);class f{async execute({body:e}){let t=await (0,m.z)(this.serverApiClient.v1.partners.revokePublicApiKey(e));if((0,h.hx)(t))switch(t.error.message){case S.iO.PUBLIC_API_KEY_ALREADY_REVOKED:return(0,h.Rn)((0,S.Ps)());case S.iO.PUBLIC_API_KEY_NOT_FOUND:return(0,h.Rn)((0,S.YO)());default:return(0,h.Rn)((0,S.zH)())}return(0,h.Vp)(void 0)}constructor(e){this.serverApiClient=e}}f=(0,s.gn)([(0,u.W)(S.rT),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.l?Object:p.l])],f);var E=i(62506),I=i(95209),b=i(42589);class A{execute(){return this.publicApiKeysStore.state$.pipe((0,b.U)(e=>(0,h.Vp)(e)))}constructor(e){this.publicApiKeysStore=e}}A=(0,s.gn)([(0,E.e)(I.O),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[l])],A);class C{}C=(0,s.gn)([(0,r.Y)({api:n.y,handlers:{commands:{createPublicApiKey:v,fetchPublicApiKeys:w,revokePublicApiKey:f},events:{},queries:{listPublicApiKeys:A}},imports:[a.n],stores:[l],domainName:"partner-api",requiredFeatureFlips:Object.values({})})],C)},11838:function(e,t,i){i.d(t,{J:()=>a});var s=i(36503),r=i(85035),n=i(74571);let a=(0,s.Q)({name:"antiphishing",commands:{addAutoRedirectedDomain:r.A},events:{},queries:{isAutoRedirectedDomain:n.U}})},85035:function(e,t,i){i.d(t,{A:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},74571:function(e,t,i){i.d(t,{U:()=>r});var s=i(45429);class r extends(0,s.k)(){}},60825:function(e,t,i){i.d(t,{H:()=>c});var s=i(36503),r=i(66796),n=i(81419),a=i(76424),o=i(19696);let c=(0,s.Q)({name:"breaches",commands:{dismissBreach:r.n,markBreachAsSeen:n.Q},events:{},queries:{breach:a.i,unreadBreachesCount:o.L}})},22797:function(e,t,i){i.d(t,{J:()=>r});var s,r=((s={}).PENDING="PENDING",s.VIEWED="VIEWED",s.ACKNOWLEDGED="ACKNOWLEDGED",s)},66796:function(e,t,i){i.d(t,{n:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},81419:function(e,t,i){i.d(t,{Q:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},76424:function(e,t,i){i.d(t,{i:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},19696:function(e,t,i){i.d(t,{L:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},41835:function(e,t,i){i.d(t,{M:()=>d});var s=i(36503),r=i(93642),n=i(74232),a=i(71423),o=i(99354),c=i(51452);let d=(0,s.Q)({name:"emailMonitoring",commands:{dismissOnboardingNotification:r.n,optinEmail:n.P5,optoutEmail:a.Lc},events:{},queries:{emailList:o.dB,onboardingNotificationState:c.p}})},93642:function(e,t,i){i.d(t,{n:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},74232:function(e,t,i){i.d(t,{Dq:()=>o,Iy:()=>d,P5:()=>h,Qj:()=>u,XX:()=>c,pK:()=>l,tp:()=>p});var s,r=i(66122),n=i(15021),a=i(96272);let o="OK";var c=((s={}).INVALID_EMAIL="EMAIL_IS_INVALID",s.ALREADY_SUBSCRIBED="USER_HAS_ALREADY_AN_ACTIVE_SUBSCRIPTION",s.TOO_MANY_SUBSCRIPTIONS="USER_HAS_TOO_MANY_SUBSCRIPTIONS",s.GENERIC_ERROR="GENERIC_ERROR",s);let d=(0,a.Vj)("EMAIL_IS_INVALID",""),l=(0,a.Vj)("USER_HAS_ALREADY_AN_ACTIVE_SUBSCRIPTION",""),u=(0,a.Vj)("USER_HAS_TOO_MANY_SUBSCRIPTIONS",""),p=(0,a.Vj)("GENERIC_ERROR","");class h extends(0,r.g)({scope:n.F.User}){}},71423:function(e,t,i){i.d(t,{KP:()=>c,Lc:()=>p,QS:()=>o,h1:()=>l,uD:()=>d,v4:()=>u});var s,r=i(66122),n=i(15021),a=i(96272);let o="OK";var c=((s={}).INVALID_EMAIL="EMAIL_IS_INVALID",s.NO_SUBSCRIPTION="USER_HAS_NO_SUBSCRIPTION",s.GENERIC_ERROR="GENERIC_ERROR",s);class d extends(0,a.Hu)("EMAIL_IS_INVALID",""){}class l extends(0,a.Hu)("USER_HAS_NO_SUBSCRIPTION",""){}class u extends(0,a.Hu)("GENERIC_ERROR",""){}class p extends(0,r.g)({scope:n.F.User}){}},99354:function(e,t,i){i.d(t,{a2:()=>a,dB:()=>o,wp:()=>n});var s,r=i(45429),n=((s={}).PENDING="pending",s.ACTIVE="active",s.DISABLED="disabled",s);function a(e){return"pending"===e||"active"===e||"disabled"===e}class o extends(0,r.k)(){}},51452:function(e,t,i){i.d(t,{p:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},10281:function(e,t,i){i.d(t,{i:()=>o});var s=i(36503),r=i(49284),n=i(17907),a=i(32216);let o=(0,s.Q)({name:"otp",commands:{setupOtpCodeForCredential:r.z},events:{},queries:{otpCode:n.J,otpCodeForSecretOrUrl:a.S}})},49284:function(e,t,i){i.d(t,{z:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},17907:function(e,t,i){i.d(t,{J:()=>o,c:()=>a});var s=i(45429),r=i(15021),n=i(96272);class a extends(0,n.Hu)("Cannot generate OTP code due to no OtpSecret or OtpUrl found for credential",""){}class o extends(0,s.k)({scope:r.F.User}){}},32216:function(e,t,i){i.d(t,{S:()=>o,k:()=>a});var s=i(45429),r=i(15021),n=i(96272);class a extends(0,n.Hu)("Cannot generate OTP code for secret or url",""){}class o extends(0,s.k)({scope:r.F.User}){}},20933:function(e,t,i){i.d(t,{d:()=>S});var s=i(36503),r=i(98353),n=i(94412),a=i(97106),o=i(86982),c=i(45290),d=i(49964),l=i(9829),u=i(87200),p=i(21207),h=i(56850),g=i(30289),m=i(29099),v=i(73314),y=i(22713),w=i(33233);let S=(0,s.Q)({name:"passwordHealth",commands:{updateIsCredentialExcluded:r.v,recalculatePasswordHealth:n.t,updateHealthState:a.V,uploadUVVS:o.Yf,exportUVVS:c.E},events:{passwordHealthComputationFinished:d.w},queries:{credentialHealthData:l.w,filterCredentials:u.Q,filterCredentialsIds:p.M,score:h.e,compromisedCredentials:g.v,compromisedCredentialsIdsForBreach:m.A,passwordHealthReport:v.b,scoreForPassword:y.c,downloadUVVS:w.Up}})},98353:function(e,t,i){i.d(t,{v:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},45290:function(e,t,i){i.d(t,{E:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},94412:function(e,t,i){i.d(t,{t:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},97106:function(e,t,i){i.d(t,{V:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},86982:function(e,t,i){i.d(t,{Yf:()=>c,m0:()=>o});var s=i(66122),r=i(15021),n=i(96272);let a=Object.freeze({REQUEST_MALFORMED:"REQUEST_MALFORMED"}),o=(0,n.Vj)(a.REQUEST_MALFORMED,"Request is malformed.");class c extends(0,s.g)({scope:r.F.User}){}},49964:function(e,t,i){i.d(t,{w:()=>n});var s=i(98037),r=i(15021);class n extends(0,s.d)({scope:r.F.User}){}},28109:function(e,t,i){i.d(t,{L:()=>n});var s=i(46266),r=i(20933);class n extends(0,s.E)(r.d){}(0,s.K)(r.d,n)},61506:function(e,t,i){i.d(t,{_x:()=>c,bp:()=>l,gI:()=>o,ub:()=>d});var s,r,n,a,o=((s={}).Weak="weak",s.Reused="reused",s.Compromised="compromised",s.Excluded="excluded",s),c=((r={}).All="all",r.Weak="weak",r.Reused="reused",r.Compromised="compromised",r.Excluded="excluded",r),d=((n={}).WEAK="weak",n.EXTREMELY_WEAK="extremely_weak",n),l=((a={}).COMMON="common",a.STRONG="strong",a)},29099:function(e,t,i){i.d(t,{A:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},30289:function(e,t,i){i.d(t,{v:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},9829:function(e,t,i){i.d(t,{w:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},33233:function(e,t,i){i.d(t,{Lq:()=>d,Mp:()=>c,Mw:()=>a,Up:()=>l,iQ:()=>o});var s=i(45429),r=i(15021),n=i(96272);let a=(0,n.Vj)("snapshot-not-found","No snapshot found for this user."),o=(0,n.Vj)("snapshot-malformed","The snapshot has an unexpected form."),c=(0,n.Vj)("download-unknown","Download UVVS had an unknown error."),d=(0,n.Vj)("missing-provisioning-key","Admin provisioning key missing.");class l extends(0,s.k)({scope:r.F.User}){}},21207:function(e,t,i){i.d(t,{M:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},87200:function(e,t,i){i.d(t,{Q:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},73314:function(e,t,i){i.d(t,{b:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},22713:function(e,t,i){i.d(t,{c:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},56850:function(e,t,i){i.d(t,{e:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},35358:function(e,t,i){i.d(t,{f:()=>s});let s=(0,i(36503).Q)({name:"vaultReport",commands:{},events:{},queries:{}})},92608:function(e,t,i){i.d(t,{v:()=>I});var s=i(21636),r=i(48035),n=i(11838),a=i(15021),o=i(59982),c=i(68238),d=i(20458),l=i(63762);let u=l.z.object({autoredirection:l.z.record(l.z.boolean())}),p=e=>u.safeParse(e).success;class h extends(0,o.Q)({persist:!0,storage:{initialValue:{autoredirection:{}},typeGuard:p,schemaVersion:1},scope:a.F.Device,storeName:"antiphishing",codec:d.E,capacity:c.Y._001KB}){}var g=i(37368),m=i(306),v=i(85035);class y{async execute({body:e}){let{domain:t}=e;if(t){let e=await this.antiphishingStore.getState();await this.antiphishingStore.set({...e,autoredirection:{...e.autoredirection,[t]:!0}})}return Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.antiphishingStore=e}}y=(0,s.gn)([(0,g.W)(v.A),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[h])],y);var w=i(62506),S=i(74571),f=i(42589);class E{execute({body:e}){return this.antiphishingStore.state$.pipe((0,f.U)(t=>(0,m.Vp)(!!e.domain&&!!t.autoredirection[e.domain])))}constructor(e){this.antiphishingStore=e}}E=(0,s.gn)([(0,w.e)(S.U),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[h])],E);class I{}I=(0,s.gn)([(0,r.Y)({api:n.J,handlers:{commands:{addAutoRedirectedDomain:y},events:{},queries:{isAutoRedirectedDomain:E}},stores:[h]})],I)},1464:function(e,t,i){i.d(t,{b:()=>n});let s=e=>void 0===e||"string"==typeof e,r=e=>void 0===e||"number"==typeof e,n=e=>{if(!e||!Array.isArray(e))return!1;if(0===e.length)return!0;let t=e[0];return"string"==typeof t.Id&&r(t.LastBackupTime)&&s(t.kwType)&&s(t.BreachId)&&r(t.ContentRevision)}},18893:function(e,t,i){i.d(t,{T:()=>d,l:()=>c});var s=i(22797),r=i(31512);let n=({name:e,domains:t})=>{if(e)return e;if(t.length>0){let[e]=t;return e}return""},a=e=>(0,r.Tc)(e)?"private":"public",o=e=>{let t=e.Content,i=(0,r.Tc)(e)?e.Content.impactedEmails:[];return{breachId:e.BreachId,breachType:a(e),domains:t.domains,eventDate:t.eventDate,id:e.Id,impactedEmails:i,kwType:e.kwType??"KWSecurityBreach",leakedData:t.leakedData??[],leakedPasswords:e.LeakedPasswords??[],name:n(t),status:e.Status??s.J.PENDING}},c=e=>[...e.reduce((e,t)=>{let i=e.get(t.BreachId);return(!i||i.LastBackupTime&&t.LastBackupTime&&i.LastBackupTime<t.LastBackupTime)&&e.set(t.BreachId,t),e},new Map).values()],d=(e,t)=>{let i=c(e.filter(r.rY)).find(e=>e.Id===t);if(!i)throw Error("Breach not found");return o(i)}},31512:function(e,t,i){i.d(t,{F7:()=>d,Tc:()=>l,rY:()=>o});let s=e=>"object"==typeof e,r=e=>s(e)&&"breachModelVersion"in e&&"number"==typeof e.breachModelVersion,n=e=>r(e)&&1===e.breachModelVersion&&"domains"in e&&Array.isArray(e.domains)&&"eventDate"in e&&"string"==typeof e.eventDate&&"id"in e&&"string"==typeof e.id,a=e=>s(e)&&"kwType"in e&&"string"==typeof e.kwType&&"KWSecurityBreach"===e.kwType,o=e=>a(e)&&n(e.Content),c=e=>"impactedEmails"in e&&Array.isArray(e.impactedEmails),d=e=>c(e)&&e.impactedEmails.length>0,l=e=>o(e)&&d(e.Content)},39956:function(e,t,i){i.d(t,{t:()=>A});var s=i(21636),r=i(48035),n=i(60825),a=i(37368),o=i(306),c=i(22797),d=i(66796),l=i(49247);class u{async execute({body:e}){let{commands:{carbon:t}}=this.carbonLegacyClient;return await t({name:"updateBreachStatus",args:[{id:e.id,status:c.J.ACKNOWLEDGED}]}),Promise.resolve((0,o.Vp)(void 0))}constructor(e){this.carbonLegacyClient=e}}u=(0,s.gn)([(0,a.W)(d.n),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===l._?Object:l._])],u);var p=i(81419);class h{async execute({body:e}){let{commands:{carbon:t}}=this.carbonLegacyClient;return await t({name:"updateBreachStatus",args:[{id:e.id,status:c.J.VIEWED}]}),Promise.resolve((0,o.Vp)(void 0))}constructor(e){this.carbonLegacyClient=e}}h=(0,s.gn)([(0,a.W)(p.Q),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===l._?Object:l._])],h);var g=i(17741),m=i(62506),v=i(76424),y=i(18893),w=i(1464);class S{execute({body:e}){let{id:t}=e,{queries:{carbonState:i}}=this.carbonLegacyClient;return i({path:"userSession.personalData.securityBreaches"}).pipe((0,g.Qn)(e=>{if(!(0,w.b)(e))throw Error("Bad Breaches format");return e}),(0,g.Qn)(e=>(0,y.T)(e,t)))}constructor(e){this.carbonLegacyClient=e}}S=(0,s.gn)([(0,m.e)(v.i),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===l._?Object:l._])],S);var f=i(42589),E=i(19696),I=i(31512);class b{execute(){let{queries:{carbonState:e}}=this.carbonLegacyClient;return e({path:"userSession.personalData.securityBreaches"}).pipe((0,g.Qn)(e=>{if(!(0,w.b)(e))throw Error("Bad Breaches format");return e}),(0,f.U)(e=>{if((0,o.hx)(e))throw Error("Error while fetching data");let t=(0,y.l)(e.data.filter(I.rY)).filter(e=>e.Status===c.J.PENDING&&(0,I.Tc)(e));return(0,o.Vp)({count:t.length})}))}constructor(e){this.carbonLegacyClient=e}}b=(0,s.gn)([(0,m.e)(E.L),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===l._?Object:l._])],b);class A{}A=(0,s.gn)([(0,r.Y)({api:n.H,handlers:{commands:{dismissBreach:u,markBreachAsSeen:h},events:{},queries:{breach:S,unreadBreachesCount:b}}})],A)},78293:function(e,t,i){i.d(t,{S:()=>K});var s,r=i(21636),n=i(48035),a=i(41835),o=i(15021),c=i(59982),d=((s={}).UNKNOWN="UNKNOWN",s.SEEN="SEEN",s.NOT_SEEN="NOT_SEEN",s),l=i(20458);let u=e=>!!e&&"object"==typeof e&&"onboardingStatus"in e&&"emails"in e,p=e=>{var t;return u(e)&&("UNKNOWN"===(t=e.onboardingStatus)||"SEEN"===t||"NOT_SEEN"===t)&&Array.isArray(e.emails)};class h extends(0,c.Q)({persist:!0,storage:{schemaVersion:1,initialValue:{onboardingStatus:d.NOT_SEEN,emails:[]},typeGuard:p},scope:o.F.User,storeName:"email-monitoring-state",storeTypeGuard:p,codec:l.E,isCache:!0}){}var g=i(74232),m=i(99354),v=i(37368),y=i(17741),w=i(306),S=i(59242),f=i(44577),E=i(53868);let I=e=>{switch(e){case g.XX.INVALID_EMAIL:return(0,g.Iy)();case g.XX.ALREADY_SUBSCRIBED:return(0,g.pK)();case g.XX.TOO_MANY_SUBSCRIPTIONS:return(0,g.Qj)();default:return(0,g.tp)()}};class b{async execute({body:{email:e}}){return await (0,f.z)(this.serverApiClient.v1.darkwebmonitoring.registerEmail({email:e}).pipe((0,y.DZ)(e=>{throw Error(e.message)}),(0,y.lk)(e=>e.data.result===g.Dq?(0,w.Vp)(void 0):(0,w.Rn)(I(e.data.result))),(0,E.b)(async t=>{(0,w.d6)(t)&&await this.store.update(t=>({...t,emails:[...t.emails,{email:e,state:m.wp.PENDING}]}))})))}constructor(e,t){this.serverApiClient=e,this.store=t}}b=(0,r.gn)([(0,v.W)(g.P5),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===S.l?Object:S.l,h])],b);var A=i(4843),C=i(71423);class R{async execute({body:{email:e}}){return await (0,f.z)(this.serverApiClient.v1.darkwebmonitoring.deregisterEmail({email:e}).pipe((0,y.DZ)(e=>{throw Error(e.message)}),(0,y.lk)(e=>e.data.result===C.QS?(0,w.Vp)(void 0):(0,w.Rn)(this.getFunctionalError(e.data.result))),(0,E.b)(async t=>{(0,w.d6)(t)&&await this.store.update(t=>({...t,emails:[...t.emails.filter(t=>t.email!==e)]}))})))}constructor(e,t){this.serverApiClient=e,this.store=t,this.getFunctionalError=e=>{switch(e){case C.KP.NO_SUBSCRIPTION:return new C.h1;case C.KP.INVALID_EMAIL:return new C.uD;case C.KP.GENERIC_ERROR:default:return new C.v4}}}}R=(0,r.gn)([(0,v.W)(C.Lc),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===S.l?Object:S.l,h])],R);var _=i(93642),O=i(94190);function T(e){return{...e,onboardingStatus:d.SEEN}}class F{async execute(){await this.store.update(T)}constructor(e){this.store=e}}F=(0,r.gn)([(0,O.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[h])],F);class D{async execute(){return await this.dismissOnboardingNotificationService.execute(),Promise.resolve((0,w.Vp)(void 0))}constructor(e){this.dismissOnboardingNotificationService=e}}D=(0,r.gn)([(0,v.W)(_.n),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===F?Object:F])],D);var U=i(42589),P=i(81433),x=i(72907),N=i(10096),L=i(69853),k=i(62506);class j{constructor(e,t){this.serverApiClient=e,this.store=t,this.execute=()=>{this.serverApiClient.v1.darkwebmonitoring.listRegistrations({}).pipe((0,y.Qn)(({data:e})=>e.emails.map(e=>({email:e.email,state:(0,m.a2)(e.state)?e.state:m.wp.PENDING}))),(0,y.Qn)(e=>{this.store.update(t=>({...t,emails:e}))}),(0,y.DZ)(e=>{throw e})).subscribe()}}}j=(0,r.gn)([(0,O.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===S.l?Object:S.l,h])],j);class G{execute(){return this.syncMonitoredEmails.execute(),this.store.state$.pipe((0,U.U)(e=>e.emails),(0,P.x)((e,t)=>JSON.stringify(e)===JSON.stringify(t)),(0,U.U)(e=>(0,w.Vp)(e))).pipe((0,x.w)(e=>{let t=()=>(this.syncMonitoredEmails.execute(),e),i=e=>(0,N.H)(0,e).pipe((0,x.w)(()=>(0,L.of)(t())));return(0,w.hx)(e)?i(3e4):e.data.some(e=>e.state===m.wp.PENDING)?i(3e4):(0,L.of)(e)}))}constructor(e,t){this.syncMonitoredEmails=e,this.store=t}}G=(0,r.gn)([(0,k.e)(m.dB),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===j?Object:j,h])],G);var V=i(51452);class M{execute(){return this.store.state$.pipe((0,U.U)(e=>e.onboardingStatus),(0,P.x)(),(0,U.U)(w.Vp))}constructor(e){this.store=e}}M=(0,r.gn)([(0,k.e)(V.p),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[h])],M);class K{}K=(0,r.gn)([(0,n.Y)({api:a.M,stores:[h],handlers:{commands:{dismissOnboardingNotification:D,optinEmail:b,optoutEmail:R},events:{},queries:{emailList:G,onboardingNotificationState:M}},imports:[A.n],providers:[F,j]})],K)},73441:function(e,t,i){i.d(t,{f:()=>ee});var s,r=i(21636),n=i(48035),a=i(10281),o=i(42589),c=i(49247),d=i(94190),l=i(17741),u=i(306);let p=e=>void 0===e||"string"==typeof e,h=e=>!!Array.isArray(e)&&(0===e.length||e.every(e=>"string"==typeof e.Id&&p(e.OtpSecret)&&p(e.OtpUrl)));class g{getById(e){let{queries:{carbonState:t}}=this.carbonLegacyClient;return t({path:"state.userSession.personalData.credentials"}).pipe((0,l.Qn)(e=>{if(!h(e))throw Error("Bad credential format");return e}),(0,o.U)(t=>{if((0,u.hx)(t))return(0,u.Vp)(null);let i=t.data.reduce((t,i)=>i.Id===e?{Id:i.Id,OtpSecret:i.OtpSecret,OtpUrl:i.OtpUrl}:t,null);return(0,u.Vp)(i)}))}constructor(e){this.carbonLegacyClient=e}}g=(0,r.gn)([(0,d.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===c._?Object:c._])],g);var m=i(62506),v=i(32216),y=((s={}).SHA1="SHA-1",s.SHA256="SHA-256",s.SHA384="SHA-384",s.SHA512="SHA-512",s);let w=["totp","hotp"],S=e=>{let t=e.hostname?e.hostname:/\/\/([th]otp)\//.exec(e.pathname)?.[1]??"";return w.includes(t)?t:null},f=e=>{let t=new URL(e),i=S(t),s=t.searchParams.get("secret")?.toUpperCase();if(!i||!s)throw Error("Corrupted OTP url");let r=t.searchParams.get("digits"),n=t.searchParams.get("counter"),a=t.searchParams.get("period"),o=t.searchParams.get("algorithm");return{secret:s,algorithm:o?y[o]:y.SHA1,counter:n?Number.parseInt(n,10):0,digits:r?Number.parseInt(r,10):6,period:a?Number.parseInt(a,10):30}},E=e=>({secret:e.toUpperCase(),algorithm:y.SHA1,counter:0,digits:6,period:30}),I=e=>{try{return f(e)}catch{return E(e)}},b=e=>{let{OtpSecret:t,OtpUrl:i}=e;if(!t&&!i)throw Error("Otp config missing for this credential");return i?I(i):E(t??"")},A=e=>{let{secret:t,algorithm:i,digits:s,period:r}=e;return`otpauth://totp/?secret=${t.toLowerCase()}&algorithm=${i.toUpperCase().replace("-","")}&digits=${s}&period=${r}&lock=false`},C=(e,t)=>e-Date.now()>=1e3*t-1e3;var R=i(10096),_=i(56144),O=i(72907),T=i(55559);let F=(e,t)=>Math.floor(e/t);var D=i(54123),U=i(784);let P=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9],x=e=>e.toString().padStart(2,"0"),N=e=>{let t=new Uint8Array(e),i=15&t[t.length-1];return 0x7fffffff&Number.parseInt(t.slice(i,i+4).reduce((e,t)=>e.concat(x(t.toString(16))),""),16)},L=async(e,t,i)=>(N(await e((0,U.n)(t)))%(i<=9?P[i]:Math.pow(10,i))).toString().padStart(i,"0");class k{async computeOtpCode({counter:e,digits:t,period:i}){let s=this.getStep(e,i);return await L(this.signer,s,t)}constructor(e,t){this.signer=e,this.getStep=t}}let j=e=>{let t=1e3*e;return new Date(Math.floor(Date.now()/t)*t+t).getTime()};class G{createCodeGenerator({secret:e,algorithm:t}){try{let i=(0,D.K)(e);return new k(e=>this.hmacSigner.sign(i,e,t),this.getStep)}catch(e){return null}}getNextOtpRefreshTimestamp(e,t){if(e)return j(t);throw Error("Not supported for non time based OTP type")}constructor(e){this.hmacSigner=e}}class V extends G{getStep(e,t){return F(e||new Date().getTime(),1e3*t)}constructor(e){super(e)}}V=(0,r.gn)([(0,d.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===T.q?Object:T.q])],V);class M{async withGeneratedCodeAndValidity(e,t){try{let i=await t.computeOtpCode(e),s=this.otpGeneratorService.getNextOtpRefreshTimestamp(!0,e.period);return(0,u.Vp)({code:i,validityEndDate:s,validityTime:1e3*e.period,url:A(e)})}catch{return(0,u.Rn)(void 0)}}otpCodes$(e,t){return(0,R.H)(0,1e3).pipe((0,_.h)(t=>0===t||C(this.otpGeneratorService.getNextOtpRefreshTimestamp(!0,e.period),e.period)),(0,O.w)(()=>this.withGeneratedCodeAndValidity(e,t)))}constructor(e){this.otpGeneratorService=e}}M=(0,r.gn)([(0,d.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===V?Object:V])],M);var K=i(69853);class W{execute({body:e}){let{secretOrUrl:t}=e;if(!t)return(0,K.of)((0,u.Rn)(new v.k));let i=I(t.replaceAll(" ","")),s=this.otpGeneratorService.createCodeGenerator(i);return null===s?(0,K.of)((0,u.Rn)(new v.k)):this.otpCodeService.otpCodes$(i,s).pipe((0,l.DZ)(()=>new v.k))}constructor(e,t){this.otpGeneratorService=e,this.otpCodeService=t}}W=(0,r.gn)([(0,m.e)(v.S),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===V?Object:V,void 0===M?Object:M])],W);var z=i(37368),q=i(49284),B=i(57178),Y=i(47244);class Q{async execute({body:e}){let{updateVaultItem:t}=this.vaultCrudClient.commands,{credentialId:i,otpUrl:s}=e;return await t({vaultItemType:B.U.Credential,content:{otpSecret:"",otpURL:s},id:i}),(0,u.Vp)(void 0)}constructor(e){this.vaultCrudClient=e}}Q=(0,r.gn)([(0,z.W)(q.z),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===Y.L?Object:Y.L])],Q);var H=i(17907);class ${withCodeGenerator(e){return{codeGenerator:this.otpGeneratorService.createCodeGenerator(e),params:e}}execute({body:e}){let{credentialId:t}=e;return this.credentialOTPGetter.getById(t).pipe((0,o.U)(e=>{if((0,u.hx)(e)||!e.data)throw Error("Credential not found");return e.data}),(0,o.U)(e=>{if(!e.OtpUrl&&!e.OtpSecret)return{params:null,codeGenerator:null};let t=b(e);return this.withCodeGenerator(t)}),(0,O.w)(({params:e,codeGenerator:t})=>null===e||null===t?(0,K.of)((0,u.Rn)(new H.c)):this.otpCodeService.otpCodes$(e,t).pipe((0,o.U)(e=>(0,u.hx)(e)?(0,u.Vp)({code:"",validityEndDate:Date.now(),validityTime:Date.now(),url:""}):e))))}constructor(e,t,i){this.credentialOTPGetter=e,this.otpGeneratorService=t,this.otpCodeService=i}}$=(0,r.gn)([(0,m.e)(H.J),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===g?Object:g,void 0===V?Object:V,void 0===M?Object:M])],$);class X extends G{getStep(e,t){return e}constructor(e){super(e)}}X=(0,r.gn)([(0,d.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===T.q?Object:T.q])],X);var Z=i(87253);class J{}J=(0,r.gn)([(0,n.Y)({sharedModuleName:"otp-generator",providers:[V,X],exports:[V,X],imports:[Z.D]})],J);class ee{}ee=(0,r.gn)([(0,n.Y)({api:a.i,handlers:{commands:{setupOtpCodeForCredential:Q},events:{},queries:{otpCode:$,otpCodeForSecretOrUrl:W}},imports:[J],providers:[g,M]})],ee)},71596:function(e,t,i){i.d(t,{U:()=>l});var s=i(21636),r=i(49247),n=i(94190),a=i(17741),o=i(1464),c=i(18893),d=i(31512);class l{getSupportedBreaches(){let{queries:{carbonState:e}}=this.carbonLegacyClient;return e({path:"userSession.personalData.securityBreaches"}).pipe((0,a.Qn)(e=>{if(!(0,o.b)(e))throw Error("Bad Breaches format");return e}),(0,a.Qn)(e=>e.filter(d.rY)))}get(){let{queries:{carbonState:e}}=this.carbonLegacyClient;return e({path:"userSession.personalData.securityBreaches"}).pipe((0,a.Qn)(e=>{if(!(0,o.b)(e))throw Error("Bad Breaches format");return e}),(0,a.Qn)(e=>(0,c.l)(e.filter(d.rY))))}constructor(e){this.carbonLegacyClient=e}}l=(0,s.gn)([(0,n.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===r._?Object:r._])],l)},79350:function(e,t,i){i.d(t,{C:()=>iw});var s,r=i(21636),n=i(20933),a=((s={}).DisablePasswordHealth="web_disable_password_health",s.ItemVisibilityPhase1="sharingVault_web_adminItemVisibility_phase1",s),o=i(4843),c=i(94846),d=i(48035),l=i(37809),u=i(90573),p=i(99481),h=i(22104),g=i(41908),m=i(41681),v=i(15021),y=i(59982),w=i(68238),S=i(20458),f=i(63762),E=i(61506);let I=f.z.object({breachId:f.z.string(),domains:f.z.array(f.z.string()),date:f.z.string()}),b=f.z.object({riskType:f.z.literal(E.gI.Compromised),breaches:f.z.array(I)}),A=f.z.object({riskType:f.z.literal(E.gI.Weak),strength:f.z.number()}),C=f.z.object({riskType:f.z.literal(E.gI.Reused),credentialIds:f.z.array(f.z.string())}),R=f.z.discriminatedUnion("riskType",[b,A,C]),_=f.z.object({id:f.z.string(),excluded:f.z.boolean(),title:f.z.string(),login:f.z.string(),email:f.z.string(),autoLogin:f.z.boolean(),autoProtected:f.z.boolean(),otpSecret:f.z.string(),otpUrl:f.z.string(),spaceId:f.z.string(),shared:f.z.boolean(),domains:f.z.array(f.z.string()),creationDatetime:f.z.union([f.z.number(),f.z.string()]).optional()});_.extend({password:f.z.string()});let O=_.extend({isImportant:f.z.boolean(),risks:f.z.array(R)}),T=f.z.object({compromised:f.z.array(f.z.string()),reused:f.z.array(f.z.string()),weak:f.z.array(f.z.string()),excluded:f.z.array(f.z.string()),corruptedCount:f.z.number(),importantCorruptedCount:f.z.number()}),F=f.z.object({credentialsAtRisk:f.z.record(O),index:f.z.record(T)}),D=e=>F.safeParse(e).success;class U extends(0,y.Q)({persist:!0,storage:{initialValue:{credentialsAtRisk:{},index:{}},typeGuard:D,schemaVersion:1},scope:v.F.User,storeName:"password-health-state",storeTypeGuard:D,codec:S.E,isCache:!0,capacity:w.Y.Unlimited}){}var P=i(49247),x=i(94190),N=i(17741),L=i(306),k=i(83463),j=i(21958),G=i(42589);let V=e=>void 0===e||"string"==typeof e,M=e=>void 0===e||"string"==typeof e||"boolean"==typeof e,K=e=>!!Array.isArray(e)&&(0===e.length||e.every(e=>"string"==typeof e.Id&&M(e.AutoLogin)&&M(e.AutoProtected)&&V(e.Email)&&V(e.Login)&&V(e.OtpSecret)&&V(e.OtpUrl)&&V(e.Password)&&V(e.Title)&&V(e.Url)&&V(e.SpaceId)&&M(e.Checked))),W=e=>!!Array.isArray(e)&&(0===e.length||e.every(e=>"string"==typeof e.content&&"string"==typeof e.itemId&&"number"==typeof e.timestamp)),z=e=>!!Array.isArray(e)&&(0===e.length||e.every(e=>"string"==typeof e.teamId&&"object"==typeof e.details&&"string"==typeof e.details.status));class q{vaultBooleanFormatter(e,t=!1){return void 0===e?t:"string"==typeof e?"true"===e.toLocaleLowerCase():e}get(){let{queries:{carbonState:e}}=this.carbonLegacyClient,t=e({path:"state.userSession.spaceData.spaces"}).pipe((0,N.Qn)(e=>{if(!z(e))throw Error("Bad space item format");return new Set(e.filter(e=>"accepted"===e.details.status).map(e=>e.teamId))})),i=e({path:"userSession.sharingData.items"}).pipe((0,N.Qn)(e=>{if(!W(e))throw Error("Bad shared items format");return e.map(e=>e.itemId)}));return e({path:"state.userSession.personalData.credentials"}).pipe((0,N.Qn)(e=>{if(!K(e))throw Error("Bad credential format");return e}),(0,j.V)(i,t),(0,G.U)(([e,t,i])=>{let s=e=>!(0,L.hx)(t)&&t.data.includes(e),r={};return(0,L.hx)(e)||(0,L.hx)(i)||e.data.forEach(e=>{let t=new k.Y(e.Url).getRootDomain();(!e.SpaceId||""===e.SpaceId||i.data.has(e.SpaceId))&&(r[e.Id]={domains:t?[t]:[],autoLogin:this.vaultBooleanFormatter(e.AutoLogin),autoProtected:this.vaultBooleanFormatter(e.AutoProtected),email:e.Email??"",excluded:this.vaultBooleanFormatter(e.Checked),id:e.Id,login:e.Login??"",otpSecret:e.OtpSecret??"",otpUrl:e.OtpUrl??"",password:e.Password??"",spaceId:e.SpaceId??"",shared:s(e.Id),title:e.Title??"",creationDatetime:e.CreationDatetime})}),(0,L.Vp)(r)}))}constructor(e){this.carbonLegacyClient=e}}q=(0,r.gn)([(0,x.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===P._?Object:P._])],q);var B=i(71596);let Y=e=>!!e&&!!e.associatedEmail&&!!e.billingAdmins&&!!e.color&&!!e.info&&!!e.letter&&!!e.planType&&!!e.status&&!!e.teamAdmins&&!!e.teamId&&!!e.teamName&&!!e.tier,Q=e=>!!(e&&Array.isArray(e))&&0!==e.length&&Y(e.find(e=>"accepted"===e.status)),H=e=>{if(!e||!Q(e.spaces))return;let t=e.spaces.find(e=>"accepted"===e.status);return t?.teamId};class ${get(){let{queries:{carbonState:e}}=this.carbon;return e({path:"userSession.localSettings.premiumStatus"}).pipe((0,N.Qn)(H))}constructor(e){this.carbon=e}}$=(0,r.gn)([(0,x.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===P._?Object:P._])],$);var X=i(49594),Z=i(75264);class J extends X.K{loadResource(e){if(!(e&&Array.isArray(e)))throw Error("Important domains file corrupted");return new Set(e)}constructor(e){super("assets/important-domains.json",e)}}J=(0,r.gn)([(0,x.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===Z.X?Object:Z.X])],J);var ee=i(44577),et=i(21039);let ei=(e,t)=>e.reduce((e,i)=>void 0===t[i]?e:[...e,t[i]],[]);class es extends(0,p.ne)(){}var er=i(17507);class en extends er.f{}en=(0,r.gn)([(0,x.GS)()],en);let ea=e=>{let t=e.risks.filter(e=>e.riskType===E.gI.Reused);return 1===t.length?t[0]:void 0},eo=(e,t)=>e?.risks.find(e=>e.riskType===t),ec=(e,t)=>e.risks.filter(e=>e.riskType!==t),ed=(e,t,i)=>[...i,{riskType:E.gI.Reused,credentialIds:[...t.credentialIds].filter(t=>e!==t)}],el=(e,t)=>{let i=ea(t);return{...t,risks:ec(t,E.gI.Reused).concat([{riskType:E.gI.Reused,credentialIds:i?[...i.credentialIds].concat(e.id):[e.id]}])}},eu=e=>({id:e.id,title:e.title,email:e.email,excluded:e.excluded,login:e.login,autoLogin:e.autoLogin,autoProtected:e.autoProtected,otpSecret:e.otpSecret,otpUrl:e.otpUrl,spaceId:e.spaceId,shared:e.shared,domains:e.domains,creationDatetime:e.creationDatetime}),ep=e=>({...eu(e),risks:[],isImportant:!1}),eh=(e,t,i)=>{let s=ec(t,E.gI.Reused),r=i&&i.length>0,n=s.length>0;return r||n?{...ep(e),risks:r?s.concat([{riskType:E.gI.Reused,credentialIds:i}]):s}:void 0},eg=e=>!!eo(e,E.gI.Weak),em=e=>!!ea(e),ev=e=>!!eo(e,E.gI.Compromised),ey=e=>e.excluded;function ew(e,t,i=3,s=5){if(!e||!t)return!1;let r=e.length,n=t.length;if(Math.abs(r-n)>i)return!1;if(r<s||n<s)return e===t;if(e===t)return!0;let a=Array(n+1),o=Array(n+1),c=!1;for(let e=0;e<n+1;e++)a[e]=e;for(let s=0;s<r;s++){o[0]=s+1,c=o[0]>i;for(let r=0;r<n;r++){let n=a[r+1]+1,d=o[r]+1,l=a[r];e[s]!==t[r]&&l++,o[r+1]=Math.min(n,Math.min(d,l)),c=c&&o[r+1]>i}let r=a;if(a=o,o=r,c)break}return a[n]<=i}let eS=e=>{if(0!==e.length)return{riskType:E.gI.Compromised,breaches:e}},ef=(e,t)=>Object.keys(t).reduce((i,s)=>ew(s,e.password)?[...i,...t[s]]:i,[]),eE=(e,t,i)=>{let s=ef(e,i);if(!t&&0===s.length)return{};let r=eS(s),n=t?ec(t,E.gI.Compromised):[],a={...ep(e),risks:r?n.concat(r):n};return{[e.id]:0===a.risks.length?void 0:a}},eI=(e,t,i,s)=>{let r=i.filter(e=>!t.includes(e));if(0===r.length)return{};let n={};for(let t of r){let i=s[t];if(!i)continue;let r=ea(i);if(!r)continue;let a=ec(i,E.gI.Reused);1===r.credentialIds.length&&0===a.length?n[t]=void 0:n[t]={...i,risks:1===r.credentialIds.length?a:ed(e,r,a)}}return n},eb=(e,t,i,s,r)=>{let n=t.filter(e=>!i.includes(e));if(0===n.length)return{};let a={};for(let t of n){let i=s[t];if(i)a[t]=el(e,i);else{let i=r[t];a[t]={...ep(i),risks:[{riskType:E.gI.Reused,credentialIds:[e.id]}]}}}return a},eA=(e,t)=>Object.keys(t).map(e=>t[e]).filter(t=>t.id!==e.id&&ew(t.password,e.password)).map(e=>e.id),eC=(e,t,i)=>{if(!i)return Promise.resolve({});let s=t[e.id]??ep(e),r=s.risks.length>0,n=eA(e,i);if(0===n.length&&!r)return Promise.resolve({});let a=ea(s)?.credentialIds??[],o=eI(e.id,n,a,t),c=eb(e,n,a,t,i),d=eh(e,s,n);return Promise.resolve({...o,...c,[e.id]:d})},eR=(e,t)=>{let i={};for(let s of Object.values(t)){if(!s)continue;let t=ea(s);if(!t)continue;let r=t.credentialIds.filter(t=>!e.includes(t));if(r.length!==t.credentialIds.length){let e=ec(s,E.gI.Reused);0===r.length&&0===e.length?i[s.id]=void 0:i[s.id]={...s,risks:0===r.length?e:[...e,{...t,credentialIds:r}]}}}return i};var e_=i(51860);let eO=async e=>(await (0,e_.evaluate)(e)).score,eT=async e=>{if(e)return await eO(e)/25},eF=async(e,t)=>{let i=await eT(e.password),s=t??ep(e),r=ec(s,E.gI.Weak),n=void 0!==i&&i<2;return n||0!==r.length?{[e.id]:{...s,...eu(e),risks:n?r.concat([{riskType:E.gI.Weak,strength:i}]):r}}:{[e.id]:void 0}},eD=(e,t,i)=>{if(!t)return{};let s=e.domains.some(e=>i.has(e)),r={...t,isImportant:s};return{[t.id]:r}},eU=()=>({[E.gI.Reused]:[],[E.gI.Weak]:[],[E.gI.Compromised]:[],[E.gI.Excluded]:[],corruptedCount:0,importantCorruptedCount:0}),eP=e=>{let t={};if(!Object.keys(e).length)return t;for(let i in e){if(!e[i])continue;let s=e[i]?.spaceId??"";void 0===t[s]&&(t[s]=eU()),e[i]?.excluded?t[s][E.gI.Excluded].push(i):(t[s].corruptedCount++,e[i]?.isImportant&&t[s].importantCorruptedCount++,e[i]?.risks.forEach(e=>t[s][e.riskType].push(i)))}return t},ex=e=>{let t={};return e.forEach(e=>{e.LeakedPasswords&&e.LeakedPasswords.forEach(i=>{Object.prototype.hasOwnProperty.call(t,i)?t[i].push({breachId:e.Id,date:e.Content.eventDate,domains:e.Content.domains}):t[i]=[{breachId:e.Id,date:e.Content.eventDate,domains:e.Content.domains}]})}),t},eN=async e=>{let t={},i=eG(eV,e);for(let s=0;s<i.length;s++){await ej();let r=i[s];for(let i=0;i<r.length;i++){let n=r[i],a=n.password,o=n.id,c=[],d=s*eV+i;for(let i=d+1;i<e.length;i++){let s=e[i].id,r=e[i].password,d=e[i];if(ew(a,r)){let e=t[s]??ep(d),i=eo(e,E.gI.Reused),r=i?.credentialIds??[];t[s]=eh(n,e,r.concat(o)),c.push(s)}}let l=t[o]??ep(n),u=eo(l,E.gI.Reused),p=u?.credentialIds??[];t[o]=eh(n,l,c.concat(p))}}return t},eL=(e=[])=>e.reduce((e,t)=>({...e,[t]:void 0}),{}),ek=e=>{let t={};return Object.keys(e).forEach(i=>{let s=e[i];s&&(t[i]=s)}),t},ej=(e=0)=>new Promise(t=>setTimeout(()=>t(),e)),eG=(e,t)=>Array.from({length:Math.ceil(t.length/e)},(i,s)=>t.slice(s*e,s*e+e)),eV=100,eM=async({credentialUpdates:e,allCredentials:t,breaches:i,importantDomains:s,hasUpdatedBreaches:r,healthState:n,deletedCredentialIds:a})=>{let o=ex(i),c=0===e.length&&0===a.length&&!r,d={...n?.credentialsAtRisk??{}},l=e=>Object.keys(e).forEach(t=>d[t]=e[t]);a.length>0&&l(eL(a));let u={},p={};for(let e of Object.keys(t))t[e].excluded?u[e]=ep(t[e]):p[e]=t[e];let h=[],g=[];for(let t of e)t.excluded?g.push(t):a.includes(t.id)||h.push(t);l(eR([...Object.values(g).map(e=>e.id),...a],d)),c&&l(await eN(Object.values(p)));let m=c?Object.values(p):h;if(r)for await(let e of Object.values(p))l(eE(e,d[e.id],o));for await(let e of eG(eV,m))for await(let t of(await ej(),e))r||l(eE(t,d[t.id],o)),c||l(await eC(t,d,p)),l(await eF(t,d[t.id])),l(eD(t,d[t.id],s));return l(u),{credentialsAtRisk:ek(d),index:eP(d)}};class eK{async run({updatedCredentialIds:e,deletedCredentialIds:t,hasUpdatedBreaches:i=!1}){if(this.logger.debug("Starting password health calculation"),!await this.isPasswordHealthFeatureFlipEnabled()){this.logger.debug("Password health is disabled through feature flip"),await this.store.set({credentialsAtRisk:{},index:{}}),this.eventEmitter.sendEvent("passwordHealthComputationFinished",null);return}this.logger.debug("Recovering data for calculation. Getting previous health state.");let s=await this.store.getState();this.logger.debug("Getting credentials");let r=await (0,ee.z)(this.credentialsGetter.get());this.logger.debug("Getting breaches");let n=await (0,ee.z)(this.breachesGetter.get());this.logger.debug("Getting important domains");let a=await this.importantDomains.get();if((0,L.hx)(r)||(0,L.hx)(n))throw Error("Failure getting vault data");let o=e?.length??0,c=t?.length??0,d=o>0||c>0||i,l=o+c<=50,u=d&&l?s:void 0,p=d?ei(e??[],r.data):[];this.logger.debug("Calculating updated health state",{hasUpdates:d,hasUpdatedBreaches:i,partialUpdatePossible:l});let h=await this.updateHealthState(u,i,l,p,r.data,n,a,t);await this.updateHealthStateStore(h)}async updateHealthState(e,t,i,s,r,n,a,o){try{return await eM({hasUpdatedBreaches:t,credentialUpdates:i?s:[],allCredentials:r,breaches:n.data,importantDomains:a,healthState:e,deletedCredentialIds:i?[...o??[]]:[]})}catch(e){throw Error("Failed to calculate updated health state",{cause:e})}}async updateHealthStateStore(e){try{this.logger.debug("Updating password health store value"),await this.store.set({...e}),this.eventEmitter.sendEvent("passwordHealthComputationFinished",null)}catch(e){throw Error("Failed to set password health store value",{cause:e})}}async isPasswordHealthFeatureFlipEnabled(){return!await this.isFeatureFlipEnabled(a.DisablePasswordHealth)}async isFeatureFlipEnabled(e,t=!1){let{userFeatureFlips:i}=this.featureFlips.queries,s=await (0,ee.z)(i());return(0,L.hx)(s)?t:(0,L.db)(s)[e]??t}constructor(e,t,i,s,r,n,a){this.logger=e,this.store=t,this.credentialsGetter=i,this.breachesGetter=s,this.importantDomains=r,this.eventEmitter=n,this.featureFlips=a}}eK=(0,r.gn)([(0,x.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[es,U,void 0===q?Object:q,void 0===B.U?Object:B.U,void 0===J?Object:J,void 0===en?Object:en,void 0===et.P?Object:et.P])],eK);let eW=f.z.object({lastSentDate:f.z.number()});f.z.object({lastSentDate:f.z.number(),lastHash:f.z.string()});let ez=e=>eW.safeParse(e).success;class eq extends(0,y.Q)({persist:!0,storage:{initialValue:{lastSentDate:0,lastHash:""},typeGuard:ez,schemaVersion:2,migrateStorageSchema:()=>({lastSentDate:0,lastHash:""})},scope:v.F.User,storeName:"user-activity-state",storeTypeGuard:ez,codec:S.E,capacity:w.Y._001KB,isCache:!0}){}let eB=f.z.object({isOutdated:f.z.literal(!0),lastUpdateTimestamp:f.z.number(),updatedCredentialIds:f.z.record(f.z.string()),deletedCredentialIds:f.z.record(f.z.string()),hasUpdatedBreaches:f.z.boolean()}),eY=f.z.object({isOutdated:f.z.literal(!1),lastUpdateTimestamp:f.z.number()}),eQ=f.z.discriminatedUnion("isOutdated",[eB,eY]),eH=e=>eQ.safeParse(e).success;class e$ extends(0,y.Q)({persist:!0,storage:{initialValue:{isOutdated:!1,lastUpdateTimestamp:0},typeGuard:eH,schemaVersion:1},scope:v.F.User,storeName:"health-cache-state",storeTypeGuard:eH,codec:S.E,isCache:!0,capacity:w.Y.Unlimited}){}let eX=(e,t)=>({...e,...t.slice(0,51).reduce((e,t)=>(e[t]=t,e),{})}),eZ=(e,t)=>{if(!t.isOutdated)return{isOutdated:!1,lastUpdateTimestamp:e.lastUpdateTimestamp};let{updatedCredentialIds:i,deletedCredentialIds:s,hasUpdatedBreaches:r}=t,n=e.isOutdated?{...e}:{isOutdated:!0,lastUpdateTimestamp:e.lastUpdateTimestamp,updatedCredentialIds:{},deletedCredentialIds:{},hasUpdatedBreaches:!1};return i&&(n.updatedCredentialIds=eX(n.updatedCredentialIds,i)),s&&(n.deletedCredentialIds=eX(n.deletedCredentialIds,s)),r&&(n.hasUpdatedBreaches=r),n},eJ=new(i(31256)).WU;class e0{update(e){eJ.runExclusive(async()=>{let t=await this.store.getState();this.store.set(eZ(t,e))})}async updateHealthState(){await eJ.runExclusive(async()=>{let e=await this.store.getState();(e.isOutdated||0===e.lastUpdateTimestamp||e.lastUpdateTimestamp+864e5<Date.now())&&(await this.passwordHealthCalculationService.run(this.prepCacheStateProps(e)),await this.markAsUpToDate())})}prepCacheStateProps(e){return e.isOutdated?{updatedCredentialIds:Object.keys(e.updatedCredentialIds),deletedCredentialIds:Object.keys(e.deletedCredentialIds),hasUpdatedBreaches:e.hasUpdatedBreaches}:{}}async markAsUpToDate(){await this.store.set({isOutdated:!1,lastUpdateTimestamp:new Date().getTime()})}constructor(e,t){this.store=e,this.passwordHealthCalculationService=t}}e0=(0,r.gn)([(0,x.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[e$,void 0===eK?Object:eK])],e0);class e6{async run(){await this.healthCacheUpdater.updateHealthState()}constructor(e){this.healthCacheUpdater=e}}e6=(0,r.gn)([(0,x.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===e0?Object:e0])],e6);var e1=i(59242),e2=i(76957),e4=i(87169),e5=i(89095);let e9=e=>null===e?null:Math.round(100*e);function e3(e){let t={};return Object.keys(e).forEach(i=>{let s=e[i].spaceId;void 0===t[s]?t[s]=1:t[s]++}),t}var e7=i(28109),e8=i(96272);let te=(0,e8.Vj)("get-credentials-error","Failed to get credentials"),tt=(0,e8.Vj)("upload-uvvs-error","Failed to upload UVVS");class ti{async send(){if(!await this.isAdminVisibilityEnabled())return this.logger.info("Admin visibility is not enabled"),(0,L.Vp)(void 0);let e=await (0,ee.z)(this.credentialsGetter.get());if((0,L.hx)(e))return this.logger.error("Failed to get credentials",{cause:e.error}),(0,L.Rn)(te());let t=await this.passwordHealthStore.getState(),i=await this.sendUVVS(e.data,t);return(0,L.hx)(i)?(this.logger.error("Failed to upload UVVS",{cause:i.error}),(0,L.Rn)(tt())):(0,L.Vp)(void 0)}async sendUVVS(e,t){this.logger.debug("Creating UVVS data");let i=function(e,t,i){try{let s=[];for(let r in e){let n=e[r],a=t[r];if(!n.spaceId)continue;let[o]=n.domains;if(o){let{isCompromised:e,isReused:t,isWeak:r}=function(e){let t={isCompromised:!1,isReused:!1,isWeak:!1};return e?.risks.reduce((e,t)=>{switch(t.riskType){case E.gI.Compromised:e.isCompromised=!0;break;case E.gI.Reused:e.isReused=!0;break;case E.gI.Weak:e.isWeak=!0}return e},t)??t}(a),c=function(e,t){if("number"!=typeof e&&"string"!=typeof e&&void 0!==e)return t.error(Error("Credential has an invalid creation datetime type.",{cause:{type:typeof e,value:e}})),0;if(!e)return 0;if("string"==typeof e){let i=Number(e);return Number.isNaN(i)?(t.error(Error("Credential has an invalid creation datetime string.",{cause:{value:e}})),0):i}return e}(n.creationDatetime,i);s.push({id:n.id,domain:o,creationDateUnix:c,risks:{isCompromised:e,isReused:t,isWeak:r}})}}return s}catch(e){throw Error("Failed to create UVVS data from health state",{cause:e})}}(e,t.credentialsAtRisk,this.logger);i.length||this.logger.debug("UVVS data was empty");try{return this.logger.debug("Sending UVVS data"),await this.passwordHealthClient.commands.uploadUVVS({uvvs:i})}catch(e){throw Error("Unexpected error while uploading UVVS",{cause:e})}}async isAdminVisibilityEnabled(){return!!await this.isAdminVisibilityFeatureFlipEnabled()&&await this.isAdminVisibilitySettingEnabled()}async isAdminVisibilitySettingEnabled(){return(0,ee.z)(this.getActiveSpaceSettings().pipe((0,G.U)(e=>(0,L.f2)(e,{failure:()=>!1,success:e=>e.uvvsReportEnabled??!1}))))}getActiveSpaceSettings(){return this.carbonLegacyClient.queries.getActiveSpaces().pipe((0,N.Qn)(([e])=>e),(0,N.Qn)(e=>e?.info??{}))}async isAdminVisibilityFeatureFlipEnabled(){return this.isFeatureFlipEnabled(a.ItemVisibilityPhase1)}async isFeatureFlipEnabled(e,t=!1){let{userFeatureFlips:i}=this.featureFlips.queries,s=await (0,ee.z)(i());return(0,L.hx)(s)?t:(0,L.db)(s)[e]??t}constructor(e,t,i,s,r,n){this.logger=e,this.credentialsGetter=t,this.passwordHealthStore=i,this.passwordHealthClient=s,this.carbonLegacyClient=r,this.featureFlips=n}}ti=(0,r.gn)([(0,x.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[es,void 0===q?Object:q,U,void 0===e7.L?Object:e7.L,void 0===P._?Object:P._,void 0===et.P?Object:et.P])],ti);let ts=e=>Math.floor(e/1e3);class tr{async sendIfReportUpdated(){let e=await this.getTeamId();if(!e)return(0,L.Rn)("Missing team ID.");let t=await this.userActivityStore.getState(),{currentTime:i,relativeEnd:s,relativeStart:r}=this.getTimes(t.lastSentDate),n=await this.getTeamContent(e),a=(0,e2.k)(this.md5Hasher.compute((0,e4.u)(JSON.stringify(n))));return t.lastHash===a?(0,L.Rn)("Health data has not changed from previous run."):(await this.createReport(e,i,s,r,n,a),(0,L.Vp)(void 0))}async sendReport(){let e=await this.getTeamId();if(!e)return(0,L.Rn)("Missing team ID.");let t=await this.userActivityStore.getState(),{currentTime:i,relativeEnd:s,relativeStart:r}=this.getTimes(t.lastSentDate),n=await this.getTeamContent(e);return await this.createReport(e,i,s,r,n,""),(0,L.Vp)(void 0)}getTimes(e){let t=Date.now(),i=ts(t),s=ts(e||t);return{currentTime:t,relativeEnd:i,relativeStart:s}}async getTeamContent(e){let t=await this.store.getState(),i=await this.getPerSpaceTotal();return function(e,t,i){let s=e[i],r=t[i]??0;return s?{checkedPasswords:s.excluded.length,compromisedPasswords:s.compromised.length,nbrPasswords:r,reused:s.reused.length,safePasswords:r-s.corruptedCount,securityIndex:e9((0,e5.R9)(s.corruptedCount,s.importantCorruptedCount,r-s.excluded.length))??0,weakPasswords:s.weak.length}:{checkedPasswords:0,compromisedPasswords:0,nbrPasswords:r,reused:0,safePasswords:r,securityIndex:r<e5.RG?0:e5.JK,weakPasswords:0}}(t.index,i,e)}async createReport(e,t,i,s,r,n){await (0,ee.z)(this.serverApiClient.v1.useractivity.create({userActivity:{securityIndex:0},teamActivity:e?{teamId:parseInt(e,10),activity:r}:void 0,relativeEnd:i,relativeStart:s})),this.userActivityStore.set({lastSentDate:t,lastHash:n}),this.adminVisibilitySender.send()}async getTeamId(){let e=await (0,ee.z)(this.currentSpaceGetter.get());if(!(0,L.d6)(e))throw Error("Error while retrieving current space for activity report");return(0,L.db)(e)}async getPerSpaceTotal(){let e=await (0,ee.z)(this.credentialsGetter.get());if(!(0,L.d6)(e))throw Error("Error while retrieving credentials");return e3(e.data)}constructor(e,t,i,s,r,n,a){this.serverApiClient=e,this.userActivityStore=t,this.credentialsGetter=i,this.store=s,this.md5Hasher=r,this.currentSpaceGetter=n,this.adminVisibilitySender=a}}tr=(0,r.gn)([(0,x.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===e1.l?Object:e1.l,eq,void 0===q?Object:q,U,void 0===c.f?Object:c.f,void 0===$?Object:$,void 0===ti?Object:ti])],tr);var tn=i(22713),ta=i(62506),to=i(1833);class tc{execute({body:e}){let{password:t}=e;return(0,to.D)(eT(t)).pipe((0,G.U)(e=>(0,L.Vp)(e)))}constructor(){}}tc=(0,r.gn)([(0,ta.e)(tn.c),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[])],tc);var td=i(21207);let tl=(e,t)=>t===E._x.All?[...new Set([...e[E.gI.Compromised],...e[E.gI.Reused],...e[E.gI.Weak],...e[E.gI.Excluded]])]:e[t],tu=(e,t)=>{if(0!==t.length)switch(e){case E._x.All:{let e={[E.gI.Compromised]:3,[E.gI.Weak]:2,[E.gI.Reused]:1,[E.gI.Excluded]:0};return t.reduce((t,i)=>t?e[i.riskType]>e[t.riskType]?i:t:i,void 0)}case E._x.Compromised:return t.find(e=>e.riskType===E.gI.Compromised);case E._x.Weak:return t.find(e=>e.riskType===E.gI.Weak);case E._x.Reused:return t.find(e=>e.riskType===E.gI.Reused);default:return}},tp=(e,t)=>{let i=tu(e,t);if(!i)return;let s={severity:E.bp.COMMON};switch(i.riskType){case E.gI.Compromised:{let e=[...i.breaches].sort((e,t)=>{let i=Date.parse(e.date),s=Date.parse(t.date);return i===s?0:i<s?1:-1})[0];return{...s,riskType:E.gI.Compromised,date:e.date,domain:e.domains[0]??null,severity:E.bp.STRONG}}case E.gI.Reused:return{...s,riskType:E.gI.Reused,reuseCount:i.credentialIds.length};case E.gI.Weak:return{...s,riskType:E.gI.Weak,strength:i.strength>=1?E.ub.WEAK:E.ub.EXTREMELY_WEAK}}},th=(e,t)=>{let{id:i,title:s,login:r,email:n,autoProtected:a,shared:o,excluded:c,domains:d,risks:l}=e;return{id:i,title:s,login:r,email:n,autoProtected:a,shared:o,excluded:c,domainIcon:void 0,corruptionData:tp(t,l),domain:d[0]}},tg=(e,t,i,s,r)=>{let n;return n=null!==e?tl(t[e],i):i===E._x.All?Object.keys(s):Object.keys(t).reduce((e,s)=>[...e,...tl(t[s],i)],[]),r&&(n=n.filter(e=>r.includes(e))),n.map(e=>th(s[e],i))};class tm{execute({body:e}){let{credentialIds:t,spaceId:i,healthFilter:s}=e;return this.store.state$.pipe((0,G.U)(e=>null!==i&&void 0===e.index[i]?(0,L.Vp)([]):(0,L.Vp)(tg(i,e.index,s||E._x.All,e.credentialsAtRisk,t))))}constructor(e){this.store=e}}tm=(0,r.gn)([(0,ta.e)(td.M),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[U])],tm);var tv=i(56778);class ty{isRunnable(){return(0,ee.z)(this.isHourlyActivityReportEnabled())}async run(){await this.userActivitySenderService.sendReport()}isHourlyActivityReportEnabled(){return this.featureFlipsClient.queries.userFeatureFlips().pipe((0,G.U)(e=>!(0,L.hx)(e)&&!e.data[a.DisablePasswordHealth]),(0,tv.q)(1))}constructor(e,t){this.userActivitySenderService=e,this.featureFlipsClient=t}}ty=(0,r.gn)([(0,x.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===tr?Object:tr,void 0===et.P?Object:et.P])],ty);var tw=i(37368),tS=i(97106);class tf{async execute(){return await this.healthCacheUpdater.updateHealthState(),(0,L.Vp)(void 0)}constructor(e){this.healthCacheUpdater=e}}tf=(0,r.gn)([(0,tw.W)(tS.V),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===e0?Object:e0])],tf);var tE=i(98353),tI=i(91798),tb=i(37937),tA=i(70410),tC=i(32755);let tR=e=>({date_time:new Date().getTime(),schema_version:"1.0.0",is_sensitive:!0,uuid:(0,tA.Z)().toUpperCase(),category:tC.s.SecurityMonitoring,log_type:tC.b.UserExcludedItemFromPasswordHealth,properties:e}),t_=e=>({date_time:new Date().getTime(),schema_version:"1.0.0",is_sensitive:!0,uuid:(0,tA.Z)().toUpperCase(),category:tC.s.SecurityMonitoring,log_type:tC.b.UserIncludedItemInPasswordHealth,properties:e});class tO{async execute({body:e}){let{commands:{carbon:t}}=this.carbonLegacyClient;return await t({name:"updateCredential",args:[{id:e.credentialId,update:{isExcludedFromHealth:e.excluded}}]}),await this.getActivityLogEnabled()&&this.auditLogCredentialExclusionFromRisk(e.credentialId,e.excluded),this.store.update(t=>{let i={...t.credentialsAtRisk[e.credentialId],excluded:e.excluded},s={...t};return s.credentialsAtRisk[e.credentialId]=i,s.index=eP(t.credentialsAtRisk),s}),Promise.resolve((0,L.Vp)(void 0))}async auditLogCredentialExclusionFromRisk(e,t){let{commands:{storeActivityLogs:i}}=this.activityLogsApiClient,s=await this.findCredentialRiskById(e),r=this.getActivityLogProperties(s);i({activityLogs:[t?tR(r):t_(r)]})}async findCredentialRiskById(e){return(await this.store.getState()).credentialsAtRisk[e]}async getActivityLogEnabled(){let{userFeatureFlip:e}=this.featureFlips.queries,t=await (0,ee.z)(e({featureFlip:tI.q.SharingVaultTacAuditLogsProtectedItemRevealed}));return!!(0,L.d6)(t)&&!!(0,L.db)(t)}getActivityLogProperties({email:e,login:t,domains:[i]}){return{credential_domain:i,credential_login:e||t}}constructor(e,t,i,s){this.store=e,this.carbonLegacyClient=t,this.featureFlips=i,this.activityLogsApiClient=s}}tO=(0,r.gn)([(0,tw.W)(tE.v),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[U,void 0===P._?Object:P._,void 0===et.P?Object:et.P,void 0===tb._?Object:tb._])],tO);var tT=i(94412);class tF{execute(){return this.healthCacheUpdaterService.update({isOutdated:!0}),Promise.resolve((0,L.Vp)(void 0))}constructor(e){this.healthCacheUpdaterService=e}}tF=(0,r.gn)([(0,tw.W)(tT.t),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===e0?Object:e0])],tF);var tD=i(94680),tU=i(86982);class tP{async execute({body:e}){let{uvvs:t}=e,i=await this.enclaveApiClient.uvvs.uploadUVVS({uvvs:t});if(!(0,L.d6)(i)){if("request_malformed"===i.error.code)return(0,L.Rn)((0,tU.m0)());throw Error("Unexpected error while uploading UVVS.",{cause:i.error})}return(0,L.Vp)(void 0)}constructor(e){this.enclaveApiClient=e}}tP=(0,r.gn)([(0,tw.W)(tU.Yf),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===tD.l?Object:tD.l])],tP);var tx=i(91984),tN=i(45290),tL=i(422);let tk=["Item Name","Date Created"],tj=[e=>e.domain,e=>e.creationDateUnix?(0,tL.Z)(e.creationDateUnix).toISOString():"Not available"];class tG{async execute({body:e}){let{userLogin:t}=e;this.logger.debug("Downloading UVVS");let i=await this.downloadUVVS(t);if((0,L.hx)(i))throw Error("Unexpectedly unable to fetch UVVS report",{cause:i.error});this.logger.debug("Downloaded UVVS with success");let{uvvs:s,lastUpdateDateUnix:r}=i.data;if(s.length<=0)return this.logger.debug("User has no UVVS data"),(0,L.Vp)(void 0);this.logger.debug("Serializing UVVS data into a CSV buffer");let n=(0,tL.Z)(r),a=this.getUVVSBuffer(t,n,s),o=this.getFileName();try{this.logger.debug("Downloading CSV buffer"),await this.fileDownloadService.downloadFile(o,"text/csv",a)}catch(e){throw Error("Unexpectedly unable to download exported UVVS file",{cause:e})}return this.logger.debug("Exported UVVS's CSV successfully"),(0,L.Vp)(void 0)}async downloadUVVS(e){try{return await (0,ee.z)(this.passwordHealthClient.queries.downloadUVVS({userLogin:e}))}catch(e){throw Error("Unexpected error while downloading UVVS",{cause:e})}}getUVVSBuffer(e,t,i){try{let s=this.mapToRows(i),r=this.createCSV(e,t,s);return this.createTextBuffer(r)}catch(e){throw Error("Unexpectedly unable to serialize UVVS content",{cause:e})}}createTextBuffer(e){return new TextEncoder().encode(e).buffer}createCSV(e,t,i){return[["User email",e],["Last update",t.toISOString()],[],tk].concat(i).map(e=>e.join(",")).join("\n")}mapToRows(e){return e.map(e=>tj.map(t=>t(e)))}getFileName(){return"user-report.csv"}constructor(e,t,i){this.logger=e,this.passwordHealthClient=t,this.fileDownloadService=i}}tG=(0,r.gn)([(0,tw.W)(tN.E),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[es,void 0===e7.L?Object:e7.L,void 0===tx._?Object:tx._])],tG);var tV=i(49964),tM=i(51870);class tK{async handle(){await this.isPasswordHealthEnabled()&&await this.sendActivityReport()}async sendActivityReport(){await this.isFirstRun()&&await this.userActivitySender.sendReport()}async isFirstRun(){let{lastSentDate:e}=await this.userActivityStore.getState();return 0===e}async isPasswordHealthEnabled(){let{userFeatureFlips:e}=this.featureFlips.queries,t=await (0,ee.z)(e());return!!(0,L.hx)(t)||!(0,L.db)(t)[a.DisablePasswordHealth]}constructor(e,t,i){this.featureFlips=e,this.userActivitySender=t,this.userActivityStore=i}}tK=(0,r.gn)([(0,tM.b)(tV.w),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===et.P?Object:et.P,void 0===tr?Object:tr,eq])],tK);var tW=i(23506),tz=i(39523),tq=i(53286),tB=i(83533);let tY=e=>({is_excluded:!!e&&ey(e),is_weak:!!e&&eg(e),is_reused:!!e&&em(e),is_compromised:!!e&&ev(e)});class tQ{async handle({body:e}){let{credentialId:t}=e,{commands:{trackEvent:i}}=this.cqrsClient.getClient(tz.Yu),s=tY((await (0,ee.z)(this.store.state$)).credentialsAtRisk[t]);return i({event:new tB.UserCredentialHealthReportEvent({credentialSecurityStatus:s,itemId:t})}),Promise.resolve(void 0)}constructor(e,t){this.store=e,this.cqrsClient=t}}tQ=(0,r.gn)([(0,tM.b)(tq.p),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[U,void 0===tW.w?Object:tW.w])],tQ);var tH=i(57178),t$=i(87824);class tX{handle({body:e}){let{ids:t,vaultItemType:i}=e;return i===tH.U.Credential&&this.healthCacheUpdater.update({isOutdated:!0,updatedCredentialIds:t}),Promise.resolve(void 0)}constructor(e){this.healthCacheUpdater=e}}tX=(0,r.gn)([(0,tM.b)(t$.V),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===e0?Object:e0])],tX);var tZ=i(37883);class tJ{handle({body:e}){let{ids:t,vaultItemType:i}=e;return i===tH.U.Credential&&this.healthCacheUpdater.update({isOutdated:!0,updatedCredentialIds:t}),Promise.resolve(void 0)}constructor(e){this.healthCacheUpdater=e}}tJ=(0,r.gn)([(0,tM.b)(tZ.J),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===e0?Object:e0])],tJ);var t0=i(85689);class t6{handle({body:e}){let{ids:t,vaultItemType:i}=e;return i===tH.U.Credential&&this.healthCacheUpdater.update({isOutdated:!0,deletedCredentialIds:t}),Promise.resolve(void 0)}constructor(e){this.healthCacheUpdater=e}}t6=(0,r.gn)([(0,tM.b)(t0.s),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===e0?Object:e0])],t6);var t1=i(9829);let t2=e=>{let{excluded:t,risks:i}=e;return{excluded:t,corruptionData:tp(E._x.All,i)}};class t4{execute({body:e}){let{credentialId:t}=e;return this.store.state$.pipe((0,G.U)(e=>e.credentialsAtRisk[t]?(0,L.Vp)(t2(e.credentialsAtRisk[t])):(0,L.Vp)(null)))}constructor(e){this.store=e}}t4=(0,r.gn)([(0,ta.e)(t1.w),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[U])],t4);var t5=i(56850);let t9=(e,t)=>{let{excluded:i,compromised:s,reused:r,weak:n,corruptedCount:a,importantCorruptedCount:o}=e,c=i.length,d=e9((0,e5.R9)(a,o,t-c));return{total:t,excluded:c,compromised:s.length,reused:r.length,weak:n.length,score:d}},t3=(e,t)=>{let i=0,s=0,r=0,n=0,a=0,o=0;for(let t of Object.values(e)){let{compromised:e,reused:c,weak:d,corruptedCount:l,importantCorruptedCount:u,excluded:p}=t;i+=e.length,s+=c.length,r+=d.length,n+=l,a+=u,o+=p.length}let c=(0,e5.R9)(n,a,t-o);return{compromised:i,reused:s,total:t,weak:r,score:e9(c),excluded:o}};function t7(e,t){return(0,L.hx)(e)?0:Object.keys(e.data).filter(i=>e.data[i].spaceId===t).length}class t8{execute({body:e}){let{spaceId:t=null}=e;return this.store.state$.pipe((0,j.V)(this.credentialsGetter.get(),this.cacheStateStore.state$),(0,G.U)(([e,i,s])=>{if(null!==t&&void 0===e.index[t]){let e=t7(i,t);return(0,L.Vp)({counters:{compromised:0,reused:0,score:100,total:e,weak:0,excluded:0},isInitialized:s.lastUpdateTimestamp>0})}if(null===t){let t=(0,L.hx)(i)?0:Object.keys(i.data).length;return(0,L.Vp)({counters:t3(e.index,t),isInitialized:s.lastUpdateTimestamp>0})}let r=t7(i,t);return(0,L.Vp)({counters:t9(e.index[t],r),isInitialized:s.lastUpdateTimestamp>0})}))}constructor(e,t,i){this.cacheStateStore=e,this.credentialsGetter=t,this.store=i}}t8=(0,r.gn)([(0,ta.e)(t5.e),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[e$,void 0===q?Object:q,U])],t8);var ie=i(81433),it=i(87200);let ii={[E.gI.Compromised]:1,[E.gI.Reused]:2,[E.gI.Weak]:3,[E.gI.Excluded]:4},is=(e,t)=>e?.riskType===E.gI.Compromised&&t?.riskType===E.gI.Compromised?Date.parse(t.date)-Date.parse(e.date):e?.riskType===E.gI.Reused&&t?.riskType===E.gI.Reused?t.reuseCount-e.reuseCount:e?.riskType===E.gI.Weak&&t?.riskType===E.gI.Weak?e.strength===t.strength?0:e.strength===E.ub.WEAK?1:-1:0,ir=e=>[...e].sort((e,t)=>{let i=ii[e.corruptionData?.riskType??E.gI.Excluded],s=ii[t.corruptionData?.riskType??E.gI.Excluded];if(i!==s)return i-s;{let i=is(e.corruptionData,t.corruptionData);return 0!==i?i:e.title.localeCompare(t.title)}});class ia{execute({body:e}){let{healthFilter:t,spaceId:i,pageNumber:s=1,pageSize:r=20}=e;return this.store.state$.pipe((0,G.U)(e=>null!==i&&void 0===e.index[i]?[]:ir(tg(i,e.index,t||E._x.All,e.credentialsAtRisk))),(0,G.U)(e=>{let t=e.length,i=e;return{items:e.slice(0,r*s),matchCount:t}}),(0,ie.x)((e,t)=>{let i=0===e.matchCount&&0===t.matchCount,s=0===e.items.length&&0===t.items.length;return!!i&&!!s}),(0,G.U)(L.Vp))}constructor(e){this.store=e}}ia=(0,r.gn)([(0,ta.e)(it.Q),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[U])],ia);var io=i(30289);let ic=(e,t)=>Object.keys(e).reduce((t,i)=>[...t,...e[i].compromised],[]).filter(e=>t.includes(e));class id{execute({body:e}){let{credentialIds:t}=e;return this.store.state$.pipe((0,G.U)(e=>(0,L.Vp)(ic(e.index,t))))}constructor(e){this.store=e}}id=(0,r.gn)([(0,ta.e)(io.v),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[U])],id);var il=i(29099);let iu=(e,t)=>Object.keys(e.index).reduce((i,s)=>[...i,...e.index[s].compromised.filter(i=>{let s=eo(e.credentialsAtRisk[i],E.gI.Compromised);return s?.breaches.some(e=>e.breachId===t)})],[]);class ip{execute({body:e}){let{breachId:t}=e;return this.store.state$.pipe((0,G.U)(e=>(0,L.Vp)(iu(e,t))))}constructor(e){this.store=e}}ip=(0,r.gn)([(0,ta.e)(il.A),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[U])],ip);var ih=i(73314);class ig{execute(){return this.store.state$.pipe((0,j.V)(this.credentialsGetter.get()),(0,G.U)(([e,t])=>{let i={};if(!(0,L.d6)(t))throw Error("Error while retrieving credentials");let s=e3(t.data),r=Object.keys(t.data).length,n=function(e){let t={};return Object.keys(e).forEach(i=>{let s=eo(e[i],E.gI.Compromised),r=e[i].spaceId;if(void 0===s)return;void 0===t[r]&&(t[r]={breaches:new Set,compromisedByBreaches:{}});let n=s.breaches.map(e=>e.breachId);t[r].breaches=new Set([...t[r].breaches,...n]),t[r].compromisedByBreaches[i]=new Set(n)}),t}(e.credentialsAtRisk),a=new Set([]),o={},c=0;return Object.keys(e.index).forEach(t=>{let r=e.index[t],d=t9(r,s[t]);i[t]={...d,breaches:n[t]?.breaches??new Set,compromisedByBreach:n[t]?.compromisedByBreaches??{},corrupted:r.corruptedCount},a=new Set([...a,...n[t]?.breaches??new Set]),o={...o,...n[t]?.compromisedByBreaches??{}},c+=r.corruptedCount}),i.global={...t3(e.index,r),breaches:a,compromisedByBreach:o,corrupted:c},(0,L.Vp)(i)}))}constructor(e,t){this.store=e,this.credentialsGetter=t}}ig=(0,r.gn)([(0,ta.e)(ih.b),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[U,void 0===q?Object:q])],ig);var im=i(59355),iv=i(33233);class iy{execute({body:e}){let{userLogin:t}=e;return this.getAdminProvisioningKey$().pipe((0,N.dy)(e=>this.enclaveApiClient.uvvs.downloadUVVS({adminProvisioningKey:e,requestedLogin:t})),(0,G.U)(e=>(0,L.f2)(e,{success:({snapshot:e,lastUpdateDateUnix:t})=>(0,L.Vp)({uvvs:e,lastUpdateDateUnix:t}),failure:e=>"tag"in e?(0,L.Rn)(e):this.handleEnclaveProxyError(e)})))}handleEnclaveProxyError(e){switch(e.code){case"SNAPSHOT_NOT_FOUND":return(0,L.Rn)((0,iv.Mw)());case"SNAPSHOT_MALFORMED":return(0,L.Rn)((0,iv.iQ)());default:return(0,L.Rn)((0,iv.Mp)())}}getAdminProvisioningKey$(){return this.teamEnclaveClient.queries.getTeamIdentifiers().pipe((0,N.lk)(({adminProvisioningKey:e})=>e?(0,L.Vp)(e):(0,L.Rn)((0,iv.Lq)())))}constructor(e,t){this.teamEnclaveClient=e,this.enclaveApiClient=t}}iy=(0,r.gn)([(0,ta.e)(iv.Up),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===im.G?Object:im.G,void 0===tD.l?Object:tD.l])],iy);class iw{}iw=(0,r.gn)([(0,d.Y)({api:n.d,crons:[{handler:e6,name:"health-cache",periodInMinutes:15,scope:v.F.User},{handler:ty,name:"user-activity-report",periodInMinutes:60,scope:v.F.User}],handlers:{commands:{updateIsCredentialExcluded:tO,recalculatePasswordHealth:tF,updateHealthState:tf,uploadUVVS:tP,exportUVVS:tG},events:{...(0,d.g)(n.d,{passwordHealthComputationFinished:tK}),...(0,d.g)(g.Y,{passwordAutofillPerformed:tQ}),...(0,d.g)(m.L,{updated:tX,created:tJ,deleted:t6})},queries:{credentialHealthData:t4,score:t8,filterCredentials:ia,filterCredentialsIds:tm,compromisedCredentials:id,compromisedCredentialsIdsForBreach:ip,passwordHealthReport:ig,scoreForPassword:tc,downloadUVVS:iy}},imports:[o.n,h.G,l.l,u.G],stores:[U,eq,e$],providers:[(0,p.d_)(es),q,B.U,J,eK,e0,e6,en,tr,U,c.f,$,ty,ti],requiredFeatureFlips:[a.DisablePasswordHealth,a.ItemVisibilityPhase1]})],iw)},89095:function(e,t,i){i.d(t,{JK:()=>r,R9:()=>n,RG:()=>s});let s=5,r=100;function n(e,t,i){return i<s?null:.2+.8*(.6*Math.pow(1-t/i,1)+.4*Math.pow(1-e/i,1))}},91857:function(e,t,i){i.d(t,{E:()=>q});var s=i(21636),r=i(48035),n=i(35358),a=i(20933),o=i(44577),c=i(17460),d=i(28109),l=i(94190),u=i(1144),p=i(306),h=i(83533),g=i(49219),m=i(49499),v=i(57178),y=i(4495),w=i(47244),S=i(71596),f=i(15021),E=i(59982),I=i(68238),b=i(18550),A=i(20458);let C=e=>!!e&&"object"==typeof e&&(0,b.l$)(e,"lastSentDate")&&"number"==typeof e.lastSentDate;class R extends(0,E.Q)({codec:A.E,persist:!0,storage:{initialValue:{lastSentDate:0},schemaVersion:1,typeGuard:C},scope:f.F.User,storeName:"vault-report",storeTypeGuard:C,capacity:I.Y._001KB,isCache:!0}){}let _="global",O={collectionsCount:-1,collectionsSharedCount:-1,multipleCollectionsCount:-1,multipleCollectionsSharedCount:-1,singleCollectionCount:-1,singleCollectionSharedCount:-1};var T=i(31512);let F=e=>e.reduce((e,t)=>({...e,[t.id]:{...t}}),{}),D=(e,t=[])=>{let i={[_]:{totalCount:0,sharedCount:0}};return e.forEach(e=>{let s=e.spaceId;void 0===i[s]&&(i[s]={totalCount:0,sharedCount:0}),i[s].totalCount++,i[_].totalCount++,t.includes(e.id)&&(i[s].sharedCount++,i[_].sharedCount++)}),i};var U=i(89095);let P=(e,t)=>({total_count:t?.totalCount??0,shared_count:t?.sharedCount??0,collections_count:e?.collectionsCount??0,collections_shared_count:e?.collectionsSharedCount??0,multiple_collections_count:e?.multipleCollectionsCount??0,multiple_collections_shared_count:e?.multipleCollectionsSharedCount??0,single_collection_count:e?.singleCollectionCount??0,single_collection_shared_count:e?.singleCollectionSharedCount??0}),x=(e,t)=>e?{passwordsSafeCount:t.totalCount-e.corrupted,passwordsExcludedCount:e.excluded,passwordsCompromisedCount:e.compromised,passwordsReusedCount:e.reused,securityScore:e.score??void 0,passwordsWeakCount:e.weak}:{passwordsSafeCount:t.totalCount,passwordsExcludedCount:0,passwordsCompromisedCount:0,passwordsReusedCount:0,securityScore:t.totalCount<U.RG?void 0:U.JK,passwordsWeakCount:0},N=(e,t)=>t.reduce((t,i)=>({totalCount:t.totalCount+(i[e]?.totalCount??0),sharedCount:t.sharedCount+(i[e]?.sharedCount??0)}),{totalCount:0,sharedCount:0}),L=(e,t,i,s,r)=>{let n=D([...t.idCardsResult.items,...t.socialSecurityIdsResult.items,...t.driversLicensesResult.items,...t.fiscalIdsResult.items,...t.passportsResult.items]),a=D(t.secureNotesResult.items,r),o=D(t.secretsResult.items,r),c=D(t.passkeysResult.items,r),d=D([...t.paymentCardsResult.items,...t.bankAccountsResult.items]),l=D([...t.addressesResult.items,...t.emailsResult.items,...t.phonesResult.items,...t.websitesResult.items,...t.companiesResult.items,...t.identitiesResult.items]),{totalCount:u,sharedCount:p}=N(e,[i,n,l,d,o,a,c]);return{itemsTotalCount:u,itemsSharedCount:p,ids:P(s.ids,n[e]),personalInfo:P(s.personalInfo,l[e]),secureNotes:P(s.secureNotes,a[e]),secrets:P(void 0,o[e]),passkeys:P(void 0,c[e]),payments:P(s.payments,d[e]),passwords:P(s.passwords,i[e])}},k=[v.U.Email,v.U.Address,v.U.Company,v.U.Phone,v.U.Website,v.U.Identity],j=[v.U.BankAccount,v.U.PaymentCard],G=[v.U.DriversLicense,v.U.FiscalId,v.U.IdCard,v.U.Passport,v.U.SocialSecurityId],V=[v.U.Credential,v.U.SecureNote,v.U.Secret,v.U.Passkey,...k,...j,...G];class M{getSpaceScope(e){switch(e){case"":return h.Scope.Personal;case _:return h.Scope.Global;default:return h.Scope.Team}}async send(){let e=await (0,o.z)(this.passwordHealth.queries.passwordHealthReport());if((0,p.hx)(e))return Promise.reject(Error("Error while retrieving health report for creating the vault report"));let t=await (0,o.z)(this.breachesGetter.getSupportedBreaches());if((0,p.hx)(t))return Promise.reject(Error("Error while retrieving breaches for creating the vault report"));let i=await (0,o.z)(this.vaultCrud.queries.query({vaultItemTypes:V}));if((0,p.hx)(i))return Promise.reject(Error("Error while retrieving credentials for creating the vault report"));let s=(0,p.db)(i).credentialsResult,r=await (0,o.z)(this.autofillSettings.queries.getPreferencesForCredentials({}));if((0,p.hx)(r))return Promise.reject(Error("Error while retrieving credential preferences for creating the vault report"));let n=await (0,o.z)(this.vault.queries.queryCollections({}));if((0,p.hx)(n))return Promise.reject(Error("Error while retrieving collections for creating the vault report"));let a=await (0,o.z)(this.sharedCollections.queries.sharedCollectionsWithItems());if((0,p.hx)(a))return Promise.reject(Error("Error while retrieving shared collections for creating the vault report"));let c=await (0,o.z)(this.sharedItems.queries.sharedItemsIds());if((0,p.hx)(c))return Promise.reject(Error("Error while retrieving shared items ids for creating the vault report"));let d=function(e,t,i){let s=F(e),r=F(t),n={[_]:{domainsWithoutAutofillCount:0,totalCount:0,sharedCount:0,passwordsWithOtpCount:0,passwordsProtectedWithMasterPasswordCount:0}};return Object.keys(s).forEach(e=>{let t=s[e].spaceId;void 0===n[t]&&(n[t]={domainsWithoutAutofillCount:0,totalCount:0,sharedCount:0,passwordsWithOtpCount:0,passwordsProtectedWithMasterPasswordCount:0}),n[t].totalCount++,n[_].totalCount++,i.includes(e)&&(n[t].sharedCount++,n[_].sharedCount++),!r[e].useAutoLogin&&(n[t].domainsWithoutAutofillCount++,n[_].domainsWithoutAutofillCount++),(s[e].otpSecret||s[e].otpURL)&&(n[t].passwordsWithOtpCount++,n[_].passwordsWithOtpCount++),r[e].requireMasterPassword&&(n[t].passwordsProtectedWithMasterPasswordCount++,n[_].passwordsProtectedWithMasterPasswordCount++)}),n}(s.items,(0,p.db)(r),c.data),l=function(e,t){let i=new Set,s=new Set;e.forEach(e=>{(0,T.F7)(e.Content)?s.add(e.Id):i.add(e.Id)});let r=new Set,n=new Set,a={global:{activePrivateBreachAlerts:0,activePublicBreachAlerts:0,passwordsCompromisedThroughPrivateBreaches:0,privateBreachAlerts:s.size,publicBreachAlerts:i.size}};return Object.keys(t).forEach(e=>{if(e===_)return;let o=t[e];void 0===a[e]&&(a[e]={activePrivateBreachAlerts:0,activePublicBreachAlerts:0,passwordsCompromisedThroughPrivateBreaches:0,privateBreachAlerts:s.size,publicBreachAlerts:i.size}),[...o.breaches].forEach(t=>{i.has(t)?(a[e].activePublicBreachAlerts++,r.add(t)):s.has(t)&&(a[e].activePrivateBreachAlerts++,n.add(t))}),Object.keys(o.compromisedByBreach).forEach(t=>{[...o.compromisedByBreach[t]].some(e=>s.has(e))&&a[e].passwordsCompromisedThroughPrivateBreaches++}),a[_].passwordsCompromisedThroughPrivateBreaches+=a[e].passwordsCompromisedThroughPrivateBreaches}),a[_].activePrivateBreachAlerts=n.size,a[_].activePublicBreachAlerts=r.size,a}(t.data,e.data);return Object.keys(d).forEach(t=>{let s=e.data[t],r=function(e,t,i){let s,r,n,a;let o=[...e,...t].filter(e=>i===_||i&&e.spaceId||!i&&!e.spaceId),c=i?t.length:0,d=i===_?e.length:e.filter(e=>i&&e.spaceId||!i&&!e.spaceId).length;return{itemsPerCollectionAverageCount:function(e){if(0===e.length)return 0;let t=0,i=0;for(let s of e)s.vaultItems.length>0&&(i+=s.vaultItems.length,t++);return 0===t?0:Math.round(i/t)}(o),collectionsPerItemAverageCount:function(e){if(0===e.length)return 0;let t=e.flatMap(e=>e.vaultItems);if(0===t.length)return 0;let i=new Set(t.map(e=>e.id)).size;return Math.round(t.length/i)}(o),ids:O,passwords:(s=0,r=0,n=0,a=0,Object.values(o.reduce((e,t)=>(t.vaultItems.forEach(i=>{let s=i.id;e[s]?(e[s].all++,t.isShared&&e[s].shared++):e[s]={all:1,shared:+!!t.isShared}}),e),{})).forEach(e=>{e.all>1?s++:1===e.all&&r++,e.shared>1?n++:1===e.shared&&a++}),{collectionsCount:o.length,collectionsSharedCount:o.filter(e=>e.isShared).length,multipleCollectionsCount:s,multipleCollectionsSharedCount:n,singleCollectionCount:r,singleCollectionSharedCount:a}),payments:O,personalInfo:O,secureNotes:O,collectionsSharedCount:c,collectionsTotalCount:c+d}}((0,p.db)(n).collections,a.data,t),o={scope:this.getSpaceScope(t),...r,...d[t],...l[t]},u=x(s,d[t]),g=L(t,i.data,d,r,c.data),m=new h.UserVaultReportEvent({...o,...u,...g});this.analytics.commands.trackEvent({event:m})}),this.store.set({lastSentDate:Date.now()}),Promise.resolve()}async shouldBeSent(){return(await (0,o.z)(this.store.state$)).lastSentDate+864e5<Date.now()}constructor(e,t,i,s,r,n,a,o,c){this.autofillSettings=e,this.breachesGetter=t,this.store=i,this.analytics=s,this.passwordHealth=r,this.vault=n,this.vaultCrud=a,this.sharedCollections=o,this.sharedItems=c}}M=(0,s.gn)([(0,l.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===c.W?Object:c.W,void 0===S.U?Object:S.U,R,void 0===u.R?Object:u.R,void 0===d.L?Object:d.L,void 0===y.C?Object:y.C,void 0===w.L?Object:w.L,void 0===g.L?Object:g.L,void 0===m.s?Object:m.s])],M);var K=i(49964),W=i(51870);class z{async handle(){await this.vaultReportSender.shouldBeSent()&&this.vaultReportSender.send()}constructor(e){this.vaultReportSender=e}}z=(0,s.gn)([(0,W.b)(K.w),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===M?Object:M])],z);class q{}q=(0,s.gn)([(0,r.Y)({api:n.f,handlers:{commands:{},events:{...(0,r.g)(a.d,{passwordHealthComputationFinished:z})},queries:{}},providers:[S.U,M],stores:[R]})],q)},16238:function(e,t,i){i.d(t,{v:()=>s});let s="ecommerce_cancel_flow_discounts"},7832:function(e,t,i){i.d(t,{c:()=>p});var s=i(36503),r=i(21018),n=i(41866),a=i(85472),o=i(75808),c=i(95807),d=i(990),l=i(55926),u=i(39785);let p=(0,s.Q)({name:"b2cPlansApi",commands:{downloadInvoice:r.j,refreshB2CCardInfo:n.E,requestRefund:a.E$},events:{},queries:{getB2CPlanPricing:o.W,getCancelationCouponDiscount:c.x,getRefundEligibility:d.B,getB2CCardInfo:l.t,listInvoices:u.U}})},21018:function(e,t,i){i.d(t,{j:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},41866:function(e,t,i){i.d(t,{E:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},85472:function(e,t,i){i.d(t,{E$:()=>h,FD:()=>d,HQ:()=>u,R0:()=>c,gR:()=>p,nW:()=>o,sT:()=>l});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).UserIneligible30DayPolicy="USER_INELIGIBLE_FOR_FULL_REFUND_30_DAY_POLICY",s.MonthlySubscriptionIneligible="MONTHLY_SUBSCRIPTION_INELIGIBLE_FOR_FULL_REFUND",s.NoActiveSubscriptionFound="NO_ACTIVE_PAID_SUBSCRIPTION_FOUND",s.RenewalActive="RENEWAL_ACTIVE",s.SubscriptionIneligibleForRefund="SUBSCRIPTION_INELIGIBLE_FOR_REFUND",s);let c=(0,a.Vj)("USER_INELIGIBLE_FOR_FULL_REFUND_30_DAY_POLICY","This purchase is not within the last 30 days"),d=(0,a.Vj)("MONTHLY_SUBSCRIPTION_INELIGIBLE_FOR_FULL_REFUND","Only annual subscriptions are eligible for refund"),l=(0,a.Vj)("NO_ACTIVE_PAID_SUBSCRIPTION_FOUND","User does not have an active paid subscription"),u=(0,a.Vj)("RENEWAL_ACTIVE","User must first cancel renewal before being eligible for refund"),p=(0,a.Vj)("SUBSCRIPTION_INELIGIBLE_FOR_REFUND","This subscription is not eligible for a refund");class h extends(0,r.g)({scope:n.F.User}){}},55926:function(e,t,i){i.d(t,{t:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},75808:function(e,t,i){i.d(t,{W:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},95807:function(e,t,i){i.d(t,{x:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},990:function(e,t,i){i.d(t,{B:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},39785:function(e,t,i){i.d(t,{U:()=>o,d:()=>a});var s,r=i(45429),n=i(15021),a=((s={}).NOT_LOADED="NOT_LOADED",s.LOADING="LOADING",s.READY="READY",s);class o extends(0,r.k)({scope:n.F.Device}){}},61428:function(e,t,i){i.d(t,{k:()=>l});var s=i(36503),r=i(63294),n=i(85078),a=i(58545),o=i(90286),c=i(54573),d=i(14979);let l=(0,s.Q)({name:"family",commands:{joinFamily:r.pz,removeFamilyMember:n.Q8,resetJoinFamilyToken:a.Q},events:{},queries:{getJoinFamilyToken:o.$,getFamilyMembers:c.v,getNewFamilyMemberInfo:d.vs}})},63294:function(e,t,i){i.d(t,{Hx:()=>l,Le:()=>p,NJ:()=>d,Z_:()=>m,jW:()=>o,pz:()=>v,qP:()=>u,vr:()=>h,vu:()=>c,zI:()=>g});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).BadLogin="BAD_LOGIN",s.FamilyIsFull="FAMILY_FULL",s.CannotJoinMultipleFamilies="CANNOT_JOIN_MULTIPLE_FAMILIES",s.AlreadyInFamily="ALREADY_JOINED_THIS_FAMILY",s.TokenNotFound="JOIN_FAMILY_TOKEN_NOT_FOUND",s.SubscriptionUpForRenewal="USER_SUBSCRIPTION_IS_UP_FOR_RENEWAL",s.FamilyDiscontinued="FAMILY_HAS_BEEN_DISCONTINUED",s.PremiumPlusDowngrade="USER_MUST_CANCEL_PREMIUM_PLUS_RENEWAL_TO_DOWNGRADE_TO_FAMILY",s);let c=(0,a.Vj)("BAD_LOGIN","Login is invalid"),d=(0,a.Vj)("FAMILY_FULL","Family is full"),l=(0,a.Vj)("CANNOT_JOIN_MULTIPLE_FAMILIES","User cannot join multiple family plans"),u=(0,a.Vj)("ALREADY_JOINED_THIS_FAMILY","User is already in family"),p=(0,a.Vj)("JOIN_FAMILY_TOKEN_NOT_FOUND","Family token not found"),h=(0,a.Vj)("USER_SUBSCRIPTION_IS_UP_FOR_RENEWAL","User subscription is up for renewal"),g=(0,a.Vj)("FAMILY_HAS_BEEN_DISCONTINUED","User is trying to join a discontinued family"),m=(0,a.Vj)("USER_MUST_CANCEL_PREMIUM_PLUS_RENEWAL_TO_DOWNGRADE_TO_FAMILY","User must cancel premium plus plan to downgrade to family");class v extends(0,r.g)({scope:n.F.Device}){}},85078:function(e,t,i){i.d(t,{E6:()=>o,Q8:()=>u,Rb:()=>c,oV:()=>l,sR:()=>d});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).UserIsNotFamilyAdmin="USER_MUST_BE_FAMILY_ADMIN",s.CannotRemoveFamilyAdmin="CANNOT_REMOVE_FAMILY_ADMIN",s.UserNotMemberOfTheFamily="USER_NOT_MEMBER_OF_FAMILY",s);let c=(0,a.Vj)("USER_MUST_BE_FAMILY_ADMIN","User must be the family admin to remove a member"),d=(0,a.Vj)("CANNOT_REMOVE_FAMILY_ADMIN","Family Admin cannot be removed"),l=(0,a.Vj)("USER_NOT_MEMBER_OF_FAMILY","User is not member of the family plan");class u extends(0,r.g)({scope:n.F.Device}){}},58545:function(e,t,i){i.d(t,{Q:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},54573:function(e,t,i){i.d(t,{v:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},90286:function(e,t,i){i.d(t,{$:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},14979:function(e,t,i){i.d(t,{B8:()=>o,vs:()=>d,wD:()=>c});var s,r,n=i(45429),a=i(15021),o=((s={}).NEW_USER="NEW_USER",s.EXISTING_FREE_USER="EXISTING_FREE_USER",s.EXISTING_PREMIUM_USER="EXISTING_PREMIUM_USER",s),c=((r={}).APP_STORE="ios",r.MAC_STORE="mac",r.PLAY_STORE="playstore",r);class d extends(0,n.k)({scope:a.F.Device}){}},91255:function(e,t,i){i.d(t,{X:()=>Z});var s=i(21636),r=i(48035),n=i(37809),a=i(7832),o=i(4843),c=i(94190),d=i(59242),l=i(17741),u=i(306);class p{getPlanPricing({login:e,userKey:t,couponCode:i,language:s,hasEssentials:r}){return this.serverApiClient.v1.payments.getAccessibleWebOffers({login:e,userKey:t,couponCode:i,language:s,forceFamily:!0,hasEssentials:r}).pipe((0,l.DZ)(e=>{throw Error(`GetPlanPricing failed with error: ${e}`)}),(0,l.lk)(e=>{let{plans:t,currency:i}=e.data,{family:s,premium:r}=t,{offers:n,...a}=s,{offers:o,...c}=r,d={plans:{family:{offers:n.map(({price:e,duration:t,...i})=>({price:(e??0)*.01,billingPeriod:{periodicity:this.getPeriodicity(t.unit,t.value),value:t.value},...i})),...a},premium:{offers:o.map(({price:e,duration:t,...i})=>({price:(e??0)*.01,billingPeriod:{periodicity:this.getPeriodicity(t.unit,t.value),value:t.value},...i})),...c}},currency:i};return(0,u.Vp)(d)}))}constructor(e){this.serverApiClient=e,this.getPeriodicity=(e,t)=>"d"===e&&t>=30||"M"===e&&1===t?"monthly":"y"===e&&1===t||"M"===e&&12===t?"yearly":"other"}}p=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===d.l?Object:d.l])],p);class h{constructor(e){this.serverApiClient=e,this.getCancelationCouponDiscount=()=>this.serverApiClient.v1.premium.getB2CCancellationCoupon({}).pipe((0,l.DZ)(e=>{throw Error(`GetB2CCancellationCoupon failed with error: ${e}`)}),(0,l.lk)(e=>(0,u.Vp)({couponCode:e.data.couponCode??null})))}}h=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===d.l?Object:d.l])],h);var g=i(42589),m=i(44577),v=i(85472);let y=e=>{switch(e){case v.nW.UserIneligible30DayPolicy:return(0,u.Rn)((0,v.R0)());case v.nW.MonthlySubscriptionIneligible:return(0,u.Rn)((0,v.FD)());case v.nW.NoActiveSubscriptionFound:return(0,u.Rn)((0,v.sT)());case v.nW.RenewalActive:return(0,u.Rn)((0,v.HQ)());case v.nW.SubscriptionIneligibleForRefund:default:return(0,u.Rn)((0,v.gR)())}};class w{constructor(e){this.serverApiClient=e,this.checkRefundEligibility=()=>this.serverApiClient.v1.payments.grantFullRefundAndCancelSubscription({dryRun:!0}).pipe((0,g.U)(e=>(0,u.hx)(e)?(0,u.Vp)({isEligible:!1}):(0,u.Vp)({isEligible:!0}))),this.grantRefund=async()=>{let e=await (0,m.z)(this.serverApiClient.v1.payments.grantFullRefundAndCancelSubscription({dryRun:!1}));if((0,u.hx)(e)){if("BusinessError"===e.error.tag)return y(e.error.code);throw Error(e.error.message)}return(0,u.Vp)(void 0)}}}w=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===d.l?Object:d.l])],w);var S=i(2582),f=i(15021),E=i(59982),I=i(68238);class b extends(0,E.Q)({persist:!1,scope:f.F.Device,storeName:"b2c-Card-info",initialValue:{last4DigitsFormatted:"",expirationDateFormatted:"",hasCreditCardPaymentMethod:!1,isExpired:!1,billingCountry:"",cardType:""},capacity:I.Y._001KB}){}class A{populateB2CCardInfoStore(){return this.serverApiClient.v1.premium.getSubscriptionInfo({}).pipe((0,g.U)(e=>{if(!(0,u.d6)(e))throw Error(`Cannot retrieve subscription info. Error: ${e.error} `);let{billingInformation:t}=e.data.data.b2cSubscription;return this.cardInfoStore.set({last4DigitsFormatted:this.formatCardLast4Digits(Number(t?.last4)),expirationDateFormatted:t?.exp_year&&t.exp_month?`${t.exp_month}/${t.exp_year.toString().substring(2)}`:"",hasCreditCardPaymentMethod:!!t?.last4,isExpired:this.isBillingMethodExpired(t),billingCountry:t?.country??"",cardType:t?.type??""}),(0,u.Vp)(void 0)}))}constructor(e,t){this.serverApiClient=e,this.cardInfoStore=t,this.isBillingMethodExpired=e=>!!e?.exp_year&&!!e.exp_month&&(0,S.Z)(new Date(e.exp_year,e.exp_month,0)),this.formatCardLast4Digits=e=>e.toLocaleString("en-US",{minimumIntegerDigits:4,useGrouping:!1})}}A=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===d.l?Object:d.l,b])],A);var C=i(91984);class R{constructor(e,t){this.serverApiClient=e,this.serviceDownload=t,this.downloadInvoice=async e=>{let t=await (0,m.z)(this.getInvoice(e)),i=e.invoiceDate.replace(/[^a-zA-Z0-9]/g,"_"),s=`dashlane_invoice_${i}`;await this.serviceDownload.downloadFile(s,"application/pdf",t)},this.getInvoice=e=>{let{invoiceId:t,customerData:i}=e,{address:s,recipient:r,company:n,vatNumber:a}=i??{};return this.serverApiClient.v1.payments.getCustomerInvoice({invoiceId:t,address:s,recipient:r,company:n,vatNumber:a}).pipe((0,g.U)(e=>{if((0,u.hx)(e))throw Error("cannot retrieve invoice");return e.data}))}}}R=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===d.l?Object:d.l,void 0===C._?Object:C._])],R);var _=i(422),O=i(72233),T=i(80262),F=i(39785);class D extends(0,E.Q)({persist:!1,scope:f.F.Device,storeName:"invoice-list-store",initialValue:{status:F.d.NOT_LOADED},capacity:I.Y._001KB}){}class U{getInvoicesList(){return this.invoiceListStore.set({status:F.d.LOADING}),this.serverApiClient.v1.payments.listInvoices().pipe((0,g.U)(e=>{if((0,u.hx)(e))throw Error(`couldn't retrieve invoices: ${e.error}`);let{invoices:t}=e.data.data,i=this.getInvoiceYears(t),s=this.getInvoiceCount(t),r={invoices:t,invoiceCount:s,invoiceYearsList:i};return this.invoiceListStore.set({...r,status:F.d.READY}),(0,u.Vp)(r)}),(0,O.K)(e=>(this.invoiceListStore.set({status:F.d.NOT_LOADED}),(0,T._)(()=>Error(`Failed to load invoices: ${e.message}`)))))}constructor(e,t){this.serverApiClient=e,this.invoiceListStore=t,this.getInvoiceYears=e=>Array.from(new Set(e.map(e=>(0,_.Z)(e.startDate).getFullYear().toString()))),this.getInvoiceCount=e=>e.length}}U=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===d.l?Object:d.l,D])],U);var P=i(37368),x=i(21018);class N{async execute({body:e}){return await this.downloadInvoiceService.downloadInvoice(e),(0,u.Vp)(void 0)}constructor(e){this.downloadInvoiceService=e}}N=(0,s.gn)([(0,P.W)(x.j),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===R?Object:R])],N);var L=i(41866);class k{async execute(){return await (0,m.z)(this.cardInfoService.populateB2CCardInfoStore())}constructor(e){this.cardInfoService=e}}k=(0,s.gn)([(0,P.W)(L.E),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===A?Object:A])],k);class j{async execute(){return this.refundService.grantRefund()}constructor(e){this.refundService=e}}j=(0,s.gn)([(0,P.W)(v.E$),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===w?Object:w])],j);var G=i(56144),V=i(72907),M=i(62506),K=i(49247),W=i(75808);class z{execute(){let{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.account.login"}).pipe((0,G.h)(u.d6),(0,g.U)(e=>e.data),(0,V.w)(e=>this.webOffersService.getPlanPricing({login:e})))}constructor(e,t){this.carbonLegacyClient=e,this.webOffersService=t}}z=(0,s.gn)([(0,M.e)(W.W),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===K._?Object:K._,void 0===p?Object:p])],z);var q=i(55926);class B{execute(){return this.cardInfoStore.state$.pipe((0,g.U)(e=>(0,u.Vp)(e)))}constructor(e){this.cardInfoStore=e}}B=(0,s.gn)([(0,M.e)(q.t),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[b])],B);var Y=i(95807);class Q{execute(){return this.cancelationService.getCancelationCouponDiscount()}constructor(e){this.cancelationService=e}}Q=(0,s.gn)([(0,M.e)(Y.x),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h?Object:h])],Q);var H=i(990);class ${execute(){return this.refundService.checkRefundEligibility()}constructor(e){this.refundService=e}}$=(0,s.gn)([(0,M.e)(H.B),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===w?Object:w])],$);class X{execute(){return this.listInvoicesService.getInvoicesList()}constructor(e,t){this.listInvoicesService=e,this.invoiceListStore=t}}X=(0,s.gn)([(0,M.e)(F.U),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===U?Object:U,D])],X);class Z{}Z=(0,s.gn)([(0,r.Y)({api:a.c,handlers:{commands:{downloadInvoice:N,refreshB2CCardInfo:k,requestRefund:j},events:{},queries:{getB2CPlanPricing:z,getB2CCardInfo:B,getCancelationCouponDiscount:Q,getRefundEligibility:$,listInvoices:X}},imports:[o.n,n.l],providers:[p,h,A,w,U,R],stores:[b,D],requiredFeatureFlips:Object.values({CANCEL_DISCOUNT_FF:"b2c_ecommerce_web_optimize_cancel_flow_phase1",CANCEL_DISCOUNT_PHASE2_FF:"b2c_ecommerce_web_optimize_cancel_flow_phase2",ACCOUNT_REFERRAL_PHASE3_FF:"b2c_ecommerce_web_optimize_cancel_flow_phase3",CANCEL_FLOW_OPTIMIZATIONS_DEV:"b2c_ecommerce_web_optimize_cancel_flow_dev"})})],Z)},59173:function(e,t,i){i.d(t,{p:()=>W});var s=i(21636),r=i(48035),n=i(4843),a=i(61428),o=i(44577),c=i(42589),d=i(94190),l=i(14098),u=i(59242),p=i(70554),h=i(306);let g=(0,i(96272).Vj)("USER_MUST_BE_FAMILY_ADMIN","User must be the family admin to remove a member");var m=i(85078),v=i(63294),y=i(15021),w=i(59982),S=i(68238);class f extends(0,w.Q)({initialValue:{status:"DATA_NOT_LOADED"},persist:!1,scope:y.F.Device,storeName:"family-members-store",capacity:S.Y._010KB}){}class E extends(0,w.Q)({initialValue:{status:"DATA_NOT_LOADED"},persist:!1,scope:y.F.Device,storeName:"new-family-member-info",capacity:S.Y._001KB}){}var I=i(90555),b=i(14979);let A=e=>e.find(e=>"admin"===e.role),C=(e,t)=>e.filter(e=>e.role===t),R=e=>C(e,"admin").length+C(e,"regular").length,_=(e,t)=>t-R(e),O=(e,t)=>{switch(e){case I.lU.NO_PREMIUM:case I.lU.NEW_USER:return t?b.B8.EXISTING_FREE_USER:b.B8.NEW_USER;case I.lU.OLD_ACCOUNT:return b.B8.EXISTING_FREE_USER;case I.lU.PREMIUM:case I.lU.PREMIUM_CANCELLED:return b.B8.EXISTING_PREMIUM_USER;default:throw Error("Family getUserStatus: impossible to identify user status")}},T=e=>{switch(e?.platform){case"ios":return b.wD.APP_STORE;case"mac":return b.wD.MAC_STORE;case"playstore":return b.wD.PLAY_STORE;default:return null}};class F{constructor(e,t,i){this.serverApiClient=e,this.familyMembersStore=t,this.newFamilyMemberInfoStore=i,this.joinFamily=async(e,t)=>{let i=await (0,o.z)(this.serverApiClient.v1.familyplan.joinFamily({login:e,joinToken:t}));return(0,p.EQ)(i,{success:()=>{if((0,h.d6)(i)){let{userExists:t,statusCode:s,stopRenewalResult:r}=i.data.data;this.newFamilyMemberInfoStore.set({status:"DATA_LOADED",data:{email:e,userStatus:O(s,t),stopRenewalPlatform:T(r)??void 0}})}return(0,h.Vp)(void 0)},failure:({error:e})=>(0,p.EQ)(e,{...(0,l.X)(e=>{throw Error("Unexpected server error attempting to join family",{cause:e})}),BusinessError:e=>this.getJoinFamilyError(e.code)})})},this.removeFamilyMember=async e=>{let t=await (0,o.z)(this.serverApiClient.v1.familyplan.removeFamilyMember({userId:e}));return(0,p.EQ)(t,{success:async()=>(await this.populateFamilyMembersStore(),(0,h.Vp)(void 0)),failure:({error:e})=>(0,p.EQ)(e,{...(0,l.X)(e=>{throw Error("Unexpected server error attempting to remove family member",{cause:e})}),BusinessError:e=>this.getRemoveFamilyMemberError(e.code)})})},this.resetJoinFamilyToken=async()=>{let e=await (0,o.z)(this.serverApiClient.v1.familyplan.resetJoinToken());return(0,p.EQ)(e,{success:async()=>(await this.populateFamilyMembersStore(),(0,h.Vp)(void 0)),failure:({error:e})=>(0,p.EQ)(e,{...(0,l.X)(e=>{throw Error("Unexpected server error attempting to reset family join token",{cause:e})}),BusinessError:()=>(0,h.Rn)(g())})})},this.getRemoveFamilyMemberError=e=>{switch(e){case m.E6.UserIsNotFamilyAdmin:return(0,h.Rn)((0,m.Rb)());case m.E6.CannotRemoveFamilyAdmin:return(0,h.Rn)((0,m.sR)());case m.E6.UserNotMemberOfTheFamily:return(0,h.Rn)((0,m.oV)())}},this.getJoinFamilyError=e=>{switch(e){case v.jW.BadLogin:return(0,h.Rn)((0,v.vu)());case v.jW.FamilyIsFull:return(0,h.Rn)((0,v.NJ)());case v.jW.CannotJoinMultipleFamilies:return(0,h.Rn)((0,v.Hx)());case v.jW.AlreadyInFamily:return(0,h.Rn)((0,v.qP)());case v.jW.TokenNotFound:return(0,h.Rn)((0,v.Le)());case v.jW.SubscriptionUpForRenewal:return(0,h.Rn)((0,v.vr)());case v.jW.FamilyDiscontinued:return(0,h.Rn)((0,v.zI)());case v.jW.PremiumPlusDowngrade:return(0,h.Rn)((0,v.Z_)())}},this.populateFamilyMembersStore=async()=>{let{maxMembers:e,members:t,joinToken:i}=await (0,o.z)(this.serverApiClient.v1.familyplan.getFamilyDetails({}).pipe((0,c.U)(e=>{if((0,h.hx)(e))throw Error("Unexpected server error attempting to get family details");return e.data.data}))),s=A(t),r=_(t,e),n=C(t,"regular");if(!s)throw Error("Family does not have an admin");return this.familyMembersStore.set({status:"DATA_LOADED",data:{spotsLeft:r,admin:s,members:n,token:i}})}}}F=(0,s.gn)([(0,d.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===u.l?Object:u.l,f,E])],F);var D=i(37368);class U{async execute({body:{login:e,joinToken:t}}){return this.familyService.joinFamily(e,t)}constructor(e){this.familyService=e}}U=(0,s.gn)([(0,D.W)(v.pz),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F?Object:F])],U);class P{async execute({body:{userId:e}}){return this.familyService.removeFamilyMember(e)}constructor(e){this.familyService=e}}P=(0,s.gn)([(0,D.W)(m.Q8),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F?Object:F])],P);var x=i(58545);class N{execute(){return this.familyService.resetJoinFamilyToken()}constructor(e){this.familyService=e}}N=(0,s.gn)([(0,D.W)(x.Q),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F?Object:F])],N);var L=i(60025),k=i(62506),j=i(54573);class G{execute(){return(0,L.P)(()=>(this.familyService.populateFamilyMembersStore(),this.familyMembersStore.state$.pipe((0,c.U)(e=>"DATA_LOADED"===e.status?(0,h.Vp)(e.data):(0,h.Vp)(null)))))}constructor(e,t){this.familyService=e,this.familyMembersStore=t}}G=(0,s.gn)([(0,k.e)(j.v),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F?Object:F,f])],G);var V=i(90286);class M{execute(){return(0,L.P)(()=>(this.familyService.populateFamilyMembersStore(),this.familyMembersStore.state$.pipe((0,c.U)(e=>"DATA_LOADED"===e.status?(0,h.Vp)({tokenId:e.data.token}):(0,h.Vp)(null)))))}constructor(e,t){this.familyService=e,this.familyMembersStore=t}}M=(0,s.gn)([(0,k.e)(V.$),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F?Object:F,f])],M);class K{execute(){return this.newMemberInfoStore.state$.pipe((0,c.U)(e=>"DATA_LOADED"===e.status?(0,h.Vp)(e.data):(0,h.Vp)(null)))}constructor(e){this.newMemberInfoStore=e}}K=(0,s.gn)([(0,k.e)(b.vs),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[E])],K);class W{}W=(0,s.gn)([(0,r.Y)({api:a.k,handlers:{commands:{joinFamily:U,removeFamilyMember:P,resetJoinFamilyToken:N},events:{},queries:{getFamilyMembers:G,getJoinFamilyToken:M,getNewFamilyMemberInfo:K}},imports:[n.n],providers:[F],stores:[f,E],domainName:"plans"})],W)},1457:function(e,t,i){i.d(t,{y:()=>o});var s=i(36503),r=i(44374),n=i(92845),a=i(26698);let o=(0,s.Q)({name:"userConsents",commands:{updateConsents:r.a},events:{},queries:{getConsents:n.o,getEmailPreferenceLink:a.UE}})},44374:function(e,t,i){i.d(t,{a:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},92845:function(e,t,i){i.d(t,{o:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},26698:function(e,t,i){i.d(t,{UE:()=>o,Wp:()=>a});var s=i(96272),r=i(45429),n=i(15021);let a=(0,s.Vj)("no_user_for_key","No user for this subscription code");class o extends(0,r.k)({scope:n.F.User}){}},7588:function(e,t,i){i.d(t,{K:()=>A});var s=i(21636),r=i(48035),n=i(1457),a=i(4843),o=i(44577),c=i(42589),d=i(48194),l=i(94190),u=i(59242),p=i(17741),h=i(306),g=i(26698),m=i(72005);class v{async updateConsents({triggerBy:e,consents:t}){return await (0,o.z)(this.serverApiClient.v1.userconsents.updateConsents({triggerBy:e,consents:t}).pipe((0,p.DZ)(e=>{throw Error(e.message)}))),(0,h.Vp)(void 0)}getEmailPreferenceCenterLink(){return this.getSubscriptionCode().pipe((0,c.U)(e=>e)).pipe((0,d.z)(e=>this.serverApiClient.v1.communication.getUserEmailSubscriptionInfo({userKey:e}).pipe((0,c.U)(e=>(0,h.hx)(e)?(0,h.Rn)((0,g.Wp)()):(0,h.Vp)(e.data.data.prefCenterLink)))))}getSubscriptionCode(){let{getSubscriptionCode:e}=this.subscriptionCodeApi.queries;return e().pipe((0,c.U)(e=>{if(!(0,h.d6)(e))throw Error(e.error.message);return(0,h.db)(e)}))}constructor(e,t){this.serverApiClient=e,this.subscriptionCodeApi=t}}v=(0,s.gn)([(0,l.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===u.l?Object:u.l,void 0===m._?Object:m._])],v);var y=i(37368),w=i(44374);class S{execute({body:{triggerBy:e,consents:t}}){return this.userConsentsService.updateConsents({triggerBy:e,consents:t})}constructor(e){this.userConsentsService=e}}S=(0,s.gn)([(0,y.W)(w.a),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===v?Object:v])],S);var f=i(62506),E=i(92845);class I{execute(){return this.serverApiClient.v1.userconsents.getConsents({format:"two-consents"}).pipe((0,p.Qn)(e=>e.data),(0,p.DZ)(e=>{throw Error(e.message)}))}constructor(e){this.serverApiClient=e}}I=(0,s.gn)([(0,f.e)(E.o),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===u.l?Object:u.l])],I);class b{execute(){return this.userConsentsService.getEmailPreferenceCenterLink()}constructor(e){this.userConsentsService=e}}b=(0,s.gn)([(0,f.e)(g.UE),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===v?Object:v])],b);class A{}A=(0,s.gn)([(0,r.Y)({api:n.y,imports:[a.n],providers:[v],handlers:{commands:{updateConsents:S},events:{},queries:{getConsents:I,getEmailPreferenceLink:b}},requiredFeatureFlips:[...Object.values({EMAIL_PREFERENCE_CENTER:"ecommerce_web_admin_email_preference_center"})]})],A)},36501:function(e,t,i){i.d(t,{R:()=>u});var s=i(36503),r=i(71034),n=i(58584),a=i(7919),o=i(76640),c=i(74893),d=i(70969),l=i(13402);let u=(0,s.Q)({name:"nudges",commands:{validateNudgesInstallation:r.u,sendNudge:n.P,updateTeamNudge:a.X,uninstallNudges:o.Q},events:{},queries:{checkNudgesInstallation:c.W,getHealthAndNudgeReport:d.N,getTeamNudges:l.w}})},58584:function(e,t,i){i.d(t,{P:()=>a,m:()=>n});var s=i(66122),r=i(15021);let n="SLACK_MESSAGE_NOT_DELIVERED";class a extends(0,s.g)({scope:r.F.User}){}},76640:function(e,t,i){i.d(t,{Q:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},7919:function(e,t,i){i.d(t,{X:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},71034:function(e,t,i){i.d(t,{u:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},74893:function(e,t,i){i.d(t,{W:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},70969:function(e,t,i){i.d(t,{N:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},13402:function(e,t,i){i.d(t,{w:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},45315:function(e,t,i){i.d(t,{_:()=>L});var s=i(21636),r=i(48035),n=i(79869),a=i(36501),o=i(88288),c=i(4843),d=i(22104),l=i(59578),u=i(37368),p=i(94680),h=i(306),g=i(71034),m=i(59355),v=i(44577);class y{async execute({body:{authCode:e}}){try{let{adminProvisioningKey:t,teamUuid:i}=await this.getTeamIdentifiers();if(!t||!i){let t=await this.teamEnclaveClient.commands.createTeamInEnclave();if((0,h.hx)(t))throw Error("ValidateNudgesInstallation: failed to create team "+t.error);return this.execute(new g.u({authCode:e}))}return await this.enclaveApiClient.slack.installSlackApp({adminProvisioningKey:t,slackAuthGrant:e,teamUuid:i}),(0,h.Vp)(void 0)}catch(e){throw Error(`ValidateNudgesInstallation: ${e}`)}}async getTeamIdentifiers(){let e=await (0,v.z)(this.teamEnclaveClient.queries.getTeamIdentifiers());if((0,h.hx)(e))return{teamUuid:void 0,adminProvisioningKey:void 0};let{teamUuid:t,adminProvisioningKey:i}=(0,h.db)(e);return{teamUuid:t,adminProvisioningKey:i}}constructor(e,t){this.enclaveApiClient=e,this.teamEnclaveClient=t}}y=(0,s.gn)([(0,u.W)(g.u),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.l?Object:p.l,void 0===m.G?Object:m.G])],y);var w=i(59242),S=i(70554),f=i(649),E=i(58584);class I{async execute({body:{type:e}}){let{testSlackMessageForAdmin:t}=this.serverApiClient.v1.integration;try{let i=await (0,v.z)(t({nudge:"welcome"===e?void 0:e}));if((0,h.hx)(i))return(0,S.EQ)(i.error,{BusinessError:e=>this.getFunctionalError(e.code),FetchFailedError:()=>{throw Error("Fetch Failed error")},BadStatus:f.j,InternalServerError:f.j,InvalidRequest:f.j,RateLimited:f.j,ServiceUnavailable:f.j,UnspecifiedBadStatus:f.j});return(0,h.Vp)(void 0)}catch(e){throw Error("SendNudge: unable to send nudge"+e)}}constructor(e){this.serverApiClient=e,this.getFunctionalError=e=>{if(e===E.m)return(0,h.Rn)({tag:"SLACK_MESSAGE_NOT_DELIVERED"});throw Error(`SendNudge: error ${e}`)}}}I=(0,s.gn)([(0,u.W)(E.P),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===w.l?Object:w.l])],I);var b=i(7919);class A{async execute({body:e}){let{updateTeamNudge:t}=this.serverApiClient.v1.integration;try{let i=await (0,v.z)(t(e));if((0,h.hx)(i))throw Error(i.error.message);return(0,h.Vp)(void 0)}catch(e){throw Error("UpdateTeamNudge: "+e)}}constructor(e){this.serverApiClient=e}}A=(0,s.gn)([(0,u.W)(b.X),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===w.l?Object:w.l])],A);var C=i(76640);class R{async execute(){try{let e=await (0,v.z)(this.teamEnclaveClient.queries.getTeamIdentifiers());if((0,h.hx)(e))throw Error("UninstallNudges: team not provisioned in nitro");let{adminProvisioningKey:t,teamUuid:i}=(0,h.db)(e);if(!t)throw Error("UninstallNudges: adminProvisioningKey is missing. Could not uninstall nudges");return await this.enclaveApiClient.slack.uninstallSlackApp({teamUuid:i,adminProvisioningKey:t}),(0,h.Vp)(void 0)}catch(e){throw Error(`UninstallNudges: ${e}`)}}constructor(e,t){this.enclaveApiClient=e,this.teamEnclaveClient=t}}R=(0,s.gn)([(0,u.W)(C.Q),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.l?Object:p.l,void 0===m.G?Object:m.G])],R);var _=i(42589),O=i(62506),T=i(74893);class F{execute(){return this.teamEnclaveClient.queries.getTeamFromEnclave().pipe((0,_.U)(e=>{if((0,h.hx)(e))return(0,h.Vp)(!1);let{messageIntegrations:{slackStatus:t}}=(0,h.db)(e);return(0,h.Vp)(t)}))}constructor(e){this.teamEnclaveClient=e}}F=(0,s.gn)([(0,O.e)(T.W),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===m.G?Object:m.G])],F);var D=i(17741),U=i(70969);class P{execute({body:{numberOfDays:e}}){let{getHealthAndNudgeReport:t}=this.serverApiClient.v1.teams;return t({numberOfDays:e}).pipe((0,D.Qn)(e=>e.data),(0,D.DZ)(e=>{throw Error(e.message)}))}constructor(e){this.serverApiClient=e}}P=(0,s.gn)([(0,O.e)(U.N),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===w.l?Object:w.l])],P);var x=i(13402);class N{execute(){let{getTeamNudges:e}=this.serverApiClient.v1.integration;return e().pipe((0,D.Qn)(e=>e.data),(0,D.DZ)(e=>{throw Error(e.message)}))}constructor(e){this.serverApiClient=e}}N=(0,s.gn)([(0,O.e)(x.w),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===w.l?Object:w.l])],N);class L{}L=(0,s.gn)([(0,r.Y)({api:a.R,handlers:{commands:{validateNudgesInstallation:y,sendNudge:I,updateTeamNudge:A,uninstallNudges:R},events:{},queries:{checkNudgesInstallation:F,getHealthAndNudgeReport:P,getTeamNudges:N}},imports:[n.X,o.i,l.Z,c.n,d.G],providers:[],requiredFeatureFlips:["ace_tac_slack_integration"]})],L)},31460:function(e,t,i){i.d(t,{g:()=>l});var s=i(36503),r=i(26703),n=i(31614),a=i(42191),o=i(22773),c=i(99201),d=i(20679);let l=(0,s.Q)({name:"activityLogs",commands:{initiateActivityLogsRetrieval:r.b,loadNextActivityLogs:n.X,storeActivityLogs:a.M,encryptAuditLogDetailsBatch:o._b},events:{},queries:{activityLogs:c.I,areSensitiveLogsEnabled:d._}})},37937:function(e,t,i){i.d(t,{_:()=>n});var s=i(46266),r=i(31460);class n extends(0,s.E)(r.g){}(0,s.K)(r.g,n)},22773:function(e,t,i){i.d(t,{B6:()=>c,M:()=>d,_b:()=>l,_f:()=>o});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).ID_IS_NOT_UNIQUE="ID_IS_NOT_UNIQUE",s.GENERIC_ERROR="GENERIC_ERROR",s);let c=(0,a.Vj)("ID_IS_NOT_UNIQUE","Id is not unique"),d=(0,a.Vj)("GENERIC_ERROR","Generic error");class l extends(0,r.g)({scope:n.F.User}){}},26703:function(e,t,i){i.d(t,{b:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},31614:function(e,t,i){i.d(t,{X:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},42191:function(e,t,i){i.d(t,{M:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},91798:function(e,t,i){i.d(t,{q:()=>r});var s,r=((s={}).SharingVaultTacAuditLogsProtectedItemRevealed="sharingVault_tac_audit_logs_protected_item_revealed",s.EncryptActivityLogsDetails="setup_rollout_web_activityLogsSlice2-2",s)},99201:function(e,t,i){i.d(t,{I:()=>a,Q:()=>n});var s=i(45429),r=i(15021);let n={NOT_LOADED:"NOT_LOADED",LOADING:"LOADING",READY:"READY",ERROR:"ERROR"};class a extends(0,s.k)({scope:r.F.User}){}},20679:function(e,t,i){i.d(t,{_:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},70160:function(e,t,i){i.d(t,{Q:()=>v});var s=i(36503),r=i(11747),n=i(99073),a=i(83802),o=i(16097),c=i(13941),d=i(25257),l=i(79160),u=i(45942),p=i(51214),h=i(74266),g=i(57478),m=i(25511);let v=(0,s.Q)({name:"credentialRiskDetection",commands:{computeRiskDetectionInsights:r.N,generateMassDeploymentTeamKey:n.tv,sendRiskyPasswordLoggedOutLog:a.r,updateCredentialRiskDetectionActiveStatus:o.j,generateAndDownloadMassDeploymentScript:c.U,downloadWindowsGroupPolicyFiles:d.Q},events:{},queries:{analysePasswordForRisks:l.S,getLastLogDate:u.k,getMassDeploymentSecurityMonitoringConfiguration:p.g,getMassDeploymentSetupInformation:h.a,getRiskDetectionInsights:g.p,isCredentialRiskDetectionEnabledForDevice:m.T}})},11747:function(e,t,i){i.d(t,{N:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},25257:function(e,t,i){i.d(t,{Q:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},13941:function(e,t,i){i.d(t,{U:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},99073:function(e,t,i){i.d(t,{$m:()=>d,o1:()=>c,rI:()=>o,tv:()=>l});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).TEAM_NOT_FOUND="TEAM_NOT_FOUND",s.VALID_MASS_DEPLOYMENT_TEAM_KEY_ALREADY_EXISTS_FOR_TEAM="VALID_MASS_DEPLOYMENT_TEAM_KEY_ALREADY_EXISTS_FOR_TEAM",s);let c=(0,a.Vj)("TEAM_NOT_FOUND","[Mass Deployment - Generate Key] - Team not found"),d=(0,a.Vj)("VALID_MASS_DEPLOYMENT_TEAM_KEY_ALREADY_EXISTS_FOR_TEAM","[Mass Deployment - Generate Key] - A valid mass deployment team key already exists for the team");class l extends(0,r.g)({scope:n.F.User}){}},83802:function(e,t,i){i.d(t,{r:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},16097:function(e,t,i){i.d(t,{j:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},91209:function(e,t,i){i.d(t,{v:()=>r});var s,r=((s={}).CRDEnhancements="activationRetention_web_crd_enhancements_dev",s.RiskDetectionV2Prod="lomo_web_v2-risk-detection",s.RiskDetectionV2OnDemand="lomo_web_risk-detection-capability",s.CredentialRiskDetectionGPOPolicy="activationRetention_web_crd_gpo_settings",s.CRDInsightsV1="activationRetention_web_insights_v1",s.CRDInsightsV1Dev="activationRetention_web_insights_v1_dev",s.CRDPreviewForTrials="activationRetention_web_trial_insights_preview",s)},79160:function(e,t,i){i.d(t,{S:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},45942:function(e,t,i){i.d(t,{k:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},51214:function(e,t,i){i.d(t,{g:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},74266:function(e,t,i){i.d(t,{a:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},57478:function(e,t,i){i.d(t,{p:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},25511:function(e,t,i){i.d(t,{T:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},10222:function(e,t,i){i.d(t,{LS:()=>a,We:()=>o,Zq:()=>n,y9:()=>c});var s,r=i(96272),n=((s={}).ERROR_GETTING_ACTIVITY_LOGS="ERROR_GETTING_ACTIVITY_LOGS",s.ERROR_INITIATING_ACTIVITY_LOGS_RETRIEVAL="ERROR_INITIATING_ACTIVITY_LOGS_RETRIEVAL",s.ERROR_LOADING_NEXT_ACTIVITY_LOGS="ERROR_LOADING_NEXT_ACTIVITY_LOGS",s);let a=(0,r.Vj)("ERROR_GETTING_ACTIVITY_LOGS","[Risk Detection Insights - get-risk-detection-insights] - Failed to get activity logs"),o=(0,r.Vj)("ERROR_LOADING_NEXT_ACTIVITY_LOGS","[Risk Detection Insights - get-risk-detection-insights] - Failed to load next activity logs"),c=(0,r.Vj)("ERROR_INITIATING_ACTIVITY_LOGS_RETRIEVAL","[Risk Detection Insights - get-risk-detection-insights] - Failed to initiate activity logs retrieval")},68064:function(e,t,i){i.d(t,{k:()=>n,x:()=>a});var s,r=i(96272),n=((s={}).NOT_AUTHORIZED="NOT_AUTHORIZED",s);let a=(0,r.Vj)("NOT_AUTHORIZED","[Mass Deployment - Update Credential Risk Detection Active Status] - Server call not authorized")},38129:function(e,t,i){i.d(t,{GI:()=>r,Ss:()=>o,TY:()=>n,US:()=>a,hw:()=>c,kv:()=>d});var s=i(79199);function r(e){return"string"==typeof e&&s.T4.includes(e)}function n(e){return"string"==typeof e&&s.I3.includes(e)}function a(e){return"string"==typeof e&&s.Qh.includes(e)}function o(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)&&"massDeploymentPoliciesScript"in e&&"string"==typeof e.massDeploymentPoliciesScript&&"massDeploymentExtensionIDsAndUpdateURLs"in e&&"object"==typeof e.massDeploymentExtensionIDsAndUpdateURLs&&null!==e.massDeploymentExtensionIDsAndUpdateURLs&&!Array.isArray(e.massDeploymentExtensionIDsAndUpdateURLs)&&Object.keys(e.massDeploymentExtensionIDsAndUpdateURLs).every(a)&&Object.values(e.massDeploymentExtensionIDsAndUpdateURLs).every(e=>"string"==typeof e)}function c(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)&&Object.keys(e).every(a)&&Object.values(e).every(e=>Array.isArray(e)&&e.length===s.Bl.length&&s.Bl.every(t=>e.some(e=>"object"==typeof e&&null!==e&&"name"in e&&"string"==typeof e.name&&e.name.includes(t.name)&&"type"in e&&e.type===t.type)))}function d(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)&&"extensionPreferenceDomains"in e&&"object"==typeof e.extensionPreferenceDomains&&null!==e.extensionPreferenceDomains&&!Array.isArray(e.extensionPreferenceDomains)&&Object.keys(e.extensionPreferenceDomains).every(a)&&Object.values(e.extensionPreferenceDomains).every(e=>"string"==typeof e)&&"extensionPoliciesValue"in e&&"string"==typeof e.extensionPoliciesValue&&"browsersPreferenceDomains"in e&&"object"==typeof e.browsersPreferenceDomains&&null!==e.browsersPreferenceDomains&&!Array.isArray(e.browsersPreferenceDomains)&&Object.keys(e.browsersPreferenceDomains).every(a)&&Object.values(e.browsersPreferenceDomains).every(e=>"string"==typeof e)&&"browsersForceInstallValues"in e&&"object"==typeof e.browsersForceInstallValues&&null!==e.browsersForceInstallValues&&!Array.isArray(e.browsersForceInstallValues)&&Object.keys(e.browsersForceInstallValues).every(a)&&Object.values(e.browsersForceInstallValues).every(e=>"string"==typeof e)}},79199:function(e,t,i){i.d(t,{Bl:()=>p,I3:()=>r,NB:()=>a,Qh:()=>n,T4:()=>s,Xd:()=>l,Y:()=>c,Zf:()=>u,gr:()=>d,m2:()=>o});let s=["jamf","microsoft-intune","windows-group-policy"],r=["macos","windows","linux"],n=["chrome","edge"],a={chrome:"fdjamakpfbbddfjaooikfcpapjohcfmg",edge:"gehmmocbbkpblljhkekmfhjpfbkclbph"},o={chrome:"https://clients2.google.com/service/update2/crx",edge:"https://edge.microsoft.com/extensionwebstorebase/v1/crx"},c={chrome:"HKLM:\\SOFTWARE\\Policies\\Google\\Chrome\\3rdparty\\extensions\\fdjamakpfbbddfjaooikfcpapjohcfmg\\policy",edge:"HKLM:\\SOFTWARE\\Policies\\Microsoft\\Edge\\3rdparty\\extensions\\gehmmocbbkpblljhkekmfhjpfbkclbph\\policy"},d={chrome:"SOFTWARE\\Policies\\Google\\Chrome\\3rdparty\\extensions\\fdjamakpfbbddfjaooikfcpapjohcfmg\\policy",edge:"SOFTWARE\\Policies\\Microsoft\\Edge\\3rdparty\\extensions\\gehmmocbbkpblljhkekmfhjpfbkclbph\\policy"},l={chrome:"com.google.Chrome.extensions.fdjamakpfbbddfjaooikfcpapjohcfmg",edge:"com.microsoft.Edge.extensions.gehmmocbbkpblljhkekmfhjpfbkclbph"},u={chrome:"com.google.Chrome",edge:"com.microsoft.Edge"},p=[{type:"silent_deploy",name:"silent_deploy"},{type:"username",name:"Username"},{type:"mass_deployed_team_key",name:"MassDeployedTeamKey"}]},7795:function(e,t,i){i.r(t),i.d(t,{EncryptAuditLogDetailsBatchErrors:()=>d._f,GenerateMassDeploymentTeamKeyCommand:()=>y.tv,ActivityLogsQuery:()=>l.I,invalidUrlError:()=>j.q0,ActivityLogType:()=>p.b,CredentialRiskDetectionFeatureFlips:()=>b.v,InitiateActivityLogsRetrievalCommand:()=>a.b,SUPPORTED_BROWSERS_TO_WINDOWS_REGISTRY_PATH:()=>N.Y,ActivityLogsClient:()=>n._,isSupportedMassDeploymentOS:()=>L.TY,SetSiemConfigurationCommand:()=>j.Qj,IsCredentialRiskDetectionEnabledForDeviceQuery:()=>T.T,SUPPORTED_BROWSERS_TO_UPDATE_URL_MAPPING:()=>N.m2,createGetActivityLogsError:()=>F.LS,GetRiskDetectionInsightsQuery:()=>O.p,GetSiemConfigurationErrorCode:()=>G.At,isSupportedMassDeploymentBrowser:()=>L.US,GetRiskDetectionInsightsQueryErrorCodes:()=>F.Zq,getSiemGenericError:()=>G.Nv,SUPPORTED_BROWSERS_TO_EXTENSION_PREFERENCE_DOMAINS:()=>N.Xd,SUPPORTED_BROWSERS_TO_EXTENSION_ID_MAPPING:()=>N.NB,SendRiskyPasswordLoggedOutLogCommand:()=>w.r,createServerCallNotAuthorizedError:()=>x.x,ComputeRiskDetectionInsightsCommand:()=>E.N,siemApi:()=>k.v,noSiemConfigurationUpdateError:()=>j.$3,GROUP_POLICY_FILES:()=>N.Bl,createTeamNotFoundMassDeploymentError:()=>y.o1,mismatchingAdminProvisioningKeyError:()=>j.HC,AreSensitiveLogsEnabledQuery:()=>u._,DownloadWindowsGroupPolicyFilesCommand:()=>I.Q,createEncryptAuditLogDetailsBatchGenericError:()=>d.M,MassDeploymentSecurityMonitoringConfigurationErrorCodes:()=>x.k,SUPPORTED_MASS_DEPLOYMENT_OSS:()=>N.I3,CredentialRiskDetectionClient:()=>v,SetSiemConfigurationErrorCode:()=>j.M7,createInitiateActivityLogsRetrievalError:()=>F.y9,GenerateMassDeploymentTeamKeyCommandErrorCodes:()=>y.rI,createEncryptAuditLogDetailsBatchIdIsNotUnique:()=>d.B6,ActivityLogCategory:()=>p.s,IsCredentialRiskDetectionEnabledForDeviceQueryErrorCodes:()=>U,teamNotFoundError:()=>j.gY,GetMassDeploymentSecurityMonitoringConfigurationQuery:()=>R.g,setSiemGenericError:()=>j.SC,SUPPORTED_MASS_DEPLOYMENT_SOFTWARES:()=>N.T4,credentialRiskDetectionApi:()=>g.Q,EncryptAuditLogDetailsBatchCommand:()=>d._b,isJamfSetupInformationResult:()=>L.kv,LoadingStatus:()=>l.Q,AnalysePasswordForRisksQuery:()=>A.S,isIntuneSetupInformationResult:()=>L.Ss,SUPPORTED_BROWSERS_TO_WINDOWS_REGISTRY_GPO_PATH:()=>N.gr,isSupportedMassDeploymentSoftware:()=>L.GI,activityLogsApi:()=>r.g,ActivityLogFeatureFlips:()=>h.q,createValidMassDeploymentTeamKeyAlreadyExistsForTeamError:()=>y.$m,UpdateCredentialRiskDetectionActiveStatusCommand:()=>S.j,StoreActivityLogsCommand:()=>c.M,GetSiemConfigurationQuery:()=>G.pr,GetLastLogDateQuery:()=>C.k,SUPPORTED_MASS_DEPLOYMENT_BROWSERS:()=>N.Qh,createLoadNextActivityLogsError:()=>F.We,LoadNextActivityLogsCommand:()=>o.X,GenerateAndDownloadMassDeploymentScriptCommand:()=>f.U,SUPPORTED_BROWSERS_TO_PREFERENCE_DOMAINS:()=>N.Zf,GetMassDeploymentSetupInformationQuery:()=>_.a,isWindowsGPOSetupInformationResult:()=>L.hw,createCantGetMassDeploymentTeamKeyFromBrowserPoliciesError:()=>P});var s,r=i(31460),n=i(37937),a=i(26703),o=i(31614),c=i(42191),d=i(22773),l=i(99201),u=i(20679),p=i(32755),h=i(91798),g=i(70160),m=i(46266);class v extends(0,m.E)(g.Q){}(0,m.K)(g.Q,v);var y=i(99073),w=i(83802),S=i(16097),f=i(13941),E=i(11747),I=i(25257),b=i(91209),A=i(79160),C=i(45942),R=i(51214),_=i(74266),O=i(57478),T=i(25511),F=i(10222),D=i(96272),U=((s={}).CANT_GET_MASS_DEPLOYMENT_TEAM_KEY_FROM_BROWSER_POLICIES="CANT_GET_MASS_DEPLOYMENT_TEAM_KEY_FROM_BROWSER_POLICIES",s);let P=(0,D.Vj)("CANT_GET_MASS_DEPLOYMENT_TEAM_KEY_FROM_BROWSER_POLICIES","[Mass Deployment - Is Logged-out Monitoring Enabled for device] - Failed to get mass deployment team key from browser policies");var x=i(68064),N=i(79199),L=i(38129),k=i(50018),j=i(93447),G=i(56859)},50018:function(e,t,i){i.d(t,{v:()=>a});var s=i(36503),r=i(93447),n=i(56859);let a=(0,s.Q)({name:"siem",commands:{setSiemConfiguration:r.Qj},events:{},queries:{getSiemConfiguration:n.pr}})},93447:function(e,t,i){i.d(t,{$3:()=>l,HC:()=>d,M7:()=>o,Qj:()=>h,SC:()=>p,gY:()=>c,q0:()=>u});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).GENERIC_ERROR="GENERIC_ERROR",s.TEAM_NOT_FOUND="TEAM_NOT_FOUND",s.MISMATCHING_ADMIN_PROVISIONING_KEY="MISMATCHING_ADMIN_PROVISIONING_KEY",s.NO_SIEM_CONFIGURATION_UPDATE="NO_SIEM_CONFIGURATION_UPDATE",s.INVALID_URL="INVALID_URL",s);let c=(0,a.Vj)("TEAM_NOT_FOUND","Team not found"),d=(0,a.Vj)("MISMATCHING_ADMIN_PROVISIONING_KEY","Mismatching admin provisioning key"),l=(0,a.Vj)("NO_SIEM_CONFIGURATION_UPDATE","There's nothing to update"),u=(0,a.Vj)("INVALID_URL","Invalid URL"),p=(0,a.Vj)("GENERIC_ERROR","Generic error");class h extends(0,r.g)({scope:n.F.User}){}},56859:function(e,t,i){i.d(t,{At:()=>o,Nv:()=>c,pr:()=>d});var s,r=i(45429),n=i(15021),a=i(96272),o=((s={}).GENERIC_ERROR="GENERIC_ERROR",s);let c=(0,a.Vj)("GENERIC_ERROR","Generic error");class d extends(0,r.k)({scope:n.F.User}){}},95205:function(e,t,i){i.d(t,{Z:()=>et});var s=i(21636),r=i(48035),n=i(90573),a=i(99481),o=i(4843),c=i(22104),d=i(31460),l=i(91798),u=i(15021),p=i(59982),h=i(68238),g=i(20458),m=i(51721);let v={activityLogsQueue:[],nextAllowedAttemptTime:0,countOfFailedAttempts:0},y=e=>!!(0,m.K)(e)&&"activityLogsQueue"in e&&Array.isArray(e.activityLogsQueue),w=e=>!!(0,m.K)(e)&&"activityLogsQueue"in e&&Array.isArray(e.activityLogsQueue)&&"nextAllowedAttemptTime"in e&&"number"==typeof e.nextAllowedAttemptTime&&"countOfFailedAttempts"in e&&"number"==typeof e.countOfFailedAttempts,S=e=>{let{content:t,version:i}=e;if(1===i)return y(t)?{...v,activityLogsQueue:t.activityLogsQueue}:v;throw Error(`Unable to migrate unexpected activity-logs schema version ${i}`)};class f extends(0,p.Q)({persist:!0,storage:{initialValue:v,typeGuard:w,migrateStorageSchema:S,schemaVersion:2},scope:u.F.User,storeName:"activity-logs",storeTypeGuard:w,codec:g.E,capacity:h.Y._010KB}){}var E=i(31256),I=i(42191),b=i(37368),A=i(306),C=i(49247),R=i(44577),_=i(94190),O=i(17741);let T=e=>!!Array.isArray(e)&&(0===e.length||e.every(e=>"string"==typeof e?.teamId&&"object"==typeof e?.details&&"string"==typeof e?.details.status));class F{get(){let{queries:{carbonState:e}}=this.carbonLegacyClient;return e({path:"state.userSession.spaceData.spaces"}).pipe((0,O.Qn)(e=>{if(!T(e))throw Error("Bad space item format");let t=e.find(e=>"accepted"===e.details.status);return!!t?.details.info.collectSensitiveDataAuditLogsEnabled}))}constructor(e){this.carbonLegacyClient=e}}F=(0,s.gn)([(0,_.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===C._?Object:C._])],F);let D=e=>["user_accepted_collection_invite","user_accepted_sharing_invite_credential","user_accepted_sharing_invite_secure_note","user_added_credential_to_collection","user_added_credential_to_shared_collection","user_added_secure_note_to_collection","user_added_secure_note_to_shared_collection","user_authenticated_with_cloud_passkey","user_authenticated_with_passkey","user_copied_bank_account_field","user_copied_credential_field","user_copied_credit_card_field","user_copied_secret_field","user_copied_secure_note_field","user_created_collection","user_created_credential","user_created_secure_note","user_deleted_cloud_passkey","user_deleted_collection","user_deleted_credential","user_deleted_secure_note","user_excluded_item_from_password_health","user_imported_collection","user_included_item_in_password_health","user_modified_credential","user_modified_secure_note","user_performed_autofill_credential","user_performed_autofill_payment","user_registered_cloud_passkey","user_rejected_collection_invite","user_rejected_sharing_invite_credential","user_rejected_sharing_invite_secure_note","user_removed_credential_from_collection","user_removed_credential_from_shared_collection","user_removed_secure_note_from_collection","user_removed_secure_note_from_shared_collection","user_renamed_collection","user_renamed_shared_collection","user_revealed_bank_account_field","user_revealed_credential_field","user_revealed_credit_card_field","user_revealed_secret_field","user_revealed_secure_note_field","user_revoked_collection_user","user_revoked_collection_usergroup","user_revoked_shared_credential_email","user_revoked_shared_credential_external","user_revoked_shared_credential_group","user_revoked_shared_secure_note_email","user_revoked_shared_secure_note_external","user_revoked_shared_secure_note_group","user_shared_collection_with_user","user_shared_collection_with_usergroup","user_shared_credential_with_email","user_shared_credential_with_external","user_shared_credential_with_group","user_shared_secure_note_with_email","user_shared_secure_note_with_external","user_shared_secure_note_with_group","user_updated_collection_user","user_updated_collection_usergroup"].includes(e),U=new E.WU;class P{async execute({body:{activityLogs:e}}){let t=await (0,R.z)(this.carbonLegacyClient.queries.getActiveSpaces());if(!(0,A.d6)(t))throw Error("Cannot retrieve user spaces from carbon");if(!t.data.length)return(0,A.Vp)(void 0);let i=await (0,R.z)(this.sensitiveLogsEnabledGetter.get());if(!(0,A.d6)(i))throw Error("Error while getting sensitive logs enabled data");let s=e.filter(e=>!D(e.log_type)||i.data);return s.length&&await this.updateActivityLogsState(s),Promise.resolve((0,A.Vp)(void 0))}async updateActivityLogsState(e){await U.runExclusive(async()=>{let t=await this.activityLogsStore.getState();await this.activityLogsStore.set({...t,activityLogsQueue:[...t.activityLogsQueue,...e]})})}constructor(e,t,i){this.activityLogsStore=e,this.sensitiveLogsEnabledGetter=t,this.carbonLegacyClient=i}}P=(0,s.gn)([(0,b.W)(I.M),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[f,void 0===F?Object:F,void 0===C._?Object:C._])],P);var x=i(29047),N=i(70519);class L{async isRunnable(){let{activityLogsQueue:e,nextAllowedAttemptTime:t}=await this.activityLogsStore.getState();return e.length>0&&new Date().getTime()>=t}async run(){let{activityLogsQueue:e}=await this.activityLogsStore.getState();await this.attemptSendLogsToServer(e)}async attemptSendLogsToServer(e){let t=[...e];for(;t.length>0;){let e=t.splice(0,40);await this.sendLogsToServer(e)}}async sendLogsToServer(e){let t=e.map(e=>e.uuid),i=await this.activityLogsService.sendLogs(e);if((0,A.hx)(i)){"TEAM_NOT_FOUND"===i.error.code&&await this.removeSentLogsFromActivityLogsQueue(t),await this.increaseFailedAttempts();return}if(await this.removeSentLogsFromActivityLogsQueue(t),i.data?.invalidActivityLogs){let t=this.createLogsTypeMap(e);await this.allowedToFail.do((i.data.invalidActivityLogs??[]).map(e=>()=>{let i=t.get(e.uuid);throw Error(`An activity log with a log type of ${i} has been detected to have a technical/schema error. (${e.error})`)}))}}createLogsTypeMap(e){let t=new Map;return e.forEach(e=>{t.set(e.uuid,e.log_type)}),t}async removeSentLogsFromActivityLogsQueue(e){let{activityLogsQueue:t}=await this.activityLogsStore.getState(),i=t.filter(t=>!e.includes(t.uuid));await this.activityLogsStore.set({activityLogsQueue:[...i],countOfFailedAttempts:0,nextAllowedAttemptTime:0})}async increaseFailedAttempts(){let e=await this.activityLogsStore.getState(),t=e.countOfFailedAttempts>=4?5:e.countOfFailedAttempts+1;await this.activityLogsStore.set({...e,countOfFailedAttempts:t,nextAllowedAttemptTime:new Date().getTime()+6e4*Math.pow(2,t)-1e4})}constructor(e,t,i){this.activityLogsService=e,this.allowedToFail=t,this.activityLogsStore=i}}L=(0,s.gn)([(0,_.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===N.c?Object:N.c,void 0===x.J?Object:x.J,f])],L);var k=i(99201);class j extends(0,p.Q)({persist:!1,isCache:!0,scope:u.F.User,storeName:"activity-logs-data",initialValue:{status:k.Q.NOT_LOADED},capacity:h.Y._100KB}){}var G=i(31614),V=i(32755);let M=(e,t)=>{if(!t)return e;let{domain:i,login:s}=t;return e.filter(e=>{if(s&&!e.properties.author_login?.includes(s))return!1;if(i){let t=e.properties;if(!t.domain_url?.includes(i))return!1}return e.log_type!==V.b.UserTypedPassword||"safe"!==e.properties.health_status})},K=e=>e.map(e=>e.category===V.s.SecurityMonitoring?{...e,category:V.s.RiskDetection}:e);class W{async execute(){let e=await this.logsStore.getState(),{queryInfo:t}=e;return t?.queryExecutionId&&t.nextToken?(this.logsStore.set({...e,queryInfo:{...t,nextToken:void 0},status:k.Q.LOADING}),this.loadNextActivityLogs({state:e})):Promise.resolve((0,A.Vp)(void 0))}async loadNextActivityLogs({state:e}){if(!e.queryInfo?.queryExecutionId||!e.queryInfo.nextToken)return Promise.resolve((0,A.Vp)(void 0));let t=await this.activityLogService.getFilteredAuditLogsQueryResults(e.queryInfo.queryExecutionId,e.queryInfo.nextToken);if((0,A.hx)(t))return this.logsStore.set({status:k.Q.ERROR}),Promise.resolve((0,A.Vp)(void 0));let{logs:i,nextToken:s}=t.data,r=M(K(i),e.queryInfo.filters);return 0===r.length&&s?this.loadNextActivityLogs({state:{...e,queryInfo:{...e.queryInfo,nextToken:s}}}):(this.logsStore.set({...e,status:k.Q.READY,queryInfo:{...e.queryInfo,nextToken:s},logs:[...e.logs??[],...r]}),Promise.resolve((0,A.Vp)(void 0)))}constructor(e,t){this.logsStore=e,this.activityLogService=t}}W=(0,s.gn)([(0,b.W)(G.X),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[j,void 0===N.c?Object:N.c])],W);var z=i(22773),q=i(21039);class B extends(0,a.ne)(){}class Y{async execute({body:{auditLogDetailsItems:e}}){let t=await (0,R.z)(this.featureFlips.queries.userFeatureFlip({featureFlip:l.q.EncryptActivityLogsDetails}));if(!(0,A.d6)(t)||!t.data)return(0,A.Vp)(void 0);let i=e.filter(e=>!!e);if(0===i.length)return(0,A.Vp)(void 0);let s=await this.activityLogService.getEncryptedAuditLogDetailsBatchResult(i.map(e=>e.batchItemToEncrypt));if((0,A.hx)(s))return this.logger.error("Failed to encrypt audit log details"),(0,A.Vp)(void 0);let r=s.data.encryptedDetailsBatch.reduce((e,{id:t,encryptedDetails:s})=>{let r=i.find(e=>e.batchItemToEncrypt.id===t);return r&&(e[t]={...r.securedAuditLogDetails,encryptedDetails:s}),e},{});return(0,A.Vp)(r)}constructor(e,t,i){this.featureFlips=e,this.activityLogService=t,this.logger=i}}Y=(0,s.gn)([(0,b.W)(z._b),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===q.P?Object:q.P,void 0===N.c?Object:N.c,B])],Y);var Q=i(26703);class H{async execute({body:{startDate:e,endDate:t,filters:i}}){this.logsStore.set({status:k.Q.LOADING,queryInfo:{filters:i}});let s=await this.activityLogService.startFilteredAuditLogsQuery(1e3*e,1e3*t,i?.categories,i?.logTypes);if((0,A.hx)(s))return this.logsStore.set({status:k.Q.ERROR}),Promise.resolve((0,A.Vp)(void 0));let{data:r}=s,n=!1;do{let e=await this.activityLogService.getFilteredAuditLogsQueryResults(r);if((0,A.hx)(e)||"CANCELLED"===e.data.state||"FAILED"===e.data.state){this.logsStore.set({status:k.Q.ERROR});break}let{state:t,nextToken:s,logs:a}=e.data;if("QUEUED"===t){await new Promise(e=>setTimeout(()=>e(),1e3));continue}if("RUNNING"===t){await new Promise(e=>setTimeout(()=>e(),500));continue}let o=M(K(a),i);this.logsStore.set({status:k.Q.READY,logs:o,queryInfo:{queryExecutionId:r,nextToken:s,filters:i}}),0===o.length&&s&&this.loadNextActivityLogsCommandHandler.execute(),n=!0}while(!n);return Promise.resolve((0,A.Vp)(void 0))}constructor(e,t,i){this.logsStore=e,this.activityLogService=t,this.loadNextActivityLogsCommandHandler=i}}H=(0,s.gn)([(0,b.W)(Q.b),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[j,void 0===N.c?Object:N.c,void 0===W?Object:W])],H);var $=i(62506),X=i(42589);class Z{execute(){return this.logsStore.state$.pipe((0,X.U)(e=>(0,A.Vp)({logs:e.logs??[],hasMoreData:!!e.queryInfo?.nextToken,status:e.status})))}constructor(e){this.logsStore=e}}Z=(0,s.gn)([(0,$.e)(k.I),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[j])],Z);var J=i(20679);class ee{execute(){return this.sensitiveLogsEnabledGetter.get()}constructor(e){this.sensitiveLogsEnabledGetter=e}}ee=(0,s.gn)([(0,$.e)(J._),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F?Object:F])],ee);class et{}et=(0,s.gn)([(0,r.Y)({api:d.g,imports:[o.n,c.G,n.G],providers:[N.c,F,(0,a.d_)(B)],stores:[f,j],crons:[{handler:L,periodInMinutes:1,name:"activity-logs-cron",scope:u.F.User}],handlers:{commands:{encryptAuditLogDetailsBatch:Y,initiateActivityLogsRetrieval:H,loadNextActivityLogs:W,storeActivityLogs:P},events:{},queries:{activityLogs:Z,areSensitiveLogsEnabled:ee}},requiredFeatureFlips:[l.q.SharingVaultTacAuditLogsProtectedItemRevealed,l.q.EncryptActivityLogsDetails]})],et)},70519:function(e,t,i){i.d(t,{c:()=>d});var s=i(21636),r=i(44577),n=i(94190),a=i(94680),o=i(306),c=i(59355);class d{async sendLogs(e){let t=await this.enclaveApiClient.auditLogs.store(e);return(0,o.hx)(t)?t:t.data.invalidAuditLogs.length?(0,o.Vp)({invalidActivityLogs:t.data.invalidAuditLogs}):(0,o.Vp)(void 0)}async startFilteredAuditLogsQuery(e,t,i,s){let r=await this.getTeamAdminProvisioningKey();return this.enclaveApiClient.auditLogs.filteredQueryStart({startDateRangeUnixMs:e,endDateRangeUnixMs:t,categories:i,logTypes:s,adminAccessToken:r})}async getFilteredAuditLogsQueryResults(e,t){let i=await this.getTeamAdminProvisioningKey(),s=await this.enclaveApiClient.auditLogs.filteredQueryResults({queryExecutionId:e,nextToken:t,adminAccessToken:i});return(0,o.hx)(s)?s:(0,o.Vp)({nextToken:s.data.nextToken??void 0,state:s.data.state,logs:s.data.results??[]})}async getEncryptedAuditLogDetailsBatchResult(e){return this.enclaveApiClient.auditLogs.encryptAuditLogDetailsBatch(e)}async getTeamAdminProvisioningKey(){let e=await (0,r.z)(this.teamEnclaveClient.queries.getTeamIdentifiers());if((0,o.hx)(e))return;let{adminProvisioningKey:t}=(0,o.db)(e);return t}constructor(e,t){this.enclaveApiClient=e,this.teamEnclaveClient=t}}d=(0,s.gn)([(0,n.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===a.l?Object:a.l,void 0===c.G?Object:c.G])],d)},28266:function(e,t,i){i.d(t,{b:()=>tv});var s,r=i(21636),n=i(48035),a=i(37809),o=i(87253),c=i(4843),d=i(88288),l=i(22104),u=i(70160),p=i(91209),h=i(41098),g=i(85133),m=i(59982),v=i(68238),y=i(15021),w=i(63762);let S=w.z.object({active:w.z.boolean(),teamId:w.z.number().nullable(),configuration:w.z.nullable(w.z.object({}))}),f=e=>S.safeParse(e).success;var E=((s={}).NOT_DEPLOYED="NOT_DEPLOYED",s.EXTENSION_DEPLOYED="EXTENSION_DEPLOYED",s);let I=w.z.object({teamId:w.z.string().nullable(),status:w.z.nativeEnum(E),configuration:w.z.object({completedStep:w.z.number().min(0).max(2),isRiskDetectionActive:w.z.boolean()})}),b=e=>I.safeParse(e).success,A=w.z.object({active:w.z.boolean(),teamId:w.z.number().nullable(),configuration:w.z.nullable(w.z.object({})),lastUpdateTimestamp:w.z.number()}),C=e=>A.safeParse(e).success,R=w.z.array(w.z.object({startDate:w.z.number(),endDate:w.z.number(),nLogins:w.z.number(),nWeak:w.z.number(),nCompromised:w.z.number()})),_=w.z.enum(["compromised","weak"]),O=w.z.enum(["LOADING","SUCCESS","FAILURE"]),T=w.z.enum(["ERROR_GETTING_ACTIVITY_LOGS","ERROR_INITIATING_ACTIVITY_LOGS_RETRIEVAL","ERROR_LOADING_NEXT_ACTIVITY_LOGS"]),F=w.z.object({authorLogin:w.z.string(),weakCount:w.z.number(),compromisedCount:w.z.number(),lastActivity:w.z.object({type:_,domain:w.z.string(),date:w.z.number()})}),D=w.z.object({week:w.z.object({insights:w.z.object({nLogins:w.z.number().nullable(),nWeak:w.z.number().nullable(),nCompromised:w.z.number().nullable()}),topAtRiskEmployees:w.z.array(F),history:R,lastUpdateTimestamp:w.z.number()}),month:w.z.object({insights:w.z.object({nLogins:w.z.number().nullable(),nWeak:w.z.number().nullable(),nCompromised:w.z.number().nullable()}),topAtRiskEmployees:w.z.array(F),history:R,lastUpdateTimestamp:w.z.number()}),year:w.z.object({insights:w.z.object({nLogins:w.z.number().nullable(),nWeak:w.z.number().nullable(),nCompromised:w.z.number().nullable()}),topAtRiskEmployees:w.z.array(F),history:R,lastUpdateTimestamp:w.z.number()}),lastLogDateTime:w.z.number().nullable(),hasLogsInLastYear:w.z.boolean(),lastRunningQueryId:w.z.string().nullable(),status:O.nullable(),error:T.nullable()}),U=e=>D.safeParse(e).success,P={insights:{nLogins:null,nWeak:null,nCompromised:null},topAtRiskEmployees:[],history:[],lastUpdateTimestamp:0},x={week:{...P},month:{...P},year:{...P},lastLogDateTime:0,hasLogsInLastYear:!1,lastRunningQueryId:null,status:null,error:null};class N extends(0,m.Q)({persist:!1,scope:y.F.User,storeName:"risk-detection-insights",initialValue:x,storeTypeGuard:U,capacity:v.Y._010KB}){}class L extends(0,m.Q)({persist:!1,scope:y.F.Device,storeName:"mass-deployment-security-monitoring-configuration-for-extension",initialValue:{active:!1,teamId:null,configuration:{},lastUpdateTimestamp:0},storeTypeGuard:C,capacity:v.Y._001KB}){}class k extends(0,m.Q)({persist:!1,scope:y.F.User,storeName:"mass-deployment-security-monitoring-configuration",initialValue:{teamId:null,status:E.NOT_DEPLOYED,configuration:{completedStep:0,isRiskDetectionActive:!1}},storeTypeGuard:b,capacity:v.Y._001KB}){}class j extends(0,m.Q)({persist:!1,scope:y.F.User,storeName:"mass-deployment-security-monitoring-configuration-legacy",initialValue:{active:!1,teamId:null,configuration:{}},storeTypeGuard:f,capacity:v.Y._001KB}){}var G=i(95205),V=i(70519),M=i(44577),K=i(94190),W=i(59242),z=i(306);class q{async check(e){let t=await this.passwordHasher.hash(e),i=await (0,M.z)(this.serverApiClient.v1.pwleak.getHashes({hashPrefix:t.substring(0,6)}));if((0,z.hx)(i))throw Error("Error while retrieving list of hashes for password leak check");return i.data.data.includes(t)}constructor(e,t){this.serverApiClient=e,this.passwordHasher=t}}q=(0,r.gn)([(0,K.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===W.l?Object:W.l,void 0===g.T?Object:g.T])],q);var B=i(94680),Y=i(32755),Q=i(51376);class H{async refreshStateIfOutdated(){let e=await this.configurationForExtensionStore.getState();if(0===e.lastUpdateTimestamp||e.lastUpdateTimestamp+3e5<Date.now()){let e=await this.getConfiguration();if((0,z.d6)(e)){let t={...e.data,lastUpdateTimestamp:Date.now()};return this.configurationForExtensionStore.set(t),(0,z.Vp)(t)}return(0,z.Rn)(void 0)}return(0,z.Vp)(e)}async getConfiguration(){let e=await (0,M.z)(this.serverApiClient.v1.massdeployment.getMassDeploymentSecurityMonitoringConfigForExtension());return(0,z.hx)(e)?(0,z.Rn)(void 0):(0,z.Vp)(e.data.data)}async getUsernameFromBrowserPolicies(){let e="Username";try{let t=await (0,Q.U)();if("object"==typeof t&&null!==t&&e in t&&"string"==typeof t[e]&&t[e].length)return{username:t[e]}}catch(e){throw Error("Error getting Username property from Mass-Deployed Browser Policies.")}return{username:void 0}}constructor(e,t){this.serverApiClient=e,this.configurationForExtensionStore=t}}H=(0,r.gn)([(0,K.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===W.l?Object:W.l,L])],H);class ${async sendLogs(e){let t=await this.enclaveApiClient.auditLogsMassDeployment.store(e);return(0,z.hx)(t)?(0,z.Rn)("massdeployment/storeActivityLogs failed with an unknown HTTP error"):t.data.invalidAuditLogs.length?(0,z.Vp)({invalidActivityLogs:t.data.invalidAuditLogs}):(0,z.Vp)(void 0)}async createLog({dateTime:e,domain:t,uuid:i,healthStatus:s}){try{let r=(await this.massDeploymentConfigurationForExtensionService.getUsernameFromBrowserPolicies()).username;return{uuid:i,log_type:Y.b.UserTypedPassword,date_time:e,schema_version:"1.0.0",properties:{domain_url:t,author_login:r,health_status:s}}}catch{return null}}constructor(e,t){this.massDeploymentConfigurationForExtensionService=e,this.enclaveApiClient=t}}$=(0,r.gn)([(0,K.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===H?Object:H,void 0===B.l?Object:B.l])],$);var X=i(17741),Z=i(70554),J=i(649),ee=i(99073);class et{generateMassDeploymentTeamKey(){return(0,M.z)(this.serverApiClient.v1.massdeployment.generateMassDeploymentTeamKey().pipe((0,X.DZ)(e=>(0,Z.EQ)(e,{BusinessError:e=>this.getFunctionalError(e.code),FetchFailedError:J.j,BadStatus:J.j,InternalServerError:J.j,InvalidRequest:J.j,RateLimited:J.j,ServiceUnavailable:J.j,UnspecifiedBadStatus:J.j})),(0,X.Qn)(e=>e.data)))}getFunctionalError(e){switch(e){case ee.rI.TEAM_NOT_FOUND:return(0,ee.o1)();case ee.rI.VALID_MASS_DEPLOYMENT_TEAM_KEY_ALREADY_EXISTS_FOR_TEAM:return(0,ee.$m)();default:throw Error(`GenerateMassDeploymentTeamKey: error ${e}`)}}constructor(e){this.serverApiClient=e}}et=(0,r.gn)([(0,K.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===W.l?Object:W.l])],et);class ei{async refreshState(){let e=await this.getMassDeploymentSecurityMonitoringConfiguration();return(0,z.d6)(e)&&this.massDeploymentSecurityConfigurationStore.set({...e.data}),e}async updateCredentialRiskDetectionActiveStatus(e){let t=await this.getMassDeploymentSecurityMonitoringConfiguration();try{let{teamId:i,configuration:s}=t.data;return this.massDeploymentSecurityConfigurationStore.set({teamId:i,status:E.EXTENSION_DEPLOYED,configuration:{completedStep:s.completedStep,isRiskDetectionActive:e}}),(0,z.Vp)(void 0)}catch(e){return(0,z.Rn)("Failed to set Mass Deployment Security Monitoring Configuration store value")}}async updateMassDeploymentSecurityMonitoringConfigurationCompletedStep(e){let t=await this.getMassDeploymentSecurityMonitoringConfiguration();try{let{teamId:i,configuration:s}=t.data;return this.massDeploymentSecurityConfigurationStore.set({teamId:i,status:2===e?E.EXTENSION_DEPLOYED:E.NOT_DEPLOYED,configuration:{completedStep:e,isRiskDetectionActive:s.isRiskDetectionActive}}),(0,z.Vp)(void 0)}catch(e){return(0,z.Rn)("Failed to set Mass Deployment Security Monitoring Configuration store value")}}async getMassDeploymentSecurityMonitoringConfiguration(){let e=await this.massDeploymentSecurityConfigurationStore.getState();return(0,z.Vp)({...e,teamId:"1234"})}constructor(e){this.massDeploymentSecurityConfigurationStore=e}}ei=(0,r.gn)([(0,K.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[k])],ei);var es=i(68064);class er{async refreshState(){let e=await this.getMassDeploymentSecurityMonitoringConfiguration();return(0,z.d6)(e)&&this.massDeploymentSecurityConfigurationStore.set({...e.data}),e}async updateCredentialRiskDetectionActiveStatus(e){let t=await (0,M.z)(this.serverApiClient.v1.massdeployment.updateMassDeploymentSecurityMonitoringConfiguration({active:e}));return(0,z.hx)(t)?(0,z.Rn)((0,es.x)()):(this.refreshState(),(0,z.Vp)(void 0))}async getMassDeploymentSecurityMonitoringConfiguration(){let e=await (0,M.z)(this.serverApiClient.v1.massdeployment.getMassDeploymentSecurityMonitoringConfiguration());return(0,z.hx)(e)?(0,z.Rn)((0,es.x)()):(0,z.Vp)(e.data.data)}constructor(e,t){this.serverApiClient=e,this.massDeploymentSecurityConfigurationStore=t}}er=(0,r.gn)([(0,K.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===W.l?Object:W.l,j])],er);var en=i(31256),ea=i(10222),eo=i(85654),ec=i(54315),ed=i(16443),el=i(70147),eu=i(98799),ep=i(68517),eh=i(96338),eg=i(77781),em=i(30228);let ev={week:e=>(0,eo.Z)({start:(0,ec.Z)(e,{days:6}),end:(0,ed.Z)((0,el.Z)(e,1))}).map(e=>e.valueOf()),month:e=>(0,eu.Z)({start:(0,ec.Z)(e,{weeks:4}),end:(0,ep.Z)(e)},{weekStartsOn:1}).map(e=>e.valueOf()),year:e=>(0,eh.Z)({start:(0,ec.Z)(e,{months:11}),end:(0,eg.Z)((0,em.Z)(e,1))}).map(e=>e.valueOf())},ey=e=>{let t=Date.now(),i=ev[e](t);return{startDate:i[0],endDate:t,interval:i}},ew=e=>e.reduce((e,t)=>({nWeak:e.nWeak+t.nWeak,nCompromised:e.nCompromised+t.nCompromised}),{nWeak:0,nCompromised:0}),eS=e=>e.log_type===Y.b.UserTypedWeakPassword||e.log_type===Y.b.UserTypedPassword&&"weak"===e.properties.health_status,ef=e=>e.log_type===Y.b.UserTypedCompromisedPassword||e.log_type===Y.b.UserTypedPassword&&"compromised"===e.properties.health_status,eE=(e,t,i,s)=>{if(!e.properties.author_login||!e.properties.domain_url)return;t[s].logins.add(e.properties.author_login);let r=eS(e)?"weak":"compromised",n=i[e.properties.author_login],a=n?{...n}:{authorLogin:e.properties.author_login,weakCount:0,compromisedCount:0,lastActivity:{type:r,domain:e.properties.domain_url,date:e.date_time}};"weak"===r?(t[s].nWeak++,a.weakCount++):(t[s].nCompromised++,a.compromisedCount++),i[e.properties.author_login]={...a}},eI=(e,t,i,s)=>{let r={...s},n=t.length-1;r.hasLogsInLastYear=!!e.length||s.hasLogsInLastYear,r.lastLogDateTime=e[0]?.date_time||s.lastLogDateTime;let a=[],o={};for(let e=0;e<n;e++)a.push({startDate:t[e],endDate:t[e+1]-1,logins:new Set,nWeak:0,nCompromised:0});let c=a.length-1;for(let t=0;t<e.length;t++){let i=e[t];if((eS(i)||ef(i))&&i.date_time>=a[0].startDate){for(;i.date_time<a[c].startDate;)c--;eE(i,a,o,c)}}let d=new Set;return r[i].history=a.map(e=>(d=new Set([...d,...e.logins]),{startDate:e.startDate,endDate:e.endDate,nWeak:e.nWeak,nCompromised:e.nCompromised,nLogins:e.logins.size})),r[i].insights={nLogins:d.size,...ew(r[i].history)},r[i].lastUpdateTimestamp=Date.now(),r[i].topAtRiskEmployees=Object.values(o).sort((e,t)=>t.compromisedCount-e.compromisedCount).slice(0,10),r},eb=new en.WU,eA=[Y.b.UserTypedCompromisedPassword,Y.b.UserTypedWeakPassword,Y.b.UserTypedPassword],eC=[Y.s.RiskDetection,Y.s.SecurityMonitoring],eR=e=>{switch(e){case ea.Zq.ERROR_INITIATING_ACTIVITY_LOGS_RETRIEVAL:return(0,ea.y9)();case ea.Zq.ERROR_GETTING_ACTIVITY_LOGS:default:return(0,ea.LS)()}};class e_{async getAllRiskDetectionLogsBetweenDates(e,t){let i,s;let r=!1,n=[];try{let s=await this.activityLogsService.startFilteredAuditLogsQuery(e,t,eC,eA);if((0,z.hx)(s))return{data:[],error:(0,ea.y9)()};i=s.data,await this.riskDetectionInsightsStore.set({...await this.riskDetectionInsightsStore.getState(),lastRunningQueryId:i})}catch{return{data:[],error:(0,ea.y9)()}}do{let e=await this.activityLogsService.getFilteredAuditLogsQueryResults(i,s);if((0,z.hx)(e)||"FAILED"===e.data.state||"CANCELLED"===e.data.state)return{data:[],error:(0,ea.LS)()};s=e.data.nextToken,n=n.concat(e.data.logs),r=!!s||"QUEUED"===e.data.state||"RUNNING"===e.data.state,("QUEUED"===e.data.state||"RUNNING"===e.data.state)&&await new Promise(e=>setTimeout(e,1e3))}while(r);return{data:n}}async refreshRiskDetectionInsights(e){return eb.runExclusive(async()=>{let{startDate:t,endDate:i,interval:s}=ey(e),r=await this.riskDetectionInsightsStore.getState(),n=0===r[e].lastUpdateTimestamp,a=r[e].lastUpdateTimestamp+3e5<Date.now();if(!(n||a)||r.lastRunningQueryId)return;await this.riskDetectionInsightsStore.set({...r,status:"LOADING",error:null});let o=await this.getAllRiskDetectionLogsBetweenDates(t,i);if(o.error)this.riskDetectionInsightsStore.set({...r,status:"FAILURE",error:o.error.tag,lastRunningQueryId:null});else{let t=eI(o.data,s,e,r);this.riskDetectionInsightsStore.set({...t,status:"SUCCESS",error:null,lastRunningQueryId:null})}})}constructor(e,t){this.activityLogsService=e,this.riskDetectionInsightsStore=t}}e_=(0,r.gn)([(0,K.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===V.c?Object:V.c,N])],e_);var eO=i(42589),eT=i(49247),eF=i(91984),eD=i(70410),eU=i(79199);let eP=e=>new TextEncoder().encode(e).buffer,ex=e=>e.toISOString().replace(/,/g,"").replace(/T/gi," ").slice(0,-5),eN=e=>e.charAt(0).toLocaleUpperCase()+e.slice(1),eL=(e,t)=>{let i=eN(t);return{file:eP(`
<Registry 
  clsid="{9CD4B2F4-923D-47f5-A062-E897DD1DAD50}" 
  name="${i}-MassDeployedTeamKey" 
  status="MassDeployedTeamKey" 
  image="7" 
  changed="${ex(new Date)}" 
  uid="{${(0,eD.Z)().toUpperCase()}}"> 
<Properties 
  action="U" 
  displayDecimal="0" 
  default="0" 
  hive="HKEY_LOCAL_MACHINE" 
  key="${eU.gr[t]}"
  name="MassDeployedTeamKey" 
  type="REG_SZ" 
  value="${e}"
/>
</Registry>`),name:`${i}-MassDeployedTeamKey`}},ek=e=>({file:eP(`
<Registry 
  clsid="{9CD4B2F4-923D-47f5-A062-E897DD1DAD50}"
  name="${eN(e)}-silent_deploy" 
  status="silent_deploy" 
  image="10" 
  changed="${ex(new Date)}" 
  uid="{${(0,eD.Z)().toUpperCase()}}" 
  bypassErrors="1"> 
  
<Properties 
  action="C" 
  displayDecimal="0" 
  default="0" 
  hive="HKEY_LOCAL_MACHINE" 
  key="${eU.gr[e]}"
  name="silent_deploy" 
  type="REG_DWORD"
  value="00000001"
  />
</Registry>`),name:`${eN(e)}-silent_deploy`}),ej=e=>({file:eP(`
<Registry 
  clsid="{9CD4B2F4-923D-47f5-A062-E897DD1DAD50}"  
  name="${eN(e)} - Username" 
  status="Username" 
  image="6" 
  changed="${ex(new Date)}" 
  uid="{${(0,eD.Z)().toUpperCase()}}">
  
  <Properties 
  action="R" 
  displayDecimal="0" 
  default="0" 
  hive="HKEY_LOCAL_MACHINE" 
  key="${eU.gr[e]}" 
  name="Username" 
  type="REG_SZ" 
  value="%LogonUser%"/>
</Registry>`),name:`${eN(e)} - Username`});class eG{constructor(e,t){this.downloadService=e,this.carbonLegacyClient=t,this.downloadGPOFiles=async(e,t)=>{(await this.generateGPOFiles(e,t)).forEach(async e=>{await this.downloadService.downloadFile(e.name,"text/xml",e.file)})},this.generateGPOFiles=async(e,t)=>{let i=await this.getMassDeploymentTeamKey();return i?e.flatMap(e=>t.map(t=>{switch(t){case"mass_deployed_team_key":return eL(i,e);case"silent_deploy":return ek(e);case"username":return ej(e)}})):[]},this.getMassDeploymentTeamKey=async()=>await (0,M.z)(this.carbonLegacyClient.queries.liveMassDeploymentTeamKey(void 0).pipe((0,eO.U)(e=>{if((0,z.d6)(e)){let{massDeploymentTeamAccessKey:t,massDeploymentTeamSecretKey:i}=(0,z.db)(e);if(t&&i)return`${t}-${i}`}})))}}eG=(0,r.gn)([(0,K.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===eF._?Object:eF._,void 0===eT._?Object:eT._])],eG);var eV=i(37368),eM=i(11747);class eK{async execute({body:{timescale:e}}){return this.riskDetectionInsightsService.refreshRiskDetectionInsights(e),(0,z.Vp)(void 0)}constructor(e){this.riskDetectionInsightsService=e}}eK=(0,r.gn)([(0,eV.W)(eM.N),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===e_?Object:e_])],eK);class eW{async execute(){let e=await this.massDeploymentTeamKeyService.generateMassDeploymentTeamKey();if((0,z.hx)(e))return e;let{massDeploymentTeamAccessKey:t,massDeploymentTeamSecretKey:i}=(0,z.db)(e);return await this.carbonLegacyClient.commands.persistMassDeploymentTeamKey({massDeploymentTeamAccessKey:t,massDeploymentTeamSecretKey:i}),(0,z.Vp)(void 0)}constructor(e,t){this.massDeploymentTeamKeyService=e,this.carbonLegacyClient=t}}eW=(0,r.gn)([(0,eV.W)(ee.tv),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===et?Object:et,void 0===eT._?Object:eT._])],eW);var ez=i(83802);class eq{async execute({body:e}){let t=await this.loggedOutMonitoringLogsService.createLog(e);return t&&this.loggedOutMonitoringLogsService.sendLogs([t]),(0,z.Vp)(void 0)}constructor(e){this.loggedOutMonitoringLogsService=e}}eq=(0,r.gn)([(0,eV.W)(ez.r),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===$?Object:$])],eq);var eB=i(16097);class eY{async execute({body:{active:e}}){return this.massDeploymentSecurityMonitoringConfigurationService.updateCredentialRiskDetectionActiveStatus(e)}constructor(e){this.massDeploymentSecurityMonitoringConfigurationService=e}}eY=(0,r.gn)([(0,eV.W)(eB.j),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===er?Object:er])],eY);var eQ=i(13941),eH=i(38129);let e$=`$username = $null
# Wait for username to be populated
while ($username -eq $null) {
    $username = (Get-CimInstance Win32_Process -Filter 'name = "explorer.exe"' | Invoke-CimMethod -MethodName getowner).User
    if ($username -is [array]) {
        $username = $username[0]
    }
    $username = $username -replace ' ', '.'
    Start-Sleep -Seconds 5 # Sleep for 5 seconds (optional)
}
`,eX=(e,t,i)=>{let s=t.reduce((e,t)=>(e[t]=`${eU.NB[t]};${eU.m2[t]}`,e),{});if("windows"===i){if(0===t.length)return;let i=`${e$}
$massDeploymentTeamKey = "${e}"
`;for(let e of t){if(!(0,eH.US)(e))return;i+=`# Set the registry path for ${e}
$registry_path_${e} = "${eU.Y[e]}"
$parent_path_${e} = Split-Path -Path $registry_path_${e}

if (!(Test-Path $parent_path_${e})) {
    New-Item -Path $parent_path_${e} -Force -ItemType Directory | Out-Null
}

if (!(Test-Path $parent_path_${e}\\policy)) {
    New-Item -Path ("$parent_path_${e}\\policy") -Force -ItemType Directory | Out-Null
}

# Set the MassDeployedTeamKey and Username in the registry for ${e}

Set-ItemProperty -Path $registry_path_${e} -Name "MassDeployedTeamKey" -Value $massDeploymentTeamKey
Set-ItemProperty -Path $registry_path_${e} -Name "Username" -Value $username
Set-ItemProperty -Path $registry_path_${e} -Name "silent_deploy" -Value 1
`}return{massDeploymentPoliciesScript:i+="\nexit 0",massDeploymentExtensionIDsAndUpdateURLs:s}}},eZ=(e,t,i)=>{if("macos"!==i)return;let s=t.reduce((e,t)=>(e[t]=eU.Xd[t],e),{}),r=t.reduce((e,t)=>(e[t]=eU.Zf[t],e),{});return{extensionPreferenceDomains:s,extensionPoliciesValue:`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>Username</key>
      <string>$USERNAME</string>
    <key>MassDeployedTeamKey</key>
      <string>${e}</string>
    <key>silent_deploy</key>
      <true/>
  </dict>
</plist>
    `,browsersPreferenceDomains:r,browsersForceInstallValues:t.reduce((e,t)=>(e[t]=`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>ExtensionSettings</key>
    <dict>
      <key>${eU.NB[t]}</key>
      <dict>
        <key>installation_mode</key>
          <string>force_installed</string>
        <key>update_url</key>
          <string>${eU.m2[t]}</string>
      </dict>
    </dict>
  </dict>
</plist>`,e),{})}},eJ=e=>{let t={};return e.forEach(e=>{let i=e.charAt(0).toUpperCase()+e.slice(1),s=eU.Bl.map(e=>({type:e.type,name:`${i}-${e.name}.xml`}));s.length>0&&(t[e]=s)}),t};class e0{areMassDeploymentTeamKeysUndefined(e){let{massDeploymentTeamAccessKey:t,massDeploymentTeamSecretKey:i}=(0,z.db)(e);return!t||!i}async execute({body:e}){let t=await (0,M.z)(this.carbonLegacyClient.queries.getMassDeploymentTeamKey());if(!(0,z.d6)(t)||this.areMassDeploymentTeamKeysUndefined(t))throw Error("Trying to generate a MassDeployment script without a MassDeploymentTeamKey",{cause:"MassDeploymentTeamKey is not available from the CarbonLegacyClient. Either the key for this team was never generated or it was not persisted correctly in the team admin data."});let{massDeploymentTeamAccessKey:i,massDeploymentTeamSecretKey:s}=(0,z.db)(t),r=`${i}-${s}`,{targetedMassDeploymentSoftware:n,targetedBrowsers:a}=e;if("microsoft-intune"!==n)throw Error("Trying to generate a MassDeployment script for an unsupported mass-deployment software",{cause:"The configuration provided by the admin is not supported for Mass Deployment. This is likely a bug in the UI that should have prevented this configuration from being selected."});let o=eX(r,a,"windows");if(!o)throw Error("Something went wrong while generating the Mass Deployment script for Intune",{cause:"The targeted browsers might not be correct. This is likely a bug in the UI that should have prevented this configuration from being selected."});let c=new TextEncoder().encode(o.massDeploymentPoliciesScript).buffer;return this.fileDownloaderService.downloadFile("Dashlane-Risk-Detection-Policies-Script.ps1","text/plain",c),(0,z.Vp)(void 0)}constructor(e,t){this.carbonLegacyClient=e,this.fileDownloaderService=t}}e0=(0,r.gn)([(0,eV.W)(eQ.U),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===eT._?Object:eT._,void 0===eF._?Object:eF._])],e0);var e6=i(25257);class e1{async execute({body:{targetedBrowsers:e,files:t}}){return await this.downloadWindowsGroupPolicyFilesService.downloadGPOFiles(e,t),(0,z.Vp)(void 0)}constructor(e){this.downloadWindowsGroupPolicyFilesService=e}}e1=(0,r.gn)([(0,eV.W)(e6.Q),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===eG?Object:eG])],e1);var e2=i(1833),e4=i(62506),e5=i(79160),e9=i(51860);let e3=e=>(0,e9.evaluate)(e).score/25<3;class e7{execute({body:{password:e}}){let t=e3(e);return(0,e2.D)(this.checkPasswordCompromisedService.check(e)).pipe((0,eO.U)(e=>(0,z.Vp)({isWeak:t,isCompromised:e})))}constructor(e){this.checkPasswordCompromisedService=e}}e7=(0,r.gn)([(0,e4.e)(e5.S),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===q?Object:q])],e7);var e8=i(81433),te=i(45991),tt=i(45942);class ti{execute(){return this.riskDetectionInsightsStore.state$.pipe((0,eO.U)(e=>e.lastLogDateTime?{lastLogDate:e.lastLogDateTime}:{lastLogDate:null}),(0,e8.x)(te.shallowEqualObjects),(0,eO.U)(z.Vp))}constructor(e){this.riskDetectionInsightsStore=e}}ti=(0,r.gn)([(0,e4.e)(tt.k),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[N])],ti);var ts=i(81102),tr=i(51214);class tn{execute(){return this.massDeploymentSecurityMonitoringConfigurationStore.state$.pipe((0,eO.U)(e=>(e.teamId||this.massDeploymentSecurityMonitoringConfigurationService.refreshState(),e)),(0,ts.n)(e=>!e.teamId),(0,eO.U)(z.Vp))}constructor(e,t){this.massDeploymentSecurityMonitoringConfigurationService=e,this.massDeploymentSecurityMonitoringConfigurationStore=t}}tn=(0,r.gn)([(0,e4.e)(tr.g),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===er?Object:er,j])],tn);var ta=i(74266);class to{execute({body:e}){let t=this.carbonLegacyClient.queries.liveMassDeploymentTeamKey(void 0).pipe((0,eO.U)(e=>{if((0,z.d6)(e)){let{massDeploymentTeamAccessKey:t,massDeploymentTeamSecretKey:i}=(0,z.db)(e);if(t&&i)return`${t}-${i}`}}),(0,e8.x)());return e?t.pipe((0,eO.U)(t=>t?(0,z.Vp)({massDeploymentTeamKey:t,massDeploymentSetupInformation:function(e,t,i,s){switch(t){case"microsoft-intune":return eX(e,s,i);case"jamf":return eZ(e,s,i);case"windows-group-policy":return eJ(s);default:return}}(t,e.targetedMassDeploymentSoftware,e.targetedOS,e.targetedBrowsers)}):(0,z.Vp)({massDeploymentTeamKey:void 0,massDeploymentSetupInformation:void 0}))):t.pipe((0,eO.U)(e=>(0,z.Vp)({massDeploymentTeamKey:e,massDeploymentSetupInformation:void 0})))}constructor(e){this.carbonLegacyClient=e}}to=(0,r.gn)([(0,e4.e)(ta.a),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===eT._?Object:eT._])],to);var tc=i(20661),td=i(57478);class tl{execute({body:{timeScale:e="week"}}){return this.riskDetectionInsightsStore.state$.pipe((0,ts.n)(e=>"LOADING"===e.status),(0,eO.U)(t=>({status:t.status,error:t.error,insights:t[e].insights,riskDetectionHistory:t[e].history,hasLogsInLastYear:t.hasLogsInLastYear,lastUpdateTimestamp:t[e].lastUpdateTimestamp,topAtRiskEmployees:t[e].topAtRiskEmployees})),(0,e8.x)((e,t)=>(0,tc.Z)(e,t)),(0,eO.U)(e=>"FAILURE"===e.status&&e.error?(0,z.Rn)(eR(e.error)):(0,z.Vp)(e)))}constructor(e){this.riskDetectionInsightsStore=e}}tl=(0,r.gn)([(0,e4.e)(td.p),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[N])],tl);var tu=i(72907),tp=i(69853),th=i(91978),tg=i(25511);class tm{execute(){return(0,e2.D)(this.hasMassDeployedTeamKey()).pipe((0,tu.w)(e=>e?this.getConfiguration():(0,tp.of)((0,z.Vp)({isEnabled:!1}))))}async hasMassDeployedTeamKey(){try{return this.managedStorageInfrastructure.get("MassDeployedTeamKey").then(e=>!!(e&&e.length>0))}catch(e){return Promise.resolve(!1)}}getConfiguration(){return(0,e2.D)(this.configurationForExtensionService.refreshStateIfOutdated()).pipe((0,ts.n)(e=>(0,z.d6)(e)&&0===e.data.lastUpdateTimestamp),(0,eO.U)(e=>(0,z.d6)(e)?(0,z.Vp)({isEnabled:!!e.data.active}):(0,z.Vp)({isEnabled:!1})))}constructor(e,t){this.configurationForExtensionService=e,this.managedStorageInfrastructure=t}}tm=(0,r.gn)([(0,e4.e)(tg.T),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===H?Object:H,void 0===th.Rx?Object:th.Rx])],tm);class tv{}tv=(0,r.gn)([(0,n.Y)({api:u.Q,imports:[G.Z,o.D,a.l,h.f,c.n,d.i,l.G],providers:[V.c,q,$,et,ei,er,H,g.T,e_,eG],stores:[k,j,L,N],handlers:{commands:{computeRiskDetectionInsights:eK,generateMassDeploymentTeamKey:eW,sendRiskyPasswordLoggedOutLog:eq,updateCredentialRiskDetectionActiveStatus:eY,generateAndDownloadMassDeploymentScript:e0,downloadWindowsGroupPolicyFiles:e1},events:{},queries:{analysePasswordForRisks:e7,getLastLogDate:ti,getMassDeploymentSecurityMonitoringConfiguration:tn,getMassDeploymentSetupInformation:to,getRiskDetectionInsights:tl,isCredentialRiskDetectionEnabledForDevice:tm}},requiredFeatureFlips:Object.values(p.v)})],tv)},12552:function(e,t,i){i.d(t,{g:()=>U});var s=i(21636),r=i(48035),n=i(22104),a=i(50018),o=i(59578),c=i(59842),d=i(15021),l=i(59982),u=i(68238);let p={token:null,instanceURL:null,active:!1,siemType:null,isSelfSignedCertificateAllowed:!1};class h extends(0,l.Q)({initialValue:!1,persist:!1,scope:d.F.User,storeName:"siem-config",capacity:u.Y._001KB}){}var g=i(94190),m=i(306),v=i(94680),y=i(59355),w=i(56859),S=i(93447),f=i(63762);let E=f.z.object({token:f.z.string().nullable(),instanceURL:f.z.string().nullable(),active:f.z.boolean(),siemType:f.z.enum(["splunk"]).nullable(),isSelfSignedCertificateAllowed:f.z.boolean()});var I=i(44577);class b{async getSiemConfiguration(){try{let{teamUuid:e,adminProvisioningKey:t}=await this.getTeamInfo(),i=await this.enclaveApiClient.siem.getSiemConfiguration({teamUuid:e,adminProvisioningKey:t});if((0,m.hx)(i))return Promise.reject((0,w.Nv)());return E.parse((0,m.db)(i))}catch(e){return Promise.reject((0,w.Nv)())}}async setSiemConfiguration(e){try{let{teamUuid:t,adminProvisioningKey:i}=await this.getTeamInfo(),s=await this.enclaveApiClient.siem.setSiemConfiguration({teamUuid:t,adminProvisioningKey:i,token:e.token??void 0,active:e.active,instanceURL:e.instanceURL??void 0,siemType:e.siemType,isSelfSignedCertificateAllowed:e.isSelfSignedCertificateAllowed??void 0});if((0,m.hx)(s))return Promise.reject((0,w.Nv)());return E.parse((0,m.db)(s))}catch(e){switch(e.message){case S.M7.INVALID_URL:return Promise.reject((0,S.q0)());case S.M7.MISMATCHING_ADMIN_PROVISIONING_KEY:return Promise.reject((0,S.HC)());case S.M7.NO_SIEM_CONFIGURATION_UPDATE:return Promise.reject((0,S.$3)());case S.M7.TEAM_NOT_FOUND:return Promise.reject((0,S.gY)());default:return Promise.reject((0,S.SC)())}}}async getTeamInfo(){let e=await (0,I.z)(this.teamEnclaveClient.queries.getTeamIdentifiers());if((0,m.hx)(e))throw Error("TeamInfoNotFound");let{teamUuid:t,adminProvisioningKey:i}=(0,m.db)(e);if(!i)throw Error("TeamInfoNotFound");return{teamUuid:t,adminProvisioningKey:i}}constructor(e,t){this.enclaveApiClient=e,this.teamEnclaveClient=t}}b=(0,s.gn)([(0,g.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===v.l?Object:v.l,void 0===y.G?Object:y.G])],b);var A=i(62506),C=i(72907);class R{execute(){return this.siemStore.state$.pipe((0,C.w)(async e=>{if(!e)try{let e=await this.siemService.getSiemConfiguration();return await this.siemStore.set(e),(0,m.Vp)(e)}catch(e){return(0,m.Vp)(p)}return(0,m.Vp)(e)}))}constructor(e,t){this.siemStore=e,this.siemService=t}}R=(0,s.gn)([(0,A.e)(w.pr),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[h,void 0===b?Object:b])],R);var _=i(37368);class O{async execute({body:e}){let{token:t,instanceURL:i,active:s,isSelfSignedCertificateAllowed:r}=e;try{let e=await this.siemService.setSiemConfiguration({active:s,instanceURL:i,token:t,siemType:"splunk",isSelfSignedCertificateAllowed:r});return this.siemConfigStore.set(e),(0,m.Vp)(void 0)}catch(e){return(0,m.Rn)(e)}}constructor(e,t){this.siemConfigStore=e,this.siemService=t}}O=(0,s.gn)([(0,_.W)(S.Qj),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[h,void 0===b?Object:b])],O);var T=i(51870),F=i(18310);class D{async handle(){await this.siemConfigStore.clear()}constructor(e){this.siemConfigStore=e}}D=(0,s.gn)([(0,T.b)(F.z),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[h])],D);class U{}U=(0,s.gn)([(0,r.Y)({api:a.v,stores:[h],providers:[b],imports:[o.Z,n.G],handlers:{commands:{setSiemConfiguration:O},events:{...(0,r.g)(c.y,{confidentialSsoSettingsReset:D})},queries:{getSiemConfiguration:R}},requiredFeatureFlips:["setup_rollout_splunk_integration_prod","setup_rollout_siem_self_signed_certificate"]})],U)},98222:function(e,t,i){i.d(t,{v:()=>a});var s=i(36503),r=i(38293),n=i(53836);let a=(0,s.Q)({name:"changeMasterPassword",commands:{temporarySendMasterPasswordChangedEvent:r.n},events:{masterPasswordChanged:n.D},queries:{}})},38293:function(e,t,i){i.d(t,{n:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},53836:function(e,t,i){i.d(t,{D:()=>n});var s=i(98037),r=i(15021);class n extends(0,s.d)({scope:r.F.User}){}},70990:function(e,t,i){i.r(t),i.d(t,{ChangeSessionKeyErrorTypes:()=>l.eq,CheckSessionKeyErrorTypes:()=>I.f3,CheckSessionKeyQuery:()=>h.Z,CheckSessionSessionNotCreated:()=>I.OT,CloseUserSessionCommand:()=>a.V,CopyUserDataAndOpenSessionCommand:()=>u.k,CopyUserDataAndOpenSessionErrorCode:()=>u.G,CreateUserSessionCommand:()=>o.lk,CurrentSessionInfoQuery:()=>m.EP,DeleteLocalSessionCommand:()=>d.G,DeviceLimitQuery:()=>F.X,ExportSessionKeyQuery:()=>g.w,FlushLocalDataCommand:()=>r.e,IsAllowedQuery:()=>T.bY,LocalSessionsQuery:()=>v.a,MasterPasswordChangedEvent:()=>C.D,MultiAccountNotYetSupported:()=>c.y9,NO_USER_LOGGED_IN:()=>m.i6,NoUserLoggedInError:()=>m.Ou,NotAllowedReason:()=>T.Oq,OpenUserSessionCommand:()=>c.Dx,PlatformView:()=>F.i,PrepareLocalDataFlushCommand:()=>n.X,SESSION_FEATURE_FLIPS:()=>b.e,SelectedOpenedSessionQuery:()=>p._,SessionAlreadyExists:()=>o.X0,SessionAlreadyOpened:()=>c.mR,SessionClient:()=>E.x,SessionCloseMode:()=>y.K,SessionClosedEvent:()=>y.X,SessionClosingEvent:()=>w.Z,SessionCreationErrorTypes:()=>o.v5,SessionKeyChecker:()=>I.BD,SessionNotCreated:()=>c.aK,SessionOpenErrorTypes:()=>c.T8,SessionOpenedEvent:()=>S.M,SessionOpeningEvent:()=>f.$,SessionStates:()=>v.U,TemporarySendMasterPasswordChangedEventCommand:()=>R.n,UnableToUpdateSessionKeyForNonExistingAccount:()=>l.pX,UnableToUpdateSessionSessionNotOpened:()=>l.nA,UpdateUserSessionKeyCommand:()=>l.yt,UserNotLogged:()=>T.Fh,VaultAccessClient:()=>O.N,changeMasterPasswordApi:()=>A.v,sessionApi:()=>s.Q,vaultAccessApi:()=>_.Y});var s=i(73827),r=i(19901),n=i(82529),a=i(78526),o=i(67894),c=i(44972),d=i(97098),l=i(58453),u=i(37379),p=i(74304),h=i(5270),g=i(61228),m=i(56791),v=i(20993),y=i(42258),w=i(30120),S=i(88826),f=i(39332),E=i(19855),I=i(45579),b=i(94264),A=i(98222),C=i(53836),R=i(38293),_=i(3068),O=i(73142),T=i(99178),F=i(44849)},73827:function(e,t,i){i.d(t,{Q:()=>E});var s=i(36503),r=i(39332),n=i(74304),a=i(58453),o=i(56791),c=i(19901),d=i(82529),l=i(67894),u=i(44972),p=i(78526),h=i(97098),g=i(37379),m=i(5270),v=i(61228),y=i(20993),w=i(88826),S=i(30120),f=i(42258);let E=(0,s.Q)({name:"session",commands:{flushLocalData:c.e,prepareLocalDataFlush:d.X,createUserSession:l.lk,openUserSession:u.Dx,closeUserSession:p.V,deleteLocalSession:h.G,copyUserDataAndOpenSession:g.k,updateUserSessionKey:a.yt},queries:{selectedOpenedSession:n._,checkSessionKey:m.Z,exportSessionKey:v.w,currentSessionInfo:o.EP,localSessions:y.a},events:{sessionOpened:w.M,sessionClosing:S.Z,sessionClosed:f.X,sessionOpening:r.$}})},78526:function(e,t,i){i.d(t,{V:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},37379:function(e,t,i){i.d(t,{G:()=>o,k:()=>c});var s,r=i(63762),n=i(66122),a=i(15021),o=((s={}).FAILED_TO_TRANSITION_MACHINE_FOR_OTP2_USER="FAILED_TO_TRANSITION_MACHINE_FOR_OTP2_USER",s.FAILED_TO_OPEN_SESSION="FAILED_TO_OPEN_SESSION",s);r.z.object({tag:r.z.nativeEnum(o)});class c extends(0,n.g)({scope:a.F.Device}){}},67894:function(e,t,i){i.d(t,{X0:()=>c,lk:()=>d,v5:()=>o});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).AlreadyExists="alreadyExists",s);class c extends(0,a.Hu)("alreadyExists","The session already exists. Delete it first."){}class d extends(0,r.g)({scope:n.F.Device}){}},97098:function(e,t,i){i.d(t,{G:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.Device}){}},19901:function(e,t,i){i.d(t,{e:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},44972:function(e,t,i){i.d(t,{Dx:()=>u,T8:()=>o,aK:()=>c,mR:()=>d,y9:()=>l});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).NotCreated="notCreated",s.AlreadyOpened="alreadyOpened",s.MultiAccountNotYetSupported="multiAccountNotYetSupported",s);class c extends(0,a.Hu)("notCreated","The session has not been created. Create it first."){}class d extends(0,a.Hu)("alreadyOpened","The session is already opened for this user. Close it first."){}class l extends(0,a.Hu)("multiAccountNotYetSupported","Another session is opened. Close it first."){}class u extends(0,r.g)({scope:n.F.Device}){}},82529:function(e,t,i){i.d(t,{X:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},58453:function(e,t,i){i.d(t,{eq:()=>o,nA:()=>d,pX:()=>c,yt:()=>l});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).NotCreated="notCreated",s.NotOpened="notOpened",s);class c extends(0,a.Hu)("notCreated","The session has not been created. Create it first."){}class d extends(0,a.Hu)("notOpened","The session has not been opened"){}class l extends(0,r.g)({scope:n.F.Device}){}},42258:function(e,t,i){i.d(t,{K:()=>a,X:()=>o});var s,r=i(98037),n=i(15021),a=((s={}).Close="close",s.Lock="lock",s);class o extends(0,r.d)({scope:n.F.Device}){}},30120:function(e,t,i){i.d(t,{Z:()=>n});var s=i(98037),r=i(15021);class n extends(0,s.d)({scope:r.F.User}){}},88826:function(e,t,i){i.d(t,{M:()=>n});var s=i(98037),r=i(15021);class n extends(0,s.d)({scope:r.F.User}){}},39332:function(e,t,i){i.d(t,{$:()=>n});var s=i(98037),r=i(15021);class n extends(0,s.d)({scope:r.F.User}){}},94264:function(e,t,i){i.d(t,{e:()=>s});let s={BrazeWithDesignSystemDev:"ecommerce_web_braze_with_design_system_dev"}},5270:function(e,t,i){i.d(t,{Z:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device}){}},20993:function(e,t,i){i.d(t,{U:()=>n,a:()=>a});var s=i(45429),r=i(15021);let n=Object.freeze({Open:"open",Closed:"closed",Opening:"opening"});class a extends(0,s.k)({scope:r.F.Device}){}},61228:function(e,t,i){i.d(t,{w:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},74304:function(e,t,i){i.d(t,{_:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.Device,useCache:!0}){}},56791:function(e,t,i){i.d(t,{EP:()=>c,Ou:()=>o,i6:()=>a});var s=i(45429),r=i(15021),n=i(96272);let a="no-user-logged-in",o=(0,n.Vj)(a,"User is not logged in")();class c extends(0,s.k)({scope:r.F.User,noUserError:o}){}},45579:function(e,t,i){i.d(t,{BD:()=>o,OT:()=>a,f3:()=>n});var s,r=i(96272),n=((s={}).SessionNotCreated="notCreated",s);class a extends(0,r.Hu)("notCreated","The session has not been created. Create it first."){}class o{}},19855:function(e,t,i){i.d(t,{x:()=>n});var s=i(46266),r=i(73827);class n extends(0,s.E)(r.Q){}(0,s.K)(r.Q,n)},3068:function(e,t,i){i.d(t,{Y:()=>a});var s=i(36503),r=i(99178),n=i(44849);let a=(0,s.Q)({name:"vaultAccess",commands:{},events:{},queries:{isAllowed:r.bY,deviceLimit:n.X}})},73142:function(e,t,i){i.d(t,{N:()=>n});var s=i(46266),r=i(3068);class n extends(0,s.E)(r.Y){}(0,s.K)(r.Y,n)},44849:function(e,t,i){i.d(t,{X:()=>o,i:()=>a});var s,r=i(45429),n=i(15021),a=((s={}).Android="android",s.DesktopMacOS="macosx",s.DesktopWindows="windows",s.IPad="ipad",s.IPhone="iphone",s.IPod="ipod",s.Other="other",s.StandaloneExtension="saex",s.TeamAdminConsole="tac",s.WebApp="webapp",s);class o extends(0,r.k)({scope:n.F.User}){}},99178:function(e,t,i){i.d(t,{Fh:()=>c,Oq:()=>o,bY:()=>d});var s,r=i(45429),n=i(15021),a=i(96272),o=((s={}).DeviceLimited="DeviceLimited",s.Requires2FAEnforcement="Requires2FAEnforcement",s.RequiresSSO2MPMigration="RequiresSSO2MPMigration",s.RequiresMP2SSOMigration="RequiresMP2SSOMigration",s.RequiresSettingUpRecoveryKey="RequiresSettingUpRecoveryKey",s.RequiresSettingUpPin="RequiresSettingUpPin",s.RequiresChangeLoginEmail="RequiresChangeLoginEmail",s.NoActiveUser="NoActiveUser",s);class c extends(0,a.Hu)("UserNotLogged","Please log the user"){}class d extends(0,r.k)({scope:n.F.Device}){}},16055:function(e,t,i){i.d(t,{M:()=>h});var s=i(21636),r=i(48035),n=i(98222),a=i(38293),o=i(37368),c=i(306),d=i(17507),l=i(94190);class u extends d.f{}u=(0,s.gn)([(0,l.GS)()],u);class p{execute(){return this.eventEmitter.sendEvent("masterPasswordChanged",void 0),Promise.resolve((0,c.Vp)(void 0))}constructor(e){this.eventEmitter=e}}p=(0,s.gn)([(0,o.W)(a.n),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===u?Object:u])],p);class h{}h=(0,s.gn)([(0,r.Y)({api:n.v,handlers:{commands:{temporarySendMasterPasswordChangedEvent:p},events:{},queries:{}},providers:[u]})],h)},59493:function(e,t,i){i.d(t,{P:()=>r});var s=i(14006);let r=e=>{let[,,t]=e.split("$");return"pbkdf2"===t?s.E1:s.mr}},2587:function(e,t,i){i.d(t,{h:()=>n});var s=i(62917),r=i(32862);class n extends r.b{async isUserIdle(e){return"idle"===await (0,s.q)(e)}}},32862:function(e,t,i){i.d(t,{b:()=>n});var s=i(21636),r=i(94190);class n{}n=(0,s.gn)([(0,r.GS)()],n)},58734:function(e,t,i){i.d(t,{t:()=>u});var s=i(21636),r=i(44577),n=i(49247),a=i(94190),o=i(87169),c=i(53777),d=i(17741),l=i(16620);class u{async decrypt(e){let{carbonStateList:t}=this.carbonLegacyClient.queries;return await (0,r.z)(t({paths:["userSession.session.localKey","userSession.session.masterPassword","userSession.session.serverKey"]}).pipe((0,d.nb)({success:([t,i,s])=>{if("string"==typeof t)return this.flexibleDecryptor.decrypt((0,o.u)(t),e);if("string"==typeof i&&"string"==typeof s){let t=(0,c.N)(s+i);return this.flexibleDecryptor.decrypt((0,o.u)(t),e)}throw Error("Wrong types for local data key")},failure:()=>{throw Error("Failure getting state list")}})))}constructor(e,t){this.carbonLegacyClient=e,this.flexibleDecryptor=t}}u=(0,s.gn)([(0,a.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===n._?Object:n._,void 0===l.a?Object:l.a])],u)},57048:function(e,t,i){i.d(t,{Y:()=>o});var s=i(21636),r=i(94190),n=i(58734),a=i(12445);class o{encode(e){return this.localDatKeyaEncryptor.encrypt(e)}decode(e){return this.localDataKeyDecryptor.decrypt(e)}constructor(e,t){this.localDataKeyDecryptor=e,this.localDatKeyaEncryptor=t}}o=(0,s.gn)([(0,r.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===n.t?Object:n.t,void 0===a.n?Object:a.n])],o)},12445:function(e,t,i){i.d(t,{n:()=>v});var s=i(21636),r=i(44577),n=i(94190),a=i(49247),o=i(17741),c=i(14006),d=i(49),l=i(87169),u=i(53777),p=i(97702),h=i(17721),g=i(94588),m=i(59493);class v{async encrypt(e){let{carbonStateList:t}=this.carbonLegacyClient.queries;return await (0,r.z)(t({paths:["userSession.session.localKey","userSession.session.masterPassword","userSession.session.serverKey","userSession.personalSettings.CryptoFixedSalt","userSession.personalSettings.CryptoUserPayload"]}).pipe((0,o.nb)({success:([t,i,s,r,n])=>{if("string"==typeof t)return this.flexibleEncryptor.encrypt((0,l.u)(t),e,c.oo,d.gO);if("string"==typeof i&&"string"==typeof s){let t=(0,u.N)(s+i),a="string"==typeof n?(0,m.P)(n):c.mr,{saltLength:o}=a,h="string"===r?(0,p.R)(r):this.randomValuesGetter.get(o);return this.flexibleEncryptor.encrypt((0,l.u)(t),e,a,d.Nw,{salt:h})}throw Error("Wrong types for local data key")},failure:()=>{throw Error("Failure getting state list")}})))}constructor(e,t,i){this.carbonLegacyClient=e,this.flexibleEncryptor=t,this.randomValuesGetter=i}}v=(0,s.gn)([(0,n.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===a._?Object:a._,void 0===h._?Object:h._,void 0===g.Y?Object:g.Y])],v)},55507:function(e,t,i){i.d(t,{_:()=>e$});var s=i(21636),r=i(48035),n=i(90573),a=i(15021),o=i(73827),c=i(45579),d=i(94264),l=i(87253),u=i(6223),p=i(58734),h=i(12445),g=i(57048),m=i(94190),v=i(306),y=i(42589),w=i(59982),S=i(68238),f=i(20458);let E=e=>!!e&&"object"==typeof e&&(0===Object.keys(e).length||Object.entries(e).every(([,e])=>"object"==typeof e&&"derivation"in e&&"salt"in e));class I extends(0,w.Q)({storeName:"sessions-crypto-settings-store",scope:a.F.Device,capacity:S.Y._010KB,persist:!0,storage:{schemaVersion:1,initialValue:{},typeGuard:E},codec:f.E}){}class b{getConfig(e){return this.sessionsCryptoSettingsStore.state$.pipe((0,y.U)(t=>{if(e in t){let{derivation:i,salt:s}=t[e];return(0,v.Vp)({derivation:i,salt:s})}throw Error("No crypto settings found for this user")}))}constructor(e){this.sessionsCryptoSettingsStore=e}}b=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[I])],b);var A=i(37368),C=i(57455),R=i(19901);class _{async execute(){return await this.storeFlusher.flush(),Promise.resolve((0,v.Vp)(void 0))}constructor(e){this.storeFlusher=e}}_=(0,s.gn)([(0,A.W)(R.e),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===C.X?Object:C.X])],_);var O=i(82529);class T{async execute(){return await this.storeFlusher.prepare(),Promise.resolve((0,v.Vp)(void 0))}constructor(e){this.storeFlusher=e}}T=(0,s.gn)([(0,A.W)(O.X),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===C.X?Object:C.X])],T);var F=i(49247),D=i(90385),U=i(67894),P=i(31256),x=i(44577),N=i(83267),L=i(97702),k=i(17721),j=i(49),G=i(38612),V=i(87169);class M{encrypt(e,t,i){let s;let{flexibleEncryptor:r}=this,{derivation:n,salt:a}=i,{algorithm:o}=n;if("noderivation"===o)throw Error("Session key requires derivation");switch(t.type){case"sso":s=(0,L.R)(t.ssoKey);break;case"mp":s=(0,G.K)((0,V.u)(t.masterPassword),(0,L.R)(t.secondaryKey??""));break;default:(0,D.U)(t)}return r.encrypt(s,e,n,j.Nw,{salt:(0,L.R)(a)})}constructor(e){this.flexibleEncryptor=e}}M=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===k._?Object:k._])],M);class K{decode(e){let t={};for(let[i,s]of Object.entries(e))t[i]={status:"closed",encryptedLocalKey:s.encryptedLocalKey};return t}async encode(e){let t={};for(let[i,s]of Object.entries(e)){if("closed"===s.status){t[i]={encryptedLocalKey:s.encryptedLocalKey};continue}if("sso"===s.sessionKey.type)continue;if(!s.localKey){t[i]={encryptedLocalKey:null};continue}let e=await (0,x.z)(this.settings.getConfig(i));if(!(0,v.d6)(e))throw Error("Fail to get crypto settings");t[i]={encryptedLocalKey:(0,N.s)(await this.encryptor.encrypt((0,L.R)(s.localKey),s.sessionKey,e.data))}}return t}constructor(e,t){this.encryptor=e,this.settings=t}}K=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===M?Object:M,void 0===b?Object:b])],K);class W extends(0,w.Q)({storeName:"sessions-state-store",scope:a.F.Device,capacity:S.Y._010KB,persist:!0,isCache:!0,codec:K,storage:{initialValue:{},schemaVersion:2,typeGuard:e=>!0,migrateStorageSchema:()=>({})}}){}let z=new P.WU;var q=i(48194);class B{getLocalKey(e){let t=this.generate.bind(this),i=this.changeLocalKey.bind(this);return this.store.state$.pipe((0,q.z)(async s=>{if(e in s){let t=s[e];if("open"!==t.status)throw Error("Session is not open ");let i=t.localKey;return i?(0,L.R)(i):null}let r=await t();return await i(e,r),r}))}async changeLocalKey(e,t){let{store:i}=this,s=await (0,x.z)(this.settings.getConfig(e));if(!(0,v.d6)(s))throw Error("Fail to get crypto settings");await z.runExclusive(async()=>{let s=await i.getState();if(!(e in s))throw Error("Session is not created");let r=s[e];if("open"!==r.status)throw Error("Session is not open");await i.set({...s,[e]:{status:"open",localKey:t?(0,N.s)(t):null,sessionKey:r.sessionKey}})})}async generateKeyIfNotExist(e){await (0,x.z)(this.getLocalKey(e))}async generate(){let{carbonStateList:e}=this.carbon.queries,t=await (0,x.z)(e({paths:["userSession.session.localKey"]}));if((0,v.hx)(t))throw Error("Failure getting state list");let[i]=t.data;return"string"==typeof i?(0,V.u)(i):null}constructor(e,t,i){this.carbon=e,this.store=t,this.settings=i}}B=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F._?Object:F._,W,void 0===b?Object:b])],B);var Y=i(59493),Q=i(16620);class H extends(0,w.Q)({persist:!0,codec:f.E,scope:a.F.Device,storage:{initialValue:{},schemaVersion:0,typeGuard:e=>"object"==typeof e&&null!==e&&(!("encryptionKey"in e)||"string"==typeof e.encryptionKey)},storeName:"exported-session-keys-crypto",capacity:S.Y._001KB}){}var $=i(92291),X=i(76217);class Z{async updateAndSetEncryptionKey(){let e=await this.keyGenerator.generate();return await this.store.set({encryptionKey:(0,N.s)(e)}),e}getOrCreateEncryptionKey(){return this.store.state$.pipe((0,$.b)(async e=>e.encryptionKey?(0,L.R)(e.encryptionKey):await this.updateAndSetEncryptionKey()))}constructor(e,t){this.store=e,this.keyGenerator=t}}Z=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[H,void 0===X.c?Object:X.c])],Z);class J{async import(e){let t=await (0,x.z)(this.cryptoManager.getOrCreateEncryptionKey()),i=await this.flexibleDecryptor.decrypt(t,(0,L.R)(e.content));return Promise.resolve(JSON.parse(new TextDecoder().decode(i)))}constructor(e,t){this.cryptoManager=e,this.flexibleDecryptor=t}}J=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===Z?Object:Z,void 0===Q.a?Object:Q.a])],J);class ee{async execute({body:{sessionKey:e,email:t,personalSettings:i}}){let s="exported"===e.type?await this.importer.import(e):e,r=await this.localKeyRepository.generate(),n=r?await this.encryptor.encrypt(r,s,{derivation:(0,Y.P)(i.CryptoUserPayload),salt:i.CryptoFixedSalt}):null;return z.runExclusive(async()=>{let e=await this.store.getState();if(t in e)return(0,v.Rn)(new U.X0);switch(s.type){case"mp":{await this.store.set({...e,[t]:{status:"closed",encryptedLocalKey:n?(0,N.s)(n):null}});let i=await this.carbon.commands.openSessionWithMasterPassword({login:t,password:s.masterPassword,rememberPassword:!1,requiredPermissions:void 0,serverKey:s.secondaryKey,loginType:"MasterPassword"});if((0,v.hx)(i))throw Error("Failed to create the session in carbon");return(0,v.Vp)(void 0)}case"sso":throw Error("Creating a SSO session in session module is not supported");default:return(0,D.U)(s)}})}constructor(e,t,i,s,r){this.carbon=e,this.store=t,this.localKeyRepository=i,this.encryptor=s,this.importer=r}}ee=(0,s.gn)([(0,A.W)(U.lk),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F._?Object:F._,W,void 0===B?Object:B,void 0===M?Object:M,void 0===J?Object:J])],ee);var et=i(17507);class ei extends et.f{}ei=(0,s.gn)([(0,m.GS)()],ei);var es=i(42258),er=i(78526),en=i(61393);class ea{async execute({body:{email:e}}){return await this.emitter.sendEvent("sessionClosing",void 0),await this.carbonLegacyClient.commands.carbonLegacyLeeloo({name:"closeSession",arg:[{}]}),await this.emitter.sendEvent("sessionClosed",{email:e,mode:es.K.Close}),await this.requestContextClient.commands.setActiveUser({userName:void 0}),Promise.resolve((0,v.Vp)(void 0))}constructor(e,t,i){this.emitter=e,this.requestContextClient=t,this.carbonLegacyClient=i}}ea=(0,s.gn)([(0,A.W)(er.V),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===ei?Object:ei,void 0===en.Q?Object:en.Q,void 0===F._?Object:F._])],ea);var eo=i(44972);class ec{decrypt(e,t){let i;let{flexibleDecryptor:s}=this;switch(t.type){case"sso":i=(0,L.R)(t.ssoKey);break;case"mp":i=(0,G.K)((0,V.u)(t.masterPassword),(0,L.R)(t.secondaryKey??""));break;default:(0,D.U)(t)}return s.decrypt(i,e)}constructor(e){this.flexibleDecryptor=e}}ec=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===Q.a?Object:Q.a])],ec);class ed{async execute({body:{email:e,sessionKey:t,rememberPassword:i}}){let s="exported"===t.type?await this.importer.import(t):t;if("sso"===s.type)throw Error("not implemented");let{sessionStore:r,carbon:n}=this;return await z.runExclusive(async()=>{let t=await r.getState();if(!(e in t))return(0,v.Rn)(new eo.aK);if(Object.values(t).some(e=>"open"===e.status))return(0,v.Rn)(new eo.y9);let a=t[e];if("open"===a.status||"opening"===a.status)return(0,v.Rn)(new eo.mR);await r.set({...t,[e]:{status:"opening",sessionKey:s,localKey:a.encryptedLocalKey?(0,N.s)(await this.sessionKeyDecryptor.decrypt((0,L.R)(a.encryptedLocalKey),s)):null}});let o=!1;try{let t=await n.commands.openSessionWithMasterPassword({login:e,password:s.masterPassword,rememberPassword:i,requiredPermissions:void 0,serverKey:s.secondaryKey,loginType:"MasterPassword"});if(!(0,v.d6)(t))throw Error("Failed to open session in carbon");return o=!0,(0,v.Vp)(void 0)}finally{o||await r.set(t)}})}constructor(e,t,i,s){this.carbon=e,this.sessionStore=t,this.sessionKeyDecryptor=i,this.importer=s}}ed=(0,s.gn)([(0,A.W)(eo.Dx),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F._?Object:F._,W,void 0===ec?Object:ec,void 0===J?Object:J])],ed);var el=i(81433),eu=i(62506),ep=i(20993),eh=i(74304);class eg{execute(){return this.sessionsStateStore.state$.pipe((0,y.U)(e=>{let t;for(let i in e)e[i].status===ep.U.Open&&(t=i);return t}),(0,el.x)(),(0,y.U)(v.Vp))}constructor(e){this.sessionsStateStore=e}}eg=(0,s.gn)([(0,eu.e)(eh._),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[W])],eg);var em=i(97098);class ev{execute(){return Promise.resolve((0,v.Vp)(void 0))}}ev=(0,s.gn)([(0,A.W)(em.G)],ev);var ey=i(53017);class ew{verify(e,t){let i;let{flexibleVerifier:s}=this;switch(t.type){case"sso":i=(0,L.R)(t.ssoKey);break;case"mp":i=(0,G.K)((0,V.u)(t.masterPassword),(0,L.R)(t.secondaryKey??""));break;default:(0,D.U)(t)}return s.verifySignature(i,e)}constructor(e){this.flexibleVerifier=e}}ew=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===ey.y?Object:ey.y])],ew);class eS extends c.BD{async checkSessionKey(e,t){if("mp"!==t.type)return(0,v.Vp)(!0);let i=await (0,x.z)(this.sessionsStateStore.state$);if(!(e in i))return(0,v.Vp)(!0);let s=i[e];if("open"===s.status||"opening"===s.status)return(0,v.Vp)(function(e,t){switch(e.type){case"mp":return"mp"===t.type&&e.masterPassword===t.masterPassword&&e.secondaryKey===t.secondaryKey;case"sso":return"sso"===t.type&&e.ssoKey===t.ssoKey;default:(0,D.U)(e)}}(s.sessionKey,t));if(!s.encryptedLocalKey)return(0,v.Vp)(!0);let r=(0,L.R)(s.encryptedLocalKey);return(0,v.Vp)(await this.verifier.verify(r,t))}constructor(e,t){super(),this.sessionsStateStore=e,this.verifier=t}}eS=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[W,void 0===ew?Object:ew])],eS);var ef=i(5270),eE=i(1833);class eI{execute({body:{email:e,sessionKey:t}}){return(0,eE.D)(this.checker.checkSessionKey(e,t))}constructor(e){this.checker=e}}eI=(0,s.gn)([(0,eu.e)(ef.Z),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===c.BD?Object:c.BD])],eI);var eb=i(30424),eA=i(51870);class eC{async handle({body:{user:e}}){await z.runExclusive(async()=>{let t=await this.store.getState();delete t[e],await this.store.set(t)})}constructor(e){this.store=e}}eC=(0,s.gn)([(0,eA.b)(eb.E1),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[W])],eC);var eR=i(58453);class e_{async execute({body:{email:e,sessionKey:t}}){let i="exported"===t.type?await this.importer.import(t):t;return await z.runExclusive(async()=>{let t=await this.store.getState();if(!(e in t))return(0,v.Rn)(new eR.pX);let s=t[e];return"closed"===s.status?(0,v.Rn)(new eR.nA):(t[e]={status:"open",localKey:s.localKey,sessionKey:i},await this.store.set(t),(0,v.Vp)(void 0))})}constructor(e,t){this.store=e,this.importer=t}}e_=(0,s.gn)([(0,A.W)(eR.yt),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[W,void 0===J?Object:J])],e_);var eO=i(32862);class eT{async run(){await this.carbonLegacyClient.commands.carbonLegacyLeeloo({name:"closeSession",arg:[{}]})}async isRunnable(){let e=await (0,x.z)(this.carbonLegacyClient.queries.getPremiumStatus());if(!(0,v.d6)(e)||!e.data.spaces)return!1;let t=e.data.spaces.find(e=>"accepted"===e.status),i=t?.info.forceAutomaticLogout;return!!i&&await this.conf.isUserIdle(60*i)}constructor(e,t){this.carbonLegacyClient=e,this.conf=t}}eT=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F._?Object:F._,void 0===eO.b?Object:eO.b])],eT);var eF=i(14006);class eD{async export(e){let t=JSON.stringify(e),i=new TextEncoder().encode(t),s=await (0,x.z)(this.cryptoManager.getOrCreateEncryptionKey()),r=await this.flexibleEncryptor.encrypt(s,i,eF.oo,j.gO);return Promise.resolve({type:"exported",content:(0,N.s)(r)})}constructor(e,t){this.cryptoManager=e,this.flexibleEncryptor=t}}eD=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===Z?Object:Z,void 0===k._?Object:k._])],eD);var eU=i(61228);class eP{execute(){return this.store.state$.pipe((0,$.b)(async e=>{let t;for(let i in e)e[i].status===ep.U.Open&&(t=i);if(!t)throw Error("No opened session");let i=e[t];if("open"!==i.status)throw Error("No opened session");return(0,v.Vp)(await this.exporter.export(i.sessionKey))}))}constructor(e,t){this.store=e,this.exporter=t}}eP=(0,s.gn)([(0,eu.e)(eU.w),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[W,void 0===eD?Object:eD])],eP);var ex=i(56791),eN=i(20119);class eL{execute(){return this.repository.getInfos().pipe((0,y.U)(({analytics:e,deviceAccessKey:t,login:i,deviceKeys:s,publicUserId:r})=>(0,v.Vp)({analytics:e,deviceAccessKey:t,login:i,deviceKeys:s,publicUserId:r})))}constructor(e){this.repository=e}}eL=(0,s.gn)([(0,eu.e)(ex.EP),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eN.h?Object:eN.h])],eL);var ek=i(18550),ej=i(36884);class eG{execute(){return(0,ej.a)([this.carbon.queries.carbonStateList({paths:["authentication.localUsers"]}),this.store.state$]).pipe((0,y.U)(([e,t])=>{if(!(0,v.d6)(e))throw Error("failed to get data from carbon");let[i]=e.data,s=Object.entries(t).reduce((e,[t,s])=>({...e,[t]:(0,ek.Ay)({login:t,deviceAccessKey:i[t].deviceAccessKey,state:s.status})}),(0,ek.Ay)({}));return(0,v.Vp)(s)}))}constructor(e,t){this.carbon=e,this.store=t}}eG=(0,s.gn)([(0,eu.e)(ep.a),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F._?Object:F._,W])],eG);var eV=i(98942),eM=i(47038),eK=i(26984),eW=i(64773),ez=i(11396),eq=i(4772),eB=i(37379);class eY{async execute({body:{currentEmail:e,newEmail:t,personalSettings:i}}){let s=await this.store.getState();if(!(e in s)||"open"!==s[e].status)throw Error("Current email is not authenticated");let{localKey:r,sessionKey:n}=s[e];if("sso"===n.type)throw Error("SSO not supported yet");let{analytics:a,deviceKeys:o,cryptoSettings:c}=await (0,x.z)(this.currentSessionInfoRepository.getInfos());await this.deviceRegistration.commands.registerDevice({with:"deviceKeys",deviceAccessKey:o.accessKey,deviceSecretKey:o.secretKey,login:t,settings:i.content,userAnalyticsId:a.userId});let d=await (0,x.z)(this.carbon.queries.getTwoFactorAuthenticationInfo());(0,v.d6)(d)||this.exceptionLogger.captureException(Error("getTwoFactorAuthenticationInfo carbon query has failed"),{useCaseName:"migrateUserSessionForChangeLoginEmail"});let l=(0,v.d6)(d)&&d.data.status===eM.dN.READY&&d.data.type===eM.fr.LOGIN,u=r?await this.encryptor.encrypt((0,V.u)(r),n,{derivation:(0,Y.P)(c.cryptoUserPayload),salt:c.cryptoFixedSalt}):null,p=await this.cryptoSettingsStore.getState();if(await this.cryptoSettingsStore.set({...p,[t]:{derivation:(0,Y.P)(c.cryptoUserPayload),salt:c.cryptoFixedSalt}}),await this.store.set({...s,[e]:{status:"closed",encryptedLocalKey:u?(0,N.s)(u):null},[t]:{status:"closed",encryptedLocalKey:u?(0,N.s)(u):null}}),l)try{await this.carbon.commands.cleanRemotelyRemovedProfiles(),await this.carbon.commands.carbonLegacyLeeloo({name:"openSessionWithOTP",arg:[{login:t,otp:"",password:""}]}),await this.authenticationFlow.commands.changeLogin({login:t})}catch(e){return this.exceptionLogger.captureException(Error(`Change login email flow has failed for OTP2 user with error: ${e}`),{useCaseName:"migrateUserSessionForChangeLoginEmail"}),(0,v.Rn)({tag:eB.G.FAILED_TO_TRANSITION_MACHINE_FOR_OTP2_USER})}else{let e=await this.carbon.commands.openSessionWithMasterPassword({login:t,password:n.masterPassword,rememberPassword:!1,serverKey:n.secondaryKey,loginType:"MasterPassword"});if((0,v.hx)(e))return this.exceptionLogger.captureException(Error("openSessionWithMasterPassword has failed"),{useCaseName:"migrateUserSessionForChangeLoginEmail"}),(0,v.Rn)({tag:eB.G.FAILED_TO_OPEN_SESSION})}return(0,v.Vp)(void 0)}constructor(e,t,i,s,r,n,a,o){this.carbon=e,this.store=t,this.encryptor=i,this.currentSessionInfoRepository=s,this.deviceRegistration=r,this.cryptoSettingsStore=n,this.authenticationFlow=a,this.exceptionLogger=o}}eY=(0,s.gn)([(0,A.W)(eB.k),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F._?Object:F._,W,void 0===M?Object:M,void 0===eN.h?Object:eN.h,void 0===eW.z?Object:eW.z,I,void 0===ez||void 0===eq.e?Object:eq.e,void 0===eK.v?Object:eK.v])],eY);var eQ=i(94588);class eH{async getUserCryptoSettings(){let{getUserCryptoSettings:e}=this.carbon.queries,t=await (0,x.z)(e());if(!(0,v.d6)(t))throw Error("Fail to fetch crypto settings from carbon");let{cryptoUserPayload:i,cryptoFixedSalt:s}=t.data;return{cryptoUserPayload:i,cryptoFixedSalt:s}}async getSessionKey(e){let{getMasterPasswordAndServerKey:t,getIsSSOUser:i}=this.carbon.queries,s=await (0,x.z)(i());if(!(0,v.d6)(s))throw Error("Fail to fetch is sso user from carbon");if(s.data&&!e)return{type:"sso",ssoKey:""};let r=await (0,x.z)(t());if(!(0,v.d6)(r))throw Error("Fail to fetch master password and server key from carbon");let{password:n,serverKey:a}=r.data;return{type:"mp",masterPassword:n,secondaryKey:a}}async handleLogin(e,t){let i=await z.runExclusive(async()=>{let{cryptoUserPayload:i,cryptoFixedSalt:s}=await this.getUserCryptoSettings(),r=i?(0,Y.P)(i):eF.mr,n=s||(0,N.s)(this.randomValuesGetter.get(r.saltLength)),a=await this.sessionsCryptoSettingsStore.getState();this.sessionsCryptoSettingsStore.set({...a,[e]:{derivation:r,salt:n}});let o=await this.getSessionKey(t),c=await this.sessionsStateStore.getState(),d=await this.localKeyRepo.generate();if(e in c)await this.sessionsStateStore.set({...c,[e]:{status:"open",sessionKey:o,localKey:d?(0,N.s)(d):null}});else{let t={status:"open",sessionKey:o,localKey:d?(0,N.s)(d):null};await this.sessionsStateStore.set({...c,[e]:t})}return o});await this.context.commands.setActiveUser({userName:e}),await this.eventEmitter.sendEvent("sessionOpening",void 0),await this.eventEmitter.sendEvent("sessionOpened",{sessionKey:i,login:e})}async handleLogout(){let e=[];for(let t of(await z.runExclusive(async()=>{let t=await this.sessionsStateStore.getState(),i={};for(let[s,r]of Object.entries(t)){if("closed"===r.status){i[s]=r;continue}if("sso"===r.sessionKey.type){e.push(s);continue}let t=await (0,x.z)(this.settings.getConfig(s));if(!(0,v.d6)(t))throw Error("Fail to get crypto settings");let n=t.data,a=r.localKey?(0,N.s)(await this.encryptor.encrypt((0,L.R)(r.localKey),r.sessionKey,n)):null;i[s]={status:"closed",encryptedLocalKey:a},e.push(s)}await this.sessionsStateStore.set(i)}),e))await this.eventEmitter.sendEvent("sessionClosed",{mode:es.K.Close,email:t})}async handle(e){if("carbonLoginStatusChanged"===e.body.eventName){let t=e.body.eventData;t.loggedIn?await this.handleLogin(t.login,!!t.needsSSOMigration):await this.handleLogout()}"openSessionFailed"===e.body.eventName&&this.handleLogout()}constructor(e,t,i,s,r,n,a,o,c){this.carbon=e,this.sessionsStateStore=t,this.sessionsCryptoSettingsStore=i,this.eventEmitter=s,this.randomValuesGetter=r,this.localKeyRepo=n,this.encryptor=a,this.settings=o,this.context=c}}eH=(0,s.gn)([(0,eA.b)(eb.Dj),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===F._?Object:F._,W,I,void 0===ei?Object:ei,void 0===eQ.Y?Object:eQ.Y,void 0===B?Object:B,void 0===M?Object:M,void 0===b?Object:b,void 0===en.Q?Object:en.Q])],eH);class e${}e$=(0,s.gn)([(0,r.Y)({api:o.Q,crons:[{handler:eT,periodInMinutes:1,name:"close-session-idle-cron",scope:a.F.User}],handlers:{commands:{flushLocalData:_,prepareLocalDataFlush:T,closeUserSession:ea,createUserSession:ee,openUserSession:ed,deleteLocalSession:ev,copyUserDataAndOpenSession:eY,updateUserSessionKey:e_},events:{...(0,r.g)(u.W,{carbonLegacy:eH,CarbonLegacyDeviceRemotelyDeleted:eC})},queries:{selectedOpenedSession:eg,checkSessionKey:eI,exportSessionKey:eP,currentSessionInfo:eL,localSessions:eG}},providers:[ei,p.t,h.n,g.Y,B,ec,M,ew,b,K,eN.h,eV.w,{provide:c.BD,useClass:eS},eD,J,Z],exports:[p.t,h.n,g.Y,c.BD,eN.h,eV.w],stores:[W,I,H],imports:[l.D,n.G],configurations:{session:{token:eO.b}},requiredFeatureFlips:Object.values(d.e)})],e$)},98942:function(e,t,i){i.d(t,{w:()=>o});var s=i(21636),r=i(94190),n=i(20119),a=i(44577);class o{async getDeviceCredentialsForUser(e){let t=await (0,a.z)(this.repository.getInfos());if(t.login!==e)throw Error("Cant get the credentials of another user");return{deviceAccessKey:t.deviceKeys.accessKey,deviceSecretKey:t.deviceKeys.secretKey,login:t.login}}constructor(e){this.repository=e}}o=(0,s.gn)([(0,r.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===n.h?Object:n.h])],o)},20119:function(e,t,i){i.d(t,{h:()=>d});var s=i(21636),r=i(72907),n=i(49247),a=i(94190),o=i(306),c=i(18550);class d{getInfos(){return this.carbon.queries.carbonStateList({paths:["userSession.account.login","authentication.currentUser.deviceKeys","userSession.localSettings.uki","userSession.session.analyticsIds","userSession.session.publicUserId","userSession.personalSettings.CryptoUserPayload","userSession.personalSettings.CryptoFixedSalt"]}).pipe((0,r.w)(async e=>{if(!(0,o.d6)(e))throw Error("failed to get carbon data");let[t,i,s,r,n,a,d]=e.data;if(!(r&&"object"==typeof r&&"userAnalyticsId"in r&&"deviceAnalyticsId"in r&&"string"==typeof r.userAnalyticsId&&"string"==typeof r.deviceAnalyticsId))throw Error("analytics not of type string");let l=function(e,t){if(e&&"object"==typeof e&&"accessKey"in e&&"secretKey"in e&&"string"==typeof e.accessKey&&"string"==typeof e.secretKey)return e;if("string"==typeof t)return function(e){let t=e.split("-");if(t.length>0){let[i]=t;return{accessKey:i,secretKey:e}}throw Error("Invalid UKI format")}(t);throw Error("unable to get device keys")}(i,s);return(0,c.Ay)({login:String(t),deviceAccessKey:l.accessKey,analytics:{deviceId:r.deviceAnalyticsId,userId:r.userAnalyticsId},deviceKeys:l,publicUserId:n,cryptoSettings:{cryptoUserPayload:a,cryptoFixedSalt:d}})}))}constructor(e){this.carbon=e}}d=(0,s.gn)([(0,a.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===n._?Object:n._])],d)},16892:function(e,t,i){i.d(t,{r:()=>Z});var s=i(21636),r=i(48035),n=i(90573),a=i(3068),o=i(42589),c=i(62506),d=i(306),l=i(99178),u=i(72907),p=i(69853),h=i(72233),g=i(41509),m=i(36884),v=i(81433),y=i(45991),w=i(94190),S=i(26984),f=i(19855),E=i(49247),I=i(37797);let b=e=>!!e?.name&&e.name!==I.s.DeviceLimitDone&&e.name!==I.s.OpeningSessionAfterDeviceLimitRemoval;var A=i(58060);class C{check(){let{liveLoginDeviceLimitFlow:e}=this.carbon.queries;return e(void 0).pipe((0,o.U)(e=>(0,d.d6)(e)?b(e.data)?[l.Oq.DeviceLimited]:[]:(console.log("loginDeviceLimitFlow query has failed"),this.anomalyReporter.commands.reportAnomaly({criticality:"warning",message:"loginDeviceLimitFlow query has failed",moduleName:"vault-access",useCaseName:"isAllowedQuery",applicationComponent:"",anomalyType:"other"}),[])))}constructor(e,t){this.carbon=e,this.anomalyReporter=t,this.name="device-limit"}}C=(0,s.gn)([(0,w.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===E._?Object:E._,void 0===A.G?Object:A.G])],C);var R=i(46266),_=i(47146);class O extends(0,R.E)(_.j){}(0,R.K)(_.j,O);let T={masterPassword:!1,invisibleMasterPassword:!0};class F{check(e){if(!e)throw Error("No user login provided");let{getAccountAuthenticationType:t}=this.carbon.queries,i=t(),s=this.ark.queries.accountRecoveryKeyStatus({login:e});return(0,m.a)({accountAuthenticationType:i,accountRecoveryKeyStatus:s}).pipe((0,o.U)(({accountAuthenticationType:e,accountRecoveryKeyStatus:t})=>(0,d.d6)(e)&&(0,d.d6)(t)?T[e.data]&&!t.data.isEnabled?[l.Oq.RequiresSettingUpRecoveryKey]:[]:(console.log("One of these queries has failed: [accountAuthenticationType, accountRecoveryKeyStatus]"),this.anomalyReporter.commands.reportAnomaly({criticality:"warning",message:"One of these queries has failed: [accountAuthenticationType, accountRecoveryKeyStatus]",moduleName:"vault-access",useCaseName:"isAllowedQuery",applicationComponent:"",anomalyType:"other"}),[])))}constructor(e,t,i){this.carbon=e,this.ark=t,this.anomalyReporter=i,this.name="enforce-ark"}}F=(0,s.gn)([(0,w.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===E._?Object:E._,O,void 0===A.G?Object:A.G])],F);var D=i(83816);let U={masterPassword:!1,invisibleMasterPassword:!0};class P{check(e){if(!e)throw Error("No user login provided");let{getAccountAuthenticationType:t}=this.carbon.queries,i=t(),s=this.pinCode.queries.getCurrentUserStatus();return(0,m.a)({accountAuthenticationType:i,pinCodeStatus:s}).pipe((0,o.U)(({accountAuthenticationType:e,pinCodeStatus:t})=>(0,d.d6)(e)&&(0,d.d6)(t)?U[e.data]&&!t.data.isPinCodeEnabled?[l.Oq.RequiresSettingUpPin]:[]:(console.log("One of these queries has failed: [accountAuthenticationType, pinCodeStatus]"),this.anomalyReporter.commands.reportAnomaly({criticality:"warning",message:"One of these queries has failed: [accountAuthenticationType, pinCodeStatus]",moduleName:"vault-access",useCaseName:"isAllowedQuery",applicationComponent:"",anomalyType:"other"}),[])))}constructor(e,t,i){this.carbon=e,this.pinCode=t,this.anomalyReporter=i,this.name="enforce-pin"}}P=(0,s.gn)([(0,w.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===E._?Object:E._,void 0===D.u?Object:D.u,void 0===A.G?Object:A.G])],P);var x=i(56144),N=i(30545),L=i(47038);class k{check(){let{liveTwoFactorAuthenticationInfo:e}=this.carbon.queries;return e(void 0).pipe((0,x.h)(e=>!(0,d.d6)(e)||e.data.status===L.dN.READY||e.data.status===L.dN.ERROR),(0,o.U)(e=>{if(!(0,d.d6)(e))throw Error("twoFactorAuthenticationInfo query has failed");return e.data.status===L.dN.READY&&e.data.shouldEnforceTwoFactorAuthentication?[l.Oq.Requires2FAEnforcement]:[]}),(0,N.O)([]),(0,v.x)((e,t)=>(0,y.shallowEqualArrays)(e,t)))}constructor(e){this.carbon=e,this.name="enforce-two-factor-authentication"}}k=(0,s.gn)([(0,w.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===E._?Object:E._])],k);var j=i(11396),G=i(4772),V=i(90555);let M={[V.vX.MP_TO_SSO]:l.Oq.RequiresMP2SSOMigration,[V.vX.MP_TO_SSO_WITH_INFO]:l.Oq.RequiresMP2SSOMigration,[V.vX.SSO_TO_MP]:l.Oq.RequiresSSO2MPMigration};class K{check(){let{getProviderInfo:e}=this.authentication.queries;return e(void 0).pipe((0,o.U)(e=>(0,d.d6)(e)?void 0!==e.data.migrationType?[M[e.data.migrationType]]:[]:(console.log("ssoMigrationType query has failed"),this.anomalyReporter.commands.reportAnomaly({criticality:"warning",message:"ssoMigrationType query has failed",moduleName:"vault-access",useCaseName:"SsoMigrationCheckerService",applicationComponent:"",anomalyType:"other"}),[])))}constructor(e,t){this.authentication=e,this.anomalyReporter=t,this.name="sso-migration"}}K=(0,s.gn)([(0,w.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===j||void 0===G.e?Object:G.e,void 0===A.G?Object:A.G])],K);var W=i(84323);class z extends(0,R.E)(W.v){}(0,R.K)(W.v,z);class q{check(){return this.accountManagement.queries.pendingLoginChangeRequests().pipe((0,o.U)(e=>(0,d.d6)(e)?e.data.length>0?[l.Oq.RequiresChangeLoginEmail]:[]:(console.log("pendingLoginChangeRequests query has failed"),this.anomalyReporter.commands.reportAnomaly({criticality:"warning",message:"pendingLoginChangeRequests query has failed",moduleName:"vault-access",useCaseName:"ChangeLoginEmailCheckerService",applicationComponent:"",anomalyType:"other"}),[])))}constructor(e,t){this.accountManagement=e,this.anomalyReporter=t,this.name="change-login-email"}}function B(e,t){return e.isAllowed===t.isAllowed&&(!!e.isAllowed||!!t.isAllowed||(0,y.shallowEqualArrays)(e.reasons,t.reasons))}q=(0,s.gn)([(0,w.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[z,void 0===A.G?Object:A.G])],q);let Y={isAllowed:!0};class Q{execute(){let{selectedOpenedSession:e}=this.session.queries;return e(void 0).pipe((0,u.w)(e=>{if(!(0,d.d6)(e))throw Error("Failed to get active user's login");if(!e.data)return(0,p.of)({isAllowed:!1,reasons:[l.Oq.NoActiveUser]});let t=this.postLoginRequirements.map(t=>t.check(e.data).pipe((0,h.K)(()=>(console.log(`${t.name} query has failed`),this.exceptionLogger.captureException(Error(`${t.name} query has failed`),{useCaseName:"isAllowedQuery"}),(0,p.of)([]))),(0,g.V)({first:3e3,with:()=>(console.log(`${t.name} query has timed out`),this.exceptionLogger.captureException(Error(`${t.name} query has timed out`),{useCaseName:"isAllowedQuery"}),(0,p.of)([]))})));return(0,m.a)(t).pipe((0,o.U)(e=>{let t=Array.from(new Set(e.flat())).sort();return t.length>0?{isAllowed:!1,reasons:t}:Y}))}),(0,v.x)(B))}constructor(e,t,i,s,r,n,a,o){this.session=e,this.exceptionLogger=t,this.postLoginRequirements=[i,s,r,n,a,o]}}Q=(0,s.gn)([(0,w.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===f.x?Object:f.x,void 0===S.v?Object:S.v,void 0===C?Object:C,void 0===F?Object:F,void 0===P?Object:P,void 0===k?Object:k,void 0===K?Object:K,void 0===q?Object:q])],Q);class H{execute(){return this.postLoginRequirementsChecker.execute().pipe((0,o.U)(d.Vp))}constructor(e){this.postLoginRequirementsChecker=e}}H=(0,s.gn)([(0,c.e)(l.bY),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===Q?Object:Q])],H);var $=i(44849);class X{execute(){let{liveLoginDeviceLimitFlow:e}=this.carbon.queries;return e(void 0).pipe((0,o.U)(e=>{if(!(0,d.d6)(e))throw Error("liveLoginDeviceLimitFlow failed");return(0,d.Vp)({isLimited:b(e.data)})}))}constructor(e){this.carbon=e}}X=(0,s.gn)([(0,c.e)($.X),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===E._?Object:E._])],X);class Z{}Z=(0,s.gn)([(0,r.Y)({api:a.Y,handlers:{commands:{},events:{},queries:{isAllowed:H,deviceLimit:X}},providers:[C,Q,k,F,P,K,q],imports:[n.G]})],Z)},4274:function(e,t,i){i.d(t,{IP:()=>w,Iy:()=>h,Uv:()=>v,bd:()=>g,dg:()=>S,i:()=>f,oX:()=>m,qb:()=>u,qn:()=>E,y$:()=>p,y2:()=>y,y3:()=>l});var s,r,n,a,o,c,d=i(63762),l=((s={}).Admin="admin",s.Limited="limited",s),u=((r={}).Pending="pending",r.Accepted="accepted",r.Refused="refused",r.Revoked="revoked",r);let p=d.z.nativeEnum(u),h=d.z.nativeEnum(l),g=d.z.union([d.z.literal("noKey"),d.z.literal("publicKey"),d.z.literal("sharingKeys")]),m=d.z.union([d.z.literal("restricted"),d.z.literal("view"),d.z.literal("edit"),d.z.literal("full")]);var v=((n={}).User="user",n.UserGroup="group",n.CollectionUser="collectionUser",n.CollectionUserGroup="collectionUserGroup",n),y=((a={}).Secret="secret",a.Credential="password",a.SecureNote="note",a),w=((o={}).Group="group",o.Collection="collection",o.User="user",o);let S=d.z.nativeEnum(v),f=d.z.nativeEnum(w);var E=((c={}).AuditLogDetailsEncryptErrorMsg="Failed to encrypt audit log details",c)},42598:function(e,t,i){i.r(t),i.d(t,{RsaStatusSchema:()=>s.bd,SharedAccessEntrySchema:()=>x.wQ,SharedCollectionAccessLinkTypes:()=>eu.oP,SharingInvitesClient:()=>B,SharingSyncClient:()=>eS,ATTACHMENT_IN_COLLECTION:()=>es.Pf,GetPermissionForItemQuery:()=>h.C,InviteCollectionMembersCommand:()=>en.Q,SharedCollectionStateSchema:()=>eu.nW,RefuseCollectionInviteFailedError:()=>G.R$,GetSharingTeamLoginsQuery:()=>n.G,SharedItemPermissionLevelSchema:()=>s.oX,RefuseSharedItemBeforeDeletionCommandErrors:()=>O.m$,SharedCollectionAccessEntrySchema:()=>eu.Eo,RefuseCollectionInviteCommand:()=>G.UC,UpdateSharedItemPermissionCommand:()=>D.W,PendingCollectionInviteSchema:()=>z.ZS,createLimitExceededError:()=>T.Kb,RefuseUserGroupInviteInsufficientPrivilegesError:()=>M.FO,SharedItemRecipientIdsSchema:()=>x.QT,SharingItemsClient:()=>P.s,createPermissionsCollectionNotFoundError:()=>R.yE,CollectionKeyDecryptionLinkSchema:()=>eu.GL,AcceptUserGroupInviteCommand:()=>j.Q,sharingSyncApi:()=>ew.k,RefuseUserGroupInviteResultErrorCode:()=>M.xC,RefuseUserGroupInviteNotFoundError:()=>M.i6,GetPermissionForItemsQuery:()=>g.R,PendingSharedItemInviteSchema:()=>z.jd,ShareItemFailureReason:()=>f.z,ShareItemsErrorType:()=>T.Mb,UserGroupAccessSchema:()=>x.Ho,GetSharedCollectionsQuery:()=>Z.$,PermissionsAndCapabilitiesQuery:()=>R.G4,RefuseItemGroupInviteNotEnoughAdminsError:()=>V.Ix,RenameCollectionCommand:()=>ea.r,RefuseUserGroupInviteUserIsNotInUserGroupError:()=>M.xz,createForbiddenLastAdminError:()=>O.V$,GetItemIdsInSharedCollectionsSchema:()=>eu.Po,AcceptCollectionInviteCommand:()=>L.cD,RefuseUserGroupInviteUserGroupIsNotFoundError:()=>M.U1,AcceptCollectionInviteResultErrorCode:()=>L.Ti,RefuseItemGroupInviteUserGroupIsNotInItemGroupError:()=>V.Te,createPermissionsNoItemFoundError:()=>R.h$,RoleCapabilityDefinitionQuery:()=>C.F,GetSharedItemsQuery:()=>I.w,SharedAccessForItemQuery:()=>v.v,SharedCollectionAccessLinkTypesSchema:()=>eu.SE,RefuseUserGroupInviteUserGroupUpdateConflictError:()=>M.Xp,GetCollectionRoleForGroupQuery:()=>$.L,UsersAndGroupsInCollectionQuery:()=>et.O,DirectAccessSchema:()=>x.eA,CreateSharedCollectionCommand:()=>es.I4,ShareItemsErrorsQuery:()=>f.f,createForbiddenGroupItemError:()=>O.Vf,UpdateSharedItemContentCommand:()=>U.l,RevokeCollectionMembersCommand:()=>ec.q,SharedCollectionRoleSchema:()=>eu.gi,AcceptCollectionInviteFailedError:()=>L.nu,SharedVaultItemType:()=>x.nC,GetSharedAccessQuery:()=>b.w,sharingInvitesApi:()=>N.t,ErrorsMessages:()=>s.qn,GetCollectionsForUserOrGroupQuery:()=>X.Q,StatusSchema:()=>s.y$,sharingRemoteControlApi:()=>eI.X,PermissionSchema:()=>s.Iy,GetSharingGroupsWithItemCountQuery:()=>eR.$,GetItemIdsInSharedCollectionsQuery:()=>Q.q,RefuseSharedItemCommand:()=>_.l,GetIsLastAdminForItemQuery:()=>m.X,UserGroupCollectionAccessSchema:()=>eu.pU,getRefuseItemGroupInviteFunctionalError:()=>V.fr,RunSharingSyncCommand:()=>ef.N,IsSharingAllowedQuery:()=>S.B,ShareableItemType:()=>s.y2,GetSharedItemForIdQuery:()=>E.L,GetSharingStatusForItemQuery:()=>u.S,RefuseUserGroupInviteGroupHasInvalidStatusError:()=>M.kh,BaseSharedAccessEntrySchema:()=>x.BP,GetSharedAccessForItemIdsQuery:()=>A.D,SharedAccessSchema:()=>x.Im,SharedCollectionsStateSchema:()=>eu.T_,Status:()=>s.qb,RefuseUserGroupInviteCommand:()=>M.Fo,HasInvitesQuery:()=>W._,DirectCollectionAccessSchema:()=>eu.tF,GetTeamAdminSharingDataQuery:()=>eE.k,PendingInviteSchema:()=>z.ju,SharingDisabledReason:()=>eu.Hz,SharedCollectionsWithItemsQuery:()=>ee.MO,SharedItemSchema:()=>x.m$,sharingItemsApi:()=>r.X,SharedItemAccessLinkTypesSchema:()=>s.dg,GetSharingStatusForItemsQuery:()=>p.I,RefuseItemGroupInviteNotFoundError:()=>V.fL,RefuseUserGroupInviteUserIsNotInPendingStatusError:()=>M.PZ,ShareableCollectionVaultItemSchema:()=>ee.FN,UpdateCollectionMembersCommand:()=>ed.c,RefuseItemGroupInviteResultErrorCode:()=>V.dI,RefuseItemGroupInviteAuthorHasInvalidStatusError:()=>V.bp,createPermissionsBackwardCompatibilityError:()=>R._r,getRefuseUserGroupInviteFunctionalError:()=>M.cz,RefuseSharedItemBeforeDeletionCommand:()=>O.OL,sharingCollectionsApi:()=>Y.a,RemoteControlSharedItemsCommand:()=>eb.v,sharingRecipientsApi:()=>eh.A,GetSharingUsersQuery:()=>e_.K,AcceptSharedItemInviteCommand:()=>k.C,SharedItemDecryptionLinkSchema:()=>x.I2,UsersAndGroupsInCollectionSchema:()=>eu.a7,CollectionUserAccessSchema:()=>x.v,PendingUserGroupInviteSchema:()=>z.Ey,SharedCollectionUserOrGroupViewSchema:()=>eu.fg,CollectionUserGroupAccessSchema:()=>x.r8,GetInvitesQuery:()=>K.q,RefuseCollectionInviteResultErrorCode:()=>G.eT,MoveCollectionItemsToBusinessSpaceCommand:()=>eA.g,UpdatePermissionForCollectionItemCommand:()=>el.a,TeamAdminSharingDataSchema:()=>eE.m,ShareableCollectionSchema:()=>ee.JQ,DeleteSharedCollectionCommand:()=>er.U,RefuseItemGroupInviteInvalidItemGroupRevisionError:()=>V.Ne,SharingEnabledQuery:()=>a.N,GetSharingGroupByIdQuery:()=>em.e,RecipientTypes:()=>s.IP,AddItemsToCollectionsCommand:()=>ei.k,RefuseItemGroupInviteGroupHasInvalidStatusError:()=>V.Xj,GetSharedCollectionsCountQuery:()=>J.C,RefuseUserGroupInviteAuthorHasInvalidStatusError:()=>M.K8,GetCollectionPermissionsForUserQuery:()=>H.y,RefuseItemGroupInviteCommand:()=>V.gm,SharingCollectionsClient:()=>ep.L,SharingUserSchema:()=>ey,SortDirection:()=>eO.S,createAttachmentInCollectionError:()=>es.LG,createPermissionsEmptyItemIdsError:()=>R.XJ,isSharedVaultItemType:()=>x.RP,sharingCenterApi:()=>eC.m,GetSharedItemsForItemIdsQuery:()=>o.z,PermissionsAndCapabilitiesErrorCode:()=>R.Ix,RecipientTypeSchema:()=>s.i,SharedItemAccessLinkTypes:()=>s.Uv,createPartialSuccessError:()=>T.$u,Permission:()=>s.y3,GetAllAcceptedGroupsQuery:()=>eg.J,RefuseItemGroupInviteUserIsNotInPendingStatusError:()=>V.gR,RefuseUserGroupInviteInvalidItemGroupRevisionError:()=>M.Uf,GetItemGroupIdForItemIdQuery:()=>l,SharedCollectionRole:()=>eu.Yt,SharedCollectionAccessSchema:()=>eu.Ng,GetUserSharedVaultItemsQuery:()=>y.v,RefuseUserGroupInviteInvalidTeamIdError:()=>M.Ix,RemoveItemFromCollectionsCommand:()=>eo.B,RefuseItemGroupInviteUserIsNotInItemGroupError:()=>V.hp,ShareItemsCommand:()=>T.S2,SharedItemsIdsQuery:()=>w.c,RevokeSharedItemCommand:()=>F.V});var s=i(4274),r=i(50702),n=i(87254),a=i(60568),o=i(38012),c=i(45429),d=i(15021);class l extends(0,c.k)({scope:d.F.User}){}var u=i(41751),p=i(90048),h=i(51856),g=i(16132),m=i(71709),v=i(58881),y=i(58414),w=i(21222),S=i(35946),f=i(28795),E=i(96937),I=i(50218),b=i(10955),A=i(93058),C=i(31862),R=i(75427),_=i(80706),O=i(91682),T=i(85669),F=i(76910),D=i(85670),U=i(2816),P=i(49499),x=i(43909),N=i(50113),L=i(31608),k=i(3945),j=i(84834),G=i(38190),V=i(77481),M=i(94191),K=i(91526),W=i(14706),z=i(80905),q=i(46266);class B extends(0,q.E)(N.t){}(0,q.K)(N.t,B);var Y=i(59064),Q=i(72967),H=i(53110),$=i(33575),X=i(75247),Z=i(51560),J=i(85786),ee=i(48202),et=i(72322),ei=i(16098),es=i(50326),er=i(52037),en=i(60715),ea=i(25426),eo=i(90337),ec=i(81923),ed=i(92684),el=i(48274),eu=i(38392),ep=i(49219),eh=i(4466),eg=i(82986),em=i(13256),ev=i(63762);let ey=ev.z.object({userId:ev.z.string(),proposeSignature:ev.z.optional(ev.z.string()),acceptSignature:ev.z.optional(ev.z.nullable(ev.z.string())),status:ev.z.optional(s.y$),referrer:ev.z.optional(ev.z.string()),groupKey:ev.z.optional(ev.z.nullable(ev.z.string()))});var ew=i(70472);class eS extends(0,q.E)(ew.k){}(0,q.K)(ew.k,eS);var ef=i(89242),eE=i(11770),eI=i(22636),eb=i(62642),eA=i(30874),eC=i(68280),eR=i(73390),e_=i(99861),eO=i(72275)},68280:function(e,t,i){i.d(t,{m:()=>a});var s=i(36503),r=i(99861),n=i(73390);let a=(0,s.Q)({name:"sharingCenter",commands:{},events:{},queries:{getSharingUsers:r.K,getSharingGroupsWithItemCount:n.$}})},73390:function(e,t,i){i.d(t,{$:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},99861:function(e,t,i){i.d(t,{K:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},72275:function(e,t,i){i.d(t,{S:()=>r});var s,r=((s={}).Ascend="ascend",s.Descend="descend",s)},59064:function(e,t,i){i.d(t,{a:()=>E});var s=i(36503),r=i(16098),n=i(50326),a=i(52037),o=i(60715),c=i(92684),d=i(90337),l=i(25426),u=i(81923),p=i(48274),h=i(75247),g=i(72967),m=i(51560),v=i(53110),y=i(33575),w=i(85786),S=i(48202),f=i(72322);let E=(0,s.Q)({name:"sharingCollections",commands:{addItemsToCollections:r.k,createSharedCollection:n.I4,deleteSharedCollection:a.U,inviteCollectionMembers:o.Q,updateCollectionMembers:c.c,removeItemFromCollections:d.B,renameCollection:l.r,revokeCollectionMembers:u.q,updatePermissionForCollectionItem:p.a},events:{},queries:{getCollectionsForUserOrGroup:h.Q,getItemIdsInSharedCollections:g.q,getSharedCollections:m.$,getCollectionPermissionsForUser:v.y,getCollectionRoleForGroup:y.L,getSharedCollectionsCount:w.C,sharedCollectionsWithItems:S.MO,usersAndGroupsInCollection:f.O}})},16098:function(e,t,i){i.d(t,{k:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},50326:function(e,t,i){i.d(t,{I4:()=>c,LG:()=>o,Pf:()=>a});var s=i(66122),r=i(15021),n=i(96272);let a="ATTACHMENT_IN_COLLECTION",o=(0,n.Vj)(a,"Unable to share collections containing secure notes with attachments.");class c extends(0,s.g)({scope:r.F.User}){}},52037:function(e,t,i){i.d(t,{U:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},60715:function(e,t,i){i.d(t,{Q:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},90337:function(e,t,i){i.d(t,{B:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},25426:function(e,t,i){i.d(t,{r:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},81923:function(e,t,i){i.d(t,{q:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},92684:function(e,t,i){i.d(t,{c:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},48274:function(e,t,i){i.d(t,{a:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},72967:function(e,t,i){i.d(t,{q:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},33575:function(e,t,i){i.d(t,{L:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},53110:function(e,t,i){i.d(t,{y:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},75247:function(e,t,i){i.d(t,{Q:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},85786:function(e,t,i){i.d(t,{C:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},51560:function(e,t,i){i.d(t,{$:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},48202:function(e,t,i){i.d(t,{FN:()=>a,JQ:()=>o,MO:()=>c});var s=i(63762),r=i(45429),n=i(15021);let a=s.z.object({id:s.z.string(),type:s.z.string(),url:s.z.optional(s.z.string())}),o=s.z.object({id:s.z.string(),name:s.z.string(),spaceId:s.z.string(),vaultItems:s.z.array(a),isShared:s.z.optional(s.z.boolean())});class c extends(0,r.k)({scope:n.F.User}){}},72322:function(e,t,i){i.d(t,{O:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},49219:function(e,t,i){i.d(t,{L:()=>n});var s=i(46266),r=i(59064);class n extends(0,s.E)(r.a){}(0,s.K)(r.a,n)},38392:function(e,t,i){i.d(t,{Eo:()=>u,GL:()=>I,Hz:()=>v,Ng:()=>m,Po:()=>g,SE:()=>w,T_:()=>A,Yt:()=>d,a7:()=>h,fg:()=>p,gi:()=>l,nW:()=>b,oP:()=>y,pU:()=>E,tF:()=>f});var s,r,n,a=i(63762),o=i(4274),c=i(43909),d=((s={}).Editor="editor",s.Manager="manager",s);let l=a.z.nativeEnum(d),u=c.BP.extend({sharedCollectionRole:l}),p=a.z.object({label:a.z.string(),status:o.y$,sharedCollectionRole:l,id:a.z.string()}),h=a.z.object({userGroups:a.z.optional(a.z.array(p)),users:a.z.optional(a.z.array(p))}),g=a.z.array(a.z.string()),m=a.z.object({users:a.z.array(u),userGroups:a.z.array(u)});var v=((r={}).DisabledInTAC="disabledInTac",r.EditorRole="editorRole",r.LimitedRightItems="limitedRightItems",r),y=((n={}).User="user",n.UserGroup="group",n);let w=a.z.nativeEnum(y),S=a.z.object({sharedCollectionRole:l,proposeSignature:a.z.optional(a.z.string()),acceptSignature:a.z.optional(a.z.nullable(a.z.string())),encryptedResourceKey:a.z.string(),accessType:w}),f=S.extend({accessType:a.z.literal("user")}),E=S.extend({accessType:a.z.literal("group"),groupEncryptedKey:a.z.optional(a.z.string()),groupPrivateKey:a.z.optional(a.z.string()),groupPublicKey:a.z.optional(a.z.string())}),I=a.z.discriminatedUnion("accessType",[f,E]),b=a.z.object({id:a.z.string(),name:a.z.string(),privateKey:a.z.string(),publicKey:a.z.string(),revision:a.z.number(),isAccepted:a.z.boolean(),sharedCollectionRole:l,accessLink:a.z.optional(I),isLastAdmin:a.z.boolean(),authorLogin:a.z.optional(a.z.string()),pendingDirectAccess:a.z.optional(a.z.object({referrer:a.z.string(),sharedCollectionRole:l}))}),A=a.z.object({collections:a.z.record(b),sharedCollectionsAccess:a.z.record(m)})},50113:function(e,t,i){i.d(t,{t:()=>p});var s=i(36503),r=i(84834),n=i(3945),a=i(31608),o=i(38190),c=i(77481),d=i(94191),l=i(91526),u=i(14706);let p=(0,s.Q)({name:"sharingInvites",commands:{acceptUserGroupInvite:r.Q,acceptSharedItemInvite:n.C,acceptCollectionInvite:a.cD,refuseCollectionInvite:o.UC,refuseItemGroupInvite:c.gm,refuseUserGroupInvite:d.Fo},events:{},queries:{getInvites:l.q,hasInvites:u._}})},31608:function(e,t,i){i.d(t,{Ti:()=>o,cD:()=>d,nu:()=>c});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).AcceptFailed="AcceptFailed",s);class c extends(0,a.Hu)("AcceptFailed","Failed to accept collection"){}class d extends(0,r.g)({scope:n.F.User}){}},3945:function(e,t,i){i.d(t,{C:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},84834:function(e,t,i){i.d(t,{Q:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},38190:function(e,t,i){i.d(t,{R$:()=>c,UC:()=>d,eT:()=>o});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).RefuseFailed="RefuseFailed",s);class c extends(0,a.Hu)("RefuseFailed","Failed to refuse collection"){}class d extends(0,r.g)({scope:n.F.User}){}},77481:function(e,t,i){i.d(t,{Ix:()=>g,Ne:()=>h,Te:()=>p,Xj:()=>l,bp:()=>d,dI:()=>o,fL:()=>c,fr:()=>v,gR:()=>m,gm:()=>y,hp:()=>u});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).ItemGroupNotFound="ItemGroupNotFound",s.AuthorHasInvalidStatus="AuthorHasInvalidStatus",s.GroupHasInvalidStatus="GroupHasInvalidStatus",s.UserIsNotInItemGroup="UserIsNotInItemGroup",s.UserGroupIsNotInItemGroup="UserGroupIsNotInItemGroup",s.InvalidItemGroupRevision="InvalidItemGroupRevision",s.NotEnoughAdmins="NotEnoughAdmins",s.UserIsNotInPendingStatus="UserIsNotInPendingStatus",s);class c extends(0,a.Hu)("ItemGroupNotFound","Item Group not found"){}class d extends(0,a.Hu)("AuthorHasInvalidStatus","User is not in accepted/pending status (already refused or revoked)"){}class l extends(0,a.Hu)("GroupHasInvalidStatus","UserGroup is not in accepted/pending status (already refused or revoked)"){}class u extends(0,a.Hu)("UserIsNotInItemGroup","User is not part of item group"){}class p extends(0,a.Hu)("UserGroupIsNotInItemGroup","User group is not part of item group"){}class h extends(0,a.Hu)("InvalidItemGroupRevision","Item group revision is not valid"){}class g extends(0,a.Hu)("NotEnoughAdmins","The operation would let the item group with no admin"){}class m extends(0,a.Hu)("UserIsNotInPendingStatus",'User is not in "pending" status or not part of a group'){}function v(e){switch(e){case"AUTHOR_HAS_INVALID_STATUS":return new d;case"GROUP_HAS_INVALID_STATUS":return new l;case"USER_IS_NOT_IN_ITEM_GROUP":return new u;case"USER_GROUP_IS_NOT_IN_ITEM_GROUP":return new p;case"INVALID_ITEM_GROUP_REVISION":return new h;case"NOT_ENOUGH_ADMINS":return new g;case"USER_IS_NOT_IN_PENDING_STATUS":return new m;default:throw Error("Unknown server error")}}class y extends(0,r.g)({scope:n.F.User}){}},94191:function(e,t,i){i.d(t,{FO:()=>h,Fo:()=>S,Ix:()=>d,K8:()=>y,PZ:()=>m,U1:()=>l,Uf:()=>u,Xp:()=>p,cz:()=>w,i6:()=>c,kh:()=>v,xC:()=>o,xz:()=>g});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).UserGroupNotFound="UserGroupNotFound",s.InvalidTeamId="InvalidTeamId",s.UserGroupIsNotFound="UserGroupIsNotFound",s.InvalidItemGroupRevision="InvalidItemGroupRevision",s.UserGroupUpdateConflict="UserGroupUpdateConflict",s.InsufficientPrivileges="InsufficientPrivileges",s.UserIsNotInUserGroup="UserIsNotInUserGroup",s.UserIsNotInPendingStatus="UserIsNotInPendingStatus",s.GroupHasInvalidStatus="GroupHasInvalidStatus",s.AuthorHasInvalidStatus="AuthorHasInvalidStatus",s);class c extends(0,a.Hu)("UserGroupNotFound","User Group not found"){}class d extends(0,a.Hu)("InvalidTeamId","Provided Team ID is not a number"){}class l extends(0,a.Hu)("UserGroupIsNotFound","User group for provided ID does not exist"){}class u extends(0,a.Hu)("InvalidItemGroupRevision","User group revision is not valid"){}class p extends(0,a.Hu)("UserGroupUpdateConflict","Conflict between users attempting to update the same user group"){}class h extends(0,a.Hu)("InsufficientPrivileges","The user does not have User Group permission to refuse the invitation"){}class g extends(0,a.Hu)("UserIsNotInUserGroup","User is not part of a group"){}class m extends(0,a.Hu)("UserIsNotInPendingStatus",'User is not in "pending" status or not part of a group'){}class v extends(0,a.Hu)("GroupHasInvalidStatus",'UserGroup is not in "accepted" or "pending" status (already refused or revoked)'){}class y extends(0,a.Hu)("AuthorHasInvalidStatus","User is not in accepted/pending status (already refused or revoked)"){}function w(e){switch(e){case"INVALID_TEAM_ID":return new d;case"USER_GROUP_IS_NOT_FOUND":return new l;case"INVALID_USER_GROUP_REVISION":return new u;case"USER_GROUP_UPDATE_CONFLICT":return new p;case"INSUFFICIENT_PRIVILEGES":return new h;case"USER_IS_NOT_IN_USER_GROUP":return new g;case"USER_IS_NOT_IN_PENDING_STATUS":return new m;case"GROUP_HAS_INVALID_STATUS":return new v;case"AUTHOR_HAS_INVALID_STATUS":return new y;default:throw Error("Unknown server error")}}class S extends(0,r.g)({scope:n.F.User}){}},91526:function(e,t,i){i.d(t,{q:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},14706:function(e,t,i){i.d(t,{_:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},80905:function(e,t,i){i.d(t,{Ey:()=>c,ZS:()=>d,jd:()=>g,ju:()=>o});var s=i(63762),r=i(4274),n=i(38392);let a=s.z.object({referrer:s.z.string()}),o=a.extend({id:s.z.string(),name:s.z.string()}),c=o,d=o.extend({sharedCollectionRole:n.gi});o.extend({permission:r.Iy});let l=a.extend({vaultItemId:s.z.string(),sharedItemId:s.z.string(),revision:s.z.number(),title:s.z.string(),spaceId:s.z.optional(s.z.string()),sharingPermissionLevel:r.oX}),u=l.extend({itemType:s.z.literal(r.y2.Credential),url:s.z.optional(s.z.string()),login:s.z.optional(s.z.string()),secondaryLogin:s.z.optional(s.z.string()),email:s.z.optional(s.z.string()),linkedDomains:s.z.optional(s.z.array(s.z.string()))}),p=l.extend({itemType:s.z.literal(r.y2.SecureNote),color:s.z.optional(s.z.string()),secured:s.z.boolean()}),h=l.extend({itemType:s.z.literal(r.y2.Secret),secured:s.z.boolean()}),g=s.z.union([u,p,h])},50702:function(e,t,i){i.d(t,{X:()=>T});var s=i(36503),r=i(85670),n=i(2816),a=i(76910),o=i(80706),c=i(91682),d=i(85669),l=i(10955),u=i(93058),p=i(50218),h=i(96937),g=i(35946),m=i(87254),v=i(60568),y=i(38012),w=i(41751),S=i(90048),f=i(51856),E=i(16132),I=i(71709),b=i(75427),A=i(58881),C=i(58414),R=i(21222),_=i(28795),O=i(31862);let T=(0,s.Q)({name:"sharingItems",commands:{updateSharedItemPermission:r.W,updateSharedItemContent:n.l,revokeSharedItem:a.V,refuseSharedItem:o.l,refuseSharedItemBeforeDeletion:c.OL,shareItems:d.S2},events:{},queries:{getSharedAccess:l.w,getSharedAccessForItemIds:u.D,getSharedItems:p.w,getSharedItemForId:h.L,isSharingAllowed:g.B,getSharingTeamLogins:m.G,sharingEnabled:v.N,getSharedItemsForItemIds:y.z,getSharingStatusForItem:w.S,getSharingStatusForItems:S.I,getPermissionForItem:f.C,getPermissionForItems:E.R,getIsLastAdminForItem:I.X,permissionsAndCapabilities:b.G4,sharedAccessForItem:A.v,getUserSharedVaultItems:C.v,sharedItemsIds:R.c,shareItemsErrors:_.f,roleCapabilityDefinition:O.F}})},91682:function(e,t,i){i.d(t,{OL:()=>d,V$:()=>c,Vf:()=>o,m$:()=>a});var s=i(66122),r=i(15021),n=i(96272);let a=Object.freeze({FORBIDDEN_GROUP_ITEM:"FORBIDDEN_GROUP_ITEM",FORBIDDEN_LAST_ADMIN:"FORBIDDEN_LAST_ADMIN"}),o=(0,n.Vj)(a.FORBIDDEN_GROUP_ITEM,"The Vault Item cannot be deleted while shared via user group."),c=(0,n.Vj)(a.FORBIDDEN_LAST_ADMIN,"The Vault Item cannot be deleted while the current user is the last admin.");class d extends(0,s.g)({scope:r.F.User}){}},80706:function(e,t,i){i.d(t,{l:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},76910:function(e,t,i){i.d(t,{V:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},85669:function(e,t,i){i.d(t,{$u:()=>d,Kb:()=>c,Mb:()=>o,S2:()=>l});var s,r=i(66122),n=i(15021),a=i(96272),o=((s={}).LIMIT_EXCEEDED="LIMIT_EXCEEDED",s.PARTIAL_SUCCESS="PARTIAL_SUCCESS",s);let c=(0,a.Vj)("LIMIT_EXCEEDED","Sharing limit exceeded"),d=(0,a.Vj)("PARTIAL_SUCCESS","Some items were shared successfully, but not all");class l extends(0,r.g)({scope:n.F.User}){}},2816:function(e,t,i){i.d(t,{l:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},85670:function(e,t,i){i.d(t,{W:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},71709:function(e,t,i){i.d(t,{X:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},51856:function(e,t,i){i.d(t,{C:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User,useCache:!0}){}},16132:function(e,t,i){i.d(t,{R:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},93058:function(e,t,i){i.d(t,{D:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},10955:function(e,t,i){i.d(t,{w:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},96937:function(e,t,i){i.d(t,{L:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},38012:function(e,t,i){i.d(t,{z:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},50218:function(e,t,i){i.d(t,{w:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},41751:function(e,t,i){i.d(t,{S:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User,useCache:!0}){}},90048:function(e,t,i){i.d(t,{I:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},87254:function(e,t,i){i.d(t,{G:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},58414:function(e,t,i){i.d(t,{v:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},35946:function(e,t,i){i.d(t,{B:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User,useCache:!0}){}},75427:function(e,t,i){i.d(t,{G4:()=>p,Ix:()=>o,XJ:()=>d,_r:()=>u,h$:()=>l,yE:()=>c});var s,r=i(45429),n=i(15021),a=i(96272),o=((s={}).COLLECTION_NOT_FOUND="COLLECTION_NOT_FOUND",s.EMPTY_ITEM_IDS="EMPTY_ITEM_IDS",s.NO_ITEM_FOUND="NO_ITEM_FOUND",s.BACKWARD_COMPATIBILITY_ERROR="BACKWARD_COMPATIBILITY_ERROR",s);let c=(0,a.Vj)("COLLECTION_NOT_FOUND","Collection not found"),d=(0,a.Vj)("EMPTY_ITEM_IDS","No item IDs provided"),l=(0,a.Vj)("NO_ITEM_FOUND","No item found"),u=(0,a.Vj)("BACKWARD_COMPATIBILITY_ERROR","Hard coded business rule relying on a non existing permission level");class p extends(0,r.k)({scope:n.F.User,useCache:!0}){}},31862:function(e,t,i){i.d(t,{F:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},28795:function(e,t,i){i.d(t,{f:()=>o,z:()=>a});var s,r=i(45429),n=i(15021),a=((s={})[s.ITEM_DOESNT_EXIST=0]="ITEM_DOESNT_EXIST",s[s.LIMIT_EXCEEDED=1]="LIMIT_EXCEEDED",s[s.ITEM_HAS_ATTACHMENTS=2]="ITEM_HAS_ATTACHMENTS",s[s.INVALID_REVISION=3]="INVALID_REVISION",s[s.SHARING_FAILED=4]="SHARING_FAILED",s);class o extends(0,r.k)({scope:n.F.User}){}},58881:function(e,t,i){i.d(t,{v:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},21222:function(e,t,i){i.d(t,{c:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},60568:function(e,t,i){i.d(t,{N:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User,useCache:!0}){}},49499:function(e,t,i){i.d(t,{s:()=>n});var s=i(46266),r=i(50702);class n extends(0,s.E)(r.X){}(0,s.K)(r.X,n)},43909:function(e,t,i){i.d(t,{BP:()=>h,Ho:()=>c,I2:()=>u,Im:()=>m,QT:()=>p,RP:()=>w,eA:()=>o,m$:()=>v,nC:()=>y,r8:()=>l,v:()=>d,wQ:()=>g});var s,r=i(63762),n=i(4274);let a=r.z.object({sharingPermissionLevel:n.oX,proposeSignature:r.z.optional(r.z.string()),acceptSignature:r.z.optional(r.z.nullable(r.z.string())),encryptedResourceKey:r.z.string(),accessType:n.dg}),o=a.extend({accessType:r.z.literal(n.Uv.User)}),c=a.extend({accessType:r.z.literal(n.Uv.UserGroup),groupEncryptedKey:r.z.optional(r.z.string()),groupPrivateKey:r.z.optional(r.z.string()),groupPublicKey:r.z.optional(r.z.string())}),d=a.extend({accessType:r.z.literal(n.Uv.CollectionUser),collectionEncryptedKey:r.z.optional(r.z.string()),collectionPrivateKey:r.z.optional(r.z.string()),collectionPublicKey:r.z.optional(r.z.string())}),l=a.extend({accessType:r.z.literal(n.Uv.CollectionUserGroup),collectionEncryptedKey:r.z.optional(r.z.string()),collectionPrivateKey:r.z.optional(r.z.string()),groupEncryptedKey:r.z.optional(r.z.string()),groupPrivateKey:r.z.optional(r.z.string()),groupPublicKey:r.z.optional(r.z.string()),collectionPublicKey:r.z.optional(r.z.string())}),u=r.z.union([o,c,d,l]),p=r.z.object({userIds:r.z.optional(r.z.nullable(r.z.array(r.z.string()))),collectionIds:r.z.optional(r.z.nullable(r.z.array(r.z.string()))),userGroupIds:r.z.optional(r.z.nullable(r.z.array(r.z.string())))}),h=r.z.object({id:r.z.string(),name:r.z.string(),status:r.z.optional(n.y$)}),g=h.extend({sharingPermissionLevel:n.oX}),m=r.z.object({users:r.z.array(g),userGroups:r.z.array(g),collections:r.z.array(g)}),v=r.z.object({accessLink:r.z.optional(u),sharedItemId:r.z.string(),itemId:r.z.string(),itemKey:r.z.string(),revision:r.z.number(),recipientIds:p,sharingPermissionLevel:n.oX,isLastAdmin:r.z.boolean()});var y=((s={}).Credential="KWAuthentifiant",s.Secret="KWSecret",s.SecureNote="KWSecureNote",s);let w=e=>Object.values(y).includes(e)},4466:function(e,t,i){i.d(t,{A:()=>a});var s=i(36503),r=i(82986),n=i(13256);let a=(0,s.Q)({name:"sharingRecipients",commands:{},events:{},queries:{getAllAcceptedGroups:r.J,getSharingGroupById:n.e}})},82986:function(e,t,i){i.d(t,{J:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},13256:function(e,t,i){i.d(t,{e:()=>n});var s=i(45429),r=i(15021);class n extends(0,s.k)({scope:r.F.User}){}},22636:function(e,t,i){i.d(t,{X:()=>a});var s=i(36503),r=i(62642),n=i(30874);let a=(0,s.Q)({name:"sharingRemoteControl",commands:{remoteControlSharedItems:r.v,moveCollectionItemsToBusinessSpace:n.g},events:{},queries:{}})},30874:function(e,t,i){i.d(t,{g:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},62642:function(e,t,i){i.d(t,{v:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},70472:function(e,t,i){i.d(t,{k:()=>a});var s=i(36503),r=i(89242),n=i(11770);let a=(0,s.Q)({name:"sharingSync",commands:{runSharingSync:r.N},events:{},queries:{getTeamAdminSharingData:n.k}})},89242:function(e,t,i){i.d(t,{N:()=>n});var s=i(66122),r=i(15021);class n extends(0,s.g)({scope:r.F.User}){}},11770:function(e,t,i){i.d(t,{k:()=>p,m:()=>u});var s=i(63762),r=i(45429),n=i(15021),a=i(4274);let o=s.z.object({userId:s.z.string(),alias:s.z.string(),referrer:s.z.string(),groupKey:s.z.string().nullable().optional(),permission:s.z.enum(["admin","limited"]),rsaStatus:a.bd,status:a.y$}),c=s.z.object({groupId:s.z.string(),name:s.z.string(),type:s.z.literal("teamAdmins"),publicKey:s.z.string(),privateKey:s.z.string(),revision:s.z.number(),users:s.z.array(o)}),d=s.z.object({groupId:s.z.string(),items:s.z.array(s.z.object({itemId:s.z.string(),itemKey:s.z.string()})).optional(),revision:s.z.number(),type:s.z.literal("userGroupKeys"),users:s.z.array(o).optional()}),l=s.z.object({content:s.z.string(),timestamp:s.z.number(),itemId:s.z.string()}),u=s.z.object({specialItemGroup:d.optional(),specialUserGroup:c.optional(),specialItems:s.z.record(l).optional()});class p extends(0,r.k)({scope:n.F.User}){}},89005:function(e,t,i){i.d(t,{y:()=>l});var s=i(21636),r=i(48035),n=i(62434),a=i(79791),o=i(95255),c=i(72094),d=i(53990);class l{}l=(0,s.gn)([(0,r.Y)({sharedModuleName:"sharing-carbon-helpers",providers:[n.J,a.n,o.a,c.H,d.F],exports:[n.J,a.n,o.a,c.H,d.F],imports:[]})],l)},62434:function(e,t,i){i.d(t,{J:()=>d});var s=i(21636),r=i(44577),n=i(71749),a=i(49247),o=i(94190),c=i(306);class d{async getCarbonCredentialsByItemIds(e){let{queries:{carbonState:t}}=this.client,i=await (0,r.z)(t({path:"userSession.personalData.credentials"}));if((0,c.hx)(i))throw Error("Unable to access credentials from carbon");let s=i.data;if(!s)throw Error("No credentials found");if(!(Array.isArray(s)&&s.every(n.G)))throw Error("Credentials are invalid");let a=s.reduce((e,t)=>(e[t.Id]=t,e),{});return e.reduce((e,t)=>(t in a&&e.push(a[t]),e),[])}constructor(e){this.client=e}}d=(0,s.gn)([(0,o.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===a._?Object:a._])],d)},79791:function(e,t,i){i.d(t,{n:()=>p});var s=i(21636),r=i(81433),n=i(20661),a=i(49247),o=i(94190),c=i(17741);let d=e=>!!e&&!!e.associatedEmail&&!!e.billingAdmins&&!!e.color&&!!e.info&&!!e.letter&&!!e.planType&&!!e.status&&!!e.teamAdmins&&!!e.teamId&&!!e.teamName&&!!e.tier,l=e=>!!(e&&Array.isArray(e))&&0!==e.length&&d(e.find(e=>"accepted"===e.status)),u=e=>{if(!e)return{teamId:"",isSharingEnabled:!1,isCollectionsSharingEnabled:!1,areSensitiveLogsEnabled:!1};if(!l(e.spaces))return{teamId:"",isSharingEnabled:!0,isCollectionsSharingEnabled:!1,areSensitiveLogsEnabled:!1};let t=e.spaces.find(e=>"accepted"===e.status),i=!!e.capabilities?.collectionSharing.enabled,s=e.capabilities?.sharingLimit.info?.limit;return{teamId:t?.teamId??"",isSharingEnabled:!!(t&&!t.info.sharingDisabled),areSensitiveLogsEnabled:!!t?.info.collectSensitiveDataAuditLogsEnabled,isCollectionsSharingEnabled:i,sharedItemsLimit:s}};class p{get(){let{getNodePremiumStatus:e}=this.carbon.queries;return e().pipe((0,c.Qn)(u),(0,r.x)((e,t)=>(0,n.Z)(e,t)))}constructor(e){this.carbon=e}}p=(0,s.gn)([(0,o.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===a._?Object:a._])],p)},95255:function(e,t,i){i.d(t,{a:()=>c});var s=i(21636),r=i(44577),n=i(49247),a=i(94190),o=i(17741);class c{async getCurrentUserWithKeys(){let{queries:{carbonStateList:e}}=this.client;return await (0,r.z)(e({paths:["userSession.account.login","userSession.session.keyPair.publicKey","userSession.session.keyPair.privateKey"]}).pipe((0,o.nb)({success:([e,t,i])=>{if("string"!=typeof e||"string"!=typeof t||"string"!=typeof i)throw Error("Invalid format of current user keys");return{login:e,publicKey:t,privateKey:i}},failure:()=>{throw Error("Failure getting current user and key pair")}})))}constructor(e){this.client=e}}c=(0,s.gn)([(0,a.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===n._?Object:n._])],c)},72094:function(e,t,i){i.d(t,{H:()=>d});var s=i(21636),r=i(44577),n=i(70727),a=i(49247),o=i(94190),c=i(306);class d{async getCarbonNotesByItemIds(e){let{queries:{carbonState:t}}=this.client,i=await (0,r.z)(t({path:"userSession.personalData.notes"}));if((0,c.hx)(i))throw Error("Unable to access notes from carbon");let s=i.data;if(!s)throw Error("No notes found");if(!(Array.isArray(s)&&s.every(n.g)))throw Error("Notes are invalid");let a=s.reduce((e,t)=>(e[t.Id]=t,e),{});return e.reduce((e,t)=>(t in a&&e.push(a[t]),e),[])}constructor(e){this.client=e}}d=(0,s.gn)([(0,o.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===a._?Object:a._])],d)},53990:function(e,t,i){i.d(t,{F:()=>d});var s=i(21636),r=i(44577),n=i(51603),a=i(49247),o=i(94190),c=i(306);class d{async getCarbonSecretsByItemIds(e){let{queries:{carbonState:t}}=this.client,i=await (0,r.z)(t({path:"userSession.personalData.secrets"}));if((0,c.hx)(i))throw Error("Unable to access secrets from carbon");let s=i.data;if(!s)throw Error("No secrets found");if(!(Array.isArray(s)&&s.every(n.k)))throw Error("Secrets are invalid");let a=s.reduce((e,t)=>(e[t.Id]=t,e),{});return e.reduce((e,t)=>(t in a&&e.push(a[t]),e),[])}constructor(e){this.client=e}}d=(0,s.gn)([(0,o.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===a._?Object:a._])],d)},59311:function(e,t,i){i.d(t,{k:()=>O});var s=i(21636),r=i(48035),n=i(68280),a=i(42589),o=i(72907),c=i(56144),d=i(3750),l=i(62506),u=i(306),p=i(99861),h=i(84809),g=i(1833),m=i(94190),v=i(57178),y=i(47244),w=i(26342);class S{getSharedVaultItemsForSpaceId(e){return this.sharedItemsRepo.sharedItems$().pipe((0,o.w)(t=>{let i=t.map(e=>e.itemId),s=this.vaultItemsCrud.queries.query({vaultItemTypes:[v.U.Credential,v.U.SecureNote,v.U.Secret],ids:i,propertyFilters:null!==e?[{property:"spaceId",value:e}]:void 0});return(0,g.D)(s)}))}constructor(e,t){this.vaultItemsCrud=e,this.sharedItemsRepo=t}}S=(0,s.gn)([(0,m.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===y.L?Object:y.L,void 0===w.z?Object:w.z])],S);class f{execute({body:e}){let{spaceId:t,sortDirection:i}=e;return null!==t?this.executeWithSpace(t,i):this.executeWithoutSpace(i)}executeWithoutSpace(e){return this.sharedItemsRepo.sharedAccess$().pipe((0,a.U)(t=>{let i=this.getSharingUsersFromSharedAccess(t,e);return(0,u.Vp)(i)}))}executeWithSpace(e,t){return this.getVaultItemIdsInSpace(e).pipe((0,o.w)(e=>this.sharedItemsRepo.sharedAccessForIds$(e)),(0,a.U)(e=>{let i=this.getSharingUsersFromSharedAccess(e,t);return(0,u.Vp)(i)}))}getCurrentUserLogin(){return this.context.get(d.l.UserName)}getVaultItemIdsInSpace(e){return this.recipientItems.getSharedVaultItemsForSpaceId(e).pipe((0,c.h)(u.d6),(0,a.U)(e=>{let t=(0,u.db)(e);return[...t.credentialsResult.items.map(e=>e.id),...t.secureNotesResult.items.map(e=>e.id),...t.secretsResult.items.map(e=>e.id)]}))}getSharingUsersFromSharedAccess(e,t){let i=this.getCurrentUserLogin(),s=new Map;return e.forEach(e=>{!e.users.some(e=>e.id===i&&"accepted"!==e.status)&&e.users.forEach(e=>{if(e.id===i||"accepted"!==e.status&&"pending"!==e.status)return;let t=s.has(e.id)?s.get(e.id).itemCount:0;s.set(e.id,{id:e.id,itemCount:t+1})})}),Array.from(s.values()).sort((e,i)=>t===h.S.Ascend?e.id.localeCompare(i.id):i.id.localeCompare(e.id))}constructor(e,t,i){this.context=e,this.recipientItems=t,this.sharedItemsRepo=i}}f=(0,s.gn)([(0,l.e)(p.K),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===d.f?Object:d.f,void 0===S?Object:S,void 0===w.z?Object:w.z])],f);var E=i(21958),I=i(72275),b=i(73390),A=i(19425);class C{execute({body:e}){let{sortDirection:t}=e;return this.sharedItemsRepo.sharedAccess$().pipe((0,E.V)(this.userGroupsRepo.getUserGroups()),(0,a.U)(([e,i])=>{let s=this.context.get(d.l.UserName)??"",r=new Map;Object.values(i).forEach(e=>{e.acceptedUsers?.includes(s)&&r.set(e.groupId,{id:e.groupId,name:e.name,users:e.acceptedUsers,itemCount:0})}),e.forEach(e=>{e.userGroups.forEach(e=>{if("accepted"!==e.status)return;let t=r.get(e.id);if(!t)return;let i=t.itemCount||0;r.set(t.id,{id:t.id,name:t.name,users:t.users,itemCount:i+1})})});let n=Array.from(r.values()).sort((e,i)=>t===I.S.Ascend?e.name.localeCompare(i.name):i.name.localeCompare(e.name));return(0,u.Vp)(n)}))}constructor(e,t,i){this.sharedItemsRepo=e,this.userGroupsRepo=t,this.context=i}}C=(0,s.gn)([(0,l.e)(b.$),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===w.z?Object:w.z,void 0===A.x?Object:A.x,void 0===d.f?Object:d.f])],C);var R=i(90735),_=i(78631);class O{}O=(0,s.gn)([(0,r.Y)({api:n.m,providers:[S],handlers:{commands:{},events:{},queries:{getSharingUsers:f,getSharingGroupsWithItemCount:C}},domainName:"sharing",imports:[R.u,_.F]})],O)},44145:function(e,t,i){i.d(t,{G:()=>s});class s{}},77261:function(e,t,i){i.d(t,{a:()=>e7});var s=i(21636),r=i(48035),n=i(59064),a=i(4843),o=i(87253),c=i(94190);class d{}var l=i(53800),u=i(61028),p=i(15255);class h{async createCollection(e,t,i,s,r){let n=await this.sharingCrypto.createResourceKey(),a={resourceKey:n,uuid:e},o=await this.sharingUsers.createSignedUserInvites(s,a),c=r.length>0?await this.sharingUserGroups.createSignedUserGroupInvites(r,a):void 0,{publicKey:d,privateKey:l}=await this.sharingCrypto.createRecipientKeyPair(n);return this.sharingCollectionsGateway.createCollection({collectionId:e,collectionName:i,publicKey:d,privateKey:l,users:o,userGroups:c,teamId:Number(t)})}async renameCollection(e,t){let{revision:i,id:s}=e;await this.sharingCollectionsGateway.renameCollection({collectionId:s,revision:i,updatedName:t})}async inviteCollectionMembers(e,t,i,s,r){let n=s.length?this.sharingUsers.createSignedUserInvites(s,{resourceKey:i,uuid:e},!1):void 0,a=r.length?this.sharingUserGroups.createSignedUserGroupInvites(r,{resourceKey:i,uuid:e}):void 0,[o,c]=await Promise.all([n,a]);return await this.sharingCollectionsGateway.inviteCollectionMembers({revision:t,collectionId:e,users:o,userGroups:c})}async updateCollectionMembers(e,t,i){let{revision:s,id:r}=e;return await this.sharingCollectionsGateway.updateCollectionMembers({revision:s,collectionId:r,users:t,userGroups:i})}constructor(e,t,i,s){this.sharingCollectionsGateway=e,this.sharingCrypto=t,this.sharingUserGroups=i,this.sharingUsers=s}}h=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[d,void 0===l.M?Object:l.M,void 0===u.o?Object:u.o,void 0===p.E?Object:p.E])],h);var g=i(44577),m=i(306),v=i(50326),y=i(4274),w=i(49499),S=i(72094),f=i(97702),E=i(91012),I=i(37937),b=i(57178),A=i(47244),C=i(83463),R=i(70600),_=i(28107),O=i(59283);class T{async getDomainForCredential(e){let t=await (0,g.z)(this.vaultItemsCrudClient.queries.query({vaultItemTypes:[b.U.Credential],ids:[e]}));if((0,m.hx)(t))throw Error("Unable to find selected item");let i=t.data.credentialsResult.items[0];return new C.Y(i.URL).getRootDomain()}async createCollectionInvites(e,t,i){let s=await Promise.all(t.map(async t=>{let s=await this.sharingCryptoUtility.decryptItemGroupKey(t);if(null===s)throw Error("Unable to decrypt item group key");let r=await this.sharingCryptoUtility.decryptSharedCollectionKeyForCurrentUser(e);if(!r)throw Error("Unable to decrypt collection key");let n=await this.sharingCryptoElements.decryptSecureData(r,(0,f.R)(e.privateKey)),{proposeSignature:a,acceptSignature:o,resourceKey:c}=await this.sharingInvitesCrypto.createSignedInvite(e.id,{resourceKey:s,uuid:t.sharedItemId},e.publicKey,(0,E.v)(n));if(!c)throw Error("Could not create resource key when generating user group invite for collection");if(!o)throw Error("should not happen");let d=await (0,g.z)(this.activityLogs.queries.areSensitiveLogsEnabled());if((0,m.hx)(d))throw Error("Unable find preferences");let l=await (0,g.z)(this.vaultItemsCrudClient.queries.query({vaultItemTypes:[b.U.Credential,b.U.SecureNote],ids:[t.itemId]}));if((0,m.hx)(l))throw Error("Unable to find selected item");let u=l.data.credentialsResult.items.length?{captureLog:!0,domain:await this.getDomainForCredential(t.itemId),type:(0,R.j)(y.y2.Credential)}:{captureLog:!0,type:(0,R.j)(y.y2.SecureNote),domain:void 0};return{id:t.sharedItemId,permission:i,resourceKey:c,proposeSignature:a,acceptSignature:o,auditLogDetails:u}}));return{collectionId:e.id,revision:e.revision,itemGroups:s}}constructor(e,t,i,s,r){this.sharingInvitesCrypto=e,this.sharingCryptoElements=t,this.sharingCryptoUtility=i,this.vaultItemsCrudClient=s,this.activityLogs=r}}T=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===_.f?Object:_.f,void 0===l.M?Object:l.M,void 0===O.Z?Object:O.Z,void 0===A.L?Object:A.L,void 0===I._?Object:I._])],T);var F=i(32616),D=i(62434);class U{async addItemsToCollections(e,t,i){let s=await (0,g.z)(this.sharingItemsClient.queries.getSharedItemsForItemIds({itemIds:t}));if((0,m.hx)(s))throw Error("Unable to find item groups for items");let r=(0,m.db)(s).sharedItems;if(!r.every(e=>"full"===e.sharingPermissionLevel))throw Error("User does not have access to share selected items");let n=await this.credentialsGetter.getCarbonCredentialsByItemIds(t),a=await this.notesGetter.getCarbonNotesByItemIds(t),o=[...n,...a];if(a.some(e=>e.Attachments?.length))return(0,m.Rn)((0,v.LG)());let c=[...o.filter(({Id:e})=>!r.some(t=>t.itemId===e))],d=c.length>0?await this.sharingItemGroups.createMultipleItemGroups(c):[];return await Promise.all(e.map(async e=>{let t=await this.collectionInvitesService.createCollectionInvites(e,[...r,...d],i.find(t=>t.collectionId===e.id)?.permission??y.y3.Admin);await this.sharingCollectionsApi.addItemGroupsToCollection(t)})),(0,m.Vp)(void 0)}constructor(e,t,i,s,r,n){this.collectionInvitesService=e,this.sharingItemGroups=t,this.sharingCollectionsApi=i,this.credentialsGetter=s,this.notesGetter=r,this.sharingItemsClient=n}}U=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===T?Object:T,void 0===F.k?Object:F.k,d,void 0===D.J?Object:D.J,void 0===S.H?Object:S.H,void 0===w.s?Object:w.s])],U);var P=i(37368),x=i(16098);function N(e){return void 0!==e}var L=i(44145),k=i(1349);class j{async execute({body:e}){let{collectionPermissions:t,itemIds:i,shouldSkipSync:s}=e,r=await this.collectionsRepository.getCollectionsById(t.map(({collectionId:e})=>e)),n=await this.sharingCollectionItems.addItemsToCollections(r.filter(N),i,t);if((0,m.hx)(n))throw Error("Failed adding an item to a list of collections");return s||await this.sharingSync.scheduleSync(),(0,m.Vp)(void 0)}constructor(e,t,i){this.sharingCollectionItems=e,this.sharingSync=t,this.collectionsRepository=i}}j=(0,s.gn)([(0,P.W)(x.k),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===U?Object:U,void 0===k.D?Object:k.D,void 0===L.G?Object:L.G])],j);var G=i(59242);let V=e=>e.map(({id:e,resourceKey:t,proposeSignature:i,proposeSignatureUsingAlias:s,acceptSignature:r,alias:n,permission:a})=>({login:e,collectionKey:t,proposeSignature:i,proposeSignatureUsingAlias:s,acceptSignature:r,alias:n,permission:a})),M=e=>e.map(({id:e,resourceKey:t,proposeSignature:i,acceptSignature:s,permission:r})=>({groupUUID:e,collectionKey:t,proposeSignature:i,acceptSignature:s,permission:r})),K=e=>{let{collectionId:t,collectionName:i,users:s,userGroups:r,publicKey:n,privateKey:a,teamId:o}=e;return{collectionUUID:t,collectionName:i,publicKey:n,privateKey:a,teamId:o,users:V(s),userGroups:r?M(r):void 0}};class W{async createCollection(e){let t=await (0,g.z)(this.serverApiClient.v1.sharingUserdevice.createCollection(K(e)));if((0,m.hx)(t))throw Error("Failed to create shared collection from private one");let i=m.db(t).data.collections?.find(t=>t.uuid===e.collectionId);if(!i)throw Error("Unable to find collection");return i}async renameCollection(e){let{collectionId:t,revision:i,updatedName:s}=e,r=await (0,g.z)(this.serverApiClient.v1.sharingUserdevice.renameCollection({collectionUUID:t,revision:i,updatedName:s}));if((0,m.hx)(r))throw Error("Failed to rename shared collection")}async addItemGroupsToCollection(e){let t=[];for(let i=0;i<e.itemGroups.length;i+=100)t.push(e.itemGroups.slice(i,i+100));let i=e.revision;for(let s of t){let t=await this.activityLogsClient.commands.encryptAuditLogDetailsBatch({auditLogDetailsItems:s.map(e=>(0,R.O)(e.id,e.auditLogDetails))});if((0,m.hx)(t))throw Error(y.qn.AuditLogDetailsEncryptErrorMsg);let r=await (0,g.z)(this.serverApiClient.v1.sharingUserdevice.addItemGroupsToCollection({collectionUUID:e.collectionId,itemGroups:s.map(({id:e,proposeSignature:i,acceptSignature:s,permission:r,resourceKey:n,auditLogDetails:a})=>{let o=m.db(t)?.[e];return{uuid:e,proposeSignature:i,acceptSignature:s,permission:r,itemGroupKey:n,auditLogDetails:o||a}}),revision:i}));if((0,m.hx)(r))throw Error("Failed to add items to collection",{cause:r.error});let n=(0,m.db)(r).data;if(!n.collections?.length)throw Error("Failed to add items to collection");i=n.collections[0].revision}}async deleteCollection(e,t){let i=await (0,g.z)(this.serverApiClient.v1.sharingUserdevice.deleteCollection({collectionUUID:e,revision:t}));if((0,m.hx)(i))throw Error("Failed to delete shared collection")}async inviteCollectionMembers({collectionId:e,revision:t,users:i,userGroups:s}){let r={collectionUUID:e,revision:t,users:i?V(i):void 0,userGroups:s?M(s):void 0},n=this.serverApiClient.v1.sharingUserdevice.inviteCollectionMembers(r),a=await (0,g.z)(n);if((0,m.hx)(a)||!a.data.data.collections)throw Error("Failed to add members to collection");return a.data.data.collections[0]}async updateCollectionMembers({collectionId:e,revision:t,users:i,userGroups:s}){let r={collectionUUID:e,revision:t,users:i,userGroups:s?.map(({groupId:e,permission:t})=>({groupUUID:e,permission:t}))},n=this.serverApiClient.v1.sharingUserdevice.updateCollectionMembers(r),a=await (0,g.z)(n);if((0,m.hx)(a)||!a.data.data.collections)throw Error("Failed to update collection members");return a.data.data.collections[0]}async revokeCollectionMembers({collectionId:e,revision:t,userGroupIds:i,userLogins:s}){let r=this.serverApiClient.v1.sharingUserdevice.revokeCollectionMembers({collectionUUID:e,revision:t,userLogins:s,userGroupUUIDs:i}),n=await (0,g.z)(r);if((0,m.hx)(n)||!n.data.data.collections)throw Error("Failed to revoke access to collection");return n.data.data.collections[0]}async removeItemGroupsFromCollection(e,t){let i=await (0,g.z)(this.serverApiClient.v1.sharingUserdevice.removeItemGroupsFromCollection({collectionUUID:e.id,itemGroupUUIDs:t,revision:e.revision}));if((0,m.hx)(i))throw Error("Failure to remove items from collection")}async removeItemGroupCollectionAccess(e){let{collectionId:t,itemGroupId:i,itemGroupRevision:s,auditLogDetails:r}=e,n=await this.activityLogsClient.commands.encryptAuditLogDetailsBatch({auditLogDetailsItems:[(0,R.O)(i,r)]});if((0,m.hx)(n))throw Error(y.qn.AuditLogDetailsEncryptErrorMsg);let a=m.db(n)?.[i],o=await (0,g.z)(this.serverApiClient.v1.sharingUserdevice.revokeItemGroupMembers({revision:s,groupId:i,collections:[t],auditLogDetails:a||r}));if((0,m.hx)(o))throw Error("Failure to remove collection member from an item group",{cause:o.error})}constructor(e,t){this.serverApiClient=e,this.activityLogsClient=t}}W=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===G.l?Object:G.l,void 0===I._?Object:I._])],W);var z=i(92684),q=i(38392);let B=e=>e===q.Yt.Manager?y.y3.Admin:y.y3.Limited,Y=e=>({login:e.login,permission:B(e.role)}),Q=e=>({groupId:e.groupId,permission:B(e.role)});class H{async execute({body:e}){let{collectionId:t,userRecipients:i,userGroupRecipients:s}=e,r=await this.collectionsRepository.getCollectionById(t);if(!r)throw Error("Collection not found");return await this.sharingCollectionsService.updateCollectionMembers(r,i?.map(Y),s?.map(Q)),await this.sharingSync.scheduleSync(),(0,m.Vp)(void 0)}constructor(e,t,i){this.sharingCollectionsService=e,this.collectionsRepository=t,this.sharingSync=i}}H=(0,s.gn)([(0,P.W)(z.c),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h?Object:h,void 0===L.G?Object:L.G,void 0===k.D?Object:k.D])],H);var $=i(21958),X=i(42589),Z=i(69853),J=i(17741),ee=i(19425),et=i(59982),ei=i(68238),es=i(18550),er=i(20458),en=i(15021);let ea=e=>q.T_.safeParse(e).success;class eo extends(0,et.Q)({persist:!0,scope:en.F.User,storeName:"collections-store",storeTypeGuard:ea,storage:{initialValue:{collections:(0,es.Ay)({}),sharedCollectionsAccess:(0,es.Ay)({})},typeGuard:ea,schemaVersion:4,migrateStorageSchema:()=>({collections:{},sharedCollectionsAccess:{}})},capacity:ei.Y.Unlimited,codec:er.E,isCache:!0}){}class ec{getUserRoleInCollection$(e,t,i){let s=t||i;if(!s)throw Error("No target user to get role in collection");return this?.userGroupsRepository.acceptedUserGroupIdsForLogin$(s).pipe($.V(this.store.state$),X.U(([t,i])=>{let{sharedCollectionsAccess:r}=i,n=r[e];if(!n)throw Error("Shared collection not found");let a=n.users.find(e=>e.name===s),o=a?.sharedCollectionRole===q.Yt.Manager&&a.status===y.qb.Accepted,c=n.userGroups.filter(e=>t.includes(e.id)).some(e=>e.sharedCollectionRole===q.Yt.Manager);return o||c?q.Yt.Manager:q.Yt.Editor}))}getGroupRoleInCollection$(e,t){return this.collectionsRepository.sharedCollectionsAccessForId$(e).pipe((0,X.U)(e=>{if(!e)throw Error("Shared collection not found when user group role");let i=e.userGroups.find(e=>e.id===t);return i?.sharedCollectionRole?i.sharedCollectionRole:q.Yt.Editor}))}canShareItems(e){return 0===e.length?(0,Z.of)((0,m.Vp)(!0)):this.sharingItemsClient.queries.getSharedItemsForItemIds({itemIds:e}).pipe((0,J.Qn)(e=>e.sharedItems.every(e=>"full"===e.sharingPermissionLevel)))}constructor(e,t,i,s){this.collectionsRepository=e,this.userGroupsRepository=t,this.sharingItemsClient=i,this.store=s}}ec=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L.G?Object:L.G,void 0===ee.x?Object:ee.x,void 0===w.s?Object:w.s,eo])],ec);var ed=i(3750),el=i(62506),eu=i(85786);class ep{execute(){let e=this.getCurrentUserLogin();return this.collectionsRepository.acceptedCollections$().pipe((0,X.U)(t=>{let i=Object.values(t).filter(t=>t.authorLogin===e);return(0,m.Vp)(i.length)}))}getCurrentUserLogin(){return this.context.get(ed.l.UserName)}constructor(e,t){this.collectionsRepository=e,this.context=t}}ep=(0,s.gn)([(0,el.e)(eu.C),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L.G?Object:L.G,void 0===ed.f?Object:ed.f])],ep);var eh=i(48274),eg=i(51623);class em{async execute({body:e}){let{collection:t,itemId:i}=e,s=await (0,g.z)(this.sharingItemsClient.queries.getSharedItemForId({itemId:i}));if((0,m.hx)(s)||!s.data.sharedItem)throw Error("Item group to be removed from collection cannot be found");let{sharedItemId:r,revision:n}=s.data.sharedItem;return await this.sharingCommon.updateItemGroupMembers({groupId:r,collections:[{collectionUUID:t.collectionId,permission:t.permission}],revision:n}),await this.sharingSync.scheduleSync(),(0,m.Vp)(void 0)}constructor(e,t,i){this.sharingCommon=e,this.sharingSync=t,this.sharingItemsClient=i}}em=(0,s.gn)([(0,P.W)(eh.a),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eg.b_?Object:eg.b_,void 0===k.D?Object:k.D,void 0===w.s?Object:w.s])],em);class ev{async getCollections(){let{collections:e}=await this.store.getState();return e}acceptedCollections$(){return this.store.state$.pipe((0,X.U)(({collections:e})=>Object.fromEntries(Object.entries(e).filter(([,e])=>e.isAccepted))))}async getCollectionsById(e){let{collections:t}=await this.store.getState();return e.reduce((e,i)=>(t[i]&&e.push(t[i]),e),[])}async getAcceptedCollections(){return Object.values(await this.getCollections()).filter(e=>e.isAccepted)}async getCollectionById(e){let{collections:t}=await this.store.getState();return t[e]}async setCollections(e,t){let i=await this.store.getState();await this.store.set(e.reduce((e,s)=>(e.collections[s.id]=s,e.sharedCollectionsAccess[s.id]=t[s.id]??i.sharedCollectionsAccess[s.id],e),{collections:{},sharedCollectionsAccess:{}}))}sharedCollectionsAccess$(){return this.store.state$.pipe((0,X.U)(({sharedCollectionsAccess:e})=>e))}sharedCollectionsAccessForId$(e){return this.store.state$.pipe((0,X.U)(({sharedCollectionsAccess:t})=>t[e]))}constructor(e){this.store=e}}ev=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[eo])],ev);var ey=i(4495),ew=i(80323),eS=i(17231);let ef=e=>e.login,eE=e=>e.groupId,eI=e=>e.length>0?e.map(ef):void 0,eb=e=>e.length>0?e.map(eE):void 0;class eA{async execute({body:e}){let{teamId:t,collectionName:i,privateCollectionId:s,users:r,groups:n,defaultItemPermissions:a,itemIds:o}=e,c=(0,ew.R)(),d=await this.sharingCollections.createCollection(c,t,i,r.map(Y),n.map(Q));if(o.length>0)try{let e=this.getCurrentUserLogin();if(!e)throw Error("No loged in user available when adding items to collections");let t=await this.sharingCollectionItems.addItemsToCollections([(0,eS.E)(d,[],e)],o,[{collectionId:c,permission:a}]);if((0,m.hx)(t))throw Error(t.error.tag)}catch(t){let e=await this.sharingCollectionsGateway.revokeCollectionMembers({collectionId:d.uuid,revision:d.revision,userGroupIds:eb(n),userLogins:eI(r)});if(await this.sharingCollectionsGateway.deleteCollection(e.uuid,e.revision),await this.sharingSync.scheduleSync(),t instanceof Error&&t.message===v.Pf)return(0,m.Rn)((0,v.LG)());throw t}let{commands:l}=this.vaultClient;return s?await l.deleteCollection({id:s}):await this.sharingSync.scheduleSync(),(0,m.Vp)(void 0)}getCurrentUserLogin(){return this.context.get(ed.l.UserName)}constructor(e,t,i,s,r,n){this.sharingCollections=e,this.sharingCollectionsGateway=t,this.sharingCollectionItems=i,this.vaultClient=s,this.sharingSync=r,this.context=n}}eA=(0,s.gn)([(0,P.W)(v.I4),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h?Object:h,d,void 0===U?Object:U,void 0===ey.C?Object:ey.C,void 0===k.D?Object:k.D,void 0===ed.f?Object:ed.f])],eA);var eC=i(52037);class eR{async execute({body:e}){let{id:t}=e,i=await this.collectionsRepository.getCollectionById(t);if(!i)throw Error("Cannot find collection to delete");return await this.sharingCollectionsApi.deleteCollection(i.id,i.revision),await this.sharingSync.scheduleSync(),(0,m.Vp)(void 0)}constructor(e,t,i){this.sharingSync=e,this.collectionsRepository=t,this.sharingCollectionsApi=i}}eR=(0,s.gn)([(0,P.W)(eC.U),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===k.D?Object:k.D,void 0===L.G?Object:L.G,d])],eR);var e_=i(60715),eO=i(95255);class eT{async execute({body:e}){let{collectionId:t,userRecipients:i,userGroupRecipients:s}=e,{sharedCollectionsAccess:r,collections:n}=await this.store.getState(),a=n[t],o=r[t];if(!a||!o)throw Error(`Collection ${t} not found when inviting collection member`);let{revision:c,id:d}=a,l=await this.currentUserGetter.getCurrentUserWithKeys(),u=await this.sharingCrypto.decryptSharedCollectionKey(a,l);if(!u)throw Error("Cannot decrypt collection key.");let p=i?.map(Y),h=s?.map(Q);return await this.sharingCollectionsService.inviteCollectionMembers(d,c,u,p||[],h||[]),await this.syncService.scheduleSync(),(0,m.Vp)(void 0)}constructor(e,t,i,s,r){this.sharingCollectionsService=e,this.store=t,this.currentUserGetter=i,this.sharingCrypto=s,this.syncService=r}}eT=(0,s.gn)([(0,P.W)(e_.Q),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h?Object:h,eo,void 0===eO.a?Object:eO.a,void 0===O.Z?Object:O.Z,void 0===k.D?Object:k.D])],eT);var eF=i(90337),eD=i(63948);class eU{async removeItemToCollection(e,t){let i=await (0,g.z)(this.sharingItemsClient.queries.getSharedItemForId({itemId:e}));if((0,m.hx)(i)||!i.data.sharedItem)throw Error("Item group to be removed from collection cannot be found");let{sharedItemId:s,revision:r}=i.data.sharedItem,n=await this.sharingAuditLog.prepareSharedItemAuditLogDetails(e);await this.sharingCollectionsGateway.removeItemGroupCollectionAccess({collectionId:t,itemGroupId:s,itemGroupRevision:r,auditLogDetails:n})}async execute({body:e}){let{collectionIds:t,itemId:i}=e;for(let e of t)await this.removeItemToCollection(i,e);return await this.sharingSync.scheduleSync(),(0,m.Vp)(void 0)}constructor(e,t,i,s){this.sharingCollectionsGateway=e,this.sharingSync=t,this.sharingItemsClient=i,this.sharingAuditLog=s}}eU=(0,s.gn)([(0,P.W)(eF.B),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[d,void 0===k.D?Object:k.D,void 0===w.s?Object:w.s,void 0===eD.a?Object:eD.a])],eU);var eP=i(25426);class ex{async execute({body:e}){let{collectionId:t,newName:i}=e,s=await this.collectionsRepository.getCollectionById(t);if(!s)throw Error("Failed to find collection revision");return await this.sharingCollections.renameCollection(s,i),await this.sharingSync.scheduleSync(),(0,m.Vp)(void 0)}constructor(e,t,i){this.sharingCollections=e,this.collectionsRepository=t,this.sharingSync=i}}ex=(0,s.gn)([(0,P.W)(eP.r),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h?Object:h,void 0===L.G?Object:L.G,void 0===k.D?Object:k.D])],ex);var eN=i(81923);class eL{async execute({body:e}){let{collectionId:t,userGroupIds:i,userLogins:s}=e,r=await this.collectionsRepository.getCollectionById(t);if(!r)throw Error("Cannot access the requested collection.");let{revision:n}=r;return await this.sharingCollectionsGateway.revokeCollectionMembers({collectionId:t,revision:n,userGroupIds:i,userLogins:s}),await this.sharingSync.scheduleSync(),(0,m.Vp)(void 0)}constructor(e,t,i){this.collectionsRepository=e,this.sharingCollectionsGateway=t,this.sharingSync=i}}eL=(0,s.gn)([(0,P.W)(eN.q),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L.G?Object:L.G,d,void 0===k.D?Object:k.D])],eL);var ek=i(72907),ej=i(81433),eG=i(45991),eV=i(53110),eM=i(79791);class eK{isCollectionsSharingEnabled(e){return e.isSharingEnabled&&e.isCollectionsSharingEnabled}execute({body:e}){let{collectionId:t,userId:i}=e,{queries:{queryCollections:s}}=this.vaultOrganization;return s({ids:[t]}).pipe((0,$.V)(this.currentSpace.get()),(0,ek.w)(([e,s])=>{if((0,m.hx)(e))throw Error("Error accessing private collections");if((0,m.hx)(s))throw Error("Error accessing current space info");let r=this.isCollectionsSharingEnabled((0,m.db)(s)),n=(0,m.db)(e).collections.find(({id:e})=>e===t);if(n)return this.getPermissionsForPrivateCollection(n,r);let a=this.context.get(ed.l.UserName);return this.sharingAccess.getUserRoleInCollection$(t,i,a).pipe((0,X.U)(e=>{let t=e===q.Yt.Manager;return{canShare:r&&t,canEditRoles:t,canEdit:t,canDelete:t,role:e,sharingDisabledReason:r?q.Hz.EditorRole:q.Hz.DisabledInTAC}}),(0,ej.x)(eG.shallowEqualObjects),(0,X.U)(m.Vp))}))}getPermissionsForPrivateCollection(e,t){if(!t)return(0,Z.of)((0,m.Vp)({canShare:!1,canEditRoles:!0,canEdit:!0,canDelete:!0,role:q.Yt.Manager,sharingDisabledReason:q.Hz.DisabledInTAC}));let i=e.vaultItems.map(({id:e})=>e);return this.sharingAccess.canShareItems(i).pipe((0,X.U)(e=>{if((0,m.hx)(e))throw Error("Error checking if user can share a collection");let t=(0,m.db)(e);return{canShare:t,canEditRoles:!0,canEdit:!0,canDelete:!0,role:q.Yt.Manager,sharingDisabledReason:t?void 0:q.Hz.LimitedRightItems}}),(0,ej.x)(eG.shallowEqualObjects),(0,X.U)(m.Vp))}constructor(e,t,i,s){this.sharingAccess=e,this.vaultOrganization=t,this.currentSpace=i,this.context=s}}eK=(0,s.gn)([(0,el.e)(eV.y),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===ec?Object:ec,void 0===ey.C?Object:ey.C,void 0===eM.n?Object:eM.n,void 0===ed.f?Object:ed.f])],eK);var eW=i(33575);class ez{execute({body:e}){let{collectionId:t,groupId:i}=e;return this.sharingAccess.getGroupRoleInCollection$(t,i).pipe((0,X.U)(e=>(0,m.Vp)(e)))}constructor(e){this.sharingAccess=e}}ez=(0,s.gn)([(0,el.e)(eW.L),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===ec?Object:ec])],ez);var eq=i(75247);class eB{execute({body:e}){let{targetId:t}=e;return this.userGroupsRepository.acceptedUserGroupIdsForLogin$(t).pipe((0,$.V)(this.store.state$),(0,X.U)(([e,i])=>{let s=[],{collections:r,sharedCollectionsAccess:n}=i;for(let i in n)if(n[i]&&(n[i].users.some(e=>e.name===t)||n[i].userGroups.some(e=>e.id===t)||n[i].userGroups.some(t=>e.includes(t.id)))){s.push(r[i]);continue}return(0,m.Vp)({collections:s})}))}constructor(e,t){this.userGroupsRepository=e,this.store=t}}eB=(0,s.gn)([(0,el.e)(eq.Q),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===ee.x?Object:ee.x,eo])],eB);var eY=i(72967),eQ=i(48202);let eH=e=>{if(!e.itemId||!e.sharedItemId)throw Error("Corrupted item group");return{id:e.itemId,type:b.U.Credential}},e$=(e,t,i)=>({name:e.name,id:e.id,spaceId:i,isShared:!0,vaultItems:t.filter(t=>t.recipientIds.collectionIds?.some(t=>t===e.id)).map(eH)}),eX=(e,t,i)=>{let s=e$(e,t,i);if(eQ.JQ.safeParse(s).success)return s;throw Error("Failure to convert shared collection")};class eZ{execute({body:e}){let{itemIds:t}=e;return this.collectionsRepository.acceptedCollections$().pipe((0,$.V)(this.currentSpaceGetter.get(),this.sharingItemsClient.queries.getSharedItemsForItemIds({itemIds:t})),(0,X.U)(([e,i,s])=>{if((0,m.hx)(i)||(0,m.hx)(s))throw Error("Unable to access sharing data");let r=s.data.sharedItems,n=Object.values(e).map(e=>eX(e,r,i.data.teamId)).flatMap(e=>e.vaultItems),a=t.filter(e=>n.some(t=>t.id===e));return(0,m.Vp)(a)}))}constructor(e,t,i){this.currentSpaceGetter=e,this.collectionsRepository=t,this.sharingItemsClient=i}}eZ=(0,s.gn)([(0,el.e)(eY.q),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===eM.n?Object:eM.n,void 0===L.G?Object:L.G,void 0===w.s?Object:w.s])],eZ);var eJ=i(51560);class e0{execute({body:e}){let t=e.collectionIds?e.collectionIds:[];return this.collectionsRepository.acceptedCollections$().pipe((0,X.U)(e=>(0,m.Vp)(Object.values(e).filter(e=>!t.length||t.includes(e.id)))))}constructor(e){this.collectionsRepository=e}}e0=(0,s.gn)([(0,el.e)(eJ.$),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L.G?Object:L.G])],e0);class e6{execute(){return this.collectionsRepository.acceptedCollections$().pipe((0,$.V)(this.currentSpaceGetter.get(),this.sharingItemsClient.queries.getSharedItems()),(0,X.U)(([e,t,i])=>{if((0,m.hx)(t))throw Error("Failed to load shared collections");if((0,m.hx)(i))throw Error("Failed to load shared items data");return(0,m.Vp)(Object.values(e).map(e=>eX(e,i.data.sharedItems,t.data.teamId)))}))}constructor(e,t,i){this.collectionsRepository=e,this.currentSpaceGetter=t,this.sharingItemsClient=i}}e6=(0,s.gn)([(0,el.e)(eQ.MO),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L.G?Object:L.G,void 0===eM.n?Object:eM.n,void 0===w.s?Object:w.s])],e6);var e1=i(72322);class e2{execute({body:e}){let{collectionIds:t}=e;return this.collectionsRepository.sharedCollectionsAccess$().pipe((0,X.U)(e=>{let i=t.flatMap(t=>{let i=e[t];return i?i.users.map(e=>({id:e.name,label:e.name,status:e.status??y.qb.Pending,sharedCollectionRole:e.sharedCollectionRole})):[]}),s=t.flatMap(t=>{let i=e[t];return i?i.userGroups.map(e=>({id:e.id,label:e.name,status:e.status??y.qb.Pending,sharedCollectionRole:e.sharedCollectionRole})):[]});return(0,m.Vp)({userGroups:s,users:i})}))}constructor(e){this.collectionsRepository=e}}e2=(0,s.gn)([(0,el.e)(e1.O),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===L.G?Object:L.G])],e2);var e4=i(36159),e5=i(71318),e9=i(89005),e3=i(90735);class e7{}e7=(0,s.gn)([(0,r.Y)({api:n.a,stores:[eo],providers:[h,T,ec,U,{provide:d,useClass:W},{provide:L.G,useClass:ev}],exports:[L.G],handlers:{commands:{addItemsToCollections:j,createSharedCollection:eA,deleteSharedCollection:eR,inviteCollectionMembers:eT,updateCollectionMembers:H,removeItemFromCollections:eU,renameCollection:ex,revokeCollectionMembers:eL,updatePermissionForCollectionItem:em},events:{},queries:{getCollectionPermissionsForUser:eK,getCollectionRoleForGroup:ez,getCollectionsForUserOrGroup:eB,getItemIdsInSharedCollections:eZ,getSharedCollectionsCount:ep,getSharedCollections:e0,sharedCollectionsWithItems:e6,usersAndGroupsInCollection:e2}},imports:[a.n,o.D,e5.k,e4.I,e9.y,e3.u],requiredFeatureFlips:["sharing_web_invalidSignatureAutoRevoke_prod","monetization_extension_starterRepackagingCollection","sharing_Web_GranularPermissions_dev"]})],e7)},75646:function(e,t,i){i.d(t,{x:()=>s});let s=async(e,t,i=5,s=10)=>{let r=e.length>=20?Math.ceil(e.length/s):i,n=[];for(let t=0;t<e.length;t+=r)n.push(e.slice(t,t+r));return Promise.all(n.map(e=>t(e)))}},70600:function(e,t,i){i.d(t,{O:()=>n,j:()=>r});var s=i(4274);let r=e=>{switch(e){case s.y2.Credential:return"AUTHENTIFIANT";case s.y2.Secret:return"SECRET";default:return"SECURENOTE"}},n=(e,t,i="domain")=>{let s=t?.[i];if(!s)return;let r={...t};return delete r[i],{batchItemToEncrypt:{id:e,detailsToEncrypt:[{key:i,value:s}]},securedAuditLogDetails:r}}},36159:function(e,t,i){i.d(t,{I:()=>D});var s=i(21636),r=i(48035),n=i(44577),a=i(94190),o=i(59242),c=i(306),d=i(17741),l=i(18550),u=i(37937),p=i(4274);let h=/[<>]/g,g=e=>e.trim().toLowerCase().replace(h,"");var m=i(44948);function v(e,t){let i=(0,m.B5)(e),s=t||`Untitled ${i}`;return{type:i,name:s}}let y=e=>e.map(({id:e,resourceKey:t,proposeSignature:i,proposeSignatureUsingAlias:s,acceptSignature:r,alias:n,permission:a})=>({userId:e,groupKey:t,proposeSignature:i,proposeSignatureUsingAlias:s,acceptSignature:r,alias:n,permission:a}));var w=i(51623),S=i(75646),f=i(70600);class E{async encryptAuditLogDetails(e,t){let i=await this.activityLogsClient.commands.encryptAuditLogDetailsBatch({auditLogDetailsItems:[(0,f.O)(t,e)]});return(0,c.hx)(i)?i:(0,c.Vp)(c.db(i)?.[t])}async getPublicKeysForUsers(e){let t=await (0,n.z)(this.serverApiClient.v1.sharingUserdevice.getUsersPublicKey({logins:e}).pipe((0,d.DZ)(()=>{throw Error("Cannot get public keys of requested users.")}),(0,d.lk)(e=>(0,c.Vp)(e.data))));if((0,c.hx)(t))throw Error("Cannot get public keys of requested users.");return t.data.data.map(e=>({login:e.login??g(e.email),publicKey:e.publicKey}))}async createItemGroup({users:e,item:t,itemTitle:i,groupId:s,auditLogDetails:r}){let a=await this.encryptAuditLogDetails(r,s);if((0,c.hx)(a))throw Error(p.qn.AuditLogDetailsEncryptErrorMsg);let o=(0,c.db)(a),d=await (0,n.z)(this.serverApiClient.v1.sharingUserdevice.createItemGroup({groupId:s,items:[t],users:y(e),itemsForEmailing:[v(t.itemType,i)],auditLogDetails:o||r}));if((0,c.hx)(d))throw Error("Failed to create item group");let l=c.db(d).data.itemGroups?.find(e=>e.groupId===s);if(!l)throw Error("Error creating item group");return l}async createMultipleItemGroups(e){let t=await this.activityLogsClient.commands.encryptAuditLogDetailsBatch({auditLogDetailsItems:e.map(e=>(0,f.O)(e.groupId,e.auditLogDetails))});if((0,c.hx)(t))throw Error(p.qn.AuditLogDetailsEncryptErrorMsg);let i=(await (0,S.x)(e,async e=>{let i=e.map(({users:e,item:i,itemTitle:s,groupId:r,auditLogDetails:n})=>{let a=c.db(t)?.[r];return{groupId:r,items:[i],users:y(e),itemsForEmailing:[v(i.itemType,s)],auditLogDetails:a||n}}),s=await (0,n.z)(this.serverApiClient.v1.sharingUserdevice.createMultipleItemGroups({itemgroups:i}));if((0,c.hx)(s))throw Error("Failed to create item groups.");return(0,c.db)(s)})).reduce((e,t)=>({itemGroups:e.itemGroups.concat(t.data.itemGroups??[]),itemGroupErrors:e.itemGroupErrors.concat(t.data.itemGroupErrors??[])}),(0,l.Ay)({itemGroups:[],itemGroupErrors:[]}));if(i.itemGroupErrors.length)throw Error("Failed to create some of multiple item groups",{cause:{itemGroupErrors:i.itemGroupErrors}});if(!i.itemGroups.length)throw Error("No item groups have been created",{cause:{itemGroupErrors:i.itemGroupErrors}});return i.itemGroups}async updateItemGroupMembers(e){let{groupId:t,revision:i,users:s,groups:r,collections:a}=e,o=await (0,n.z)(this.serverApiClient.v1.sharingUserdevice.updateItemGroupMembers({groupId:t,revision:i,collections:a,groups:r,users:s}));if((0,c.hx)(o)){if("BusinessError"===o.error.tag&&o.error.code===w.wI)return(0,c.Rn)((0,w.ge)());throw Error("Updating members of item groups have failed")}let d=(0,c.db)(o).data;return(0,c.Vp)(d.itemGroups)}async revokeItemGroupMembers(e){let{itemGroupId:t,revision:i,userLogins:s,collectionIds:r,userGroupIds:a,auditLogDetails:o}=e,d=await this.encryptAuditLogDetails(o,t);if((0,c.hx)(d))throw Error(p.qn.AuditLogDetailsEncryptErrorMsg);let l=(0,c.db)(d),u=await (0,n.z)(this.serverApiClient.v1.sharingUserdevice.revokeItemGroupMembers({groupId:t,revision:i,collections:r,users:s,groups:a,auditLogDetails:l||o}));if((0,c.hx)(u)){if("BusinessError"===u.error.tag&&u.error.code===w.wI)return(0,c.Rn)((0,w.ge)());throw Error("Revoking members of item groups have failed")}let h=(0,c.db)(u).data;return(0,c.Vp)(h.itemGroups)}async refuseItemGroup(e){let{itemGroupId:t,revision:i,auditLogDetails:s}=e,r=await this.encryptAuditLogDetails(s,t);if((0,c.hx)(r))throw Error(p.qn.AuditLogDetailsEncryptErrorMsg);let a=(0,c.db)(r),o=await (0,n.z)(this.serverApiClient.v1.sharingUserdevice.refuseItemGroup({groupId:t,revision:i,auditLogDetails:a||s}));if((0,c.hx)(o))throw Error("Refusing item group have failed");let d=(0,c.db)(o).data;if(!d.itemGroups?.length)throw Error("No members of item groups have been revoked");if(d.itemGroupErrors?.length)throw Error("Revoking of some members of item groups failed");return d.itemGroups}async deleteItemGroup(e){let{groupId:t,revision:i}=e,s=await (0,n.z)(this.serverApiClient.v1.sharingUserdevice.deleteItemGroup({groupId:t,revision:i}));if((0,c.hx)(s))throw Error("Failed to delete item group");return(0,c.Vp)(void 0)}constructor(e,t){this.serverApiClient=e,this.activityLogsClient=t}}E=(0,s.gn)([(0,a.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o.l?Object:o.l,void 0===u._?Object:u._])],E);var I=i(32616),b=i(1349),A=i(61028),C=i(15255),R=i(4843),_=i(63948),O=i(90735),T=i(71318),F=i(89005);class D{}D=(0,s.gn)([(0,r.Y)({sharedModuleName:"sharing-common",providers:[I.k,b.D,A.o,C.E,_.a,{provide:w.b_,useClass:E}],exports:[_.a,I.k,b.D,A.o,C.E,w.b_],imports:[O.u,T.k,R.n,F.y]})],D)},63948:function(e,t,i){i.d(t,{a:()=>w});var s=i(21636),r=i(44577),n=i(71749),a=i(70727),o=i(49247),c=i(94190),d=i(17741),l=i(306),u=i(4274),p=i(83463),h=i(57178),g=i(47244),m=i(5041),v=i(70600),y=i(79791);class w{async createAuditLog(e){if(e.SpaceId)return await this.prepareAuditLogDetails(e)}async prepareAuditLogDetails(e){let{queries:{carbonState:t}}=this.carbonLegacyClient,i=t({path:"userSession.localSettings.premiumStatus"}).pipe((0,d.Qn)(e=>{let t=(0,m.n)(e);return t.length?t[0]:void 0})),s=await (0,r.z)(i);if((0,l.hx)(s)||!l.db(s)?.info.collectSensitiveDataAuditLogsEnabled)return;let o=(0,n.G)(e)?new p.Y(e.Url).getRootDomain():void 0;return{captureLog:!!e.SpaceId,domain:o,type:(0,n.G)(e)?(0,v.j)(u.y2.Credential):(0,a.g)(e)?(0,v.j)(u.y2.SecureNote):(0,v.j)(u.y2.Secret)}}async prepareSharedItemAuditLogDetails(e){let t=await (0,r.z)(this.currentSpaceGetter.get());if((0,l.hx)(t))throw Error("Error fetching current space when preparing shared item audit log");if(!t.data.areSensitiveLogsEnabled)return;let i=await (0,r.z)(this.vaultItemsCrudClient.queries.query({vaultItemTypes:[h.U.Credential,h.U.SecureNote,h.U.Secret],ids:[e],propertyFilters:[{property:"spaceId",value:t.data.teamId}]}));if((0,l.hx)(i))throw Error("Unable to find selected item");let s=(0,l.db)(i),n=s.credentialsResult.matchCount?s.credentialsResult.items[0]:void 0,a=s.secureNotesResult.matchCount?s.secureNotesResult.items[0]:void 0,o=s.secretsResult.matchCount?s.secretsResult.items[0]:void 0;if(!n&&!a&&!o)return;let c=n?new p.Y(n.URL).getRootDomain():"";return{captureLog:!0,domain:n?c:void 0,type:n?(0,v.j)(u.y2.Credential):a?(0,v.j)(u.y2.SecureNote):(0,v.j)(u.y2.Secret)}}constructor(e,t,i){this.carbonLegacyClient=e,this.currentSpaceGetter=t,this.vaultItemsCrudClient=i}}w=(0,s.gn)([(0,c.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o._?Object:o._,void 0===y.n?Object:y.n,void 0===g.L?Object:g.L])],w)},32616:function(e,t,i){i.d(t,{k:()=>h});var s=i(21636),r=i(94190),n=i(83267),a=i(4274),o=i(80323),c=i(53800),d=i(15255),l=i(51623),u=i(44948),p=i(63948);class h{async prepareCreateItemGroupModel(e){let t=(0,o.R)(),i=await this.sharingCrypto.createResourceKey(),s=await this.sharingUsers.createSignedUserInvites([],{resourceKey:i,uuid:t}),r=await this.sharingCrypto.createResourceKey(),a=await this.sharingCrypto.encryptSecureData(i,r),c=await this.sharingCrypto.encryptSharingItem(r,e),d=await this.sharingAuditLogs.createAuditLog(e);return{groupId:t,item:{itemId:e.Id,itemType:(0,u.l7)(e),itemKey:(0,n.s)(a),content:(0,n.s)(c)},itemTitle:e.Title,users:s,auditLogDetails:d}}convertToSharedItem(e){let t=e.items?.[0];if(!t)throw Error("Newly created item group is missing an item");let i=e.users?.[0];if(!i)throw Error("Newly created item group is missing an admin");let{itemKey:s,itemId:r}=t;if(!i.groupKey)throw Error("Newly created item group is missing a resource key");return{isLastAdmin:!0,sharedItemId:e.groupId,itemKey:s,itemId:r,accessLink:{accessType:a.Uv.User,encryptedResourceKey:i.groupKey,sharingPermissionLevel:"full"},recipientIds:{userIds:[i.userId],collectionIds:null,userGroupIds:null},sharingPermissionLevel:"full",revision:e.revision}}async createItemGroup(e){let t=await this.prepareCreateItemGroupModel(e);return this.sharingApi.createItemGroup(t)}async createMultipleItemGroups(e){let t=await Promise.all(e.map(e=>this.prepareCreateItemGroupModel(e)));return(await this.sharingApi.createMultipleItemGroups(t)).map(this.convertToSharedItem)}constructor(e,t,i,s){this.sharingApi=e,this.sharingCrypto=t,this.sharingUsers=i,this.sharingAuditLogs=s}}h=(0,s.gn)([(0,r.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===l.b_?Object:l.b_,void 0===c.M?Object:c.M,void 0===d.E?Object:d.E,void 0===p.a?Object:p.a])],h)},1349:function(e,t,i){i.d(t,{D:()=>u});var s=i(21636),r=i(306),n=i(44577),a=i(56144),o=i(94190),c=i(82343),d=i(42894),l=i(83533);class u{async scheduleSync(){let{commands:e}=this.syncClient;return await this.waitOnSyncToFinish(),await e.sync({trigger:l.Trigger.Sharing}),(0,r.Vp)(void 0)}async runSync(){return await this.scheduleSync(),await this.waitOnSyncToFinish(),(0,r.Vp)(void 0)}waitOnSyncToFinish(){return(0,n.z)(this.syncClient.queries.syncProgress().pipe((0,a.h)(r.d6),(0,a.h)(e=>e.data.status!==c.L.IN_PROGRESS)))}constructor(e){this.syncClient=e}}u=(0,s.gn)([(0,o.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===d.Q?Object:d.Q])],u)},61028:function(e,t,i){i.d(t,{o:()=>u});var s=i(21636),r=i(18550),n=i(94190),a=i(4274),o=i(19425),c=i(53800),d=i(28107),l=i(95255);class u{async createSignedUserGroupInvites(e,t){return(await this.createSignedUserGroupInvitesPerResource(e,[t]))[t.uuid]}async createSignedUserGroupInvitesPerResource(e,t){let i=await this.getUserGroupsWithKeys(e),s=await Promise.all(t.map(async e=>{let t=await Promise.all(i.map(t=>this.createInvite(t,e)));return{resource:e,invites:t}})),r={};return s.forEach(({resource:e,invites:t})=>{r[e.uuid]=t}),r}async getUserGroupsWithKeys(e){let t=await this.currentUserGetter.getCurrentUserWithKeys();return Promise.all((await this.userGroupsRepository.getUserGroupsForIds(e.map(e=>e.groupId))).map(async i=>{let s=e.find(e=>e.groupId===i.groupId)?.permission??a.y3.Limited,r=i.groupKey;if(!r)throw Error("Unable to get encrypted user group key.");let n=await this.sharingCrypto.decryptResourceKeyToClearText(t.privateKey,i.privateKey,r);return{permission:s,groupId:i.groupId,publicKey:i.publicKey,clearUserGroupPrivateKey:n}}))}async createInvite(e,t){let{groupId:i,publicKey:s,clearUserGroupPrivateKey:n,permission:a}=e,{proposeSignature:o,acceptSignature:c,resourceKey:d}=await this.sharingInvitesCrypto.createSignedInvite(i,t,s,n);if(!d)throw Error("Could not create resource key when generating user group invite for shared item");return(0,r.Ay)({permission:a,proposeSignature:o,acceptSignature:c,id:i,resourceKey:d})}constructor(e,t,i,s){this.userGroupsRepository=e,this.sharingCrypto=t,this.sharingInvitesCrypto=i,this.currentUserGetter=s}}u=(0,s.gn)([(0,n.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o.x?Object:o.x,void 0===c.M?Object:c.M,void 0===d.f?Object:d.f,void 0===l.a?Object:l.a])],u)},15255:function(e,t,i){i.d(t,{E:()=>d});var s=i(21636),r=i(94190),n=i(4274),a=i(51623),o=i(28107),c=i(95255);class d{async createSignedUserInvites(e,t,i=!0){let s=e.length?await this.sharingGateway.getPublicKeysForUsers(e.map(e=>e.login)):[],r=await this.currentUserGetter.getCurrentUserWithKeys();return Promise.all([...i?[{login:r.login,publicKey:r.publicKey,permission:n.y3.Admin}]:[],...s.map(t=>({...t,permission:e.find(e=>e.login===t.login)?.permission??n.y3.Limited}))].map(e=>this.createInvite(e,t,r)))}async createSignedUserInvitesPerResource(e,t){let i=e.length?await this.sharingGateway.getPublicKeysForUsers(e.map(e=>e.login)):[],s=i.map(e=>e.login),r=[...i,...e.filter(e=>!s.includes(e.login)).map(({login:e})=>({login:e,publicKey:null}))].map(t=>({...t,permission:e.find(e=>e.login===t.login)?.permission??n.y3.Limited})),a=await Promise.all(t.map(async e=>{let t=await Promise.all(r.map(t=>this.createInvite(t,e)));return{resource:e,invites:t}})),o={};return a.forEach(({resource:e,invites:t})=>{o[e.uuid]=t}),o}async createInvite(e,t,i){let s=i?.login===e.login;return{...await this.invitesCryptoService.createSignedInvite(e.login,t,e.publicKey,s?i.privateKey:void 0),id:e.login,alias:e.login,permission:s?n.y3.Admin:e.permission}}constructor(e,t,i){this.currentUserGetter=e,this.invitesCryptoService=t,this.sharingGateway=i}}d=(0,s.gn)([(0,r.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===c.a?Object:c.a,void 0===o.f?Object:o.f,void 0===a.b_?Object:a.b_])],d)},51623:function(e,t,i){i.d(t,{b_:()=>a,ge:()=>n,wI:()=>r});var s=i(96272);let r="INVALID_ITEM_GROUP_REVISION",n=(0,s.Vj)(r,"Invalid revision when trying to update item group member");class a{}},71318:function(e,t,i){i.d(t,{k:()=>l});var s=i(21636),r=i(48035),n=i(53800),a=i(59283),o=i(28107),c=i(87253),d=i(89005);class l{}l=(0,s.gn)([(0,r.Y)({sharedModuleName:"sharing-crypto",providers:[n.M,a.Z,o.f],exports:[n.M,a.Z,o.f],imports:[d.y,c.D]})],l)},53800:function(e,t,i){i.d(t,{M:()=>D});var s=i(21636),r=i(94190),n=i(55559),a=i(6307),o=i(76217),c=i(21193),d=i(63654),l=i(92570),u=i(91073),p=i(74147),h=i(88355),g=i(98652),m=i(83267),v=i(87169),y=i(7766),w=i(56130),S=i(96349),f=i(46093),E=i(97702),I=i(91012),b=i(306),A=i(49247),C=i(35856);let R=e=>"string"==typeof e.data.carbonResult.xml,_=e=>(0,b.hx)(e)||!R(e)?null:e.data.carbonResult.xml;var O=i(74019),T=i(58060);let F={moduleName:"SharingCryptographyModule",useCaseName:"SharingCryptographyElementsService",applicationComponent:"Sharing"};class D{async createResourceKey(){return await this.keyGeneratorAes256.generate()}async encryptSecureData(e,t){return await this.kwc5Encryptor.encrypt(e,t)}async decryptSecureData(e,t){return await this.kwc5Decryptor.decrypt(e,t)}async createProposeSignature(e,t){let i=await this.hmacSigner.sign(e,t);return(0,m.s)(i)}async createRecipientKeyPair(e){let{publicKey:t,privateKey:i}=await this.rsaKeyPairGenerator.generate(),s=(0,v.u)((0,y.R)(i)),r=await this.encryptSecureData(e,s);return{publicKey:(0,w.y)(t),privateKey:(0,m.s)(r)}}async createAcceptSignature(e,t,i){let s=(0,m.s)(i),r=`${t}-accepted-${s}`,n=(0,v.u)(r),a=await this.rsaSigner.sign((0,S.B)(e),n);return(0,m.s)(a)}async verifyAcceptSignature(e,t,i,s){let r=(0,m.s)(s),n=`${i}-accepted-${r}`,a=(0,v.u)(n);return await this.rsaVerifier.verify((0,f.M)(e),(0,E.R)(t),a)}async verifyProposeSignature(e,t,i){return this.hmacVerifier.verify(e,(0,E.R)(i),(0,v.u)(t))}async encryptResourceKey(e,t){return await this.rsaEncryptor.encrypt(e,t)}async decryptResourceKey(e,t){return await this.rsaDecryptor.decrypt(e,t)}async decryptResourceKeyToClearText(e,t,i){let s=await this.decryptResourceKey((0,S.B)(e),(0,E.R)(i)),r=await this.decryptSecureData(s,(0,E.R)(t));return(0,I.v)(r)}async encryptSharingItem(e,t){let{commands:{carbon:i}}=this.client,s=_(await i({name:"convertItemToDashlaneXml",args:[{item:t}]}));if(""===s||null===s)throw Error("Unable to convert item to XML");let r=(0,C.w)(s);return await this.encryptSecureData(e,r)}async decryptContentAndConvertXMLToVaultItem(e,t){let i=(0,E.R)(t),s=await this.decryptSecureData(e,i),r=(0,C.Q)(s),n=await this.client.commands.convertDashlaneXmlToItem({xml:r});if((0,b.hx)(n))return null;let a=(0,b.db)(n);return a.success?a.item:(this.reportError("Error when converting item to xml",{error:a.error}),null)}async decryptEncapsulatedPrivateKey(e,t,i){let s=await this.decryptResourceKey(e,(0,E.R)(t)),r=await this.decryptSecureData(s,(0,E.R)(i));return(0,S.B)((0,I.v)(r))}reportError(e,t){this.exceptionLoggingClient.commands.reportAnomaly({...F,criticality:O.h_.CRITICAL,message:e,anomalyType:"exception",origin:"uncaughtException",additionalInfo:JSON.stringify(t)})}constructor(e,t,i,s,r,n,a,o,c,d,l,u){this.client=e,this.hmacSigner=t,this.hmacVerifier=i,this.keyGeneratorAes256=s,this.rsaKeyPairGenerator=r,this.kwc5Decryptor=n,this.kwc5Encryptor=a,this.rsaDecryptor=o,this.rsaEncryptor=c,this.rsaSigner=d,this.rsaVerifier=l,this.exceptionLoggingClient=u}}D=(0,s.gn)([(0,r.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===A._?Object:A._,void 0===n.q?Object:n.q,void 0===a.a?Object:a.a,void 0===o.c?Object:o.c,void 0===c.e?Object:c.e,void 0===d.$?Object:d.$,void 0===l.o?Object:l.o,void 0===u.g?Object:u.g,void 0===p.H?Object:p.H,void 0===h.k?Object:h.k,void 0===g.u?Object:g.u,void 0===T.G?Object:T.G])],D)},59283:function(e,t,i){i.d(t,{Z:()=>g});var s=i(21636),r=i(94190),n=i(97702),a=i(96349),o=i(4274),c=i(53800),d=i(79583),l=i(74019),u=i(58060),p=i(95255);let h={moduleName:"SharingCryptographyModule",useCaseName:"SharingCryptographyUtilityService",applicationComponent:"Sharing"};class g{async decryptItemGroupKey(e){let t=await this.currentUserGetter.getCurrentUserWithKeys(),{accessLink:i}=e;return this.decryptItemGroupKeyFromAccessLink(i,t)}async decryptItemGroupKeyFromAccessLink(e,t){return e?e.accessType===o.Uv.User?this.decryptResourceKeyViaUserMember(e,t):e.accessType===o.Uv.UserGroup?this.decryptViaGroupMember(e,t):e.accessType===o.Uv.CollectionUser?this.decryptViaCollectionUserMember(e,t):this.decryptViaCollectionUserGroupMember(e,t):null}async decryptSharedItemContent(e,t){try{let i=await this.decryptItemGroupKey(e);if(!i)return null;let s=await this.sharingCrypto.decryptSecureData(i,(0,n.R)(e.itemKey));return await this.sharingCrypto.decryptContentAndConvertXMLToVaultItem(s,t)}catch(t){return this.reportError("Error when decrypting item content",JSON.stringify({itemGroupId:e.itemId,revision:e.revision,error:t})),null}}async decryptSharedCollectionKey(e,t){let{accessLink:i}=e;return i?.accessType===d.o.User?this.decryptResourceKeyViaUserMember(i,t):i?.accessType===d.o.UserGroup?this.decryptViaGroupMember(i,t):void 0}async decryptSharedCollectionKeyForCurrentUser(e){let t=await this.currentUserGetter.getCurrentUserWithKeys();return this.decryptSharedCollectionKey(e,t)}async decryptResourceKeyViaUserMember(e,t){try{return await this.sharingCrypto.decryptResourceKey((0,a.B)(t.privateKey),(0,n.R)(e.encryptedResourceKey))}catch(e){return this.reportError("Error when decrypting resource key",JSON.stringify({error:e})),null}}async createSharedItemAcceptSignature(e,t){let i=await this.decryptItemGroupKey(e);if(!i)throw Error("Failed to decrypt item group key");return await this.sharingCrypto.createAcceptSignature(t.privateKey,e.sharedItemId,i)}async createUserGroupAcceptSignature(e,t,i){let s=await this.sharingCrypto.decryptResourceKey((0,a.B)(e.privateKey),(0,n.R)(t));return await this.sharingCrypto.createAcceptSignature(e.privateKey,i,s)}async createCollectionAcceptSignature(e,t){let i=await this.decryptSharedCollectionKey(t,e);if(!i)throw Error("Failed to decrypt collection key");return await this.sharingCrypto.createAcceptSignature(e.privateKey,t.id,i)}async decryptViaGroupMember(e,t){let{encryptedResourceKey:i,groupEncryptedKey:s,groupPrivateKey:r}=e;if(!s||!r)return null;try{let e=await this.sharingCrypto.decryptEncapsulatedPrivateKey((0,a.B)(t.privateKey),s,r);return await this.sharingCrypto.decryptResourceKey(e,(0,n.R)(i))}catch(e){return this.reportError("Error when decrypting resource key via user group user member",JSON.stringify({error:e})),null}}async decryptViaCollectionUserMember(e,t){let{encryptedResourceKey:i,collectionEncryptedKey:s,collectionPrivateKey:r}=e;if(!s||!r)return null;let o=await this.sharingCrypto.decryptEncapsulatedPrivateKey((0,a.B)(t.privateKey),s,r);return await this.sharingCrypto.decryptResourceKey(o,(0,n.R)(i))}async decryptViaCollectionUserGroupMember(e,t){try{let{encryptedResourceKey:i,collectionEncryptedKey:s,collectionPrivateKey:r,groupEncryptedKey:o,groupPrivateKey:c}=e;if(!s||!r||!o||!c)return null;let d=await this.sharingCrypto.decryptEncapsulatedPrivateKey((0,a.B)(t.privateKey),o,c),l=await this.sharingCrypto.decryptEncapsulatedPrivateKey(d,s,r);return await this.sharingCrypto.decryptResourceKey(l,(0,n.R)(i))}catch(e){return this.reportError("Error when decrypting collection key via user group member",JSON.stringify({error:e})),null}}reportError(e,t){this.exceptionLoggingClient.commands.reportAnomaly({...h,criticality:l.h_.CRITICAL,message:e,anomalyType:"exception",origin:"uncaughtException",additionalInfo:JSON.stringify(t)})}constructor(e,t,i){this.sharingCrypto=e,this.currentUserGetter=t,this.exceptionLoggingClient=i}}g=(0,s.gn)([(0,r.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===c.M?Object:c.M,void 0===p.a?Object:p.a,void 0===u.G?Object:u.G])],g)},28107:function(e,t,i){i.d(t,{f:()=>d});var s=i(21636),r=i(94190),n=i(46093),a=i(83267),o=i(87169),c=i(53800);class d{async createSignedInvite(e,t,i,s){let r=i?await this.sharingCrypto.encryptResourceKey((0,n.M)(i),t.resourceKey):void 0,c=r?(0,a.s)(r):void 0,d=(0,o.u)(e);return{proposeSignature:await this.sharingCrypto.createProposeSignature(t.resourceKey,d),acceptSignature:s?await this.sharingCrypto.createAcceptSignature(s,t.uuid,t.resourceKey):void 0,resourceKey:c,proposeSignatureUsingAlias:!i}}constructor(e){this.sharingCrypto=e}}d=(0,s.gn)([(0,r.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===c.M?Object:c.M])],d)},79511:function(e,t,i){i.d(t,{F:()=>c});var s=i(21636),r=i(42589),n=i(44577),a=i(94190),o=i(32018);class c{async getSharedItemContent(e){let t=this.store.state$.pipe((0,r.U)(t=>{let i=t.find(t=>t.sharedItemId===e);if(!i)throw Error("Pending item group not found when accepting/refusing invite");return i}));return(0,n.z)(t)}constructor(e){this.store=e}}c=(0,s.gn)([(0,a.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===o.fx?Object:o.fx])],c)},81778:function(e,t,i){i.d(t,{p:()=>er});var s=i(21636),r=i(48035),n=i(50113),a=i(4843),o=i(87253),c=i(59025),d=i(32018),l=i(51971),u=i(33506),p=i(79511),h=i(69369),g=i(9921),m=i(44577),v=i(37368),y=i(59242),w=i(306),S=i(84834),f=i(81218),E=i(19425),I=i(59283),b=i(95255),A=i(1349);class C{async execute({body:e}){let{userGroupId:t}=e,i=await this.userGroupsRepository.getUserGroupForId(t),s=await this.currentUserGetter.getCurrentUserWithKeys(),r=i.groupKey;if(!r)throw Error("Unable to get user group key");let n=await this.sharingCrypto.createUserGroupAcceptSignature(s,r,t);return await (0,m.z)(this.serverApiClient.v1.sharingUserdevice.acceptUserGroup({acceptSignature:n,groupId:t,provisioningMethod:f.ET.USER,revision:i.revision})),await this.sharingSync.scheduleSync(),(0,w.Vp)(void 0)}constructor(e,t,i,s,r){this.serverApiClient=e,this.sharingCrypto=t,this.currentUserGetter=i,this.sharingSync=s,this.userGroupsRepository=r}}C=(0,s.gn)([(0,v.W)(S.Q),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===y.l?Object:y.l,void 0===I.Z?Object:I.Z,void 0===b.a?Object:b.a,void 0===A.D?Object:A.D,void 0===E.x?Object:E.x])],C);var R=i(31608),_=i(44145);class O{async execute(e){let{body:{collectionId:t}}=e,i=await this.collectionsRepository.getCollectionById(t);if(!i)throw Error("Pending Collection not found new path");let s=await this.currentUserGetter.getCurrentUserWithKeys(),r=await this.sharingCryptoUtility.createCollectionAcceptSignature(s,i),n=await (0,m.z)(this.serverApiClient.v1.sharingUserdevice.acceptCollection({collectionUUID:t,revision:i.revision,acceptSignature:r}));return(0,w.hx)(n)?(0,w.Rn)(new R.nu):(await this.sharingSync.scheduleSync(),(0,w.Vp)(void 0))}constructor(e,t,i,s,r){this.serverApiClient=e,this.sharingCryptoUtility=t,this.collectionsRepository=i,this.sharingSync=s,this.currentUserGetter=r}}O=(0,s.gn)([(0,v.W)(R.cD),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===y.l?Object:y.l,void 0===I.Z?Object:I.Z,void 0===_.G?Object:_.G,void 0===A.D?Object:A.D,void 0===b.a?Object:b.a])],O);var T=i(4274),F=i(3945),D=i(37937),U=i(36399),P=i(26342),x=i(70600);class N{async execute(e){let{itemGroupId:t}=e.body,i=(await this.sharedItemsRepository.getSharedItemsIndex())[t];if(!i)throw Error("Item group not found");let s=await this.currentUserGetter.getCurrentUserWithKeys(),r=await this.sharingCryptoUtility.createSharedItemAcceptSignature(i,s),n=await this.sharedItemContent.getSharedItemContent(t),a=await this.prepareAuditLogService.prepareAuditLogDetails(n),o=await this.encryptAuditLogDetails(a,t);return await (0,m.z)(this.serverApiClient.v1.sharingUserdevice.acceptItemGroup({acceptSignature:r,groupId:t,revision:i.revision,itemsForEmailing:[(0,U.Q)(n)],auditLogDetails:o||a})),await this.sharingSync.scheduleSync(),(0,w.Vp)(void 0)}async encryptAuditLogDetails(e,t){let i=await this.activityLogsClient.commands.encryptAuditLogDetailsBatch({auditLogDetailsItems:[(0,x.O)(t,e)]});if((0,w.hx)(i))throw Error(T.qn.AuditLogDetailsEncryptErrorMsg);return w.db(i)?.[t]}constructor(e,t,i,s,r,n,a,o){this.serverApiClient=e,this.sharedItemsRepository=t,this.sharingCryptoUtility=i,this.currentUserGetter=s,this.sharingSync=r,this.sharedItemContent=n,this.prepareAuditLogService=a,this.activityLogsClient=o}}N=(0,s.gn)([(0,v.W)(F.C),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===y.l?Object:y.l,void 0===P.z?Object:P.z,void 0===I.Z?Object:I.Z,void 0===b.a?Object:b.a,void 0===A.D?Object:A.D,void 0===p.F?Object:p.F,void 0===g.t?Object:g.t,void 0===D._?Object:D._])],N);var L=i(38190);class k{async execute(e){let{body:{collectionId:t}}=e,i=await this.collectionsRepository.getCollectionById(t);if(!i)throw Error("Pending Collection not found new path when refusing");let s=await (0,m.z)(this.serverApiClient.v1.sharingUserdevice.refuseCollection({collectionUUID:t,revision:i.revision}));return(0,w.hx)(s)?(0,w.Rn)(new L.R$):(await this.sharingSync.scheduleSync(),(0,w.Vp)(void 0))}constructor(e,t,i){this.serverApiClient=e,this.collectionsRepository=t,this.sharingSync=i}}k=(0,s.gn)([(0,v.W)(L.UC),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===y.l?Object:y.l,void 0===_.G?Object:_.G,void 0===A.D?Object:A.D])],k);var j=i(77481);class G{async execute(e){return this.refuseSharedItemService.execute(e.body.itemGroupId)}constructor(e){this.refuseSharedItemService=e}}G=(0,s.gn)([(0,v.W)(j.gm),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===h.C?Object:h.C])],G);var V=i(53868),M=i(94191),K=i(17741);class W{async execute(e){let{body:{userGroupId:t}}=e,{groupId:i,revision:s}=await this.userGroupsRepository.getUserGroupForId(t);return await (0,m.z)(this.serverApiClient.v1.sharingUserdevice.refuseUserGroup({groupId:i,revision:s,provisioningMethod:f.ET.USER}).pipe((0,K.DZ)(e=>{if("BusinessError"===e.tag)return(0,M.cz)(e.code);throw Error(e.message)}),(0,K.lk)(e=>{if(void 0===e.data.userGroupErrors||0===e.data.userGroupErrors.length)return(0,w.Vp)(void 0);if(e.data.userGroupErrors.length>0)throw Error(`Error for user group ${e.data.userGroupErrors[0].groupId}: ${e.data.userGroupErrors[0].message}`);throw Error("Unknown server error")}),(0,V.b)(async e=>{(0,w.d6)(e)&&await this.sharingSync.scheduleSync()})))}constructor(e,t,i){this.serverApiClient=e,this.userGroupsRepository=t,this.sharingSync=i}}W=(0,s.gn)([(0,v.W)(M.Fo),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===y.l?Object:y.l,void 0===E.x?Object:E.x,void 0===A.D?Object:A.D])],W);var z=i(36884),q=i(42589),B=i(62506),Y=i(91526);class Q{execute(){return(0,z.a)([this.pendingUserGroupsStore.state$,this.pendingCollectionInvitesStore.state$,this.pendingItemsStore.state$]).pipe((0,q.U)(([e,t,i])=>(0,w.Vp)({pendingSharedItems:i,pendingUserGroups:e,pendingCollections:t})))}constructor(e,t,i){this.pendingUserGroupsStore=e,this.pendingItemsStore=t,this.pendingCollectionInvitesStore=i}}Q=(0,s.gn)([(0,B.e)(Y.q),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===l.t?Object:l.t,void 0===d.fx?Object:d.fx,void 0===c.KL?Object:c.KL])],Q);var H=i(81433),$=i(14706);class X{execute(){let e=this.pendingItemsStore.state$,t=this.pendingUserGroupsStore.state$,i=this.pendingCollectionInvitesStore.state$;return(0,z.a)([i,e,t]).pipe((0,q.U)(([e,t,i])=>{let s=e.length>0,r=t.length>0,n=i.length>0;return s||r||n}),(0,H.x)(),(0,q.U)(w.Vp))}constructor(e,t,i){this.pendingCollectionInvitesStore=e,this.pendingItemsStore=t,this.pendingUserGroupsStore=i}}X=(0,s.gn)([(0,B.e)($._),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===c.KL?Object:c.KL,void 0===d.fx?Object:d.fx,void 0===l.t?Object:l.t])],X);var Z=i(78631),J=i(71318),ee=i(36159),et=i(89005),ei=i(90735),es=i(77261);class er{}er=(0,s.gn)([(0,r.Y)({api:n.t,stores:[c.KL,d.fx,l.t],handlers:{commands:{acceptUserGroupInvite:C,acceptCollectionInvite:O,acceptSharedItemInvite:N,refuseCollectionInvite:k,refuseItemGroupInvite:G,refuseUserGroupInvite:W},events:{},queries:{getInvites:Q,hasInvites:X}},imports:[a.n,o.D,J.k,ee.I,et.y,ei.u,Z.F,es.a],providers:[u.M,p.F,h.C,g.t],requiredFeatureFlips:["sharing_Web_GranularPermissions_dev"],exports:[u.M,h.C]})],er)},33506:function(e,t,i){i.d(t,{M:()=>c});var s=i(21636),r=i(94190),n=i(59025),a=i(32018),o=i(51971);class c{setCollectionInvites(e){this.collectionsStore.set(e)}setUserGroupInvites(e){this.userGroupsStore.set(e)}setSharedItemInvites(e){this.itemsStore.set(e)}getUserGroupInvites(){return this.userGroupsStore.getState()}getSharedItemsInvites(){return this.itemsStore.getState()}getCollectionsInvites(){return this.collectionsStore.getState()}constructor(e,t,i){this.collectionsStore=e,this.userGroupsStore=t,this.itemsStore=i}}c=(0,s.gn)([(0,r.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===n.KL?Object:n.KL,void 0===o.t?Object:o.t,void 0===a.fx?Object:a.fx])],c)},9921:function(e,t,i){i.d(t,{t:()=>v});var s=i(21636),r=i(44577),n=i(49247),a=i(94190),o=i(17741),c=i(306),d=i(5041),l=i(71749),u=i(83463),p=i(4274),h=i(44948);let g=(e,t)=>{let i=!!t?.SpaceId&&e,s=t&&(0,l.G)(t),r=s?new u.Y(t.Url).getRootDomain():"",n=(0,h.l7)(t);return i?{captureLog:i,domain:s?r||"":void 0,type:n}:void 0},m=(e,t)=>{let i;let s=!!t.spaceId&&e;if(t.itemType===p.y2.Credential){let e={...t,itemType:p.y2.Credential};i=new u.Y(e.url).getRootDomain()||""}let r=(0,h.HU)(t.itemType);return s?{captureLog:s,domain:i,type:r}:void 0};class v{async prepareAuditLogDetails(e){let{queries:{carbonState:t}}=this.carbonLegacyClient,i=t({path:"userSession.localSettings.premiumStatus"}).pipe((0,o.Qn)(e=>{let t=(0,d.n)(e);return t.length?t[0]:void 0})),s=await (0,r.z)(i);if((0,c.hx)(s))return;let n=c.db(s)?.info.collectSensitiveDataAuditLogsEnabled;return n?m(n,e):void 0}async prepareAuditLogDetailsLegacy(e){let{queries:{carbonState:t}}=this.carbonLegacyClient,i=t({path:"userSession.localSettings.premiumStatus"}).pipe((0,o.Qn)(e=>(0,d.n)(e)[0])),s=await (0,r.z)(i);if((0,c.hx)(s))return;let n=c.db(s)?.info.collectSensitiveDataAuditLogsEnabled;return n?g(n,e):void 0}constructor(e){this.carbonLegacyClient=e}}v=(0,s.gn)([(0,a.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===n._?Object:n._])],v)},69369:function(e,t,i){i.d(t,{C:()=>v});var s=i(21636),r=i(44577),n=i(94190),a=i(59242),o=i(306),c=i(4274),d=i(37937),l=i(79511),u=i(26342),p=i(36399),h=i(9921),g=i(70600),m=i(1349);class v{async execute(e){let t=(await this.sharedItemsRepository.getSharedItemsIndex())[e];if(!t)throw Error("Shared item not found while refusing invite");let i=await this.sharedItemContent.getSharedItemContent(e),s=await this.prepareAuditLogService.prepareAuditLogDetails(i),n=await this.activityLogsClient.commands.encryptAuditLogDetailsBatch({auditLogDetailsItems:[(0,g.O)(e,s)]});if((0,o.hx)(n))throw Error(c.qn.AuditLogDetailsEncryptErrorMsg);let a=o.db(n)?.[e];return await (0,r.z)(this.serverApiClient.v1.sharingUserdevice.refuseItemGroup({groupId:e,revision:t.revision,itemsForEmailing:[(0,p.Q)(i)],auditLogDetails:a||s})),await this.sharingSync.scheduleSync(),(0,o.Vp)(void 0)}constructor(e,t,i,s,r,n){this.serverApiClient=e,this.sharedItemContent=t,this.sharedItemsRepository=i,this.sharingSync=s,this.prepareAuditLogService=r,this.activityLogsClient=n}}v=(0,s.gn)([(0,n.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===a.l?Object:a.l,void 0===l.F?Object:l.F,void 0===u.z?Object:u.z,void 0===m.D?Object:m.D,void 0===h.t?Object:h.t,void 0===d._?Object:d._])],v)},59025:function(e,t,i){i.d(t,{KL:()=>h});var s=i(63762),r=i(80905),n=i(59982),a=i(68238),o=i(15021),c=i(20458),d=i(32303);let l=s.z.array(r.ZS),u=e=>l.safeParse(e).success,p=({version:e,content:t})=>{var i;if(1===e&&Array.isArray(i=t)&&(0===i.length||i.some(e=>void 0!==e.permission)))return t.map(e=>({id:e.id,name:e.name,referrer:e.referrer,sharedCollectionRole:(0,d.c)(e.permission)}));throw Error("Unable to recognize data schema during migration (PendingCollectionInvites)")};class h extends(0,n.Q)({persist:!0,storage:{initialValue:[],typeGuard:u,schemaVersion:2,migrateStorageSchema:p},scope:o.F.User,storeName:"pending-collection-invites-state",storeTypeGuard:u,codec:c.E,isCache:!0,capacity:a.Y.Unlimited}){}},32018:function(e,t,i){i.d(t,{fx:()=>h});var s=i(63762),r=i(80905),n=i(59982),a=i(68238),o=i(15021),c=i(20458),d=i(32303);let l=s.z.array(r.jd),u=e=>l.safeParse(e).success,p=({version:e,content:t})=>{var i;if(1===e&&Array.isArray(i=t)&&(0===i.length||i.some(e=>void 0!==e.permission)))return t.map(e=>{let{permission:t,...i}=e;return{...i,sharingPermissionLevel:(0,d.m)(t)}});throw Error("Unable to recognize data schema during migration (PendingCollectionInvites)")};class h extends(0,n.Q)({persist:!0,storage:{initialValue:[],typeGuard:u,schemaVersion:2,migrateStorageSchema:p},scope:o.F.User,storeName:"pending-shared-items-invites-state",storeTypeGuard:u,codec:c.E,isCache:!0,capacity:a.Y.Unlimited}){}},51971:function(e,t,i){i.d(t,{t:()=>u});var s=i(63762),r=i(80905),n=i(59982),a=i(68238),o=i(15021),c=i(20458);let d=s.z.array(r.Ey),l=e=>d.safeParse(e).success;class u extends(0,n.Q)({persist:!0,storage:{initialValue:[],typeGuard:l,schemaVersion:1},scope:o.F.User,storeName:"pending-user-group-invites-state",storeTypeGuard:l,codec:c.E,isCache:!0,capacity:a.Y.Unlimited}){}},36399:function(e,t,i){i.d(t,{Q:()=>s});let s=e=>({type:e.itemType,name:e.title})},26342:function(e,t,i){i.d(t,{z:()=>s});class s{}},5041:function(e,t,i){i.d(t,{n:()=>s});let s=e=>(e.spaces??[]).filter(e=>"accepted"===e.status)},78631:function(e,t,i){i.d(t,{F:()=>tA});var s,r=i(21636),n=i(48035),a=i(99481),o=i(90573),c=i(4843),d=i(50702),l=i(26342),u=((s={}).SHARED_ITEM_IS_NOT_FOUND="ITEM_GROUP_IS_NOT_FOUND",s.INSUFFICIENT_PERMISSION_PRIVILEGES="INSUFFICIENT_PERMISSION_PRIVILEGES",s.INVALID_REVISION="INVALID_ITEM_GROUP_REVISION",s.NOT_A_MEMBER_CANNOT_SHARE_WITH_USER_GROUP="NOT_A_MEMBER_CANNOT_SHARE_WITH_USER_GROUP",s.SHARING_DISABLED_BY_TEAM="SHARING_DISABLED_BY_TEAM",s.USER_IS_NOT_MEMBER_OF_TEAM="USER_IS_NOT_MEMBER_OF_TEAM",s.SERVER_ERROR="SERVER_ERROR",s);class p{}var h=i(44577),g=i(94190),m=i(59242),v=i(306),y=i(18550),w=i(37937),S=i(4274);let f=e=>e.map(({id:e,resourceKey:t,proposeSignature:i,proposeSignatureUsingAlias:s,acceptSignature:r,alias:n,permission:a})=>({...t?{}:{proposeSignatureUsingAlias:!0},userId:e,groupKey:t,proposeSignature:i,proposeSignatureUsingAlias:s,acceptSignature:r,alias:n,permission:a})),E=e=>e.map(({id:e,resourceKey:t,proposeSignature:i,acceptSignature:s,permission:r})=>({groupId:e,groupKey:t,proposeSignature:i,acceptSignature:s,permission:r})),I=(e,t)=>{let i=e||`Untitled ${t}`;return{type:t,name:i}};var b=i(75646),A=i(70600);class C{async inviteMultipleItemGroupsMembers(e){let t=await this.activityLogsClient.commands.encryptAuditLogDetailsBatch({auditLogDetailsItems:e.map(e=>(0,A.O)(e.sharedItem.sharedItemId,e.sharedItem.auditLogDetails))});if((0,v.hx)(t))throw Error(S.qn.AuditLogDetailsEncryptErrorMsg);let i=(await (0,b.x)(e,async e=>{let i=e.map(({sharedItem:e,users:i,userGroups:s})=>{let{sharedItemId:r,revision:n,auditLogDetails:a,itemType:o,title:c}=e,d=v.db(t)?.[e.sharedItemId];return{groupId:r,revision:n,users:i?.length?f(i):void 0,groups:s?.length?E(s):void 0,auditLogDetails:d||a,itemsForEmailing:[I(c,o)]}}),s=await (0,h.z)(this.serverApiClient.v1.sharingUserdevice.inviteMultipleItemGroupMembers({itemgroups:i}));if((0,v.hx)(s))throw Error("Failed to add members to item group");return(0,v.db)(s)})).reduce((e,t)=>({itemGroups:e.itemGroups.concat(t.data.itemGroups??[]),itemGroupErrors:e.itemGroupErrors.concat(t.data.itemGroupErrors??[])}),(0,y.Ay)({itemGroups:[],itemGroupErrors:[]})),s=i.itemGroupErrors.map(({groupId:e,message:t})=>({sharedItemId:e,error:this.mapServerError(t),revision:i.itemGroups.find(t=>t.groupId===e)?.revision}));return(0,v.Vp)({errors:s})}mapServerError(e){switch(e){case u.USER_IS_NOT_MEMBER_OF_TEAM:return u.USER_IS_NOT_MEMBER_OF_TEAM;case u.INSUFFICIENT_PERMISSION_PRIVILEGES:return u.INSUFFICIENT_PERMISSION_PRIVILEGES;case u.NOT_A_MEMBER_CANNOT_SHARE_WITH_USER_GROUP:return u.NOT_A_MEMBER_CANNOT_SHARE_WITH_USER_GROUP;case u.SHARED_ITEM_IS_NOT_FOUND:return u.SHARED_ITEM_IS_NOT_FOUND;case u.INVALID_REVISION:return u.INVALID_REVISION;case u.SHARING_DISABLED_BY_TEAM:return u.SHARING_DISABLED_BY_TEAM;default:return u.SERVER_ERROR}}constructor(e,t){this.serverApiClient=e,this.activityLogsClient=t}}C=(0,r.gn)([(0,g.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===m.l?Object:m.l,void 0===w._?Object:w._])],C);var R=i(58060),_=i(66407),O=i(83463),T=i(28795);let F=e=>{switch(e){case u.SHARED_ITEM_IS_NOT_FOUND:return T.z.ITEM_DOESNT_EXIST;case u.INVALID_REVISION:return T.z.INVALID_REVISION;default:return T.z.SHARING_FAILED}},D=(e,t,i)=>{let s=i.find(e=>e.Id===t);if(!s)throw Error("Vault item not found when trying to share");let{Id:r,kwType:n,Title:a}=s,o={id:r,title:a,error:F(e)};if(n===_.dJ.KWAuthentifiant){let e=new O.Y(s.Url).getRootDomain();return{...o,type:S.y2.Credential,domain:e,text:s.Email||s.Login}}return n===_.dJ.KWSecureNote?{...o,type:S.y2.SecureNote,color:s.Type}:{...o,type:S.y2.Secret}},U=e=>{let{Id:t,Title:i}=e;return{id:t,title:i,error:T.z.ITEM_HAS_ATTACHMENTS,type:S.y2.SecureNote,color:e.Type}},P=(e,t,i)=>{let{kwType:s}=t;return{itemType:s===_.dJ.KWAuthentifiant?S.y2.Credential:s===_.dJ.KWSecureNote?S.y2.SecureNote:S.y2.Secret,sharedItemId:e.sharedItemId,revision:e.revision,title:t.Title,auditLogDetails:i}},x=(e,t)=>D(u.INSUFFICIENT_PERMISSION_PRIVILEGES,e,t);var N=i(59283),L=i(61028),k=i(15255),j=i(63948);class G{async inviteRecipients(e,t,i,s,r){let n=await this.createItemsInvites(i,e.map(e=>({login:e,permission:r})),t.map(e=>({groupId:e,permission:r}))),a=await Promise.all(await n.reduce(async(e,{sharedItem:t,users:i,userGroups:r})=>{let n=s.find(e=>e.Id===t.itemId);if(n){let s=await this.sharingAuditLogs.createAuditLog(n);(await e).push({sharedItem:P(t,n,s),users:i,userGroups:r})}else this.anomalyReporter.commands.reportAnomaly({criticality:"warning",message:"Vault item not found when trying to share",additionalInfo:JSON.stringify({sharedItemId:t.itemId}),moduleName:"sharingItemsApi",useCaseName:"sharing-items-invites",anomalyType:"other",applicationComponent:""});return e},Promise.resolve([]))),o=await this.sharingItemsGateway.inviteMultipleItemGroupsMembers(a);if((0,v.hx)(o))throw Error("Server error when sharing items");return v.db(o).errors?.map(({error:e,sharedItemId:t})=>{let r=i.find(e=>e.sharedItemId===t);if(!r)throw Error("Error when creating invite params for sharing an item");return D(e,r.itemId,s)})??[]}async createItemsInvites(e,t,i){let s=await Promise.all(e.map(async e=>{let t=await this.sharingCrypto.decryptItemGroupKey(e);if(null===t)throw Error("Unable to decrypt item group key");return{resourceKey:t,uuid:e.sharedItemId}})),r=await this.sharingUsers.createSignedUserInvitesPerResource(t,s),n=await this.sharingUserGroups.createSignedUserGroupInvitesPerResource(i,s);return e.map(e=>({sharedItem:e,users:r[e.sharedItemId],userGroups:n[e.sharedItemId]}))}constructor(e,t,i,s,r,n){this.sharingItemsGateway=e,this.sharingCrypto=t,this.sharingUserGroups=i,this.sharingUsers=s,this.sharingAuditLogs=r,this.anomalyReporter=n}}G=(0,r.gn)([(0,g.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[p,void 0===N.Z?Object:N.Z,void 0===L.o?Object:L.o,void 0===k.E?Object:k.E,void 0===j.a?Object:j.a,void 0===R.G?Object:R.G])],G);var V=i(59982),M=i(15021);class K extends(0,V.Q)({storeName:"share-items-errors-state",scope:M.F.User,persist:!1,initialValue:{hasErrors:!1}}){}var W=i(42589),z=i(72907),q=i(69853),B=i(81433),Y=i(79791);class Q{get(){return this.currentSpaceGetter.get().pipe((0,W.U)(e=>{if((0,v.hx)(e))throw Error("Problem retrieving current space information to assess sharing capacity");return(0,v.db)(e).sharedItemsLimit}),(0,z.w)(e=>void 0===e?(0,q.of)(!0):this.sharedItemsRepository.sharedItems$().pipe((0,W.U)(e=>e.length),(0,B.x)(),(0,W.U)(t=>e-t))))}constructor(e,t){this.currentSpaceGetter=e,this.sharedItemsRepository=t}}Q=(0,r.gn)([(0,g.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===Y.n?Object:Y.n,void 0===l.z?Object:l.z])],Q);var H=i(62434),$=i(72094),X=i(53990);class Z{async get(e){let t=await this.credentialsGetter.getCarbonCredentialsByItemIds(e),{notes:i,notesErrors:s}=await this.getSharableNotes(e);return{credentials:t,notes:i,notesErrors:s,secrets:await this.secretsGetter.getCarbonSecretsByItemIds(e)}}async getSharableNotes(e){return(await this.notesGetter.getCarbonNotesByItemIds(e)).reduce((e,t)=>(t.Attachments?.length?e.notesErrors.push(U(t)):e.notes.push(t),e),{notes:(0,y.Ay)([]),notesErrors:(0,y.Ay)([])})}constructor(e,t,i){this.credentialsGetter=e,this.notesGetter=t,this.secretsGetter=i}}Z=(0,r.gn)([(0,g.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===H.J?Object:H.J,void 0===$.H?Object:$.H,void 0===X.F?Object:X.F])],Z);var J=i(32616);class ee{async run(e){let{vaultItemIds:t,permission:i,userLogins:s,userGroupIds:r}=e,{credentials:n,secrets:a,notes:o,notesErrors:c}=await this.shareableItems.get(t),d=[...o,...n,...a],l=[],u=[];for(let e of d)""!==e.SpaceId?l.push(e):u.push(e);let{alreadySharedItems:p,alreadySharedItemsErrors:g,alreadySharedItemIds:m}=await (0,h.z)(this.getAlreadySharedItems(d,l.map(e=>e.Id))),{alreadySharedItems:v,alreadySharedItemsErrors:y,alreadySharedItemIds:w}=await (0,h.z)(this.getAlreadySharedItems(d,u.map(e=>e.Id))),S=l.filter(e=>!m.includes(e.Id)),f=u.filter(e=>!w.includes(e.Id)),E=[...v,...p,...f.length?await this.sharingItemsService.createMultipleItemGroups(f):[],...S.length?await this.sharingItemsService.createMultipleItemGroups(S):[]],I=[...c,...y,...g,...E.length?await this.sharingItemsInvitesService.inviteRecipients(s,r,E,d,i):[]];return{hasChanges:E.length>0,errors:I}}getAlreadySharedItems(e,t){return this.sharedItemsRepository.sharedItemsForIds$(t).pipe((0,W.U)(t=>t.reduce((t,i)=>("full"!==i.sharingPermissionLevel?t.alreadySharedItemsErrors.push(x(i.itemId,e)):t.alreadySharedItems.push(i),t.alreadySharedItemIds.push(i.itemId),t),{alreadySharedItems:(0,y.Ay)([]),alreadySharedItemsErrors:(0,y.Ay)([]),alreadySharedItemIds:(0,y.Ay)([])})))}constructor(e,t,i,s){this.sharingItemsInvitesService=e,this.sharingItemsService=t,this.sharedItemsRepository=i,this.shareableItems=s}}ee=(0,r.gn)([(0,g.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===G?Object:G,void 0===J.k?Object:J.k,void 0===l.z?Object:l.z,void 0===Z?Object:Z])],ee);var et=i(63762),ei=i(68238),es=i(20458),er=i(43909);let en=et.z.object({sharedItemId:et.z.string(),vaultItemId:et.z.string(),revision:et.z.number(),savedToVault:et.z.boolean().optional()}),ea=et.z.object({indexPerVaultItemId:et.z.record(en),sharedItems:et.z.record(er.m$),sharedAccess:et.z.record(er.Im)}),eo=e=>ea.safeParse(e).success;class ec extends(0,V.Q)({persist:!0,storage:{initialValue:{indexPerVaultItemId:{},sharedItems:{},sharedAccess:{}},typeGuard:eo,schemaVersion:5,migrateStorageSchema:()=>({indexPerVaultItemId:{},sharedItems:{},sharedAccess:{}})},scope:M.F.User,storeName:"shared-items-state",storeTypeGuard:eo,codec:es.E,isCache:!0,capacity:ei.Y.Unlimited}){}class ed{async getVaultItemsIndex(){let{indexPerVaultItemId:e}=await this.store.getState();return e}async getSharedItemsIndex(){let{sharedItems:e}=await this.store.getState();return e}async getSharedAccessIndex(){let{sharedAccess:e}=await this.store.getState();return e}async setSharedItems(e,t){if(!e||!t){this.store.set({indexPerVaultItemId:{},sharedItems:{},sharedAccess:{}});return}let i=await this.store.getState();await this.store.set(e.reduce((e,{sharedItem:s,revision:r})=>(e.sharedItems[s.sharedItemId]=s,e.indexPerVaultItemId[s.itemId]={sharedItemId:s.sharedItemId,vaultItemId:s.itemId,revision:r},e.sharedAccess[s.sharedItemId]=t[s.sharedItemId]??i.sharedAccess[s.sharedItemId],e),(0,y.Ay)({sharedItems:{},indexPerVaultItemId:{},sharedAccess:{}})))}sharedItems$(){return this.store.state$.pipe((0,W.U)(({sharedItems:e})=>Object.values(e)))}sharedItemsForIds$(e){return this.store.state$.pipe((0,W.U)(({sharedItems:t,indexPerVaultItemId:i})=>e.reduce((e,s)=>{let r=i[s];if(r){let i=t[r.sharedItemId];i&&e.push(i)}return e},(0,y.Ay)([]))))}sharedItemForId$(e){return this.store.state$.pipe((0,W.U)(({sharedItems:t,indexPerVaultItemId:i})=>i[e]?t[i[e].sharedItemId]:null))}sharedAccess$(){return this.store.state$.pipe((0,W.U)(({sharedAccess:e})=>Object.values(e)))}sharedAccessForId$(e){return this.store.state$.pipe((0,W.U)(({sharedAccess:t,indexPerVaultItemId:i})=>{let s=i[e];if(!s)return null;let r=s.sharedItemId;return{sharedItemId:r,...t[r]}}))}sharedAccessForIds$(e){return this.store.state$.pipe((0,W.U)(({sharedAccess:t,indexPerVaultItemId:i})=>e.reduce((e,s)=>{let r=i[s];if(r){let i=t[r.sharedItemId];i&&e.push(i)}return e},(0,y.Ay)([]))))}sharedAccessesById$(e){return this.store.state$.pipe((0,W.U)(({sharedAccess:t,indexPerVaultItemId:i})=>e.reduce((e,s)=>{let r=i[s];if(r){let i=t[r.sharedItemId];i&&(e[s]=i)}return e},(0,y.Ay)({}))))}constructor(e){this.store=e}}ed=(0,r.gn)([(0,g.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[ec])],ed);class el{async refuseSharedItem(e,t){let i=await (0,h.z)(this.sharedItemRepository.sharedItemForId$(e));if(!i)throw Error("Failed to retrieve shared item to refuse");let{itemId:s}=i,r=await this.activityLogsClient.commands.encryptAuditLogDetailsBatch({auditLogDetailsItems:[(0,A.O)(s,t)]});if((0,v.hx)(r))throw Error(S.qn.AuditLogDetailsEncryptErrorMsg);let n=v.db(r)?.[s];await (0,h.z)(this.serverApiClient.v1.sharingUserdevice.refuseItemGroup({groupId:i.sharedItemId,revision:i.revision,auditLogDetails:n||t}))}constructor(e,t,i){this.serverApiClient=e,this.sharedItemRepository=t,this.activityLogsClient=i}}el=(0,r.gn)([(0,g.GS)(),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===m.l?Object:m.l,void 0===l.z?Object:l.z,void 0===w._?Object:w._])],el);class eu{getAllRoleDefinitions(){return{restricted:{canCopy:!1,canReveal:!1,canEdit:!1,canShare:!1,canManageAccess:!1},view:{canCopy:!0,canReveal:!0,canEdit:!1,canShare:!1,canManageAccess:!1},edit:{canCopy:!0,canReveal:!0,canEdit:!0,canShare:!1,canManageAccess:!1},full:{canCopy:!0,canReveal:!0,canEdit:!0,canShare:!0,canManageAccess:!0}}}getCapabilitiesForRole(e){let t=this.getAllRoleDefinitions();return t[e]||t.restricted}}eu=(0,r.gn)([(0,g.GS)()],eu);class ep extends(0,a.ne)(){}var eh=i(37368),eg=i(85670),em=i(51623),ev=i(1349);class ey{async execute({body:e}){let{sharedItemId:t,revision:i,users:s,groups:r}=await this.getItemGroup(e),n=await this.commonGateway.updateItemGroupMembers({groupId:t,revision:i,users:s,groups:r});if((0,v.hx)(n)){if(n.error.tag===em.wI){await this.sharingSync.scheduleSync();let{sharedItemId:t,revision:i}=await this.getItemGroup(e);return await this.commonGateway.updateItemGroupMembers({groupId:t,revision:i,users:s,groups:r}),(0,v.Vp)(void 0)}throw Error("Revoke shared item failed after retry attempt")}return await this.sharingSync.scheduleSync(),(0,v.Vp)(void 0)}async getItemGroup(e){let{vaultItemId:t,recipient:i,permission:s}=e,r=await (0,h.z)(this.sharedItemRepository.sharedItemForId$(t));if(!r)throw Error("Failed to retrieve item group to revoke share item");let{sharedItemId:n,revision:a}=r;return{sharedItemId:n,revision:a,users:i.type===S.IP.User?[{userId:i.alias,permission:s}]:void 0,groups:i.type===S.IP.Group?[{groupId:i.groupId,permission:s}]:void 0}}constructor(e,t,i){this.sharingSync=e,this.commonGateway=t,this.sharedItemRepository=i}}ey=(0,r.gn)([(0,eh.W)(eg.W),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===ev.D?Object:ev.D,void 0===em.b_?Object:em.b_,void 0===l.z?Object:l.z])],ey);var ew=i(76910);class eS{async execute({body:e}){let{vaultItemId:t}=e,{revision:i,itemGroupId:s,userLogins:r,userGroupIds:n}=await this.getItemGroup(e),a=await this.sharingAuditLogs.prepareSharedItemAuditLogDetails(t),o=await this.commonGateway.revokeItemGroupMembers({revision:i,itemGroupId:s,userLogins:r,userGroupIds:n,auditLogDetails:a});if((0,v.hx)(o)){if(o.error.tag===em.wI){await this.sharingSync.scheduleSync();let{revision:t,itemGroupId:i}=await this.getItemGroup(e);return await this.commonGateway.revokeItemGroupMembers({revision:t,itemGroupId:i,userLogins:r,userGroupIds:n,auditLogDetails:a}),(0,v.Vp)(void 0)}throw Error("Revoke shared item failed after retry attempt")}return await this.sharingSync.scheduleSync(),(0,v.Vp)(void 0)}async getItemGroup(e){let{vaultItemId:t,recipient:i}=e,s=await (0,h.z)(this.sharedItemRepository.sharedItemForId$(t));if(!s)throw Error("Failed to retrieve item group to revoke share item");let{sharedItemId:r,revision:n}=s;return{revision:n,itemGroupId:r,userLogins:i.type===S.IP.User?[i.alias]:void 0,userGroupIds:i.type===S.IP.Group?[i.groupId]:void 0}}constructor(e,t,i,s){this.sharingSync=e,this.commonGateway=t,this.sharedItemRepository=i,this.sharingAuditLogs=s}}eS=(0,r.gn)([(0,eh.W)(ew.V),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===ev.D?Object:ev.D,void 0===em.b_?Object:em.b_,void 0===l.z?Object:l.z,void 0===j.a?Object:j.a])],eS);var ef=i(80706);class eE{async execute({body:e}){return await this.sharedItemsService.refuseSharedItem(e.vaultItemId),(0,v.Vp)(void 0)}constructor(e){this.sharedItemsService=e}}eE=(0,r.gn)([(0,eh.W)(ef.l),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===el?Object:el])],eE);var eI=i(31578),eb=i(41751),eA=i(91682),eC=i(71709),eR=i(45991),e_=i(3750),eO=i(62506),eT=i(19425);class eF{getCurrentUserLogin(){return this.context.get(e_.l.UserName)}execute({body:e}){let{itemId:t}=e;return this.sharedItemsRepository.sharedAccessForId$(t).pipe((0,z.w)(e=>{if(!e)return(0,q.of)({isShared:!1,isSharedViaUserGroup:!1});let t=this.getCurrentUserLogin();if(!t)throw Error("No user login found to check sharing status for item");return this.userGroupRepository.acceptedUserGroupIdsForLogin$(t).pipe((0,W.U)(t=>({isShared:!0,isSharedViaUserGroup:e.userGroups.some(({id:e,status:i})=>t.includes(e)&&"accepted"===i)})))}),(0,B.x)(eR.shallowEqualObjects),(0,W.U)(v.Vp))}constructor(e,t,i){this.userGroupRepository=e,this.sharedItemsRepository=t,this.context=i}}eF=(0,r.gn)([(0,eO.e)(eb.S),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===eT.x?Object:eT.x,void 0===l.z?Object:l.z,void 0===e_.f?Object:e_.f])],eF);class eD{execute({body:e}){let{itemId:t}=e;return this.sharedItemsRepository.sharedItemForId$(t).pipe((0,W.U)(e=>(0,v.Vp)({isLastAdmin:!!e?.isLastAdmin})))}constructor(e){this.sharedItemsRepository=e}}eD=(0,r.gn)([(0,eO.e)(eC.X),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===l.z?Object:l.z])],eD);class eU{async execute({body:e}){let{vaultItemId:t}=e,i=await (0,h.z)(this.sharingStatusForItemQueryHandler.execute(new eb.S({itemId:t}))),{isSharedViaUserGroup:s,isShared:r}=(0,v.f2)(i,{success:eI.y,failure:e=>{throw Error("Unexpected failure while attempting to retrieve sharing status of item to be deleted",{cause:{failure:e}})}});if(!r)return(0,v.Vp)(void 0);if(s)return(0,v.Rn)((0,eA.Vf)());let n=await (0,h.z)(this.getIsLastAdminForItemQueryHandler.execute(new eC.X({itemId:t}))),{isLastAdmin:a}=(0,v.f2)(n,{success:eI.y,failure:e=>{throw Error("Unexpected failure while attempting to determine if we're the last admin of shared item to be deleted",{cause:{failure:e}})}});return a?(0,v.Rn)((0,eA.V$)()):(await this.sharedItemsService.refuseSharedItem(t),(0,v.Vp)(void 0))}constructor(e,t,i){this.sharingStatusForItemQueryHandler=e,this.getIsLastAdminForItemQueryHandler=t,this.sharedItemsService=i}}eU=(0,r.gn)([(0,eh.W)(eA.OL),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===eF?Object:eF,void 0===eD?Object:eD,void 0===el?Object:el])],eU);var eP=i(85669);class ex{async execute({body:e}){let{vaultItemIds:t}=e,i=await (0,h.z)(this.isSharingAllowedService.get());if("boolean"==typeof i?!i:t.length>i)return(0,v.Rn)((0,eP.Kb)());let s=!1,r=null,{hasChanges:n,errors:a}=await this.shareItemsService.run(e);if(s=n,r=a,this.hasInvalidRevisionErrors(a)){let{hasChanges:i,errors:n}=await this.runShareAttempt({...e,vaultItemIds:t.filter(e=>a.find(t=>t.id===e))});r=n,s=s||i}return(s&&this.sharingSync.scheduleSync(),r.length)?(this.sharedItemsErrorsStore.set({hasErrors:!0,errors:r}),(0,v.Rn)((0,eP.$u)())):(this.sharedItemsErrorsStore.set({hasErrors:!1}),(0,v.Vp)(void 0))}hasInvalidRevisionErrors(e){return e.find(({error:e})=>e===T.z.INVALID_REVISION)}async runShareAttempt(e){return await this.sharingSync.runSync(),this.shareItemsService.run(e)}constructor(e,t,i,s){this.isSharingAllowedService=e,this.sharedItemsErrorsStore=t,this.sharingSync=i,this.shareItemsService=s}}ex=(0,r.gn)([(0,eh.W)(eP.S2),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===Q?Object:Q,K,void 0===ev.D?Object:ev.D,void 0===ee?Object:ee])],ex);var eN=i(97702),eL=i(83267),ek=i(2816),ej=i(35856),eG=i(53800);class eV{async execute({body:e}){let{itemContent:t,itemId:i}=e,s=await this.sharedItemsRepository.getVaultItemsIndex(),r=await (0,h.z)(this.sharedItemsRepository.sharedItemForId$(i));if(!r)return(0,v.Vp)(void 0);let n=s[r.itemId].revision,a=await this.sharingCryptoUtility.decryptItemGroupKey(r);if(!a)throw Error("Shared item key cannot be decrypted when trying to update its content");let o=await this.sharingCryptoElements.decryptSecureData(a,(0,eN.R)(r.itemKey)),c=(0,ej.w)(t),d=await this.sharingCryptoElements.encryptSecureData(o,c);return await (0,h.z)(this.serverApi.v1.sharingUserdevice.updateItem({content:(0,eL.s)(d),itemId:i,timestamp:n})),(0,v.Vp)(void 0)}constructor(e,t,i,s){this.sharedItemsRepository=e,this.sharingCryptoElements=t,this.sharingCryptoUtility=i,this.serverApi=s}}eV=(0,r.gn)([(0,eh.W)(ek.l),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===l.z?Object:l.z,void 0===eG.M?Object:eG.M,void 0===N.Z?Object:N.Z,void 0===m.l?Object:m.l])],eV);var eM=i(10955);class eK{execute(){return this.sharedItemsRepository.sharedAccess$().pipe((0,W.U)(e=>(0,v.Vp)({sharedAccess:e})))}constructor(e){this.sharedItemsRepository=e}}eK=(0,r.gn)([(0,eO.e)(eM.w),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===l.z?Object:l.z])],eK);var eW=i(93058);class ez{execute({body:e}){let{itemIds:t}=e;return this.sharedItemsRepository.sharedAccessForIds$(t).pipe((0,W.U)(e=>(0,v.Vp)({sharedAccess:e})))}constructor(e){this.sharedItemsRepository=e}}ez=(0,r.gn)([(0,eO.e)(eW.D),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===l.z?Object:l.z])],ez);var eq=i(50218);class eB{execute(){return this.sharedItemsRepository.sharedItems$().pipe((0,W.U)(e=>(0,v.Vp)({sharedItems:e})))}constructor(e){this.sharedItemsRepository=e}}eB=(0,r.gn)([(0,eO.e)(eq.w),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===l.z?Object:l.z])],eB);var eY=i(1833),eQ=i(96937);class eH{execute({body:e}){let{itemId:t}=e;return(0,eY.D)(this.repo.sharedItemForId$(t)).pipe((0,W.U)(e=>(0,v.Vp)({sharedItem:e})))}constructor(e){this.repo=e}}eH=(0,r.gn)([(0,eO.e)(eQ.L),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===l.z?Object:l.z])],eH);var e$=i(35946);class eX{execute(){return this.isSharingAllowedService.get().pipe((0,W.U)(e=>(0,v.Vp)("boolean"==typeof e?e:e>0)))}constructor(e){this.isSharingAllowedService=e}}eX=(0,r.gn)([(0,eO.e)(e$.B),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===Q?Object:Q])],eX);var eZ=i(17741),eJ=i(87254);class e0{execute(){return this.premiumSpaceGetter.get().pipe((0,z.w)(e=>{if((0,v.hx)(e))throw Error("Error retrieving space for user");return(0,v.db)(e).teamId?this.serverApiClient.v1.sharingUserdevice.getTeamLogins().pipe((0,eZ.Qn)(e=>({userLogins:e.data.teamLogins})),(0,eZ.DZ)(e=>{throw e})):(0,q.of)((0,v.Vp)({userLogins:[]}))}))}constructor(e,t){this.serverApiClient=e,this.premiumSpaceGetter=t}}e0=(0,r.gn)([(0,eO.e)(eJ.G),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===m.l?Object:m.l,void 0===Y.n?Object:Y.n])],e0);var e6=i(60568);class e1{execute(){return this.currentSpaceGetter.get().pipe((0,eZ.Qn)(e=>e.isSharingEnabled))}constructor(e){this.currentSpaceGetter=e}}e1=(0,r.gn)([(0,eO.e)(e6.N),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===Y.n?Object:Y.n])],e1);var e2=i(38012);class e4{execute({body:e}){let{itemIds:t}=e;return this.sharedItemsRepository.sharedItemsForIds$(t).pipe((0,W.U)(e=>(0,v.Vp)({sharedItems:e})))}constructor(e){this.sharedItemsRepository=e}}e4=(0,r.gn)([(0,eO.e)(e2.z),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===l.z?Object:l.z])],e4);var e5=i(20661),e9=i(90048);class e3{getCurrentUserLogin(){return this.context.get(e_.l.UserName)}execute({body:e}){let{itemIds:t}=e;return this.sharedItemsRepository.sharedAccessesById$(t).pipe((0,z.w)(e=>{let t=this.getCurrentUserLogin();if(!t)throw Error("No user login found to check sharing status for item");return this.userGroupRepository.acceptedUserGroupIdsForLogin$(t).pipe((0,W.U)(t=>Object.entries(e).reduce((e,[i,s])=>{let r=s.userGroups.some(({id:e,status:i})=>t.includes(e)&&"accepted"===i);return e[i]={isShared:!0,isSharedViaUserGroup:r},e},(0,y.Ay)({}))))}),(0,B.x)((e,t)=>(0,e5.Z)(e,t)),(0,W.U)(v.Vp))}constructor(e,t,i){this.userGroupRepository=e,this.context=t,this.sharedItemsRepository=i}}e3=(0,r.gn)([(0,eO.e)(e9.I),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===eT.x?Object:eT.x,void 0===e_.f?Object:e_.f,void 0===l.z?Object:l.z])],e3);var e7=i(51856);class e8{execute({body:e}){let{itemId:t}=e;return this.sharedItemsRepository.sharedItemForId$(t).pipe((0,W.U)(e=>{let t=e?e.sharingPermissionLevel:"full",i=this.roleCapabilityDefinitionService.getCapabilitiesForRole(t);return(0,v.Vp)({sharingPermissionLevel:e?.sharingPermissionLevel,capabilities:i})}))}constructor(e,t){this.sharedItemsRepository=e,this.roleCapabilityDefinitionService=t}}e8=(0,r.gn)([(0,eO.e)(e7.C),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===l.z?Object:l.z,void 0===eu?Object:eu])],e8);var te=i(16132);class tt{execute({body:e}){let{itemIds:t}=e;return this.sharedItemsRepository.sharedItemsForIds$(t).pipe((0,W.U)(e=>(0,v.Vp)(e.reduce((e,t)=>{let i=t.sharingPermissionLevel,s=this.roleCapabilityDefinitionService.getCapabilitiesForRole(i);return e[t.itemId]={sharingPermissionLevel:i,capabilities:s},e},{}))))}constructor(e,t){this.sharedItemsRepository=e,this.roleCapabilityDefinitionService=t}}tt=(0,r.gn)([(0,eO.e)(te.R),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===l.z?Object:l.z,void 0===eu?Object:eu])],tt);var ti=i(75427),ts=i(49219),tr=i(57178),tn=i(47244),ta=i(4495);class to{execute({body:{sharingIntent:e}}){return this.getTypes(e).pipe((0,eZ.lk)(e=>{let t=this.getPermissionsAndCapabilities(e);return(0,v.d6)(t)?(0,v.Vp)({defaultPermission:this.getDefaultPermission(),permissionItemTypeCapabilityMapping:t.data}):t}))}getTypes(e){if("collection"===e.type)return this.getTypesFromCollectionId(e.collectionId);let t=[er.nC.Credential,er.nC.SecureNote,er.nC.Secret];return 0===e.itemIds.length?(this.logger.error("No item ids provided in the sharing intent"),(0,q.of)((0,v.Vp)(t))):this.getTypesFromItemIds(e.itemIds).pipe((0,eZ.Qn)(i=>0===i.length?(this.logger.error("No shareable item found based on the list of ids",{itemIds:e.itemIds}),t):i))}getTypesFromCollectionId(e){return this.getTypesFromPrivateCollectionId(e).pipe((0,z.w)(t=>(0,v.hx)(t)?this.getTypesFromSharedCollectionId(e):(0,q.of)(t)),(0,eZ.Qn)(e=>0===e.length?[er.nC.Credential,er.nC.SecureNote]:e))}getTypesFromSharedCollectionId(e){return this.sharingCollectionsClient.queries.sharedCollectionsWithItems().pipe((0,eZ.lk)(t=>{let i=t.find(t=>t.id===e);return i?(0,v.Vp)(this.getTypesFromCollectionContent(i.vaultItems)):(0,v.Rn)((0,ti.yE)())}))}getTypesFromPrivateCollectionId(e){return this.vaultOrganizationClient.queries.queryCollections({ids:[e]}).pipe((0,eZ.lk)(({collections:t})=>{let i=t.find(t=>t.id===e);return i?(0,v.Vp)(this.getTypesFromCollectionContent(i.vaultItems)):(0,v.Rn)((0,ti.yE)())}))}getTypesFromCollectionContent(e){let t=[];return e.some(e=>e.type===er.nC.Credential)&&t.push(er.nC.Credential),e.some(e=>e.type===er.nC.Secret)&&t.push(er.nC.Secret),e.some(e=>e.type===er.nC.SecureNote)&&t.push(er.nC.SecureNote),t}getTypesFromItemIds(e){let t=[tr.U.Credential,tr.U.Secret,tr.U.SecureNote];return this.vaultItemsCrudClient.queries.query({ids:e,vaultItemTypes:t}).pipe((0,eZ.Qn)(e=>{let t=[];return e.credentialsResult.matchCount>0&&t.push(er.nC.Credential),e.secureNotesResult.matchCount>0&&t.push(er.nC.SecureNote),e.secretsResult.matchCount>0&&t.push(er.nC.Secret),t}))}getDefaultPermission(){return"view"}getPermissionsAndCapabilities(e){let t=this.roleCapabilityDefinitionService.getAllRoleDefinitions(),i={},s=e=>e in t;for(let r of["full","edit","view","restricted"].filter(s)){if("restricted"===r&&!e.includes(er.nC.Credential))continue;let n={};for(let a of(i[r]=n,e)){let e=r;if("restricted"===r&&a!==er.nC.Credential){if(!s("view"))return(0,v.Rn)((0,ti._r)());e="view"}let i=t[e],o={canAutofill:void 0,canReveal:i.canReveal,canCopy:i.canCopy,canEdit:i.canEdit,canShare:i.canShare};a===er.nC.Credential&&(o.canAutofill=!0),n[a]=o}}return(0,v.Vp)(i)}constructor(e,t,i,s,r){this.roleCapabilityDefinitionService=e,this.vaultItemsCrudClient=t,this.sharingCollectionsClient=i,this.vaultOrganizationClient=s,this.logger=r}}to=(0,r.gn)([(0,eO.e)(ti.G4),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===eu?Object:eu,void 0===tn.L?Object:tn.L,void 0===ts.L?Object:ts.L,void 0===ta.C?Object:ta.C,ep])],to);var tc=i(58881);let td=(e,t)=>({sharingPermissionLevel:e.sharingPermissionLevel,status:e.status,recipientId:e.id,recipientName:e.name,recipientType:t});class tl{execute({body:e}){let{itemId:t}=e;return this.sharedItemsRepository.sharedAccessForId$(t).pipe((0,W.U)(e=>{if(!e)return(0,v.Vp)(void 0);let t=e.sharedItemId,i=e.users.map(e=>td(e,S.IP.User)),s=e.userGroups.map(e=>td(e,S.IP.Group)),r=e.collections.map(e=>td(e,S.IP.Collection)),n={itemGroupId:t,count:i.length+s.length+r.length,users:i,groups:s,collections:r};return(0,v.Vp)(n)}))}constructor(e){this.sharedItemsRepository=e}}tl=(0,r.gn)([(0,eO.e)(tc.v),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===l.z?Object:l.z])],tl);var tu=i(58414),tp=i(34211);class th{getVaultItems(e,t,i,s){return this.vaultClient.queries.search({searchQuery:i,vaultItemTypes:e,propertyFilters:null!==s?[{property:"spaceId",value:s}]:void 0,ids:t})}execute({body:e}){let{userId:t,groupId:i,query:s,spaceId:r}=e;return this.sharedItemsStore.state$.pipe((0,z.w)(({sharedAccess:e,sharedItems:n})=>{let a=[];for(let s in e)t?e[s].users.some(e=>e.id===t)&&a.push(n[s].itemId):i&&e[s].userGroups.some(e=>e.id===i&&e.status!==S.qb.Revoked)&&a.push(n[s].itemId);return this.getVaultItems([tr.U.Credential,tr.U.SecureNote,tr.U.Secret],a,s,r).pipe((0,W.U)(e=>{if(!(0,v.d6)(e))throw Error("Unable to retrieve vault items");let t=e.data.credentialsResult.items,i=e.data.secureNotesResult.items,s=e.data.secretsResult.items;return(0,v.Vp)({sharedCredentials:t,sharedSecureNotes:i,sharedSecrets:s})}))}))}constructor(e,t){this.vaultClient=e,this.sharedItemsStore=t}}th=(0,r.gn)([(0,eO.e)(tu.v),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===tp.T?Object:tp.T,ec])],th);var tg=i(21222);class tm{execute(){return this.sharedItemsRepo.sharedItems$().pipe((0,W.U)(e=>(0,v.Vp)(e.map(e=>e.itemId))))}constructor(e){this.sharedItemsRepo=e}}tm=(0,r.gn)([(0,eO.e)(tg.c),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===l.z?Object:l.z])],tm);class tv{execute(){return this.store.state$.pipe((0,W.U)(e=>e.hasErrors?(0,v.Vp)(e.errors.reduce((e,t)=>{let{id:i,type:s,title:r,error:n}=t,a={id:i,title:r,reason:n};switch(s){case S.y2.Credential:e.credentialsErrors.push({...a,domain:t.domain,text:t.text});break;case S.y2.SecureNote:e.notesErrors.push({...a,color:t.color});break;default:e.secretsErrors.push({...a})}return e},{credentialsErrors:(0,y.Ay)([]),notesErrors:(0,y.Ay)([]),secretsErrors:(0,y.Ay)([])})):(0,v.Vp)({credentialsErrors:[],notesErrors:[],secretsErrors:[]})))}constructor(e){this.store=e}}tv=(0,r.gn)([(0,eO.e)(T.f),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[K])],tv);var ty=i(31862);class tw{execute(){let e=this.roleCapabilityDefinitionService.getAllRoleDefinitions();return(0,q.of)((0,v.Vp)(e))}constructor(e){this.roleCapabilityDefinitionService=e}}tw=(0,r.gn)([(0,eO.e)(ty.F),(0,r.w6)("design:type",Function),(0,r.w6)("design:paramtypes",[void 0===eu?Object:eu])],tw);var tS=i(77261),tf=i(89005),tE=i(36159),tI=i(71318),tb=i(90735);class tA{}tA=(0,r.gn)([(0,n.Y)({api:d.X,providers:[(0,a.d_)(ep),G,Q,ee,el,Z,eu,{provide:l.z,useClass:ed},{provide:p,useClass:C}],exports:[l.z],stores:[K,ec],handlers:{commands:{updateSharedItemPermission:ey,revokeSharedItem:eS,refuseSharedItem:eE,refuseSharedItemBeforeDeletion:eU,shareItems:ex,updateSharedItemContent:eV},events:{},queries:{getSharedAccess:eK,getSharedAccessForItemIds:ez,getSharedItems:eB,getSharedItemForId:eH,isSharingAllowed:eX,getSharingTeamLogins:e0,sharingEnabled:e1,getSharedItemsForItemIds:e4,getSharingStatusForItem:eF,getSharingStatusForItems:e3,getPermissionForItem:e8,getPermissionForItems:tt,getIsLastAdminForItem:eD,permissionsAndCapabilities:to,sharedAccessForItem:tl,getUserSharedVaultItems:th,sharedItemsIds:tm,shareItemsErrors:tv,roleCapabilityDefinition:tw}},imports:[c.n,tf.y,tE.I,tS.a,tI.k,tb.u,o.G]})],tA)},90735:function(e,t,i){i.d(t,{u:()=>T});var s=i(21636),r=i(48035),n=i(4466),a=i(63762),o=i(59982),c=i(68238),d=i(15021),l=i(20458);let u=a.z.object({groupId:a.z.string(),name:a.z.string(),revision:a.z.number(),publicKey:a.z.string(),privateKey:a.z.string(),acceptedUsers:a.z.array(a.z.string()),allUsers:a.z.array(a.z.string()),groupKey:a.z.string().optional()}),p=a.z.object({userGroups:a.z.record(u)}),h=e=>p.safeParse(e).success;class g extends(0,o.Q)({persist:!0,storage:{initialValue:{userGroups:{}},typeGuard:h,schemaVersion:1},scope:d.F.User,storeName:"sharing-user-groups-state",storeTypeGuard:h,codec:l.E,isCache:!0,capacity:c.Y.Unlimited}){}var m=i(19425),v=i(42589),y=i(94190),w=i(18550);class S{async getUserGroups(){let{userGroups:e}=await this.userGroupsStore.getState();return Object.keys(e).reduce((t,i)=>{let{groupId:s,name:r,revision:n,acceptedUsers:a,privateKey:o,publicKey:c,groupKey:d}=e[i];return t[i]={groupId:s,name:r,revision:n,privateKey:o,publicKey:c,acceptedUsers:a,groupKey:d},t},(0,w.Ay)({}))}async getAcceptedUserGroupsForLogin(e){return Object.values(await this.getUserGroups()).filter(t=>t.acceptedUsers?.includes(e))}setUserGroups(e){let t=e.reduce((e,t)=>(e[t.groupId]={...t,allUsers:t.allUsers??[],acceptedUsers:t.acceptedUsers??[]},e),(0,w.Ay)({}));this.userGroupsStore.set({userGroups:t})}async getUserGroup(e){let{userGroups:t}=await this.userGroupsStore.getState(),i=t[e];if(!i)return null;let{groupId:s,name:r,revision:n,acceptedUsers:a,privateKey:o,publicKey:c,groupKey:d}=i;return{groupId:s,name:r,revision:n,privateKey:o,publicKey:c,groupKey:d,users:[],acceptedUsers:a}}async getUserGroupsForIds(e){let{userGroups:t}=await this.userGroupsStore.getState();return e.reduce((e,i)=>{let s=t[i];if(s){let{groupId:t,name:i,revision:r,acceptedUsers:n,privateKey:a,publicKey:o,groupKey:c}=s;e.push({groupId:t,name:i,revision:r,privateKey:a,publicKey:o,groupKey:c,acceptedUsers:n})}return e},(0,w.Ay)([]))}async getUserGroupForId(e){let t=await this.getUserGroupsForIds([e]);if(!t.length)throw Error("Failed to retrieve user group by id");return t[0]}acceptedUserGroupIdsForLogin$(e){return this.userGroupsStore.state$.pipe((0,v.U)(t=>Object.values(t.userGroups).filter(t=>t.acceptedUsers.includes(e)).map(e=>e.groupId)))}constructor(e){this.userGroupsStore=e}}S=(0,s.gn)([(0,y.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[g])],S);var f=i(1833),E=i(3750),I=i(62506),b=i(306),A=i(82986);class C{execute(){return(0,f.D)(this.userGroupsRepo.getUserGroups()).pipe((0,v.U)(e=>{let t=[],i=this.context.get(E.l.UserName)??"";for(let s in e){let r=e[s];r.acceptedUsers?.includes(i)&&t.push({id:r.groupId,name:r.name,users:r.acceptedUsers})}return(0,b.Vp)(t)}))}constructor(e,t){this.userGroupsRepo=e,this.context=t}}C=(0,s.gn)([(0,I.e)(A.J),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===m.x?Object:m.x,void 0===E.f?Object:E.f])],C);var R=i(13256);class _{execute({body:e}){let{id:t}=e;return(0,f.D)(this.userGroupsRepo.getUserGroupForId(t)).pipe((0,v.U)(e=>{let t={id:e.groupId,name:e.name,users:e.acceptedUsers??[]};return(0,b.Vp)(t)}))}constructor(e){this.userGroupsRepo=e}}_=(0,s.gn)([(0,I.e)(R.e),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===m.x?Object:m.x])],_);var O=i(89005);class T{}T=(0,s.gn)([(0,r.Y)({api:n.A,providers:[{provide:m.x,useClass:S}],stores:[g],handlers:{commands:{},events:{},queries:{getAllAcceptedGroups:C,getSharingGroupById:_}},imports:[O.y],exports:[m.x]})],T)},19425:function(e,t,i){i.d(t,{x:()=>s});class s{}},75719:function(e,t,i){i.d(t,{D:()=>F});var s=i(21636),r=i(48035),n=i(22636),a=i(37368),o=i(30874),c=i(44577),d=i(306),l=i(57178),u=i(47244),p=i(26342),h=i(79791);class g{async execute(){let e=await (0,c.z)(this.currentSpaceGetter.get());if((0,d.hx)(e))throw Error("Error fetching current space when moving shared collection items to business space");let t=(0,d.db)(e).teamId;if(!t)return(0,d.Vp)(void 0);let i=(await (0,c.z)(this.sharedItemsRepository.sharedItems$())).reduce((e,t)=>t.recipientIds.collectionIds?.length?[...e,t.itemId]:e,[]);if(i.length&&(await Promise.all(i.map(e=>this.moveItemToBusinessSpace(e,t)))).some(d.hx))throw Error("Error when moving shared collection items to business space");return(0,d.Vp)(void 0)}async moveItemToBusinessSpace(e,t){let{commands:i}=this.vaultItemsCrudClient,s=await (0,c.z)(this.vaultItemsCrudClient.queries.query({vaultItemTypes:[l.U.Credential,l.U.SecureNote],ids:[e]}));if((0,d.hx)(s))return Promise.resolve((0,d.Rn)(void 0));let r=(0,d.db)(s).credentialsResult,n=(0,d.db)(s).secureNotesResult,a=r.matchCount>0,o=n.matchCount>0;return(a||o)&&(a?r.items[0]:n.items[0]).spaceId!==t?i.updateVaultItem({vaultItemType:a?l.U.Credential:l.U.SecureNote,id:e,content:{spaceId:t},shouldSkipSync:!0}):Promise.resolve((0,d.Vp)(void 0))}constructor(e,t,i){this.sharedItemsRepository=e,this.vaultItemsCrudClient=t,this.currentSpaceGetter=i}}g=(0,s.gn)([(0,a.W)(o.g),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.z?Object:p.z,void 0===u.L?Object:u.L,void 0===h.n?Object:h.n])],g);var m=i(56144),v=i(42589),y=i(49247),w=i(19855),S=i(62642),f=i(51623),E=i(69369),I=i(1349);let b=async(e,t=2)=>{let i=[...e],s=0;for(;i.length;){let e=i.splice(0,t).map(e=>e());s+=(await Promise.all(e)).length}return s};class A{async execute(e){let{body:{vaultItemIds:t,pendingInvitesIds:i,shouldRunSync:s}}=e;if(!t.length&&!i.length)return s&&this.sharingSync.scheduleSync(),(0,d.Vp)(void 0);let r=i.map(e=>()=>this.refusePendingInvite(e)),n=await b(r),a=await this.getRevokeSharedItemsTasks(t),o=await b(a);return(s||n>0||o>0)&&this.sharingSync.scheduleSync(),(0,d.Vp)(void 0)}async refusePendingInvite(e){let t=await this.refuseSharedItemService.execute(e);if((0,d.hx)(t))throw Error("Failure to refuse pending invite for a force categorized item");return(0,d.db)(t)}async getRevokeSharedItemsTasks(e){if(!e.length)return[];let[t,i]=await Promise.all([this.getCurrentUserLogin(),(0,c.z)(this.sharedItemsRepository.sharedItemsForIds$(e))]);return i.map(e=>()=>this.revokeSharedItem(e,t))}async revokeSharedItem({isLastAdmin:e,revision:t,recipientIds:{userIds:i,collectionIds:s,userGroupIds:r},sharedItemId:n,itemId:a,sharingPermissionLevel:o},c){let l=i?.filter(e=>e!==c);if(e&&(l||s||r)){let e=await this.commonGateway.revokeItemGroupMembers({itemGroupId:n,revision:t,userLogins:l?.length?l:void 0,collectionIds:s??void 0,userGroupIds:r??void 0});if((0,d.hx)(e))throw Error("Revoke shared item failed in remote control");return await this.sharingSync.scheduleSync(),(0,d.Vp)(e)}let u=await this.commonGateway.refuseItemGroup({itemGroupId:n,revision:t});return"full"===o?this.duplicateVaultItem(a):u}async duplicateVaultItem(e){let{commands:{duplicateVaultItem:t}}=this.carbonClient,i=await t({vaultItemId:e});if((0,d.hx)(i))throw Error("Failed to duplicate a shared item that is revoked because of forced catgorization");return(0,d.db)(i)}getCurrentUserLogin(){return(0,c.z)(this.sessionClient.queries.selectedOpenedSession().pipe((0,m.h)(d.d6),(0,v.U)(d.db),(0,m.h)(e=>"string"==typeof e&&""!==e)))}constructor(e,t,i,s,r,n){this.sharedItemsRepository=e,this.commonGateway=t,this.carbonClient=i,this.sessionClient=s,this.sharingSync=r,this.refuseSharedItemService=n}}A=(0,s.gn)([(0,a.W)(S.v),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.z?Object:p.z,void 0===f.b_?Object:f.b_,void 0===y._?Object:y._,void 0===w.x?Object:w.x,void 0===I.D?Object:I.D,void 0===E.C?Object:E.C])],A);var C=i(36159),R=i(89005),_=i(77261),O=i(78631),T=i(81778);class F{}F=(0,s.gn)([(0,r.Y)({api:n.X,handlers:{commands:{remoteControlSharedItems:A,moveCollectionItemsToBusinessSpace:g},events:{},queries:{}},domainName:"sharing",imports:[C.I,R.y,_.a,O.F,T.p]})],F)},81173:function(e,t,i){i.d(t,{P:()=>eN});var s=i(21636),r=i(44577),n=i(37368),a=i(59242),o=i(306),c=i(89242),d=i(4274),l=i(18550),u=i(94190),p=i(19425);let h=(e,t)=>Object.keys(t).filter(t=>!e.find(e=>e.id===t)),g=e=>e.reduce((e,t)=>{let{current:i,hasChanges:s}=t;return i?s?e.updatedIds.push(t.id):e.unchanged.push(i):e.newIds.push(t.id),e},{newIds:[],updatedIds:[],unchanged:[]}),m=(e,t)=>e.reduce((e,i)=>{if(i.id in t){let s=t[i.id];s.revision<i.revision?e.updatedIds.push(i.id):e.unchanged.push(s)}else e.newIds.push(i.id);return e},{newIds:(0,l.Ay)([]),updatedIds:(0,l.Ay)([]),unchanged:(0,l.Ay)([])});var v=i(33506),y=i(71749),w=i(70727),S=i(32303);let f=e=>{switch(e.accessType){case d.Uv.UserGroup:return e.groupPublicKey;case d.Uv.CollectionUserGroup:case d.Uv.CollectionUser:return e.collectionPublicKey}},E=(e,t,i,s)=>{let r={vaultItemId:e.itemId,title:t.Title,spaceId:t.SpaceId,referrer:i.referrer,sharedItemId:e.sharedItemId,sharingPermissionLevel:i.sharingPermissionLevel,revision:s};return(0,y.G)(t)?{...r,itemType:d.y2.Credential,url:t.Url,linkedDomains:t.LinkedServices?.associated_domains.map(e=>e.domain),email:t.Email,login:t.Login,secondaryLogin:t.SecondaryLogin}:(0,w.g)(t)?{...r,itemType:d.y2.SecureNote,color:t.Type,secured:t.Secured}:{...r,itemType:d.y2.Secret,secured:t.Secured}},I=(e,t)=>{let i=e.collections;if(i&&i.length>0)return!1;let{users:s,groups:r}=e,n=!r||0===r.filter(e=>e.status===d.qb.Accepted||e.status===d.qb.Pending).length,a=s&&1===s.filter(e=>e.status===d.qb.Accepted||e.status===d.qb.Pending).length&&s[0].userId===t&&s[0].status===d.qb.Accepted&&s[0].permission===d.y3.Admin;return n&&!!a},b=({status:e})=>e&&![d.qb.Refused,d.qb.Revoked].includes(e),A=e=>({users:e.users?.reduce((e,t)=>(b(t)&&e.push({id:t.userId,name:t.alias,sharingPermissionLevel:S.m(t.permission),status:t.status}),e),l.Ay([]))??[],userGroups:e.groups?.reduce((e,t)=>(b(t)&&e.push({id:t.groupId,name:t.name,sharingPermissionLevel:S.m(t.permission),status:t.status}),e),l.Ay([]))??[],collections:e.collections?.reduce((e,t)=>(b(t)&&e.push({id:t.uuid,name:t.name,sharingPermissionLevel:S.m(t.permission),status:t.status}),e),l.Ay([]))??[]});var C=i(99481);class R extends(0,C.ne)(){}var _=i(59283),O=i(53800);let T={module:"sharing sync"};class F{async isUserGroupValid(e,t){let{publicKey:i,login:s}=t,r=e.users.find(e=>e.userId===s);if(!r?.groupKey?.length)return!1;if(r.status===d.qb.Pending)return r;if(r.status!==d.qb.Accepted||!r.acceptSignature)return!1;let n=await this.sharingCryptoUtility.decryptResourceKeyViaUserMember({encryptedResourceKey:r.groupKey},t);return!!n&&this.sharingCryptoElements.verifyAcceptSignature(i,r.acceptSignature,e.groupId,n)}async isSharedItemValid(e,t){return this.isSharedItemAccessValid(e.sharedItemId,e.accessLink,t)}async isSharedItemAccessValid(e,t,i){let{publicKey:s}=i;if(!t?.acceptSignature)return this.logger.debug("Item access is invalid, no accept signature found",{...T,sharedItemId:e,accessType:t?.accessType}),{isValid:!1};let{acceptSignature:r}=t,n=await this.sharingCryptoUtility.decryptItemGroupKeyFromAccessLink(t,i);return n?await this.sharingCryptoElements.verifyAcceptSignature(f(t)??s,r,e,n)?{isValid:!0,itemGroupKey:n}:(this.logger.debug("Item access is invalid, accept signature is invalid",{...T,sharedItemId:e,accessType:t.accessType}),{isValid:!1}):(this.logger.debug("Item access is invalid, no itemGroup key found",{...T,sharedItemId:e,accessType:t.accessType}),{isValid:!1})}constructor(e,t,i){this.sharingCryptoUtility=e,this.sharingCryptoElements=t,this.logger=i}}F=(0,s.gn)([(0,u.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===_.Z?Object:_.Z,void 0===O.M?Object:O.M,R])],F);class D{async getUserGroupChangesFromSummary(e){let t=await this.userGroupsRepo.getUserGroups(),{newIds:i,updatedIds:s,unchanged:r}=await m(e,t);return{newUserGroupIds:i,updateUserGroupIds:s,unchangedUserGroups:r,revokedUserGroupIds:h(e,t),isUserGroupsSyncNeeded:s.length||Object.keys(t).length!==e.length}}async syncUserGroups(e,t,i){let{validatedUserGroupDownloads:s,pendingInvites:r}=await e.reduce(async(e,t)=>{if("users"!==t.type)return e;let s=await this.validationService.isUserGroupValid(t,i),r=await e;if(s&&r.validatedUserGroupDownloads.push(t),"boolean"!=typeof s){let{referrer:e}=s;r.pendingInvites.push({referrer:e,id:t.groupId,name:t.name})}return e},Promise.resolve({validatedUserGroupDownloads:(0,l.Ay)([]),pendingInvites:(0,l.Ay)([])})),n=s.map(e=>this.mapToUserGroupStateModel(e,i.login));this.userGroupsRepo.setUserGroups(t.concat(n));let a=t.map(e=>e.groupId),o=(await this.pendingInvitesService.getUserGroupInvites()).filter(e=>a.includes(e.id)).concat(r);this.pendingInvitesService.setUserGroupInvites(o)}mapToUserGroupStateModel(e,t){let{groupId:i,name:s,revision:r,users:n,privateKey:a,publicKey:o}=e,c=[],l=[],u="";return n.forEach(e=>{e.status===d.qb.Accepted&&c.push(e.userId),e.userId===t&&(u=e.groupKey??""),l.push(e.userId)}),{groupId:i,name:s,revision:r,acceptedUsers:c,publicKey:o,privateKey:a,groupKey:u,allUsers:l}}constructor(e,t,i){this.userGroupsRepo=e,this.validationService=t,this.pendingInvitesService=i}}D=(0,s.gn)([(0,u.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===p.x?Object:p.x,void 0===F?Object:F,void 0===v.M?Object:v.M])],D);var U=i(44145),P=i(17231),x=i(79583);class N{async getCollectionsChangesFromSummary(e,t){let i=await this.collectionsRepo.getCollections(),{newIds:s,updatedIds:r,unchanged:n}=g(await Promise.all(e.map(async({id:e,revision:s})=>{let r=i[e];if(!(e in i))return{id:e};let n=r.revision<s,a=await this.getCollectionSharedAccess(r),o=a?.userGroups.some(e=>t.includes(e.id))??!1;return{id:e,current:r,hasChanges:n||o}}))),a=h(e,i),o=Object.keys(i).length,c=e.length,d=r.length||o!==c;return{newCollectionIds:s,updatedCollectionIds:r,unchangedCollections:n,revokedCollectionIds:a,isCollectionsSyncNeeded:d}}getCollectionSharedAccess(e){return(0,r.z)(this.collectionsRepo.sharedCollectionsAccessForId$(e.id))}async syncCollections(e,t,i){let s=Object.values(await this.userGroupsRepo.getUserGroups()),{validatedCollections:r,pendingInvites:n,validatedSharedCollectionAccess:a}=await e.reduce(async(e,t)=>{let r=(0,P.E)(t,s,i.login),n=t.users?.find(e=>e.login===i.login&&e.status===d.qb.Pending),a=n||await this.isCollectionValid(r,i),o=await e;if(a&&(o.validatedCollections.push(r),o.validatedSharedCollectionAccess[r.id]={users:t.users?.map(e=>({id:e.login,name:e.login,sharedCollectionRole:S.c(e.permission),status:e.status}))??[],userGroups:t.userGroups?.map(e=>({id:e.uuid,name:e.name,sharedCollectionRole:S.c(e.permission),status:e.status}))??[]}),n){let{referrer:e,permission:t}=n;o.pendingInvites.push({referrer:e,sharedCollectionRole:(0,S.c)(t),id:r.id,name:r.name})}return e},Promise.resolve({validatedCollections:(0,l.Ay)([]),pendingInvites:(0,l.Ay)([]),validatedSharedCollectionAccess:(0,l.Ay)({})}));this.collectionsRepo.setCollections(t.concat(r),a);let o=t.map(e=>e.id),c=(await this.pendingInvitesService.getCollectionsInvites()).filter(e=>o.includes(e.id)).concat(n);this.pendingInvitesService.setCollectionInvites(c)}async isCollectionValid(e,t){let{publicKey:i}=t;if(!e.accessLink?.acceptSignature)return!1;let{acceptSignature:s}=e.accessLink,r=await this.sharingCryptoUtility.decryptSharedCollectionKey(e,t);return!!r&&this.sharingCryptoElements.verifyAcceptSignature(e.accessLink.accessType===x.o.UserGroup?e.accessLink.groupPublicKey??i:i,s,e.id,r)}constructor(e,t,i,s,r){this.collectionsRepo=e,this.userGroupsRepo=t,this.sharingCryptoElements=i,this.sharingCryptoUtility=s,this.pendingInvitesService=r}}N=(0,s.gn)([(0,u.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===U.G?Object:U.G,void 0===p.x?Object:p.x,void 0===O.M?Object:O.M,void 0===_.Z?Object:_.Z,void 0===v.M?Object:v.M])],N);var L=i(74019),k=i(58060),j=i(26342),G=i(57178),V=i(47244),M=i(49247);class K{async runVaultUpdates(e,t){let{itemRevisions:i,itemsToSave:s}=(await Promise.all(e.map(async e=>{let i=t[e.itemId];if(!i)return null;let s=await this.decryptItemContent(i,e.content);return{vaultItemId:e.itemId,id:i.sharedItemId,revision:e.timestamp,itemToSave:s}}))).reduce((e,t)=>{if(t){t.itemToSave&&e.itemsToSave.push(t.itemToSave);let{id:i,vaultItemId:s,revision:r}=t;e.itemRevisions.push({sharedItemId:i,vaultItemId:s,revision:r,savedToVault:!0})}return e},{itemRevisions:(0,l.Ay)([]),itemsToSave:(0,l.Ay)([])}),r=await this.carbonLegacyClient.commands.saveSharedItemsToVault({items:s});return(0,o.hx)(r)?null:i}decryptItemContent(e,t){return this.sharingCrypto.decryptSharedItemContent(e,t)}async getVaultItemsPerType(e){let t=await (0,r.z)(this.vaultItemsCrudClient.queries.query({vaultItemTypes:[G.U.Credential,G.U.Secret,G.U.SecureNote],ids:e}));if((0,o.hx)(t))throw Error("Could not access the vault items to run sharing sync");return(0,o.db)(t)}async deleteVaultItems(e){let t=await this.getVaultItemsPerType(e),i=[],s=[];if(t.credentialsResult.matchCount){let e=t.credentialsResult.items.map(e=>e.id),r=await this.vaultItemsCrudClient.commands.deleteVaultItems({vaultItemType:G.U.Credential,ids:e}).catch();i.push(...e),(0,o.hx)(r)&&s.push(...(0,o.Yv)(r).failedDeletionIds)}if(t.secureNotesResult.matchCount){let e=t.secureNotesResult.items.map(e=>e.id),r=await this.vaultItemsCrudClient.commands.deleteVaultItems({vaultItemType:G.U.SecureNote,ids:e}).catch();i.push(...e),(0,o.hx)(r)&&s.push(...(0,o.Yv)(r).failedDeletionIds)}if(t.secretsResult.matchCount){let e=t.secretsResult.items.map(e=>e.id),r=await this.vaultItemsCrudClient.commands.deleteVaultItems({vaultItemType:G.U.Secret,ids:e}).catch();i.push(...e),(0,o.hx)(r)&&s.push(...(0,o.Yv)(r).failedDeletionIds)}let r=i.filter(e=>!s.includes(e));await this.vaultItemsCrudClient.commands.deleteChangeHistoryForVaultItems({ids:r})}constructor(e,t,i){this.sharingCrypto=e,this.vaultItemsCrudClient=t,this.carbonLegacyClient=i}}K=(0,s.gn)([(0,u.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===_.Z?Object:_.Z,void 0===V.L?Object:V.L,void 0===M._?Object:M._])],K);var W=i(57499);let z=(e,t,i)=>{let s=e.users?.filter(e=>e.userId===t&&(e.status===d.qb.Accepted||!i&&e.status===d.qb.Pending)&&e.groupKey),r=e.users?.some(({userId:e,permission:i,rsaStatus:s,status:r})=>e!==t&&i===d.y3.Admin&&"sharingKeys"===s&&r===d.qb.Accepted)??!1;if(s?.length){let e=s.find(e=>e.status===d.qb.Accepted);if(e||i||(e=s.find(e=>e.status===d.qb.Pending)),e?.groupKey){let{permission:t,acceptSignature:i,proposeSignature:n}=e,a={sharingPermissionLevel:(0,S.m)(t),acceptSignature:i,proposeSignature:n,encryptedResourceKey:e.groupKey,accessType:d.Uv.User},o=(0,W.u)(s.filter(e=>e.status===d.qb.Accepted));return{link:a,sharingPermissionLevel:(0,S.m)(o),otherAdminsFound:r}}}return{sharingPermissionLevel:"restricted",otherAdminsFound:r}},q=(e,t)=>{let i=e.groups?.filter(e=>t.some(t=>t.groupId===e.groupId)&&e.status===d.qb.Accepted&&e.groupKey);if(i?.length){let e=i[0],s=(0,W.u)(i);if(e.groupKey){let{permission:i,acceptSignature:r,proposeSignature:n}=e,a=t.find(t=>t.groupId===e.groupId);if(a?.groupKey)return{link:{sharingPermissionLevel:(0,S.m)(i),acceptSignature:r,proposeSignature:n,encryptedResourceKey:e.groupKey,groupEncryptedKey:a.groupKey,groupPrivateKey:a.privateKey,groupPublicKey:a.publicKey,accessType:d.Uv.UserGroup},sharingPermissionLevel:(0,S.m)(s)}}}return null},B=(e,t)=>{let i={sharingPermissionLevel:"restricted"};if(!e)return i;for(let s of e)if(s.status===d.qb.Accepted&&s.itemGroupKey){if(i.sharingPermissionLevel=(0,S.m)(s.permission),!i.collection||i.collection.accessLink?.accessType!==x.o.User){let e=t.find(e=>e.id===s.uuid&&e.accessLink);e&&(i.collection=e,i.member=s)}if("full"===i.sharingPermissionLevel&&i.collection?.accessLink?.accessType===x.o.User)break}return i},Y=(e,t)=>{let i=B(e.collections,t);if(i.collection&&i.member){let{collection:e,member:t}=i,{permission:s,acceptSignature:r,proposeSignature:n,itemGroupKey:a}=t,o=(0,S.m)(s);if(a){if(e.accessLink?.accessType===x.o.User){let{encryptedResourceKey:t}=e.accessLink;if(t)return{link:{sharingPermissionLevel:o,acceptSignature:r,proposeSignature:n,encryptedResourceKey:a,collectionEncryptedKey:t,collectionPrivateKey:e.privateKey,collectionPublicKey:e.publicKey,accessType:d.Uv.CollectionUser},sharingPermissionLevel:i.sharingPermissionLevel}}else if(e.accessLink?.accessType===x.o.UserGroup){let{encryptedResourceKey:t,groupPublicKey:s,groupPrivateKey:c,groupEncryptedKey:l}=e.accessLink;if(t)return{link:{sharingPermissionLevel:o,acceptSignature:r,proposeSignature:n,encryptedResourceKey:a,collectionEncryptedKey:t,collectionPrivateKey:e.privateKey,collectionPublicKey:e.publicKey,groupEncryptedKey:l,groupPublicKey:s,groupPrivateKey:c,accessType:d.Uv.CollectionUserGroup},sharingPermissionLevel:i.sharingPermissionLevel}}}}return null},Q=(...e)=>e.find(e=>e?.link)??e[0],H=({permission:e,status:t})=>e===d.y3.Admin&&t===d.qb.Accepted,$=(e,t,i,s)=>{let r=z(e,t),n=!!r?.otherAdminsFound||!!e.groups?.some(H)||!!e.collections?.some(H);if(null!==r&&"full"===r.sharingPermissionLevel&&r.link?.acceptSignature)return{...r,otherAdminsFound:n};let a=q(e,i);if(null!==a&&"full"===a.sharingPermissionLevel)return{...Q(r,a),sharingPermissionLevel:"full",otherAdminsFound:n};let o=Y(e,s);if(null===a&&null===o&&null!==r&&!r.link?.acceptSignature)return{...r,otherAdminsFound:n};let c=z(e,t,!0);return{...Q(c,a,o),sharingPermissionLevel:(0,W.B)([c,a,o]),otherAdminsFound:n}},X=(e,t,i,s)=>{let r=$(e,s,t,i),{items:n,revision:a,groupId:o,groups:c,collections:d,users:l}=e,u=n?.[0];if(!u)throw Error("No items associated with item group");let{itemId:p,itemKey:h}=u,g=r?.sharingPermissionLevel==="full"&&!r.otherAdminsFound;return{sharingPermissionLevel:r?.sharingPermissionLevel??"restricted",accessLink:r?.link,itemId:p,itemKey:h,sharedItemId:o,revision:a,isLastAdmin:g,recipientIds:{userIds:l?.map(({userId:e})=>e)??null,collectionIds:d?.map(({uuid:e})=>e)??null,userGroupIds:c?.map(({groupId:e})=>e)??null}}},Z=(e,t)=>e.reduce((e,i)=>(e[t(i)]=i,e),(0,l.Ay)({}));var J=i(51623),ee=i(15255);let et={moduleName:"SharingSyncModule",useCaseName:"sharing-sync-resend-invites.service",applicationComponent:"Sharing"};class ei{async checkPublicKeysAndResendInvites(e,t,i){if(!t.accessLink)return;let s=(e.users||[]).filter(e=>"publicKey"===e.rsaStatus&&!0===e.proposeSignatureUsingAlias);s.length&&this.logger.debug("New public key users found, resending sharing invites",{module:"sharing sync",publicKeyUsersLength:s.length});let r=s.map(e=>this.resendPublicKeyInvite(e,t,i));await Promise.all(r)}async resendPublicKeyInvite(e,t,i){try{if(!e.proposeSignature){this.reportWarning("Missing propose signature when re-sending invite",JSON.stringify({itemGroupId:t.sharedItemId}));return}if(!await this.sharingCrypto.verifyProposeSignature(i,e.userId,e.proposeSignature)){this.reportWarning("Invalid propose signature when re-sending invite",JSON.stringify({itemGroupId:t.sharedItemId}));return}let s=await this.sharingUsersService.createSignedUserInvites([{login:e.userId,permission:e.permission}],{resourceKey:i,uuid:t.sharedItemId},!1);s.length||this.reportWarning("Cannot create invite to re-sending invite",JSON.stringify({itemGroupId:t.sharedItemId})),await this.sharingCommonGateway.updateItemGroupMembers({revision:t.revision,groupId:t.sharedItemId,users:[{userId:e.userId,groupKey:s[0].resourceKey,proposeSignature:s[0].proposeSignature}]})}catch(e){this.reportError("Error when trying to resend an invite",{itemGroupId:t.sharedItemId,error:e})}}reportError(e,t){this.exceptionLoggingClient.commands.reportAnomaly({...et,criticality:L.h_.CRITICAL,message:e,anomalyType:"exception",origin:"uncaughtException",additionalInfo:JSON.stringify(t)})}reportWarning(e,t){this.exceptionLoggingClient.commands.reportAnomaly({...et,criticality:L.h_.WARNING,message:e,anomalyType:"other",additionalInfo:JSON.stringify(t)})}constructor(e,t,i,s,r){this.sharingCrypto=e,this.sharingUsersService=t,this.sharingCommonGateway=i,this.exceptionLoggingClient=s,this.logger=r}}ei=(0,s.gn)([(0,u.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===O.M?Object:O.M,void 0===ee.E?Object:ee.E,void 0===J.b_?Object:J.b_,void 0===k.G?Object:k.G,R])],ei);class es{async resolvePendingInvites(e,t,i,s){let r=Z(e,e=>e.itemId),n=Z((await this.pendingInvitesService.getSharedItemsInvites()).filter(e=>t.some(t=>t.sharedItemId===e.sharedItemId&&!t.accessLink?.acceptSignature)),e=>e.sharedItemId),a=await i.reduce(async(e,t)=>{let i=await this.resolvePendingInvite(t,r,s,n);return i&&(await e).push(i),e},Promise.resolve((0,l.Ay)([])));return this.pendingInvitesService.setSharedItemInvites(a),a}async resolvePendingInvite(e,t,i,s){let r=i[e.sharedItemId],n=s[e.sharedItemId];if(r||n){let i=r??{sharingPermissionLevel:n.sharingPermissionLevel,referrer:n.referrer,sharedItemId:e.sharedItemId,vaultItemId:e.itemId},s=await this.decryptItemContentAndConvertToInvite(t,e,i);if(s)return s}if(n)return n}async decryptItemContentAndConvertToInvite(e,t,i){let s=e[t.itemId];if(s){let e=await this.vaultUpdatesService.decryptItemContent(t,s.content);if(e)return E(t,e,i,s.timestamp)}}constructor(e,t){this.vaultUpdatesService=e,this.pendingInvitesService=t}}es=(0,s.gn)([(0,u.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===K?Object:K,void 0===v.M?Object:v.M])],es);var er=i(17242),en=i(4495);class ea{async deleteLastAdminSharedItem(e){let t,i;let s=await this.vaultUpdatesService.getVaultItemsPerType([e.itemId]);if(s.credentialsResult.matchCount){t=G.U.Credential;let{id:e,...r}=s.credentialsResult.items[0];i=r}else if(s.secureNotesResult.matchCount){t=G.U.SecureNote;let{id:e,...r}=s.secureNotesResult.items[0];i=r}else{if(!s.secretsResult.matchCount)return;t=G.U.Secret;let{id:e,...r}=s.secretsResult.items[0];i=r}let n=await this.vaultItemsCrudClient.commands.createVaultItem({vaultItemType:t,content:i,shouldSkipSync:!1,origin:"IMPORT"});if(!(0,o.d6)(n))return;let a=await this.sharingCommonGateway.deleteItemGroup({groupId:e.sharedItemId,revision:e.revision});if(!(0,o.d6)(a)){this.exceptionLoggingClient.commands.reportAnomaly({criticality:L.h_.CRITICAL,message:"Error when trying to delete an item group during the unshare item process",moduleName:"SharingSyncModule",useCaseName:"sharing-sync-last-admin.service",applicationComponent:"Sharing",anomalyType:"exception",origin:"uncaughtException"}),await this.vaultItemsCrudClient.commands.deleteVaultItem({id:n.data.id,vaultItemType:t});return}let c=await (0,r.z)(this.vaultOrganizationClient.queries.queryCollections({}));if(await this.vaultItemsCrudClient.commands.deleteVaultItem({id:e.itemId,vaultItemType:t,ignoreSharing:!0}),(0,o.d6)(c)&&c.data.collections.length>0){let t=c.data.collections.filter(t=>t.vaultItems.some(t=>t.id===e.itemId)),i={vaultItems:[{id:e.itemId,type:G.U.Credential}]},s={vaultItems:[{id:n.data.id,type:G.U.Credential}]};for(let e of t)await this.vaultOrganizationClient.commands.updateCollection({id:e.id,collection:i,operationType:er.C.SUBSTRACT_VAULT_ITEMS}),await this.vaultOrganizationClient.commands.updateCollection({id:e.id,collection:s,operationType:er.C.APPEND_VAULT_ITEMS})}}constructor(e,t,i,s,r){this.vaultUpdatesService=e,this.sharingCommonGateway=t,this.vaultItemsCrudClient=i,this.vaultOrganizationClient=s,this.exceptionLoggingClient=r}}ea=(0,s.gn)([(0,u.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===K?Object:K,void 0===J.b_?Object:J.b_,void 0===V.L?Object:V.L,void 0===en.C?Object:en.C,void 0===k.G?Object:k.G])],ea);class eo{async getItemsChangesFromSummary(e,t){let i=await this.sharedItemsRepo.getVaultItemsIndex(),{newItemsIds:s,updatedItemsIds:r,unchangedItems:n}=e.reduce((e,s)=>{let r=i[s.id];return r?r.revision<s.timestamp||!r.savedToVault&&t.includes(r.sharedItemId)?e.updatedItemsIds.push(s.id):e.unchangedItems.push(r):e.newItemsIds.push(s.id),e},{newItemsIds:(0,l.Ay)([]),updatedItemsIds:(0,l.Ay)([]),unchangedItems:(0,l.Ay)([])}),a=h(e,i);return{newItemsIds:s,updatedItemsIds:r,unchangedItems:n,revokedIds:a,isItemsSyncNeeded:r.length||a.length}}async getSharedItemsChangesFromSummary(e,t,i){let s=await this.sharedItemsRepo.getSharedItemsIndex(),{newIds:r,updatedIds:n,unchanged:a}=g(await Promise.all(e.map(async({id:e,revision:r})=>{let n=s[e];if(!n)return{id:e};let a=n.revision<r,o=n.recipientIds.userGroupIds?.some(e=>t.includes(e))??!1,c=n.recipientIds.collectionIds?.some(e=>i.includes(e))??!1;return{id:e,hasChanges:a||o||c,current:n}}))),o=!!n.length,c=Object.keys(s).length!==e.length;return{newItemGroupIds:r,updatedItemGroupIds:n,unchangedItemGroups:a,isSharedItemsSyncNeeded:o||c}}async syncSharedItems(e,t,i,s,r){let n=Object.values(await this.userGroupsRepo.getAcceptedUserGroupsForLogin(r.login)),a=Object.values(await this.collectionsRepo.getAcceptedCollections()),{validatedSharedItems:o,pendingInvitesWithoutContent:c,validatedSharedAccess:d,sharedItemsToDelete:u}=await e.reduce(async(e,t)=>{if("items"!==t.type)return e;let i=t.groupId,s=await e,o=await this.syncSharedItem(t,n,a,r);if(o){let{sharedItem:e,sharedAccess:n,pendingInvite:a}=o;if(I(t,r.login))try{await this.sharingSyncLastAdmin.deleteLastAdminSharedItem(e),s.sharedItemsToDelete.push(e.sharedItemId)}catch(e){this.exceptionLoggingClient.commands.reportAnomaly({criticality:L.h_.CRITICAL,message:"Error when trying to unshare an item",moduleName:"SharingSyncModule",useCaseName:"sharing-sync-items.service",applicationComponent:"Sharing",anomalyType:"exception",origin:"uncaughtException"})}else s.validatedSharedItems.push(e),s.validatedSharedAccess[t.groupId]=n,a&&(s.pendingInvitesWithoutContent[i]=a)}return e},Promise.resolve({validatedSharedItems:(0,l.Ay)([]),pendingInvitesWithoutContent:(0,l.Ay)({}),validatedSharedAccess:(0,l.Ay)({}),sharedItemsToDelete:(0,l.Ay)([])})),p=t.concat(o),h=Z(p.filter(e=>e.accessLink?.acceptSignature),e=>e.itemId),g=s,m=null;i.length&&(m=await this.vaultUpdatesService.runVaultUpdates(i,h),m?.length&&(g=g.concat(m)));let v=await this.pendingInvitesService.resolvePendingInvites(i,t,p,c),y=Z(g,e=>e.vaultItemId),w=Z(v,e=>e.sharedItemId),S=p.reduce((e,t)=>{if(u.includes(t.sharedItemId))return e;let i=y[t.itemId];if(i){let{revision:s,savedToVault:r}=i;e.push({sharedItem:t,revision:s,savedToVault:r})}else{let i=w[t.sharedItemId];if(i){let{revision:s}=i;e.push({sharedItem:t,revision:s,savedToVault:!1})}}return e},(0,l.Ay)([]));this.sharedItemsRepo.setSharedItems(S,d)}async isItemAlreadyShared(e,t){let i=(await this.userGroupsRepo.getAcceptedUserGroupsForLogin(t)).map(e=>e.groupId),s=(await this.collectionsRepo.getAcceptedCollections()).map(e=>e.id);return e?.users.some(e=>e.id===t&&e.status===d.qb.Accepted)||e?.userGroups.some(e=>i.includes(e.id))||e?.collections.some(e=>s.includes(e.id))}async deleteItems(e,t){let i=await this.sharedItemsRepo.getSharedItemsIndex(),s=await this.sharedItemsRepo.getSharedAccessIndex(),r=Object.values(i).filter(e=>!e.accessLink?.acceptSignature).filter(e=>!this.isItemAlreadyShared(s[e.sharedItemId],t)).map(e=>e.itemId).concat(e);r.length&&this.vaultUpdatesService.deleteVaultItems(r).catch()}async syncSharedItem(e,t,i,s){let r=X(e,t,i,s.login),n=await this.validationService.isSharedItemValid(r,s);n.isValid&&this.sharingSyncResendInvites.checkPublicKeysAndResendInvites(e,r,n.itemGroupKey);let a=e.users?.find(e=>e.userId===s.login&&e.status===d.qb.Pending);if(n.isValid||a){if(a){let{referrer:t,permission:i}=a,{sharedItemId:s,itemId:n}=r;return{sharedItem:r,sharedAccess:A(e),pendingInvite:{referrer:t,sharingPermissionLevel:(0,S.m)(i),sharedItemId:s,vaultItemId:n}}}return{sharedItem:r,sharedAccess:A(e)}}}constructor(e,t,i,s,r,n,a,o,c){this.sharedItemsRepo=e,this.userGroupsRepo=t,this.collectionsRepo=i,this.vaultUpdatesService=s,this.validationService=r,this.pendingInvitesService=n,this.sharingSyncResendInvites=a,this.sharingSyncLastAdmin=o,this.exceptionLoggingClient=c}}eo=(0,s.gn)([(0,u.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===j.z?Object:j.z,void 0===p.x?Object:p.x,void 0===U.G?Object:U.G,void 0===K?Object:K,void 0===F?Object:F,void 0===es?Object:es,void 0===ei?Object:ei,void 0===ea?Object:ea,void 0===k.G?Object:k.G])],eo);var ec=i(20661),ed=i(59982),el=i(68238),eu=i(15021),ep=i(20458),eh=i(11770);let eg=e=>eh.m.safeParse(e).success;class em extends(0,ed.Q)({persist:!0,storage:{initialValue:{},typeGuard:eg,schemaVersion:1},scope:eu.F.User,storeName:"team-admin-data-store",storeTypeGuard:eg,codec:ep.E,isCache:!0,capacity:el.Y.Unlimited}){}let ev=(e,t)=>{let{groupId:i,name:s,revision:r,users:n,privateKey:a,publicKey:o}=e;return{groupId:i,name:s,revision:r,publicKey:o,privateKey:a,groupKey:n.find(e=>e.userId===t)?.groupKey??void 0}};class ey{async getTeamAdminSharingDataSummary(e,t,i){let{specialItemGroup:s,specialItems:r,specialUserGroup:n}=await this.store.getState();if(!n)return;let a=e.find(({revision:e,id:t})=>n.groupId===t&&n.revision===e),o=s?t.find(({revision:e,id:t})=>s.groupId===t&&s.revision===e):void 0,c=r?i.filter(({id:e,timestamp:t})=>{let i=r[e];return i?.timestamp===t}):void 0;return{itemGroupId:o?.id,userGroupId:a?.id,itemIds:c?.map(({id:e})=>e)}}async syncTeamAdminSharingData(e,t,i,s,r){let n=await this.store.getState(),a={specialUserGroup:e?.userGroupId?n.specialUserGroup:void 0,specialItemGroup:e?.itemGroupId?n.specialItemGroup:void 0,specialItems:e?.itemIds?.reduce((e,t)=>{let i=n.specialItems?.[t];return i&&(e[t]=i),e},l.Ay({}))},o=t?.find(e=>"teamAdmins"===e.type);if(o){if(await this.validationService.isUserGroupValid(o,r))a.specialUserGroup=o;else{this.store.set({});return}}let c=i?.find(e=>"userGroupKeys"===e.type);if(c&&a.specialUserGroup){let e=$(c,r.login,[ev(a.specialUserGroup,r.login)],[]);if((await this.validationService.isSharedItemAccessValid(c.groupId,e?.link,r)).isValid)a.specialItemGroup=c;else{this.store.set({});return}}a.specialItemGroup?.items&&s?.forEach(e=>{a.specialItemGroup?.items?.find(t=>t.itemId===e.itemId)&&(a.specialItems||(a.specialItems={}),a.specialItems[e.itemId]=e)}),(0,ec.Z)(a,n)||this.store.set(a)}constructor(e,t){this.store=e,this.validationService=t}}ey=(0,s.gn)([(0,u.GS)(),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[em,void 0===F?Object:F])],ey);var ew=i(95255);let eS={module:"sharing sync"};class ef{async execute({body:e}){let{summary:t}=e,{collections:i,userGroups:s,itemGroups:r,items:n}=t;this.logger.debug("Sharing Summary",{...eS,collectionsSummaryLength:i.length,userGroupsSummaryLength:s.length,sharedItemsSummaryLength:r.length,itemsSummaryLength:n.length});let a=await this.currentUserGetter.getCurrentUserWithKeys(),{newUserGroupIds:c,updateUserGroupIds:d,unchangedUserGroups:l,revokedUserGroupIds:u,isUserGroupsSyncNeeded:p}=await this.userGroupsService.getUserGroupChangesFromSummary(s),h=d.concat(u),{newCollectionIds:g,updatedCollectionIds:m,unchangedCollections:v,revokedCollectionIds:y,isCollectionsSyncNeeded:w}=await this.collectionsService.getCollectionsChangesFromSummary(i,h),S=m.concat(y),{newItemGroupIds:f,updatedItemGroupIds:E,unchangedItemGroups:I,isSharedItemsSyncNeeded:b}=await this.itemsService.getSharedItemsChangesFromSummary(r,h,S),{newItemsIds:A,updatedItemsIds:C,unchangedItems:R,revokedIds:_,isItemsSyncNeeded:O}=await this.itemsService.getItemsChangesFromSummary(n,E),T=await this.teamAdminSharingDataService.getTeamAdminSharingDataSummary(s,r,n),F=c.concat(d),D=f.concat(E),U=A.concat(C);if(T){let{itemGroupId:e,itemIds:t,userGroupId:i}=T;e&&(D=D.filter(t=>t!==e)),i&&(F=F.filter(e=>e!==i)),t?.length&&(U=U.filter(e=>!t.includes(e)))}let P=g.concat(m),{updatedUserGroups:x,updatedCollectionDownloads:N,updatedItemGroups:L,updatedItems:k}=await this.getSharingDetails({userGroupIds:F,collectionIds:P,itemGroupIds:D,itemIds:U});return p?(this.logger.debug("User group sync running",eS),l.length&&x.length&&this.logger.debug("User group sync has updates",{...eS,updatedUserGroups:JSON.stringify(x.map(({groupId:e})=>e))}),await this.userGroupsService.syncUserGroups(x,l,a)):this.logger.debug("User group sync not needed",eS),w?(this.logger.debug("Collection sync running",eS),N.length&&v.length&&this.logger.debug("Shared items sync has updates",{...eS,updatedCollections:JSON.stringify(N.map(e=>e.uuid))}),await this.collectionsService.syncCollections(N,v,a)):this.logger.debug("Collection sync not needed",eS),b||O?(this.logger.debug("Shared items sync running",eS),I.length&&L.length&&this.logger.debug("Shared items sync has updates",{...eS,updatedItemGroups:JSON.stringify(L.map(e=>e.groupId))}),await this.itemsService.syncSharedItems(L,I,k,R,a)):this.logger.debug("Shared items sync not needed",eS),await this.teamAdminSharingDataService.syncTeamAdminSharingData(T,x,L,k,a),await this.itemsService.deleteItems(_,a.login),this.logger.debug("Shared sync complete",eS),(0,o.Vp)(void 0)}async getSharingDetails({userGroupIds:e,itemGroupIds:t,itemIds:i,collectionIds:s}){if(e.length||t.length||i.length||s.length){this.logger.debug("Getting sharing details for updated items",{...eS,userGroupIdsLength:e.length,itemGroupIdsLength:t.length,itemIdsLength:i.length,collectionIdsLength:s.length});let n=await (0,r.z)(this.serverApiClient.v1.sharingUserdevice.postSharingUserdevice({collectionIds:s,userGroupIds:e,itemGroupIds:t,itemIds:i}));if((0,o.hx)(n))throw Error("Error getting sharing updates");let{data:a}=(0,o.db)(n),{userGroups:c,collections:d,itemGroups:l,items:u}=a;return this.logger.debug("Sharing details for updated items result",{...eS,updatedUserGroupsLength:c?.length,updatedCollectionDownloadsLength:d?.length,updatedItemGroupsLength:l?.length,itupdatedItemsemsLength:u?.length}),{updatedUserGroups:c??[],updatedCollectionDownloads:d??[],updatedItemGroups:l??[],updatedItems:u??[]}}return this.logger.debug("Sharing sync, no sharing details to get",eS),{updatedUserGroups:[],updatedCollectionDownloads:[],updatedItemGroups:[],updatedItems:[]}}constructor(e,t,i,s,r,n,a){this.serverApiClient=e,this.currentUserGetter=t,this.itemsService=i,this.userGroupsService=s,this.collectionsService=r,this.teamAdminSharingDataService=n,this.logger=a}}ef=(0,s.gn)([(0,n.W)(c.N),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[void 0===a.l?Object:a.l,void 0===ew.a?Object:ew.a,void 0===eo?Object:eo,void 0===D?Object:D,void 0===N?Object:N,void 0===ey?Object:ey,R])],ef);var eE=i(48035),eI=i(90573),eb=i(4843),eA=i(70472),eC=i(42589),eR=i(62506);class e_{execute(){return this.store.state$.pipe((0,eC.U)(e=>(0,o.Vp)(e)))}constructor(e){this.store=e}}e_=(0,s.gn)([(0,eR.e)(eh.k),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[em])],e_);var eO=i(81778),eT=i(89005),eF=i(71318),eD=i(90735),eU=i(77261),eP=i(78631),ex=i(36159);class eN{}eN=(0,s.gn)([(0,eE.Y)({api:eA.k,providers:[K,eo,N,D,es,ei,ea,ey,F,(0,C.d_)(R)],stores:[em],handlers:{commands:{runSharingSync:ef},events:{},queries:{getTeamAdminSharingData:e_}},imports:[eb.n,eT.y,eF.k,eD.u,eU.a,eP.F,eO.p,ex.I,eI.G]})],eN)},35856:function(e,t,i){i.d(t,{Q:()=>l,w:()=>d});var s=i(53777),r=i(87169),n=i(57102),a=i(45065),o=i(91012),c=i(34015);let d=e=>{let t=(0,s.N)(e),i=(0,r.u)(t);return(0,n.n)(i)},l=e=>{let t=(0,a.L)(e),i=(0,o.v)(t);return(0,c.e)(i)}},32303:function(e,t,i){i.d(t,{c:()=>a,m:()=>n});var s=i(4274),r=i(38392);let n=e=>e===s.y3.Admin?"full":"restricted",a=e=>e===s.y3.Admin?r.Yt.Manager:r.Yt.Editor},80323:function(e,t,i){i.d(t,{R:()=>r});var s=i(70410);let r=()=>`{${(0,s.Z)().toUpperCase()}}`},57499:function(e,t,i){i.d(t,{B:()=>c,u:()=>n});var s=i(4274);let r=(e,t)=>t?.permission===s.y3.Admin?t.permission:e,n=e=>e.reduce(r,s.y3.Limited),a={restricted:1,view:2,edit:3,full:4},o=(e,t)=>t?.sharingPermissionLevel&&a[t.sharingPermissionLevel]>a[e]?t.sharingPermissionLevel:e,c=e=>e.reduce(o,"restricted")},44948:function(e,t,i){i.d(t,{B5:()=>a,HU:()=>n,l7:()=>r});var s=i(4274);function r(e){switch(e?.kwType){case"KWAuthentifiant":return"AUTHENTIFIANT";case"KWSecureNote":return"SECURENOTE";default:return"SECRET"}}function n(e){switch(e){case s.y2.Credential:return"AUTHENTIFIANT";case s.y2.SecureNote:return"SECURENOTE";default:return"SECRET"}}function a(e){switch(e){case"AUTHENTIFIANT":return"password";case"SECURENOTE":return"note";default:return"secret"}}},79583:function(e,t,i){i.d(t,{o:()=>r});var s,r=((s={}).User="user",s.UserGroup="group",s)},17231:function(e,t,i){i.d(t,{E:()=>p});var s=i(38392),r=i(4274),n=i(57499),a=i(79583),o=i(32303);let c=(e,t)=>{let i=e.userGroups?.filter(e=>t.some(t=>t.groupId===e.uuid)&&e.status===r.qb.Accepted&&e.collectionKey);if(i?.length){let e=i[0],s=(0,n.u)(i),r=(0,o.c)(s);if(e.collectionKey){let{permission:i,acceptSignature:s,proposeSignature:n}=e,c=t.find(t=>t.groupId===e.uuid);if(c?.groupKey)return{link:{sharedCollectionRole:(0,o.c)(i),acceptSignature:s,proposeSignature:n,encryptedResourceKey:e.collectionKey,groupEncryptedKey:c.groupKey,groupPrivateKey:c.privateKey,groupPublicKey:c.publicKey,accessType:a.o.UserGroup},sharedCollectionRole:r,isAccepted:!0}}}return null},d=(e,t)=>{let i=e.users?.some(({login:e,permission:i,rsaStatus:s,status:n})=>e!==t&&i===r.y3.Admin&&"sharingKeys"===s&&n===r.qb.Accepted)??!1,n=e.users?.some(e=>e.login===t&&e.status===r.qb.Accepted&&e.collectionKey)??!1,c=e.users?.find(e=>e.login===t&&(e.status===r.qb.Accepted||e.status===r.qb.Pending)&&e.collectionKey);if(c&&c.collectionKey){let{permission:e,acceptSignature:t,proposeSignature:s}=c,r=(0,o.c)(e);return{link:{sharedCollectionRole:r,acceptSignature:t,proposeSignature:s,encryptedResourceKey:c.collectionKey,accessType:a.o.User},sharedCollectionRole:r,isAccepted:n,otherAdminsFound:i}}return{sharedCollectionRole:s.Yt.Editor,isAccepted:!1,otherAdminsFound:i}},l=({permission:e,status:t})=>e===r.y3.Admin&&t===r.qb.Accepted,u=(e,t,i)=>{let r=d(e,t),n=!!r?.otherAdminsFound||!!e.userGroups?.some(l)||!!e.users?.some(l);if(null!==r&&r.sharedCollectionRole===s.Yt.Manager)return{...r,otherAdminsFound:n};let a=c(e,i.filter(e=>e.groupKey&&e.acceptedUsers?.some(e=>e===t))),o=a?.sharedCollectionRole===s.Yt.Manager||r?.sharedCollectionRole===s.Yt.Manager?s.Yt.Manager:s.Yt.Editor,u=!!(r?.isAccepted||a?.isAccepted);return{...r?.link?r:a,sharedCollectionRole:o,otherAdminsFound:n,isAccepted:u}},p=(e,t,i)=>{let{link:r,sharedCollectionRole:n,otherAdminsFound:a,isAccepted:o}=u(e,i,t),c=n===s.Yt.Manager&&!a,{name:d,privateKey:l,publicKey:p,revision:h,uuid:g,authorLogin:m}=e;return{id:g,name:d,privateKey:l,publicKey:p,revision:h,accessLink:r,isLastAdmin:c,isAccepted:o,sharedCollectionRole:n,authorLogin:m}}}}]);